diff --git a/.gitignore b/.gitignore
index f076dca..34fcd8d 100644
--- a/.gitignore
+++ b/.gitignore
@@ -77,5 +77,6 @@ rg.sh




 dist/SCOREPLANREMOTE.md
+telemetry-id
diff --git a/.jules/bolt.md b/.jules/bolt.md
index ca8687a..88ae160 100644
--- a/.jules/bolt.md
+++ b/.jules/bolt.md
@@ -14,15 +14,5 @@
 **Action:** Centralized DOM access in `src/utils/dom.ts` with typed helpers. Refactored the `Controller` base class to include a `name` getter using `this.constructor.name`, eliminating the need for a manual name-mapping utility and reducing duplication.

 ## 2026-02-08 - [Snooker Score-Based Winner Determination]
 **Learning:** In Snooker, the person who pots the last ball isn't necessarily the winner; the player with the highest score wins the frame. Relying on an `isWinner` boolean passed from the game flow controller can lead to incorrect UI states and match reporting in multiplayer.
 **Action:** Refactored `Snooker.handleGameEnd` to ignore the `isWinner` parameter for UI/Winner logic. It now explicitly compares `this.container.scores` to determine the actual winner (where a tie is treated as a win), updates the notification subtext with names and scores, and ensures only the correct winner submits the match result.
-
-## 2026-02-13 - [Webpack and Accessibility Optimization]
-**Learning:**
-- Removing 'user-scalable=0' and adding '<main>' landmarks directly addresses Lighthouse accessibility failures.
-- Replacing manual 'vendor' entry points with 'optimization.splitChunks' in Webpack allows for better tree-shaking of large dependencies like Three.js.
-- Enabling 'devtool: "source-map"' in production satisfies Lighthouse best practices and aids in production debugging.
-**Action:**
-- Updated HTML files in dist/ to remove scaling restrictions and add main landmarks.
-- Refactored webpack.config.js to use splitChunks and deterministic module IDs.
-- Enabled source maps for production builds.
diff --git a/AGENTS.md b/AGENTS.md
index a85a771..bdd89f1 100644
--- a/AGENTS.md
+++ b/AGENTS.md
@@ -2,10 +2,11 @@

 ## Project Structure & Module Organization
 - `src/` contains all TypeScript source code. Core areas include `src/model` (physics), `src/view` (rendering/UI), `src/controller` (input/game flow), and `src/network` (multiplayer and scoring).
 - `test/` contains Jest tests organized by domain (e.g., `test/model`, `test/rules`, `test/view`).
 - `dist/` holds built artifacts and assets used for deployment (models, HTML, CSS, images).
+- `dist/index.html` is the main game page.

 ## Build, Test, and Development Commands
 - `yarn serve` starts the webpack dev server; open `http://localhost:8080/`.
 - `yarn build` produces a production build via webpack.
 - `yarn test` runs Jest with the repoâ€™s config.
@@ -13,25 +14,36 @@
 - `yarn lint` runs `tsc --noEmit` and ESLint.
 - `yarn prettify` formats JS/TS/JSON/CSS/HTML and caches results.

 ## Coding Style & Naming Conventions
 - TypeScript is the primary language; keep types explicit at public boundaries.
-- Indentation follows the existing codebase (2 spaces in TS/JS files).
+- Indentation follows the existing codebase (2 spaces in TS/JS files) no semicolons.
 - Filenames are lower-case and descriptive. Tests use `*.spec.ts` (e.g., `test/model/cushion.spec.ts`).
 - Keep ball serialisation compact; do not include `state` in serialized ball data.
-- Use ESLint and Prettier before opening a PR: `yarn lint` and `yarn prettify`.
+- Always run ESLint and Prettier after changes `yarn lint` and `yarn prettify`.

 ## Testing Guidelines
 - Jest is the test runner; configuration is in `test/jest.config.js`.
 - Add tests alongside the affected domain (e.g., physics changes in `test/model`).
 - Prefer deterministic tests; use `jest.useFakeTimers()` when timing is involved.
 - Run `yarn test` locally before submitting; `yarn coverage` for deeper validation.
 - After making changes, run `yarn lint` and `yarn test`.

-## Commit & Pull Request Guidelines
-- There is no enforced commit message standard in this repo. Use concise, imperative summaries (e.g., â€œFix cushion bounce edge caseâ€).
-- PRs should include a clear description, testing notes, and screenshots or short clips for visual or physics changes.
-- Link relevant issues when applicable, and call out any behavior changes or tuning constants.
-
 ## Configuration Notes
 - Node/Yarn usage matches the README instructions (Yarn 1.x; see `package.json` engines).
 - For model assets, use `yarn gltfpack` to regenerate optimized `.gltf` files in `dist/models`.
+
+## Physics Implementation Notes
+
+The physics engine is based on:
+- **Han 2005:** For ball mechanics (surface velocity, sliding/rolling motion).
+- **Alciatore:** For ball-to-ball collisions incorporating throw effects.
+- **Mathavan 2010:** For cushion bounces, including spin-induced effects.
+
+Key equations and constants are documented in the `README.md`.
+
+## Basic Quality Checks
+
+Before submitting changes, ensure the following commands pass:
+- **Build:** `yarn dev`
+- **Test:** `yarn test`
+- **Format:** `yarn prettify`
\ No newline at end of file
diff --git a/PLAYERS.md b/PLAYERS.md
deleted file mode 100644
index e5e917a..0000000
--- a/PLAYERS.md
+++ /dev/null
@@ -1,254 +0,0 @@
-# Player Score Migration Plan
-
-## Current Structure
-
-```typescript
-container.scores: [number, number]  // index 0 or 1 based on playerIndex
-Session.playerIndex() â†’ 0 or 1
-Session.getInstance().playername
-Session.getInstance().opponentName
-```
-
-### Pain Points
-
-- `scores[Session.playerIndex()]++` is verbose
-- `scores[1 - playerIndex]` for opponent is error-prone
-- Winner logic: compare array, then check `winnerIndex === playerIndex`
-- Player names stored separately in Session, not linked to scores
-
----
-
-## Proposed Structure
-
-```typescript
-interface Player {
-  id: string;
-  name: string;
-  score: number;
-}
-
-// In Container
-me: Player;
-opponent: Player;
-```
-
-### Usage Examples
-
-```typescript
-// Incrementing score
-this.container.me.score++;
-
-// Accessing opponent name
-this.container.opponent.name;
-
-// Checking raceTo winner
-return this.container.me.score >= raceTo;
-
-// Winner determination
-const winner =
-  this.container.me.score >= this.container.opponent.score
-    ? this.container.me
-    : this.container.opponent;
-```
-
----
-
-## Files to Change
-
-| File                                 | Changes                                                                                        |
-| ------------------------------------ | ---------------------------------------------------------------------------------------------- |
-| `container/container.ts`             | Replace `scores: [number, number]` with `me: Player` and `opponent: Player`                    |
-| `network/client/session.ts`          | Remove `playername` and `opponentName` (moved to Player), keep `playerIndex` for turn tracking |
-| `controller/rules/threecushion.ts`   | Use `me.score`/`opponent.score`, simplify `isEndOfGame` and `handleGameEnd`                    |
-| `controller/rules/nineball.ts`       | Use `me.score` for incrementing                                                                |
-| `controller/rules/snooker.ts`        | Use `me.score`/`opponent.score` for scoring                                                    |
-| `controller/rules/snookerscoring.ts` | Simplify winner logic using Player objects                                                     |
-| `events/recorder.ts`                 | Use `me.score`                                                                                 |
-| `view/hud.ts`                        | Display `me.name`, `opponent.name` with scores                                                 |
-
----
-
-## Detailed Changes
-
-### 1. New Player Interface (add to `container/container.ts` or new file)
-
-```typescript
-export interface Player {
-  id: string;
-  name: string;
-  score: number;
-}
-
-export function createPlayer(id: string = "", name: string = ""): Player {
-  return { id, name, score: 0 };
-}
-```
-
-### 2. Container Changes
-
-```typescript
-// Before
-scores: [number, number] = [0, 0]
-
-// After
-me: Player = createPlayer("", "")
-opponent: Player = createPlayer("", "")
-
-// Update getScores() method
-getScores(): [number, number] {
-  return [this.me.score, this.opponent.score]
-}
-```
-
-### 3. Session Changes
-
-```typescript
-// Keep playerIndex for turn tracking
-// Remove playername and opponentName (now in Container.me/opponent)
-// Session remains focused on connection/identity, not display
-
-export class Session {
-  constructor(
-    readonly clientId: string,
-    readonly tableId: string,
-    readonly spectator: boolean,
-  ) {}
-
-  playerIndex: number = 0; // 0 = me plays first, 1 = opponent plays first
-
-  // ... rest unchanged
-}
-```
-
-### 4. BrowserContainer Changes
-
-```typescript
-constructor(canvas3d, params) {
-  // ...
-  const playername = params.get("name") ?? ""
-  this.container.me.name = playername
-  // opponent name set via network event
-}
-
-netEvent(e: string) {
-  const event = EventUtil.fromSerialised(e)
-  if (event.playername) {
-    this.container.opponent.name = event.playername
-  }
-  // ...
-}
-```
-
-### 5. ThreeCushion Rules
-
-```typescript
-// Before
-this.container.scores[Session.playerIndex()]++
-
-if (this.isEndOfGame(outcomes)) {
-  return this.handleGameEnd(true)
-}
-
-isEndOfGame(_: Outcome[]) {
-  const [s1, s2] = this.container.scores
-  return s1 >= ThreeCushionConfig.raceTo || s2 >= ThreeCushionConfig.raceTo
-}
-
-// After
-const player = Session.playerIndex() === 0 ? this.container.me : this.container.opponent
-player.score++
-
-if (this.isEndOfGame(outcomes)) {
-  return this.handleGameEnd(player === this.container.me)
-}
-
-isEndOfGame(_: Outcome[]) {
-  return this.container.me.score >= ThreeCushionConfig.raceTo
-    || this.container.opponent.score >= ThreeCushionConfig.raceTo
-}
-```
-
-### 6. SnookerScoring
-
-```typescript
-// Before
-const winnerIndex = container.scores[0] >= container.scores[1] ? 0 : 1;
-const amIWinner = winnerIndex === playerIndex;
-
-// After
-const winner =
-  container.me.score >= container.opponent.score
-    ? container.me
-    : container.opponent;
-const amIWinner = winner === container.me;
-```
-
-### 7. HUD Display
-
-```typescript
-// Before
-p1Element: <div class="p1Score">Score: ${scores[0]}</div>
-p2Element: <div class="p2Score">Score: ${scores[1]}</div>
-
-// After
-p1Element: <div class="p1Score">${me.name || 'Player 1'}: ${me.score}</div>
-p2Element: <div class="p2Score">${opponent.name || 'Player 2'}: ${opponent.score}</div>
-```
-
----
-
-## Winner Logic Simplification
-
-### Before (complex)
-
-```typescript
-const winnerIndex = container.scores[0] >= container.scores[1] ? 0 : 1;
-const amIWinner = winnerIndex === playerIndex;
-const winnerScore = container.scores[winnerIndex];
-const loserScore = container.scores[1 - winnerIndex];
-```
-
-### After (clear)
-
-```typescript
-const winner =
-  container.me.score >= container.opponent.score
-    ? container.me
-    : container.opponent;
-const amIWinner = winner === container.me;
-const { score: winnerScore } = winner;
-const loserScore =
-  winner === container.me ? container.opponent.score : container.me.score;
-```
-
----
-
-## Network Serialization
-
-The array format is compact for network sync. Options:
-
-1. **Keep `getScores()` for sync** - maintain backward compatibility with network protocol
-2. **Serialize Player objects** - `{ me: {...}, opponent: {...} }` - more verbose but clearer
-3. **Hybrid** - store as array internally, expose as Player getters
-
----
-
-## Migration Steps
-
-1. Add `Player` interface and `createPlayer` helper
-2. Add `me` and `opponent` to Container (keep `scores` temporarily)
-3. Update all rules files to use `me.score`/`opponent.score`
-4. Update Session to remove name fields
-5. Update BrowserContainer to populate Player names
-6. Update HUD and display components
-7. Remove `scores` array once migration complete
-8. Update tests
-
----
-
-## Considerations
-
-- **Single player**: `me` is always the active player, `opponent` tracks their score
-- **Spectator mode**: Both players are "opponents" from spectator view
-- **Turn tracking**: `Session.playerIndex` still needed to know whose turn it is
-- **Backward compat**: `getScores()` returns `[number, number]` for existing code
diff --git a/REVIEW.md b/REVIEW.md
new file mode 100644
index 0000000..49de780
--- /dev/null
+++ b/REVIEW.md
@@ -0,0 +1,330 @@
+# Frontend Design Review: Break Builder Billiards
+
+## Executive Summary
+
+The application presents a functional billiards game UI with solid accessibility foundations and semantic markup. However, the design lacks a distinctive visual identity and falls into common patterns that fail to create a memorable user experience. This review identifies opportunities to elevate the frontend from utilitarian to distinctive.
+
+---
+
+## 1. Typography Analysis
+
+### Current State
+
+- **Score Display**: `Verdana, Geneva, Tahoma, sans-serif` â€” Generic system font stack with italic styling
+- **Notifications**: `"Segoe UI", Roboto, Helvetica, Arial, sans-serif` â€” Industry-standard but forgettable
+- **No custom web fonts loaded** â€” Missing opportunity for typographic personality
+
+### Issues
+
+1. **Generic font choices**: Verdana and Roboto/Segoe UI are overused defaults that contribute to "AI slop" aesthetics
+2. **No typographic hierarchy**: Only `xx-large` and `smaller` sizes with minimal weight variation
+3. **Inconsistent font families**: Two different stacks used without clear rationale
+4. **No display font**: A game interface would benefit from a distinctive display font for headings and scores
+
+### Recommendations
+
+- Consider a **refined** direction: Pair a distinctive display font (e.g., a geometric sans like _Bebas Neue_ or a classic serif like _Playfair Display_) with a clean body font
+- For a **playful/arcade** aesthetic: Use _Bungee_, _Press Start 2P_, or _Russo One_
+- For a **luxury/billiards club** feel: Consider _Cormorant_, _Crimson Pro_, or _Libre Baskerville_
+- Establish CSS custom properties for typography scale
+
+---
+
+## 2. Color & Theme Analysis
+
+### Current Palette
+
+| Element               | Color                        | Assessment                   |
+| --------------------- | ---------------------------- | ---------------------------- |
+| Background            | `#000` (black)               | Functional dark theme        |
+| Body text             | `#444`                       | Very dark gray, low contrast |
+| Div text              | `antiquewhite`               | Warm off-white, decent       |
+| Score                 | `yellow`                     | Harsh, no nuance             |
+| Panel gradient        | `rgb(0, 64, 94)` â†’ `#000214` | Deep blue to black           |
+| Notification gradient | `#1464c8` â†’ `#00b4a0`        | Blue to teal gradient        |
+| Chat output           | `rgba(47, 79, 79, 0.486)`    | Low-opacity dark slate       |
+
+### Issues
+
+1. **Inconsistent color story**: Blues, greens, yellows, and teals compete without hierarchy
+2. **No CSS custom properties**: Colors hardcoded throughout, making theme adjustments difficult
+3. **Yellow score text**: Pure yellow (`yellow`) is harsh against black â€” lacks sophistication
+4. **Low contrast**: `#444` body text fails WCAG AA standards
+5. **No accent color system**: Colors appear arbitrary rather than intentional
+
+### Recommendations
+
+- Establish a cohesive **CSS variable system**:
+  ```css
+  :root {
+    --color-bg-primary: #0a0a0f;
+    --color-bg-secondary: #14141f;
+    --color-text-primary: #e8e4dc;
+    --color-text-muted: #8a8a9a;
+    --color-accent: /* choose one strong accent */;
+    --color-success: /* for positive feedback */;
+    --color-warning: /* for fouls/alerts */;
+  }
+  ```
+- **Choose ONE accent color** and use it sparingly for emphasis
+- Consider **felt green** (`#0d7a3c`) as primary accent â€” connects to billiards table aesthetic
+- Soften score yellow to a **gold/amber** (`#d4a537`) for luxury feel
+
+---
+
+## 3. Motion & Animation Analysis
+
+### Current State
+
+- **One keyframe animation**: `badgeIn` (fade + translateY)
+- **Limited transitions**:
+  - Notification buttons: `transform`, `opacity` (0.2s ease)
+  - Active button states: `scale(0.97)` (no transition defined)
+  - Hover states: `translateY(-2px)` (0.2s ease)
+
+### Issues
+
+1. **Underutilized motion**: A game interface has numerous opportunities for delight
+2. **No entrance animations**: Elements appear instantly without orchestration
+3. **No micro-interactions**: Power slider, hit button, ball container lack polish
+4. **No state transitions**: Score changes, ball potting, game events lack visual feedback
+5. **No canvas effects**: The 3D view could benefit from subtle UI overlays
+
+### Recommendations
+
+- **Page load sequence**: Stagger entrance animations for panel elements using `animation-delay`
+- **Power slider enhancement**:
+  - Add a glowing track that intensifies with power level
+  - Animate the slider thumb with a pulse effect at max power
+- **Hit button**:
+  - Ripple effect on click
+  - Glow intensification while holding
+  - Satisfying "thwack" visual feedback
+- **Score reveal**: Animate score changes with counter-up effect
+- **Ball potting**: Celebration animation when balls are potted
+- **Consider**: CSS `@property` for animated gradients on power indicator
+
+---
+
+## 4. Spatial Composition Analysis
+
+### Current Layout
+
+```
+â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
+â”‚                                 â”‚
+â”‚         3D View (83%)           â”‚
+â”‚                                 â”‚
+â”‚                                 â”‚
+â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
+â”‚ [hit] [ball] [slider] [chat]   â”‚ â† Panel (17%)
+â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
+```
+
+### Issues
+
+1. **Completely predictable layout**: 83/17 split is utilitarian without visual interest
+2. **No asymmetry**: Everything centered or evenly distributed
+3. **No overlapping elements**: Score overlay positioned separately, not integrated
+4. **Wasted negative space**: Could use breathing room or intentional density
+5. **No visual hierarchy**: All panel elements compete for attention equally
+
+### Recommendations
+
+- **Asymmetric panel**: Consider a sidebar approach on larger screens
+- **Overlapping elements**: Allow score display to overlap the canvas edge
+- **Grid-breaking**: Position the ball container to slightly overlap the panel boundary
+- **Z-index playfulness**: Layer UI elements at different depths with shadows
+- **Responsive consideration**: Layout collapses poorly on mobile â€” explore alternative arrangements
+
+---
+
+## 5. Backgrounds & Visual Details Analysis
+
+### Current Details
+
+- **Panel background**: Linear gradient (`rgb(0, 64, 94)` â†’ `#000214`) â€” basic but functional
+- **Cue ball**: Radial gradient with 3D lighting effect â€” actually well-executed
+- **Chat output**: Semi-transparent background â€” appropriate
+- **Constants panel**: Gradient background with double border â€” dated styling
+
+### Issues
+
+1. **No atmosphere**: Pure black background lacks depth
+2. **No textures**: Billiards = felt, wood, leather â€” all missing from UI
+3. **No visual metaphors**: UI doesn't reflect the game's physicality
+4. **Double border**: `.constants` uses outdated `border: double` aesthetic
+5. **Flat backgrounds**: No grain, noise, or atmospheric effects
+
+### Recommendations
+
+- **Introduce textures**:
+  - Subtle felt texture on panel background
+  - Wood grain on button surfaces
+  - Leather-stitched borders on key elements
+- **Add atmosphere**:
+  - Subtle vignette on 3D view edges
+  - Ambient glow around active elements
+  - Noise/grain overlay for depth
+- **Visual metaphor extension**:
+  - Score display could look like a scoreboard or chalkboard
+  - Power slider could be a cue stick visual
+  - Hit button could have a leather-wrapped aesthetic
+
+---
+
+## 6. Component-Specific Issues
+
+### Hit Button (`.hitButton`)
+
+- **Problem**: Generic rectangular button, minimal styling
+- **Opportunity**: Could be the primary action with strong visual weight
+- **Fix**:
+  - Increase visual prominence
+  - Add power-dependent styling (color shifts with power level)
+  - Consider a circular or stadium-shaped button
+
+### Power Slider (`.powerSlider`)
+
+- **Problem**: Default browser styling, vertical orientation only
+- **Opportunity**: Critical game control, should feel satisfying
+- **Fix**:
+  - Custom track and thumb styling
+  - Gradient fill that grows with power
+  - Numeric power indicator
+  - Haptic visual feedback
+
+### Ball Container (`.ballContainer`)
+
+- **Strength**: The cue ball gradient is genuinely nice
+- **Problem**: Object ball is nearly invisible with transparent styling
+- **Opportunity**: Could show aiming direction more clearly
+- **Fix**:
+  - Add visible object ball styling
+  - Show trajectory preview line
+  - Animate ball rotation based on spin
+
+### Score Display (`#snookerScore`)
+
+- **Problem**: Floating yellow text, no visual container
+- **Opportunity**: Could be a signature visual element
+- **Fix**:
+  - Encapsulate in a styled container (wooden frame, digital display)
+  - Add team/player colors
+  - Include player names or avatars
+
+### Chat Area (`.chatarea`)
+
+- **Problem**: Functional but unpolished
+- **Opportunity**: Could integrate game log, tips, and social features
+- **Fix**:
+  - Better message styling
+  - Timestamp indicators
+  - System message differentiation
+
+### Icons (Emojis)
+
+- **Problem**: â˜…, ðŸ†, ðŸ‘¥, â¬€, ðŸŽ¥ used as icons â€” unprofessional and inconsistent
+- **Opportunity**: Custom icons would elevate the entire UI
+- **Fix**:
+  - SVG icons with consistent stroke weight
+  - Consider Lucide, Feather, or custom designed set
+  - Animated icon states on hover
+
+---
+
+## 7. Accessibility & Usability Notes
+
+### Strengths
+
+- Good use of `aria-label` attributes on buttons
+- `aria-live` regions for notifications and scores
+- Semantic HTML structure
+- `role="alert"` on notifications
+
+### Issues
+
+- `#444` text on black background fails contrast requirements
+- No visible focus states on interactive elements
+- Emojis may not convey meaning to screen readers
+- No skip links or keyboard navigation indicators
+
+### Recommendations
+
+- Audit all text/background combinations for WCAG AA compliance
+- Add visible focus rings (styled to match aesthetic)
+- Provide text alternatives for emoji icons
+- Ensure keyboard navigation follows logical game flow
+
+---
+
+## 8. Proposed Design Directions
+
+### Direction A: Classic Billiards Club
+
+**Tone**: Refined, luxury, leather-and-wood
+
+- Deep green felt backgrounds with subtle texture
+- Wood-grain panel borders
+- Gold accents for scores and achievements
+- Serif display font (Libre Baskerville, Cormorant)
+- Leather-stitched button textures
+- Warm amber lighting effects
+
+### Direction B: Modern Arcade
+
+**Tone**: Playful, bold, neon-drenched
+
+- High contrast dark background with neon accents
+- Geometric sans font (Bebas Neue, Archivo Black)
+- Glowing borders and shadows
+- Satisfying micro-animations on every interaction
+- Score display as digital LED panel
+- Particle effects on ball potting
+
+### Direction C: Minimal Brutalist
+
+**Tone**: Raw, intentional, high-contrast
+
+- Pure black with stark white text
+- Single accent color (electric blue or felt green)
+- Monospace font for scores (JetBrains Mono, Space Mono)
+- Sharp corners, no gradients
+- Aggressive typography hierarchy
+- No decoration, only function
+
+---
+
+## 9. Priority Action Items
+
+| Priority | Item                                        | Effort | Impact |
+| -------- | ------------------------------------------- | ------ | ------ |
+| 1        | Establish CSS custom properties for colors  | Low    | High   |
+| 2        | Fix text contrast issues (#444 on black)    | Low    | High   |
+| 3        | Replace emojis with SVG icons               | Medium | Medium |
+| 4        | Add custom web font                         | Low    | High   |
+| 5        | Implement power slider custom styling       | Medium | High   |
+| 6        | Add entrance animations with stagger        | Medium | Medium |
+| 7        | Create styled score container               | Medium | High   |
+| 8        | Design and implement hit button enhancement | Medium | Medium |
+| 9        | Add background textures/atmosphere          | Medium | Medium |
+| 10       | Implement consistent hover/focus states     | Low    | Medium |
+
+---
+
+## 10. Summary
+
+The Break Builder frontend is **functional but forgettable**. It succeeds at presenting game controls and information but fails to create a distinctive visual identity. The use of system fonts, generic color choices, minimal animation, and emoji icons places it firmly in "utility UI" territory rather than "memorable product."
+
+The strongest opportunities for improvement are:
+
+1. **Typography**: A distinctive display font would immediately elevate the aesthetic
+2. **Color system**: Cohesive palette with CSS variables
+3. **Motion**: Orchestrated animations for delight and feedback
+4. **Texture**: Introduction of billiards-relevant textures (felt, wood, leather)
+
+The notification system styling demonstrates that the codebase can support more sophisticated design patterns â€” this quality should be extended throughout the application.
+
+---
+
+_Review conducted according to frontend-design guidelines emphasizing distinctive, production-grade interfaces that avoid generic AI aesthetics._
diff --git a/SCORERECORD.md b/SCORERECORD.md
deleted file mode 100644
index 387f58e..0000000
--- a/SCORERECORD.md
+++ /dev/null
@@ -1,59 +0,0 @@
-# Plan: Record ScoreEvents While Preserving Replay Semantics
-
-## Summary
-Update the recorder to store `ScoreEvent` entries and ensure replay extraction (last shot and break) still targets the correct shot by skipping score entries when computing indices. Include ScoreEvents in replay sequences so score updates play during replays, while keeping break/last-shot link behavior correct.
-
-## Public API / Interface Changes
-- No new exported types or methods.
-- Behavior changes in `Recorder`:
-  - `record()` will include `EventType.SCORE`.
-  - `last()` and `lastShot()` will ignore `SCORE` when choosing the â€œlast shotâ€.
-  - `breakLink()` / `currentBreak()`-derived sequences will handle trailing `SCORE` events to preserve include/exclude-last-shot behavior.
-
-## Implementation Details (Recorder-Only)
-1. Record ScoreEvents
-- In `record()`, add `EventType.SCORE` to the list of recordable types.
-- Keep `state` as `table.shortSerialise()` (consistent with other events).
-- `pots`, `isPartOfBreak`, `time` remain as today (score entries will have `pots = 0`, etc.).
-
-2. Centralize â€œlast shotâ€ indexing
-- Add a small helper inside `Recorder` (private or local method) to find the last index that is not in a skip list.
-- Use skip list `[EventType.RERACK, EventType.SCORE]` for â€œlast shotâ€ identification.
-- Update `last()` to use this helper.
-
-3. Include ScoreEvents in last-shot replay while skipping them for indexing
-- Update `lastShot()` to:
-  - Find the last non-skip entry index.
-  - Build the replay event list as:
-    - The last shot event.
-    - Plus any trailing `ScoreEvent`s that occur after it (ignore trailing `RERACK`).
-  - `ReplayEncoder.createState(entry.state, events)` with the new list.
-
-4. Break replay extraction that respects include/exclude-last-shot
-- Keep `currentBreak()` to return the full slice (including score events).
-- In `breakLink(includeLastShot)`:
-  - If `includeLastShot` is `false`, create a trimmed break copy:
-    - Remove trailing `SCORE` and `RERACK` events so the last element is a real shot.
-    - Let `LinkFormatter.breakLink()` pop the last shot as it already does.
-  - If `includeLastShot` is `true`, pass through the full break slice (including score events).
-
-## Test Cases / Scenarios (Manual)
-1. ScoreEvent recorded
-- Trigger a score update (via normal gameplay).
-- Confirm `Recorder.entries` includes a `SCORE` event in chronological order.
-
-2. Last-shot replay correctness
-- Ensure last entry is a `SCORE` event.
-- `lastShot()` should still replay the correct last shot and include its trailing `SCORE` events.
-
-3. Break replay with includeLastShot = false
-- Ensure break link excludes the final shot and its trailing score updates.
-- Verify replay length and behavior match expectations.
-
-4. Break replay with includeLastShot = true
-- Ensure break replay includes all shots and associated score updates in sequence.
-
-## Assumptions / Defaults
-- ScoreEvents occur after the shot they correspond to.
-- It is acceptable for whole-game replays to include ScoreEvents (even if link text â€œshot countâ€ may count them; LinkFormatter change is out of scope per the constraint).
-- Only `src/events/recorder.ts` will be edited.
diff --git a/TODO.md b/TODO.md
deleted file mode 100644
index cfe48bf..0000000
--- a/TODO.md
+++ /dev/null
@@ -1,17 +0,0 @@
-# Todo
-
-## Controls Sync
-
-In 2p mode the on screen ball spin and cue power show the opponents choice when they hitBall however when it becomes that players turn the values have not been updated (in the local aim object) and when they hit the ball you get a surprise.
-
-## Snooker Concede Button
-
-Discuss, maybe all games need a concede button.
-
-## Aim Next in Snooker Not Working Well in 2p Mode
-
-In snooker in the very first break off shot should not point at red since it is annoying, other than that it should always aim at next available red or colour.
-
-## Scaling in Lower Menu Not Right
-
-The buttons and ball etc in lower area not filling available area vertically.
diff --git a/dist/2p.html b/dist/2p.html
index 9ab8072..839b4dc 100644
--- a/dist/2p.html
+++ b/dist/2p.html
@@ -42,12 +42,11 @@
     />
     <link rel="stylesheet" type="text/css" href="index.css" />
   </head>

   <body>
-    <main>
-      <div class="box">
+    <div class="box">
       <iframe
         src="index.html"
         title="P1"
         id="P1"
         width="620"
@@ -60,14 +59,13 @@
         src="index.html"
         title="P2"
         id="P2"
         width="620"
         height="450"
-          style="float: right"
-        ></iframe>
-      </div>
-    </main>
+        style="float: right"
+      ></iframe>
+    </div>
   </body>

   <script>
     const urlParams = new URLSearchParams(window.location.search)
     const websocketserver =
diff --git a/dist/compare.js b/dist/compare.js
index 3699b86..24530e1 100644
--- a/dist/compare.js
+++ b/dist/compare.js
@@ -1,6 +1,6 @@
-"use strict";(self.webpackChunkbilliards=self.webpackChunkbilliards||[]).push([[44],{"./src/compare.ts"(e,t,n){var r=n("./src/view/sliders.ts"),i=n("./src/diagram/diagramcontainer.ts"),o=n("./src/model/physics/physics.ts");document.addEventListener("DOMContentLoaded",function(){for(var e=document.getElementsByClassName("replaydiagram"),t=0;t<e.length;t++){var n=e.item(t),s=i.n.fromDiamgramElement(n);s.cushionModel=o.Qy,s.start()}new r.r})},"./src/container/container.ts"(e,t,n){n.d(t,{m:()=>$});var r=n("./src/network/client/session.ts"),i=n("./src/events/stationaryevent.ts"),o=n("./node_modules/three/build/three.core.js"),s=n("./src/utils/utils.ts"),a=n("./src/view/cameratop.ts"),l=n("./src/model/physics/constants.ts");function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var u=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");c(this,"camera",void 0),c(this,"mode",this.topView),c(this,"mainMode",this.aimView),c(this,"height",8*l.R),c(this,"target",new o.Pq0),c(this,"lookTarget",new o.Pq0),c(this,"tempVec",new o.Pq0),c(this,"elapsed",void 0),this.camera=new o.ubm(45,e,l.R,1e3*l.R)}return e=[{key:"update",value:function(e,t){this.elapsed=e,this.mode(t)}},{key:"topView",value:function(e){this.camera.fov=a.v.fov,this.camera.position.lerp(a.v.viewPoint(this.camera.aspect,this.camera.fov,this.tempVec),.9),this.camera.up=s.up,this.camera.lookAt(s.v_)}},{key:"aimView",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.08,n=this.height,r=this.camera.aspect<.8;if(this.camera.fov=r?60:40,n<10*l.R){var i=100*(10*l.R-n);this.camera.fov-=i*(r?3:1)}this.target.copy(e.pos).addScaledVector((0,s.Dz)(e.angle,this.tempVec),-(18*l.R)),this.camera.position.lerp(this.target,t),this.camera.position.z=n,this.camera.up=s.up,this.lookTarget.copy(e.pos).addScaledVector(s.up,n/2),this.camera.lookAt(this.lookTarget)}},{key:"adjustHeight",value:function(e){e=this.height<10*l.R?e/8:e,this.height=o.cj9.clamp(this.height+e,6*l.R,120*l.R),this.height>110*l.R&&this.suggestMode(this.topView),this.height<105*l.R&&this.suggestMode(this.aimView)}},{key:"suggestMode",value:function(e){this.mainMode===this.aimView&&(this.mode=e)}},{key:"forceMode",value:function(e){this.mode=e,this.mainMode=e}},{key:"forceMove",value:function(e){this.mode===this.aimView&&this.aimView(e,1)}},{key:"toggleMode",value:function(){this.mode===this.topView?this.mode=this.aimView:this.mode=this.topView,this.mainMode=this.mode}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),h=n("./src/view/tablegeometry.ts"),f=function(){var e;function t(){var e,n;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");e="material",n=new o.mrM({color:132,opacity:.15,transparent:!0}),e in this?Object.defineProperty(this,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):this[e]=n}return e=[{key:"generateLineSegments",value:function(){var e=this,t=[this.point(0,-11.13*l.R/.5),this.point(0,11.13*l.R/.5)],n=h.P.X/4,r=h.P.tableY+l.R;[1,2,3,-1,-2,-3].forEach(function(i){t.push(e.point(i*n,-r)),t.push(e.point(i*n,r))});var i=(h.P.Y+l.R)/2,s=h.P.tableX+l.R;[-1,0,1].forEach(function(n){t.push(e.point(-s,n*i)),t.push(e.point(s,n*i))});var a=new o.LoY().setFromPoints(t);return new o.DXC(a,this.material)}},{key:"point",value:function(e,t){var n=-(.485*l.R)/.5;return new o.Pq0(e,t,n)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),p=n("./node_modules/three/build/three.module.js"),d=n("./src/controller/rules/snooker.ts");function v(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var y=function(){var e;function t(e,n,r){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");v(this,"scene",new o.Z58),v(this,"renderer",void 0),v(this,"camera",void 0),v(this,"windowWidth",1),v(this,"windowHeight",1),v(this,"lastFov",0),v(this,"element",void 0),v(this,"table",void 0),v(this,"loadAssets",!0),v(this,"assets",void 0),v(this,"frustum",new o.PPD),v(this,"projScreenMatrix",new o.kn4),v(this,"ballToCheck",0),this.element=e,this.table=n,this.assets=r,this.renderer=function(e){if("u"<typeof process){var t=new p.JeP({antialias:!1});return t.shadowMap.enabled=!1,t.autoClear=!1,t.setSize(e.offsetWidth,e.offsetHeight),t.setPixelRatio(.75*window.devicePixelRatio),e.appendChild(t.domElement),t}}(e),this.camera=new u(e?e.offsetWidth/e.offsetHeight:1),this.initialiseScene()}return e=[{key:"update",value:function(e,t){this.camera.update(e,t)}},{key:"sizeChanged",value:function(){var e,t;return this.windowWidth!=(null==(e=this.element)?void 0:e.offsetWidth)||this.windowHeight!=(null==(t=this.element)?void 0:t.offsetHeight)}},{key:"updateSize",value:function(){var e,t,n=this.sizeChanged();return n&&(this.windowWidth=null==(e=this.element)?void 0:e.offsetWidth,this.windowHeight=null==(t=this.element)?void 0:t.offsetHeight),n}},{key:"render",value:function(){this.isInMotionNotVisible()&&this.camera.suggestMode(this.camera.topView),this.renderCamera(this.camera)}},{key:"renderCamera",value:function(e){var t=this.updateSize();if(t){var n,r,i,o,s,a=this.windowWidth,l=this.windowHeight;null==(r=this.renderer)||r.setSize(a,l),null==(i=this.renderer)||i.setViewport(0,0,a,l),null==(o=this.renderer)||o.setScissor(0,0,a,l),null==(s=this.renderer)||s.setScissorTest(!0),e.camera.aspect=a/l}(t||e.camera.fov!==this.lastFov)&&(e.camera.updateProjectionMatrix(),this.lastFov=e.camera.fov),null==(n=this.renderer)||n.render(this.scene,e.camera)}},{key:"initialiseScene",value:function(){this.scene.add(new o.$p8(39202,.3)),this.assets.background&&this.scene.add(this.assets.background),this.scene.add(this.assets.table),this.table.mesh=this.assets.table,this.assets.rules.asset()!==d.c.tablemodel&&this.scene.add(new f().generateLineSegments())}},{key:"isInMotionNotVisible",value:function(){var e=this.viewFrustum(),t=this.table.balls[this.ballToCheck++%this.table.balls.length];return t.inMotion()&&!e.intersectsObject(t.ballmesh.mesh)}},{key:"viewFrustum",value:function(){var e=this.camera.camera;return this.frustum.setFromProjectionMatrix(this.projScreenMatrix.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse)),this.frustum}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),m=n("./src/controller/init.ts"),b=n("./src/events/input.ts");function g(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var w=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");g(this,"line",new o.cZY),g(this,"balls",void 0),this.balls=e}return e=[{key:"getFirst",value:function(e,t){var n=this;this.line.set(e.pos,(0,s.xb)(t).multiplyScalar(4*h.P.X).add(e.pos));var r=new o.Pq0,i=this.balls.map(function(t){return n.line.closestPointToPoint(t.pos,!0,r),{ball:t,perpendicular:r.distanceTo(t.pos),distance:r.distanceTo(e.pos)}}).filter(function(e){return e.perpendicular<2*l.R}).filter(function(t){return t.ball!==e});return i.reduce(function(e,t){return e.distance<t.distance?e:t},i[0])}},{key:"getOverlapOffset",value:function(e,t){var n=this.getFirst(e,t);if(n){var r=n.ball.pos.clone().sub(e.pos),i=n.perpendicular*Math.sign(r.cross(t).z)/l.R;return{ball:n.ball,overlap:i}}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),k=n("./src/utils/dom.ts");function x(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var T=function(){var e;function t(e){var n,i=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");x(this,"cueBallElement",void 0),x(this,"cueTipElement",void 0),x(this,"cuePowerElement",void 0),x(this,"cueHitElement",void 0),x(this,"objectBallStyle",void 0),x(this,"container",void 0),x(this,"overlap",void 0),x(this,"ballWidth",void 0),x(this,"ballHeight",void 0),x(this,"tipRadius",void 0),x(this,"mousemove",function(e){1===e.buttons&&i.adjustSpin(e)}),x(this,"powerChanged",function(e){i.container.table.cue.setPower(i.cuePowerElement.value)}),x(this,"hit",function(e){var t;i.container.table.cue.setPower(null==(t=i.cuePowerElement)?void 0:t.value),i.container.inputQueue.push(new b.p(0,"SpaceUp"))}),x(this,"mousewheel",function(e){i.cuePowerElement&&(i.cuePowerElement.value-=Math.sign(e.deltaY)/10,i.container.table.cue.setPower(i.cuePowerElement.value),i.container.lastEventTime=performance.now())}),this.container=e,this.cueBallElement=(0,k.id)("cueBall"),this.cueTipElement=(0,k.id)("cueTip"),this.cuePowerElement=(0,k.id)("cuePower"),this.cueHitElement=(0,k.id)("cueHit"),this.objectBallStyle=null==(n=(0,k.id)("objectBall"))?void 0:n.style,this.overlap=new w(this.container.table.balls),this.addListeners(),r.N.isSpectator()&&this.setDisabled(!0)}return e=[{key:"addListeners",value:function(){var e,t,n,r,i,o=this;null==(e=this.cueBallElement)||e.addEventListener("pointermove",this.mousemove),null==(t=this.cueBallElement)||t.addEventListener("click",function(e){o.adjustSpin(e)}),null==(n=this.cueHitElement)||n.addEventListener("click",this.hit),null==(r=this.cuePowerElement)||r.addEventListener("change",this.powerChanged),"ontouchstart"in globalThis||null==(i=(0,k.id)("viewP1"))||i.addEventListener("dblclick",this.hit),document.addEventListener("wheel",this.mousewheel)}},{key:"setButtonText",value:function(e){this.cueHitElement&&(this.cueHitElement.innerText=e)}},{key:"setDisabled",value:function(e){this.cueHitElement&&(this.cueHitElement.disabled=e||r.N.isSpectator())}},{key:"readDimensions",value:function(){var e,t,n;this.ballWidth=null==(e=this.cueBallElement)?void 0:e.offsetWidth,this.ballHeight=null==(t=this.cueBallElement)?void 0:t.offsetHeight,this.tipRadius=(null==(n=this.cueTipElement)?void 0:n.offsetWidth)/2}},{key:"adjustSpin",value:function(e){this.readDimensions(),this.container.table.cue.setSpin(new o.Pq0(-(e.offsetX-this.ballWidth/2)/this.ballWidth,-(e.offsetY-this.ballHeight/2)/this.ballHeight),this.container.table),this.container.lastEventTime=performance.now()}},{key:"updateVisualState",value:function(e,t){this.readDimensions();var n,r=null==(n=this.cueTipElement)?void 0:n.style;r&&(r.left=(-e+.5)*this.ballWidth-this.tipRadius+"px",r.top=(-t+.5)*this.ballHeight-this.tipRadius+"px"),this.showOverlap()}},{key:"showOverlap",value:function(){if(this.objectBallStyle){var e=this.container.table,t=(0,s.Dz)(e.cue.aim.angle),n=this.overlap.getOverlapOffset(e.cueball,t);n?(this.readDimensions(),this.objectBallStyle.visibility="visible",this.objectBallStyle.left=5+n.overlap*this.ballWidth/2+"px",this.objectBallStyle.backgroundColor=new o.Q1f(0,0,0).lerp(n.ball.ballmesh.color,.5).getStyle()):this.objectBallStyle.visibility="hidden"}}},{key:"updatePowerSlider",value:function(e){var t;e>0&&(null==(t=this.cuePowerElement)?void 0:t.value)&&(this.cuePowerElement.value=e)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function P(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var S=function(){var e;function t(e){var n,r=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");P(this,"chatoutput",void 0),P(this,"chatInput",void 0),P(this,"chatSend",void 0),P(this,"chatInputText",void 0),P(this,"send",void 0),P(this,"sendClicked",function(e){var t,n;r.send(null==(t=r.chatInputText)?void 0:t.value),r.showMessage(null==(n=r.chatInputText)?void 0:n.value)}),this.chatoutput=(0,k.id)("chatoutput"),this.chatInputText=(0,k.V4)("chatinputtext"),this.chatSend=(0,k.id)("chatsend"),null==(n=this.chatSend)||n.addEventListener("click",this.sendClicked),this.send=e}return e=[{key:"showMessage",value:function(e){this.chatoutput&&(this.chatoutput.innerHTML+=e),this.updateScroll()}},{key:"updateScroll",value:function(){this.chatoutput&&(this.chatoutput.scrollTop=this.chatoutput.scrollHeight)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),O=n("./src/events/chatevent.ts"),R=n("./src/events/eventtype.ts");function E(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var A=function(){var e;function t(e,n){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");E(this,"period",void 0),E(this,"pending",null),E(this,"sentTime",0),E(this,"apply",function(e){}),this.period=e,this.apply=n}return e=[{key:"flush",value:function(){this.pending&&(this.apply(this.pending),this.pending=null)}},{key:"send",value:function(e){if(performance.now()>this.sentTime+this.period||e.type!==R.B.AIM){this.flush(),this.apply(e),this.sentTime=performance.now();return}this.pending=e}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),_=n("./src/view/sliders.ts"),M=n("./src/model/outcome.ts"),I=n("./src/utils/replay-encoder.ts");function C(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var j=function(){var e;function t(e,n){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");C(this,"container",void 0),C(this,"linkFormatter",void 0),C(this,"entries",[]),C(this,"start",Date.now()),C(this,"breakStart",void 0),C(this,"breakStartTime",void 0),this.container=e,this.linkFormatter=n}return e=[{key:"shots",get:function(){return this.entries.map(function(e){return e.event})}},{key:"states",get:function(){return this.entries.map(function(e){return e.state})}},{key:"record",value:function(e){var t=e;e.type===R.B.HIT&&(t=e.tablejson.aim),(e.type===R.B.HIT||e.type===R.B.RERACK||e.type===R.B.PLACEBALL||e.type===R.B.SCORE)&&this.entries.push({state:this.container.table.shortSerialise(),event:t,pots:0,isPartOfBreak:!1,time:Date.now()})}},{key:"findLastIndex",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[R.B.RERACK,R.B.SCORE],t=this.entries.length-1;t>=0&&e.includes(this.entries[t].event.type);)t--;return t}},{key:"getPlayerNames",value:function(){if(r.N.hasInstance()){var e=r.N.getInstance(),t=0===e.playerIndex;return{player1:(t?e.playername:e.opponentName)||"Player 1",player2:(t?e.opponentName:e.playername)||"Player 2"}}}},{key:"wholeGame",value:function(){var e;return I.k.createState(null==(e=this.entries[0])?void 0:e.state,this.entries.map(function(e){return e.event}),this.start,this.container.scores[r.N.playerIndex()],!0,this.getPlayerNames())}},{key:"last",value:function(){return this.findLastIndex()}},{key:"lastShot",value:function(){var e=this.last();if(!(e<0)){for(var t=this.entries[e],n=[t.event],r=e+1;r<this.entries.length;r++)this.entries[r].event.type===R.B.SCORE&&n.push(this.entries[r].event);return I.k.createState(t.state,n,0,0,!1,this.getPlayerNames())}}},{key:"currentBreak",value:function(){if(void 0!==this.breakStart){var e=this.entries.slice(this.breakStart);return I.k.createState(this.entries[this.breakStart].state,e.map(function(e){return e.event}),this.breakStartTime,this.container.rules.previousBreak,!1,this.getPlayerNames())}}},{key:"updateBreak",value:function(e,t,n){var r=M.P.potCount(e),i=this.last();if(i>=0&&(this.entries[i].pots=r,this.entries[i].isPartOfBreak=t),t||this.breakLink(n),this.lastShotLink(t||n,r,M.P.pots(e)),n&&this.breakLink(n),!t){this.breakStart=void 0;return}void 0===this.breakStart&&(this.breakStart=i,this.breakStartTime=Date.now())}},{key:"lastShotLink",value:function(e,t,n){var r=this.lastShot();r&&this.linkFormatter.lastShotLink(e,t,n,r)}},{key:"breakLink",value:function(e){var t=this.currentBreak();if(t){var n=0===this.container.rules.currentBreak?this.container.rules.previousBreak:this.container.rules.currentBreak;if(e)return void this.linkFormatter.breakLink(t,n,!0);for(var r=t.shots.slice();r.length>0&&(r[r.length-1].type===R.B.SCORE||r[r.length-1].type===R.B.RERACK);)r.pop();if(0!==r.length){var i,o,s=(i=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(t){C(e,t,n[t])})}return e}({},t),o=o={shots:r},Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(o)):(function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t.push.apply(t,n)}return t})(Object(o)).forEach(function(e){Object.defineProperty(i,e,Object.getOwnPropertyDescriptor(o,e))}),i);this.linkFormatter.breakLink(s,n,!1)}}}},{key:"wholeGameLink",value:function(){this.linkFormatter.wholeGameLink(this.wholeGame())}},{key:"getPastShots",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[R.B.RERACK,R.B.SCORE],n=[],r=this.entries.length-1;r>=0&&n.length<e;r--)t.includes(this.entries[r].event.type)||n.unshift(this.entries[r]);return n}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function B(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var L=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");B(this,"container",void 0),B(this,"replayUrl",""),B(this,"hiScoreUrl","https://scoreboard-tailuge.vercel.app/hiscore.html"),this.container=e}return e=[{key:"lastShotLink",value:function(e,t,n,r){var i="#000000";n.length>0&&n.forEach(function(e){e.ballmesh&&(i="#"+e.ballmesh.color.getHexString())});var o="âšˆ".repeat(t>1?t-1:0)+(e?"âšˆ":"âš†"),s=JSON.stringify(r);this.generateLink(o,s,i)}},{key:"breakLink",value:function(e,t,n){if(e&&(n||e.shots.pop(),1!==e.shots.length)){e.score=t;var r=JSON.stringify(e),i=I.k.crush(r);this.generateLink("break(".concat(t,")"),i,"black"),t>=2&&this.generateHiScoreLink(i)}}},{key:"wholeGameLink",value:function(e){var t="frame(".concat(this.shotCount(e.shots)," shots)"),n=JSON.stringify(e),r=I.k.crush(n);this.generateLink(t,r,"black")}},{key:"shotCount",value:function(e){return e.filter(function(e){return"RERACK"!==e.type}).length}},{key:"generateLink",value:function(e,t,n){var r="".concat(this.replayUrl).concat(I.k.fullyEncodeURI(t)),i='<a class="pill" style="color: '.concat(n,'" target="_blank" href="').concat(r,'">').concat(e,"</a>");this.container.eventQueue.push(new O.b(null,"".concat(i)))}},{key:"generateHiScoreLink",value:function(e){var t="".concat(this.hiScoreUrl,"?ruletype=").concat(this.container.rules.rulename,"&state=").concat(I.k.fullyEncodeURI(e)),n='<a class="pill" target="_blank" href="'.concat(t,'">').concat("hi score ðŸ†","</a>");this.container.eventQueue.push(new O.b(null,"".concat(n)))}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),N=n("./src/controller/rules/rulefactory.ts");function F(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var H=function(){var e;function t(e){var n=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");F(this,"container",void 0),F(this,"share",void 0),F(this,"camera",void 0),F(this,"disabled",!0),this.container=e,this.share=this.getElement("share"),this.camera=this.getElement("camera"),this.share&&(this.share.disabled=!0),this.camera&&(this.camera.onclick=function(e){n.adjustCamera()})}return e=[{key:"adjustCamera",value:function(){this.container.view.camera.toggleMode(),this.container.lastEventTime=performance.now()}},{key:"getElement",value:function(e){return(0,k.vq)(e)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function U(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var D=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");U(this,"p1Element",void 0),U(this,"p2Element",void 0),U(this,"breakElement",void 0),this.p1Element=(0,k.id)("p1Score"),this.p2Element=(0,k.id)("p2Score"),this.breakElement=(0,k.id)("breakScore")}return e=[{key:"setText",value:function(e,t){e&&(e.textContent=t)}},{key:"updateBreak",value:function(e){this.setText(this.p1Element,""),this.setText(this.p2Element,""),e>0&&this.breakElement?this.breakElement.innerHTML="Break</br>"+e:this.setText(this.breakElement,"")}},{key:"updateScores",value:function(e,t,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;this.setText(this.p1Element,""),this.setText(this.p2Element,""),this.setText(this.breakElement,""),n&&r?(this.setText(this.p1Element,"".concat(n,": ").concat(e)),this.setText(this.p2Element,"".concat(r,": ").concat(t))):n?this.setText(this.p1Element,"".concat(n,": ").concat(e)):r?this.setText(this.p2Element,"".concat(r,": ").concat(t)):this.setText(this.p1Element,"Score: ".concat(e)),i>0&&this.setText(this.breakElement,"Break: ".concat(i))}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function z(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function G(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var V=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");G(this,"element",void 0),G(this,"timeoutId",null),this.element=(0,k.id)("notification")}return e=[{key:"getIcon",value:function(e){return e.icon?e.icon:"Foul"===e.type?"ðŸŽ±":"GameOver"===e.type?"ðŸ†":"ðŸ”µ"}},{key:"show",value:function(e){var t,n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3e3;if(this.element){var i=r;if("string"==typeof e)t=this.renderStringContent(e),n="type-Info";else{var o=this.processData(e);t=o.content,n=o.typeClass,void 0!==e.duration&&(i=e.duration)}this.display(t,n,i)}}},{key:"renderStringContent",value:function(e){return`
+"use strict";(self.webpackChunkbilliards=self.webpackChunkbilliards||[]).push([[44],{"./src/compare.ts"(e,t,n){var r=n("./src/view/sliders.ts"),i=n("./src/diagram/diagramcontainer.ts"),o=n("./src/model/physics/physics.ts");document.addEventListener("DOMContentLoaded",function(){for(var e=document.getElementsByClassName("replaydiagram"),t=0;t<e.length;t++){var n=e.item(t),s=i.n.fromDiamgramElement(n);s.cushionModel=o.Qy,s.start()}new r.r})},"./src/container/container.ts"(e,t,n){n.d(t,{m:()=>$});var r=n("./src/network/client/session.ts"),i=n("./src/events/stationaryevent.ts"),o=n("./node_modules/three/build/three.core.js"),s=n("./src/utils/utils.ts"),a=n("./src/view/cameratop.ts"),l=n("./src/model/physics/constants.ts");function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var u=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");c(this,"camera",void 0),c(this,"mode",this.topView),c(this,"mainMode",this.aimView),c(this,"height",8*l.R),c(this,"target",new o.Pq0),c(this,"lookTarget",new o.Pq0),c(this,"tempVec",new o.Pq0),c(this,"elapsed",void 0),this.camera=new o.ubm(45,e,l.R,1e3*l.R)}return e=[{key:"update",value:function(e,t){this.elapsed=e,this.mode(t)}},{key:"topView",value:function(e){this.camera.fov=a.v.fov,this.camera.position.lerp(a.v.viewPoint(this.camera.aspect,this.camera.fov,this.tempVec),.9),this.camera.up=s.up,this.camera.lookAt(s.v_)}},{key:"aimView",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.08,n=this.height,r=this.camera.aspect<.8;if(this.camera.fov=r?60:40,n<10*l.R){var i=100*(10*l.R-n);this.camera.fov-=i*(r?3:1)}this.target.copy(e.pos).addScaledVector((0,s.Dz)(e.angle,this.tempVec),-(18*l.R)),this.camera.position.lerp(this.target,t),this.camera.position.z=n,this.camera.up=s.up,this.lookTarget.copy(e.pos).addScaledVector(s.up,n/2),this.camera.lookAt(this.lookTarget)}},{key:"adjustHeight",value:function(e){e=this.height<10*l.R?e/8:e,this.height=o.cj9.clamp(this.height+e,6*l.R,120*l.R),this.height>110*l.R&&this.suggestMode(this.topView),this.height<105*l.R&&this.suggestMode(this.aimView)}},{key:"suggestMode",value:function(e){this.mainMode===this.aimView&&(this.mode=e)}},{key:"forceMode",value:function(e){this.mode=e,this.mainMode=e}},{key:"forceMove",value:function(e){this.mode===this.aimView&&this.aimView(e,1)}},{key:"toggleMode",value:function(){this.mode===this.topView?this.mode=this.aimView:this.mode=this.topView,this.mainMode=this.mode}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),h=n("./src/view/tablegeometry.ts"),f=function(){var e;function t(){var e,n;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");e="material",n=new o.mrM({color:132,opacity:.15,transparent:!0}),e in this?Object.defineProperty(this,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):this[e]=n}return e=[{key:"generateLineSegments",value:function(){var e=this,t=[this.point(0,-11.13*l.R/.5),this.point(0,11.13*l.R/.5)],n=h.P.X/4,r=h.P.tableY+l.R;[1,2,3,-1,-2,-3].forEach(function(i){t.push(e.point(i*n,-r)),t.push(e.point(i*n,r))});var i=(h.P.Y+l.R)/2,s=h.P.tableX+l.R;[-1,0,1].forEach(function(n){t.push(e.point(-s,n*i)),t.push(e.point(s,n*i))});var a=new o.LoY().setFromPoints(t);return new o.DXC(a,this.material)}},{key:"point",value:function(e,t){var n=-(.485*l.R)/.5;return new o.Pq0(e,t,n)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),p=n("./node_modules/three/build/three.module.js"),d=n("./src/controller/rules/snooker.ts");function v(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var y=function(){var e;function t(e,n,r){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");v(this,"scene",new o.Z58),v(this,"renderer",void 0),v(this,"camera",void 0),v(this,"windowWidth",1),v(this,"windowHeight",1),v(this,"lastFov",0),v(this,"element",void 0),v(this,"table",void 0),v(this,"loadAssets",!0),v(this,"assets",void 0),v(this,"frustum",new o.PPD),v(this,"projScreenMatrix",new o.kn4),v(this,"ballToCheck",0),this.element=e,this.table=n,this.assets=r,this.renderer=function(e){if("u"<typeof process){var t=new p.JeP({antialias:!1});return t.shadowMap.enabled=!1,t.autoClear=!1,t.setSize(e.offsetWidth,e.offsetHeight),t.setPixelRatio(.75*window.devicePixelRatio),e.appendChild(t.domElement),t}}(e),this.camera=new u(e?e.offsetWidth/e.offsetHeight:1),this.initialiseScene()}return e=[{key:"update",value:function(e,t){this.camera.update(e,t)}},{key:"sizeChanged",value:function(){var e,t;return this.windowWidth!=(null==(e=this.element)?void 0:e.offsetWidth)||this.windowHeight!=(null==(t=this.element)?void 0:t.offsetHeight)}},{key:"updateSize",value:function(){var e,t,n=this.sizeChanged();return n&&(this.windowWidth=null==(e=this.element)?void 0:e.offsetWidth,this.windowHeight=null==(t=this.element)?void 0:t.offsetHeight),n}},{key:"render",value:function(){this.isInMotionNotVisible()&&this.camera.suggestMode(this.camera.topView),this.renderCamera(this.camera)}},{key:"renderCamera",value:function(e){var t=this.updateSize();if(t){var n,r,i,o,s,a=this.windowWidth,l=this.windowHeight;null==(r=this.renderer)||r.setSize(a,l),null==(i=this.renderer)||i.setViewport(0,0,a,l),null==(o=this.renderer)||o.setScissor(0,0,a,l),null==(s=this.renderer)||s.setScissorTest(!0),e.camera.aspect=a/l}(t||e.camera.fov!==this.lastFov)&&(e.camera.updateProjectionMatrix(),this.lastFov=e.camera.fov),null==(n=this.renderer)||n.render(this.scene,e.camera)}},{key:"initialiseScene",value:function(){this.scene.add(new o.$p8(39202,.3)),this.assets.background&&this.scene.add(this.assets.background),this.scene.add(this.assets.table),this.table.mesh=this.assets.table,this.assets.rules.asset()!==d.c.tablemodel&&this.scene.add(new f().generateLineSegments())}},{key:"isInMotionNotVisible",value:function(){var e=this.viewFrustum(),t=this.table.balls[this.ballToCheck++%this.table.balls.length];return t.inMotion()&&!e.intersectsObject(t.ballmesh.mesh)}},{key:"viewFrustum",value:function(){var e=this.camera.camera;return this.frustum.setFromProjectionMatrix(this.projScreenMatrix.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse)),this.frustum}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),m=n("./src/controller/init.ts"),b=n("./src/events/input.ts");function g(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var w=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");g(this,"line",new o.cZY),g(this,"balls",void 0),this.balls=e}return e=[{key:"getFirst",value:function(e,t){var n=this;this.line.set(e.pos,(0,s.xb)(t).multiplyScalar(4*h.P.X).add(e.pos));var r=new o.Pq0,i=this.balls.map(function(t){return n.line.closestPointToPoint(t.pos,!0,r),{ball:t,perpendicular:r.distanceTo(t.pos),distance:r.distanceTo(e.pos)}}).filter(function(e){return e.perpendicular<2*l.R}).filter(function(t){return t.ball!==e});return i.reduce(function(e,t){return e.distance<t.distance?e:t},i[0])}},{key:"getOverlapOffset",value:function(e,t){var n=this.getFirst(e,t);if(n){var r=n.ball.pos.clone().sub(e.pos),i=n.perpendicular*Math.sign(r.cross(t).z)/l.R;return{ball:n.ball,overlap:i}}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),k=n("./src/utils/dom.ts");function x(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var T=function(){var e;function t(e){var n,i=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");x(this,"cueBallElement",void 0),x(this,"cueTipElement",void 0),x(this,"cuePowerElement",void 0),x(this,"cueHitElement",void 0),x(this,"objectBallStyle",void 0),x(this,"container",void 0),x(this,"overlap",void 0),x(this,"ballWidth",void 0),x(this,"ballHeight",void 0),x(this,"tipRadius",void 0),x(this,"mousemove",function(e){1===e.buttons&&i.adjustSpin(e)}),x(this,"powerChanged",function(e){i.container.table.cue.setPower(i.cuePowerElement.value)}),x(this,"hit",function(e){var t;i.container.table.cue.setPower(null==(t=i.cuePowerElement)?void 0:t.value),i.container.inputQueue.push(new b.p(0,"SpaceUp"))}),x(this,"mousewheel",function(e){i.cuePowerElement&&(i.cuePowerElement.value-=Math.sign(e.deltaY)/10,i.container.table.cue.setPower(i.cuePowerElement.value),i.container.lastEventTime=performance.now())}),this.container=e,this.cueBallElement=(0,k.id)("cueBall"),this.cueTipElement=(0,k.id)("cueTip"),this.cuePowerElement=(0,k.id)("cuePower"),this.cueHitElement=(0,k.id)("cueHit"),this.objectBallStyle=null==(n=(0,k.id)("objectBall"))?void 0:n.style,this.overlap=new w(this.container.table.balls),this.addListeners(),r.N.isSpectator()&&this.setDisabled(!0)}return e=[{key:"addListeners",value:function(){var e,t,n,r,i,o=this;null==(e=this.cueBallElement)||e.addEventListener("pointermove",this.mousemove),null==(t=this.cueBallElement)||t.addEventListener("click",function(e){o.adjustSpin(e)}),null==(n=this.cueHitElement)||n.addEventListener("click",this.hit),null==(r=this.cuePowerElement)||r.addEventListener("change",this.powerChanged),"ontouchstart"in globalThis||null==(i=(0,k.id)("viewP1"))||i.addEventListener("dblclick",this.hit),document.addEventListener("wheel",this.mousewheel)}},{key:"setButtonText",value:function(e){this.cueHitElement&&(this.cueHitElement.innerText=e)}},{key:"setDisabled",value:function(e){this.cueHitElement&&(this.cueHitElement.disabled=e||r.N.isSpectator())}},{key:"readDimensions",value:function(){var e,t,n;this.ballWidth=null==(e=this.cueBallElement)?void 0:e.offsetWidth,this.ballHeight=null==(t=this.cueBallElement)?void 0:t.offsetHeight,this.tipRadius=(null==(n=this.cueTipElement)?void 0:n.offsetWidth)/2}},{key:"adjustSpin",value:function(e){this.readDimensions(),this.container.table.cue.setSpin(new o.Pq0(-(e.offsetX-this.ballWidth/2)/this.ballWidth,-(e.offsetY-this.ballHeight/2)/this.ballHeight),this.container.table),this.container.lastEventTime=performance.now()}},{key:"updateVisualState",value:function(e,t){this.readDimensions();var n,r=null==(n=this.cueTipElement)?void 0:n.style;r&&(r.left=(-e+.5)*this.ballWidth-this.tipRadius+"px",r.top=(-t+.5)*this.ballHeight-this.tipRadius+"px"),this.showOverlap()}},{key:"showOverlap",value:function(){if(this.objectBallStyle){var e=this.container.table,t=(0,s.Dz)(e.cue.aim.angle),n=this.overlap.getOverlapOffset(e.cueball,t);n?(this.readDimensions(),this.objectBallStyle.visibility="visible",this.objectBallStyle.left=5+n.overlap*this.ballWidth/2+"px",this.objectBallStyle.backgroundColor=new o.Q1f(0,0,0).lerp(n.ball.ballmesh.color,.5).getStyle()):this.objectBallStyle.visibility="hidden"}}},{key:"updatePowerSlider",value:function(e){var t;e>0&&(null==(t=this.cuePowerElement)?void 0:t.value)&&(this.cuePowerElement.value=e)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function P(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var S=function(){var e;function t(e){var n,r=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");P(this,"chatoutput",void 0),P(this,"chatInput",void 0),P(this,"chatSend",void 0),P(this,"chatInputText",void 0),P(this,"send",void 0),P(this,"sendClicked",function(e){var t,n;r.send(null==(t=r.chatInputText)?void 0:t.value),r.showMessage(null==(n=r.chatInputText)?void 0:n.value)}),this.chatoutput=(0,k.id)("chatoutput"),this.chatInputText=(0,k.V4)("chatinputtext"),this.chatSend=(0,k.id)("chatsend"),null==(n=this.chatSend)||n.addEventListener("click",this.sendClicked),this.send=e}return e=[{key:"showMessage",value:function(e){this.chatoutput&&(this.chatoutput.innerHTML+=e),this.updateScroll()}},{key:"updateScroll",value:function(){this.chatoutput&&(this.chatoutput.scrollTop=this.chatoutput.scrollHeight)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),O=n("./src/events/chatevent.ts"),R=n("./src/events/eventtype.ts");function E(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var A=function(){var e;function t(e,n){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");E(this,"period",void 0),E(this,"pending",null),E(this,"sentTime",0),E(this,"apply",function(e){}),this.period=e,this.apply=n}return e=[{key:"flush",value:function(){this.pending&&(this.apply(this.pending),this.pending=null)}},{key:"send",value:function(e){if(performance.now()>this.sentTime+this.period||e.type!==R.B.AIM){this.flush(),this.apply(e),this.sentTime=performance.now();return}this.pending=e}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),M=n("./src/view/sliders.ts"),_=n("./src/model/outcome.ts"),I=n("./src/utils/replay-encoder.ts");function C(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var j=function(){var e;function t(e,n){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");C(this,"container",void 0),C(this,"linkFormatter",void 0),C(this,"entries",[]),C(this,"start",Date.now()),C(this,"breakStart",void 0),C(this,"breakStartTime",void 0),this.container=e,this.linkFormatter=n}return e=[{key:"shots",get:function(){return this.entries.map(function(e){return e.event})}},{key:"states",get:function(){return this.entries.map(function(e){return e.state})}},{key:"record",value:function(e){var t=e;e.type===R.B.HIT&&(t=e.tablejson.aim),(e.type===R.B.HIT||e.type===R.B.RERACK||e.type===R.B.PLACEBALL||e.type===R.B.SCORE)&&this.entries.push({state:this.container.table.shortSerialise(),event:t,pots:0,isPartOfBreak:!1,time:Date.now()})}},{key:"findLastIndex",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[R.B.RERACK,R.B.SCORE],t=this.entries.length-1;t>=0&&e.includes(this.entries[t].event.type);)t--;return t}},{key:"getPlayerNames",value:function(){if(r.N.hasInstance()){var e=r.N.getInstance(),t=0===e.playerIndex;return{player1:(t?e.playername:e.opponentName)||"Player",player2:(t?e.opponentName:e.playername)||"Opponent"}}}},{key:"wholeGame",value:function(){var e;return I.k.createState(null==(e=this.entries[0])?void 0:e.state,this.entries.map(function(e){return e.event}),this.start,this.container.scores[r.N.playerIndex()],!0,this.getPlayerNames())}},{key:"last",value:function(){return this.findLastIndex()}},{key:"lastShot",value:function(){var e=this.last();if(!(e<0)){for(var t=this.entries[e],n=[t.event],r=e+1;r<this.entries.length;r++)this.entries[r].event.type===R.B.SCORE&&n.push(this.entries[r].event);return I.k.createState(t.state,n,0,0,!1,this.getPlayerNames())}}},{key:"currentBreak",value:function(){if(void 0!==this.breakStart){var e=this.entries.slice(this.breakStart);return I.k.createState(this.entries[this.breakStart].state,e.map(function(e){return e.event}),this.breakStartTime,this.container.rules.previousBreak,!1,this.getPlayerNames())}}},{key:"updateBreak",value:function(e,t,n){var r=_.P.potCount(e),i=this.last();if(i>=0&&(this.entries[i].pots=r,this.entries[i].isPartOfBreak=t),t||this.breakLink(n),this.lastShotLink(t||n,r,_.P.pots(e)),n&&this.breakLink(n),!t){this.breakStart=void 0;return}void 0===this.breakStart&&(this.breakStart=i,this.breakStartTime=Date.now())}},{key:"lastShotLink",value:function(e,t,n){var r=this.lastShot();r&&this.linkFormatter.lastShotLink(e,t,n,r)}},{key:"breakLink",value:function(e){var t=this.currentBreak();if(t){var n=0===this.container.rules.currentBreak?this.container.rules.previousBreak:this.container.rules.currentBreak;if(e)return void this.linkFormatter.breakLink(t,n,!0);for(var r=t.shots.slice();r.length>0&&(r[r.length-1].type===R.B.SCORE||r[r.length-1].type===R.B.RERACK);)r.pop();if(0!==r.length){var i,o,s=(i=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(t){C(e,t,n[t])})}return e}({},t),o=o={shots:r},Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(o)):(function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t.push.apply(t,n)}return t})(Object(o)).forEach(function(e){Object.defineProperty(i,e,Object.getOwnPropertyDescriptor(o,e))}),i);this.linkFormatter.breakLink(s,n,!1)}}}},{key:"wholeGameLink",value:function(){this.linkFormatter.wholeGameLink(this.wholeGame())}},{key:"getPastShots",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[R.B.RERACK,R.B.SCORE],n=[],r=this.entries.length-1;r>=0&&n.length<e;r--)t.includes(this.entries[r].event.type)||n.unshift(this.entries[r]);return n}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function B(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var L=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");B(this,"container",void 0),B(this,"replayUrl",""),B(this,"hiScoreUrl","https://scoreboard-tailuge.vercel.app/hiscore.html"),this.container=e}return e=[{key:"lastShotLink",value:function(e,t,n,r){var i="#000000";n.length>0&&n.forEach(function(e){e.ballmesh&&(i="#"+e.ballmesh.color.getHexString())});var o="âšˆ".repeat(t>1?t-1:0)+(e?"âšˆ":"âš†"),s=JSON.stringify(r);this.generateLink(o,s,i)}},{key:"breakLink",value:function(e,t,n){if(e&&(n||e.shots.pop(),1!==e.shots.length)){e.score=t;var r=JSON.stringify(e),i=I.k.crush(r);this.generateLink("break(".concat(t,")"),i,"black"),t>=2&&this.generateHiScoreLink(i)}}},{key:"wholeGameLink",value:function(e){var t="frame(".concat(this.shotCount(e.shots)," shots)"),n=JSON.stringify(e),r=I.k.crush(n);this.generateLink(t,r,"black")}},{key:"shotCount",value:function(e){return e.filter(function(e){return"RERACK"!==e.type}).length}},{key:"generateLink",value:function(e,t,n){var r="".concat(this.replayUrl).concat(I.k.fullyEncodeURI(t)),i='<a class="pill" style="color: '.concat(n,'" target="_blank" href="').concat(r,'">').concat(e,"</a>");this.container.eventQueue.push(new O.b(null,"".concat(i)))}},{key:"generateHiScoreLink",value:function(e){var t="".concat(this.hiScoreUrl,"?ruletype=").concat(this.container.rules.rulename,"&state=").concat(I.k.fullyEncodeURI(e)),n='<a class="pill" target="_blank" href="'.concat(t,'">').concat("hi score ðŸ†","</a>");this.container.eventQueue.push(new O.b(null,"".concat(n)))}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),N=n("./src/controller/rules/rulefactory.ts");function F(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var H=function(){var e;function t(e){var n=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");F(this,"container",void 0),F(this,"share",void 0),F(this,"camera",void 0),F(this,"disabled",!0),this.container=e,this.share=this.getElement("share"),this.camera=this.getElement("camera"),this.share&&(this.share.disabled=!0),this.camera&&(this.camera.onclick=function(e){n.adjustCamera()})}return e=[{key:"adjustCamera",value:function(){this.container.view.camera.toggleMode(),this.container.lastEventTime=performance.now()}},{key:"getElement",value:function(e){return(0,k.vq)(e)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function U(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var D=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");U(this,"p1Element",void 0),U(this,"p2Element",void 0),U(this,"breakElement",void 0),this.p1Element=(0,k.id)("p1Score"),this.p2Element=(0,k.id)("p2Score"),this.breakElement=(0,k.id)("breakScore")}return e=[{key:"setText",value:function(e,t){e&&(e.textContent=t)}},{key:"updateBreak",value:function(e){this.setText(this.p1Element,""),this.setText(this.p2Element,""),e>0&&this.breakElement?this.breakElement.innerHTML="Break</br>"+e:this.setText(this.breakElement,"")}},{key:"updateScores",value:function(e,t,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;this.setText(this.p1Element,""),this.setText(this.p2Element,""),this.setText(this.breakElement,""),n&&r?(this.setText(this.p1Element,"".concat(n,": ").concat(e)),this.setText(this.p2Element,"".concat(r,": ").concat(t))):n?this.setText(this.p1Element,"".concat(n,": ").concat(e)):r?this.setText(this.p2Element,"".concat(r,": ").concat(t)):this.setText(this.p1Element,"Score: ".concat(e)),i>0&&this.setText(this.breakElement,"Break: ".concat(i))}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function z(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function G(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var V=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");G(this,"element",void 0),G(this,"timeoutId",null),this.element=(0,k.id)("notification")}return e=[{key:"getIcon",value:function(e){return e.icon?e.icon:"Foul"===e.type?"ðŸŽ±":"GameOver"===e.type?"ðŸ†":"ðŸ”µ"}},{key:"show",value:function(e){var t,n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3e3;if(this.element){var i=r;if("string"==typeof e)t=this.renderStringContent(e),n="type-Info";else{var o=this.processData(e);t=o.content,n=o.typeClass,void 0!==e.duration&&(i=e.duration)}this.display(t,n,i)}}},{key:"renderStringContent",value:function(e){return`
       <div class="notification-banner">
         <div class="notification-text-group">
           <div class="notification-subtext">`.concat(e,`</div>
         </div>
       </div>
@@ -11,12 +11,12 @@
           <div class="notification-title">`).concat(e.title,`</div>
           `).concat(e.subtext?'<div class="notification-subtext">'.concat(e.subtext,"</div>"):"",`
         </div>
       </div>
       `).concat(r,`
-    `),typeClass:t}}},{key:"renderExtra",value:function(e){return e?e.includes("<")?'<div class="notification-extra">'.concat(e,"</div>"):'<div class="notification-badge">'.concat(e,"</div>"):""}},{key:"display",value:function(e,t,n){var r,i,o=this;this.element&&(this.element.innerHTML=e,this.element.className="",(i=this.element.classList).add.apply(i,function(e){if(Array.isArray(e))return z(e)}(r=t.split(" "))||function(e){if("u">typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(r)||function(e){if(e){if("string"==typeof e)return z(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return z(e,void 0)}}(r)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),this.element.style.display="flex",this.timeoutId&&globalThis.clearTimeout(this.timeoutId),n>0&&(this.timeoutId=globalThis.setTimeout(function(){o.clear()},n)))}},{key:"clear",value:function(){this.element&&(this.element.innerHTML="",this.element.style.display="none",this.element.className=""),this.timeoutId&&(globalThis.clearTimeout(this.timeoutId),this.timeoutId=null)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),q=n("./src/events/notificationevent.ts");function K(e,t,n,r,i,o,s){try{var a=e[o](s),l=a.value}catch(e){n(e);return}a.done?t(l):Promise.resolve(l).then(r,i)}function X(e){return function(){var t=this,n=arguments;return new Promise(function(r,i){var o=e.apply(t,n);function s(e){K(o,r,i,s,a,"next",e)}function a(e){K(o,r,i,s,a,"throw",e)}s(void 0)})}}function W(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Y(e,t){var n,r,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype),a=Object.defineProperty;return a(s,"next",{value:l(0)}),a(s,"throw",{value:l(1)}),a(s,"return",{value:l(2)}),"function"==typeof Symbol&&a(s,Symbol.iterator,{value:function(){return this}}),s;function l(a){return function(l){var c=[a,l];if(n)throw TypeError("Generator is already executing.");for(;s&&(s=0,c[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&c[0]?r.return:c[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,c[1])).done)return i;switch(r=0,i&&(c=[2&c[0],i.value]),c[0]){case 0:case 1:i=c;break;case 4:return o.label++,{value:c[1],done:!1};case 5:o.label++,r=c[1],c=[0];continue;case 7:c=o.ops.pop(),o.trys.pop();continue;default:if(!(i=(i=o.trys).length>0&&i[i.length-1])&&(6===c[0]||2===c[0])){o=0;continue}if(3===c[0]&&(!i||c[1]>i[0]&&c[1]<i[3])){o.label=c[1];break}if(6===c[0]&&o.label<i[1]){o.label=i[1],i=c;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(c);break}i[2]&&o.ops.pop(),o.trys.pop();continue}c=t.call(e,o)}catch(e){c=[6,e],r=0}finally{n=i=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}}var J=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");W(this,"relay",void 0),W(this,"element",void 0),this.relay=e,this.element=(0,k.id)("lobby")}return e=[{key:"init",value:function(){return X(function(){var e,t;return Y(this,function(n){switch(n.label){case 0:if(e=this,!this.relay||!this.element)return[2];return[4,(t=function(){return X(function(){var e,t;return Y(this,function(n){switch(n.label){case 0:return[4,null==(e=this.relay)?void 0:e.getOnlineCount()];case 1:return null!==(t=n.sent())&&this.element&&(this.element.textContent=" ".concat(t," ðŸ‘¥")),[2]}})}).call(e)})()];case 1:return n.sent(),this.relay.subscribe("lobby",function(e){try{var n=JSON.parse(e);"connected"===n.action&&t()}catch(e){}},"lobby"),[2]}})}).call(this)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),Z=n("./src/events/scoreevent.ts");function Q(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var $=function(){var e;function t(e,n,r,i,o,s){var a=this,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");Q(this,"table",void 0),Q(this,"view",void 0),Q(this,"controller",void 0),Q(this,"inputQueue",[]),Q(this,"eventQueue",[]),Q(this,"keyboard",void 0),Q(this,"sound",void 0),Q(this,"chat",void 0),Q(this,"sliders",void 0),Q(this,"recorder",void 0),Q(this,"linkFormatter",void 0),Q(this,"id",""),Q(this,"isSinglePlayer",!0),Q(this,"rules",void 0),Q(this,"menu",void 0),Q(this,"hud",void 0),Q(this,"notification",void 0),Q(this,"lobbyIndicator",void 0),Q(this,"relay",null),Q(this,"scoreReporter",null),Q(this,"frame",void 0),Q(this,"scores",[0,0]),Q(this,"currentBreak",0),Q(this,"last",performance.now()),Q(this,"step",.001953125),Q(this,"broadcast",function(){}),Q(this,"log",void 0),Q(this,"sendChat",function(e){a.sendEvent(new O.b(a.id,e))}),Q(this,"throttle",new A(0,function(e){a.broadcast(e)})),Q(this,"lastEventTime",performance.now()),this.log=n,this.rules=N.V.create(i,this),this.table=this.rules.table(),this.view=new y(e,this.table,r),this.table.cue.aimInputs=new T(this),this.keyboard=o,this.sound=r.sound,this.chat=new S(this.sendChat),this.sliders=new _.r,this.linkFormatter=new L(this),this.recorder=new j(this,this.linkFormatter),this.id=s,this.menu=new H(this),this.table.addToScene(this.view.scene),this.hud=new D,this.notification=new V,this.relay=l,this.scoreReporter=c,this.lobbyIndicator=new J(this.relay),this.lobbyIndicator.init(),this.updateController(new m.J(this))}return e=[{key:"sendEvent",value:function(e){this.recorder.record(e),this.throttle.send(e)}},{key:"updateScoreHud",value:function(e,t,n){this.scores=[e,t],this.currentBreak=n;var i=void 0,o=void 0;if(r.N.hasInstance()){var s=r.N.getInstance(),a=0===r.N.playerIndex();i=(a?s.playername:s.opponentName)||void 0,o=(a?s.opponentName:s.playername)||void 0}this.hud.updateScores(e,t,i,o,n)}},{key:"sendScoreUpdate",value:function(e,t,n){var r=this.scores[0]!==e||this.scores[1]!==t||this.currentBreak!==n;this.updateScoreHud(e,t,n),r&&this.sendEvent(new Z.P(e,t,n))}},{key:"notify",value:function(e,t){this.notification.show(e,t),this.sendEvent(new q.c(e,t))}},{key:"notifyLocal",value:function(e,t){this.notification.show(e,t)}},{key:"advance",value:function(e){null==(t=this.frame)||t.call(this,e);for(var t,n=Math.floor(e/this.step),r=n*this.step,o=this.table.allStationary(),s=0;s<n;s++)this.table.advance(this.step);this.table.updateBallMesh(r),this.view.update(r,this.table.cue.aim),this.table.cue.update(r),!o&&this.table.allStationary()&&this.eventQueue.push(new i.T),this.sound.processOutcomes(this.table.outcome)}},{key:"processEvents",value:function(){var e=this;for(this.keyboard&&this.keyboard.getEvents().forEach(function(t){return e.inputQueue.push(t)});this.inputQueue.length>0;){this.lastEventTime=this.last;var t=this.inputQueue.shift();t&&this.updateController(this.controller.handleInput(t))}if(this.table.allStationary()){var n=this.eventQueue.shift();n&&(this.lastEventTime=performance.now(),this.recorder.record(n),this.updateController(n.applyToController(this.controller)))}}},{key:"animate",value:function(e){var t=this;this.advance((e-this.last)/1e3),this.last=e,this.processEvents(),(e<this.lastEventTime+12e3||!this.table.allStationary()||this.view.sizeChanged())&&this.view.render(),requestAnimationFrame(function(e){t.animate(e)})}},{key:"updateController",value:function(e){if(e!==this.controller){var t=r.N.hasInstance()?r.N.getInstance().playername:"_";this.log("".concat(t,": Transition to ").concat(e.name)),this.controller=e,this.controller.onFirst()}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/controller/aim.ts"(e,t,n){n.d(t,{m:()=>d});var r=n("./src/controller/controller.ts"),i=n("./src/controller/controllerbase.ts");function o(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){var t,r,i;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return r=n,i=[e],r=s(r),(t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(r,i||[],s(this).constructor):r.apply(this,i))).hit(),t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&a(n,e),t=[{key:"handleStationary",value:function(e){var t,n=this.container.table,r=n.outcome,i=this.container.rules.update(r),s=function(e){if(Array.isArray(e))return e}(t=this.container.rules.getScores())||function(e){var t,n,r=null==e?null:"u">typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var i=[],o=!0,s=!1;try{for(r=r.call(e);!(o=(t=r.next()).done)&&(i.push(t.value),2!==i.length);o=!0);}catch(e){s=!0,n=e}finally{try{o||null==r.return||r.return()}finally{if(s)throw n}}return i}}(t)||function(e){if(e){if("string"==typeof e)return o(e,2);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return o(e,2)}}(t)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(),a=s[0],l=s[1],c=this.container.rules.currentBreak;this.container.sendScoreUpdate(a,l,c);var u=this.container.rules.isPartOfBreak(r),h=this.container.rules.isEndOfGame(r);return this.container.recorder.updateBreak(r,u,h),n.cue.aimAtNext(n.cueball,this.container.rules.nextCandidateBall()),i}},{key:"handleInput",value:function(e){return this.commonKeyHandler(e),this}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(i.y),u=n("./src/controller/replay.ts");function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function p(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(p=function(){return!!e})()}var d=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");t=n,r=[e],t=h(t);var t,r,i,o=(i=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,p()?Reflect.construct(t,r||[],h(this).constructor):t.apply(this,r))).container.table;return o.cue.aimMode(),o.cue.showHelper(!0),o.cueball=i.container.rules.cueball,o.cue.aim.i=o.balls.indexOf(o.cueball),o.cue.moveTo(o.cueball.pos),o.cue.aimAtNext(o.cueball,i.container.rules.nextCandidateBall()),i.container.view.camera.suggestMode(i.container.view.camera.aimView),o.cue.aimInputs.showOverlap(),i}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&f(n,e),t=[{key:"onFirst",value:function(){this.container.table.cue.aimInputs.setDisabled(!1)}},{key:"handleInput",value:function(e){switch(e.key){case"Space":this.container.table.cue.adjustPower(e.t*this.scale*.7);break;case"SpaceUp":return this.playShot();default:if(!this.commonKeyHandler(e))return this}return this.container.sendEvent(this.container.table.cue.aim),this}},{key:"handleBreak",value:function(e){return new u.e(this.container,e.init,e.shots,e.retry)}},{key:"playShot",value:function(){var e=new r.Qe(this.container.table.serialise());return this.container.sendEvent(e),new c(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(i.y)},"./src/controller/controller.ts"(e,t,n){n.d(t,{Qe:()=>i.Q,pd:()=>o.p,wG:()=>r.w,xI:()=>s}),n("./src/events/beginevent.ts");var r=n("./src/events/aimevent.ts"),i=n("./src/events/hitevent.ts"),o=n("./src/events/input.ts");n("./src/events/abortevent.ts"),n("./src/events/stationaryevent.ts");var s=function(){var e;function t(e){var n,r;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");r=void 0,(n="container")in this?Object.defineProperty(this,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):this[n]=r,this.container=e}return e=[{key:"name",get:function(){return this.constructor.name}},{key:"handleInput",value:function(e){return this}},{key:"handleBegin",value:function(e){return this}},{key:"handleBreak",value:function(e){return this}},{key:"handleStartAim",value:function(e){return this}},{key:"handleAim",value:function(e){return this}},{key:"handleHit",value:function(e){return this}},{key:"handleAbort",value:function(e){return this}},{key:"handleWatch",value:function(e){return this}},{key:"handlePlaceBall",value:function(e){return this}},{key:"handleStationary",value:function(e){return this}},{key:"handleChat",value:function(e){return this}},{key:"handleRejoin",value:function(e){return this}},{key:"handleNotification",value:function(e){return this}},{key:"handleScore",value:function(e){return this}},{key:"onFirst",value:function(){}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/controller/controllerbase.ts"(e,t,n){n.d(t,{y:()=>h});var r=n("./src/controller/controller.ts"),i=n("./src/utils/gltf.ts"),o=n("./src/model/outcome.ts"),s=n("./node_modules/three/build/three.core.js");function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(e){return e&&"u">typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(u=function(){return!!e})()}var h=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t,r,i,o;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return t=n,r=arguments,t=a(t),(o="scale")in(i=e=function(e,t){if(t&&("object"===c(t)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,u()?Reflect.construct(t,r||[],a(this).constructor):t.apply(this,r)))?Object.defineProperty(i,o,{value:.001,enumerable:!0,configurable:!0,writable:!0}):i[o]=.001,e}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&l(n,e),t=[{key:"handleChat",value:function(e){var t=e.sender?"".concat(e.sender,":"):"",n="".concat(t," ").concat(e.message);return this.container.chat.showMessage(n),this}},{key:"handleNotification",value:function(e){return this.container.notification.show(e.data,e.duration),this}},{key:"handleScore",value:function(e){return this.container.updateScoreHud(e.p1,e.p2,e.b),this}},{key:"hit",value:function(){this.container.table.outcome=[o.P.hit(this.container.table.cueball,this.container.table.cue.aim.power)],this.container.table.hit(),this.container.view.camera.suggestMode(this.container.view.camera.aimView),this.container.table.cue.showHelper(!1)}},{key:"commonKeyHandler",value:function(e){var t=this.container.table.cue,n=e.t*this.scale;switch(e.key){case"ArrowLeft":return t.rotateAim(-n,this.container.table),!0;case"ArrowRight":return t.rotateAim(n,this.container.table),!0;case"ArrowDown":return t.adjustSpin(new s.Pq0(0,-n),this.container.table),!0;case"ArrowUp":return t.adjustSpin(new s.Pq0(0,n),this.container.table),!0;case"ShiftArrowLeft":return t.adjustSpin(new s.Pq0(n,0),this.container.table),!0;case"ShiftArrowRight":return t.adjustSpin(new s.Pq0(-n,0),this.container.table),!0;case"KeyPUp":return(0,i.KP)(this.container.view.scene),!0;case"KeyHUp":return t.toggleHelper(),!0;case"movementXUp":return t.rotateAim(2*n,this.container.table),!0;case"movementYUp":case"NumpadSubtract":return this.container.view.camera.adjustHeight(8*n),!0;case"NumpadAdd":return this.container.view.camera.adjustHeight(-(8*n)),!0;case"KeyOUp":return this.container.view.camera.toggleMode(),!0;case"KeyDUp":return this.togglePanel(),!0;case"KeyFUp":return this.toggleFullscreen(),!0;default:return!1}}},{key:"togglePanel",value:function(){this.container.sliders.toggleVisibility(),this.container.table.showSpin(!0),this.container.table.showTraces(!0),("u"<typeof process?"undefined":c(process))!=="object"&&console.log(this.container.table.serialise())}},{key:"toggleFullscreen",value:function(){document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen()}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.xI)},"./src/controller/end.ts"(e,t,n){n.d(t,{o:()=>c});var r=n("./src/controller/controller.ts"),i=n("./src/controller/init.ts"),o=n("./src/utils/replay-encoder.ts");function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e,t){var r,i,o,a,c;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return i=n,o=[e],i=s(i),r=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(i,o||[],s(this).constructor):i.apply(this,o)),c=void 0,(a="result")in r?Object.defineProperty(r,a,{value:c,enumerable:!0,configurable:!0,writable:!0}):r[a]=c,r.result=t,r}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&a(n,e),t=[{key:"onFirst",value:function(){if(this.result&&this.container.scoreReporter){try{var e=this.container.recorder.wholeGame(),t=JSON.stringify(e);this.result.replayData=o.k.crush(t)}catch(e){console.error("Failed to encode replay data",e)}this.container.scoreReporter.submitMatchResult(this.result)}}},{key:"handleChat",value:function(e){var t=e.sender?"".concat(e.sender,":"):"",n="".concat(t," ").concat(e.message);return this.container.chat.showMessage(n),this}},{key:"handleBegin",value:function(e){return new i.J(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.xI)},"./src/controller/init.ts"(e,t,n){n.d(t,{J:()=>k});var r=n("./src/events/watchevent.ts"),i=n("./src/controller/watchaim.ts"),o=n("./src/controller/controllerbase.ts"),s=n("./src/controller/placeball.ts"),a=n("./src/controller/replay.ts"),l=n("./src/network/client/session.ts"),c=n("./src/controller/controller.ts"),u=n("./src/events/eventutil.ts");function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function f(e){return(f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(e,t){return null!=t&&"u">typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function v(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(v=function(){return!!e})()}var y=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e,t,r){var i,o,s;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return o=n,s=[e],o=f(o),h(i=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,v()?Reflect.construct(o,s||[],f(this).constructor):o.apply(this,s)),"messageRelay",void 0),h(i,"tableId",void 0),h(i,"messages",[]),i.messageRelay=t,i.tableId=r,i.messageRelay.subscribe(i.tableId,function(e){console.log(e);var t=u.d.fromSerialised(e);i.messages.push(t),(p(t,c.Qe)||p(t,c.wG))&&i.container.eventQueue.push(t)}),console.log("Spectate"),i}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&d(n,e),t=[{key:"handleAim",value:function(e){return this.container.table.cue.aim=e,this.container.table.cueball.pos.copy(e.pos),this}},{key:"handleHit",value:function(e){return console.log("Spectate Hit"),this.container.table.updateFromSerialised(e.tablejson),this.container.table.outcome=[],this.container.table.hit(),this}},{key:"handleInput",value:function(e){return this.commonKeyHandler(e),this}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(o.y),m=n("./src/network/client/nchanmessagerelay.ts");function b(e){return(b=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function g(e,t){return(g=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function w(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(w=function(){return!!e})()}var k=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return e=n,t=arguments,e=b(e),function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,w()?Reflect.construct(e,t||[],b(this).constructor):e.apply(this,t))}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&g(n,e),t=[{key:"handleBegin",value:function(e){if(l.N.isSpectator()){var t;return new y(this.container,null!=(t=this.container.relay)?t:new m.p,l.N.getInstance().tableId)}return this.container.chat.showMessage("Start"),this.container.sendEvent(new r.Q(this.container.table.serialise())),new s.x(this.container)}},{key:"handleWatch",value:function(e){return this.container.chat.showMessage("Opponent to break"),this.container.rules.secondToPlay(),this.container.table.updateFromSerialised(e.json),l.N.hasInstance()&&(l.N.getInstance().playerIndex=1),new i.r(this.container)}},{key:"handleBreak",value:function(e){return e.init?(this.container.table.updateFromShortSerialised(e.init),this.container.chat.showMessage("Replay"),new a.e(this.container,e.init,e.shots)):new s.x(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(o.y)},"./src/controller/placeball.ts"(e,t,n){n.d(t,{x:()=>d});var r=n("./src/controller/controllerbase.ts"),i=n("./src/controller/controller.ts"),o=n("./src/controller/aim.ts"),s=n("./src/events/breakevent.ts"),a=n("./src/model/physics/constants.ts"),l=n("./node_modules/three/build/three.core.js"),c=n("./src/view/cuemesh.ts");function u(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function p(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(p=function(){return!!e})()}var d=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e,t){var r,i,o;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return i=n,o=[e],i=h(i),u(r=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,p()?Reflect.construct(i,o||[],h(this).constructor):i.apply(this,o)),"placescale",.02*a.R),u(r,"startPos",void 0),r.startPos=t,r.container.table.cue.moveTo(r.container.table.cueball.pos),r.container.table.cue.aim.power=0,r.container.view.camera.forceMode(r.container.view.camera.aimView),r}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&f(n,e),t=[{key:"onFirst",value:function(){var e=this.container.table.cueball;this.container.rules.allowsPlaceBall()&&(this.startPos?e.pos.copy(this.container.rules.placeBall(this.startPos.clone())):e.pos.copy(this.container.rules.placeBall())),e.setStationary(),e.updateMesh(0),this.container.table.cue.placeBallMode(),this.container.table.cue.showHelper(!1),this.container.table.cue.moveTo(this.container.table.cueball.pos),this.container.table.cue.aimInputs.setButtonText(`Place
-Ball`),this.container.table.cue.aimInputs.setDisabled(!1),this.container.rules.allowsPlaceBall()||this.container.inputQueue.push(new i.pd(1,"SpaceUp"))}},{key:"handleInput",value:function(e){var t=this.container.table.cueball.pos;switch(e.key){case"ArrowLeft":case"KeyI":this.moveTo(0,e.t*this.placescale);break;case"ArrowRight":case"KeyK":this.moveTo(0,-e.t*this.placescale);break;case"movementXUp":this.moveTo(0,-e.t*this.placescale*2);break;case"movementYUp":this.moveTo(-e.t*this.placescale*2,0);break;case"KeyJ":this.moveTo(-e.t*this.placescale,0);break;case"KeyL":this.moveTo(e.t*this.placescale,0);break;case"SpaceUp":return this.placed();default:this.commonKeyHandler(e)}return this.container.table.cue.moveTo(t),this.container.view.camera.forceMove(this.container.table.cue.aim),this.container.sendEvent(this.container.table.cue.aim),this}},{key:"moveTo",value:function(e,t){var n=new l.Pq0(e,t),r=this.container.table.cueball.pos.add(n);r.copy(this.container.rules.placeBall(r)),c.l.indicateValid(!this.container.table.overlapsAny(r))}},{key:"placed",value:function(){return this.container.table.overlapsAny(this.container.table.cueball.pos)?this:(this.container.table.cue.aimInputs.setButtonText("Hit"),this.container.sound.playNotify(),this.container.sendEvent(new s.W(this.container.table.shortSerialise())),new o.m(this.container))}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.y)},"./src/controller/replay.ts"(e,t,n){n.d(t,{e:()=>k});var r=n("./src/events/hitevent.ts"),i=n("./src/controller/controllerbase.ts"),o=n("./src/events/aimevent.ts"),s=n("./src/events/breakevent.ts"),a=n("./src/controller/aim.ts"),l=n("./src/events/eventtype.ts"),c=n("./src/events/rerackevent.ts"),u=n("./src/events/placeballevent.ts"),h=n("./src/controller/end.ts"),f=n("./src/events/scoreevent.ts"),p=n("./src/events/chatevent.ts"),d=n("./src/utils/gameover.ts");function v(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function m(e){return(m=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function b(e,t){return(b=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function g(e){return function(e){if(Array.isArray(e))return v(e)}(e)||function(e){if("u">typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e){if(e){if("string"==typeof e)return v(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return v(e,void 0)}}(e)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function w(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(w=function(){return!!e})()}var k=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e,t,r){var i,o,a,l=arguments.length>3&&void 0!==arguments[3]&&arguments[3],c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1500;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");if(i=n,o=[e],i=m(i),y(a=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,w()?Reflect.construct(i,o||[],m(this).constructor):i.apply(this,o)),"delay",void 0),y(a,"shots",void 0),y(a,"firstShot",void 0),y(a,"timer",void 0),y(a,"init",void 0),a.init=t,a.shots=g(r),a.firstShot=a.shots[0],a.delay=c,a.container.table.showTraces(!0),a.container.table.updateFromShortSerialised(a.init),console.log(a.shots),l){var u=new s.W(t,r);u.retry=!0,a.container.eventQueue.push(u)}else a.container.view.camera.forceMode(a.container.view.camera.topView),a.playNextShot(1.5*a.delay);return a}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&b(n,e),t=[{key:"onFirst",value:function(){var e=this;this.container.table.cue.aimInputs.setDisabled(!0);var t=this.container.menu.share;t&&(t.disabled=!1,t.onclick=function(){!function(e,t){var n;if(("u"<typeof process?"undefined":(n=process)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)=="object")return t(e);fetch("https://scoreboard-tailuge.vercel.app/api/shorten",{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({input:new URL(e.replaceAll("(","%28").replaceAll(")","%29").replaceAll("!","%21").replaceAll("*","%2A")).search})}).then(function(e){return e.json()}).then(function(n){"shortUrl"in n?t(n.shortUrl):(console.log("Could not shorten url:"),console.log(n),t(e))})}(window.location.href,function(t){var n,r,i,o,s=(o={title:"Billiards",text:"Replay break",url:t},(null==(n=(r=navigator).canShare)?void 0:n.call(r,o))?(navigator.share(o).then(function(){return console.log("shared successfully")}).catch(function(e){console.log("Error: "+e)}),"link shared"):(null==(i=navigator.clipboard)||i.writeText(t),'link copied to clipboard <a href="'.concat(t,'">').concat(t,"</a>")));e.container.eventQueue.push(new p.b(null,s))})})}},{key:"playNextShot",value:function(e){var t=this,n=this.shots.shift();if((null==n?void 0:n.type)===l.B.RERACK){var i=c.x.fromJson(n.ballinfo);c.x.applyBallinfoToTable(this.container.table,i.ballinfo),this.shots.length>0&&this.playNextShot(e);return}if((null==n?void 0:n.type)===l.B.PLACEBALL){var s=u.z.fromJson(n);if(this.container.table.cueball.pos.copy(s.pos),this.container.table.cueball.setStationary(),s.respot){var a=this.container.table.balls[s.respot.id];a&&(a.pos.copy(s.respot.pos),a.setStationary())}this.shots.length>0&&this.playNextShot(e);return}if((null==n?void 0:n.type)===l.B.SCORE){f.P.fromJson(n).applyToController(this),this.shots.length>0&&this.playNextShot(e);return}var h=o.w.fromJson(n);this.container.table.cueball=this.container.table.balls[h.i],console.log(this.container.table.cueball.pos.distanceTo(h.pos)),this.container.table.cueball.pos.copy(h.pos),this.container.table.cue.aim=h,this.container.table.cue.updateAimInput(),this.container.table.cue.t=1,clearTimeout(this.timer),this.timer=setTimeout(function(){t.container.eventQueue.push(new r.Q(t.container.table.cue.aim)),t.timer=void 0},e)}},{key:"handleHit",value:function(e){return this.hit(),this}},{key:"handleStationary",value:function(e){return(this.shots.length>0&&void 0===this.timer&&this.playNextShot(this.delay),0===this.shots.length&&void 0===this.timer)?(this.container.notifyLocal({type:"GameOver",title:"Replay Complete",extra:d.c.replay+d.c.lobby},0),new h.o(this.container)):this}},{key:"handleInput",value:function(e){return this.commonKeyHandler(e),this}},{key:"handleBreak",value:function(e){return(this.container.table.updateFromShortSerialised(e.init),this.shots=g(e.shots),this.container.table.showSpin(!0),e.retry)?this.retry():(this.playNextShot(this.delay),this)}},{key:"handleAbort",value:function(e){return console.log("Replay aborted"),clearTimeout(this.timer),this.timer=void 0,new h.o(this.container)}},{key:"retry",value:function(){clearTimeout(this.timer),this.timer=void 0,this.container.table.updateFromShortSerialised(this.init);var e=o.w.fromJson(this.firstShot);return this.container.table.cueball=this.container.table.balls[e.i],this.container.rules.cueball=this.container.table.cueball,this.container.table.cueball.pos.copy(e.pos),this.container.table.cue.aim=e,this.container.view.camera.forceMode(this.container.view.camera.aimView),new a.m(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(i.y)},"./src/controller/rules/rulefactory.ts"(e,t,n){n.d(t,{V:()=>B});var r=n("./src/events/rerackevent.ts"),i=n("./src/model/outcome.ts"),o=n("./src/utils/rack.ts"),s=n("./node_modules/three/build/three.core.js"),a=n("./src/controller/aim.ts"),l=n("./src/controller/placeball.ts"),c=n("./src/controller/watchaim.ts"),u=n("./src/events/placeballevent.ts"),h=n("./src/events/watchevent.ts"),f=n("./src/model/table.ts"),p=n("./src/model/physics/constants.ts"),d=n("./src/utils/respot.ts"),v=n("./src/view/tablegeometry.ts"),y=n("./src/events/startaimevent.ts"),m=n("./src/network/client/matchresult.ts"),b=n("./src/network/client/session.ts");function g(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function w(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function k(e){return function(e){if(Array.isArray(e))return g(e)}(e)||function(e){if("u">typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e){if(e){if("string"==typeof e)return g(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return g(e,void 0)}}(e)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var x=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");w(this,"container",void 0),w(this,"cueball",void 0),w(this,"currentBreak",0),w(this,"previousBreak",0),w(this,"rulename","nineball"),this.container=e}return e=[{key:"getScores",value:function(){return this.container.scores}},{key:"startTurn",value:function(){this.previousBreak=this.currentBreak,this.currentBreak=0}},{key:"nextCandidateBall",value:function(){var e=this;return this.container.table.balls.filter(function(t){return t!==e.cueball&&t.onTable()}).sort(function(e,t){return(e.label||0)-(t.label||0)})[0]}},{key:"placeBall",value:function(e){if(e){var t=new s.Pq0(v.P.tableX,v.P.tableY),n=new s.Pq0(-v.P.tableX,-v.P.tableY);return e.clamp(n,t)}return new s.Pq0(-(11*p.R)/.5,0,0)}},{key:"asset",value:function(){return"models/p8.min.gltf"}},{key:"tableGeometry",value:function(){v.P.hasPockets=!0}},{key:"table",value:function(){var e=new f.X(this.rack());return this.cueball=e.cueball,e}},{key:"rack",value:function(){return o.m.diamond()}},{key:"update",value:function(e){var t=this.foulReason(e);return t?this.handleFoul(e,t):i.P.potCount(e)>0?this.handlePot(e):this.handleMiss()}},{key:"handleFoul",value:function(e,t){this.container.notify({type:"Foul",title:"FOUL",subtext:t,extra:"Ball in hand"}),this.startTurn();var n=i.P.pots(e).includes(this.container.table.balls[9]),o=this.container.table.cueball;if(n){this.respotNineBall();var s=this.container.table.balls[9];if(s){var a=r.x.fromJson({balls:[s.serialise()]});console.log("Respot nine ball sending rerack event",a),this.container.sendEvent(a)}}var h=o.onTable()?o.pos.clone():this.placeBall(),f=new u.z(h,void 0,!0);return(this.container.sendEvent(f),this.container.isSinglePlayer)?new l.x(this.container,h):new c.r(this.container)}},{key:"handlePot",value:function(e){var t=this.container.table,n=i.P.potCount(e);return(this.currentBreak+=n,this.container.scores[b.N.playerIndex()]+=n,this.container.sound.playSuccess(t.inPockets()),this.isEndOfGame(e))?this.handleGameEnd(!0):(this.container.sendEvent(new h.Q(t.serialise())),new a.m(this.container))}},{key:"handleGameEnd",value:function(e){return m.n.presentGameEnd(this.container,this.rulename)}},{key:"handleMiss",value:function(){var e=this.container.table;return(this.container.sendEvent(new y.M),this.container.isSinglePlayer)?(this.container.sendEvent(new h.Q(e.serialise())),this.startTurn(),new a.m(this.container)):new c.r(this.container)}},{key:"isPartOfBreak",value:function(e){return i.P.isBallPottedNoFoul(this.container.table.cueball,e)}},{key:"isEndOfGame",value:function(e){return!this.isFoul(e)&&i.P.pots(e).includes(this.container.table.balls[9])}},{key:"otherPlayersCueBall",value:function(){return this.cueball}},{key:"secondToPlay",value:function(){}},{key:"allowsPlaceBall",value:function(){return!0}},{key:"isFoul",value:function(e){return null!==this.foulReason(e)}},{key:"foulReason",value:function(e){var t=this.container.table.cueball;if(i.P.isCueBallPotted(t,e))return"Cue ball potted";var n=this.getLowestBallAtStartOfShot(e),r=i.P.firstCollision(i.P.cueBallFirst(t,e));if(!r)return"No ball hit";if(r.ballB!==n)return"Wrong ball hit first";if(0===i.P.potCount(e)){var o=e.indexOf(r);if(!e.slice(o+1).some(function(e){return e.type===i.$.Cushion}))return"No cushion after contact"}return null}},{key:"getLowestBallAtStartOfShot",value:function(e){var t=this,n=i.P.pots(e),r=this.container.table.balls.filter(function(e){return e!==t.cueball&&e.onTable()});return k(n).concat(k(r)).sort(function(e,t){return(e.label||0)-(t.label||0)})[0]}},{key:"respotNineBall",value:function(){d.k.nineBall(this.container.table)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function T(e,t,n){return(T="u">typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=P(e)););return e}(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(n||e):i.value}})(e,t,n||e)}function P(e){return(P=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function S(e,t){return(S=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function O(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(O=function(){return!!e})()}var R=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){var t,r,i;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return r=n,i=[e],r=P(r),(t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,O()?Reflect.construct(r,i||[],P(this).constructor):r.apply(this,i))).rulename="fourteenone",t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&S(n,e),t=[{key:"asset",value:function(){return"models/p8.min.gltf"}},{key:"rack",value:function(){return o.m.triangle()}},{key:"update",value:function(e){var t=this.container.table;return this.checkRerack(t),T(P(n.prototype),"update",this).call(this,e)}},{key:"isFoul",value:function(e){return i.P.isCueBallPotted(this.container.table.cueball,e)}},{key:"checkRerack",value:function(e){var t=e.balls.filter(function(e){return e.onTable()}).filter(function(t){return t!==e.cueball});if(1===t.length){o.m.rerack(t[0],e),this.container.sound.playSuccess(e.inPockets());var n=e.serialise(),i=r.x.fromJson(n);this.container.sendEvent(i),this.container.recorder.wholeGameLink()}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(x),E=n("./src/controller/rules/snooker.ts"),A=n("./src/view/cameratop.ts"),_=n("./src/utils/utils.ts"),M=n("./src/utils/threecushionconfig.ts");function I(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function C(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var j=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");C(this,"container",void 0),C(this,"cueball",void 0),C(this,"currentBreak",0),C(this,"previousBreak",0),C(this,"rulename","threecushion"),this.container=e}return e=[{key:"getScores",value:function(){return this.container.scores}},{key:"startTurn",value:function(){}},{key:"nextCandidateBall",value:function(){if(!(0,_.hs)(this.container.recorder))return d.k.closest(this.container.table.cueball,this.container.table.balls)}},{key:"placeBall",value:function(e){return _.v_}},{key:"asset",value:function(){return"models/threecushion.min.gltf"}},{key:"secondToPlay",value:function(){this.cueball=this.container.table.balls[1]}},{key:"tableGeometry",value:function(){v.P.tableX=49*p.R,v.P.tableY=24*p.R,v.P.X=v.P.tableX+p.R,v.P.Y=v.P.tableY+p.R,v.P.hasPockets=!1}},{key:"table",value:function(){this.tableGeometry(),A.v.zoomFactor=.92;var e=new f.X(this.rack());return this.cueball=e.cueball,e}},{key:"rack",value:function(){return o.m.three()}},{key:"update",value:function(e){return i.P.isThreeCushionPoint(this.cueball,e)?(this.container.sound.playSuccess(e.length/3),this.container.sendEvent(new h.Q(this.container.table.serialise())),this.currentBreak++,this.container.scores[b.N.playerIndex()]++,this.isEndOfGame(e))?this.handleGameEnd(!0):new a.m(this.container):(this.previousBreak=this.currentBreak,this.currentBreak=0,this.container.isSinglePlayer)?(this.cueball=this.otherPlayersCueBall(),this.container.table.cue.aim.i=this.container.table.balls.indexOf(this.cueball),new a.m(this.container)):(this.container.sendEvent(new y.M),new c.r(this.container))}},{key:"otherPlayersCueBall",value:function(){var e=this.container.table.balls;return this.cueball===e[0]?e[1]:e[0]}},{key:"isPartOfBreak",value:function(e){return i.P.isThreeCushionPoint(this.cueball,e)}},{key:"isEndOfGame",value:function(e){var t,n=function(e){if(Array.isArray(e))return e}(t=this.container.scores)||function(e){var t,n,r=null==e?null:"u">typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var i=[],o=!0,s=!1;try{for(r=r.call(e);!(o=(t=r.next()).done)&&(i.push(t.value),2!==i.length);o=!0);}catch(e){s=!0,n=e}finally{try{o||null==r.return||r.return()}finally{if(s)throw n}}return i}}(t)||function(e){if(e){if("string"==typeof e)return I(e,2);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return I(e,2)}}(t)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(),r=n[0],i=n[1];return r>=M.Y.raceTo||i>=M.Y.raceTo}},{key:"handleGameEnd",value:function(e){return m.n.presentGameEnd(this.container,this.rulename)}},{key:"allowsPlaceBall",value:function(){return!1}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),B=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"create",value:function(e,t){switch(e){case"threecushion":return new j(t);case"fourteenone":return new R(t);case"snooker":return new E.c(t);default:return new x(t)}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/controller/rules/snooker.ts"(e,t,n){n.d(t,{c:()=>T});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/events/watchevent.ts"),o=n("./src/model/outcome.ts"),s=n("./src/utils/rack.ts"),a=n("./src/utils/respot.ts"),l=n("./src/controller/aim.ts"),c=n("./src/controller/watchaim.ts"),u=n("./src/model/table.ts"),h=n("./src/view/tablegeometry.ts"),f=n("./src/controller/placeball.ts"),p=n("./src/events/placeballevent.ts"),d=n("./src/utils/utils.ts");function v(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}var y=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"shotInfo",value:function(e,n,r,i){var s=o.P.firstCollision(n);return{pots:o.P.potCount(n),firstCollision:s,legalFirstCollision:t.isLegalFirstCollision(e,r,i,s),whitePotted:o.P.isCueBallPotted(e.cueball,n),targetIsRed:r}}},{key:"isLegalFirstCollision",value:function(e,n,r,i){if(!i)return!1;var o=i.ballB.id;if(n)return o>=7;if(r)return o>=1&&o<=6;var s=t.coloursOnTable(e).sort(function(e,t){return e.id-t.id});return 0!==s.length&&o===s[0].id}},{key:"calculateFoul",value:function(e,n){return{points:t.foulPoints(e,n),reason:t.foulReason(e,n)}}},{key:"foulPoints",value:function(e,t){var n,r,i,s,a=o.P.pots(e).map(function(e){return e.id}).filter(function(e){return e<7}),l=null!=(r=null==(s=t.firstCollision)||null==(i=s.ballB)?void 0:i.id)?r:0;return l>6&&(l=0),(n=Math).max.apply(n,[3,l].concat(function(e){if(Array.isArray(e))return v(e)}(a)||function(e){if("u">typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(a)||function(e){if(e){if("string"==typeof e)return v(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return v(e,void 0)}}(a)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()))+1}},{key:"foulReason",value:function(e,n){if(n.whitePotted)return"White potted";if(!n.firstCollision)return"No ball hit";var r=null!=(l=null==(c=n.firstCollision.ballB)?void 0:c.id)?l:0;if(n.targetIsRed){if(r<7||0===r){var i=t.colourName(r);return"Hit ".concat(i," instead of red")}}else if(r>=7)return"Hit red instead of colour";var s=o.P.pots(e).filter(function(e){return e.id>0&&e.id<7});if(s.length>1){var a=s.map(function(e){return t.colourName(e.id)}).join(", ");return"Potted ".concat(a)}if(1===s.length){var l,c,u,h,f,p=s[0].id,d=null!=(u=null==(f=n.firstCollision)||null==(h=f.ballB)?void 0:h.id)?u:0;if(p!==d){var v=t.colourName(p),y=t.colourName(d);return"Potted ".concat(v," instead of ").concat(y)}}return null}},{key:"respotAllPottedColours",value:function(e,t){return o.P.pots(t).filter(function(e){return e.id<7}).filter(function(e){return 0!==e.id}).map(function(t){return a.k.respot(t,e)})}},{key:"redsOnTable",value:function(e){return e.balls.slice(7).filter(function(e){return e.onTable()})}},{key:"coloursOnTable",value:function(e){return e.balls.slice(1,7).filter(function(e){return e.onTable()})}},{key:"colourName",value:function(e){return({1:"Yellow",2:"Green",3:"Brown",4:"Blue",5:"Pink",6:"Black"})[e]||"Ball ".concat(e)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}(),m=n("./src/network/client/matchresult.ts"),b=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"presentGameEnd",value:function(e,t){return m.n.presentGameEnd(e,t)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}(),g=n("./src/events/startaimevent.ts"),w=n("./src/network/client/session.ts"),k=n("./src/events/rerackevent.ts");function x(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var T=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");x(this,"cueball",void 0),x(this,"previousPotRed",!1),x(this,"targetIsRed",!0),x(this,"currentBreak",0),x(this,"previousBreak",0),x(this,"foulPoints",0),x(this,"rulename","snooker"),x(this,"container",void 0),this.container=e}return e=[{key:"snookerrule",value:function(e){this.foulPoints=0;var t=y.shotInfo(this.container.table,e,this.targetIsRed,this.previousPotRed);return 0===t.pots?(this.targetIsRed=y.redsOnTable(this.container.table).length>0,t.legalFirstCollision)?this.switchPlayer():this.foul(e,t):this.targetIsRed?this.targetRedRule(e,t):this.targetColourRule(e,t)}},{key:"targetRedRule",value:function(e,t){return t.legalFirstCollision&&o.P.onlyRedsPotted(e)?(this.currentBreak+=t.pots,this.container.scores[w.N.playerIndex()]+=t.pots,this.targetIsRed=!1,this.previousPotRed=!0,this.continueBreak()):this.foul(e,t)}},{key:"targetColourRule",value:function(e,t){if(t.whitePotted)return this.foul(e,t);if(t.pots>1)return this.respot(e),this.foul(e,t);if(o.P.pots(e)[0].id>6)return this.foul(e,t);var n=o.P.pots(e)[0].id;return n!==t.firstCollision.ballB.id?this.foul(e,t):this.previousPotRed?(this.respot(e),this.currentBreak+=n+1,this.container.scores[w.N.playerIndex()]+=n+1,this.previousPotRed=!1,this.targetIsRed=y.redsOnTable(this.container.table).length>0,this.continueBreak()):y.coloursOnTable(this.container.table).filter(function(e){return e.id<n}).length>0?this.foul(e,t):(this.currentBreak+=n+1,this.container.scores[w.N.playerIndex()]+=n+1,this.previousPotRed=!1,this.targetIsRed=y.redsOnTable(this.container.table).length>0,this.continueBreak())}},{key:"foul",value:function(e,t){var n=y.calculateFoul(e,t);this.foulPoints=n.points;var r=w.N.playerIndex();this.container.scores[1-r]+=this.foulPoints;var i=t.whitePotted?{type:"Foul",title:"FOUL",subtext:n.reason||"Foul (".concat(this.foulPoints," points)"),extra:"Ball in hand"}:{type:"Foul",title:"FOUL",subtext:n.reason||"Foul (".concat(this.foulPoints," points)")};return(this.container.notify(i),this.respot(e),t.whitePotted)?this.whiteInHand():this.switchPlayer()}},{key:"tableGeometry",value:function(){h.P.hasPockets=!0}},{key:"table",value:function(){var e=new u.X(this.rack());return this.cueball=e.cueball,e}},{key:"otherPlayersCueBall",value:function(){return this.cueball}},{key:"secondToPlay",value:function(){}},{key:"isPartOfBreak",value:function(e){return this.currentBreak>0}},{key:"isEndOfGame",value:function(e){return o.P.isClearTable(this.container.table)&&this.currentBreak>0}},{key:"allowsPlaceBall",value:function(){return!0}},{key:"asset",value:function(){return t.tablemodel}},{key:"startTurn",value:function(){this.previousPotRed=!1,this.targetIsRed=y.redsOnTable(this.container.table).length>0,this.previousBreak=this.currentBreak,this.currentBreak=0}},{key:"getScores",value:function(){return this.container.scores}},{key:"rack",value:function(){return s.m.snooker()}},{key:"nextCandidateBall",value:function(){if((0,d.hs)(this.container.recorder))return void console.log("first shot");var e=this.container.table,t=y.redsOnTable(e),n=y.coloursOnTable(e);return this.previousPotRed?a.k.closest(e.cueball,n):t.length>0?a.k.closest(e.cueball,t):n.length>0?n[0]:void 0}},{key:"placeBall",value:function(e){if(e){var t=new r.Pq0(s.m.baulk,0,0),n=s.m.sixth,i=e.distanceTo(t);if(e.x>=s.m.baulk&&(e.x=s.m.baulk),!(i>n))return e;var o=e.clone().sub(t).normalize();return t.add(o.multiplyScalar(n))}return new r.Pq0(s.m.baulk,-s.m.sixth/2.6,0)}},{key:"switchPlayer",value:function(){var e=this.container.table;return(this.container.sendEvent(new g.M(this.foulPoints)),this.container.isSinglePlayer)?(this.container.sendEvent(new i.Q(e.serialise())),this.startTurn(),new l.m(this.container)):(this.startTurn(),new c.r(this.container))}},{key:"continueBreak",value:function(){var e=this.container.table;return(this.container.sound.playSuccess(e.inPockets()),o.P.isClearTable(e))?this.handleGameEnd(!0):(this.container.sendEvent(new i.Q(e.serialise())),new l.m(this.container))}},{key:"handleGameEnd",value:function(e){return b.presentGameEnd(this.container,this.rulename)}},{key:"whiteInHand",value:function(){return(this.startTurn(),this.container.isSinglePlayer)?new f.x(this.container):(this.container.sendEvent(new p.z(d.v_)),new c.r(this.container))}},{key:"update",value:function(e){return this.snookerrule(e)}},{key:"respot",value:function(e){var t=y.respotAllPottedColours(this.container.table,e);if(t.length>0){var n=k.x.fromJson({balls:t.map(function(e){return e.serialise()})});this.container.sendEvent(n)}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();x(T,"tablemodel","models/d-snooker.min.gltf")},"./src/controller/watchaim.ts"(e,t,n){n.d(t,{r:()=>d});var r=n("./src/controller/aim.ts"),i=n("./src/controller/controllerbase.ts"),o=n("./src/controller/placeball.ts"),s=n("./src/events/rerackevent.ts");function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(c=function(){return!!e})()}var u=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){var t,r,i;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return r=n,i=[e],r=a(r),(t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,c()?Reflect.construct(r,i||[],a(this).constructor):r.apply(this,i))).container.table.outcome=[],t.container.table.hit(),t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&l(n,e),t=[{key:"onFirst",value:function(){this.container.table.cue.aimInputs.setDisabled(!0)}},{key:"handleStationary",value:function(e){var t=this.container.table.outcome;return this.container.rules.isEndOfGame(t)?this.container.rules.handleGameEnd(!1):this}},{key:"handleStartAim",value:function(e){return this.container.rules.startTurn(),new r.m(this.container)}},{key:"handlePlaceBall",value:function(e){if(e.respot){var t=this.container.table.balls.find(function(t){return t.id===e.respot.id});t&&(t.pos.copy(e.respot.pos),t.setStationary())}return e.useStartPos?(this.container.rules.startTurn(),new o.x(this.container,e.pos.clone())):(this.container.rules.startTurn(),new o.x(this.container))}},{key:"handleWatch",value:function(e){return"rerack"in e.json?(console.log("Respot"),s.x.applyBallinfoToTable(this.container.table,e.json),this):new d(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(i.y);function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function p(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(p=function(){return!!e})()}var d=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){var t,r,i;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return r=n,i=[e],r=h(r),(t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,p()?Reflect.construct(r,i||[],h(this).constructor):r.apply(this,i))).container.table.cueball=t.container.rules.otherPlayersCueBall(),t.container.table.cue.moveTo(t.container.table.cueball.pos),t.container.view.camera.suggestMode(t.container.view.camera.topView),t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&f(n,e),t=[{key:"onFirst",value:function(){this.container.table.cue.aimInputs.setDisabled(!0)}},{key:"handleAim",value:function(e){return this.container.table.cue.aim=e,this.container.table.cueball.pos.copy(e.pos),this}},{key:"handleHit",value:function(e){return this.container.table.updateFromSerialised(e.tablejson),new u(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(i.y)},"./src/diagram/diagramcontainer.ts"(e,t,n){n.d(t,{n:()=>T});var r=n("./src/container/container.ts"),i=n("./src/events/keyboard.ts"),o=n("./src/events/breakevent.ts"),s=n("./src/view/cameratop.ts"),a=n("./src/model/physics/physics.ts"),l=n("./src/view/assets.ts"),c=n("./node_modules/three/build/three.core.js");function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}var h=function(){var e;function t(e){var n,r,i=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");r=void 0,(n="shots")in this?Object.defineProperty(this,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):this[n]=r,this.shots=e.map(function(e){return i.interpolateAllBalls(e)})}return e=[{key:"interpolateUntilMove",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.3,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e-5;return e.t.length>1&&e.t[1]-e.t[0]>t&&(e.t.splice(1,0,e.t[1]-n),e.x.splice(1,0,e.x[0]),e.y.splice(1,0,e.y[0])),e}},{key:"interpolateAllBalls",value:function(e){var t=this;return e.balls=Object.fromEntries(Object.entries(e.balls).map(function(e){var n=function(e){if(Array.isArray(e))return e}(e)||function(e){var t,n,r=null==e?null:"u">typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var i=[],o=!0,s=!1;try{for(r=r.call(e);!(o=(t=r.next()).done)&&(i.push(t.value),2!==i.length);o=!0);}catch(e){s=!0,n=e}finally{try{o||null==r.return||r.return()}finally{if(s)throw n}}return i}}(e)||function(e){if(e){if("string"==typeof e)return u(e,2);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return u(e,2)}}(e)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(),r=n[0],i=n[1];return[r,t.interpolateUntilMove(i)]})),e}},{key:"getInterpolatedPosition",value:function(e,t,n){if(!e||0===e.length||n<=e[0])return t[0];if(n>=e[e.length-1])return t[t.length-1];for(var r=0,i=e.length-1;r<i-1;){var o=Math.floor((r+i)/2);e[o]<n?r=o:i=o}var s=e[r],a=e[i],l=t[r];return l+(n-s)/(a-s)*(t[i]-l)}},{key:"getPositionsAtTime",value:function(e,t){var n=this.shots.find(function(t){return t.shotID===e}),r={};for(var i in n.balls){var o=n.balls[i],s=this.getInterpolatedPosition(o.t,o.x,t),a=this.getInterpolatedPosition(o.t,o.y,t);r[i]={x:s,y:a}}return r}},{key:"realToSim",value:function(e,t){return{x:2.3*(.71-t[e].x/2),y:2.3*(-.36+t[e].y/2)}}},{key:"identifyFirstMover",value:function(e){return console.log(e),e.balls["1"].t[1]<e.balls["2"].t[1]?"1":"2"}},{key:"estimateDirection",value:function(e){var t=this.getPositionsAtTime(e.shotID,0),n=this.getPositionsAtTime(e.shotID,.2),r=this.identifyFirstMover(e),i=t[r],o=new c.Pq0(i.x,i.y),s=n[r],a=new c.Pq0(s.x,s.y);return{pos1:t,pos2:n,firstMover:r,speed:2*o.distanceTo(a),angle:new c.Pq0(-1,0).angleTo(a.sub(o))}}},{key:"stateFrom",value:function(e){var t=this.getPositionsAtTime(e.shotID,0),n={init:[],shots:[]};for(var r in t){var i=this.realToSim(r,t);n.init.push(i.x),n.init.push(i.y)}var o=this.estimateDirection(e);console.log("estimated",o);var s=+("1"!=o.firstMover);return console.log(o),n.shots.push({type:"AIM",offset:{x:-0,y:0,z:0},angle:o.angle,power:o.speed,pos:{x:n.init[2*s],y:n.init[2*s+1],z:0},i:s}),n}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var p=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");f(this,"ctx",void 0),f(this,"canvas",void 0),f(this,"BALL_COLORS",{1:"white",2:"yellow",3:"red"}),f(this,"BALL_DIAMETER",.0615),f(this,"TABLE_WIDTH",2.84),f(this,"PIXELS_PER_METER",void 0),f(this,"ballPaths",{}),this.canvas=e,this.ctx=this.canvas.getContext("2d"),this.PIXELS_PER_METER=this.canvas.width/this.TABLE_WIDTH}return e=[{key:"drawBall",value:function(e,t,n){var r=this.BALL_DIAMETER/2*this.PIXELS_PER_METER,i=this.canvas.width-e;this.ctx.beginPath(),this.ctx.arc(i,t,r,0,2*Math.PI),this.ctx.fillStyle=n,this.ctx.fill(),this.ctx.strokeStyle="black",this.ctx.lineWidth=1,this.ctx.stroke()}},{key:"drawBallPath",value:function(e,t){var n=this,r=this.BALL_COLORS[e];this.ctx.save(),this.ctx.beginPath(),t.forEach(function(e,t){var r=n.canvas.width-e.x*n.PIXELS_PER_METER,i=n.canvas.height-e.y*n.PIXELS_PER_METER;0===t?n.ctx.moveTo(r,i):n.ctx.lineTo(r,i)}),this.ctx.setLineDash([4,4]),this.ctx.strokeStyle=r,this.ctx.lineWidth=1,this.ctx.stroke(),this.ctx.restore()}},{key:"clear",value:function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}},{key:"drawShot",value:function(e){for(var t in this.ballPaths)this.drawBallPath(t,this.ballPaths[t]);for(var n in e){var r=e[n],i=this.BALL_COLORS[n],o=r.x*this.PIXELS_PER_METER,s=this.canvas.height-r.y*this.PIXELS_PER_METER;this.drawBall(o,s,i)}}},{key:"resetCanvas",value:function(){this.clear(),this.ballPaths={}}},{key:"updateBallPaths",value:function(e,t){this.ballPaths[e]||(this.ballPaths[e]=[]),this.ballPaths[e].push(t)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),d=n("./src/events/abortevent.ts"),v=n("./src/events/beginevent.ts");function y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var m=function(){var e;function t(){var e;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");y(this,"aimBall",void 0),y(this,"aimCoordinatesDisplay",void 0),y(this,"aimBallContainer",void 0),y(this,"powerSlider",void 0),y(this,"directionSlider",void 0),y(this,"BALL_CONTAINER_RADIUS",void 0),y(this,"MAX_DISTANCE",.7),y(this,"position",{x:0,y:0}),y(this,"power",5),y(this,"direction",0),this.aimBall=document.getElementById("aim-ball"),this.aimCoordinatesDisplay=document.getElementById("aim-coordinates"),this.aimBallContainer=document.getElementById("aim-ball-container"),this.powerSlider=document.getElementById("power"),this.directionSlider=document.getElementById("direction"),this.BALL_CONTAINER_RADIUS=((null==(e=this.aimBallContainer)?void 0:e.clientWidth)||0)/2,this.addEventListeners()}return e=[{key:"addEventListeners",value:function(){var e,t,n,r=this;null==(e=this.aimBallContainer)||e.addEventListener("click",function(e){return r.handleClick(e)}),null==(t=this.powerSlider)||t.addEventListener("input",function(e){r.power=parseInt(e.target.value)}),null==(n=this.directionSlider)||n.addEventListener("input",function(e){r.direction=parseInt(e.target.value)})}},{key:"handleClick",value:function(e){if(this.aimBallContainer&&this.aimBall){var t=this.aimBallContainer.getBoundingClientRect(),n=e.clientX-t.left-t.width/2,r=e.clientY-t.top-t.height/2;if(Math.sqrt(n*n+r*r)>this.MAX_DISTANCE*this.BALL_CONTAINER_RADIUS){var i=Math.atan2(r,n);n=this.MAX_DISTANCE*this.BALL_CONTAINER_RADIUS*Math.cos(i),r=this.MAX_DISTANCE*this.BALL_CONTAINER_RADIUS*Math.sin(i)}var o=t.width/2-this.aimBall.offsetWidth/2,s=t.height/2-this.aimBall.offsetHeight/2,a=Math.max(-o,Math.min(o,n)),l=Math.max(-s,Math.min(s,r));this.position.x=a/this.BALL_CONTAINER_RADIUS,this.position.y=l/this.BALL_CONTAINER_RADIUS,this.updateDom()}}},{key:"updateDom",value:function(){if(this.aimBall&&this.aimBallContainer){var e=this.aimBallContainer.getBoundingClientRect(),t=this.position.x*this.BALL_CONTAINER_RADIUS,n=this.position.y*this.BALL_CONTAINER_RADIUS;this.aimBall.style.left="".concat(t+e.width/2-this.aimBall.offsetWidth/2,"px"),this.aimBall.style.top="".concat(n+e.height/2-this.aimBall.offsetHeight/2,"px"),this.aimCoordinatesDisplay&&(this.aimCoordinatesDisplay.textContent="x: ".concat(this.position.x.toFixed(2),", y: ").concat(this.position.y.toFixed(2)))}}},{key:"getAim",value:function(){return{offset:{x:this.position.x,y:this.position.y,z:0},angle:this.direction,power:this.power}}},{key:"setAim",value:function(e){this.position.x=e.offset.x,this.position.y=e.offset.y,this.power=e.power,this.powerSlider.value=e.power.toString(),this.direction=e.angle,this.directionSlider.value=e.angle.toString(),console.log("set aim",e),this.updateDom()}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function b(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var g=function(){var e;function t(e,n){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");b(this,"drawer",void 0),b(this,"aimInputs",void 0),b(this,"fileInput",document.getElementById("fileInput")),b(this,"shotIndexDisplay",document.getElementById("shotIndexDisplay")),b(this,"shotSelector",document.getElementById("shotSelector")),b(this,"replayButton",document.getElementById("replay")),b(this,"myIframe",document.getElementById("myIframe")),b(this,"allShots",[]),b(this,"currentShotIndex",0),b(this,"animationTimer",-2.35),b(this,"isPlaying",!1),b(this,"lastFrameTime",0),b(this,"animationStartTime",0),b(this,"realPosition",null),b(this,"elapsedTime",0),b(this,"container",void 0),this.drawer=new p(e),this.container=n,this.aimInputs=new m,n&&(n.frame=this.advance.bind(this)),this.start()}return e=[{key:"start",value:function(){console.log("real overlay start"),this.loadDefaultData(),this.addEventListeners()}},{key:"addEventListeners",value:function(){var e=this;this.fileInput.addEventListener("change",function(t){return e.handleFileChange(t)}),this.shotSelector.addEventListener("change",function(){return e.handleShotSelect()}),this.replayButton.addEventListener("click",function(){return e.handleReplay()})}},{key:"handleFileChange",value:function(e){var t=this,n=e.target.files[0];if(n){var r=new FileReader;r.onload=function(e){try{var n=JSON.parse(e.target.result);t.processShots(n)}catch(e){console.error("Error parsing JSON:",e),alert("Error parsing JSON file.")}},r.readAsText(n)}}},{key:"handleShotSelect",value:function(){this.currentShotIndex=parseInt(this.shotSelector.value,10),this.updateDisplay(),this.resetAnimation()}},{key:"loadDefaultData",value:function(){var e=this;fetch("simple_shots.json").then(function(e){if(!e.ok)throw Error("HTTP error! status: ".concat(e.status));return e.json()}).then(function(t){return e.processShots(t)})}},{key:"processShots",value:function(e){this.allShots=e,this.realPosition=new h(this.allShots),this.allShots.length>0&&(this.currentShotIndex=0,this.populateShotSelector(),this.updateDisplay(),this.resetAnimation())}},{key:"populateShotSelector",value:function(){var e=this;this.shotSelector.innerHTML="",this.allShots.forEach(function(t,n){var r=document.createElement("option");r.value=n.toString(),r.text="Shot ".concat(n+1," (ID: ").concat(t.shotID,")"),e.shotSelector.appendChild(r)}),this.allShots.length>0&&(this.shotSelector.value=this.currentShotIndex.toString())}},{key:"updateDisplay",value:function(){this.shotIndexDisplay.textContent="Shot: ".concat(this.currentShotIndex+1),this.allShots[this.currentShotIndex]&&(this.shotSelector.value=this.currentShotIndex.toString())}},{key:"drawShot",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(this.realPosition){var n=this.realPosition.getPositionsAtTime(e.shotID,t);if(n){for(var r in n)this.drawer.updateBallPaths(r,n[r]);this.drawer.clear(),this.drawer.drawShot(n)}}}},{key:"handleReplay",value:function(){this.resetAnimation()}},{key:"resetAnimation",value:function(){this.isPlaying=!1,this.animationTimer=-2.3,this.drawer.resetCanvas(),this.drawShot(this.allShots[this.currentShotIndex],0),this.resetSimulation(this.allShots[this.currentShotIndex])}},{key:"resetSimulation",value:function(e){console.log("reset simulation");var t=this.realPosition.stateFrom(e);this.container.table.updateFromShortSerialised(t.init),this.container.eventQueue.push(new d.h),this.container.eventQueue.push(new v.u),this.container.eventQueue.push(new o.W(t.init,t.shots)),this.aimInputs.setAim(t.shots[0])}},{key:"advance",value:function(e){this.elapsedTime+=e,this.animationTimer+=e;var t=this.allShots[this.currentShotIndex];this.drawShot(t,this.animationTimer)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),w=n("./src/utils/dom.ts");function k(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function x(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var T=function(){var e,t;function n(e,t,r){var i=this;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");x(this,"container",void 0),x(this,"canvas3d",void 0),x(this,"ruletype",void 0),x(this,"replay",void 0),x(this,"cushionModel",void 0),x(this,"breakState",{init:null,shots:[]}),x(this,"realOverlay",void 0),x(this,"onAssetsReady",function(){console.log("diagram ready");var e=(0,w.vq)("replay");i.replayButton(e);var t=(0,w.dX)("overlaycanvas");t?i.realOverlay=new g(t,i.container):(i.breakState=JSON.parse(decodeURIComponent(i.replay)),i.container.eventQueue.push(new o.W(i.breakState.init,i.breakState.shots))),i.container.animate(performance.now())}),this.replay=r,this.ruletype=t,this.canvas3d=e,s.v.zoomFactor=.88}return e=[{key:"start",value:function(){var e=new i.s(this.canvas3d);this.container=new r.m(this.canvas3d,console.log,l.s.localAssets(this.ruletype),this.ruletype,e,"diagram"),this.cushionModel&&(this.container.table.cushionModel=this.cushionModel),this.onAssetsReady()}},{key:"replayButton",value:function(e){var t=this;e.innerHTML="â†»",e.addEventListener("click",function(){var e;0==t.container.eventQueue.length&&t.container.eventQueue.push(new o.W(t.breakState.init,t.breakState.shots)),null==(e=t.realOverlay)||e.start()})}}],t=[{key:"fromDiamgramElement",value:function(e){var t=null==e?void 0:e.getElementsByClassName("topview")[0],r=null==t?void 0:t.getAttribute("data-state"),i=new URLSearchParams(r),o=null==e?void 0:e.getElementsByClassName("description")[0],s=(0,w.id)("common"),l=document.createElement("a");l.href="../".concat(r),l.innerHTML="â¬€",l.target="_blank",null==o||o.appendChild(l),null==s||s.appendChild(l);var c=document.createElement("button");null==o||o.appendChild(c);var u=new n(t,i.get("ruletype"),i.get("state"));return u.replayButton(c),"bounceHan"==i.get("cushionModel")&&(u.cushionModel=a.QV),u}}],e&&k(n.prototype,e),t&&k(n,t),n}()},"./src/events/abortevent.ts"(e,t,n){n.d(t,{h:()=>l});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function a(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(a=function(){return!!e})()}var l=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return t=o(t=n),(e=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,a()?Reflect.construct(t,[],o(this).constructor):t.apply(this,void 0))).type=i.B.ABORT,e}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&s(n,e),t=[{key:"applyToController",value:function(e){return e.handleAbort(this)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.F)},"./src/events/aimevent.ts"(e,t,n){n.d(t,{w:()=>f});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts"),o=n("./src/utils/utils.ts"),s=n("./node_modules/three/build/three.core.js");function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function u(e,t){return(u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function h(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(h=function(){return!!e})()}var f=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(){var e,t;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return t=c(t=r),l(e=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,h()?Reflect.construct(t,[],c(this).constructor):t.apply(this,void 0)),"offset",new s.Pq0(0,0,0)),l(e,"angle",0),l(e,"power",0),l(e,"pos",new s.Pq0(0,0,0)),l(e,"i",0),e.type=i.B.AIM,e}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&u(r,e),t=[{key:"applyToController",value:function(e){return e.handleAim(this)}},{key:"copy",value:function(){return r.fromJson(this)}}],n=[{key:"fromJson",value:function(e){var t=new r;return t.pos=(0,o.t6)(e.pos),t.angle=e.angle,t.offset=(0,o.t6)(e.offset),t.power=e.power,e.i&&(t.i=e.i),t}}],t&&a(r.prototype,t),n&&a(r,n),r}(r.F)},"./src/events/beginevent.ts"(e,t,n){n.d(t,{u:()=>l});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function a(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(a=function(){return!!e})()}var l=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return t=o(t=n),(e=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,a()?Reflect.construct(t,[],o(this).constructor):t.apply(this,void 0))).type=i.B.BEGIN,e}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&s(n,e),t=[{key:"applyToController",value:function(e){return e.handleBegin(this)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.F)},"./src/events/breakevent.ts"(e,t,n){n.d(t,{W:()=>u});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(c=function(){return!!e})()}var u=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(e,t){var n,o;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return o=a(o=r),s(n=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,c()?Reflect.construct(o,[],a(this).constructor):o.apply(this,void 0)),"init",void 0),s(n,"shots",void 0),s(n,"retry",void 0),n.init=e,n.shots=t,n.type=i.B.BREAK,n}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&l(r,e),t=[{key:"applyToController",value:function(e){return e.handleBreak(this)}}],n=[{key:"fromJson",value:function(e){return new r(e.init,e.shots)}}],t&&o(r.prototype,t),n&&o(r,n),r}(r.F)},"./src/events/chatevent.ts"(e,t,n){n.d(t,{b:()=>u});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(c=function(){return!!e})()}var u=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(e,t){var n,o;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return o=a(o=r),s(n=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,c()?Reflect.construct(o,[],a(this).constructor):o.apply(this,void 0)),"sender",void 0),s(n,"message",void 0),n.sender=e,n.message=t,n.type=i.B.CHAT,n}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&l(r,e),t=[{key:"applyToController",value:function(e){return e.handleChat(this)}}],n=[{key:"fromJson",value:function(e){return new r(e.sender,e.message)}}],t&&o(r.prototype,t),n&&o(r,n),r}(r.F)},"./src/events/eventtype.ts"(e,t,n){n.d(t,{B:()=>i});var r,i=((r={}).BEGIN="BEGIN",r.BREAK="BREAK",r.WATCHAIM="WATCHAIM",r.AIM="AIM",r.HIT="HIT",r.STATIONARY="STATIONARY",r.CHAT="CHAT",r.ABORT="ABORT",r.PLACEBALL="PLACEBALL",r.REJOIN="REJOIN",r.RERACK="RERACK",r.STARTAIM="STARTAIM",r.NOTIFICATION="NOTIFICATION",r.SCORE="SCORE",r)},"./src/events/eventutil.ts"(e,t,n){n.d(t,{d:()=>x});var r=n("./src/events/eventtype.ts"),i=n("./src/events/aimevent.ts"),o=n("./src/events/watchevent.ts"),s=n("./src/events/hitevent.ts"),a=n("./src/events/abortevent.ts"),l=n("./src/events/breakevent.ts"),c=n("./src/events/beginevent.ts"),u=n("./src/events/chatevent.ts");function h(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function p(e){return(p=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function v(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(v=function(){return!!e})()}var y=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function i(){var e,t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(!(this instanceof i))throw TypeError("Cannot call a class as a function");return e=p(e=i),f(t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,v()?Reflect.construct(e,[],p(this).constructor):e.apply(this,void 0)),"clientResendFrom",void 0),f(t,"serverResendFrom",void 0),t.type=r.B.REJOIN,t.clientResendFrom=n,t.serverResendFrom=o,t}return i.prototype=Object.create(e&&e.prototype,{constructor:{value:i,writable:!0,configurable:!0}}),e&&d(i,e),t=[{key:"applyToController",value:function(e){return e.handleRejoin(this)}}],n=[{key:"fromJson",value:function(e){return new i(e.clientResendFrom,e.serverResendFrom)}}],t&&h(i.prototype,t),n&&h(i,n),i}(n("./src/events/gameevent.ts").F),m=n("./src/events/placeballevent.ts"),b=n("./src/events/rerackevent.ts"),g=n("./src/events/startaimevent.ts"),w=n("./src/events/notificationevent.ts"),k=n("./src/events/scoreevent.ts"),x=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"serialise",value:function(e){return JSON.stringify(e)}},{key:"fromJson",value:function(e){switch(e.type){case r.B.BEGIN:return new c.u;case r.B.AIM:return i.w.fromJson(e);case r.B.BREAK:return l.W.fromJson(e);case r.B.WATCHAIM:return o.Q.fromJson(e.json);case r.B.HIT:return s.Q.fromJson(e);case r.B.CHAT:return u.b.fromJson(e);case r.B.REJOIN:return y.fromJson(e);case r.B.ABORT:return new a.h;case r.B.PLACEBALL:return m.z.fromJson(e);case r.B.RERACK:return b.x.fromJson(e);case r.B.STARTAIM:return g.M.fromJson(e);case r.B.NOTIFICATION:return w.c.fromJson(e);case r.B.SCORE:return k.P.fromJson(e);default:throw Error("Unknown GameEvent :"+e)}}},{key:"fromSerialised",value:function(e){var n=JSON.parse(e),r=t.fromJson(n);return"sequence"in n&&(r.sequence=n.sequence),"clientId"in n&&(r.clientId=n.clientId),"playername"in n&&(r.playername=n.playername),r}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/events/gameevent.ts"(e,t,n){function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,{F:()=>i});var i=function e(){if(!(this instanceof e))throw TypeError("Cannot call a class as a function");r(this,"type",void 0),r(this,"sequence",void 0),r(this,"clientId",void 0),r(this,"playername",void 0)}},"./src/events/hitevent.ts"(e,t,n){n.d(t,{Q:()=>c});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(e){var t,n,o,a;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return n=s(n=r),t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(n,[],s(this).constructor):n.apply(this,void 0)),a=void 0,(o="tablejson")in t?Object.defineProperty(t,o,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[o]=a,t.type=i.B.HIT,t.tablejson=e,t}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&a(r,e),t=[{key:"applyToController",value:function(e){return e.handleHit(this)}}],n=[{key:"fromJson",value:function(e){return new r(e.tablejson)}}],t&&o(r.prototype,t),n&&o(r,n),r}(r.F)},"./src/events/input.ts"(e,t,n){function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,{p:()=>i});var i=function e(t,n){if(!(this instanceof e))throw TypeError("Cannot call a class as a function");r(this,"t",void 0),r(this,"key",void 0),this.t=t,this.key=n}},"./src/events/keyboard.ts"(e,t,n){n.d(t,{s:()=>a});var r=n("./src/events/input.ts"),i=n("./node_modules/interactjs/dist/interact.min.js"),o=n.n(i);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e;function t(e){var n=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");s(this,"pressed",{}),s(this,"released",{}),s(this,"keydown",function(e){null==n.pressed[e.code]&&(n.pressed[e.code]=performance.now()),e.stopImmediatePropagation(),"F12"!==e.key&&e.preventDefault()}),s(this,"keyup",function(e){n.released[e.code]=performance.now()-n.pressed[e.code],delete n.pressed[e.code],e.stopImmediatePropagation(),"F12"!==e.key&&e.preventDefault()}),s(this,"mousetouch",function(e){var t,r,i=n.released,o=e.client.y<e.rect.height/2||e.ctrlKey?.5:1,s=e.dx*o,a=.8*e.dy;i.movementY=(null!=(t=i.movementY)?t:0)+a,i.movementX=(null!=(r=i.movementX)?r:0)+s,Math.abs(i.movementX)>Math.abs(i.movementY)&&(i.movementY=0)}),this.addHandlers(e),/Android|iPhone/i.test(navigator.userAgent)||(e.contentEditable="true")}return e=[{key:"getEvents",value:function(){var e=this,t=Object.keys(this.pressed).filter(function(e){return!/Shift/.test(e)}).filter(function(e){return!/Control/.test(e)}),n=Object.keys(this.pressed).some(function(e){return/Shift/.test(e)}),i=Object.keys(this.pressed).some(function(e){return/Control/.test(e)}),o=[];return t.forEach(function(t){var s=performance.now()-e.pressed[t];o.push(new r.p(i?s/3:s,n?"Shift"+t:t)),"Space"!=t&&(e.pressed[t]=performance.now())}),Object.keys(this.released).forEach(function(t){return o.push(new r.p(e.released[t],t+"Up"))}),this.released={},o}},{key:"addHandlers",value:function(e){var t=this;e.addEventListener("keydown",this.keydown),e.addEventListener("keyup",this.keyup),e.focus(),o()(e).draggable({listeners:{move:function(e){t.mousetouch(e)}}}),o()(e).gesturable({onmove:function(e){e.dx/=3,t.mousetouch(e)}})}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/events/notificationevent.ts"(e,t,n){n.d(t,{c:()=>u});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(c=function(){return!!e})()}var u=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(e,t){var n,o;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return o=a(o=r),s(n=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,c()?Reflect.construct(o,[],a(this).constructor):o.apply(this,void 0)),"data",void 0),s(n,"duration",void 0),n.data=e,n.duration=t,n.type=i.B.NOTIFICATION,n}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&l(r,e),t=[{key:"applyToController",value:function(e){return e.handleNotification(this)}}],n=[{key:"fromJson",value:function(e){return new r(e.data,e.duration)}}],t&&o(r.prototype,t),n&&o(r,n),r}(r.F)},"./src/events/placeballevent.ts"(e,t,n){n.d(t,{z:()=>h});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts"),o=n("./src/utils/utils.ts");function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(u=function(){return!!e})()}var h=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(e,t,n){var o,s;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return s=l(s=r),a(o=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,u()?Reflect.construct(s,[],l(this).constructor):s.apply(this,void 0)),"pos",void 0),a(o,"respot",void 0),a(o,"useStartPos",void 0),o.pos=e,o.respot=t,o.useStartPos=n,o.type=i.B.PLACEBALL,o}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&c(r,e),t=[{key:"applyToController",value:function(e){return e.handlePlaceBall(this)}}],n=[{key:"fromJson",value:function(e){var t,n=e.respot?{id:e.respot.id,pos:(0,o.t6)(e.respot.pos)}:void 0;return new r((0,o.t6)(e.pos),n,null!=(t=e.useStartPos)&&t)}}],t&&s(r.prototype,t),n&&s(r,n),r}(r.F)},"./src/events/rerackevent.ts"(e,t,n){n.d(t,{x:()=>c});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(){var e,t,n,o;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return t=s(t=r),e=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(t,[],s(this).constructor):t.apply(this,void 0)),o=void 0,(n="ballinfo")in e?Object.defineProperty(e,n,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[n]=o,e.type=i.B.RERACK,e}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&a(r,e),t=[{key:"applyToController",value:function(e){return r.applyBallinfoToTable(e.container.table,this.ballinfo),e}}],n=[{key:"fromJson",value:function(e){var t,n=new r;return n.ballinfo=null!=(t=e.ballinfo)?t:e,n}},{key:"applyBallinfoToTable",value:function(e,t){e.updateFromSerialised(t),(null==t?void 0:t.balls)&&t.balls.forEach(function(t){var n=e.balls[t.id];n&&(n.pos.copy(t.pos),n.setStationary())})}}],t&&o(r.prototype,t),n&&o(r,n),r}(r.F)},"./src/events/scoreevent.ts"(e,t,n){n.d(t,{P:()=>c});var r=n("./src/events/eventtype.ts");function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function c(e,t,n){var i,a;if(!(this instanceof c))throw TypeError("Cannot call a class as a function");return a=s(a=c),o(i=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(a,[],s(this).constructor):a.apply(this,void 0)),"p1",void 0),o(i,"p2",void 0),o(i,"b",void 0),i.p1=e,i.p2=t,i.b=n,i.type=r.B.SCORE,i}return c.prototype=Object.create(e&&e.prototype,{constructor:{value:c,writable:!0,configurable:!0}}),e&&a(c,e),t=[{key:"applyToController",value:function(e){return e.handleScore(this)}}],n=[{key:"fromJson",value:function(e){return new c(e.p1,e.p2,e.b)}}],t&&i(c.prototype,t),n&&i(c,n),c}(n("./src/events/gameevent.ts").F)},"./src/events/startaimevent.ts"(e,t,n){n.d(t,{M:()=>c});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(){var e,t,n,o,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return e=s(e=r),(n="foul")in(t=o=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(e,[],s(this).constructor):e.apply(this,void 0)))?Object.defineProperty(t,n,{value:0,enumerable:!0,configurable:!0,writable:!0}):t[n]=0,o.type=i.B.STARTAIM,o.foul=a,o}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&a(r,e),t=[{key:"applyToController",value:function(e){return e.handleStartAim(this)}}],n=[{key:"fromJson",value:function(e){return new r(e.foul)}}],t&&o(r.prototype,t),n&&o(r,n),r}(r.F)},"./src/events/stationaryevent.ts"(e,t,n){n.d(t,{T:()=>l});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function a(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(a=function(){return!!e})()}var l=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return t=o(t=n),(e=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,a()?Reflect.construct(t,[],o(this).constructor):t.apply(this,void 0))).type=i.B.STATIONARY,e}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&s(n,e),t=[{key:"applyToController",value:function(e){return e.handleStationary(this)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.F)},"./src/events/watchevent.ts"(e,t,n){n.d(t,{Q:()=>c});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(e){var t,n,o,a;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return n=s(n=r),t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(n,[],s(this).constructor):n.apply(this,void 0)),a=void 0,(o="json")in t?Object.defineProperty(t,o,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[o]=a,t.type=i.B.WATCHAIM,t.json=e,t}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&a(r,e),t=[{key:"applyToController",value:function(e){return e.handleWatch(this)}}],n=[{key:"fromJson",value:function(e){return new r(e)}}],t&&o(r.prototype,t),n&&o(r,n),r}(r.F)},"./src/model/ball.ts"(e,t,n){n.d(t,{c:()=>x,U:()=>k});var r,i,o,s,a,l=n("./src/utils/utils.ts"),c=n("./src/model/physics/physics.ts"),u=n("./node_modules/three/build/three.core.js"),h=n("./src/model/physics/constants.ts");function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var p=function(){var e;function t(e,n){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");f(this,"line",void 0),f(this,"geometry",void 0),f(this,"positions",void 0),f(this,"lastPos",new u.Pq0),f(this,"lastVel",new u.Pq0),this.geometry=new u.LoY,this.positions=new Float32Array(3*e),this.geometry.setAttribute("position",new u.THS(this.positions,3)),this.reset();var r=new u.mrM({color:n,opacity:.25,linewidth:3,transparent:!0});this.line=new u.N1A(this.geometry,r),this.line.visible=!1}return e=[{key:"reset",value:function(){this.geometry.setDrawRange(0,0),this.lastVel.setZ(1)}},{key:"forceTrace",value:function(e){this.lastVel.z=1,this.addTraceGiven(e,this.lastVel,1,.1,1)}},{key:"addTrace",value:function(e,t){if(0!==t.length()){var n=this.lastVel.angleTo(t),r=n>Math.PI/32?.01*h.R:h.R,i=this.lastPos.distanceTo(e);this.addTraceGiven(e,t,i,r,n)}}},{key:"addTraceGiven",value:function(e,t,n,r,i){var o=this.geometry.drawRange.count;0!==o&&n<r||(o>1&&i<1e-4&&o--,this.lastPos.copy(e),this.lastVel.copy(t),this.addPoint(e,o))}},{key:"addPoint",value:function(e,t){var n=3*t;n>this.positions.length||(this.positions[n++]=e.x,this.positions[n++]=e.y,this.positions[n]=e.z,this.geometry.setDrawRange(0,t+1),this.line.geometry.attributes.position.needsUpdate=!0)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),d=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"getOrCreateTexture",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:256,r="".concat(e,"_").concat(t.getHex(),"_").concat(n);if(this.textureCache.has(r))return this.textureCache.get(r);var i=this.createNumberTexture(e,t,n);return this.textureCache.set(r,i),i}},{key:"createNumberTexture",value:function(e,t,n){var r=n/256,i=document.createElement("canvas");i.width=n,i.height=n;var o=i.getContext("2d");if(!o)return new u.GOR(i);if(o.fillStyle="#".concat(t.getHexString()),o.fillRect(0,0,i.width,i.height),e>=9&&(o.fillStyle="white",o.fillRect(0,0,n,.2*n),o.fillRect(0,.8*n,n,.2*n)),e>0){var s=n/2,a=n/2,l=Math.round(52*r),c=Math.round(15*r);o.beginPath(),o.arc(s,a,l+c,0,2*Math.PI),o.fillStyle="black",o.fill(),o.beginPath(),o.arc(s,a,l,0,2*Math.PI),o.fillStyle="white",o.fill(),o.fillStyle="black",o.strokeStyle="black";var h=Math.round(97*r);o.lineWidth=.05*h,o.font="900 ".concat(h,'px "Arial Black", Arial, sans-serif'),o.textAlign="center",o.textBaseline="middle";var f=a+Math.round(5*r);o.strokeText(e.toString(),s,f),o.fillText(e.toString(),s,f)}var p=new u.GOR(i);return p.flipY=!1,p}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();r="textureCache",i=new Map,r in d?Object.defineProperty(d,r,{value:i,enumerable:!0,configurable:!0,writable:!0}):d[r]=i;var v=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"createDottedMaterial",value:function(e){var t="dotted_".concat(e.getHex());if(this.materialCache.has(t))return this.materialCache.get(t);var n=new u.tXL({emissive:0,flatShading:!0,vertexColors:!0,forceSinglePass:!0,shininess:25,specular:5592371});return this.materialCache.set(t,n),n}},{key:"createProjectedMaterial",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:256,r="projected_".concat(e,"_").concat(t.getHex(),"_").concat(n);if(this.materialCache.has(r))return this.materialCache.get(r);var i=d.getOrCreateTexture(e,t,n),o=new u._4j({color:t,roughness:.5,metalness:0,flatShading:!0});return o.onBeforeCompile=function(e){e.uniforms.numberTex={value:i},e.uniforms.projSize={value:2},e.vertexShader=e.vertexShader.replace("#include <common>",`#include <common>
+    `),typeClass:t}}},{key:"renderExtra",value:function(e){return e?e.includes("<")?'<div class="notification-extra">'.concat(e,"</div>"):'<div class="notification-badge">'.concat(e,"</div>"):""}},{key:"display",value:function(e,t,n){var r,i,o=this;this.element&&(this.element.innerHTML=e,this.element.className="",(i=this.element.classList).add.apply(i,function(e){if(Array.isArray(e))return z(e)}(r=t.split(" "))||function(e){if("u">typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(r)||function(e){if(e){if("string"==typeof e)return z(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return z(e,void 0)}}(r)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),this.element.style.display="flex",this.timeoutId&&globalThis.clearTimeout(this.timeoutId),n>0&&(this.timeoutId=globalThis.setTimeout(function(){o.clear()},n)))}},{key:"clear",value:function(){this.element&&(this.element.innerHTML="",this.element.style.display="none",this.element.className=""),this.timeoutId&&(globalThis.clearTimeout(this.timeoutId),this.timeoutId=null)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),q=n("./src/events/notificationevent.ts");function K(e,t,n,r,i,o,s){try{var a=e[o](s),l=a.value}catch(e){n(e);return}a.done?t(l):Promise.resolve(l).then(r,i)}function X(e){return function(){var t=this,n=arguments;return new Promise(function(r,i){var o=e.apply(t,n);function s(e){K(o,r,i,s,a,"next",e)}function a(e){K(o,r,i,s,a,"throw",e)}s(void 0)})}}function W(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Y(e,t){var n,r,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype),a=Object.defineProperty;return a(s,"next",{value:l(0)}),a(s,"throw",{value:l(1)}),a(s,"return",{value:l(2)}),"function"==typeof Symbol&&a(s,Symbol.iterator,{value:function(){return this}}),s;function l(a){return function(l){var c=[a,l];if(n)throw TypeError("Generator is already executing.");for(;s&&(s=0,c[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&c[0]?r.return:c[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,c[1])).done)return i;switch(r=0,i&&(c=[2&c[0],i.value]),c[0]){case 0:case 1:i=c;break;case 4:return o.label++,{value:c[1],done:!1};case 5:o.label++,r=c[1],c=[0];continue;case 7:c=o.ops.pop(),o.trys.pop();continue;default:if(!(i=(i=o.trys).length>0&&i[i.length-1])&&(6===c[0]||2===c[0])){o=0;continue}if(3===c[0]&&(!i||c[1]>i[0]&&c[1]<i[3])){o.label=c[1];break}if(6===c[0]&&o.label<i[1]){o.label=i[1],i=c;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(c);break}i[2]&&o.ops.pop(),o.trys.pop();continue}c=t.call(e,o)}catch(e){c=[6,e],r=0}finally{n=i=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}}var J=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");W(this,"relay",void 0),W(this,"element",void 0),this.relay=e,this.element=(0,k.id)("lobby")}return e=[{key:"init",value:function(){return X(function(){var e,t;return Y(this,function(n){switch(n.label){case 0:if(e=this,!this.relay||!this.element)return[2];return[4,(t=function(){return X(function(){var e,t;return Y(this,function(n){switch(n.label){case 0:return[4,null==(e=this.relay)?void 0:e.getOnlineCount()];case 1:return null!==(t=n.sent())&&this.element&&(this.element.textContent=" ".concat(t," ðŸ‘¥")),[2]}})}).call(e)})()];case 1:return n.sent(),setInterval(t,3e5),[2]}})}).call(this)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),Z=n("./src/events/scoreevent.ts");function Q(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var $=function(){var e;function t(e,n,r,i,o,s){var a=this,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");Q(this,"table",void 0),Q(this,"view",void 0),Q(this,"controller",void 0),Q(this,"inputQueue",[]),Q(this,"eventQueue",[]),Q(this,"keyboard",void 0),Q(this,"sound",void 0),Q(this,"chat",void 0),Q(this,"sliders",void 0),Q(this,"recorder",void 0),Q(this,"linkFormatter",void 0),Q(this,"id",""),Q(this,"isSinglePlayer",!0),Q(this,"rules",void 0),Q(this,"menu",void 0),Q(this,"hud",void 0),Q(this,"notification",void 0),Q(this,"lobbyIndicator",void 0),Q(this,"relay",null),Q(this,"scoreReporter",null),Q(this,"frame",void 0),Q(this,"scores",[0,0]),Q(this,"currentBreak",0),Q(this,"last",performance.now()),Q(this,"step",.001953125),Q(this,"broadcast",function(){}),Q(this,"log",void 0),Q(this,"sendChat",function(e){a.sendEvent(new O.b(a.id,e))}),Q(this,"throttle",new A(0,function(e){a.broadcast(e)})),Q(this,"lastEventTime",performance.now()),this.log=n,this.rules=N.V.create(i,this),this.table=this.rules.table(),this.view=new y(e,this.table,r),this.table.cue.aimInputs=new T(this),this.keyboard=o,this.sound=r.sound,this.chat=new S(this.sendChat),this.sliders=new M.r,this.linkFormatter=new L(this),this.recorder=new j(this,this.linkFormatter),this.id=s,this.menu=new H(this),this.table.addToScene(this.view.scene),this.hud=new D,this.notification=new V,this.relay=l,this.scoreReporter=c,this.lobbyIndicator=new J(this.relay),this.lobbyIndicator.init(),this.updateController(new m.J(this))}return e=[{key:"sendEvent",value:function(e){this.recorder.record(e),this.throttle.send(e)}},{key:"updateScoreHud",value:function(e,t,n){this.scores=[e,t],this.currentBreak=n;var i=void 0,o=void 0;if(r.N.hasInstance()){var s=r.N.getInstance(),a=0===r.N.playerIndex();i=(a?s.playername:s.opponentName)||void 0,o=(a?s.opponentName:s.playername)||void 0}this.hud.updateScores(e,t,i,o,n)}},{key:"sendScoreUpdate",value:function(e,t,n){var r=this.scores[0]!==e||this.scores[1]!==t||this.currentBreak!==n;this.updateScoreHud(e,t,n),r&&this.sendEvent(new Z.P(e,t,n))}},{key:"notify",value:function(e,t){this.notification.show(e,t),this.sendEvent(new q.c(e,t))}},{key:"notifyLocal",value:function(e,t){this.notification.show(e,t)}},{key:"advance",value:function(e){null==(t=this.frame)||t.call(this,e);for(var t,n=Math.floor(e/this.step),r=n*this.step,o=this.table.allStationary(),s=0;s<n;s++)this.table.advance(this.step);this.table.updateBallMesh(r),this.view.update(r,this.table.cue.aim),this.table.cue.update(r),!o&&this.table.allStationary()&&this.eventQueue.push(new i.T),this.sound.processOutcomes(this.table.outcome)}},{key:"processEvents",value:function(){var e=this;for(this.keyboard&&this.keyboard.getEvents().forEach(function(t){return e.inputQueue.push(t)});this.inputQueue.length>0;){this.lastEventTime=this.last;var t=this.inputQueue.shift();t&&this.updateController(this.controller.handleInput(t))}if(this.table.allStationary()){var n=this.eventQueue.shift();n&&(this.lastEventTime=performance.now(),this.recorder.record(n),this.updateController(n.applyToController(this.controller)))}}},{key:"animate",value:function(e){var t=this;this.advance((e-this.last)/1e3),this.last=e,this.processEvents(),(e<this.lastEventTime+12e3||!this.table.allStationary()||this.view.sizeChanged())&&this.view.render(),requestAnimationFrame(function(e){t.animate(e)})}},{key:"updateController",value:function(e){if(e!==this.controller){var t=r.N.hasInstance()?r.N.getInstance().playername:"_";this.log("".concat(t,": Transition to ").concat(e.name)),this.controller=e,this.controller.onFirst()}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/controller/aim.ts"(e,t,n){n.d(t,{m:()=>d});var r=n("./src/controller/controller.ts"),i=n("./src/controller/controllerbase.ts");function o(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){var t,r,i;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return r=n,i=[e],r=s(r),(t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(r,i||[],s(this).constructor):r.apply(this,i))).hit(),t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&a(n,e),t=[{key:"handleStationary",value:function(e){var t,n=this.container.table,r=n.outcome,i=this.container.rules.update(r),s=function(e){if(Array.isArray(e))return e}(t=this.container.rules.getScores())||function(e){var t,n,r=null==e?null:"u">typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var i=[],o=!0,s=!1;try{for(r=r.call(e);!(o=(t=r.next()).done)&&(i.push(t.value),2!==i.length);o=!0);}catch(e){s=!0,n=e}finally{try{o||null==r.return||r.return()}finally{if(s)throw n}}return i}}(t)||function(e){if(e){if("string"==typeof e)return o(e,2);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return o(e,2)}}(t)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(),a=s[0],l=s[1],c=this.container.rules.currentBreak;this.container.sendScoreUpdate(a,l,c);var u=this.container.rules.isPartOfBreak(r),h=this.container.rules.isEndOfGame(r);return this.container.recorder.updateBreak(r,u,h),n.cue.aimAtNext(n.cueball,this.container.rules.nextCandidateBall()),i}},{key:"handleInput",value:function(e){return this.commonKeyHandler(e),this}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(i.y),u=n("./src/controller/replay.ts");function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function p(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(p=function(){return!!e})()}var d=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");t=n,r=[e],t=h(t);var t,r,i,o=(i=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,p()?Reflect.construct(t,r||[],h(this).constructor):t.apply(this,r))).container.table;return o.cue.aimMode(),o.cue.showHelper(!0),o.cueball=i.container.rules.cueball,o.cue.aim.i=o.balls.indexOf(o.cueball),o.cue.moveTo(o.cueball.pos),o.cue.aimAtNext(o.cueball,i.container.rules.nextCandidateBall()),i.container.view.camera.suggestMode(i.container.view.camera.aimView),o.cue.aimInputs.showOverlap(),i}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&f(n,e),t=[{key:"onFirst",value:function(){this.container.table.cue.aimInputs.setDisabled(!1)}},{key:"handleInput",value:function(e){switch(e.key){case"Space":this.container.table.cue.adjustPower(e.t*this.scale*.7);break;case"SpaceUp":return this.playShot();default:if(!this.commonKeyHandler(e))return this}return this.container.sendEvent(this.container.table.cue.aim),this}},{key:"handleBreak",value:function(e){return new u.e(this.container,e.init,e.shots,e.retry)}},{key:"playShot",value:function(){var e=new r.Qe(this.container.table.serialise());return this.container.sendEvent(e),new c(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(i.y)},"./src/controller/controller.ts"(e,t,n){n.d(t,{Qe:()=>i.Q,pd:()=>o.p,wG:()=>r.w,xI:()=>s}),n("./src/events/beginevent.ts");var r=n("./src/events/aimevent.ts"),i=n("./src/events/hitevent.ts"),o=n("./src/events/input.ts");n("./src/events/abortevent.ts"),n("./src/events/stationaryevent.ts");var s=function(){var e;function t(e){var n,r;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");r=void 0,(n="container")in this?Object.defineProperty(this,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):this[n]=r,this.container=e}return e=[{key:"name",get:function(){return this.constructor.name}},{key:"handleInput",value:function(e){return this}},{key:"handleBegin",value:function(e){return this}},{key:"handleBreak",value:function(e){return this}},{key:"handleStartAim",value:function(e){return this}},{key:"handleAim",value:function(e){return this}},{key:"handleHit",value:function(e){return this}},{key:"handleAbort",value:function(e){return this}},{key:"handleWatch",value:function(e){return this}},{key:"handlePlaceBall",value:function(e){return this}},{key:"handleStationary",value:function(e){return this}},{key:"handleChat",value:function(e){return this}},{key:"handleRejoin",value:function(e){return this}},{key:"handleNotification",value:function(e){return this}},{key:"handleScore",value:function(e){return this}},{key:"onFirst",value:function(){}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/controller/controllerbase.ts"(e,t,n){n.d(t,{y:()=>h});var r=n("./src/controller/controller.ts"),i=n("./src/utils/gltf.ts"),o=n("./src/model/outcome.ts"),s=n("./node_modules/three/build/three.core.js");function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(e){return e&&"u">typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(u=function(){return!!e})()}var h=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t,r,i,o;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return t=n,r=arguments,t=a(t),(o="scale")in(i=e=function(e,t){if(t&&("object"===c(t)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,u()?Reflect.construct(t,r||[],a(this).constructor):t.apply(this,r)))?Object.defineProperty(i,o,{value:.001,enumerable:!0,configurable:!0,writable:!0}):i[o]=.001,e}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&l(n,e),t=[{key:"handleChat",value:function(e){var t=e.sender?"".concat(e.sender,":"):"",n="".concat(t," ").concat(e.message);return this.container.chat.showMessage(n),this}},{key:"handleNotification",value:function(e){return this.container.notification.show(e.data,e.duration),this}},{key:"handleScore",value:function(e){return this.container.updateScoreHud(e.p1,e.p2,e.b),this}},{key:"hit",value:function(){this.container.table.outcome=[o.P.hit(this.container.table.cueball,this.container.table.cue.aim.power)],this.container.table.hit(),this.container.view.camera.suggestMode(this.container.view.camera.aimView),this.container.table.cue.showHelper(!1)}},{key:"commonKeyHandler",value:function(e){var t=this.container.table.cue,n=e.t*this.scale;switch(e.key){case"ArrowLeft":return t.rotateAim(-n,this.container.table),!0;case"ArrowRight":return t.rotateAim(n,this.container.table),!0;case"ArrowDown":return t.adjustSpin(new s.Pq0(0,-n),this.container.table),!0;case"ArrowUp":return t.adjustSpin(new s.Pq0(0,n),this.container.table),!0;case"ShiftArrowLeft":return t.adjustSpin(new s.Pq0(n,0),this.container.table),!0;case"ShiftArrowRight":return t.adjustSpin(new s.Pq0(-n,0),this.container.table),!0;case"KeyPUp":return(0,i.KP)(this.container.view.scene),!0;case"KeyHUp":return t.toggleHelper(),!0;case"movementXUp":return t.rotateAim(2*n,this.container.table),!0;case"movementYUp":case"NumpadSubtract":return this.container.view.camera.adjustHeight(8*n),!0;case"NumpadAdd":return this.container.view.camera.adjustHeight(-(8*n)),!0;case"KeyOUp":return this.container.view.camera.toggleMode(),!0;case"KeyDUp":return this.togglePanel(),!0;case"KeyFUp":return this.toggleFullscreen(),!0;default:return!1}}},{key:"togglePanel",value:function(){this.container.sliders.toggleVisibility(),this.container.table.showSpin(!0),this.container.table.showTraces(!0),("u"<typeof process?"undefined":c(process))!=="object"&&console.log(this.container.table.serialise())}},{key:"toggleFullscreen",value:function(){document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen()}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.xI)},"./src/controller/end.ts"(e,t,n){n.d(t,{o:()=>c});var r=n("./src/controller/controller.ts"),i=n("./src/controller/init.ts"),o=n("./src/utils/replay-encoder.ts");function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e,t){var r,i,o,a,c;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return i=n,o=[e],i=s(i),r=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(i,o||[],s(this).constructor):i.apply(this,o)),c=void 0,(a="result")in r?Object.defineProperty(r,a,{value:c,enumerable:!0,configurable:!0,writable:!0}):r[a]=c,r.result=t,r}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&a(n,e),t=[{key:"onFirst",value:function(){if(this.result&&this.container.scoreReporter){try{var e=this.container.recorder.wholeGame(),t=JSON.stringify(e);this.result.replayData=o.k.crush(t)}catch(e){console.error("Failed to encode replay data",e)}this.container.scoreReporter.submitMatchResult(this.result)}}},{key:"handleChat",value:function(e){var t=e.sender?"".concat(e.sender,":"):"",n="".concat(t," ").concat(e.message);return this.container.chat.showMessage(n),this}},{key:"handleBegin",value:function(e){return new i.J(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.xI)},"./src/controller/init.ts"(e,t,n){n.d(t,{J:()=>k});var r=n("./src/events/watchevent.ts"),i=n("./src/controller/watchaim.ts"),o=n("./src/controller/controllerbase.ts"),s=n("./src/controller/placeball.ts"),a=n("./src/controller/replay.ts"),l=n("./src/network/client/session.ts"),c=n("./src/controller/controller.ts"),u=n("./src/events/eventutil.ts");function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function f(e){return(f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(e,t){return null!=t&&"u">typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function v(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(v=function(){return!!e})()}var y=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e,t,r){var i,o,s;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return o=n,s=[e],o=f(o),h(i=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,v()?Reflect.construct(o,s||[],f(this).constructor):o.apply(this,s)),"messageRelay",void 0),h(i,"tableId",void 0),h(i,"messages",[]),i.messageRelay=t,i.tableId=r,i.messageRelay.subscribe(i.tableId,function(e){console.log(e);var t=u.d.fromSerialised(e);i.messages.push(t),(p(t,c.Qe)||p(t,c.wG))&&i.container.eventQueue.push(t)}),console.log("Spectate"),i}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&d(n,e),t=[{key:"handleAim",value:function(e){return this.container.table.cue.aim=e,this.container.table.cueball.pos.copy(e.pos),this}},{key:"handleHit",value:function(e){return console.log("Spectate Hit"),this.container.table.updateFromSerialised(e.tablejson),this.container.table.outcome=[],this.container.table.hit(),this}},{key:"handleInput",value:function(e){return this.commonKeyHandler(e),this}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(o.y),m=n("./src/network/client/nchanmessagerelay.ts");function b(e){return(b=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function g(e,t){return(g=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function w(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(w=function(){return!!e})()}var k=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return e=n,t=arguments,e=b(e),function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,w()?Reflect.construct(e,t||[],b(this).constructor):e.apply(this,t))}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&g(n,e),t=[{key:"handleBegin",value:function(e){if(l.N.isSpectator()){var t;return new y(this.container,null!=(t=this.container.relay)?t:new m.p,l.N.getInstance().tableId)}return this.container.chat.showMessage("Start"),this.container.sendEvent(new r.Q(this.container.table.serialise())),new s.x(this.container)}},{key:"handleWatch",value:function(e){return this.container.chat.showMessage("Opponent to break"),this.container.rules.secondToPlay(),this.container.table.updateFromSerialised(e.json),l.N.hasInstance()&&(l.N.getInstance().playerIndex=1),new i.r(this.container)}},{key:"handleBreak",value:function(e){return e.init?(this.container.table.updateFromShortSerialised(e.init),this.container.chat.showMessage("Replay"),new a.e(this.container,e.init,e.shots)):new s.x(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(o.y)},"./src/controller/placeball.ts"(e,t,n){n.d(t,{x:()=>d});var r=n("./src/controller/controllerbase.ts"),i=n("./src/controller/controller.ts"),o=n("./src/controller/aim.ts"),s=n("./src/events/breakevent.ts"),a=n("./src/model/physics/constants.ts"),l=n("./node_modules/three/build/three.core.js"),c=n("./src/view/cuemesh.ts");function u(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function p(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(p=function(){return!!e})()}var d=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e,t){var r,i,o;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return i=n,o=[e],i=h(i),u(r=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,p()?Reflect.construct(i,o||[],h(this).constructor):i.apply(this,o)),"placescale",.02*a.R),u(r,"startPos",void 0),r.startPos=t,r.container.table.cue.moveTo(r.container.table.cueball.pos),r.container.table.cue.aim.power=0,r.container.view.camera.forceMode(r.container.view.camera.aimView),r}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&f(n,e),t=[{key:"onFirst",value:function(){var e=this.container.table.cueball;this.container.rules.allowsPlaceBall()&&(this.startPos?e.pos.copy(this.container.rules.placeBall(this.startPos.clone())):e.pos.copy(this.container.rules.placeBall())),e.setStationary(),e.updateMesh(0),this.container.table.cue.placeBallMode(),this.container.table.cue.showHelper(!1),this.container.table.cue.moveTo(this.container.table.cueball.pos),this.container.table.cue.aimInputs.setButtonText(`Place
+Ball`),this.container.table.cue.aimInputs.setDisabled(!1),this.container.rules.allowsPlaceBall()||this.container.inputQueue.push(new i.pd(1,"SpaceUp"))}},{key:"handleInput",value:function(e){var t=this.container.table.cueball.pos;switch(e.key){case"ArrowLeft":case"KeyI":this.moveTo(0,e.t*this.placescale);break;case"ArrowRight":case"KeyK":this.moveTo(0,-e.t*this.placescale);break;case"movementXUp":this.moveTo(0,-e.t*this.placescale*2);break;case"movementYUp":this.moveTo(-e.t*this.placescale*2,0);break;case"KeyJ":this.moveTo(-e.t*this.placescale,0);break;case"KeyL":this.moveTo(e.t*this.placescale,0);break;case"SpaceUp":return this.placed();default:this.commonKeyHandler(e)}return this.container.table.cue.moveTo(t),this.container.view.camera.forceMove(this.container.table.cue.aim),this.container.sendEvent(this.container.table.cue.aim),this}},{key:"moveTo",value:function(e,t){var n=new l.Pq0(e,t),r=this.container.table.cueball.pos.add(n);r.copy(this.container.rules.placeBall(r)),c.l.indicateValid(!this.container.table.overlapsAny(r))}},{key:"placed",value:function(){return this.container.table.overlapsAny(this.container.table.cueball.pos)?this:(this.container.table.cue.aimInputs.setButtonText("Hit"),this.container.sound.playNotify(),this.container.sendEvent(new s.W(this.container.table.shortSerialise())),new o.m(this.container))}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.y)},"./src/controller/replay.ts"(e,t,n){n.d(t,{e:()=>k});var r=n("./src/events/hitevent.ts"),i=n("./src/controller/controllerbase.ts"),o=n("./src/events/aimevent.ts"),s=n("./src/events/breakevent.ts"),a=n("./src/controller/aim.ts"),l=n("./src/events/eventtype.ts"),c=n("./src/events/rerackevent.ts"),u=n("./src/events/placeballevent.ts"),h=n("./src/controller/end.ts"),f=n("./src/events/scoreevent.ts"),p=n("./src/events/chatevent.ts"),d=n("./src/utils/gameover.ts");function v(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function m(e){return(m=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function b(e,t){return(b=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function g(e){return function(e){if(Array.isArray(e))return v(e)}(e)||function(e){if("u">typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e){if(e){if("string"==typeof e)return v(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return v(e,void 0)}}(e)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function w(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(w=function(){return!!e})()}var k=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e,t,r){var i,o,a,l=arguments.length>3&&void 0!==arguments[3]&&arguments[3],c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1500;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");if(i=n,o=[e],i=m(i),y(a=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,w()?Reflect.construct(i,o||[],m(this).constructor):i.apply(this,o)),"delay",void 0),y(a,"shots",void 0),y(a,"firstShot",void 0),y(a,"timer",void 0),y(a,"init",void 0),a.init=t,a.shots=g(r),a.firstShot=a.shots[0],a.delay=c,a.container.table.showTraces(!0),a.container.table.updateFromShortSerialised(a.init),console.log(a.shots),l){var u=new s.W(t,r);u.retry=!0,a.container.eventQueue.push(u)}else a.container.view.camera.forceMode(a.container.view.camera.topView),a.playNextShot(1.5*a.delay);return a}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&b(n,e),t=[{key:"onFirst",value:function(){var e=this;this.container.table.cue.aimInputs.setDisabled(!0);var t=this.container.menu.share;t&&(t.disabled=!1,t.onclick=function(){!function(e,t){var n;if(("u"<typeof process?"undefined":(n=process)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)=="object")return t(e);fetch("https://scoreboard-tailuge.vercel.app/api/shorten",{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({input:new URL(e.replaceAll("(","%28").replaceAll(")","%29").replaceAll("!","%21").replaceAll("*","%2A")).search})}).then(function(e){return e.json()}).then(function(n){"shortUrl"in n?t(n.shortUrl):(console.log("Could not shorten url:"),console.log(n),t(e))})}(window.location.href,function(t){var n,r,i,o,s=(o={title:"Billiards",text:"Replay break",url:t},(null==(n=(r=navigator).canShare)?void 0:n.call(r,o))?(navigator.share(o).then(function(){return console.log("shared successfully")}).catch(function(e){console.log("Error: "+e)}),"link shared"):(null==(i=navigator.clipboard)||i.writeText(t),'link copied to clipboard <a href="'.concat(t,'">').concat(t,"</a>")));e.container.eventQueue.push(new p.b(null,s))})})}},{key:"playNextShot",value:function(e){var t=this,n=this.shots.shift();if((null==n?void 0:n.type)===l.B.RERACK){var i=c.x.fromJson(n.ballinfo);c.x.applyBallinfoToTable(this.container.table,i.ballinfo),this.shots.length>0&&this.playNextShot(e);return}if((null==n?void 0:n.type)===l.B.PLACEBALL){var s=u.z.fromJson(n);if(this.container.table.cueball.pos.copy(s.pos),this.container.table.cueball.setStationary(),s.respot){var a=this.container.table.balls[s.respot.id];a&&(a.pos.copy(s.respot.pos),a.setStationary())}this.shots.length>0&&this.playNextShot(e);return}if((null==n?void 0:n.type)===l.B.SCORE){f.P.fromJson(n).applyToController(this),this.shots.length>0&&this.playNextShot(e);return}var h=o.w.fromJson(n);this.container.table.cueball=this.container.table.balls[h.i],console.log(this.container.table.cueball.pos.distanceTo(h.pos)),this.container.table.cueball.pos.copy(h.pos),this.container.table.cue.aim=h,this.container.table.cue.updateAimInput(),this.container.table.cue.t=1,clearTimeout(this.timer),this.timer=setTimeout(function(){t.container.eventQueue.push(new r.Q(t.container.table.cue.aim)),t.timer=void 0},e)}},{key:"handleHit",value:function(e){return this.hit(),this}},{key:"handleStationary",value:function(e){return(this.shots.length>0&&void 0===this.timer&&this.playNextShot(this.delay),0===this.shots.length&&void 0===this.timer)?(this.container.notifyLocal({type:"GameOver",title:"Replay Complete",extra:d.c.replay+d.c.lobby},0),new h.o(this.container)):this}},{key:"handleInput",value:function(e){return this.commonKeyHandler(e),this}},{key:"handleBreak",value:function(e){return(this.container.table.updateFromShortSerialised(e.init),this.shots=g(e.shots),this.container.table.showSpin(!0),e.retry)?this.retry():(this.playNextShot(this.delay),this)}},{key:"handleAbort",value:function(e){return console.log("Replay aborted"),clearTimeout(this.timer),this.timer=void 0,new h.o(this.container)}},{key:"retry",value:function(){clearTimeout(this.timer),this.timer=void 0,this.container.table.updateFromShortSerialised(this.init);var e=o.w.fromJson(this.firstShot);return this.container.table.cueball=this.container.table.balls[e.i],this.container.rules.cueball=this.container.table.cueball,this.container.table.cueball.pos.copy(e.pos),this.container.table.cue.aim=e,this.container.view.camera.forceMode(this.container.view.camera.aimView),new a.m(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(i.y)},"./src/controller/rules/rulefactory.ts"(e,t,n){n.d(t,{V:()=>B});var r=n("./src/events/rerackevent.ts"),i=n("./src/model/outcome.ts"),o=n("./src/utils/rack.ts"),s=n("./node_modules/three/build/three.core.js"),a=n("./src/controller/aim.ts"),l=n("./src/controller/placeball.ts"),c=n("./src/controller/watchaim.ts"),u=n("./src/events/placeballevent.ts"),h=n("./src/events/watchevent.ts"),f=n("./src/model/table.ts"),p=n("./src/model/physics/constants.ts"),d=n("./src/utils/respot.ts"),v=n("./src/view/tablegeometry.ts"),y=n("./src/events/startaimevent.ts"),m=n("./src/network/client/matchresult.ts"),b=n("./src/network/client/session.ts");function g(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function w(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function k(e){return function(e){if(Array.isArray(e))return g(e)}(e)||function(e){if("u">typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e){if(e){if("string"==typeof e)return g(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return g(e,void 0)}}(e)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var x=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");w(this,"container",void 0),w(this,"cueball",void 0),w(this,"currentBreak",0),w(this,"previousBreak",0),w(this,"rulename","nineball"),this.container=e}return e=[{key:"getScores",value:function(){return this.container.scores}},{key:"startTurn",value:function(){this.previousBreak=this.currentBreak,this.currentBreak=0}},{key:"nextCandidateBall",value:function(){var e=this;return this.container.table.balls.filter(function(t){return t!==e.cueball&&t.onTable()}).sort(function(e,t){return(e.label||0)-(t.label||0)})[0]}},{key:"placeBall",value:function(e){if(e){var t=new s.Pq0(v.P.tableX,v.P.tableY),n=new s.Pq0(-v.P.tableX,-v.P.tableY);return e.clamp(n,t)}return new s.Pq0(-(11*p.R)/.5,0,0)}},{key:"asset",value:function(){return"models/p8.min.gltf"}},{key:"tableGeometry",value:function(){v.P.hasPockets=!0}},{key:"table",value:function(){var e=new f.X(this.rack());return this.cueball=e.cueball,e}},{key:"rack",value:function(){return o.m.diamond()}},{key:"update",value:function(e){var t=this.foulReason(e);return t?this.handleFoul(e,t):i.P.potCount(e)>0?this.handlePot(e):this.handleMiss()}},{key:"handleFoul",value:function(e,t){this.container.notify({type:"Foul",title:"FOUL",subtext:t,extra:"Ball in hand"}),this.startTurn();var n=i.P.pots(e).includes(this.container.table.balls[9]),o=this.container.table.cueball;if(n){this.respotNineBall();var s=this.container.table.balls[9];if(s){var a=r.x.fromJson({balls:[s.serialise()]});console.log("Respot nine ball sending rerack event",a),this.container.sendEvent(a)}}var h=o.onTable()?o.pos.clone():this.placeBall(),f=new u.z(h,void 0,!0);return(this.container.sendEvent(f),this.container.isSinglePlayer)?new l.x(this.container,h):new c.r(this.container)}},{key:"handlePot",value:function(e){var t=this.container.table,n=i.P.potCount(e);return(this.currentBreak+=n,this.container.scores[b.N.playerIndex()]+=n,this.container.sound.playSuccess(t.inPockets()),this.isEndOfGame(e))?this.handleGameEnd(!0):(this.container.sendEvent(new h.Q(t.serialise())),new a.m(this.container))}},{key:"handleGameEnd",value:function(e){return m.n.presentGameEnd(this.container,this.rulename)}},{key:"handleMiss",value:function(){var e=this.container.table;return(this.container.sendEvent(new y.M),this.container.isSinglePlayer)?(this.container.sendEvent(new h.Q(e.serialise())),this.startTurn(),new a.m(this.container)):new c.r(this.container)}},{key:"isPartOfBreak",value:function(e){return i.P.isBallPottedNoFoul(this.container.table.cueball,e)}},{key:"isEndOfGame",value:function(e){return!this.isFoul(e)&&i.P.pots(e).includes(this.container.table.balls[9])}},{key:"otherPlayersCueBall",value:function(){return this.cueball}},{key:"secondToPlay",value:function(){}},{key:"allowsPlaceBall",value:function(){return!0}},{key:"isFoul",value:function(e){return null!==this.foulReason(e)}},{key:"foulReason",value:function(e){var t=this.container.table.cueball;if(i.P.isCueBallPotted(t,e))return"Cue ball potted";var n=this.getLowestBallAtStartOfShot(e),r=i.P.firstCollision(i.P.cueBallFirst(t,e));if(!r)return"No ball hit";if(r.ballB!==n)return"Wrong ball hit first";if(0===i.P.potCount(e)){var o=e.indexOf(r);if(!e.slice(o+1).some(function(e){return e.type===i.$.Cushion}))return"No cushion after contact"}return null}},{key:"getLowestBallAtStartOfShot",value:function(e){var t=this,n=i.P.pots(e),r=this.container.table.balls.filter(function(e){return e!==t.cueball&&e.onTable()});return k(n).concat(k(r)).sort(function(e,t){return(e.label||0)-(t.label||0)})[0]}},{key:"respotNineBall",value:function(){d.k.nineBall(this.container.table)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function T(e,t,n){return(T="u">typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=P(e)););return e}(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(n||e):i.value}})(e,t,n||e)}function P(e){return(P=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function S(e,t){return(S=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function O(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(O=function(){return!!e})()}var R=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){var t,r,i;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return r=n,i=[e],r=P(r),(t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,O()?Reflect.construct(r,i||[],P(this).constructor):r.apply(this,i))).rulename="fourteenone",t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&S(n,e),t=[{key:"asset",value:function(){return"models/p8.min.gltf"}},{key:"rack",value:function(){return o.m.triangle()}},{key:"update",value:function(e){var t=this.container.table;return this.checkRerack(t),T(P(n.prototype),"update",this).call(this,e)}},{key:"isFoul",value:function(e){return i.P.isCueBallPotted(this.container.table.cueball,e)}},{key:"checkRerack",value:function(e){var t=e.balls.filter(function(e){return e.onTable()}).filter(function(t){return t!==e.cueball});if(1===t.length){o.m.rerack(t[0],e),this.container.sound.playSuccess(e.inPockets());var n=e.serialise(),i=r.x.fromJson(n);this.container.sendEvent(i),this.container.recorder.wholeGameLink()}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(x),E=n("./src/controller/rules/snooker.ts"),A=n("./src/view/cameratop.ts"),M=n("./src/utils/utils.ts"),_=n("./src/utils/threecushionconfig.ts");function I(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function C(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var j=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");C(this,"container",void 0),C(this,"cueball",void 0),C(this,"currentBreak",0),C(this,"previousBreak",0),C(this,"rulename","threecushion"),this.container=e}return e=[{key:"getScores",value:function(){return this.container.scores}},{key:"startTurn",value:function(){}},{key:"nextCandidateBall",value:function(){if(!(0,M.hs)(this.container.recorder))return d.k.closest(this.container.table.cueball,this.container.table.balls)}},{key:"placeBall",value:function(e){return M.v_}},{key:"asset",value:function(){return"models/threecushion.min.gltf"}},{key:"secondToPlay",value:function(){this.cueball=this.container.table.balls[1]}},{key:"tableGeometry",value:function(){v.P.tableX=49*p.R,v.P.tableY=24*p.R,v.P.X=v.P.tableX+p.R,v.P.Y=v.P.tableY+p.R,v.P.hasPockets=!1}},{key:"table",value:function(){this.tableGeometry(),A.v.zoomFactor=.92;var e=new f.X(this.rack());return this.cueball=e.cueball,e}},{key:"rack",value:function(){return o.m.three()}},{key:"update",value:function(e){return i.P.isThreeCushionPoint(this.cueball,e)?(this.container.sound.playSuccess(e.length/3),this.container.sendEvent(new h.Q(this.container.table.serialise())),this.currentBreak++,this.container.scores[b.N.playerIndex()]++,this.isEndOfGame(e))?this.handleGameEnd(!0):new a.m(this.container):(this.previousBreak=this.currentBreak,this.currentBreak=0,this.container.isSinglePlayer)?(this.cueball=this.otherPlayersCueBall(),this.container.table.cue.aim.i=this.container.table.balls.indexOf(this.cueball),new a.m(this.container)):(this.container.sendEvent(new y.M),new c.r(this.container))}},{key:"otherPlayersCueBall",value:function(){var e=this.container.table.balls;return this.cueball===e[0]?e[1]:e[0]}},{key:"isPartOfBreak",value:function(e){return i.P.isThreeCushionPoint(this.cueball,e)}},{key:"isEndOfGame",value:function(e){var t,n=function(e){if(Array.isArray(e))return e}(t=this.container.scores)||function(e){var t,n,r=null==e?null:"u">typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var i=[],o=!0,s=!1;try{for(r=r.call(e);!(o=(t=r.next()).done)&&(i.push(t.value),2!==i.length);o=!0);}catch(e){s=!0,n=e}finally{try{o||null==r.return||r.return()}finally{if(s)throw n}}return i}}(t)||function(e){if(e){if("string"==typeof e)return I(e,2);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return I(e,2)}}(t)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(),r=n[0],i=n[1];return r>=_.Y.raceTo||i>=_.Y.raceTo}},{key:"handleGameEnd",value:function(e){return m.n.presentGameEnd(this.container,this.rulename)}},{key:"allowsPlaceBall",value:function(){return!1}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),B=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"create",value:function(e,t){switch(e){case"threecushion":return new j(t);case"fourteenone":return new R(t);case"snooker":return new E.c(t);default:return new x(t)}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/controller/rules/snooker.ts"(e,t,n){n.d(t,{c:()=>T});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/events/watchevent.ts"),o=n("./src/model/outcome.ts"),s=n("./src/utils/rack.ts"),a=n("./src/utils/respot.ts"),l=n("./src/controller/aim.ts"),c=n("./src/controller/watchaim.ts"),u=n("./src/model/table.ts"),h=n("./src/view/tablegeometry.ts"),f=n("./src/controller/placeball.ts"),p=n("./src/events/placeballevent.ts"),d=n("./src/utils/utils.ts");function v(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}var y=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"shotInfo",value:function(e,n,r,i){var s=o.P.firstCollision(n);return{pots:o.P.potCount(n),firstCollision:s,legalFirstCollision:t.isLegalFirstCollision(e,r,i,s),whitePotted:o.P.isCueBallPotted(e.cueball,n),targetIsRed:r}}},{key:"isLegalFirstCollision",value:function(e,n,r,i){if(!i)return!1;var o=i.ballB.id;if(n)return o>=7;if(r)return o>=1&&o<=6;var s=t.coloursOnTable(e).sort(function(e,t){return e.id-t.id});return 0!==s.length&&o===s[0].id}},{key:"calculateFoul",value:function(e,n){return{points:t.foulPoints(e,n),reason:t.foulReason(e,n)}}},{key:"foulPoints",value:function(e,t){var n,r,i,s,a=o.P.pots(e).map(function(e){return e.id}).filter(function(e){return e<7}),l=null!=(r=null==(s=t.firstCollision)||null==(i=s.ballB)?void 0:i.id)?r:0;return l>6&&(l=0),(n=Math).max.apply(n,[3,l].concat(function(e){if(Array.isArray(e))return v(e)}(a)||function(e){if("u">typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(a)||function(e){if(e){if("string"==typeof e)return v(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return v(e,void 0)}}(a)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()))+1}},{key:"foulReason",value:function(e,n){if(n.whitePotted)return"White potted";if(!n.firstCollision)return"No ball hit";var r=null!=(l=null==(c=n.firstCollision.ballB)?void 0:c.id)?l:0;if(n.targetIsRed){if(r<7||0===r){var i=t.colourName(r);return"Hit ".concat(i," instead of red")}}else if(r>=7)return"Hit red instead of colour";var s=o.P.pots(e).filter(function(e){return e.id>0&&e.id<7});if(s.length>1){var a=s.map(function(e){return t.colourName(e.id)}).join(", ");return"Potted ".concat(a)}if(1===s.length){var l,c,u,h,f,p=s[0].id,d=null!=(u=null==(f=n.firstCollision)||null==(h=f.ballB)?void 0:h.id)?u:0;if(p!==d){var v=t.colourName(p),y=t.colourName(d);return"Potted ".concat(v," instead of ").concat(y)}}return null}},{key:"respotAllPottedColours",value:function(e,t){return o.P.pots(t).filter(function(e){return e.id<7}).filter(function(e){return 0!==e.id}).map(function(t){return a.k.respot(t,e)})}},{key:"redsOnTable",value:function(e){return e.balls.slice(7).filter(function(e){return e.onTable()})}},{key:"coloursOnTable",value:function(e){return e.balls.slice(1,7).filter(function(e){return e.onTable()})}},{key:"colourName",value:function(e){return({1:"Yellow",2:"Green",3:"Brown",4:"Blue",5:"Pink",6:"Black"})[e]||"Ball ".concat(e)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}(),m=n("./src/network/client/matchresult.ts"),b=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"presentGameEnd",value:function(e,t){return m.n.presentGameEnd(e,t)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}(),g=n("./src/events/startaimevent.ts"),w=n("./src/network/client/session.ts"),k=n("./src/events/rerackevent.ts");function x(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var T=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");x(this,"cueball",void 0),x(this,"previousPotRed",!1),x(this,"targetIsRed",!0),x(this,"currentBreak",0),x(this,"previousBreak",0),x(this,"foulPoints",0),x(this,"rulename","snooker"),x(this,"container",void 0),this.container=e}return e=[{key:"snookerrule",value:function(e){this.foulPoints=0;var t=y.shotInfo(this.container.table,e,this.targetIsRed,this.previousPotRed);return 0===t.pots?(this.targetIsRed=y.redsOnTable(this.container.table).length>0,t.legalFirstCollision)?this.switchPlayer():this.foul(e,t):this.targetIsRed?this.targetRedRule(e,t):this.targetColourRule(e,t)}},{key:"targetRedRule",value:function(e,t){return t.legalFirstCollision&&o.P.onlyRedsPotted(e)?(this.currentBreak+=t.pots,this.container.scores[w.N.playerIndex()]+=t.pots,this.targetIsRed=!1,this.previousPotRed=!0,this.continueBreak()):this.foul(e,t)}},{key:"targetColourRule",value:function(e,t){if(t.whitePotted)return this.foul(e,t);if(t.pots>1)return this.respot(e),this.foul(e,t);if(o.P.pots(e)[0].id>6)return this.foul(e,t);var n=o.P.pots(e)[0].id;return n!==t.firstCollision.ballB.id?this.foul(e,t):this.previousPotRed?(this.respot(e),this.currentBreak+=n+1,this.container.scores[w.N.playerIndex()]+=n+1,this.previousPotRed=!1,this.targetIsRed=y.redsOnTable(this.container.table).length>0,this.continueBreak()):y.coloursOnTable(this.container.table).filter(function(e){return e.id<n}).length>0?this.foul(e,t):(this.currentBreak+=n+1,this.container.scores[w.N.playerIndex()]+=n+1,this.previousPotRed=!1,this.targetIsRed=y.redsOnTable(this.container.table).length>0,this.continueBreak())}},{key:"foul",value:function(e,t){var n=y.calculateFoul(e,t);this.foulPoints=n.points;var r=w.N.playerIndex();this.container.scores[1-r]+=this.foulPoints;var i=t.whitePotted?{type:"Foul",title:"FOUL",subtext:n.reason||"Foul (".concat(this.foulPoints," points)"),extra:"Ball in hand"}:{type:"Foul",title:"FOUL",subtext:n.reason||"Foul (".concat(this.foulPoints," points)")};return(this.container.notify(i),this.respot(e),t.whitePotted)?this.whiteInHand():this.switchPlayer()}},{key:"tableGeometry",value:function(){h.P.hasPockets=!0}},{key:"table",value:function(){var e=new u.X(this.rack());return this.cueball=e.cueball,e}},{key:"otherPlayersCueBall",value:function(){return this.cueball}},{key:"secondToPlay",value:function(){}},{key:"isPartOfBreak",value:function(e){return this.currentBreak>0}},{key:"isEndOfGame",value:function(e){return o.P.isClearTable(this.container.table)&&this.currentBreak>0}},{key:"allowsPlaceBall",value:function(){return!0}},{key:"asset",value:function(){return t.tablemodel}},{key:"startTurn",value:function(){this.previousPotRed=!1,this.targetIsRed=y.redsOnTable(this.container.table).length>0,this.previousBreak=this.currentBreak,this.currentBreak=0}},{key:"getScores",value:function(){return this.container.scores}},{key:"rack",value:function(){return s.m.snooker()}},{key:"nextCandidateBall",value:function(){if((0,d.hs)(this.container.recorder))return void console.log("first shot");var e=this.container.table,t=y.redsOnTable(e),n=y.coloursOnTable(e);return this.previousPotRed?a.k.closest(e.cueball,n):t.length>0?a.k.closest(e.cueball,t):n.length>0?n[0]:void 0}},{key:"placeBall",value:function(e){if(e){var t=new r.Pq0(s.m.baulk,0,0),n=s.m.sixth,i=e.distanceTo(t);if(e.x>=s.m.baulk&&(e.x=s.m.baulk),!(i>n))return e;var o=e.clone().sub(t).normalize();return t.add(o.multiplyScalar(n))}return new r.Pq0(s.m.baulk,-s.m.sixth/2.6,0)}},{key:"switchPlayer",value:function(){var e=this.container.table;return(this.container.sendEvent(new g.M(this.foulPoints)),this.container.isSinglePlayer)?(this.container.sendEvent(new i.Q(e.serialise())),this.startTurn(),new l.m(this.container)):(this.startTurn(),new c.r(this.container))}},{key:"continueBreak",value:function(){var e=this.container.table;return(this.container.sound.playSuccess(e.inPockets()),o.P.isClearTable(e))?this.handleGameEnd(!0):(this.container.sendEvent(new i.Q(e.serialise())),new l.m(this.container))}},{key:"handleGameEnd",value:function(e){return b.presentGameEnd(this.container,this.rulename)}},{key:"whiteInHand",value:function(){return(this.startTurn(),this.container.isSinglePlayer)?new f.x(this.container):(this.container.sendEvent(new p.z(d.v_)),new c.r(this.container))}},{key:"update",value:function(e){return this.snookerrule(e)}},{key:"respot",value:function(e){var t=y.respotAllPottedColours(this.container.table,e);if(t.length>0){var n=k.x.fromJson({balls:t.map(function(e){return e.serialise()})});this.container.sendEvent(n)}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();x(T,"tablemodel","models/d-snooker.min.gltf")},"./src/controller/watchaim.ts"(e,t,n){n.d(t,{r:()=>d});var r=n("./src/controller/aim.ts"),i=n("./src/controller/controllerbase.ts"),o=n("./src/controller/placeball.ts"),s=n("./src/events/rerackevent.ts");function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(c=function(){return!!e})()}var u=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){var t,r,i;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return r=n,i=[e],r=a(r),(t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,c()?Reflect.construct(r,i||[],a(this).constructor):r.apply(this,i))).container.table.outcome=[],t.container.table.hit(),t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&l(n,e),t=[{key:"onFirst",value:function(){this.container.table.cue.aimInputs.setDisabled(!0)}},{key:"handleStationary",value:function(e){var t=this.container.table.outcome;return this.container.rules.isEndOfGame(t)?this.container.rules.handleGameEnd(!1):this}},{key:"handleStartAim",value:function(e){return this.container.rules.startTurn(),new r.m(this.container)}},{key:"handlePlaceBall",value:function(e){if(e.respot){var t=this.container.table.balls.find(function(t){return t.id===e.respot.id});t&&(t.pos.copy(e.respot.pos),t.setStationary())}return e.useStartPos?(this.container.rules.startTurn(),new o.x(this.container,e.pos.clone())):(this.container.rules.startTurn(),new o.x(this.container))}},{key:"handleWatch",value:function(e){return"rerack"in e.json?(console.log("Respot"),s.x.applyBallinfoToTable(this.container.table,e.json),this):new d(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(i.y);function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function p(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(p=function(){return!!e})()}var d=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){var t,r,i;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return r=n,i=[e],r=h(r),(t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,p()?Reflect.construct(r,i||[],h(this).constructor):r.apply(this,i))).container.table.cueball=t.container.rules.otherPlayersCueBall(),t.container.table.cue.moveTo(t.container.table.cueball.pos),t.container.view.camera.suggestMode(t.container.view.camera.topView),t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&f(n,e),t=[{key:"onFirst",value:function(){this.container.table.cue.aimInputs.setDisabled(!0)}},{key:"handleAim",value:function(e){return this.container.table.cue.aim=e,this.container.table.cueball.pos.copy(e.pos),this}},{key:"handleHit",value:function(e){return this.container.table.updateFromSerialised(e.tablejson),new u(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(i.y)},"./src/diagram/diagramcontainer.ts"(e,t,n){n.d(t,{n:()=>T});var r=n("./src/container/container.ts"),i=n("./src/events/keyboard.ts"),o=n("./src/events/breakevent.ts"),s=n("./src/view/cameratop.ts"),a=n("./src/model/physics/physics.ts"),l=n("./src/view/assets.ts"),c=n("./node_modules/three/build/three.core.js");function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}var h=function(){var e;function t(e){var n,r,i=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");r=void 0,(n="shots")in this?Object.defineProperty(this,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):this[n]=r,this.shots=e.map(function(e){return i.interpolateAllBalls(e)})}return e=[{key:"interpolateUntilMove",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.3,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e-5;return e.t.length>1&&e.t[1]-e.t[0]>t&&(e.t.splice(1,0,e.t[1]-n),e.x.splice(1,0,e.x[0]),e.y.splice(1,0,e.y[0])),e}},{key:"interpolateAllBalls",value:function(e){var t=this;return e.balls=Object.fromEntries(Object.entries(e.balls).map(function(e){var n=function(e){if(Array.isArray(e))return e}(e)||function(e){var t,n,r=null==e?null:"u">typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var i=[],o=!0,s=!1;try{for(r=r.call(e);!(o=(t=r.next()).done)&&(i.push(t.value),2!==i.length);o=!0);}catch(e){s=!0,n=e}finally{try{o||null==r.return||r.return()}finally{if(s)throw n}}return i}}(e)||function(e){if(e){if("string"==typeof e)return u(e,2);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return u(e,2)}}(e)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(),r=n[0],i=n[1];return[r,t.interpolateUntilMove(i)]})),e}},{key:"getInterpolatedPosition",value:function(e,t,n){if(!e||0===e.length||n<=e[0])return t[0];if(n>=e[e.length-1])return t[t.length-1];for(var r=0,i=e.length-1;r<i-1;){var o=Math.floor((r+i)/2);e[o]<n?r=o:i=o}var s=e[r],a=e[i],l=t[r];return l+(n-s)/(a-s)*(t[i]-l)}},{key:"getPositionsAtTime",value:function(e,t){var n=this.shots.find(function(t){return t.shotID===e}),r={};for(var i in n.balls){var o=n.balls[i],s=this.getInterpolatedPosition(o.t,o.x,t),a=this.getInterpolatedPosition(o.t,o.y,t);r[i]={x:s,y:a}}return r}},{key:"realToSim",value:function(e,t){return{x:2.3*(.71-t[e].x/2),y:2.3*(-.36+t[e].y/2)}}},{key:"identifyFirstMover",value:function(e){return console.log(e),e.balls["1"].t[1]<e.balls["2"].t[1]?"1":"2"}},{key:"estimateDirection",value:function(e){var t=this.getPositionsAtTime(e.shotID,0),n=this.getPositionsAtTime(e.shotID,.2),r=this.identifyFirstMover(e),i=t[r],o=new c.Pq0(i.x,i.y),s=n[r],a=new c.Pq0(s.x,s.y);return{pos1:t,pos2:n,firstMover:r,speed:2*o.distanceTo(a),angle:new c.Pq0(-1,0).angleTo(a.sub(o))}}},{key:"stateFrom",value:function(e){var t=this.getPositionsAtTime(e.shotID,0),n={init:[],shots:[]};for(var r in t){var i=this.realToSim(r,t);n.init.push(i.x),n.init.push(i.y)}var o=this.estimateDirection(e);console.log("estimated",o);var s=+("1"!=o.firstMover);return console.log(o),n.shots.push({type:"AIM",offset:{x:-0,y:0,z:0},angle:o.angle,power:o.speed,pos:{x:n.init[2*s],y:n.init[2*s+1],z:0},i:s}),n}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var p=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");f(this,"ctx",void 0),f(this,"canvas",void 0),f(this,"BALL_COLORS",{1:"white",2:"yellow",3:"red"}),f(this,"BALL_DIAMETER",.0615),f(this,"TABLE_WIDTH",2.84),f(this,"PIXELS_PER_METER",void 0),f(this,"ballPaths",{}),this.canvas=e,this.ctx=this.canvas.getContext("2d"),this.PIXELS_PER_METER=this.canvas.width/this.TABLE_WIDTH}return e=[{key:"drawBall",value:function(e,t,n){var r=this.BALL_DIAMETER/2*this.PIXELS_PER_METER,i=this.canvas.width-e;this.ctx.beginPath(),this.ctx.arc(i,t,r,0,2*Math.PI),this.ctx.fillStyle=n,this.ctx.fill(),this.ctx.strokeStyle="black",this.ctx.lineWidth=1,this.ctx.stroke()}},{key:"drawBallPath",value:function(e,t){var n=this,r=this.BALL_COLORS[e];this.ctx.save(),this.ctx.beginPath(),t.forEach(function(e,t){var r=n.canvas.width-e.x*n.PIXELS_PER_METER,i=n.canvas.height-e.y*n.PIXELS_PER_METER;0===t?n.ctx.moveTo(r,i):n.ctx.lineTo(r,i)}),this.ctx.setLineDash([4,4]),this.ctx.strokeStyle=r,this.ctx.lineWidth=1,this.ctx.stroke(),this.ctx.restore()}},{key:"clear",value:function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}},{key:"drawShot",value:function(e){for(var t in this.ballPaths)this.drawBallPath(t,this.ballPaths[t]);for(var n in e){var r=e[n],i=this.BALL_COLORS[n],o=r.x*this.PIXELS_PER_METER,s=this.canvas.height-r.y*this.PIXELS_PER_METER;this.drawBall(o,s,i)}}},{key:"resetCanvas",value:function(){this.clear(),this.ballPaths={}}},{key:"updateBallPaths",value:function(e,t){this.ballPaths[e]||(this.ballPaths[e]=[]),this.ballPaths[e].push(t)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),d=n("./src/events/abortevent.ts"),v=n("./src/events/beginevent.ts");function y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var m=function(){var e;function t(){var e;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");y(this,"aimBall",void 0),y(this,"aimCoordinatesDisplay",void 0),y(this,"aimBallContainer",void 0),y(this,"powerSlider",void 0),y(this,"directionSlider",void 0),y(this,"BALL_CONTAINER_RADIUS",void 0),y(this,"MAX_DISTANCE",.7),y(this,"position",{x:0,y:0}),y(this,"power",5),y(this,"direction",0),this.aimBall=document.getElementById("aim-ball"),this.aimCoordinatesDisplay=document.getElementById("aim-coordinates"),this.aimBallContainer=document.getElementById("aim-ball-container"),this.powerSlider=document.getElementById("power"),this.directionSlider=document.getElementById("direction"),this.BALL_CONTAINER_RADIUS=((null==(e=this.aimBallContainer)?void 0:e.clientWidth)||0)/2,this.addEventListeners()}return e=[{key:"addEventListeners",value:function(){var e,t,n,r=this;null==(e=this.aimBallContainer)||e.addEventListener("click",function(e){return r.handleClick(e)}),null==(t=this.powerSlider)||t.addEventListener("input",function(e){r.power=parseInt(e.target.value)}),null==(n=this.directionSlider)||n.addEventListener("input",function(e){r.direction=parseInt(e.target.value)})}},{key:"handleClick",value:function(e){if(this.aimBallContainer&&this.aimBall){var t=this.aimBallContainer.getBoundingClientRect(),n=e.clientX-t.left-t.width/2,r=e.clientY-t.top-t.height/2;if(Math.sqrt(n*n+r*r)>this.MAX_DISTANCE*this.BALL_CONTAINER_RADIUS){var i=Math.atan2(r,n);n=this.MAX_DISTANCE*this.BALL_CONTAINER_RADIUS*Math.cos(i),r=this.MAX_DISTANCE*this.BALL_CONTAINER_RADIUS*Math.sin(i)}var o=t.width/2-this.aimBall.offsetWidth/2,s=t.height/2-this.aimBall.offsetHeight/2,a=Math.max(-o,Math.min(o,n)),l=Math.max(-s,Math.min(s,r));this.position.x=a/this.BALL_CONTAINER_RADIUS,this.position.y=l/this.BALL_CONTAINER_RADIUS,this.updateDom()}}},{key:"updateDom",value:function(){if(this.aimBall&&this.aimBallContainer){var e=this.aimBallContainer.getBoundingClientRect(),t=this.position.x*this.BALL_CONTAINER_RADIUS,n=this.position.y*this.BALL_CONTAINER_RADIUS;this.aimBall.style.left="".concat(t+e.width/2-this.aimBall.offsetWidth/2,"px"),this.aimBall.style.top="".concat(n+e.height/2-this.aimBall.offsetHeight/2,"px"),this.aimCoordinatesDisplay&&(this.aimCoordinatesDisplay.textContent="x: ".concat(this.position.x.toFixed(2),", y: ").concat(this.position.y.toFixed(2)))}}},{key:"getAim",value:function(){return{offset:{x:this.position.x,y:this.position.y,z:0},angle:this.direction,power:this.power}}},{key:"setAim",value:function(e){this.position.x=e.offset.x,this.position.y=e.offset.y,this.power=e.power,this.powerSlider.value=e.power.toString(),this.direction=e.angle,this.directionSlider.value=e.angle.toString(),console.log("set aim",e),this.updateDom()}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function b(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var g=function(){var e;function t(e,n){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");b(this,"drawer",void 0),b(this,"aimInputs",void 0),b(this,"fileInput",document.getElementById("fileInput")),b(this,"shotIndexDisplay",document.getElementById("shotIndexDisplay")),b(this,"shotSelector",document.getElementById("shotSelector")),b(this,"replayButton",document.getElementById("replay")),b(this,"myIframe",document.getElementById("myIframe")),b(this,"allShots",[]),b(this,"currentShotIndex",0),b(this,"animationTimer",-2.35),b(this,"isPlaying",!1),b(this,"lastFrameTime",0),b(this,"animationStartTime",0),b(this,"realPosition",null),b(this,"elapsedTime",0),b(this,"container",void 0),this.drawer=new p(e),this.container=n,this.aimInputs=new m,n&&(n.frame=this.advance.bind(this)),this.start()}return e=[{key:"start",value:function(){console.log("real overlay start"),this.loadDefaultData(),this.addEventListeners()}},{key:"addEventListeners",value:function(){var e=this;this.fileInput.addEventListener("change",function(t){return e.handleFileChange(t)}),this.shotSelector.addEventListener("change",function(){return e.handleShotSelect()}),this.replayButton.addEventListener("click",function(){return e.handleReplay()})}},{key:"handleFileChange",value:function(e){var t=this,n=e.target.files[0];if(n){var r=new FileReader;r.onload=function(e){try{var n=JSON.parse(e.target.result);t.processShots(n)}catch(e){console.error("Error parsing JSON:",e),alert("Error parsing JSON file.")}},r.readAsText(n)}}},{key:"handleShotSelect",value:function(){this.currentShotIndex=parseInt(this.shotSelector.value,10),this.updateDisplay(),this.resetAnimation()}},{key:"loadDefaultData",value:function(){var e=this;fetch("simple_shots.json").then(function(e){if(!e.ok)throw Error("HTTP error! status: ".concat(e.status));return e.json()}).then(function(t){return e.processShots(t)})}},{key:"processShots",value:function(e){this.allShots=e,this.realPosition=new h(this.allShots),this.allShots.length>0&&(this.currentShotIndex=0,this.populateShotSelector(),this.updateDisplay(),this.resetAnimation())}},{key:"populateShotSelector",value:function(){var e=this;this.shotSelector.innerHTML="",this.allShots.forEach(function(t,n){var r=document.createElement("option");r.value=n.toString(),r.text="Shot ".concat(n+1," (ID: ").concat(t.shotID,")"),e.shotSelector.appendChild(r)}),this.allShots.length>0&&(this.shotSelector.value=this.currentShotIndex.toString())}},{key:"updateDisplay",value:function(){this.shotIndexDisplay.textContent="Shot: ".concat(this.currentShotIndex+1),this.allShots[this.currentShotIndex]&&(this.shotSelector.value=this.currentShotIndex.toString())}},{key:"drawShot",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(this.realPosition){var n=this.realPosition.getPositionsAtTime(e.shotID,t);if(n){for(var r in n)this.drawer.updateBallPaths(r,n[r]);this.drawer.clear(),this.drawer.drawShot(n)}}}},{key:"handleReplay",value:function(){this.resetAnimation()}},{key:"resetAnimation",value:function(){this.isPlaying=!1,this.animationTimer=-2.3,this.drawer.resetCanvas(),this.drawShot(this.allShots[this.currentShotIndex],0),this.resetSimulation(this.allShots[this.currentShotIndex])}},{key:"resetSimulation",value:function(e){console.log("reset simulation");var t=this.realPosition.stateFrom(e);this.container.table.updateFromShortSerialised(t.init),this.container.eventQueue.push(new d.h),this.container.eventQueue.push(new v.u),this.container.eventQueue.push(new o.W(t.init,t.shots)),this.aimInputs.setAim(t.shots[0])}},{key:"advance",value:function(e){this.elapsedTime+=e,this.animationTimer+=e;var t=this.allShots[this.currentShotIndex];this.drawShot(t,this.animationTimer)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),w=n("./src/utils/dom.ts");function k(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function x(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var T=function(){var e,t;function n(e,t,r){var i=this;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");x(this,"container",void 0),x(this,"canvas3d",void 0),x(this,"ruletype",void 0),x(this,"replay",void 0),x(this,"cushionModel",void 0),x(this,"breakState",{init:null,shots:[]}),x(this,"realOverlay",void 0),x(this,"onAssetsReady",function(){console.log("diagram ready");var e=(0,w.vq)("replay");i.replayButton(e);var t=(0,w.dX)("overlaycanvas");t?i.realOverlay=new g(t,i.container):(i.breakState=JSON.parse(decodeURIComponent(i.replay)),i.container.eventQueue.push(new o.W(i.breakState.init,i.breakState.shots))),i.container.animate(performance.now())}),this.replay=r,this.ruletype=t,this.canvas3d=e,s.v.zoomFactor=.88}return e=[{key:"start",value:function(){var e=new i.s(this.canvas3d);this.container=new r.m(this.canvas3d,console.log,l.s.localAssets(this.ruletype),this.ruletype,e,"diagram"),this.cushionModel&&(this.container.table.cushionModel=this.cushionModel),this.onAssetsReady()}},{key:"replayButton",value:function(e){var t=this;e.innerHTML="â†»",e.addEventListener("click",function(){var e;0==t.container.eventQueue.length&&t.container.eventQueue.push(new o.W(t.breakState.init,t.breakState.shots)),null==(e=t.realOverlay)||e.start()})}}],t=[{key:"fromDiamgramElement",value:function(e){var t=null==e?void 0:e.getElementsByClassName("topview")[0],r=null==t?void 0:t.getAttribute("data-state"),i=new URLSearchParams(r),o=null==e?void 0:e.getElementsByClassName("description")[0],s=(0,w.id)("common"),l=document.createElement("a");l.href="../".concat(r),l.innerHTML="â¬€",l.target="_blank",null==o||o.appendChild(l),null==s||s.appendChild(l);var c=document.createElement("button");null==o||o.appendChild(c);var u=new n(t,i.get("ruletype"),i.get("state"));return u.replayButton(c),"bounceHan"==i.get("cushionModel")&&(u.cushionModel=a.QV),u}}],e&&k(n.prototype,e),t&&k(n,t),n}()},"./src/events/abortevent.ts"(e,t,n){n.d(t,{h:()=>l});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function a(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(a=function(){return!!e})()}var l=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return t=o(t=n),(e=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,a()?Reflect.construct(t,[],o(this).constructor):t.apply(this,void 0))).type=i.B.ABORT,e}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&s(n,e),t=[{key:"applyToController",value:function(e){return e.handleAbort(this)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.F)},"./src/events/aimevent.ts"(e,t,n){n.d(t,{w:()=>f});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts"),o=n("./src/utils/utils.ts"),s=n("./node_modules/three/build/three.core.js");function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function u(e,t){return(u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function h(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(h=function(){return!!e})()}var f=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(){var e,t;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return t=c(t=r),l(e=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,h()?Reflect.construct(t,[],c(this).constructor):t.apply(this,void 0)),"offset",new s.Pq0(0,0,0)),l(e,"angle",0),l(e,"power",0),l(e,"pos",new s.Pq0(0,0,0)),l(e,"i",0),e.type=i.B.AIM,e}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&u(r,e),t=[{key:"applyToController",value:function(e){return e.handleAim(this)}},{key:"copy",value:function(){return r.fromJson(this)}}],n=[{key:"fromJson",value:function(e){var t=new r;return t.pos=(0,o.t6)(e.pos),t.angle=e.angle,t.offset=(0,o.t6)(e.offset),t.power=e.power,e.i&&(t.i=e.i),t}}],t&&a(r.prototype,t),n&&a(r,n),r}(r.F)},"./src/events/beginevent.ts"(e,t,n){n.d(t,{u:()=>l});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function a(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(a=function(){return!!e})()}var l=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return t=o(t=n),(e=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,a()?Reflect.construct(t,[],o(this).constructor):t.apply(this,void 0))).type=i.B.BEGIN,e}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&s(n,e),t=[{key:"applyToController",value:function(e){return e.handleBegin(this)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.F)},"./src/events/breakevent.ts"(e,t,n){n.d(t,{W:()=>u});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(c=function(){return!!e})()}var u=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(e,t){var n,o;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return o=a(o=r),s(n=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,c()?Reflect.construct(o,[],a(this).constructor):o.apply(this,void 0)),"init",void 0),s(n,"shots",void 0),s(n,"retry",void 0),n.init=e,n.shots=t,n.type=i.B.BREAK,n}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&l(r,e),t=[{key:"applyToController",value:function(e){return e.handleBreak(this)}}],n=[{key:"fromJson",value:function(e){return new r(e.init,e.shots)}}],t&&o(r.prototype,t),n&&o(r,n),r}(r.F)},"./src/events/chatevent.ts"(e,t,n){n.d(t,{b:()=>u});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(c=function(){return!!e})()}var u=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(e,t){var n,o;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return o=a(o=r),s(n=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,c()?Reflect.construct(o,[],a(this).constructor):o.apply(this,void 0)),"sender",void 0),s(n,"message",void 0),n.sender=e,n.message=t,n.type=i.B.CHAT,n}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&l(r,e),t=[{key:"applyToController",value:function(e){return e.handleChat(this)}}],n=[{key:"fromJson",value:function(e){return new r(e.sender,e.message)}}],t&&o(r.prototype,t),n&&o(r,n),r}(r.F)},"./src/events/eventtype.ts"(e,t,n){n.d(t,{B:()=>i});var r,i=((r={}).BEGIN="BEGIN",r.BREAK="BREAK",r.WATCHAIM="WATCHAIM",r.AIM="AIM",r.HIT="HIT",r.STATIONARY="STATIONARY",r.CHAT="CHAT",r.ABORT="ABORT",r.PLACEBALL="PLACEBALL",r.REJOIN="REJOIN",r.RERACK="RERACK",r.STARTAIM="STARTAIM",r.NOTIFICATION="NOTIFICATION",r.SCORE="SCORE",r)},"./src/events/eventutil.ts"(e,t,n){n.d(t,{d:()=>x});var r=n("./src/events/eventtype.ts"),i=n("./src/events/aimevent.ts"),o=n("./src/events/watchevent.ts"),s=n("./src/events/hitevent.ts"),a=n("./src/events/abortevent.ts"),l=n("./src/events/breakevent.ts"),c=n("./src/events/beginevent.ts"),u=n("./src/events/chatevent.ts");function h(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function p(e){return(p=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function v(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(v=function(){return!!e})()}var y=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function i(){var e,t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(!(this instanceof i))throw TypeError("Cannot call a class as a function");return e=p(e=i),f(t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,v()?Reflect.construct(e,[],p(this).constructor):e.apply(this,void 0)),"clientResendFrom",void 0),f(t,"serverResendFrom",void 0),t.type=r.B.REJOIN,t.clientResendFrom=n,t.serverResendFrom=o,t}return i.prototype=Object.create(e&&e.prototype,{constructor:{value:i,writable:!0,configurable:!0}}),e&&d(i,e),t=[{key:"applyToController",value:function(e){return e.handleRejoin(this)}}],n=[{key:"fromJson",value:function(e){return new i(e.clientResendFrom,e.serverResendFrom)}}],t&&h(i.prototype,t),n&&h(i,n),i}(n("./src/events/gameevent.ts").F),m=n("./src/events/placeballevent.ts"),b=n("./src/events/rerackevent.ts"),g=n("./src/events/startaimevent.ts"),w=n("./src/events/notificationevent.ts"),k=n("./src/events/scoreevent.ts"),x=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"serialise",value:function(e){return JSON.stringify(e)}},{key:"fromJson",value:function(e){switch(e.type){case r.B.BEGIN:return new c.u;case r.B.AIM:return i.w.fromJson(e);case r.B.BREAK:return l.W.fromJson(e);case r.B.WATCHAIM:return o.Q.fromJson(e.json);case r.B.HIT:return s.Q.fromJson(e);case r.B.CHAT:return u.b.fromJson(e);case r.B.REJOIN:return y.fromJson(e);case r.B.ABORT:return new a.h;case r.B.PLACEBALL:return m.z.fromJson(e);case r.B.RERACK:return b.x.fromJson(e);case r.B.STARTAIM:return g.M.fromJson(e);case r.B.NOTIFICATION:return w.c.fromJson(e);case r.B.SCORE:return k.P.fromJson(e);default:throw Error("Unknown GameEvent :"+e)}}},{key:"fromSerialised",value:function(e){var n=JSON.parse(e),r=t.fromJson(n);return"sequence"in n&&(r.sequence=n.sequence),"clientId"in n&&(r.clientId=n.clientId),"playername"in n&&(r.playername=n.playername),r}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/events/gameevent.ts"(e,t,n){function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,{F:()=>i});var i=function e(){if(!(this instanceof e))throw TypeError("Cannot call a class as a function");r(this,"type",void 0),r(this,"sequence",void 0),r(this,"clientId",void 0),r(this,"playername",void 0)}},"./src/events/hitevent.ts"(e,t,n){n.d(t,{Q:()=>c});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(e){var t,n,o,a;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return n=s(n=r),t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(n,[],s(this).constructor):n.apply(this,void 0)),a=void 0,(o="tablejson")in t?Object.defineProperty(t,o,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[o]=a,t.type=i.B.HIT,t.tablejson=e,t}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&a(r,e),t=[{key:"applyToController",value:function(e){return e.handleHit(this)}}],n=[{key:"fromJson",value:function(e){return new r(e.tablejson)}}],t&&o(r.prototype,t),n&&o(r,n),r}(r.F)},"./src/events/input.ts"(e,t,n){function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,{p:()=>i});var i=function e(t,n){if(!(this instanceof e))throw TypeError("Cannot call a class as a function");r(this,"t",void 0),r(this,"key",void 0),this.t=t,this.key=n}},"./src/events/keyboard.ts"(e,t,n){n.d(t,{s:()=>a});var r=n("./src/events/input.ts"),i=n("./node_modules/interactjs/dist/interact.min.js"),o=n.n(i);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e;function t(e){var n=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");s(this,"pressed",{}),s(this,"released",{}),s(this,"keydown",function(e){null==n.pressed[e.code]&&(n.pressed[e.code]=performance.now()),e.stopImmediatePropagation(),"F12"!==e.key&&e.preventDefault()}),s(this,"keyup",function(e){n.released[e.code]=performance.now()-n.pressed[e.code],delete n.pressed[e.code],e.stopImmediatePropagation(),"F12"!==e.key&&e.preventDefault()}),s(this,"mousetouch",function(e){var t,r,i=n.released,o=e.client.y<e.rect.height/2||e.ctrlKey?.5:1,s=e.dx*o,a=.8*e.dy;i.movementY=(null!=(t=i.movementY)?t:0)+a,i.movementX=(null!=(r=i.movementX)?r:0)+s,Math.abs(i.movementX)>Math.abs(i.movementY)&&(i.movementY=0)}),this.addHandlers(e),/Android|iPhone/i.test(navigator.userAgent)||(e.contentEditable="true")}return e=[{key:"getEvents",value:function(){var e=this,t=Object.keys(this.pressed).filter(function(e){return!/Shift/.test(e)}).filter(function(e){return!/Control/.test(e)}),n=Object.keys(this.pressed).some(function(e){return/Shift/.test(e)}),i=Object.keys(this.pressed).some(function(e){return/Control/.test(e)}),o=[];return t.forEach(function(t){var s=performance.now()-e.pressed[t];o.push(new r.p(i?s/3:s,n?"Shift"+t:t)),"Space"!=t&&(e.pressed[t]=performance.now())}),Object.keys(this.released).forEach(function(t){return o.push(new r.p(e.released[t],t+"Up"))}),this.released={},o}},{key:"addHandlers",value:function(e){var t=this;e.addEventListener("keydown",this.keydown),e.addEventListener("keyup",this.keyup),e.focus(),o()(e).draggable({listeners:{move:function(e){t.mousetouch(e)}}}),o()(e).gesturable({onmove:function(e){e.dx/=3,t.mousetouch(e)}})}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/events/notificationevent.ts"(e,t,n){n.d(t,{c:()=>u});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(c=function(){return!!e})()}var u=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(e,t){var n,o;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return o=a(o=r),s(n=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,c()?Reflect.construct(o,[],a(this).constructor):o.apply(this,void 0)),"data",void 0),s(n,"duration",void 0),n.data=e,n.duration=t,n.type=i.B.NOTIFICATION,n}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&l(r,e),t=[{key:"applyToController",value:function(e){return e.handleNotification(this)}}],n=[{key:"fromJson",value:function(e){return new r(e.data,e.duration)}}],t&&o(r.prototype,t),n&&o(r,n),r}(r.F)},"./src/events/placeballevent.ts"(e,t,n){n.d(t,{z:()=>h});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts"),o=n("./src/utils/utils.ts");function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(u=function(){return!!e})()}var h=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(e,t,n){var o,s;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return s=l(s=r),a(o=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,u()?Reflect.construct(s,[],l(this).constructor):s.apply(this,void 0)),"pos",void 0),a(o,"respot",void 0),a(o,"useStartPos",void 0),o.pos=e,o.respot=t,o.useStartPos=n,o.type=i.B.PLACEBALL,o}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&c(r,e),t=[{key:"applyToController",value:function(e){return e.handlePlaceBall(this)}}],n=[{key:"fromJson",value:function(e){var t,n=e.respot?{id:e.respot.id,pos:(0,o.t6)(e.respot.pos)}:void 0;return new r((0,o.t6)(e.pos),n,null!=(t=e.useStartPos)&&t)}}],t&&s(r.prototype,t),n&&s(r,n),r}(r.F)},"./src/events/rerackevent.ts"(e,t,n){n.d(t,{x:()=>c});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(){var e,t,n,o;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return t=s(t=r),e=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(t,[],s(this).constructor):t.apply(this,void 0)),o=void 0,(n="ballinfo")in e?Object.defineProperty(e,n,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[n]=o,e.type=i.B.RERACK,e}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&a(r,e),t=[{key:"applyToController",value:function(e){return r.applyBallinfoToTable(e.container.table,this.ballinfo),e}}],n=[{key:"fromJson",value:function(e){var t,n=new r;return n.ballinfo=null!=(t=e.ballinfo)?t:e,n}},{key:"applyBallinfoToTable",value:function(e,t){e.updateFromSerialised(t),(null==t?void 0:t.balls)&&t.balls.forEach(function(t){var n=e.balls[t.id];n&&(n.pos.copy(t.pos),n.setStationary())})}}],t&&o(r.prototype,t),n&&o(r,n),r}(r.F)},"./src/events/scoreevent.ts"(e,t,n){n.d(t,{P:()=>c});var r=n("./src/events/eventtype.ts");function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function c(e,t,n){var i,a;if(!(this instanceof c))throw TypeError("Cannot call a class as a function");return a=s(a=c),o(i=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(a,[],s(this).constructor):a.apply(this,void 0)),"p1",void 0),o(i,"p2",void 0),o(i,"b",void 0),i.p1=e,i.p2=t,i.b=n,i.type=r.B.SCORE,i}return c.prototype=Object.create(e&&e.prototype,{constructor:{value:c,writable:!0,configurable:!0}}),e&&a(c,e),t=[{key:"applyToController",value:function(e){return e.handleScore(this)}}],n=[{key:"fromJson",value:function(e){return new c(e.p1,e.p2,e.b)}}],t&&i(c.prototype,t),n&&i(c,n),c}(n("./src/events/gameevent.ts").F)},"./src/events/startaimevent.ts"(e,t,n){n.d(t,{M:()=>c});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(){var e,t,n,o,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return e=s(e=r),(n="foul")in(t=o=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(e,[],s(this).constructor):e.apply(this,void 0)))?Object.defineProperty(t,n,{value:0,enumerable:!0,configurable:!0,writable:!0}):t[n]=0,o.type=i.B.STARTAIM,o.foul=a,o}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&a(r,e),t=[{key:"applyToController",value:function(e){return e.handleStartAim(this)}}],n=[{key:"fromJson",value:function(e){return new r(e.foul)}}],t&&o(r.prototype,t),n&&o(r,n),r}(r.F)},"./src/events/stationaryevent.ts"(e,t,n){n.d(t,{T:()=>l});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function a(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(a=function(){return!!e})()}var l=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return t=o(t=n),(e=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,a()?Reflect.construct(t,[],o(this).constructor):t.apply(this,void 0))).type=i.B.STATIONARY,e}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&s(n,e),t=[{key:"applyToController",value:function(e){return e.handleStationary(this)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.F)},"./src/events/watchevent.ts"(e,t,n){n.d(t,{Q:()=>c});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(e){var t,n,o,a;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return n=s(n=r),t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(n,[],s(this).constructor):n.apply(this,void 0)),a=void 0,(o="json")in t?Object.defineProperty(t,o,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[o]=a,t.type=i.B.WATCHAIM,t.json=e,t}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&a(r,e),t=[{key:"applyToController",value:function(e){return e.handleWatch(this)}}],n=[{key:"fromJson",value:function(e){return new r(e)}}],t&&o(r.prototype,t),n&&o(r,n),r}(r.F)},"./src/model/ball.ts"(e,t,n){n.d(t,{c:()=>x,U:()=>k});var r,i,o,s,a,l=n("./src/utils/utils.ts"),c=n("./src/model/physics/physics.ts"),u=n("./node_modules/three/build/three.core.js"),h=n("./src/model/physics/constants.ts");function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var p=function(){var e;function t(e,n){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");f(this,"line",void 0),f(this,"geometry",void 0),f(this,"positions",void 0),f(this,"lastPos",new u.Pq0),f(this,"lastVel",new u.Pq0),this.geometry=new u.LoY,this.positions=new Float32Array(3*e),this.geometry.setAttribute("position",new u.THS(this.positions,3)),this.reset();var r=new u.mrM({color:n,opacity:.25,linewidth:3,transparent:!0});this.line=new u.N1A(this.geometry,r),this.line.visible=!1}return e=[{key:"reset",value:function(){this.geometry.setDrawRange(0,0),this.lastVel.setZ(1)}},{key:"forceTrace",value:function(e){this.lastVel.z=1,this.addTraceGiven(e,this.lastVel,1,.1,1)}},{key:"addTrace",value:function(e,t){if(0!==t.length()){var n=this.lastVel.angleTo(t),r=n>Math.PI/32?.01*h.R:h.R,i=this.lastPos.distanceTo(e);this.addTraceGiven(e,t,i,r,n)}}},{key:"addTraceGiven",value:function(e,t,n,r,i){var o=this.geometry.drawRange.count;0!==o&&n<r||(o>1&&i<1e-4&&o--,this.lastPos.copy(e),this.lastVel.copy(t),this.addPoint(e,o))}},{key:"addPoint",value:function(e,t){var n=3*t;n>this.positions.length||(this.positions[n++]=e.x,this.positions[n++]=e.y,this.positions[n]=e.z,this.geometry.setDrawRange(0,t+1),this.line.geometry.attributes.position.needsUpdate=!0)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),d=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"getOrCreateTexture",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:256,r="".concat(e,"_").concat(t.getHex(),"_").concat(n);if(this.textureCache.has(r))return this.textureCache.get(r);var i=this.createNumberTexture(e,t,n);return this.textureCache.set(r,i),i}},{key:"createNumberTexture",value:function(e,t,n){var r=n/256,i=document.createElement("canvas");i.width=n,i.height=n;var o=i.getContext("2d");if(!o)return new u.GOR(i);if(o.fillStyle="#".concat(t.getHexString()),o.fillRect(0,0,i.width,i.height),e>=9&&(o.fillStyle="white",o.fillRect(0,0,n,.2*n),o.fillRect(0,.8*n,n,.2*n)),e>0){var s=n/2,a=n/2,l=Math.round(52*r),c=Math.round(15*r);o.beginPath(),o.arc(s,a,l+c,0,2*Math.PI),o.fillStyle="black",o.fill(),o.beginPath(),o.arc(s,a,l,0,2*Math.PI),o.fillStyle="white",o.fill(),o.fillStyle="black",o.strokeStyle="black";var h=Math.round(97*r);o.lineWidth=.05*h,o.font="900 ".concat(h,'px "Arial Black", Arial, sans-serif'),o.textAlign="center",o.textBaseline="middle";var f=a+Math.round(5*r);o.strokeText(e.toString(),s,f),o.fillText(e.toString(),s,f)}var p=new u.GOR(i);return p.flipY=!1,p}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();r="textureCache",i=new Map,r in d?Object.defineProperty(d,r,{value:i,enumerable:!0,configurable:!0,writable:!0}):d[r]=i;var v=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"createDottedMaterial",value:function(e){var t="dotted_".concat(e.getHex());if(this.materialCache.has(t))return this.materialCache.get(t);var n=new u.tXL({emissive:0,flatShading:!0,vertexColors:!0,forceSinglePass:!0,shininess:25,specular:5592371});return this.materialCache.set(t,n),n}},{key:"createProjectedMaterial",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:256,r="projected_".concat(e,"_").concat(t.getHex(),"_").concat(n);if(this.materialCache.has(r))return this.materialCache.get(r);var i=d.getOrCreateTexture(e,t,n),o=new u._4j({color:t,roughness:.5,metalness:0,flatShading:!0});return o.onBeforeCompile=function(e){e.uniforms.numberTex={value:i},e.uniforms.projSize={value:2},e.vertexShader=e.vertexShader.replace("#include <common>",`#include <common>
          varying vec3 vLocalPosition;
          varying vec3 vNormalVar;`),e.vertexShader=e.vertexShader.replace("#include <begin_vertex>",`#include <begin_vertex>
          vLocalPosition = position;
          vNormalVar = normal;`),e.fragmentShader=e.fragmentShader.replace("#include <common>",`#include <common>
         uniform sampler2D numberTex;
@@ -31,11 +31,11 @@ Ball`),this.container.table.cue.aimInputs.setDisabled(!1),this.container.rules.a
          projUv = clamp(projUv, 0.0, 1.0);

          // sample & blend
          vec4 texColor = texture2D(numberTex, projUv);
          diffuseColor.rgb = texColor.rgb;
-        `))},this.materialCache.set(r,o),o}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();function y(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}o="materialCache",s=new Map,o in v?Object.defineProperty(v,o,{value:s,enumerable:!0,configurable:!0,writable:!0}):v[o]=s;var b=function(){var e,t;function n(e,t){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");m(this,"mesh",void 0),m(this,"shadow",void 0),m(this,"spinAxisArrow",void 0),m(this,"trace",void 0),m(this,"color",void 0),m(this,"m",new u.kn4),this.color=new u.Q1f(e),this.initialiseMesh(this.color,t)}return e=[{key:"updateAll",value:function(e,t){this.updatePosition(e.pos),this.updateArrows(e.pos,e.rvel,e.state),0!==e.rvel.lengthSq()&&(this.updateRotation(e.rvel,t),this.trace.addTrace(e.pos,e.vel))}},{key:"updatePosition",value:function(e){this.mesh.position.copy(e),this.shadow.position.copy(e)}},{key:"updateRotation",value:function(e,t){var n=e.length()*t;this.mesh.rotateOnWorldAxis((0,l.xb)(e),n)}},{key:"updateArrows",value:function(e,t,n){this.spinAxisArrow.setLength(h.R+h.R*t.length()/2,h.R,h.R),this.spinAxisArrow.position.copy(e),this.spinAxisArrow.setDirection((0,l.xb)(t)),n==k.Rolling?this.spinAxisArrow.setColor(0xcc0000):this.spinAxisArrow.setColor(52224)}},{key:"initialiseMesh",value:function(e,t){if(void 0===t){var r,i,o=e.getHex(),s=n._dottedGeometryCache.get(o);s||(s=new u.WBB(h.R,1),n.addDots(s,e),n._dottedGeometryCache.set(o,s)),r=s,i=v.createDottedMaterial(e)}else r=n.getBallGeometry(),i=v.createProjectedMaterial(t,e);this.mesh=new u.eaF(r,i),this.mesh.name="ball",this.updateRotation(new u.Pq0().random(),100),this.shadow=new u.eaF(n.getShadowGeometry(),n.getShadowMaterial()),this.spinAxisArrow=new u.E0M(l.up,l.v_,2,0,.01,.01),this.spinAxisArrow.visible=!1,this.trace=new p(500,e)}},{key:"addToScene",value:function(e){e.add(this.mesh),e.add(this.shadow),e.add(this.spinAxisArrow),e.add(this.trace.line)}}],t=[{key:"getBallGeometry",value:function(){return this._ballGeometry||(this._ballGeometry=new u.WBB(h.R,1)),this._ballGeometry}},{key:"getShadowGeometry",value:function(){return this._shadowGeometry||(this._shadowGeometry=new u.tcD(.9*h.R,9),this._shadowGeometry.applyMatrix4(new u.kn4().makeTranslation(0,0,-(.99*h.R)))),this._shadowGeometry}},{key:"getShadowMaterial",value:function(){return this._shadowMaterial||(this._shadowMaterial=new u.V9B({color:1118498})),this._shadowMaterial}},{key:"addDots",value:function(e,t){var r=e.attributes.position.count,i=new u.Q1f(t);e.setAttribute("color",new u.THS(new Float32Array(3*r),3));for(var o=e.attributes.color,s=0;s<r/3;s++)n.colorVerticesForFace(s,o,n.scaleNoise(i.r),n.scaleNoise(i.g),n.scaleNoise(i.b));var a=new u.Q1f(0xaa2222);[0,96,111,156,186,195].forEach(function(e){n.colorVerticesForFace(e/3,o,a.r,a.g,a.b)})}},{key:"colorVerticesForFace",value:function(e,t,n,r,i){t.setXYZ(3*e+0,n,r,i),t.setXYZ(3*e+1,n,r,i),t.setXYZ(3*e+2,n,r,i)}},{key:"scaleNoise",value:function(e){return(1-.25*Math.random())*e}}],e&&y(n.prototype,e),t&&y(n,t),n}();function g(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function w(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}m(b,"_ballGeometry",void 0),m(b,"_shadowGeometry",void 0),m(b,"_shadowMaterial",void 0),m(b,"_dottedGeometryCache",new Map);var k=((a={}).Stationary="Stationary",a.Rolling="Rolling",a.Sliding="Sliding",a.Falling="Falling",a.InPocket="InPocket",a),x=function(){var e,t;function n(e,t,r){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");w(this,"pos",void 0),w(this,"vel",l.v_.clone()),w(this,"rvel",l.v_.clone()),w(this,"futurePos",l.v_.clone()),w(this,"ballmesh",void 0),w(this,"state","Stationary"),w(this,"pocket",void 0),w(this,"id",n.id++),w(this,"label",void 0),this.pos=e.clone(),this.label=r,this.ballmesh=new b(t||0xeeeeee*Math.random(),r)}return e=[{key:"update",value:function(e){this.updatePosition(e),"Falling"==this.state?this.pocket.updateFall(this,e):this.updateVelocity(e)}},{key:"updateMesh",value:function(e){this.ballmesh.updateAll(this,e)}},{key:"updatePosition",value:function(e){this.pos.addScaledVector(this.vel,e)}},{key:"updateVelocity",value:function(e){this.inMotion()&&(this.isRolling()?(this.state="Rolling",(0,c.lx)(this.vel,this.rvel),this.addDelta(e,(0,c.JD)(this.rvel))):(this.state="Sliding",this.addDelta(e,(0,c.p2)(this.vel,this.rvel))))}},{key:"addDelta",value:function(e,t){t.v.multiplyScalar(e),t.w.multiplyScalar(e),this.passesZero(t)||(this.vel.add(t.v),this.rvel.add(t.w))}},{key:"passesZero",value:function(e){var t=(0,l.rq)(this.vel,e.v),n=(0,l.rq)(this.rvel,e.w);return!!(("Rolling"===this.state?t||n:t&&n)&&.01>Math.abs(this.rvel.z))&&(this.setStationary(),!0)}},{key:"setStationary",value:function(){this.vel.copy(l.v_),this.rvel.copy(l.v_),this.state="Stationary"}},{key:"isRolling",value:function(){return 0!==this.vel.lengthSq()&&0!==this.rvel.lengthSq()&&(0,c.Mq)(this.vel,this.rvel).length()<n.transition}},{key:"onTable",value:function(){return"Falling"!==this.state&&"InPocket"!==this.state}},{key:"inMotion",value:function(){return"Rolling"===this.state||"Sliding"===this.state||this.isFalling()}},{key:"isFalling",value:function(){return"Falling"===this.state}},{key:"futurePosition",value:function(e){return this.futurePos.copy(this.pos).addScaledVector(this.vel,e),this.futurePos}},{key:"fround",value:function(){this.pos.x=Math.fround(this.pos.x),this.pos.y=Math.fround(this.pos.y),this.vel.x=Math.fround(this.vel.x),this.vel.y=Math.fround(this.vel.y),this.rvel.x=Math.fround(this.rvel.x),this.rvel.y=Math.fround(this.rvel.y),this.rvel.z=Math.fround(this.rvel.z)}},{key:"serialise",value:function(){return{pos:this.pos.clone(),id:this.id}}}],t=[{key:"fromSerialised",value:function(e){return n.updateFromSerialised(new n((0,l.t6)(e.pos)),e)}},{key:"updateFromSerialised",value:function(e,t){var n,r;return e.pos.copy(t.pos),e.vel.copy(null!=(n=null==t?void 0:t.vel)?n:l.v_),e.rvel.copy(null!=(r=null==t?void 0:t.rvel)?r:l.v_),e}}],e&&g(n.prototype,e),t&&g(n,t),n}();w(x,"id",0),w(x,"transition",.05)},"./src/model/outcome.ts"(e,t,n){n.d(t,{$:()=>o,P:()=>s});function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var i,o=((i={}).Pot="Pot",i.Cushion="Cushion",i.Collision="Collision",i.Hit="Hit",i),s=function(){var e;function t(e,n,i,o){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");r(this,"type",void 0),r(this,"timestamp",void 0),r(this,"ballA",null),r(this,"ballB",null),r(this,"incidentSpeed",void 0),this.type=e,this.ballA=n,this.ballB=i,this.incidentSpeed=o,this.timestamp=Date.now()}return e=[{key:"pot",value:function(e,n){return new t("Pot",e,e,n)}},{key:"cushion",value:function(e,n){return new t("Cushion",e,e,n)}},{key:"collision",value:function(e,n,r){return new t("Collision",e,n,r)}},{key:"hit",value:function(e,n){return new t("Hit",e,e,n)}},{key:"isCueBallPotted",value:function(e,t){return t.some(function(t){return"Pot"==t.type&&t.ballA===e})}},{key:"isBallPottedNoFoul",value:function(e,n){return n.some(function(e){return"Pot"==e.type&&null!==e.ballA})&&!t.isCueBallPotted(e,n)}},{key:"pots",value:function(e){return e.filter(function(e){return"Pot"==e.type}).map(function(e){return e.ballA})}},{key:"potCount",value:function(e){return this.pots(e).length}},{key:"onlyRedsPotted",value:function(e){return this.pots(e).every(function(e){return e.id>6})}},{key:"firstCollision",value:function(e){var t=e.filter(function(e){return"Collision"===e.type});return t.length>0?t[0]:void 0}},{key:"isClearTable",value:function(e){var t=e.balls.filter(function(e){return e.onTable()});return 1===t.length&&t[0]===e.cueball}},{key:"isThreeCushionPoint",value:function(e,n){n=t.cueBallFirst(e,n).filter(function(t){return t.ballA===e});var r=new Set,i=0,o=!0,s=!1,a=void 0;try{for(var l,c=n[Symbol.iterator]();!(o=(l=c.next()).done);o=!0){var u=l.value;if("Cushion"===u.type&&i++,"Collision"===u.type&&(r.add(u.ballB),2===r.size))return i>=3}}catch(e){s=!0,a=e}finally{try{o||null==c.return||c.return()}finally{if(s)throw a}}return!1}},{key:"cueBallFirst",value:function(e,t){return t.forEach(function(t){"Collision"===t.type&&t.ballB===e&&(t.ballB=t.ballA,t.ballA=e)}),t}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/model/physics/collision.ts"(e,t,n){n.d(t,{F:()=>h});var r,i,o=n("./src/model/ball.ts"),s=n("./node_modules/three/build/three.core.js"),a=n("./src/model/physics/constants.ts"),l=n("./src/utils/utils.ts");function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var u=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");c(this,"normalImpulse",void 0),c(this,"tangentialImpulse",void 0)}return e=[{key:"dynamicFriction",value:function(e){return .01+.108*(0,l.oN)(-1.088*e)}},{key:"updateVelocities",value:function(e,t){var n=h.positionsAtContact(e,t);e.ballmesh.trace.forceTrace(n.a),t.ballmesh.trace.forceTrace(n.b);var r=n.b.sub(n.a).normalize(),i=new s.Pq0(-r.y,r.x,0),o=e.vel.clone().sub(t.vel).add(r.clone().multiplyScalar(-a.R).cross(e.rvel).sub(r.clone().multiplyScalar(a.R).cross(t.rvel))),l=r.dot(o),c=o.addScaledVector(r,-l),u=c.length(),f=i.dot(c),p=this.dynamicFriction(u);this.normalImpulse=-1.99*l/(2/a.m),this.tangentialImpulse=-(.25*Math.min(p*Math.abs(this.normalImpulse)/u,1/7)*f);var d=r.clone().multiplyScalar(this.normalImpulse),v=i.clone().multiplyScalar(this.tangentialImpulse);e.vel.addScaledVector(d,1/a.m).addScaledVector(v,1/a.m),t.vel.addScaledVector(d,-1/a.m).addScaledVector(v,-1/a.m);var y=r.clone().multiplyScalar(-a.R).cross(v),m=r.clone().multiplyScalar(a.R).cross(v);return e.rvel.addScaledVector(y,1/a.I),t.rvel.addScaledVector(m,1/a.I),l}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),h=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"willCollide",value:function(e,t,n){return(e.inMotion()||t.inMotion())&&e.onTable()&&t.onTable()&&e.futurePosition(n).distanceToSquared(t.futurePosition(n))<4*a.R*a.R}},{key:"collide",value:function(e,n){return t.updateVelocities(e,n)}},{key:"positionsAtContact",value:function(e,t){var n=e.pos.distanceTo(t.pos),r=e.vel.clone().sub(t.vel),i=(n-2*a.R)/r.length()||0;return{a:e.pos.clone().addScaledVector(e.vel,i),b:t.pos.clone().addScaledVector(t.vel,i)}}},{key:"updateVelocities",value:function(e,n){var r=t.model.updateVelocities(e,n);return e.state=o.U.Sliding,n.state=o.U.Sliding,r}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();r="model",i=new u,r in h?Object.defineProperty(h,r,{value:i,enumerable:!0,configurable:!0,writable:!0}):h[r]=i},"./src/model/physics/constants.ts"(e,t,n){n.d(t,{I:()=>o,Mz:()=>r,PX:()=>A,Qg:()=>k,R:()=>f,Wv:()=>T,Ys:()=>P,Z3:()=>m,_m:()=>y,cM:()=>S,e:()=>p,ee:()=>d,g:()=>s,gT:()=>c,gf:()=>l,jG:()=>w,kL:()=>u,kM:()=>O,ki:()=>E,ko:()=>R,m:()=>h,mu:()=>a,o5:()=>b,oV:()=>v,x3:()=>i,xO:()=>x});var r,i,o,s=9.8,a=.00985,l=.16,c=.85,u=.034,h=.23,f=.03275,p=.86,d=.98,v=.212,y=.14,m=.4,b=Math.sqrt(21)/5;function g(){r=a*h*s*2/3*u,i=7/(5*Math.sqrt(2))*f*a*h*s,o=.4*h*f*f}function w(e){f=e,g()}function k(e){h=e,g()}function x(e){a=e,g()}function T(e){u=e,g()}function P(e){l=e}function S(e){p=e}function O(e){c=e}function R(e){v=e}function E(e){y=e}function A(e){d=e}g()},"./src/model/physics/knuckle.ts"(e,t,n){n.d(t,{O:()=>a});var r=n("./src/model/physics/constants.ts"),i=n("./src/view/pocketgeometry.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e,t;function n(e,t){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");s(this,"pos",void 0),s(this,"radius",void 0),this.pos=e,this.radius=t}return e=[{key:"bounce",value:function(e){var t=e.pos.clone().sub(this.pos).normalize(),n=t.dot(e.vel);return e.vel.addScaledVector(t,-2*r.e*n),e.rvel.multiplyScalar(.5),Math.abs(n)}}],t=[{key:"willBounce",value:function(e,t){return t.distanceTo(e.pos)<r.R+e.radius}},{key:"findBouncing",value:function(e,t){var r=e.futurePosition(t);return i.f.knuckles.find(function(e){return n.willBounce(e,r)})}}],e&&o(n.prototype,e),t&&o(n,t),n}()},"./src/model/physics/mathaven.ts"(e,t,n){n.d(t,{z:()=>s});var r=n("./src/utils/utils.ts"),i=n("./src/model/physics/constants.ts");function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var s=function(){var e;function t(e,n,r,i,s){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");o(this,"P",0),o(this,"WzI",0),o(this,"vx",void 0),o(this,"vy",void 0),o(this,"Ï‰x",void 0),o(this,"Ï‰y",void 0),o(this,"Ï‰z",void 0),o(this,"s",void 0),o(this,"Ï†",void 0),o(this,"sÊ¹",void 0),o(this,"Ï†Ê¹",void 0),o(this,"i",0),o(this,"N",100),o(this,"M",void 0),o(this,"R",void 0),o(this,"Î¼s",void 0),o(this,"Î¼w",void 0),o(this,"ee",void 0),this.M=e,this.R=n,this.ee=r,this.Î¼s=i,this.Î¼w=s}return e=[{key:"updateSlipSpeedsAndAngles",value:function(){var e=this.R,t=this.vx+this.Ï‰y*e*i.Z3-this.Ï‰z*e*i.o5,n=-this.vy*i.Z3+this.Ï‰x*e,o=this.vx-this.Ï‰y*e,s=this.vy+this.Ï‰x*e;this.s=(0,r.RZ)((0,r.n7)(t,2)+(0,r.n7)(n,2)),this.Ï†=(0,r.FP)(n,t),this.Ï†<0&&(this.Ï†+=2*Math.PI),this.sÊ¹=(0,r.RZ)((0,r.n7)(o,2)+(0,r.n7)(s,2)),this.Ï†Ê¹=(0,r.FP)(s,o),this.Ï†Ê¹<0&&(this.Ï†Ê¹+=2*Math.PI)}},{key:"compressionPhase",value:function(){for(var e=Math.max(this.M*this.vy/this.N,.001);this.vy>0;)this.updateSingleStep(e)}},{key:"restitutionPhase",value:function(e){var t=Math.max(e/this.N,.001);for(this.WzI=0;this.WzI<e;)this.updateSingleStep(t)}},{key:"updateSingleStep",value:function(e){if(this.updateSlipSpeedsAndAngles(),this.updateVelocity(e),this.updateAngularVelocity(e),this.updateWorkDone(e),this.i++>10*this.N)throw Error("Solution not found")}},{key:"updateVelocity",value:function(e){var t=this.Î¼s,n=this.Î¼w,o=this.M;this.vx-=1/o*(n*(0,r.gn)(this.Ï†)+t*(0,r.gn)(this.Ï†Ê¹)*(i.Z3+n*(0,r.F8)(this.Ï†)*i.o5))*e,this.vy-=1/o*(i.o5-n*i.Z3*(0,r.F8)(this.Ï†)+t*(0,r.F8)(this.Ï†Ê¹)*(i.Z3+n*(0,r.F8)(this.Ï†)*i.o5))*e}},{key:"updateAngularVelocity",value:function(e){var t=this.Î¼s,n=this.Î¼w,o=this.M,s=this.R;this.Ï‰x+=-(5/(2*o*s))*(n*(0,r.F8)(this.Ï†)+t*(0,r.F8)(this.Ï†Ê¹)*(i.Z3+n*(0,r.F8)(this.Ï†)*i.o5))*e,this.Ï‰y+=-(5/(2*o*s))*(n*(0,r.gn)(this.Ï†)*i.Z3-t*(0,r.gn)(this.Ï†Ê¹)*(i.Z3+n*(0,r.F8)(this.Ï†)*i.o5))*e,this.Ï‰z+=5/(2*o*s)*(n*(0,r.gn)(this.Ï†)*i.o5)*e}},{key:"updateWorkDone",value:function(e){var t=e*Math.abs(this.vy);this.WzI+=t,this.P+=e}},{key:"solvePaper",value:function(e,t,n,i){this.solve(e*(0,r.gn)(t),e*(0,r.F8)(t),-i*(0,r.F8)(t),i*(0,r.gn)(t),n)}},{key:"solve",value:function(e,t,n,r,i){this.vx=e,this.vy=t,this.Ï‰x=n,this.Ï‰y=r,this.Ï‰z=i,this.WzI=0,this.P=0,this.i=0,this.compressionPhase();var o=this.ee*this.ee*this.WzI;this.restitutionPhase(o)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/model/physics/physics.ts"(e,t,n){n.d(t,{$8:()=>O,Gp:()=>w,JD:()=>h,Mq:()=>l,QK:()=>p,QV:()=>S,Qy:()=>A,Un:()=>g,c0:()=>b,lx:()=>f,p2:()=>u,s0:()=>m,t6:()=>_,yO:()=>k});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/utils/utils.ts"),o=n("./src/model/physics/constants.ts"),s=n("./src/model/physics/mathaven.ts"),a=new r.Pq0;function l(e,t){return a.copy(e).addScaledVector((0,i.KM)(t),o.R)}var c={v:new r.Pq0,w:new r.Pq0};function u(e,t){var n=l(e,t).setZ(0);return c.v.copy((0,i.xb)(n).multiplyScalar(-o.gf*o.g)),c.w.copy((0,i.xb)((0,i.KM)(n)).multiplyScalar(2.5*o.gf*o.g/o.R)),c.w.setZ(-2.5*(o.Mz/(o.m*o.R*o.R))*Math.sign(t.z)),c}function h(e){var t=new r.Pq0(e.x,e.y,0).length(),n=5/7*o.x3/(o.m*o.R)/t,i=5/7*o.x3/(o.m*o.R*o.R)/t;return c.v.set(-n*e.y,n*e.x,0),c.w.set(-i*e.x,-i*e.y,-2.5*(o.Mz/(o.m*o.R*o.R))*Math.sign(e.z)),c}function f(e,t){var n=t.z;t.copy((0,i.KM)(e).multiplyScalar(1/o.R)),t.setZ(n)}function p(e,t,n,r){var o=r(t.clone().applyAxisAngle(i.up,e),n.clone().applyAxisAngle(i.up,e));return o.v.applyAxisAngle(i.up,-e),o.w.applyAxisAngle(i.up,-e),o}Object.freeze(c);var d=Math.asin(.1*o.R/o.R),v=(0,i.F8)(d),y=(0,i.gn)(d);function m(e,t){return new r.Pq0(e.x*v-e.z*y+o.R*t.y,-e.y-o.R*t.z*y+o.R*t.x*v)}function b(e){return e.x*y}function g(e){var t=3.5/o.m;return e.length()/t}function w(e){var t,n=1/o.m,i=.39+.257*(t=new r.Pq0(e/y,0,0)).x-.044*t.x*t.x;return o.gT*((1+i)*e)/n}function k(e,t){var n=w(b(e));return g(m(e,t))<=n}function x(e,t){return{c:b(e),s:m(e,t),A:3.5/o.m,B:1/o.m}}function T(e,t){var n=x(e,t),r=n.c,i=n.s,s=n.A,a=n.B,l=(1+o.e)*(r/a);return R(-i.x/s*v-l*y,i.y/s,i.x/s*y-l*v)}function P(e,t){var n,r=x(e,t),i=r.c,s=r.B,a=(1+o.e)*(i/s),l=.471-.241*Math.atan2(Math.abs((n=e).y),n.x),c=Math.atan2(e.y,e.x),u=Math.cos(c);return R(-l*a*u*y-a*y,l*a*Math.sin(c),l*a*u*y-a*v)}function S(e,t){return k(e,t)?T(e,t):P(e,t)}function O(e,t){var n=T(e,t),r=P(e,t),i=Math.sign(e.y)===Math.sign(t.z)?Math.cos(Math.atan2(e.y,e.x)):1;return{v:r.v.lerp(n.v,i),w:r.w.lerp(n.w,i)}}function R(e,t,n){return{v:new r.Pq0(e/o.m,t/o.m),w:new r.Pq0(-o.R/o.I*t*v,o.R/o.I*(e*v-n*y),o.R/o.I*t*y)}}function E(e,t){var n=new s.z(o.m,o.R,o.ee,o.oV,o._m+.1);n.solve(e.x,e.y,t.x,t.y,t.z);var i=new r.Pq0(n.vx,n.vy,0),a=new r.Pq0(n.Ï‰x,n.Ï‰y,n.Ï‰z);return{v:i.sub(e),w:a.sub(t)}}function A(e,t){return p(Math.PI/2,e,t,E)}function _(e,t){var n=Math.atan2(-e.x,e.y),r=2.5*t.length()*(e.length()*o.R)/(o.R*o.R),s=t.clone().normalize();return(0,i.KM)(s).applyAxisAngle(s,n).multiplyScalar(r)}},"./src/model/physics/pocket.ts"(e,t,n){n.d(t,{Z:()=>l});var r=n("./src/model/ball.ts"),i=n("./src/model/physics/constants.ts"),o=n("./src/utils/utils.ts");function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var l=function(){var e,t;function n(e,t){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");a(this,"pos",void 0),a(this,"radius",void 0),this.pos=e,this.radius=t}return e=[{key:"fall",value:function(e,t){return e.vel.z=-i.g*t,e.state=r.U.Falling,e.pocket=this,e.vel.length()}},{key:"updateFall",value:function(e,t){e.vel.addScaledVector(o.up,-(10*i.R)*t*i.g);var n=e.pos.z;if(e.pos.clone().setZ(0).distanceTo(this.pos)>this.radius-i.R){var s=this.pos.clone().sub(e.pos).normalize().setZ(0);n>-i.R/2&&(e.vel.addScaledVector(s,7*i.R*t*i.g),e.rvel.addScaledVector((0,o.KM)(s),7*t*i.g)),0>e.vel.dot(s)&&(e.ballmesh.trace.forceTrace(e.pos),e.vel.x=s.x*e.vel.length()/2,e.vel.y=s.y*e.vel.length()/2)}var a=this.restingDepth(e);n<a&&0!==e.rvel.length()&&(e.pos.z=a,e.vel.z=-i.R/10,e.rvel.copy(o.v_)),n<a-i.R&&(e.pos.z=a-i.R,e.setStationary(),e.state=r.U.InPocket)}},{key:"restingDepth",value:function(e){return -3*i.R-i.R*e.id/4}}],t=[{key:"willFall",value:function(e,t){return t.distanceTo(e.pos)<e.radius}},{key:"findPocket",value:function(e,t,r){var i=t.futurePosition(r);return e.find(function(e){return n.willFall(e,i)})}}],e&&s(n.prototype,e),t&&s(n,t),n}()},"./src/model/table.ts"(e,t,n){n.d(t,{X:()=>b});var r=n("./src/view/tablegeometry.ts"),i=n("./src/model/physics/physics.ts"),o=n("./src/view/pocketgeometry.ts"),s=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"bounceAny",value:function(e,n){var o=!(arguments.length>2)||void 0===arguments[2]||arguments[2],s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:i.$8,a=e.futurePosition(n);if(t.willBounceLong(a,o)){var l=a.y>r.P.tableY?-Math.PI/2:Math.PI/2;return t.bounceIn(l,e,s)}if(t.willBounceShort(a,o)){var c=a.x>r.P.tableX?0:Math.PI;return t.bounceIn(c,e,s)}}},{key:"willBounceShort",value:function(e,n){return n?t.willBounceShortSegment(o.f.pockets.pocketNW.knuckleSW.pos.y,o.f.pockets.pocketSW.knuckleNW.pos.y,e):t.willBounceShortSegment(r.P.Y,-r.P.Y,e)}},{key:"willBounceLong",value:function(e,n){return n?t.willBounceLongSegment(o.f.pockets.pocketNW.knuckleNE.pos.x,o.f.pockets.pocketN.knuckleNW.pos.x,e)||t.willBounceLongSegment(o.f.pockets.pocketN.knuckleNE.pos.x,o.f.pockets.pocketNE.knuckleNW.pos.x,e):t.willBounceLongSegment(-r.P.X,r.P.X,e)}},{key:"willBounceLongSegment",value:function(e,t,n){return n.x>e&&n.x<t&&Math.abs(n.y)>r.P.tableY}},{key:"willBounceShortSegment",value:function(e,t,n){return n.y>t&&n.y<e&&Math.abs(n.x)>r.P.tableX}},{key:"bounceIn",value:function(e,t,n){t.ballmesh.trace.forceTrace(t.futurePos);var r=(0,i.QK)(e,t.vel,t.rvel,n);return t.vel.add(r.v),t.rvel.add(r.w),r.v.length()}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}(),a=n("./src/model/physics/collision.ts"),l=n("./src/model/physics/knuckle.ts"),c=n("./src/model/physics/pocket.ts"),u=n("./src/view/cue.ts"),h=n("./src/model/ball.ts"),f=n("./src/events/aimevent.ts"),p=n("./src/model/outcome.ts"),d=n("./src/utils/utils.ts"),v=n("./src/model/physics/constants.ts");function y(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var b=function(){var e,t;function n(e){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");m(this,"balls",void 0),m(this,"cue",new u.s),m(this,"pairs",void 0),m(this,"outcome",[]),m(this,"cueball",void 0),m(this,"cushionModel",i.$8),m(this,"mesh",void 0),this.cueball=e[0],this.initialiseBalls(e)}return e=[{key:"initialiseBalls",value:function(e){this.balls=e,this.pairs=[];for(var t=0;t<e.length;t++)for(var n=0;n<e.length;n++)t<n&&this.pairs.push({a:e[t],b:e[n]})}},{key:"updateBallMesh",value:function(e){this.balls.forEach(function(t){t.updateMesh(e)})}},{key:"advance",value:function(e){for(var t=0;!this.prepareAdvanceAll(e);)if(t++>100)throw Error("Depth exceeded resolving collisions");this.balls.forEach(function(t){t.update(e),t.fround()})}},{key:"prepareAdvanceAll",value:function(e){var t=this;return this.pairs.every(function(n){return t.prepareAdvancePair(n.a,n.b,e)})&&this.balls.every(function(n){return t.prepareAdvanceToCushions(n,e)})}},{key:"prepareAdvancePair",value:function(e,t,n){if(a.F.willCollide(e,t,n)){var r=a.F.collide(e,t);return this.outcome.push(p.P.collision(e,t,r)),!1}return!0}},{key:"prepareAdvanceToCushions",value:function(e,t){if(!e.onTable())return!0;var n=e.futurePosition(t);if(Math.abs(n.y)<r.P.tableY&&Math.abs(n.x)<r.P.tableX)return!0;var i=s.bounceAny(e,t,r.P.hasPockets,this.cushionModel);if(i)return this.outcome.push(p.P.cushion(e,i)),!1;var a=l.O.findBouncing(e,t);if(a){var u=a.bounce(e);return this.outcome.push(p.P.cushion(e,u)),!1}var h=c.Z.findPocket(o.f.pocketCenters,e,t);if(h){var f=h.fall(e,t);return this.outcome.push(p.P.pot(e,f)),!1}return!0}},{key:"allStationary",value:function(){return this.balls.every(function(e){return!e.inMotion()})}},{key:"inPockets",value:function(){return this.balls.reduce(function(e,t){return t.onTable()?e:e+1},0)}},{key:"hit",value:function(){this.cue.hit(this.cueball),this.balls.forEach(function(e){e.ballmesh.trace.reset()})}},{key:"serialise",value:function(){return{balls:this.balls.map(function(e){return e.serialise()}),aim:this.cue.aim.copy()}}},{key:"updateFromSerialised",value:function(e){var t=this;e.balls&&e.balls.forEach(function(e){return h.c.updateFromSerialised(t.balls[e.id],e)}),e.aim&&(this.cue.aim=f.w.fromJson(e.aim))}},{key:"shortSerialise",value:function(){return this.balls.map(function(e){return[e.pos.x,e.pos.y]}).reduce(function(e,t){return e.concat(t)},[])}},{key:"updateFromShortSerialised",value:function(e){this.balls.forEach(function(t,n){t.pos.x=e[2*n],t.pos.y=e[2*n+1],t.pos.z=0,t.vel.copy(d.v_),t.rvel.copy(d.v_),t.state=h.U.Stationary})}},{key:"addToScene",value:function(e){this.balls.forEach(function(t){t.ballmesh.addToScene(e)}),e.add(this.cue.mesh),e.add(this.cue.helperMesh),e.add(this.cue.placerMesh)}},{key:"showTraces",value:function(e){this.balls.forEach(function(t){t.ballmesh.trace.line.visible=e,t.ballmesh.trace.reset()})}},{key:"showSpin",value:function(e){this.balls.forEach(function(t){t.ballmesh.spinAxisArrow.visible=e})}},{key:"halt",value:function(){this.balls.forEach(function(e){e.vel.copy(d.v_),e.rvel.copy(d.v_),e.state=h.U.Stationary})}},{key:"roundCueBallPosition",value:function(){var e=this.cueball.pos.clone();this.overlapsAny(e)||this.cueball.pos.copy(e)}},{key:"overlapsAny",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.cueball;return this.balls.filter(function(e){return e!==t}).some(function(t){return t.pos.distanceTo(e)<2*v.R})}}],t=[{key:"fromSerialised",value:function(e){var t=new n(e.balls.map(function(e){return h.c.fromSerialised(e)}));return t.updateFromSerialised(e),t}}],e&&y(n.prototype,e),t&&y(n,t),n}()},"./src/network/client/matchresult.ts"(e,t,n){n.d(t,{n:()=>l});var r=n("./src/events/chatevent.ts"),i=n("./src/events/notificationevent.ts"),o=n("./src/controller/end.ts"),s=n("./src/network/client/session.ts"),a=n("./src/utils/gameover.ts"),l=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"presentGameEnd",value:function(e,t){e.eventQueue.push(new r.b(null,"game over")),e.recorder.wholeGameLink();var n=s.N.hasInstance()?s.N.getInstance():null,i=s.N.playerIndex(),a=(e.scores[0]>=e.scores[1]?0:1)===i,l=this.getScoreSubtext(e,n,i);a?(this.notifyWin(e,l),this.sendLossNotification(e)):s.N.isSpectator()?this.notifySpectator(e,l):this.notifyLoss(e,l);var c=this.createMatchResult(e,t,n,i);return new o.o(e,a?c:void 0)}},{key:"notifyWin",value:function(e,t){e.notifyLocal({type:"GameOver",title:"YOU WON",subtext:t,icon:"ðŸ†",extraClass:"is-winner",extra:a.c.forMode(e.isSinglePlayer),duration:0})}},{key:"notifyLoss",value:function(e,t){e.notifyLocal({type:"GameOver",title:"YOU LOST",subtext:t,icon:"ðŸ¥ˆ",extraClass:"is-loser",extra:a.c.forMode(e.isSinglePlayer),duration:0})}},{key:"notifySpectator",value:function(e,t){e.notifyLocal({type:"GameOver",title:"GAME OVER",subtext:t,icon:"ðŸ†",extraClass:"",extra:a.c.lobby,duration:0})}},{key:"sendLossNotification",value:function(e){e.isSinglePlayer||e.sendEvent(new i.c({type:"GameOver",title:"YOU LOST",icon:"ðŸ¥ˆ",extraClass:"is-loser",extra:a.c.forMode(!1),duration:0}))}},{key:"getScoreSubtext",value:function(e,t,n){if(e.isSinglePlayer)return"Score: ".concat(e.scores[n]);var r=0===n?(null==t?void 0:t.playername)||"You":(null==t?void 0:t.opponentName)||"Opponent",i=1===n?(null==t?void 0:t.playername)||"You":(null==t?void 0:t.opponentName)||"Opponent";return"".concat(r," ").concat(e.scores[0]," - ").concat(e.scores[1]," ").concat(i)}},{key:"createMatchResult",value:function(e,t,n,r){var i=e.scores[0]>=e.scores[1]?0:1,o=1-i,s=i===r?(null==n?void 0:n.playername)||"Anon":(null==n?void 0:n.opponentName)||"Opponent",a=o===r?(null==n?void 0:n.playername)||"Anon":(null==n?void 0:n.opponentName)||"Opponent",l={winner:s,winnerScore:e.scores[i],ruleType:t};return(null==n?void 0:n.opponentName)&&(l.loser=a,l.loserScore=e.scores[o]),l}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/network/client/nchanmessagerelay.ts"(e,t,n){function r(e,t,n,r,i,o,s){try{var a=e[o](s),l=a.value}catch(e){n(e);return}a.done?t(l):Promise.resolve(l).then(r,i)}n.d(t,{p:()=>o});function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var o=function(){var e;function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"billiards-network.onrender.com";if(!(this instanceof t))throw TypeError("Cannot call a class as a function");i(this,"baseURL",void 0),i(this,"websockets",void 0),this.baseURL=e,this.websockets=new Map}return e=[{key:"subscribe",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"table",r="wss://".concat(this.baseURL,"/subscribe/").concat(n,"/").concat(e),i=new WebSocket(r);console.log("Subscribed to ",r),i.onmessage=function(e){try{var n=e.data;t(n)}catch(e){console.error("Error parsing message:",e)}},i.onerror=function(e){console.error("WebSocket error:",e)},i.onopen=function(){console.log("Connected to ".concat(r))},i.onclose=function(e){console.log("Disconnected from ".concat(r,":"),e.reason)},this.websockets.set("".concat(n,"/").concat(e),i)}},{key:"publish",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"table";fetch("https://".concat(this.baseURL,"/publish/").concat(n,"/").concat(e),{method:"POST",headers:{"Content-Type":"application/json"},body:t}).catch(function(e){console.error("Publication error:",e)})}},{key:"getOnlineCount",value:function(){var e;return(e=function(){var e;return function(e,t){var n,r,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype),a=Object.defineProperty;return a(s,"next",{value:l(0)}),a(s,"throw",{value:l(1)}),a(s,"return",{value:l(2)}),"function"==typeof Symbol&&a(s,Symbol.iterator,{value:function(){return this}}),s;function l(a){return function(l){var c=[a,l];if(n)throw TypeError("Generator is already executing.");for(;s&&(s=0,c[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&c[0]?r.return:c[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,c[1])).done)return i;switch(r=0,i&&(c=[2&c[0],i.value]),c[0]){case 0:case 1:i=c;break;case 4:return o.label++,{value:c[1],done:!1};case 5:o.label++,r=c[1],c=[0];continue;case 7:c=o.ops.pop(),o.trys.pop();continue;default:if(!(i=(i=o.trys).length>0&&i[i.length-1])&&(6===c[0]||2===c[0])){o=0;continue}if(3===c[0]&&(!i||c[1]>i[0]&&c[1]<i[3])){o.label=c[1];break}if(6===c[0]&&o.label<i[1]){o.label=i[1],i=c;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(c);break}i[2]&&o.ops.pop(),o.trys.pop();continue}c=t.call(e,o)}catch(e){c=[6,e],r=0}finally{n=i=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}}(this,function(t){switch(t.label){case 0:return t.trys.push([0,3,,4]),[4,fetch("https://".concat(this.baseURL,"/basic_status"))];case 1:return[4,t.sent().text()];case 2:return[2,(e=t.sent().match(/Active connections:\s+(\d+)/))?Number.parseInt(e[1],10)-1:null];case 3:return t.sent(),[2,null];case 4:return[2]}})},function(){var t=this,n=arguments;return new Promise(function(i,o){var s=e.apply(t,n);function a(e){r(s,i,o,a,l,"next",e)}function l(e){r(s,i,o,a,l,"throw",e)}a(void 0)})}).call(this)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/network/client/session.ts"(e,t,n){n.d(t,{N:()=>i});function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var i=function(){var e;function t(e,n,i,o){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");r(this,"playername",void 0),r(this,"clientId",void 0),r(this,"tableId",void 0),r(this,"spectator",void 0),r(this,"opponentName",void 0),r(this,"playerIndex",void 0),this.playername=e,this.clientId=n,this.tableId=i,this.spectator=o,this.playerIndex=0}return e=[{key:"getInstance",value:function(){if(!t.instance)throw Error("Session not initialized");return t.instance}},{key:"hasInstance",value:function(){return void 0!==t.instance}},{key:"playerIndex",value:function(){return t.instance?t.instance.playerIndex:0}},{key:"isSpectator",value:function(){return void 0!==t.instance&&t.getInstance().spectator}},{key:"reset",value:function(){t.instance=void 0}},{key:"init",value:function(e,n,r,i){t.instance=new t(n,e,r,i)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();r(i,"instance",void 0)},"./src/utils/dom.ts"(e,t,n){function r(e){return document.getElementById(e)}function i(e){return document.getElementById(e)}function o(e){return document.getElementById(e)}function s(e){return document.getElementById(e)}n.d(t,{V4:()=>o,dX:()=>s,id:()=>r,vq:()=>i})},"./src/utils/gameover.ts"(e,t,n){n.d(t,{c:()=>r});var r={lobby:"<button onclick=\"location.href='".concat("https://scoreboard-tailuge.vercel.app/","'\">Lobby</button>"),newGame:'<button onclick="location.reload()">New Game</button>',replay:'<button onclick="location.reload()">Replay</button>',forMode:function(e){return e?this.newGame+this.lobby:this.lobby}}},"./src/utils/gltf.ts"(e,t,n){n.d(t,{KP:()=>ex,Ro:()=>eT});var r=n("./node_modules/three/build/three.core.js");let i={POSITION:["byte","byte normalized","unsigned byte","unsigned byte normalized","short","short normalized","unsigned short","unsigned short normalized"],NORMAL:["byte normalized","short normalized"],TANGENT:["byte normalized","short normalized"],TEXCOORD:["byte","byte normalized","unsigned byte","short","short normalized","unsigned short"]};class o{constructor(){this.textureUtils=null,this.pluginCallbacks=[],this.register(function(e){return new v(e)}),this.register(function(e){return new y(e)}),this.register(function(e){return new w(e)}),this.register(function(e){return new k(e)}),this.register(function(e){return new x(e)}),this.register(function(e){return new T(e)}),this.register(function(e){return new m(e)}),this.register(function(e){return new b(e)}),this.register(function(e){return new g(e)}),this.register(function(e){return new P(e)}),this.register(function(e){return new S(e)}),this.register(function(e){return new O(e)}),this.register(function(e){return new R(e)}),this.register(function(e){return new E(e)})}register(e){return -1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return -1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}setTextureUtils(e){return this.textureUtils=e,this}parse(e,t,n,r){let i=new d,o=[];for(let e=0,t=this.pluginCallbacks.length;e<t;e++)o.push(this.pluginCallbacks[e](i));i.setPlugins(o),i.setTextureUtils(this.textureUtils),i.writeAsync(e,t,r).catch(n)}parseAsync(e,t){let n=this;return new Promise(function(r,i){n.parse(e,r,i,t)})}}let s="KHR_mesh_quantization",a={};a[r.hxR]=9728,a[r.pHI]=9984,a[r.Cfg]=9986,a[r.k6q]=9729,a[r.kRr]=9985,a[r.$_I]=9987,a[r.ghU]=33071,a[r.GJx]=10497,a[r.kTW]=33648;let l={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},c=new r.Q1f;function u(e,t){return e.length===t.length&&e.every(function(e,n){return e===t[n]})}function h(e){return 4*Math.ceil(e/4)}function f(e,t=0){let n=h(e.byteLength);if(n!==e.byteLength){let r=new Uint8Array(n);if(r.set(new Uint8Array(e)),0!==t)for(let i=e.byteLength;i<n;i++)r[i]=t;return r.buffer}return e}function p(){return"u"<typeof document&&"u">typeof OffscreenCanvas?new OffscreenCanvas(1,1):document.createElement("canvas")}class d{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.extensionsRequired={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter r"+r.sPf}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map},this.textureUtils=null}setPlugins(e){this.plugins=e}setTextureUtils(e){this.textureUtils=e}async writeAsync(e,t,n={}){this.options=Object.assign({binary:!1,trs:!1,onlyVisible:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},n),this.options.animations.length>0&&(this.options.trs=!0),await this.processInputAsync(e),await Promise.all(this.pending);let r=this.buffers,i=this.json;n=this.options;let o=this.extensionsUsed,s=this.extensionsRequired,a=new Blob(r,{type:"application/octet-stream"}),l=Object.keys(o),c=Object.keys(s);if(l.length>0&&(i.extensionsUsed=l),c.length>0&&(i.extensionsRequired=c),i.buffers&&i.buffers.length>0&&(i.buffers[0].byteLength=a.size),!0===n.binary){let e=new FileReader;e.readAsArrayBuffer(a),e.onloadend=function(){var n;let r=f(e.result),o=new DataView(new ArrayBuffer(8));o.setUint32(0,r.byteLength,!0),o.setUint32(4,5130562,!0);let s=f((n=JSON.stringify(i),new TextEncoder().encode(n).buffer),32),a=new DataView(new ArrayBuffer(8));a.setUint32(0,s.byteLength,!0),a.setUint32(4,0x4e4f534a,!0);let l=new ArrayBuffer(12),c=new DataView(l);c.setUint32(0,0x46546c67,!0),c.setUint32(4,2,!0);let u=12+a.byteLength+s.byteLength+o.byteLength+r.byteLength;c.setUint32(8,u,!0);let h=new Blob([l,a,s,o,r],{type:"application/octet-stream"}),p=new FileReader;p.readAsArrayBuffer(h),p.onloadend=function(){t(p.result)}}}else if(i.buffers&&i.buffers.length>0){let e=new FileReader;e.readAsDataURL(a),e.onloadend=function(){let n=e.result;i.buffers[0].uri=n,t(i)}}else t(i)}serializeUserData(e,t){if(0===Object.keys(e.userData).length)return;let n=this.options,r=this.extensionsUsed;try{let i=JSON.parse(JSON.stringify(e.userData));if(n.includeCustomExtensions&&i.gltfExtensions){for(let e in void 0===t.extensions&&(t.extensions={}),i.gltfExtensions)t.extensions[e]=i.gltfExtensions[e],r[e]=!0;delete i.gltfExtensions}Object.keys(i).length>0&&(t.extras=i)}catch(t){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+t.message)}}getUID(e,t=!1){if(!1===this.uids.has(e)){let t=new Map;t.set(!0,this.uid++),t.set(!1,this.uid++),this.uids.set(e,t)}return this.uids.get(e).get(t)}isNormalizedNormalAttribute(e){if(this.cache.attributesNormalized.has(e))return!1;let t=new r.Pq0;for(let n=0,r=e.count;n<r;n++)if(Math.abs(t.fromBufferAttribute(e,n).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(e){let t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);let n=e.clone(),i=new r.Pq0;for(let e=0,t=n.count;e<t;e++)i.fromBufferAttribute(n,e),0===i.x&&0===i.y&&0===i.z?i.setX(1):i.normalize(),n.setXYZ(e,i.x,i.y,i.z);return t.attributesNormalized.set(e,n),n}applyTextureTransform(e,t){let n=!1,r={};(0!==t.offset.x||0!==t.offset.y)&&(r.offset=t.offset.toArray(),n=!0),0!==t.rotation&&(r.rotation=t.rotation,n=!0),(1!==t.repeat.x||1!==t.repeat.y)&&(r.scale=t.repeat.toArray(),n=!0),n&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=r,this.extensionsUsed.KHR_texture_transform=!0)}async buildMetalRoughTextureAsync(e,t){if(e===t)return e;function n(e){return e.colorSpace===r.er$?function(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}:function(e){return e}}e instanceof r.FvD&&(e=await this.decompressTextureAsync(e)),t instanceof r.FvD&&(t=await this.decompressTextureAsync(t));let i=e?e.image:null,o=t?t.image:null,s=Math.max(i?i.width:0,o?o.width:0),a=Math.max(i?i.height:0,o?o.height:0),l=p();l.width=s,l.height=a;let c=l.getContext("2d",{willReadFrequently:!0});c.fillStyle="#00ffff",c.fillRect(0,0,s,a);let u=c.getImageData(0,0,s,a);if(i){c.drawImage(i,0,0,s,a);let t=n(e),r=c.getImageData(0,0,s,a).data;for(let e=2;e<r.length;e+=4)u.data[e]=256*t(r[e]/256)}if(o){c.drawImage(o,0,0,s,a);let e=n(t),r=c.getImageData(0,0,s,a).data;for(let t=1;t<r.length;t+=4)u.data[t]=256*e(r[t]/256)}c.putImageData(u,0,0);let h=(e||t).clone();return h.source=new r.kLi(l),h.colorSpace=r.jf0,h.channel=(e||t).channel,e&&t&&e.channel!==t.channel&&console.warn("THREE.GLTFExporter: UV channels for metalnessMap and roughnessMap textures must match."),console.warn("THREE.GLTFExporter: Merged metalnessMap and roughnessMap textures."),h}async decompressTextureAsync(e,t=1/0){if(null===this.textureUtils)throw Error("THREE.GLTFExporter: setTextureUtils() must be called to process compressed textures.");return await this.textureUtils.decompress(e,t)}processBuffer(e){let t=this.json,n=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),n.push(e),0}processBufferView(e,t,n,i,o){let s,a=this.json;switch(!a.bufferViews&&(a.bufferViews=[]),t){case 5120:case 5121:s=1;break;case 5122:case 5123:s=2;break;default:s=4}let l=e.itemSize*s;34962===o&&(l=4*Math.ceil(l/4));let c=h(i*l),u=new DataView(new ArrayBuffer(c)),f=0;for(let o=n;o<n+i;o++){for(let n=0;n<e.itemSize;n++){let i;e.itemSize>4?i=e.array[o*e.itemSize+n]:(0===n?i=e.getX(o):1===n?i=e.getY(o):2===n?i=e.getZ(o):3===n&&(i=e.getW(o)),!0===e.normalized&&(i=r.cj9.normalize(i,e.array))),5126===t?u.setFloat32(f,i,!0):5124===t?u.setInt32(f,i,!0):5125===t?u.setUint32(f,i,!0):5122===t?u.setInt16(f,i,!0):5123===t?u.setUint16(f,i,!0):5120===t?u.setInt8(f,i):5121===t&&u.setUint8(f,i),f+=s}f%l!=0&&(f+=l-f%l)}let p={buffer:this.processBuffer(u.buffer),byteOffset:this.byteOffset,byteLength:c};return void 0!==o&&(p.target=o),34962===o&&(p.byteStride=l),this.byteOffset+=c,a.bufferViews.push(p),{id:a.bufferViews.length-1,byteLength:0}}processBufferViewImage(e){let t=this,n=t.json;return n.bufferViews||(n.bufferViews=[]),new Promise(function(r){let i=new FileReader;i.readAsArrayBuffer(e),i.onloadend=function(){let e=f(i.result),o={buffer:t.processBuffer(e),byteOffset:t.byteOffset,byteLength:e.byteLength};t.byteOffset+=e.byteLength,r(n.bufferViews.push(o)-1)}})}processAccessor(e,t,n,i){let o,s,a=this.json;if(e.array.constructor===Float32Array)o=5126;else if(e.array.constructor===Int32Array)o=5124;else if(e.array.constructor===Uint32Array)o=5125;else if(e.array.constructor===Int16Array)o=5122;else if(e.array.constructor===Uint16Array)o=5123;else if(e.array.constructor===Int8Array)o=5120;else if(e.array.constructor===Uint8Array)o=5121;else throw Error("THREE.GLTFExporter: Unsupported bufferAttribute component type: "+e.array.constructor.name);if(void 0===n&&(n=0),(void 0===i||i===1/0)&&(i=e.count),0===i)return null;let l=function(e,t,n){let i={min:Array(e.itemSize).fill(1/0),max:Array(e.itemSize).fill(-1/0)};for(let o=t;o<t+n;o++)for(let t=0;t<e.itemSize;t++){let n;e.itemSize>4?n=e.array[o*e.itemSize+t]:(0===t?n=e.getX(o):1===t?n=e.getY(o):2===t?n=e.getZ(o):3===t&&(n=e.getW(o)),!0===e.normalized&&(n=r.cj9.normalize(n,e.array))),i.min[t]=Math.min(i.min[t],n),i.max[t]=Math.max(i.max[t],n)}return i}(e,n,i);void 0!==t&&(s=e===t.index?34963:34962);let c=this.processBufferView(e,o,n,i,s),u={bufferView:c.id,byteOffset:c.byteOffset,componentType:o,count:i,max:l.max,min:l.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",9:"MAT3",16:"MAT4"}[e.itemSize]};return!0===e.normalized&&(u.normalized=!0),a.accessors||(a.accessors=[]),a.accessors.push(u)-1}processImage(e,t,n,i="image/png"){if(null!==e){let o=this,s=o.cache,a=o.json,l=o.options,c=o.pending;s.images.has(e)||s.images.set(e,{});let u=s.images.get(e),h=i+":flipY/"+n.toString();if(void 0!==u[h])return u[h];a.images||(a.images=[]);let f={mimeType:i},d=p();d.width=Math.min(e.width,l.maxTextureSize),d.height=Math.min(e.height,l.maxTextureSize);let v=d.getContext("2d",{willReadFrequently:!0});if(!0===n&&(v.translate(0,d.height),v.scale(1,-1)),void 0!==e.data){t!==r.GWd&&console.error("GLTFExporter: Only RGBAFormat is supported.",t),(e.width>l.maxTextureSize||e.height>l.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",e);let n=new Uint8ClampedArray(e.height*e.width*4);for(let t=0;t<n.length;t+=4)n[t+0]=e.data[t+0],n[t+1]=e.data[t+1],n[t+2]=e.data[t+2],n[t+3]=e.data[t+3];v.putImageData(new ImageData(n,e.width,e.height),0,0)}else if("u">typeof HTMLImageElement&&e instanceof HTMLImageElement||"u">typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"u">typeof ImageBitmap&&e instanceof ImageBitmap||"u">typeof OffscreenCanvas&&e instanceof OffscreenCanvas)v.drawImage(e,0,0,d.width,d.height);else throw Error("THREE.GLTFExporter: Invalid image type. Use HTMLImageElement, HTMLCanvasElement, ImageBitmap or OffscreenCanvas.");!0===l.binary?c.push((function(e,t){if(!("u">typeof OffscreenCanvas&&e instanceof OffscreenCanvas))return new Promise(n=>e.toBlob(n,t));{let n;return"image/jpeg"===t?n=.92:"image/webp"===t&&(n=.8),e.convertToBlob({type:t,quality:n})}})(d,i).then(e=>o.processBufferViewImage(e)).then(e=>{f.bufferView=e})):f.uri=r.HgN.getDataURL(d,i);let y=a.images.push(f)-1;return u[h]=y,y}throw Error("THREE.GLTFExporter: No valid image data found. Unable to process texture.")}processSampler(e){let t=this.json;t.samplers||(t.samplers=[]);let n={magFilter:a[e.magFilter],minFilter:a[e.minFilter],wrapS:a[e.wrapS],wrapT:a[e.wrapT]};return t.samplers.push(n)-1}async processTextureAsync(e){let t=this.options,n=this.cache,i=this.json;if(n.textures.has(e))return n.textures.get(e);i.textures||(i.textures=[]),e instanceof r.FvD&&(e=await this.decompressTextureAsync(e,t.maxTextureSize));let o=e.userData.mimeType;"image/webp"===o&&(o="image/png");let s={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY,o)};e.name&&(s.name=e.name),await this._invokeAllAsync(async function(t){t.writeTexture&&await t.writeTexture(e,s)});let a=i.textures.push(s)-1;return n.textures.set(e,a),a}async processMaterialAsync(e){let t=this.cache,n=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;n.materials||(n.materials=[]);let i={pbrMetallicRoughness:{}};!0!==e.isMeshStandardMaterial&&!0!==e.isMeshBasicMaterial&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");let o=e.color.toArray().concat([e.opacity]);if(u(o,[1,1,1,1])||(i.pbrMetallicRoughness.baseColorFactor=o),e.isMeshStandardMaterial?(i.pbrMetallicRoughness.metallicFactor=e.metalness,i.pbrMetallicRoughness.roughnessFactor=e.roughness):(i.pbrMetallicRoughness.metallicFactor=0,i.pbrMetallicRoughness.roughnessFactor=1),e.metalnessMap||e.roughnessMap){let t=await this.buildMetalRoughTextureAsync(e.metalnessMap,e.roughnessMap),n={index:await this.processTextureAsync(t),texCoord:t.channel};this.applyTextureTransform(n,t),i.pbrMetallicRoughness.metallicRoughnessTexture=n}if(e.map){let t={index:await this.processTextureAsync(e.map),texCoord:e.map.channel};this.applyTextureTransform(t,e.map),i.pbrMetallicRoughness.baseColorTexture=t}if(e.emissive){let t=e.emissive;if(Math.max(t.r,t.g,t.b)>0&&(i.emissiveFactor=e.emissive.toArray()),e.emissiveMap){let t={index:await this.processTextureAsync(e.emissiveMap),texCoord:e.emissiveMap.channel};this.applyTextureTransform(t,e.emissiveMap),i.emissiveTexture=t}}if(e.normalMap){let t={index:await this.processTextureAsync(e.normalMap),texCoord:e.normalMap.channel};e.normalScale&&1!==e.normalScale.x&&(t.scale=e.normalScale.x),this.applyTextureTransform(t,e.normalMap),i.normalTexture=t}if(e.aoMap){let t={index:await this.processTextureAsync(e.aoMap),texCoord:e.aoMap.channel};1!==e.aoMapIntensity&&(t.strength=e.aoMapIntensity),this.applyTextureTransform(t,e.aoMap),i.occlusionTexture=t}e.transparent?i.alphaMode="BLEND":e.alphaTest>0&&(i.alphaMode="MASK",i.alphaCutoff=e.alphaTest),e.side===r.$EB&&(i.doubleSided=!0),""!==e.name&&(i.name=e.name),this.serializeUserData(e,i),await this._invokeAllAsync(async function(t){t.writeMaterialAsync&&await t.writeMaterialAsync(e,i)});let s=n.materials.push(i)-1;return t.materials.set(e,s),s}async processMeshAsync(e){let t,n=this.cache,i=this.json,s=[e.geometry.uuid];if(Array.isArray(e.material))for(let t=0,n=e.material.length;t<n;t++)s.push(e.material[t].uuid);else s.push(e.material.uuid);let a=s.join(":");if(n.meshes.has(a))return n.meshes.get(a);let l=e.geometry;t=e.isLineSegments?1:e.isLineLoop?2:e.isLine?3:e.isPoints?0:e.material.wireframe?1:4;let c={},u={},h=[],f=[],p={uv:"TEXCOORD_0",uv1:"TEXCOORD_1",uv2:"TEXCOORD_2",uv3:"TEXCOORD_3",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},d=l.getAttribute("normal");void 0===d||this.isNormalizedNormalAttribute(d)||(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),l.setAttribute("normal",this.createNormalizedNormalAttribute(d)));let v=null;for(let e in l.attributes){if("morph"===e.slice(0,5))continue;let t=l.attributes[e];if(e=p[e]||e.toUpperCase(),/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(e)||(e="_"+e),n.attributes.has(this.getUID(t))){u[e]=n.attributes.get(this.getUID(t));continue}v=null;let i=t.array;"JOINTS_0"!==e||i instanceof Uint16Array||i instanceof Uint8Array?(i instanceof Uint32Array||i instanceof Int32Array)&&!e.startsWith("_")&&(console.warn(`GLTFExporter: Attribute "${e}" converted to type FLOAT.`),v=o.Utils.toFloat32BufferAttribute(t)):(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),v=new r.THS(new Uint16Array(i),t.itemSize,t.normalized));let s=this.processAccessor(v||t,l);null!==s&&(e.startsWith("_")||this.detectMeshQuantization(e,t),u[e]=s,n.attributes.set(this.getUID(t),s))}if(void 0!==d&&l.setAttribute("normal",d),0===Object.keys(u).length)return null;if(void 0!==e.morphTargetInfluences&&e.morphTargetInfluences.length>0){let t=[],r=[],i={};if(void 0!==e.morphTargetDictionary)for(let t in e.morphTargetDictionary)i[e.morphTargetDictionary[t]]=t;for(let o=0;o<e.morphTargetInfluences.length;++o){let s={},a=!1;for(let e in l.morphAttributes){if("position"!==e&&"normal"!==e){a||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),a=!0);continue}let t=l.morphAttributes[e][o],r=e.toUpperCase(),i=l.attributes[e];if(n.attributes.has(this.getUID(t,!0))){s[r]=n.attributes.get(this.getUID(t,!0));continue}let c=t.clone();if(!l.morphTargetsRelative)for(let e=0,n=t.count;e<n;e++)for(let n=0;n<t.itemSize;n++)0===n&&c.setX(e,t.getX(e)-i.getX(e)),1===n&&c.setY(e,t.getY(e)-i.getY(e)),2===n&&c.setZ(e,t.getZ(e)-i.getZ(e)),3===n&&c.setW(e,t.getW(e)-i.getW(e));s[r]=this.processAccessor(c,l),n.attributes.set(this.getUID(i,!0),s[r])}f.push(s),t.push(e.morphTargetInfluences[o]),void 0!==e.morphTargetDictionary&&r.push(i[o])}c.weights=t,r.length>0&&(c.extras={},c.extras.targetNames=r)}let y=Array.isArray(e.material);if(y&&0===l.groups.length)return null;let m=!1;if(y&&null===l.index){let e=[];for(let t=0,n=l.attributes.position.count;t<n;t++)e[t]=t;l.setIndex(e),m=!0}let b=y?e.material:[e.material],g=y?l.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let e=0,r=g.length;e<r;e++){let r={mode:t,attributes:u};if(this.serializeUserData(l,r),f.length>0&&(r.targets=f),null!==l.index){let t=this.getUID(l.index);(void 0!==g[e].start||void 0!==g[e].count)&&(t+=":"+g[e].start+":"+g[e].count),n.attributes.has(t)?r.indices=n.attributes.get(t):(r.indices=this.processAccessor(l.index,l,g[e].start,g[e].count),n.attributes.set(t,r.indices)),null===r.indices&&delete r.indices}let i=await this.processMaterialAsync(b[g[e].materialIndex]);null!==i&&(r.material=i),h.push(r)}!0===m&&l.setIndex(null),c.primitives=h,i.meshes||(i.meshes=[]),await this._invokeAllAsync(function(t){t.writeMesh&&t.writeMesh(e,c)});let w=i.meshes.push(c)-1;return n.meshes.set(a,w),w}detectMeshQuantization(e,t){let n;if(this.extensionsUsed[s])return;switch(t.array.constructor){case Int8Array:n="byte";break;case Uint8Array:n="unsigned byte";break;case Int16Array:n="short";break;case Uint16Array:n="unsigned short";break;default:return}t.normalized&&(n+=" normalized");let r=e.split("_",1)[0];i[r]&&i[r].includes(n)&&(this.extensionsUsed[s]=!0,this.extensionsRequired[s]=!0)}processCamera(e){let t=this.json;t.cameras||(t.cameras=[]);let n=e.isOrthographicCamera,i={type:n?"orthographic":"perspective"};return n?i.orthographic={xmag:2*e.right,ymag:2*e.top,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:i.perspective={aspectRatio:e.aspect,yfov:r.cj9.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},""!==e.name&&(i.name=e.type),t.cameras.push(i)-1}processAnimation(e,t){let n=this.json,i=this.nodeMap;n.animations||(n.animations=[]);let s=(e=o.Utils.mergeMorphTargetTracks(e.clone(),t)).tracks,a=[],c=[];for(let e=0;e<s.length;++e){let n,o=s[e],u=r.Nwf.parseTrackName(o.name),h=r.Nwf.findNode(t,u.nodeName),f=l[u.propertyName];if("bones"===u.objectName&&(h=!0===h.isSkinnedMesh?h.skeleton.getBoneByName(u.objectIndex):void 0),!h||!f){console.warn('THREE.GLTFExporter: Could not export animation track "%s".',o.name);continue}let p=o.values.length/o.times.length;f===l.morphTargetInfluences&&(p/=h.morphTargetInfluences.length),!0===o.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(n="CUBICSPLINE",p/=3):n=o.getInterpolation()===r.ljd?"STEP":"LINEAR",c.push({input:this.processAccessor(new r.THS(o.times,1)),output:this.processAccessor(new r.THS(o.values,p)),interpolation:n}),a.push({sampler:c.length-1,target:{node:i.get(h),path:f}})}let u={name:e.name||"clip_"+n.animations.length,samplers:c,channels:a};return this.serializeUserData(e,u),n.animations.push(u),n.animations.length-1}processSkin(e){let t=this.json,n=this.nodeMap,i=t.nodes[n.get(e)],o=e.skeleton;if(void 0===o)return null;let s=e.skeleton.bones[0];if(void 0===s)return null;let a=[],l=new Float32Array(16*o.bones.length),c=new r.kn4;for(let t=0;t<o.bones.length;++t)a.push(n.get(o.bones[t])),c.copy(o.boneInverses[t]),c.multiply(e.bindMatrix).toArray(l,16*t);return void 0===t.skins&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new r.THS(l,16)),joints:a,skeleton:n.get(s)}),i.skin=t.skins.length-1}async processNodeAsync(e){let t=this.json,n=this.options,r=this.nodeMap;t.nodes||(t.nodes=[]);let i={};if(n.trs){let t=e.quaternion.toArray(),n=e.position.toArray(),r=e.scale.toArray();u(t,[0,0,0,1])||(i.rotation=t),u(n,[0,0,0])||(i.translation=n),u(r,[1,1,1])||(i.scale=r)}else e.matrixAutoUpdate&&e.updateMatrix(),!1===u(e.matrix.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])&&(i.matrix=e.matrix.elements);if(""!==e.name&&(i.name=String(e.name)),this.serializeUserData(e,i),e.isMesh||e.isLine||e.isPoints){let t=await this.processMeshAsync(e);null!==t&&(i.mesh=t)}else e.isCamera&&(i.camera=this.processCamera(e));e.isSkinnedMesh&&this.skins.push(e);let o=t.nodes.push(i)-1;if(r.set(e,o),e.children.length>0){let t=[];for(let r=0,i=e.children.length;r<i;r++){let i=e.children[r];if(i.visible||!1===n.onlyVisible){let e=await this.processNodeAsync(i);null!==e&&t.push(e)}}t.length>0&&(i.children=t)}return await this._invokeAllAsync(function(t){t.writeNode&&t.writeNode(e,i)}),o}async processSceneAsync(e){let t=this.json,n=this.options;t.scenes||(t.scenes=[],t.scene=0);let r={};""!==e.name&&(r.name=e.name),t.scenes.push(r);let i=[];for(let t=0,r=e.children.length;t<r;t++){let r=e.children[t];if(r.visible||!1===n.onlyVisible){let e=await this.processNodeAsync(r);null!==e&&i.push(e)}}i.length>0&&(r.nodes=i),this.serializeUserData(e,r)}async processObjectsAsync(e){let t=new r.Z58;t.name="AuxScene";for(let n=0;n<e.length;n++)t.children.push(e[n]);await this.processSceneAsync(t)}async processInputAsync(e){let t=this.options;e=e instanceof Array?e:[e],await this._invokeAllAsync(function(t){t.beforeParse&&t.beforeParse(e)});let n=[];for(let t=0;t<e.length;t++)e[t]instanceof r.Z58?await this.processSceneAsync(e[t]):n.push(e[t]);n.length>0&&await this.processObjectsAsync(n);for(let e=0;e<this.skins.length;++e)this.processSkin(this.skins[e]);for(let n=0;n<t.animations.length;++n)this.processAnimation(t.animations[n],e[0]);await this._invokeAllAsync(function(t){t.afterParse&&t.afterParse(e)})}async _invokeAllAsync(e){for(let t=0,n=this.plugins.length;t<n;t++)await e(this.plugins[t])}}class v{constructor(e){this.writer=e,this.name="KHR_lights_punctual"}writeNode(e,t){if(!e.isLight)return;if(!e.isDirectionalLight&&!e.isPointLight&&!e.isSpotLight)return void console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e);let n=this.writer,r=n.json,i=n.extensionsUsed,o={};e.name&&(o.name=e.name),o.color=e.color.toArray(),o.intensity=e.intensity,e.isDirectionalLight?o.type="directional":e.isPointLight?(o.type="point",e.distance>0&&(o.range=e.distance)):e.isSpotLight&&(o.type="spot",e.distance>0&&(o.range=e.distance),o.spot={},o.spot.innerConeAngle=(1-e.penumbra)*e.angle,o.spot.outerConeAngle=e.angle),void 0!==e.decay&&2!==e.decay&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),e.target&&(e.target.parent!==e||0!==e.target.position.x||0!==e.target.position.y||-1!==e.target.position.z)&&console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),i[this.name]||(r.extensions=r.extensions||{},r.extensions[this.name]={lights:[]},i[this.name]=!0);let s=r.extensions[this.name].lights;s.push(o),t.extensions=t.extensions||{},t.extensions[this.name]={light:s.length-1}}}class y{constructor(e){this.writer=e,this.name="KHR_materials_unlit"}async writeMaterialAsync(e,t){if(!e.isMeshBasicMaterial)return;let n=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},n[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}}class m{constructor(e){this.writer=e,this.name="KHR_materials_clearcoat"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.clearcoat)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.clearcoatFactor=e.clearcoat,e.clearcoatMap){let t={index:await n.processTextureAsync(e.clearcoatMap),texCoord:e.clearcoatMap.channel};n.applyTextureTransform(t,e.clearcoatMap),i.clearcoatTexture=t}if(i.clearcoatRoughnessFactor=e.clearcoatRoughness,e.clearcoatRoughnessMap){let t={index:await n.processTextureAsync(e.clearcoatRoughnessMap),texCoord:e.clearcoatRoughnessMap.channel};n.applyTextureTransform(t,e.clearcoatRoughnessMap),i.clearcoatRoughnessTexture=t}if(e.clearcoatNormalMap){let t={index:await n.processTextureAsync(e.clearcoatNormalMap),texCoord:e.clearcoatNormalMap.channel};1!==e.clearcoatNormalScale.x&&(t.scale=e.clearcoatNormalScale.x),n.applyTextureTransform(t,e.clearcoatNormalMap),i.clearcoatNormalTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class b{constructor(e){this.writer=e,this.name="KHR_materials_dispersion"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.dispersion)return;let n=this.writer.extensionsUsed,r={};r.dispersion=e.dispersion,t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class g{constructor(e){this.writer=e,this.name="KHR_materials_iridescence"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.iridescence)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.iridescenceFactor=e.iridescence,e.iridescenceMap){let t={index:await n.processTextureAsync(e.iridescenceMap),texCoord:e.iridescenceMap.channel};n.applyTextureTransform(t,e.iridescenceMap),i.iridescenceTexture=t}if(i.iridescenceIor=e.iridescenceIOR,i.iridescenceThicknessMinimum=e.iridescenceThicknessRange[0],i.iridescenceThicknessMaximum=e.iridescenceThicknessRange[1],e.iridescenceThicknessMap){let t={index:await n.processTextureAsync(e.iridescenceThicknessMap),texCoord:e.iridescenceThicknessMap.channel};n.applyTextureTransform(t,e.iridescenceThicknessMap),i.iridescenceThicknessTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class w{constructor(e){this.writer=e,this.name="KHR_materials_transmission"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.transmissionFactor=e.transmission,e.transmissionMap){let t={index:await n.processTextureAsync(e.transmissionMap),texCoord:e.transmissionMap.channel};n.applyTextureTransform(t,e.transmissionMap),i.transmissionTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class k{constructor(e){this.writer=e,this.name="KHR_materials_volume"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.thicknessFactor=e.thickness,e.thicknessMap){let t={index:await n.processTextureAsync(e.thicknessMap),texCoord:e.thicknessMap.channel};n.applyTextureTransform(t,e.thicknessMap),i.thicknessTexture=t}e.attenuationDistance!==1/0&&(i.attenuationDistance=e.attenuationDistance),i.attenuationColor=e.attenuationColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class x{constructor(e){this.writer=e,this.name="KHR_materials_ior"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||1.5===e.ior)return;let n=this.writer.extensionsUsed,r={};r.ior=e.ior,t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class T{constructor(e){this.writer=e,this.name="KHR_materials_specular"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||1===e.specularIntensity&&e.specularColor.equals(c)&&!e.specularIntensityMap&&!e.specularColorMap)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.specularIntensityMap){let t={index:await n.processTextureAsync(e.specularIntensityMap),texCoord:e.specularIntensityMap.channel};n.applyTextureTransform(t,e.specularIntensityMap),i.specularTexture=t}if(e.specularColorMap){let t={index:await n.processTextureAsync(e.specularColorMap),texCoord:e.specularColorMap.channel};n.applyTextureTransform(t,e.specularColorMap),i.specularColorTexture=t}i.specularFactor=e.specularIntensity,i.specularColorFactor=e.specularColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class P{constructor(e){this.writer=e,this.name="KHR_materials_sheen"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0==e.sheen)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.sheenRoughnessMap){let t={index:await n.processTextureAsync(e.sheenRoughnessMap),texCoord:e.sheenRoughnessMap.channel};n.applyTextureTransform(t,e.sheenRoughnessMap),i.sheenRoughnessTexture=t}if(e.sheenColorMap){let t={index:await n.processTextureAsync(e.sheenColorMap),texCoord:e.sheenColorMap.channel};n.applyTextureTransform(t,e.sheenColorMap),i.sheenColorTexture=t}i.sheenRoughnessFactor=e.sheenRoughness,i.sheenColorFactor=e.sheenColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class S{constructor(e){this.writer=e,this.name="KHR_materials_anisotropy"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0==e.anisotropy)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.anisotropyMap){let t={index:await n.processTextureAsync(e.anisotropyMap)};n.applyTextureTransform(t,e.anisotropyMap),i.anisotropyTexture=t}i.anisotropyStrength=e.anisotropy,i.anisotropyRotation=e.anisotropyRotation,t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class O{constructor(e){this.writer=e,this.name="KHR_materials_emissive_strength"}async writeMaterialAsync(e,t){if(!e.isMeshStandardMaterial||1===e.emissiveIntensity)return;let n=this.writer.extensionsUsed,r={};r.emissiveStrength=e.emissiveIntensity,t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class R{constructor(e){this.writer=e,this.name="EXT_materials_bump"}async writeMaterialAsync(e,t){if(!e.isMeshStandardMaterial||1===e.bumpScale&&!e.bumpMap)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.bumpMap){let t={index:await n.processTextureAsync(e.bumpMap),texCoord:e.bumpMap.channel};n.applyTextureTransform(t,e.bumpMap),i.bumpTexture=t}i.bumpFactor=e.bumpScale,t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class E{constructor(e){this.writer=e,this.name="EXT_mesh_gpu_instancing"}writeNode(e,t){if(!e.isInstancedMesh)return;let n=this.writer,i=new Float32Array(3*e.count),o=new Float32Array(4*e.count),s=new Float32Array(3*e.count),a=new r.kn4,l=new r.Pq0,c=new r.PTz,u=new r.Pq0;for(let t=0;t<e.count;t++)e.getMatrixAt(t,a),a.decompose(l,c,u),l.toArray(i,3*t),c.toArray(o,4*t),u.toArray(s,3*t);let h={TRANSLATION:n.processAccessor(new r.THS(i,3)),ROTATION:n.processAccessor(new r.THS(o,4)),SCALE:n.processAccessor(new r.THS(s,3))};e.instanceColor&&(h._COLOR_0=n.processAccessor(e.instanceColor)),t.extensions=t.extensions||{},t.extensions[this.name]={attributes:h},n.extensionsUsed[this.name]=!0,n.extensionsRequired[this.name]=!0}}function A(e,t){if(t===r.RJ4)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(t!==r.rYR&&t!==r.O49)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),e;{let n=e.getIndex();if(null===n){let t=[],r=e.getAttribute("position");if(void 0===r)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<r.count;e++)t.push(e);e.setIndex(t),n=e.getIndex()}let i=n.count-2,o=[];if(t===r.rYR)for(let e=1;e<=i;e++)o.push(n.getX(0)),o.push(n.getX(e)),o.push(n.getX(e+1));else for(let e=0;e<i;e++)e%2==0?(o.push(n.getX(e)),o.push(n.getX(e+1)),o.push(n.getX(e+2))):(o.push(n.getX(e+2)),o.push(n.getX(e+1)),o.push(n.getX(e)));o.length/3!==i&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");let s=e.clone();return s.setIndex(o),s.clearGroups(),s}}o.Utils={insertKeyframe:function(e,t){let n,r=e.getValueSize(),i=new e.TimeBufferType(e.times.length+1),o=new e.ValueBufferType(e.values.length+r),s=e.createInterpolant(new e.ValueBufferType(r));if(0===e.times.length){i[0]=t;for(let e=0;e<r;e++)o[e]=0;n=0}else if(t<e.times[0]){if(.001>Math.abs(e.times[0]-t))return 0;i[0]=t,i.set(e.times,1),o.set(s.evaluate(t),0),o.set(e.values,r),n=0}else if(t>e.times[e.times.length-1]){if(.001>Math.abs(e.times[e.times.length-1]-t))return e.times.length-1;i[i.length-1]=t,i.set(e.times,0),o.set(e.values,0),o.set(s.evaluate(t),e.values.length),n=i.length-1}else for(let a=0;a<e.times.length;a++){if(.001>Math.abs(e.times[a]-t))return a;if(e.times[a]<t&&e.times[a+1]>t){i.set(e.times.slice(0,a+1),0),i[a+1]=t,i.set(e.times.slice(a+1),a+2),o.set(e.values.slice(0,(a+1)*r),0),o.set(s.evaluate(t),(a+1)*r),o.set(e.values.slice((a+1)*r),(a+2)*r),n=a+1;break}}return e.times=i,e.values=o,n},mergeMorphTargetTracks:function(e,t){let n=[],i={},o=e.tracks;for(let e=0;e<o.length;++e){let s,a=o[e],l=r.Nwf.parseTrackName(a.name),c=r.Nwf.findNode(t,l.nodeName);if("morphTargetInfluences"!==l.propertyName||void 0===l.propertyIndex){n.push(a);continue}if(a.createInterpolant!==a.InterpolantFactoryMethodDiscrete&&a.createInterpolant!==a.InterpolantFactoryMethodLinear){if(a.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),(a=a.clone()).setInterpolation(r.PJ3)}let u=c.morphTargetInfluences.length,h=c.morphTargetDictionary[l.propertyIndex];if(void 0===h)throw Error("THREE.GLTFExporter: Morph target name not found: "+l.propertyIndex);if(void 0===i[c.uuid]){let e=new(s=a.clone()).ValueBufferType(u*s.times.length);for(let t=0;t<s.times.length;t++)e[t*u+h]=s.values[t];s.name=(l.nodeName||"")+".morphTargetInfluences",s.values=e,i[c.uuid]=s,n.push(s);continue}let f=a.createInterpolant(new a.ValueBufferType(1));s=i[c.uuid];for(let e=0;e<s.times.length;e++)s.values[e*u+h]=f.evaluate(s.times[e]);for(let e=0;e<a.times.length;e++){let t=this.insertKeyframe(s,a.times[e]);s.values[t*u+h]=a.values[e]}}return e.tracks=n,e},toFloat32BufferAttribute:function(e){let t=new r.THS(new Float32Array(e.count*e.itemSize),e.itemSize,!1);if(!e.normalized&&!e.isInterleavedBufferAttribute)return t.array.set(e.array),t;for(let n=0,r=e.count;n<r;n++)for(let r=0;r<e.itemSize;r++)t.setComponent(n,r,e.getComponent(n,r));return t}};class _ extends r.aHM{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(e){return new L(e)}),this.register(function(e){return new N(e)}),this.register(function(e){return new K(e)}),this.register(function(e){return new X(e)}),this.register(function(e){return new W(e)}),this.register(function(e){return new H(e)}),this.register(function(e){return new U(e)}),this.register(function(e){return new D(e)}),this.register(function(e){return new z(e)}),this.register(function(e){return new B(e)}),this.register(function(e){return new G(e)}),this.register(function(e){return new F(e)}),this.register(function(e){return new q(e)}),this.register(function(e){return new V(e)}),this.register(function(e){return new C(e)}),this.register(function(e){return new Y(e)}),this.register(function(e){return new J(e)})}load(e,t,n,i){let o,s=this;if(""!==this.resourcePath)o=this.resourcePath;else if(""!==this.path){let t=r.r6x.extractUrlBase(e);o=r.r6x.resolveURL(t,this.path)}else o=r.r6x.extractUrlBase(e);this.manager.itemStart(e);let a=function(t){i?i(t):console.error(t),s.manager.itemError(e),s.manager.itemEnd(e)},l=new r.Y9S(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials),l.load(e,function(n){try{s.parse(n,o,function(n){t(n),s.manager.itemEnd(e)},a)}catch(e){a(e)}},n,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return -1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return -1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,n,r){let i,o={},s={},a=new TextDecoder;if("string"==typeof e)i=JSON.parse(e);else if(e instanceof ArrayBuffer)if(a.decode(new Uint8Array(e,0,4))===Z){try{o[I.KHR_BINARY_GLTF]=new Q(e)}catch(e){r&&r(e);return}i=JSON.parse(o[I.KHR_BINARY_GLTF].content)}else i=JSON.parse(a.decode(e));else i=e;if(void 0===i.asset||i.asset.version[0]<2){r&&r(Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}let l=new eb(i,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){let t=this.pluginCallbacks[e](l);t.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),s[t.name]=t,o[t.name]=!0}if(i.extensionsUsed)for(let e=0;e<i.extensionsUsed.length;++e){let t=i.extensionsUsed[e],n=i.extensionsRequired||[];switch(t){case I.KHR_MATERIALS_UNLIT:o[t]=new j;break;case I.KHR_DRACO_MESH_COMPRESSION:o[t]=new $(i,this.dracoLoader);break;case I.KHR_TEXTURE_TRANSFORM:o[t]=new ee;break;case I.KHR_MESH_QUANTIZATION:o[t]=new et;break;default:n.indexOf(t)>=0&&void 0===s[t]&&console.warn('THREE.GLTFLoader: Unknown extension "'+t+'".')}}l.setExtensions(o),l.setPlugins(s),l.parse(n,r)}parseAsync(e,t){let n=this;return new Promise(function(r,i){n.parse(e,t,r,i)})}}function M(){let e={};return{get:function(t){return e[t]},add:function(t,n){e[t]=n},remove:function(t){delete e[t]},removeAll:function(){e={}}}}let I={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class C{constructor(e){this.parser=e,this.name=I.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){let e=this.parser,t=this.parser.json.nodes||[];for(let n=0,r=t.length;n<r;n++){let r=t[n];r.extensions&&r.extensions[this.name]&&void 0!==r.extensions[this.name].light&&e._addNodeRef(this.cache,r.extensions[this.name].light)}}_loadLight(e){let t,n=this.parser,i="light:"+e,o=n.cache.get(i);if(o)return o;let s=n.json,a=((s.extensions&&s.extensions[this.name]||{}).lights||[])[e],l=new r.Q1f(0xffffff);void 0!==a.color&&l.setRGB(a.color[0],a.color[1],a.color[2],r.Zr2);let c=void 0!==a.range?a.range:0;switch(a.type){case"directional":(t=new r.ZyN(l)).target.position.set(0,0,-1),t.add(t.target);break;case"point":(t=new r.HiM(l)).distance=c;break;case"spot":(t=new r.nCl(l)).distance=c,a.spot=a.spot||{},a.spot.innerConeAngle=void 0!==a.spot.innerConeAngle?a.spot.innerConeAngle:0,a.spot.outerConeAngle=void 0!==a.spot.outerConeAngle?a.spot.outerConeAngle:Math.PI/4,t.angle=a.spot.outerConeAngle,t.penumbra=1-a.spot.innerConeAngle/a.spot.outerConeAngle,t.target.position.set(0,0,-1),t.add(t.target);break;default:throw Error("THREE.GLTFLoader: Unexpected light type: "+a.type)}return t.position.set(0,0,0),ed(t,a),void 0!==a.intensity&&(t.intensity=a.intensity),t.name=n.createUniqueName(a.name||"light_"+e),o=Promise.resolve(t),n.cache.add(i,o),o}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){let t=this,n=this.parser,r=n.json.nodes[e],i=(r.extensions&&r.extensions[this.name]||{}).light;return void 0===i?null:this._loadLight(i).then(function(e){return n._getNodeRef(t.cache,i,e)})}}class j{constructor(){this.name=I.KHR_MATERIALS_UNLIT}getMaterialType(){return r.V9B}extendParams(e,t,n){let i=[];e.color=new r.Q1f(1,1,1),e.opacity=1;let o=t.pbrMetallicRoughness;if(o){if(Array.isArray(o.baseColorFactor)){let t=o.baseColorFactor;e.color.setRGB(t[0],t[1],t[2],r.Zr2),e.opacity=t[3]}void 0!==o.baseColorTexture&&i.push(n.assignTexture(e,"map",o.baseColorTexture,r.er$))}return Promise.all(i)}}class B{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){let n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=n.extensions[this.name].emissiveStrength;return void 0!==r&&(t.emissiveIntensity=r),Promise.resolve()}}class L{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let o=[],s=i.extensions[this.name];if(void 0!==s.clearcoatFactor&&(t.clearcoat=s.clearcoatFactor),void 0!==s.clearcoatTexture&&o.push(n.assignTexture(t,"clearcoatMap",s.clearcoatTexture)),void 0!==s.clearcoatRoughnessFactor&&(t.clearcoatRoughness=s.clearcoatRoughnessFactor),void 0!==s.clearcoatRoughnessTexture&&o.push(n.assignTexture(t,"clearcoatRoughnessMap",s.clearcoatRoughnessTexture)),void 0!==s.clearcoatNormalTexture&&(o.push(n.assignTexture(t,"clearcoatNormalMap",s.clearcoatNormalTexture)),void 0!==s.clearcoatNormalTexture.scale)){let e=s.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new r.I9Y(e,e)}return Promise.all(o)}}class N{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_DISPERSION}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=n.extensions[this.name];return t.dispersion=void 0!==r.dispersion?r.dispersion:0,Promise.resolve()}}class F{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],o=r.extensions[this.name];return void 0!==o.iridescenceFactor&&(t.iridescence=o.iridescenceFactor),void 0!==o.iridescenceTexture&&i.push(n.assignTexture(t,"iridescenceMap",o.iridescenceTexture)),void 0!==o.iridescenceIor&&(t.iridescenceIOR=o.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==o.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),void 0!==o.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),void 0!==o.iridescenceThicknessTexture&&i.push(n.assignTexture(t,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(i)}}class H{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_SHEEN}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let o=[];t.sheenColor=new r.Q1f(0,0,0),t.sheenRoughness=0,t.sheen=1;let s=i.extensions[this.name];if(void 0!==s.sheenColorFactor){let e=s.sheenColorFactor;t.sheenColor.setRGB(e[0],e[1],e[2],r.Zr2)}return void 0!==s.sheenRoughnessFactor&&(t.sheenRoughness=s.sheenRoughnessFactor),void 0!==s.sheenColorTexture&&o.push(n.assignTexture(t,"sheenColorMap",s.sheenColorTexture,r.er$)),void 0!==s.sheenRoughnessTexture&&o.push(n.assignTexture(t,"sheenRoughnessMap",s.sheenRoughnessTexture)),Promise.all(o)}}class U{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],o=r.extensions[this.name];return void 0!==o.transmissionFactor&&(t.transmission=o.transmissionFactor),void 0!==o.transmissionTexture&&i.push(n.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(i)}}class D{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_VOLUME}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let o=[],s=i.extensions[this.name];t.thickness=void 0!==s.thicknessFactor?s.thicknessFactor:0,void 0!==s.thicknessTexture&&o.push(n.assignTexture(t,"thicknessMap",s.thicknessTexture)),t.attenuationDistance=s.attenuationDistance||1/0;let a=s.attenuationColor||[1,1,1];return t.attenuationColor=new r.Q1f().setRGB(a[0],a[1],a[2],r.Zr2),Promise.all(o)}}class z{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_IOR}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=n.extensions[this.name];return t.ior=void 0!==r.ior?r.ior:1.5,Promise.resolve()}}class G{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_SPECULAR}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let o=[],s=i.extensions[this.name];t.specularIntensity=void 0!==s.specularFactor?s.specularFactor:1,void 0!==s.specularTexture&&o.push(n.assignTexture(t,"specularIntensityMap",s.specularTexture));let a=s.specularColorFactor||[1,1,1];return t.specularColor=new r.Q1f().setRGB(a[0],a[1],a[2],r.Zr2),void 0!==s.specularColorTexture&&o.push(n.assignTexture(t,"specularColorMap",s.specularColorTexture,r.er$)),Promise.all(o)}}class V{constructor(e){this.parser=e,this.name=I.EXT_MATERIALS_BUMP}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],o=r.extensions[this.name];return t.bumpScale=void 0!==o.bumpFactor?o.bumpFactor:1,void 0!==o.bumpTexture&&i.push(n.assignTexture(t,"bumpMap",o.bumpTexture)),Promise.all(i)}}class q{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],o=r.extensions[this.name];return void 0!==o.anisotropyStrength&&(t.anisotropy=o.anisotropyStrength),void 0!==o.anisotropyRotation&&(t.anisotropyRotation=o.anisotropyRotation),void 0!==o.anisotropyTexture&&i.push(n.assignTexture(t,"anisotropyMap",o.anisotropyTexture)),Promise.all(i)}}class K{constructor(e){this.parser=e,this.name=I.KHR_TEXTURE_BASISU}loadTexture(e){let t=this.parser,n=t.json,r=n.textures[e];if(!r.extensions||!r.extensions[this.name])return null;let i=r.extensions[this.name],o=t.options.ktx2Loader;if(!o)if(!(n.extensionsRequired&&n.extensionsRequired.indexOf(this.name)>=0))return null;else throw Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return t.loadTextureImage(e,i.source,o)}}class X{constructor(e){this.parser=e,this.name=I.EXT_TEXTURE_WEBP}loadTexture(e){let t=this.name,n=this.parser,r=n.json,i=r.textures[e];if(!i.extensions||!i.extensions[t])return null;let o=i.extensions[t],s=r.images[o.source],a=n.textureLoader;if(s.uri){let e=n.options.manager.getHandler(s.uri);null!==e&&(a=e)}return n.loadTextureImage(e,o.source,a)}}class W{constructor(e){this.parser=e,this.name=I.EXT_TEXTURE_AVIF}loadTexture(e){let t=this.name,n=this.parser,r=n.json,i=r.textures[e];if(!i.extensions||!i.extensions[t])return null;let o=i.extensions[t],s=r.images[o.source],a=n.textureLoader;if(s.uri){let e=n.options.manager.getHandler(s.uri);null!==e&&(a=e)}return n.loadTextureImage(e,o.source,a)}}class Y{constructor(e){this.name=I.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){let t=this.parser.json,n=t.bufferViews[e];if(!n.extensions||!n.extensions[this.name])return null;{let e=n.extensions[this.name],r=this.parser.getDependency("buffer",e.buffer),i=this.parser.options.meshoptDecoder;if(!i||!i.supported)if(!(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0))return null;else throw Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return r.then(function(t){let n=e.byteOffset||0,r=e.byteLength||0,o=e.count,s=e.byteStride,a=new Uint8Array(t,n,r);return i.decodeGltfBufferAsync?i.decodeGltfBufferAsync(o,s,a,e.mode,e.filter).then(function(e){return e.buffer}):i.ready.then(function(){let t=new ArrayBuffer(o*s);return i.decodeGltfBuffer(new Uint8Array(t),o,s,a,e.mode,e.filter),t})})}}}class J{constructor(e){this.name=I.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){let t=this.parser.json,n=t.nodes[e];if(!n.extensions||!n.extensions[this.name]||void 0===n.mesh)return null;for(let e of t.meshes[n.mesh].primitives)if(e.mode!==eo.TRIANGLES&&e.mode!==eo.TRIANGLE_STRIP&&e.mode!==eo.TRIANGLE_FAN&&void 0!==e.mode)return null;let i=n.extensions[this.name].attributes,o=[],s={};for(let e in i)o.push(this.parser.getDependency("accessor",i[e]).then(t=>(s[e]=t,s[e])));return o.length<1?null:(o.push(this.parser.createNodeMesh(e)),Promise.all(o).then(e=>{let t=e.pop(),n=t.isGroup?t.children:[t],i=e[0].count,o=[];for(let e of n){let t=new r.kn4,n=new r.Pq0,a=new r.PTz,l=new r.Pq0(1,1,1),c=new r.ZLX(e.geometry,e.material,i);for(let e=0;e<i;e++)s.TRANSLATION&&n.fromBufferAttribute(s.TRANSLATION,e),s.ROTATION&&a.fromBufferAttribute(s.ROTATION,e),s.SCALE&&l.fromBufferAttribute(s.SCALE,e),c.setMatrixAt(e,t.compose(n,a,l));for(let t in s)if("_COLOR_0"===t){let e=s[t];c.instanceColor=new r.uWO(e.array,e.itemSize,e.normalized)}else"TRANSLATION"!==t&&"ROTATION"!==t&&"SCALE"!==t&&e.geometry.setAttribute(t,s[t]);r.B69.prototype.copy.call(c,e),this.parser.assignFinalMaterial(c),o.push(c)}return t.isGroup?(t.clear(),t.add(...o),t):o[0]}))}}let Z="glTF";class Q{constructor(e){this.name=I.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12),n=new TextDecoder;if(this.header={magic:n.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Z)throw Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw Error("THREE.GLTFLoader: Legacy binary file detected.");const r=this.header.length-12,i=new DataView(e,12);let o=0;for(;o<r;){const t=i.getUint32(o,!0);o+=4;const r=i.getUint32(o,!0);if(o+=4,0x4e4f534a===r){const r=new Uint8Array(e,12+o,t);this.content=n.decode(r)}else if(5130562===r){const n=12+o;this.body=e.slice(n,n+t)}o+=t}if(null===this.content)throw Error("THREE.GLTFLoader: JSON content not found.")}}class ${constructor(e,t){if(!t)throw Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=I.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){let n=this.json,i=this.dracoLoader,o=e.extensions[this.name].bufferView,s=e.extensions[this.name].attributes,a={},l={},c={};for(let e in s)a[eu[e]||e.toLowerCase()]=s[e];for(let t in e.attributes){let r=eu[t]||t.toLowerCase();if(void 0!==s[t]){let i=n.accessors[e.attributes[t]],o=es[i.componentType];c[r]=o.name,l[r]=!0===i.normalized}}return t.getDependency("bufferView",o).then(function(e){return new Promise(function(t,n){i.decodeDracoFile(e,function(e){for(let t in e.attributes){let n=e.attributes[t],r=l[t];void 0!==r&&(n.normalized=r)}t(e)},a,c,r.Zr2,n)})})}}class ee{constructor(){this.name=I.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(void 0===t.texCoord||t.texCoord===e.channel)&&void 0===t.offset&&void 0===t.rotation&&void 0===t.scale||(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class et{constructor(){this.name=I.KHR_MESH_QUANTIZATION}}class en extends r.lGw{constructor(e,t,n,r){super(e,t,n,r)}copySampleValue_(e){let t=this.resultBuffer,n=this.sampleValues,r=this.valueSize,i=e*r*3+r;for(let e=0;e!==r;e++)t[e]=n[i+e];return t}interpolate_(e,t,n,r){let i=this.resultBuffer,o=this.sampleValues,s=this.valueSize,a=2*s,l=3*s,c=r-t,u=(n-t)/c,h=u*u,f=h*u,p=e*l,d=p-l,v=-2*f+3*h,y=f-h,m=1-v,b=y-h+u;for(let e=0;e!==s;e++){let t=o[d+e+s],n=o[d+e+a]*c,r=o[p+e+s],l=o[p+e]*c;i[e]=m*t+b*n+v*r+y*l}return i}}let er=new r.PTz;class ei extends en{interpolate_(e,t,n,r){let i=super.interpolate_(e,t,n,r);return er.fromArray(i).normalize().toArray(i),i}}let eo={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},es={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},ea={9728:r.hxR,9729:r.k6q,9984:r.pHI,9985:r.kRr,9986:r.Cfg,9987:r.$_I},el={33071:r.ghU,33648:r.kTW,10497:r.GJx},ec={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},eu={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},eh={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},ef={CUBICSPLINE:void 0,LINEAR:r.PJ3,STEP:r.ljd};function ep(e,t,n){for(let r in n.extensions)void 0===e[r]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[r]=n.extensions[r])}function ed(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function ev(e){let t="",n=Object.keys(e).sort();for(let r=0,i=n.length;r<i;r++)t+=n[r]+":"+e[n[r]]+";";return t}function ey(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}let em=new r.kn4;class eb{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new M,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let n=!1,i=-1,o=!1,s=-1;if("u">typeof navigator){const e=navigator.userAgent;n=!0===/^((?!chrome|android).)*safari/i.test(e);const t=e.match(/Version\/(\d+)/);i=n&&t?parseInt(t[1],10):-1,s=(o=e.indexOf("Firefox")>-1)?e.match(/Firefox\/([0-9]+)\./)[1]:-1}"u"<typeof createImageBitmap||n&&i<17||o&&s<98?this.textureLoader=new r.Tap(this.options.manager):this.textureLoader=new r.Kzg(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new r.Y9S(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){let n=this,r=this.json,i=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(e){return e._markDefs&&e._markDefs()}),Promise.all(this._invokeAll(function(e){return e.beforeRoot&&e.beforeRoot()})).then(function(){return Promise.all([n.getDependencies("scene"),n.getDependencies("animation"),n.getDependencies("camera")])}).then(function(t){let o={scene:t[0][r.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:r.asset,parser:n,userData:{}};return ep(i,o,r),ed(o,r),Promise.all(n._invokeAll(function(e){return e.afterRoot&&e.afterRoot(o)})).then(function(){for(let e of o.scenes)e.updateMatrixWorld();e(o)})}).catch(t)}_markDefs(){let e=this.json.nodes||[],t=this.json.skins||[],n=this.json.meshes||[];for(let n=0,r=t.length;n<r;n++){let r=t[n].joints;for(let t=0,n=r.length;t<n;t++)e[r[t]].isBone=!0}for(let t=0,r=e.length;t<r;t++){let r=e[t];void 0!==r.mesh&&(this._addNodeRef(this.meshCache,r.mesh),void 0!==r.skin&&(n[r.mesh].isSkinnedMesh=!0)),void 0!==r.camera&&this._addNodeRef(this.cameraCache,r.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,n){if(e.refs[t]<=1)return n;let r=n.clone(),i=(e,t)=>{let n=this.associations.get(e);for(let[r,o]of(null!=n&&this.associations.set(t,n),e.children.entries()))i(o,t.children[r])};return i(n,r),r.name+="_instance_"+e.uses[t]++,r}_invokeOne(e){let t=Object.values(this.plugins);t.push(this);for(let n=0;n<t.length;n++){let r=e(t[n]);if(r)return r}return null}_invokeAll(e){let t=Object.values(this.plugins);t.unshift(this);let n=[];for(let r=0;r<t.length;r++){let i=e(t[r]);i&&n.push(i)}return n}getDependency(e,t){let n=e+":"+t,r=this.cache.get(n);if(!r){switch(e){case"scene":r=this.loadScene(t);break;case"node":r=this._invokeOne(function(e){return e.loadNode&&e.loadNode(t)});break;case"mesh":r=this._invokeOne(function(e){return e.loadMesh&&e.loadMesh(t)});break;case"accessor":r=this.loadAccessor(t);break;case"bufferView":r=this._invokeOne(function(e){return e.loadBufferView&&e.loadBufferView(t)});break;case"buffer":r=this.loadBuffer(t);break;case"material":r=this._invokeOne(function(e){return e.loadMaterial&&e.loadMaterial(t)});break;case"texture":r=this._invokeOne(function(e){return e.loadTexture&&e.loadTexture(t)});break;case"skin":r=this.loadSkin(t);break;case"animation":r=this._invokeOne(function(e){return e.loadAnimation&&e.loadAnimation(t)});break;case"camera":r=this.loadCamera(t);break;default:if(!(r=this._invokeOne(function(n){return n!=this&&n.getDependency&&n.getDependency(e,t)})))throw Error("Unknown type: "+e)}this.cache.add(n,r)}return r}getDependencies(e){let t=this.cache.get(e);if(!t){let n=this;t=Promise.all((this.json[e+("mesh"===e?"es":"s")]||[]).map(function(t,r){return n.getDependency(e,r)})),this.cache.add(e,t)}return t}loadBuffer(e){let t=this.json.buffers[e],n=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[I.KHR_BINARY_GLTF].body);let i=this.options;return new Promise(function(e,o){n.load(r.r6x.resolveURL(t.uri,i.path),e,void 0,function(){o(Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){let t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(e){let n=t.byteLength||0,r=t.byteOffset||0;return e.slice(r,r+n)})}loadAccessor(e){let t=this,n=this.json,i=this.json.accessors[e];if(void 0===i.bufferView&&void 0===i.sparse){let e=ec[i.type],t=es[i.componentType],n=!0===i.normalized,o=new t(i.count*e);return Promise.resolve(new r.THS(o,e,n))}let o=[];return void 0!==i.bufferView?o.push(this.getDependency("bufferView",i.bufferView)):o.push(null),void 0!==i.sparse&&(o.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),o.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(o).then(function(e){let o,s,a=e[0],l=ec[i.type],c=es[i.componentType],u=c.BYTES_PER_ELEMENT,h=u*l,f=i.byteOffset||0,p=void 0!==i.bufferView?n.bufferViews[i.bufferView].byteStride:void 0,d=!0===i.normalized;if(p&&p!==h){let e=Math.floor(f/p),n="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+e+":"+i.count,h=t.cache.get(n);h||(o=new c(a,e*p,i.count*p/u),h=new r.eB$(o,p/u),t.cache.add(n,h)),s=new r.eHs(h,l,f%p/u,d)}else o=null===a?new c(i.count*l):new c(a,f,i.count*l),s=new r.THS(o,l,d);if(void 0!==i.sparse){let t=ec.SCALAR,n=es[i.sparse.indices.componentType],o=i.sparse.indices.byteOffset||0,u=i.sparse.values.byteOffset||0,h=new n(e[1],o,i.sparse.count*t),f=new c(e[2],u,i.sparse.count*l);null!==a&&(s=new r.THS(s.array.slice(),s.itemSize,s.normalized)),s.normalized=!1;for(let e=0,t=h.length;e<t;e++){let t=h[e];if(s.setX(t,f[e*l]),l>=2&&s.setY(t,f[e*l+1]),l>=3&&s.setZ(t,f[e*l+2]),l>=4&&s.setW(t,f[e*l+3]),l>=5)throw Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}s.normalized=d}return s})}loadTexture(e){let t=this.json,n=this.options,r=t.textures[e].source,i=t.images[r],o=this.textureLoader;if(i.uri){let e=n.manager.getHandler(i.uri);null!==e&&(o=e)}return this.loadTextureImage(e,r,o)}loadTextureImage(e,t,n){let i=this,o=this.json,s=o.textures[e],a=o.images[t],l=(a.uri||a.bufferView)+":"+s.sampler;if(this.textureCache[l])return this.textureCache[l];let c=this.loadImageSource(t,n).then(function(t){t.flipY=!1,t.name=s.name||a.name||"",""===t.name&&"string"==typeof a.uri&&!1===a.uri.startsWith("data:image/")&&(t.name=a.uri);let n=(o.samplers||{})[s.sampler]||{};return t.magFilter=ea[n.magFilter]||r.k6q,t.minFilter=ea[n.minFilter]||r.$_I,t.wrapS=el[n.wrapS]||r.GJx,t.wrapT=el[n.wrapT]||r.GJx,t.generateMipmaps=!t.isCompressedTexture&&t.minFilter!==r.hxR&&t.minFilter!==r.k6q,i.associations.set(t,{textures:e}),t}).catch(function(){return null});return this.textureCache[l]=c,c}loadImageSource(e,t){let n=this.json,i=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then(e=>e.clone());let o=n.images[e],s=self.URL||self.webkitURL,a=o.uri||"",l=!1;if(void 0!==o.bufferView)a=this.getDependency("bufferView",o.bufferView).then(function(e){l=!0;let t=new Blob([e],{type:o.mimeType});return a=s.createObjectURL(t)});else if(void 0===o.uri)throw Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");let c=Promise.resolve(a).then(function(e){return new Promise(function(n,o){let s=n;!0===t.isImageBitmapLoader&&(s=function(e){let t=new r.gPd(e);t.needsUpdate=!0,n(t)}),t.load(r.r6x.resolveURL(e,i.path),s,void 0,o)})}).then(function(e){var t;return!0===l&&s.revokeObjectURL(a),ed(e,o),e.userData.mimeType=o.mimeType||((t=o.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":t.search(/\.ktx2($|\?)/i)>0||0===t.search(/^data\:image\/ktx2/)?"image/ktx2":"image/png"),e}).catch(function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",a),e});return this.sourceCache[e]=c,c}assignTexture(e,t,n,r){let i=this;return this.getDependency("texture",n.index).then(function(o){if(!o)return null;if(void 0!==n.texCoord&&n.texCoord>0&&((o=o.clone()).channel=n.texCoord),i.extensions[I.KHR_TEXTURE_TRANSFORM]){let e=void 0!==n.extensions?n.extensions[I.KHR_TEXTURE_TRANSFORM]:void 0;if(e){let t=i.associations.get(o);o=i.extensions[I.KHR_TEXTURE_TRANSFORM].extendTexture(o,e),i.associations.set(o,t)}}return void 0!==r&&(o.colorSpace=r),e[t]=o,o})}assignFinalMaterial(e){let t=e.geometry,n=e.material,i=void 0===t.attributes.tangent,o=void 0!==t.attributes.color,s=void 0===t.attributes.normal;if(e.isPoints){let e="PointsMaterial:"+n.uuid,t=this.cache.get(e);t||(t=new r.BH$,r.imn.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,t.sizeAttenuation=!1,this.cache.add(e,t)),n=t}else if(e.isLine){let e="LineBasicMaterial:"+n.uuid,t=this.cache.get(e);t||(t=new r.mrM,r.imn.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,this.cache.add(e,t)),n=t}if(i||o||s){let e="ClonedMaterial:"+n.uuid+":";i&&(e+="derivative-tangents:"),o&&(e+="vertex-colors:"),s&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=n.clone(),o&&(t.vertexColors=!0),s&&(t.flatShading=!0),i&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(n))),n=t}e.material=n}getMaterialType(){return r._4j}loadMaterial(e){let t,n=this,i=this.json,o=this.extensions,s=i.materials[e],a={},l=s.extensions||{},c=[];if(l[I.KHR_MATERIALS_UNLIT]){let e=o[I.KHR_MATERIALS_UNLIT];t=e.getMaterialType(),c.push(e.extendParams(a,s,n))}else{let i=s.pbrMetallicRoughness||{};if(a.color=new r.Q1f(1,1,1),a.opacity=1,Array.isArray(i.baseColorFactor)){let e=i.baseColorFactor;a.color.setRGB(e[0],e[1],e[2],r.Zr2),a.opacity=e[3]}void 0!==i.baseColorTexture&&c.push(n.assignTexture(a,"map",i.baseColorTexture,r.er$)),a.metalness=void 0!==i.metallicFactor?i.metallicFactor:1,a.roughness=void 0!==i.roughnessFactor?i.roughnessFactor:1,void 0!==i.metallicRoughnessTexture&&(c.push(n.assignTexture(a,"metalnessMap",i.metallicRoughnessTexture)),c.push(n.assignTexture(a,"roughnessMap",i.metallicRoughnessTexture))),t=this._invokeOne(function(t){return t.getMaterialType&&t.getMaterialType(e)}),c.push(Promise.all(this._invokeAll(function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,a)})))}!0===s.doubleSided&&(a.side=r.$EB);let u=s.alphaMode||"OPAQUE";if("BLEND"===u?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,"MASK"===u&&(a.alphaTest=void 0!==s.alphaCutoff?s.alphaCutoff:.5)),void 0!==s.normalTexture&&t!==r.V9B&&(c.push(n.assignTexture(a,"normalMap",s.normalTexture)),a.normalScale=new r.I9Y(1,1),void 0!==s.normalTexture.scale)){let e=s.normalTexture.scale;a.normalScale.set(e,e)}if(void 0!==s.occlusionTexture&&t!==r.V9B&&(c.push(n.assignTexture(a,"aoMap",s.occlusionTexture)),void 0!==s.occlusionTexture.strength&&(a.aoMapIntensity=s.occlusionTexture.strength)),void 0!==s.emissiveFactor&&t!==r.V9B){let e=s.emissiveFactor;a.emissive=new r.Q1f().setRGB(e[0],e[1],e[2],r.Zr2)}return void 0!==s.emissiveTexture&&t!==r.V9B&&c.push(n.assignTexture(a,"emissiveMap",s.emissiveTexture,r.er$)),Promise.all(c).then(function(){let r=new t(a);return s.name&&(r.name=s.name),ed(r,s),n.associations.set(r,{materials:e}),s.extensions&&ep(o,r,s),r})}createUniqueName(e){let t=r.Nwf.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){let t=this,n=this.extensions,i=this.primitiveCache,o=[];for(let s=0,a=e.length;s<a;s++){let a=e[s],l=function(e){let t,n=e.extensions&&e.extensions[I.KHR_DRACO_MESH_COMPRESSION];if(t=n?"draco:"+n.bufferView+":"+n.indices+":"+ev(n.attributes):e.indices+":"+ev(e.attributes)+":"+e.mode,void 0!==e.targets)for(let n=0,r=e.targets.length;n<r;n++)t+=":"+ev(e.targets[n]);return t}(a),c=i[l];if(c)o.push(c.promise);else{let e;e=a.extensions&&a.extensions[I.KHR_DRACO_MESH_COMPRESSION]?function(e){return n[I.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then(function(n){return eg(n,e,t)})}(a):eg(new r.LoY,a,t),i[l]={primitive:a,promise:e},o.push(e)}}return Promise.all(o)}loadMesh(e){let t=this,n=this.json,i=this.extensions,o=n.meshes[e],s=o.primitives,a=[];for(let e=0,t=s.length;e<t;e++){var l;let t=void 0===s[e].material?(void 0===(l=this.cache).DefaultMaterial&&(l.DefaultMaterial=new r._4j({color:0xffffff,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:r.hB5})),l.DefaultMaterial):this.getDependency("material",s[e].material);a.push(t)}return a.push(t.loadGeometries(s)),Promise.all(a).then(function(n){let a=n.slice(0,n.length-1),l=n[n.length-1],c=[];for(let n=0,u=l.length;n<u;n++){let u,h=l[n],f=s[n],p=a[n];if(f.mode===eo.TRIANGLES||f.mode===eo.TRIANGLE_STRIP||f.mode===eo.TRIANGLE_FAN||void 0===f.mode)!0===(u=!0===o.isSkinnedMesh?new r.I46(h,p):new r.eaF(h,p)).isSkinnedMesh&&u.normalizeSkinWeights(),f.mode===eo.TRIANGLE_STRIP?u.geometry=A(u.geometry,r.O49):f.mode===eo.TRIANGLE_FAN&&(u.geometry=A(u.geometry,r.rYR));else if(f.mode===eo.LINES)u=new r.DXC(h,p);else if(f.mode===eo.LINE_STRIP)u=new r.N1A(h,p);else if(f.mode===eo.LINE_LOOP)u=new r.FCc(h,p);else if(f.mode===eo.POINTS)u=new r.ONl(h,p);else throw Error("THREE.GLTFLoader: Primitive mode unsupported: "+f.mode);Object.keys(u.geometry.morphAttributes).length>0&&function(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let n=0,r=t.weights.length;n<r;n++)e.morphTargetInfluences[n]=t.weights[n];if(t.extras&&Array.isArray(t.extras.targetNames)){let n=t.extras.targetNames;if(e.morphTargetInfluences.length===n.length){e.morphTargetDictionary={};for(let t=0,r=n.length;t<r;t++)e.morphTargetDictionary[n[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}(u,o),u.name=t.createUniqueName(o.name||"mesh_"+e),ed(u,o),f.extensions&&ep(i,u,f),t.assignFinalMaterial(u),c.push(u)}for(let n=0,r=c.length;n<r;n++)t.associations.set(c[n],{meshes:e,primitives:n});if(1===c.length)return o.extensions&&ep(i,c[0],o),c[0];let u=new r.YJl;o.extensions&&ep(i,u,o),t.associations.set(u,{meshes:e});for(let e=0,t=c.length;e<t;e++)u.add(c[e]);return u})}loadCamera(e){let t,n=this.json.cameras[e],i=n[n.type];return i?("perspective"===n.type?t=new r.ubm(r.cj9.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):"orthographic"===n.type&&(t=new r.qUd(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),n.name&&(t.name=this.createUniqueName(n.name)),ed(t,n),Promise.resolve(t)):void console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){let t=this.json.skins[e],n=[];for(let e=0,r=t.joints.length;e<r;e++)n.push(this._loadNodeShallow(t.joints[e]));return void 0!==t.inverseBindMatrices?n.push(this.getDependency("accessor",t.inverseBindMatrices)):n.push(null),Promise.all(n).then(function(e){let n=e.pop(),i=[],o=[];for(let s=0,a=e.length;s<a;s++){let a=e[s];if(a){i.push(a);let e=new r.kn4;null!==n&&e.fromArray(n.array,16*s),o.push(e)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[s])}return new r.EAD(i,o)})}loadAnimation(e){let t=this.json,n=this,i=t.animations[e],o=i.name?i.name:"animation_"+e,s=[],a=[],l=[],c=[],u=[];for(let e=0,t=i.channels.length;e<t;e++){let t=i.channels[e],n=i.samplers[t.sampler],r=t.target,o=r.node,h=void 0!==i.parameters?i.parameters[n.input]:n.input,f=void 0!==i.parameters?i.parameters[n.output]:n.output;void 0!==r.node&&(s.push(this.getDependency("node",o)),a.push(this.getDependency("accessor",h)),l.push(this.getDependency("accessor",f)),c.push(n),u.push(r))}return Promise.all([Promise.all(s),Promise.all(a),Promise.all(l),Promise.all(c),Promise.all(u)]).then(function(e){let t=e[0],s=e[1],a=e[2],l=e[3],c=e[4],u=[];for(let e=0,r=t.length;e<r;e++){let r=t[e],i=s[e],o=a[e],h=l[e],f=c[e];if(void 0===r)continue;r.updateMatrix&&r.updateMatrix();let p=n._createAnimationTracks(r,i,o,h,f);if(p)for(let e=0;e<p.length;e++)u.push(p[e])}let h=new r.tz3(o,void 0,u);return ed(h,i),h})}createNodeMesh(e){let t=this.json,n=this,r=t.nodes[e];return void 0===r.mesh?null:n.getDependency("mesh",r.mesh).then(function(e){let t=n._getNodeRef(n.meshCache,r.mesh,e);return void 0!==r.weights&&t.traverse(function(e){if(e.isMesh)for(let t=0,n=r.weights.length;t<n;t++)e.morphTargetInfluences[t]=r.weights[t]}),t})}loadNode(e){let t=this.json.nodes[e],n=this._loadNodeShallow(e),r=[],i=t.children||[];for(let e=0,t=i.length;e<t;e++)r.push(this.getDependency("node",i[e]));let o=void 0===t.skin?Promise.resolve(null):this.getDependency("skin",t.skin);return Promise.all([n,Promise.all(r),o]).then(function(e){let t=e[0],n=e[1],r=e[2];null!==r&&t.traverse(function(e){e.isSkinnedMesh&&e.bind(r,em)});for(let e=0,r=n.length;e<r;e++)t.add(n[e]);return t})}_loadNodeShallow(e){let t=this.json,n=this.extensions,i=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];let o=t.nodes[e],s=o.name?i.createUniqueName(o.name):"",a=[],l=i._invokeOne(function(t){return t.createNodeMesh&&t.createNodeMesh(e)});return l&&a.push(l),void 0!==o.camera&&a.push(i.getDependency("camera",o.camera).then(function(e){return i._getNodeRef(i.cameraCache,o.camera,e)})),i._invokeAll(function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)}).forEach(function(e){a.push(e)}),this.nodeCache[e]=Promise.all(a).then(function(t){let a;if((a=!0===o.isBone?new r.$Kf:t.length>1?new r.YJl:1===t.length?t[0]:new r.B69)!==t[0])for(let e=0,n=t.length;e<n;e++)a.add(t[e]);if(o.name&&(a.userData.name=o.name,a.name=s),ed(a,o),o.extensions&&ep(n,a,o),void 0!==o.matrix){let e=new r.kn4;e.fromArray(o.matrix),a.applyMatrix4(e)}else void 0!==o.translation&&a.position.fromArray(o.translation),void 0!==o.rotation&&a.quaternion.fromArray(o.rotation),void 0!==o.scale&&a.scale.fromArray(o.scale);if(i.associations.has(a)){if(void 0!==o.mesh&&i.meshCache.refs[o.mesh]>1){let e=i.associations.get(a);i.associations.set(a,{...e})}}else i.associations.set(a,{});return i.associations.get(a).nodes=e,a}),this.nodeCache[e]}loadScene(e){let t=this.extensions,n=this.json.scenes[e],i=this,o=new r.YJl;n.name&&(o.name=i.createUniqueName(n.name)),ed(o,n),n.extensions&&ep(t,o,n);let s=n.nodes||[],a=[];for(let e=0,t=s.length;e<t;e++)a.push(i.getDependency("node",s[e]));return Promise.all(a).then(function(e){for(let t=0,n=e.length;t<n;t++)o.add(e[t]);return i.associations=(e=>{let t=new Map;for(let[e,n]of i.associations)(e instanceof r.imn||e instanceof r.gPd)&&t.set(e,n);return e.traverse(e=>{let n=i.associations.get(e);null!=n&&t.set(e,n)}),t})(o),o})}_createAnimationTracks(e,t,n,i,o){let s,a=[],l=e.name?e.name:e.uuid,c=[];switch(eh[o.path]===eh.weights?e.traverse(function(e){e.morphTargetInfluences&&c.push(e.name?e.name:e.uuid)}):c.push(l),eh[o.path]){case eh.weights:s=r.Hit;break;case eh.rotation:s=r.MBL;break;case eh.translation:case eh.scale:s=r.RiT;break;default:s=1===n.itemSize?r.Hit:r.RiT}let u=void 0!==i.interpolation?ef[i.interpolation]:r.PJ3,h=this._getArrayFromAccessor(n);for(let e=0,n=c.length;e<n;e++){let n=new s(c[e]+"."+eh[o.path],t.array,h,u);"CUBICSPLINE"===i.interpolation&&this._createCubicSplineTrackInterpolant(n),a.push(n)}return a}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){let e=ey(t.constructor),n=new Float32Array(t.length);for(let r=0,i=t.length;r<i;r++)n[r]=t[r]*e;t=n}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof r.MBL?ei:en)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function eg(e,t,n){let i=t.attributes,o=[];for(let t in i){let r=eu[t]||t.toLowerCase();r in e.attributes||o.push(function(t,r){return n.getDependency("accessor",t).then(function(t){e.setAttribute(r,t)})}(i[t],r))}if(void 0!==t.indices&&!e.index){let r=n.getDependency("accessor",t.indices).then(function(t){e.setIndex(t)});o.push(r)}return r.ppV.workingColorSpace!==r.Zr2&&"COLOR_0"in i&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${r.ppV.workingColorSpace}" not supported.`),ed(e,t),!function(e,t,n){let i=t.attributes,o=new r.NRn;if(void 0===i.POSITION)return;{let e=n.json.accessors[i.POSITION],t=e.min,s=e.max;if(void 0===t||void 0===s)return console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(o.set(new r.Pq0(t[0],t[1],t[2]),new r.Pq0(s[0],s[1],s[2])),e.normalized){let t=ey(es[e.componentType]);o.min.multiplyScalar(t),o.max.multiplyScalar(t)}}let s=t.targets;if(void 0!==s){let e=new r.Pq0,t=new r.Pq0;for(let r=0,i=s.length;r<i;r++){let i=s[r];if(void 0!==i.POSITION){let r=n.json.accessors[i.POSITION],o=r.min,s=r.max;if(void 0!==o&&void 0!==s){if(t.setX(Math.max(Math.abs(o[0]),Math.abs(s[0]))),t.setY(Math.max(Math.abs(o[1]),Math.abs(s[1]))),t.setZ(Math.max(Math.abs(o[2]),Math.abs(s[2]))),r.normalized){let e=ey(es[r.componentType]);t.multiplyScalar(e)}e.max(t)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}o.expandByVector(e)}e.boundingBox=o;let a=new r.iyt;o.getCenter(a.center),a.radius=o.min.distanceTo(o.max)/2,e.boundingSphere=a}(e,t,n),Promise.all(o).then(function(){return void 0!==t.targets?function(e,t,n){let r=!1,i=!1,o=!1;for(let e=0,n=t.length;e<n;e++){let n=t[e];if(void 0!==n.POSITION&&(r=!0),void 0!==n.NORMAL&&(i=!0),void 0!==n.COLOR_0&&(o=!0),r&&i&&o)break}if(!r&&!i&&!o)return Promise.resolve(e);let s=[],a=[],l=[];for(let c=0,u=t.length;c<u;c++){let u=t[c];if(r){let t=void 0!==u.POSITION?n.getDependency("accessor",u.POSITION):e.attributes.position;s.push(t)}if(i){let t=void 0!==u.NORMAL?n.getDependency("accessor",u.NORMAL):e.attributes.normal;a.push(t)}if(o){let t=void 0!==u.COLOR_0?n.getDependency("accessor",u.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(s),Promise.all(a),Promise.all(l)]).then(function(t){let n=t[0],s=t[1],a=t[2];return r&&(e.morphAttributes.position=n),i&&(e.morphAttributes.normal=s),o&&(e.morphAttributes.color=a),e.morphTargetsRelative=!0,e})}(e,t.targets,n):e})}var ew=n("./src/model/physics/constants.ts"),ek=console.error;function ex(e){new o().parse(e,function(e){var t,n,r;console.log(e),t=e,n="scene.gltf",(r=document.createElement("a")).setAttribute("href","data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(t))),r.setAttribute("download",n),document.body.appendChild(r),r.click(),r.remove()},ek)}function eT(e,t){new _().load(e,function(n){n.scene.scale.set(ew.R/.5,ew.R/.5,ew.R/.5),n.scene.matrixAutoUpdate=!1,n.scene.updateMatrix(),n.scene.updateMatrixWorld(),n.scene.name=e,t(n)},function(t){return console.log(e+" "+t.loaded+" bytes loaded")},ek)}},"./src/utils/rack.ts"(e,t,n){n.d(t,{m:()=>h});var r=n("./src/model/ball.ts"),i=n("./src/utils/snookerconfig.ts"),o=n("./src/view/tablegeometry.ts"),s=n("./src/view/pocketgeometry.ts"),a=n("./node_modules/three/build/three.core.js"),l=n("./src/utils/utils.ts"),c=n("./src/model/physics/constants.ts");function u(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var h=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"jitter",value:function(e){return(0,l.ld)(e.clone().add(new a.Pq0(t.noise*(Math.random()-.5),t.noise*(Math.random()-.5),0)))}},{key:"cueBall",value:function(e,n){return new r.c(t.jitter(e),0xfaebd7,n)}},{key:"swapBallPositions",value:function(e,t){var n=e.pos.clone();e.pos.copy(t.pos),t.pos.copy(n)}},{key:"diamond",value:function(){var e=new a.Pq0(o.P.tableX/2,0,0),n=[],i=function(e,n,i){return new r.c(t.jitter(e),n,i)};return n.push(t.cueBall(t.spot)),n.push(i(e,t.BALL_COLORS[1],1)),e.add(t.diagonal),n.push(i(e,t.BALL_COLORS[2],2)),e.sub(t.across),n.push(i(e,t.BALL_COLORS[3],3)),e.add(t.diagonal),n.push(i(e,t.BALL_COLORS[4],4)),e.sub(t.across),n.push(i(e,t.BALL_COLORS[5],5)),e.addScaledVector(t.across,2),n.push(i(e,t.BALL_COLORS[6],6)),e.add(t.diagonal).sub(t.across),n.push(i(e,t.BALL_COLORS[7],7)),e.sub(t.across),n.push(i(e,t.BALL_COLORS[8],8)),e.add(t.diagonal),n.push(i(e,t.BALL_COLORS[9],9)),t.swapBallPositions(n[4],n[9]),n}},{key:"triangle",value:function(){var e=t.trianglePositions(),n=[];return n.push(t.cueBall(t.spot)),e.forEach(function(e,i){var o=i+1;n.push(new r.c(t.jitter(e),t.BALL_COLORS[o],o))}),t.swapBallPositions(n[4],n[9]),n}},{key:"trianglePositions",value:function(){var e=[],t=new a.Pq0(o.P.X/2,0,0);return e.push((0,l.t6)(t)),t.add(this.diagonal),e.push((0,l.t6)(t)),t.sub(this.across),e.push((0,l.t6)(t)),t.add(this.diagonal),e.push((0,l.t6)(t)),t.sub(this.across),e.push((0,l.t6)(t)),t.addScaledVector(this.across,2),e.push((0,l.t6)(t)),t.add(this.diagonal),e.push((0,l.t6)(t)),t.sub(this.across),e.push((0,l.t6)(t)),t.sub(this.across),e.push((0,l.t6)(t)),t.sub(this.across),e.push((0,l.t6)(t)),t.add(this.diagonal).sub(this.across),e.push((0,l.t6)(t)),t.add(this.across),e.push((0,l.t6)(t)),t.add(this.across),e.push((0,l.t6)(t)),t.add(this.across),e.push((0,l.t6)(t)),t.add(this.across),e.push((0,l.t6)(t)),e}},{key:"rerack",value:function(e,n){var i=t.trianglePositions(),o=i.shift();n.balls.filter(function(e){return e!==n.cueball}).filter(function(t){return t!==e}).forEach(function(e){e.pos.copy(t.jitter(i.shift())),e.state=r.U.Stationary}),n.overlapsAny(e.pos,e)&&e.pos.copy(o),n.overlapsAny(n.cueball.pos)&&n.cueball.pos.copy(t.spot)}},{key:"three",value:function(){var e=[],n=o.P.X/2,i=o.P.Y/4;return e.push(t.cueBall(t.jitter(new a.Pq0(-n,-i,0)))),e.push(new r.c(t.jitter(new a.Pq0(-n,0,0)),0xe0de36)),e.push(new r.c(t.jitter(new a.Pq0(n,0,0)),0xff0000)),e}},{key:"snooker",value:function(){var e=[],n=o.P.Y/4;e.push(t.cueBall(t.jitter(new a.Pq0(t.baulk,-(.5*n),0))));var l=t.snookerColourPositions();e.push(new r.c(t.jitter(l[0]),0xeede36)),e.push(new r.c(t.jitter(l[1]),824932)),e.push(new r.c(t.jitter(l[2]),0xbd723a)),e.push(new r.c(t.jitter(l[3]),558062)),e.push(new r.c(t.jitter(l[4]),0xffaacc)),e.push(new r.c(t.jitter(l[5]),65793));var u=Math.min(i.U.reds,15),h=t.trianglePositions().slice(0,15),f=s.f.pockets.pocketS.pocket.pos;return h.forEach(function(n,i){var o=new r.c(t.jitter(n.add(t.down)),0xee0000);i>=u&&(o.pos.copy(f),o.pos.setZ(-8.5*c.R),o.state=r.U.InPocket),e.push(o)}),e}},{key:"snookerColourPositions",value:function(){var e=o.P.X/2,n=o.P.X-2*o.P.X/11,r=[];return r.push(new a.Pq0(t.baulk,-t.sixth,0)),r.push(new a.Pq0(t.baulk,t.sixth,0)),r.push(new a.Pq0(t.baulk,0,0)),r.push(new a.Pq0(0,0,0)),r.push(new a.Pq0(e,0,0)),r.push(new a.Pq0(n,0,0)),r}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();u(h,"noise",.0233*c.R),u(h,"gap",2*c.R+2*h.noise),u(h,"up",new a.Pq0(0,0,-1)),u(h,"spot",new a.Pq0(-o.P.X/2,0,0)),u(h,"across",new a.Pq0(0,h.gap,0)),u(h,"down",new a.Pq0(h.gap,0,0)),u(h,"diagonal",h.across.clone().applyAxisAngle(h.up,Math.PI/3)),u(h,"BALL_COLORS",["#FFFFFF","#ffd900","#0000FF","#FF0000","#800080","#ff3300","#008000","#600000","#000000","#FFFF00","#0000FF","#FF0000","#800080","#FF8000","#008000","#600000"]),u(h,"sixth",2*o.P.Y/6),u(h,"baulk",-1.5*o.P.X*2/5)},"./src/utils/replay-encoder.ts"(e,t,n){n.d(t,{k:()=>i});var r=n("./node_modules/jsoncrush/JSONCrush.js"),i=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"fullyEncodeURI",value:function(e){return encodeURIComponent(e).replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/!/g,"%21").replace(/\*/g,"%2A")}},{key:"crush",value:function(e){return r.A.crush(e)}},{key:"createState",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5?arguments[5]:void 0,s={init:e,shots:t,start:n,now:Date.now(),score:r,wholeGame:i,v:1};return o&&(s.players=o),s}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/utils/respot.ts"(e,t,n){n.d(t,{k:()=>l});var r=n("./src/model/ball.ts"),i=n("./src/view/tablegeometry.ts"),o=n("./src/model/physics/constants.ts"),s=n("./src/utils/rack.ts"),a=n("./node_modules/three/build/three.core.js"),l=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"nineBall",value:function(e){var n=e.balls.find(function(e){return 9===e.id});if(n){var r=new a.Pq0(i.P.tableX/2,0,0);t.respotBehind(r,n,e)}}},{key:"respot",value:function(e,n){var i=s.m.snookerColourPositions();return i.push(i[e.id-1]),i.reverse(),i.some(function(t){return!n.overlapsAny(t,e)&&(e.pos.copy(t),e.state=r.U.Stationary,!0)})||t.respotBehind(i[0],e,n),e}},{key:"respotBehind",value:function(e,t,n){for(var s=e.clone();s.x<i.P.tableX&&n.overlapsAny(s,t);)s.x+=o.R/8;for(;s.x>-i.P.tableX&&n.overlapsAny(s,t);)s.x-=o.R/8;t.pos.copy(s),t.state=r.U.Stationary}},{key:"closest",value:function(e,t){var n=t.filter(function(e){return e.onTable()}).filter(function(t){return t!==e});if(0!==n.length){var r=function(t){return e.pos.distanceTo(t.pos)};return n.reduce(function(e,t){return r(e)<r(t)?e:t},n[0])}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/utils/snookerconfig.ts"(e,t,n){n.d(t,{U:()=>r});var r={reds:15}},"./src/utils/threecushionconfig.ts"(e,t,n){n.d(t,{Y:()=>r});var r={raceTo:7}},"./src/utils/utils.ts"(e,t,n){n.d(t,{Dz:()=>v,F8:()=>w,FP:()=>b,KM:()=>u,RZ:()=>x,gn:()=>k,hs:()=>a,ld:()=>m,n7:()=>g,oN:()=>T,rq:()=>d,t6:()=>l,up:()=>s,v_:()=>o,xb:()=>f});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/events/eventtype.ts"),o=new r.Pq0(0,0,0),s=new r.Pq0(0,0,1);function a(e){return!e.entries.some(function(e){return e.event.type===i.B.AIM})}function l(e){return new r.Pq0(e.x,e.y,e.z)}var c=new r.Pq0;function u(e){return c.copy(s).cross(e)}var h=new r.Pq0;function f(e){return h.copy(e).normalize()}var p=new r.Pq0;function d(e,t){return 0>=p.copy(e).add(t).dot(e)}function v(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new r.Pq0;return t.set(1,0,0).applyAxisAngle(s,e)}function y(e){return Math.sign(e)*Math.floor((Math.abs(e)+Number.EPSILON)*1e4)/1e4}function m(e){return e.x=y(e.x),e.y=y(e.y),e.z=y(e.z),e}function b(e,t){return Math.fround(Math.atan2(e,t))}function g(e,t){return Math.fround(Math.pow(e,t))}function w(e){return Math.fround(Math.sin(e))}function k(e){return Math.fround(Math.cos(e))}function x(e){return Math.fround(Math.sqrt(e))}function T(e){return Math.fround(Math.exp(e))}},"./src/view/assets.ts"(e,t,n){n.d(t,{s:()=>y});var r=n("./src/controller/rules/rulefactory.ts"),i=n("./src/utils/gltf.ts"),o=n("./node_modules/three/build/three.core.js");function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");s(this,"listener",void 0),s(this,"audioLoader",void 0),s(this,"ballcollision",void 0),s(this,"cue",void 0),s(this,"cushion",void 0),s(this,"pot",void 0),s(this,"success",void 0),s(this,"lastOutcomeTime",0),s(this,"loadAssets",void 0),this.loadAssets=e,e&&(this.listener=new o.Pf$,this.audioLoader=new o.Am1,this.ballcollision=new o.fP5(this.listener),this.load("sounds/ballcollision.ogg",this.ballcollision),this.cue=new o.fP5(this.listener),this.load("sounds/cue.ogg",this.cue),this.cushion=new o.fP5(this.listener),this.load("sounds/cushion.ogg",this.cushion),this.pot=new o.fP5(this.listener),this.load("sounds/pot.ogg",this.pot),this.success=new o.fP5(this.listener),this.load("sounds/success.ogg",this.success))}return e=[{key:"addCameraToListener",value:function(e){e.add(this.listener)}},{key:"load",value:function(e,t){this.audioLoader.load(e,function(e){t.setBuffer(e),t.setLoop(!1)},function(e){},function(e){})}},{key:"play",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(this.loadAssets){var r,i,s=o.UtX.getContext();if((null==s?void 0:s.state)==="suspended"){(null==(i=navigator)||null==(r=i.userActivation)?void 0:r.hasBeenActive)&&s.resume();return}e.setVolume(t),e.isPlaying&&e.stop(),e.play(o.cj9.randFloat(0,.01)),e.setDetune(n)}}},{key:"outcomeToSound",value:function(e){"Collision"===e.type&&this.play(this.ballcollision,e.incidentSpeed/80,5*e.incidentSpeed),"Pot"===e.type&&this.play(this.pot,e.incidentSpeed/10,-1e3+10*e.incidentSpeed),"Cushion"===e.type&&this.play(this.cushion,e.incidentSpeed/70),"Hit"===e.type&&this.play(this.cue,e.incidentSpeed/30)}},{key:"processOutcomes",value:function(e){var t=this;e.every(function(e){return!(e.timestamp>t.lastOutcomeTime)||(t.lastOutcomeTime=e.timestamp,t.outcomeToSound(e),!1)})}},{key:"playNotify",value:function(){this.play(this.pot,1)}},{key:"playSuccess",value:function(e){this.play(this.success,.1,100*e-2200)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),l=n("./src/view/tablegeometry.ts"),c=n("./src/view/pocketgeometry.ts"),u=n("./src/model/physics/constants.ts");function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var f=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");h(this,"logger",function(e){}),h(this,"cloth",new o.tXL({color:4478393,wireframe:!1,flatShading:!0,transparent:!1})),h(this,"cushion",new o.tXL({color:5531065,wireframe:!1,flatShading:!0,transparent:!1})),h(this,"pocket",new o.tXL({color:4478361,wireframe:!1,flatShading:!0,transparent:!0,opacity:.3}))}return e=[{key:"generateTable",value:function(e){var t=this,n=new o.YJl,r=new o.HiM(0xf0f0e8,22);if(r.position.set(0,0,50*u.R),n.add(r),this.addCushions(n,e),e){c.f.knuckles.forEach(function(e){return t.knuckleCylinder(e,n)}),c.f.pocketCenters.forEach(function(e){return t.knuckleCylinder(e,n,t.pocket)});var i=c.f.pockets.pocketNW.pocket,s=c.f.pockets.pocketNW.knuckleNE;this.logger("knuckle-pocket gap = "+(i.pos.distanceTo(s.pos)-i.radius-s.radius))}return n}},{key:"knuckleCylinder",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.cloth;this.cylinder(e.pos,e.radius,.75*u.R/.5,t,n).position.setZ(-(.25*u.R)/.5/2)}},{key:"cylinder",value:function(e,n,r,i,s){var a="".concat(n,"_").concat(r),l=t.cylinderCache.get(a);l||(l=new o.Ho_(n,n,r,16),t.cylinderCache.set(a,l));var c=new o.eaF(l,s);return c.position.copy(e),c.rotation.x=Math.PI/2,i.add(c),c}},{key:"addCushions",value:function(e,t){var n=10*u.R/.5;this.plane(new o.Pq0(0,0,-u.R-n/2),2*l.P.X,2*l.P.Y,n,e,this.cloth);var r=u.R/.5,i=.75*u.R/.5,s=-(.25*u.R)/.5/2,a=l.P.X,h=l.P.Y,f=Math.abs(c.f.pockets.pocketNW.knuckleNE.pos.x-c.f.pockets.pocketN.knuckleNW.pos.x),p=Math.abs(c.f.pockets.pocketNW.knuckleSW.pos.y-c.f.pockets.pocketSW.knuckleNW.pos.y);t||(f=2*l.P.Y,p=2*l.P.Y+4*u.R),this.plane(new o.Pq0(a+r/2,0,s),r,p,i,e),this.plane(new o.Pq0(-a-r/2,0,s),r,p,i,e),this.plane(new o.Pq0(-a/2,h+r/2,s),f,r,i,e),this.plane(new o.Pq0(-a/2,-h-r/2,s),f,r,i,e),this.plane(new o.Pq0(a/2,h+r/2,s),f,r,i,e),this.plane(new o.Pq0(a/2,-h-r/2,s),f,r,i,e)}},{key:"plane",value:function(e,n,r,i,s){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:this.cushion,l="".concat(n,"_").concat(r,"_").concat(i),c=t.boxCache.get(l);c||(c=new o.iNn(n,r,i),t.boxCache.set(l,c));var u=new o.eaF(c,a);u.receiveShadow=!0,u.position.copy(e),s.add(u)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();h(f,"mesh",void 0),h(f,"cylinderCache",new Map),h(f,"boxCache",new Map);var p=n("./src/view/cuemesh.ts");function d(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function v(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var y=function(){var e,t;function n(e){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");v(this,"ready",void 0),v(this,"rules",void 0),v(this,"background",void 0),v(this,"table",void 0),v(this,"cue",void 0),v(this,"sound",void 0),this.rules=r.V.create(e,null),this.rules.tableGeometry()}return e=[{key:"loadFromWeb",value:function(e){var t=this;this.ready=e,this.sound=new a(!0),(0,i.Ro)("models/background.gltf",function(e){t.background=e.scene,t.done()}),(0,i.Ro)(this.rules.asset(),function(e){t.table=e.scene,f.mesh=e.scene.children[0],t.done()}),(0,i.Ro)("models/cue.gltf",function(e){t.cue=e,p.l.mesh=e.scene.children[0],t.done()})}},{key:"createLocal",value:function(){this.sound=new a(!1),f.mesh=new f().generateTable(l.P.hasPockets),this.table=f.mesh}},{key:"done",value:function(){this.background&&this.table&&this.cue&&this.ready()}}],t=[{key:"localAssets",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=new n(e);return t.createLocal(),t}}],e&&d(n.prototype,e),t&&d(n,t),n}()},"./src/view/cameratop.ts"(e,t,n){n.d(t,{v:()=>a});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/view/tablegeometry.ts"),o=n("./src/model/physics/constants.ts");function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"viewPoint",value:function(e,n){var s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new r.Pq0;(n!==t.lastFov||t.zoomFactor!==t.lastZoom)&&(t.cachedDist=t.zoomFactor/(2*Math.tan(n*Math.PI/360)),t.lastFov=n,t.lastZoom=t.zoomFactor);var a=t.cachedDist;if(e>this.portrait){var l=e>t.aspectLimit?2.75*i.P.tableY:2.4*i.P.tableX/e;return s.set(0,-.01*o.R,a*l)}var c=e>1/t.aspectLimit?4.9*i.P.tableY:1.35*i.P.tableX/e;return s.set(-.01*o.R,0,a*c)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();s(a,"aspectLimit",1.78),s(a,"portrait",.95),s(a,"fov",20),s(a,"zoomFactor",1),s(a,"lastFov",void 0),s(a,"lastZoom",void 0),s(a,"cachedDist",void 0)},"./src/view/cue.ts"(e,t,n){n.d(t,{s:()=>f});var r=n("./src/view/tablegeometry.ts"),i=n("./src/utils/utils.ts"),o=n("./src/events/aimevent.ts"),s=n("./src/model/ball.ts"),a=n("./src/model/physics/physics.ts"),l=n("./src/view/cuemesh.ts"),c=n("./node_modules/three/build/three.core.js"),u=n("./src/model/physics/constants.ts");function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var f=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");h(this,"mesh",void 0),h(this,"helperMesh",void 0),h(this,"placerMesh",void 0),h(this,"offCenterLimit",.3),h(this,"maxPower",160*u.R),h(this,"t",0),h(this,"aimInputs",void 0),h(this,"aim",new o.w),h(this,"length",+r.P.tableX),h(this,"tempVec",new c.Pq0),h(this,"tempVec2",new c.Pq0),h(this,"tempVec3",new c.Pq0),h(this,"raycaster",new c.tBo),this.mesh=l.l.createCue(.05*u.R/.5,.15*u.R/.5,this.length),this.helperMesh=l.l.createHelper(),this.placerMesh=l.l.createPlacer()}return e=[{key:"rotateAim",value:function(e,t){this.aim.angle=this.aim.angle+e,this.mesh.rotation.z=this.aim.angle,this.helperMesh.rotation.z=this.aim.angle,this.aimInputs.showOverlap(),this.avoidCueTouchingOtherBall(t)}},{key:"adjustPower",value:function(e){this.aim.power=Math.min(this.maxPower,this.aim.power+e),this.updateAimInput()}},{key:"setPower",value:function(e){this.aim.power=e*this.maxPower}},{key:"hit",value:function(e){var t=this.aim;this.t=0,e.state=s.U.Sliding,e.vel.copy((0,i.Dz)(t.angle,this.tempVec).multiplyScalar(t.power)),e.rvel.copy((0,a.t6)(t.offset,e.vel))}},{key:"aimAtNext",value:function(e,t){if(t){var n=(0,i.xb)(this.tempVec.copy(t.pos).sub(e.pos));this.aim.angle=(0,i.FP)(n.y,n.x)}}},{key:"adjustSpin",value:function(e,t){var n=this.tempVec3.copy(this.aim.offset).add(e);this.setSpin(n,t)}},{key:"setSpin",value:function(e,t){e.length()>this.offCenterLimit&&e.normalize().multiplyScalar(this.offCenterLimit),this.aim.offset.copy(e),this.avoidCueTouchingOtherBall(t),this.updateAimInput()}},{key:"avoidCueTouchingOtherBall",value:function(e){for(var t=0;t++<20&&this.intersectsAnything(e);)this.aim.offset.y+=.1,this.aim.offset.length()>this.offCenterLimit&&this.aim.offset.normalize().multiplyScalar(this.offCenterLimit);t>1&&this.updateAimInput()}},{key:"updateAimInput",value:function(){var e,t,n;null==(e=this.aimInputs)||e.updateVisualState(this.aim.offset.x,this.aim.offset.y),null==(t=this.aimInputs)||t.updatePowerSlider(this.aim.power/this.maxPower),null==(n=this.aimInputs)||n.showOverlap()}},{key:"moveTo",value:function(e){this.aim.pos.copy(e),this.mesh.rotation.z=this.aim.angle,this.helperMesh.rotation.z=this.aim.angle;var t=this.spinOffset(),n=((0,i.F8)(this.t+Math.PI/2)-1)*2*u.R*(this.aim.power/this.maxPower),r=(0,i.Dz)(this.aim.angle,this.tempVec).multiplyScalar(n);this.mesh.position.copy(e).add(t).add(r),this.helperMesh.position.copy(e),this.placerMesh.position.copy(e),this.placerMesh.rotation.z=this.t}},{key:"update",value:function(e){this.t+=e,this.moveTo(this.aim.pos)}},{key:"placeBallMode",value:function(){this.mesh.visible=!1,this.placerMesh.visible=!0,this.aim.angle=0}},{key:"aimMode",value:function(){this.mesh.visible=!0,this.placerMesh.visible=!1}},{key:"spinOffset",value:function(){return(0,i.KM)((0,i.Dz)(this.aim.angle,this.tempVec2)).multiplyScalar(2*this.aim.offset.x*u.R).setZ(2*this.aim.offset.y*u.R)}},{key:"intersectsAnything",value:function(e){var t=this.spinOffset(),n=this.tempVec.copy(e.cueball.pos).add(t),r=(0,i.xb)((0,i.Dz)(this.aim.angle+Math.PI,this.tempVec2).setZ(.1));this.raycaster.set(n,r);var o=[],s=!0,a=!1,l=void 0;try{for(var c,u=e.balls[Symbol.iterator]();!(s=(c=u.next()).done);s=!0){var h=c.value;o.push(h.ballmesh.mesh)}}catch(e){a=!0,l=e}finally{try{s||null==u.return||u.return()}finally{if(a)throw l}}return e.mesh&&o.push(e.mesh),this.raycaster.intersectObjects(o,!0).length>0}},{key:"showHelper",value:function(e){this.helperMesh.visible=e}},{key:"toggleHelper",value:function(){this.showHelper(!this.helperMesh.visible)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/view/cuemesh.ts"(e,t,n){n.d(t,{l:()=>a});var r=n("./src/model/physics/constants.ts"),i=n("./src/utils/utils.ts"),o=n("./node_modules/three/build/three.core.js");function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"indicateValid",value:function(e){t.placermaterial.color.setHex(e?0xccffcc:0xff0000)}},{key:"createHelper",value:function(){var e=new o.Ho_(r.R,r.R,30*r.R/.5,12,1,!0),t=new o.eaF(e,this.helpermaterial);return t.geometry.applyMatrix4(new o.kn4().identity().makeRotationAxis(i.up,-Math.PI/2)).applyMatrix4(new o.kn4().identity().makeTranslation(15*r.R/.5,0,-(.01*r.R)/.5)),t.visible=!1,t.renderOrder=-1,t.material.depthTest=!1,t}},{key:"createPlacer",value:function(){var e=new o.Ho_(.01*r.R/.5,r.R,r.R,4),n=new o.eaF(e,t.placermaterial);return n.geometry.applyMatrix4(new o.kn4().identity().makeRotationAxis(new o.Pq0(1,0,0),-Math.PI/2)).applyMatrix4(new o.kn4().identity().makeTranslation(0,0,.7*r.R/.5)),n.visible=!1,n}},{key:"createCue",value:function(e,n,s){var a=new o.Ho_(e,n,s,11),l=new o.eaF(a,t.material);return l.castShadow=!1,l.geometry.applyMatrix4(new o.kn4().identity().makeRotationAxis(new o.Pq0(1,0,0),-.17)).applyMatrix4(new o.kn4().identity().makeRotationAxis(i.up,-Math.PI/2)).applyMatrix4(new o.kn4().identity().makeTranslation(-s/2-r.R,0,s/2*.16918234906699603+.25*r.R)),l}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();s(a,"mesh",void 0),s(a,"material",new o.tXL({color:8934775,wireframe:!1,flatShading:!1})),s(a,"placermaterial",new o.tXL({color:0xccffcc,wireframe:!1,flatShading:!1,transparent:!0,opacity:.5})),s(a,"helpermaterial",new o.BKk({uniforms:{lightDirection:{value:new o.Pq0(0,0,1)}},vertexShader:`
+        `))},this.materialCache.set(r,o),o}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();function y(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}o="materialCache",s=new Map,o in v?Object.defineProperty(v,o,{value:s,enumerable:!0,configurable:!0,writable:!0}):v[o]=s;var b=function(){var e,t;function n(e,t){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");m(this,"mesh",void 0),m(this,"shadow",void 0),m(this,"spinAxisArrow",void 0),m(this,"trace",void 0),m(this,"color",void 0),m(this,"m",new u.kn4),this.color=new u.Q1f(e),this.initialiseMesh(this.color,t)}return e=[{key:"updateAll",value:function(e,t){this.updatePosition(e.pos),this.updateArrows(e.pos,e.rvel,e.state),0!==e.rvel.lengthSq()&&(this.updateRotation(e.rvel,t),this.trace.addTrace(e.pos,e.vel))}},{key:"updatePosition",value:function(e){this.mesh.position.copy(e),this.shadow.position.copy(e)}},{key:"updateRotation",value:function(e,t){var n=e.length()*t;this.mesh.rotateOnWorldAxis((0,l.xb)(e),n)}},{key:"updateArrows",value:function(e,t,n){this.spinAxisArrow.setLength(h.R+h.R*t.length()/2,h.R,h.R),this.spinAxisArrow.position.copy(e),this.spinAxisArrow.setDirection((0,l.xb)(t)),n==k.Rolling?this.spinAxisArrow.setColor(0xcc0000):this.spinAxisArrow.setColor(52224)}},{key:"initialiseMesh",value:function(e,t){if(void 0===t){var r,i,o=e.getHex(),s=n._dottedGeometryCache.get(o);s||(s=new u.WBB(h.R,1),n.addDots(s,e),n._dottedGeometryCache.set(o,s)),r=s,i=v.createDottedMaterial(e)}else r=n.getBallGeometry(),i=v.createProjectedMaterial(t,e);this.mesh=new u.eaF(r,i),this.mesh.name="ball",this.updateRotation(new u.Pq0().random(),100),this.shadow=new u.eaF(n.getShadowGeometry(),n.getShadowMaterial()),this.spinAxisArrow=new u.E0M(l.up,l.v_,2,0,.01,.01),this.spinAxisArrow.visible=!1,this.trace=new p(500,e)}},{key:"addToScene",value:function(e){e.add(this.mesh),e.add(this.shadow),e.add(this.spinAxisArrow),e.add(this.trace.line)}}],t=[{key:"getBallGeometry",value:function(){return this._ballGeometry||(this._ballGeometry=new u.WBB(h.R,1)),this._ballGeometry}},{key:"getShadowGeometry",value:function(){return this._shadowGeometry||(this._shadowGeometry=new u.tcD(.9*h.R,9),this._shadowGeometry.applyMatrix4(new u.kn4().makeTranslation(0,0,-(.99*h.R)))),this._shadowGeometry}},{key:"getShadowMaterial",value:function(){return this._shadowMaterial||(this._shadowMaterial=new u.V9B({color:1118498})),this._shadowMaterial}},{key:"addDots",value:function(e,t){var r=e.attributes.position.count,i=new u.Q1f(t);e.setAttribute("color",new u.THS(new Float32Array(3*r),3));for(var o=e.attributes.color,s=0;s<r/3;s++)n.colorVerticesForFace(s,o,n.scaleNoise(i.r),n.scaleNoise(i.g),n.scaleNoise(i.b));var a=new u.Q1f(0xaa2222);[0,96,111,156,186,195].forEach(function(e){n.colorVerticesForFace(e/3,o,a.r,a.g,a.b)})}},{key:"colorVerticesForFace",value:function(e,t,n,r,i){t.setXYZ(3*e+0,n,r,i),t.setXYZ(3*e+1,n,r,i),t.setXYZ(3*e+2,n,r,i)}},{key:"scaleNoise",value:function(e){return(1-.25*Math.random())*e}}],e&&y(n.prototype,e),t&&y(n,t),n}();function g(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function w(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}m(b,"_ballGeometry",void 0),m(b,"_shadowGeometry",void 0),m(b,"_shadowMaterial",void 0),m(b,"_dottedGeometryCache",new Map);var k=((a={}).Stationary="Stationary",a.Rolling="Rolling",a.Sliding="Sliding",a.Falling="Falling",a.InPocket="InPocket",a),x=function(){var e,t;function n(e,t,r){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");w(this,"pos",void 0),w(this,"vel",l.v_.clone()),w(this,"rvel",l.v_.clone()),w(this,"futurePos",l.v_.clone()),w(this,"ballmesh",void 0),w(this,"state","Stationary"),w(this,"pocket",void 0),w(this,"id",n.id++),w(this,"label",void 0),this.pos=e.clone(),this.label=r,this.ballmesh=new b(t||0xeeeeee*Math.random(),r)}return e=[{key:"update",value:function(e){this.updatePosition(e),"Falling"==this.state?this.pocket.updateFall(this,e):this.updateVelocity(e)}},{key:"updateMesh",value:function(e){this.ballmesh.updateAll(this,e)}},{key:"updatePosition",value:function(e){this.pos.addScaledVector(this.vel,e)}},{key:"updateVelocity",value:function(e){this.inMotion()&&(this.isRolling()?(this.state="Rolling",(0,c.lx)(this.vel,this.rvel),this.addDelta(e,(0,c.JD)(this.rvel))):(this.state="Sliding",this.addDelta(e,(0,c.p2)(this.vel,this.rvel))))}},{key:"addDelta",value:function(e,t){t.v.multiplyScalar(e),t.w.multiplyScalar(e),this.passesZero(t)||(this.vel.add(t.v),this.rvel.add(t.w))}},{key:"passesZero",value:function(e){var t=(0,l.rq)(this.vel,e.v),n=(0,l.rq)(this.rvel,e.w);return!!(("Rolling"===this.state?t||n:t&&n)&&.01>Math.abs(this.rvel.z))&&(this.setStationary(),!0)}},{key:"setStationary",value:function(){this.vel.copy(l.v_),this.rvel.copy(l.v_),this.state="Stationary"}},{key:"isRolling",value:function(){return 0!==this.vel.lengthSq()&&0!==this.rvel.lengthSq()&&(0,c.Mq)(this.vel,this.rvel).length()<n.transition}},{key:"onTable",value:function(){return"Falling"!==this.state&&"InPocket"!==this.state}},{key:"inMotion",value:function(){return"Rolling"===this.state||"Sliding"===this.state||this.isFalling()}},{key:"isFalling",value:function(){return"Falling"===this.state}},{key:"futurePosition",value:function(e){return this.futurePos.copy(this.pos).addScaledVector(this.vel,e),this.futurePos}},{key:"fround",value:function(){this.pos.x=Math.fround(this.pos.x),this.pos.y=Math.fround(this.pos.y),this.vel.x=Math.fround(this.vel.x),this.vel.y=Math.fround(this.vel.y),this.rvel.x=Math.fround(this.rvel.x),this.rvel.y=Math.fround(this.rvel.y),this.rvel.z=Math.fround(this.rvel.z)}},{key:"serialise",value:function(){return{pos:this.pos.clone(),id:this.id}}}],t=[{key:"fromSerialised",value:function(e){return n.updateFromSerialised(new n((0,l.t6)(e.pos)),e)}},{key:"updateFromSerialised",value:function(e,t){var n,r;return e.pos.copy(t.pos),e.vel.copy(null!=(n=null==t?void 0:t.vel)?n:l.v_),e.rvel.copy(null!=(r=null==t?void 0:t.rvel)?r:l.v_),e}}],e&&g(n.prototype,e),t&&g(n,t),n}();w(x,"id",0),w(x,"transition",.05)},"./src/model/outcome.ts"(e,t,n){n.d(t,{$:()=>o,P:()=>s});function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var i,o=((i={}).Pot="Pot",i.Cushion="Cushion",i.Collision="Collision",i.Hit="Hit",i),s=function(){var e;function t(e,n,i,o){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");r(this,"type",void 0),r(this,"timestamp",void 0),r(this,"ballA",null),r(this,"ballB",null),r(this,"incidentSpeed",void 0),this.type=e,this.ballA=n,this.ballB=i,this.incidentSpeed=o,this.timestamp=Date.now()}return e=[{key:"pot",value:function(e,n){return new t("Pot",e,e,n)}},{key:"cushion",value:function(e,n){return new t("Cushion",e,e,n)}},{key:"collision",value:function(e,n,r){return new t("Collision",e,n,r)}},{key:"hit",value:function(e,n){return new t("Hit",e,e,n)}},{key:"isCueBallPotted",value:function(e,t){return t.some(function(t){return"Pot"==t.type&&t.ballA===e})}},{key:"isBallPottedNoFoul",value:function(e,n){return n.some(function(e){return"Pot"==e.type&&null!==e.ballA})&&!t.isCueBallPotted(e,n)}},{key:"pots",value:function(e){return e.filter(function(e){return"Pot"==e.type}).map(function(e){return e.ballA})}},{key:"potCount",value:function(e){return this.pots(e).length}},{key:"onlyRedsPotted",value:function(e){return this.pots(e).every(function(e){return e.id>6})}},{key:"firstCollision",value:function(e){var t=e.filter(function(e){return"Collision"===e.type});return t.length>0?t[0]:void 0}},{key:"isClearTable",value:function(e){var t=e.balls.filter(function(e){return e.onTable()});return 1===t.length&&t[0]===e.cueball}},{key:"isThreeCushionPoint",value:function(e,n){n=t.cueBallFirst(e,n).filter(function(t){return t.ballA===e});var r=new Set,i=0,o=!0,s=!1,a=void 0;try{for(var l,c=n[Symbol.iterator]();!(o=(l=c.next()).done);o=!0){var u=l.value;if("Cushion"===u.type&&i++,"Collision"===u.type&&(r.add(u.ballB),2===r.size))return i>=3}}catch(e){s=!0,a=e}finally{try{o||null==c.return||c.return()}finally{if(s)throw a}}return!1}},{key:"cueBallFirst",value:function(e,t){return t.forEach(function(t){"Collision"===t.type&&t.ballB===e&&(t.ballB=t.ballA,t.ballA=e)}),t}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/model/physics/collision.ts"(e,t,n){n.d(t,{F:()=>h});var r,i,o=n("./src/model/ball.ts"),s=n("./node_modules/three/build/three.core.js"),a=n("./src/model/physics/constants.ts"),l=n("./src/utils/utils.ts");function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var u=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");c(this,"normalImpulse",void 0),c(this,"tangentialImpulse",void 0)}return e=[{key:"dynamicFriction",value:function(e){return .01+.108*(0,l.oN)(-1.088*e)}},{key:"updateVelocities",value:function(e,t){var n=h.positionsAtContact(e,t);e.ballmesh.trace.forceTrace(n.a),t.ballmesh.trace.forceTrace(n.b);var r=n.b.sub(n.a).normalize(),i=new s.Pq0(-r.y,r.x,0),o=e.vel.clone().sub(t.vel).add(r.clone().multiplyScalar(-a.R).cross(e.rvel).sub(r.clone().multiplyScalar(a.R).cross(t.rvel))),l=r.dot(o),c=o.addScaledVector(r,-l),u=c.length(),f=i.dot(c),p=this.dynamicFriction(u);this.normalImpulse=-1.99*l/(2/a.m),this.tangentialImpulse=-(.25*Math.min(p*Math.abs(this.normalImpulse)/u,1/7)*f);var d=r.clone().multiplyScalar(this.normalImpulse),v=i.clone().multiplyScalar(this.tangentialImpulse);e.vel.addScaledVector(d,1/a.m).addScaledVector(v,1/a.m),t.vel.addScaledVector(d,-1/a.m).addScaledVector(v,-1/a.m);var y=r.clone().multiplyScalar(-a.R).cross(v),m=r.clone().multiplyScalar(a.R).cross(v);return e.rvel.addScaledVector(y,1/a.I),t.rvel.addScaledVector(m,1/a.I),l}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),h=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"willCollide",value:function(e,t,n){return(e.inMotion()||t.inMotion())&&e.onTable()&&t.onTable()&&e.futurePosition(n).distanceToSquared(t.futurePosition(n))<4*a.R*a.R}},{key:"collide",value:function(e,n){return t.updateVelocities(e,n)}},{key:"positionsAtContact",value:function(e,t){var n=e.pos.distanceTo(t.pos),r=e.vel.clone().sub(t.vel),i=(n-2*a.R)/r.length()||0;return{a:e.pos.clone().addScaledVector(e.vel,i),b:t.pos.clone().addScaledVector(t.vel,i)}}},{key:"updateVelocities",value:function(e,n){var r=t.model.updateVelocities(e,n);return e.state=o.U.Sliding,n.state=o.U.Sliding,r}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();r="model",i=new u,r in h?Object.defineProperty(h,r,{value:i,enumerable:!0,configurable:!0,writable:!0}):h[r]=i},"./src/model/physics/constants.ts"(e,t,n){n.d(t,{I:()=>o,Mz:()=>r,PX:()=>A,Qg:()=>k,R:()=>f,Wv:()=>T,Ys:()=>P,Z3:()=>m,_m:()=>y,cM:()=>S,e:()=>p,ee:()=>d,g:()=>s,gT:()=>c,gf:()=>l,jG:()=>w,kL:()=>u,kM:()=>O,ki:()=>E,ko:()=>R,m:()=>h,mu:()=>a,o5:()=>b,oV:()=>v,x3:()=>i,xO:()=>x});var r,i,o,s=9.8,a=.00985,l=.16,c=.85,u=.034,h=.23,f=.03275,p=.86,d=.98,v=.212,y=.14,m=.4,b=Math.sqrt(21)/5;function g(){r=a*h*s*2/3*u,i=7/(5*Math.sqrt(2))*f*a*h*s,o=.4*h*f*f}function w(e){f=e,g()}function k(e){h=e,g()}function x(e){a=e,g()}function T(e){u=e,g()}function P(e){l=e}function S(e){p=e}function O(e){c=e}function R(e){v=e}function E(e){y=e}function A(e){d=e}g()},"./src/model/physics/knuckle.ts"(e,t,n){n.d(t,{O:()=>a});var r=n("./src/model/physics/constants.ts"),i=n("./src/view/pocketgeometry.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e,t;function n(e,t){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");s(this,"pos",void 0),s(this,"radius",void 0),this.pos=e,this.radius=t}return e=[{key:"bounce",value:function(e){var t=e.pos.clone().sub(this.pos).normalize(),n=t.dot(e.vel);return e.vel.addScaledVector(t,-2*r.e*n),e.rvel.multiplyScalar(.5),Math.abs(n)}}],t=[{key:"willBounce",value:function(e,t){return t.distanceTo(e.pos)<r.R+e.radius}},{key:"findBouncing",value:function(e,t){var r=e.futurePosition(t);return i.f.knuckles.find(function(e){return n.willBounce(e,r)})}}],e&&o(n.prototype,e),t&&o(n,t),n}()},"./src/model/physics/mathaven.ts"(e,t,n){n.d(t,{z:()=>s});var r=n("./src/utils/utils.ts"),i=n("./src/model/physics/constants.ts");function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var s=function(){var e;function t(e,n,r,i,s){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");o(this,"P",0),o(this,"WzI",0),o(this,"vx",void 0),o(this,"vy",void 0),o(this,"Ï‰x",void 0),o(this,"Ï‰y",void 0),o(this,"Ï‰z",void 0),o(this,"s",void 0),o(this,"Ï†",void 0),o(this,"sÊ¹",void 0),o(this,"Ï†Ê¹",void 0),o(this,"i",0),o(this,"N",100),o(this,"M",void 0),o(this,"R",void 0),o(this,"Î¼s",void 0),o(this,"Î¼w",void 0),o(this,"ee",void 0),this.M=e,this.R=n,this.ee=r,this.Î¼s=i,this.Î¼w=s}return e=[{key:"updateSlipSpeedsAndAngles",value:function(){var e=this.R,t=this.vx+this.Ï‰y*e*i.Z3-this.Ï‰z*e*i.o5,n=-this.vy*i.Z3+this.Ï‰x*e,o=this.vx-this.Ï‰y*e,s=this.vy+this.Ï‰x*e;this.s=(0,r.RZ)((0,r.n7)(t,2)+(0,r.n7)(n,2)),this.Ï†=(0,r.FP)(n,t),this.Ï†<0&&(this.Ï†+=2*Math.PI),this.sÊ¹=(0,r.RZ)((0,r.n7)(o,2)+(0,r.n7)(s,2)),this.Ï†Ê¹=(0,r.FP)(s,o),this.Ï†Ê¹<0&&(this.Ï†Ê¹+=2*Math.PI)}},{key:"compressionPhase",value:function(){for(var e=Math.max(this.M*this.vy/this.N,.001);this.vy>0;)this.updateSingleStep(e)}},{key:"restitutionPhase",value:function(e){var t=Math.max(e/this.N,.001);for(this.WzI=0;this.WzI<e;)this.updateSingleStep(t)}},{key:"updateSingleStep",value:function(e){if(this.updateSlipSpeedsAndAngles(),this.updateVelocity(e),this.updateAngularVelocity(e),this.updateWorkDone(e),this.i++>10*this.N)throw Error("Solution not found")}},{key:"updateVelocity",value:function(e){var t=this.Î¼s,n=this.Î¼w,o=this.M;this.vx-=1/o*(n*(0,r.gn)(this.Ï†)+t*(0,r.gn)(this.Ï†Ê¹)*(i.Z3+n*(0,r.F8)(this.Ï†)*i.o5))*e,this.vy-=1/o*(i.o5-n*i.Z3*(0,r.F8)(this.Ï†)+t*(0,r.F8)(this.Ï†Ê¹)*(i.Z3+n*(0,r.F8)(this.Ï†)*i.o5))*e}},{key:"updateAngularVelocity",value:function(e){var t=this.Î¼s,n=this.Î¼w,o=this.M,s=this.R;this.Ï‰x+=-(5/(2*o*s))*(n*(0,r.F8)(this.Ï†)+t*(0,r.F8)(this.Ï†Ê¹)*(i.Z3+n*(0,r.F8)(this.Ï†)*i.o5))*e,this.Ï‰y+=-(5/(2*o*s))*(n*(0,r.gn)(this.Ï†)*i.Z3-t*(0,r.gn)(this.Ï†Ê¹)*(i.Z3+n*(0,r.F8)(this.Ï†)*i.o5))*e,this.Ï‰z+=5/(2*o*s)*(n*(0,r.gn)(this.Ï†)*i.o5)*e}},{key:"updateWorkDone",value:function(e){var t=e*Math.abs(this.vy);this.WzI+=t,this.P+=e}},{key:"solvePaper",value:function(e,t,n,i){this.solve(e*(0,r.gn)(t),e*(0,r.F8)(t),-i*(0,r.F8)(t),i*(0,r.gn)(t),n)}},{key:"solve",value:function(e,t,n,r,i){this.vx=e,this.vy=t,this.Ï‰x=n,this.Ï‰y=r,this.Ï‰z=i,this.WzI=0,this.P=0,this.i=0,this.compressionPhase();var o=this.ee*this.ee*this.WzI;this.restitutionPhase(o)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/model/physics/physics.ts"(e,t,n){n.d(t,{$8:()=>O,Gp:()=>w,JD:()=>h,Mq:()=>l,QK:()=>p,QV:()=>S,Qy:()=>A,Un:()=>g,c0:()=>b,lx:()=>f,p2:()=>u,s0:()=>m,t6:()=>M,yO:()=>k});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/utils/utils.ts"),o=n("./src/model/physics/constants.ts"),s=n("./src/model/physics/mathaven.ts"),a=new r.Pq0;function l(e,t){return a.copy(e).addScaledVector((0,i.KM)(t),o.R)}var c={v:new r.Pq0,w:new r.Pq0};function u(e,t){var n=l(e,t).setZ(0);return c.v.copy((0,i.xb)(n).multiplyScalar(-o.gf*o.g)),c.w.copy((0,i.xb)((0,i.KM)(n)).multiplyScalar(2.5*o.gf*o.g/o.R)),c.w.setZ(-2.5*(o.Mz/(o.m*o.R*o.R))*Math.sign(t.z)),c}function h(e){var t=new r.Pq0(e.x,e.y,0).length(),n=5/7*o.x3/(o.m*o.R)/t,i=5/7*o.x3/(o.m*o.R*o.R)/t;return c.v.set(-n*e.y,n*e.x,0),c.w.set(-i*e.x,-i*e.y,-2.5*(o.Mz/(o.m*o.R*o.R))*Math.sign(e.z)),c}function f(e,t){var n=t.z;t.copy((0,i.KM)(e).multiplyScalar(1/o.R)),t.setZ(n)}function p(e,t,n,r){var o=r(t.clone().applyAxisAngle(i.up,e),n.clone().applyAxisAngle(i.up,e));return o.v.applyAxisAngle(i.up,-e),o.w.applyAxisAngle(i.up,-e),o}Object.freeze(c);var d=Math.asin(.1*o.R/o.R),v=(0,i.F8)(d),y=(0,i.gn)(d);function m(e,t){return new r.Pq0(e.x*v-e.z*y+o.R*t.y,-e.y-o.R*t.z*y+o.R*t.x*v)}function b(e){return e.x*y}function g(e){var t=3.5/o.m;return e.length()/t}function w(e){var t,n=1/o.m,i=.39+.257*(t=new r.Pq0(e/y,0,0)).x-.044*t.x*t.x;return o.gT*((1+i)*e)/n}function k(e,t){var n=w(b(e));return g(m(e,t))<=n}function x(e,t){return{c:b(e),s:m(e,t),A:3.5/o.m,B:1/o.m}}function T(e,t){var n=x(e,t),r=n.c,i=n.s,s=n.A,a=n.B,l=(1+o.e)*(r/a);return R(-i.x/s*v-l*y,i.y/s,i.x/s*y-l*v)}function P(e,t){var n,r=x(e,t),i=r.c,s=r.B,a=(1+o.e)*(i/s),l=.471-.241*Math.atan2(Math.abs((n=e).y),n.x),c=Math.atan2(e.y,e.x),u=Math.cos(c);return R(-l*a*u*y-a*y,l*a*Math.sin(c),l*a*u*y-a*v)}function S(e,t){return k(e,t)?T(e,t):P(e,t)}function O(e,t){var n=T(e,t),r=P(e,t),i=Math.sign(e.y)===Math.sign(t.z)?Math.cos(Math.atan2(e.y,e.x)):1;return{v:r.v.lerp(n.v,i),w:r.w.lerp(n.w,i)}}function R(e,t,n){return{v:new r.Pq0(e/o.m,t/o.m),w:new r.Pq0(-o.R/o.I*t*v,o.R/o.I*(e*v-n*y),o.R/o.I*t*y)}}function E(e,t){var n=new s.z(o.m,o.R,o.ee,o.oV,o._m+.1);n.solve(e.x,e.y,t.x,t.y,t.z);var i=new r.Pq0(n.vx,n.vy,0),a=new r.Pq0(n.Ï‰x,n.Ï‰y,n.Ï‰z);return{v:i.sub(e),w:a.sub(t)}}function A(e,t){return p(Math.PI/2,e,t,E)}function M(e,t){var n=Math.atan2(-e.x,e.y),r=2.5*t.length()*(e.length()*o.R)/(o.R*o.R),s=t.clone().normalize();return(0,i.KM)(s).applyAxisAngle(s,n).multiplyScalar(r)}},"./src/model/physics/pocket.ts"(e,t,n){n.d(t,{Z:()=>l});var r=n("./src/model/ball.ts"),i=n("./src/model/physics/constants.ts"),o=n("./src/utils/utils.ts");function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var l=function(){var e,t;function n(e,t){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");a(this,"pos",void 0),a(this,"radius",void 0),this.pos=e,this.radius=t}return e=[{key:"fall",value:function(e,t){return e.vel.z=-i.g*t,e.state=r.U.Falling,e.pocket=this,e.vel.length()}},{key:"updateFall",value:function(e,t){e.vel.addScaledVector(o.up,-(10*i.R)*t*i.g);var n=e.pos.z;if(e.pos.clone().setZ(0).distanceTo(this.pos)>this.radius-i.R){var s=this.pos.clone().sub(e.pos).normalize().setZ(0);n>-i.R/2&&(e.vel.addScaledVector(s,7*i.R*t*i.g),e.rvel.addScaledVector((0,o.KM)(s),7*t*i.g)),0>e.vel.dot(s)&&(e.ballmesh.trace.forceTrace(e.pos),e.vel.x=s.x*e.vel.length()/2,e.vel.y=s.y*e.vel.length()/2)}var a=this.restingDepth(e);n<a&&0!==e.rvel.length()&&(e.pos.z=a,e.vel.z=-i.R/10,e.rvel.copy(o.v_)),n<a-i.R&&(e.pos.z=a-i.R,e.setStationary(),e.state=r.U.InPocket)}},{key:"restingDepth",value:function(e){return -3*i.R-i.R*e.id/4}}],t=[{key:"willFall",value:function(e,t){return t.distanceTo(e.pos)<e.radius}},{key:"findPocket",value:function(e,t,r){var i=t.futurePosition(r);return e.find(function(e){return n.willFall(e,i)})}}],e&&s(n.prototype,e),t&&s(n,t),n}()},"./src/model/table.ts"(e,t,n){n.d(t,{X:()=>b});var r=n("./src/view/tablegeometry.ts"),i=n("./src/model/physics/physics.ts"),o=n("./src/view/pocketgeometry.ts"),s=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"bounceAny",value:function(e,n){var o=!(arguments.length>2)||void 0===arguments[2]||arguments[2],s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:i.$8,a=e.futurePosition(n);if(t.willBounceLong(a,o)){var l=a.y>r.P.tableY?-Math.PI/2:Math.PI/2;return t.bounceIn(l,e,s)}if(t.willBounceShort(a,o)){var c=a.x>r.P.tableX?0:Math.PI;return t.bounceIn(c,e,s)}}},{key:"willBounceShort",value:function(e,n){return n?t.willBounceShortSegment(o.f.pockets.pocketNW.knuckleSW.pos.y,o.f.pockets.pocketSW.knuckleNW.pos.y,e):t.willBounceShortSegment(r.P.Y,-r.P.Y,e)}},{key:"willBounceLong",value:function(e,n){return n?t.willBounceLongSegment(o.f.pockets.pocketNW.knuckleNE.pos.x,o.f.pockets.pocketN.knuckleNW.pos.x,e)||t.willBounceLongSegment(o.f.pockets.pocketN.knuckleNE.pos.x,o.f.pockets.pocketNE.knuckleNW.pos.x,e):t.willBounceLongSegment(-r.P.X,r.P.X,e)}},{key:"willBounceLongSegment",value:function(e,t,n){return n.x>e&&n.x<t&&Math.abs(n.y)>r.P.tableY}},{key:"willBounceShortSegment",value:function(e,t,n){return n.y>t&&n.y<e&&Math.abs(n.x)>r.P.tableX}},{key:"bounceIn",value:function(e,t,n){t.ballmesh.trace.forceTrace(t.futurePos);var r=(0,i.QK)(e,t.vel,t.rvel,n);return t.vel.add(r.v),t.rvel.add(r.w),r.v.length()}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}(),a=n("./src/model/physics/collision.ts"),l=n("./src/model/physics/knuckle.ts"),c=n("./src/model/physics/pocket.ts"),u=n("./src/view/cue.ts"),h=n("./src/model/ball.ts"),f=n("./src/events/aimevent.ts"),p=n("./src/model/outcome.ts"),d=n("./src/utils/utils.ts"),v=n("./src/model/physics/constants.ts");function y(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var b=function(){var e,t;function n(e){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");m(this,"balls",void 0),m(this,"cue",new u.s),m(this,"pairs",void 0),m(this,"outcome",[]),m(this,"cueball",void 0),m(this,"cushionModel",i.$8),m(this,"mesh",void 0),this.cueball=e[0],this.initialiseBalls(e)}return e=[{key:"initialiseBalls",value:function(e){this.balls=e,this.pairs=[];for(var t=0;t<e.length;t++)for(var n=0;n<e.length;n++)t<n&&this.pairs.push({a:e[t],b:e[n]})}},{key:"updateBallMesh",value:function(e){this.balls.forEach(function(t){t.updateMesh(e)})}},{key:"advance",value:function(e){for(var t=0;!this.prepareAdvanceAll(e);)if(t++>100)throw Error("Depth exceeded resolving collisions");this.balls.forEach(function(t){t.update(e),t.fround()})}},{key:"prepareAdvanceAll",value:function(e){var t=this;return this.pairs.every(function(n){return t.prepareAdvancePair(n.a,n.b,e)})&&this.balls.every(function(n){return t.prepareAdvanceToCushions(n,e)})}},{key:"prepareAdvancePair",value:function(e,t,n){if(a.F.willCollide(e,t,n)){var r=a.F.collide(e,t);return this.outcome.push(p.P.collision(e,t,r)),!1}return!0}},{key:"prepareAdvanceToCushions",value:function(e,t){if(!e.onTable())return!0;var n=e.futurePosition(t);if(Math.abs(n.y)<r.P.tableY&&Math.abs(n.x)<r.P.tableX)return!0;var i=s.bounceAny(e,t,r.P.hasPockets,this.cushionModel);if(i)return this.outcome.push(p.P.cushion(e,i)),!1;var a=l.O.findBouncing(e,t);if(a){var u=a.bounce(e);return this.outcome.push(p.P.cushion(e,u)),!1}var h=c.Z.findPocket(o.f.pocketCenters,e,t);if(h){var f=h.fall(e,t);return this.outcome.push(p.P.pot(e,f)),!1}return!0}},{key:"allStationary",value:function(){return this.balls.every(function(e){return!e.inMotion()})}},{key:"inPockets",value:function(){return this.balls.reduce(function(e,t){return t.onTable()?e:e+1},0)}},{key:"hit",value:function(){this.cue.hit(this.cueball),this.balls.forEach(function(e){e.ballmesh.trace.reset()})}},{key:"serialise",value:function(){return{balls:this.balls.map(function(e){return e.serialise()}),aim:this.cue.aim.copy()}}},{key:"updateFromSerialised",value:function(e){var t=this;e.balls&&e.balls.forEach(function(e){return h.c.updateFromSerialised(t.balls[e.id],e)}),e.aim&&(this.cue.aim=f.w.fromJson(e.aim))}},{key:"shortSerialise",value:function(){return this.balls.map(function(e){return[e.pos.x,e.pos.y]}).reduce(function(e,t){return e.concat(t)},[])}},{key:"updateFromShortSerialised",value:function(e){this.balls.forEach(function(t,n){t.pos.x=e[2*n],t.pos.y=e[2*n+1],t.pos.z=0,t.vel.copy(d.v_),t.rvel.copy(d.v_),t.state=h.U.Stationary})}},{key:"addToScene",value:function(e){this.balls.forEach(function(t){t.ballmesh.addToScene(e)}),e.add(this.cue.mesh),e.add(this.cue.helperMesh),e.add(this.cue.placerMesh)}},{key:"showTraces",value:function(e){this.balls.forEach(function(t){t.ballmesh.trace.line.visible=e,t.ballmesh.trace.reset()})}},{key:"showSpin",value:function(e){this.balls.forEach(function(t){t.ballmesh.spinAxisArrow.visible=e})}},{key:"halt",value:function(){this.balls.forEach(function(e){e.vel.copy(d.v_),e.rvel.copy(d.v_),e.state=h.U.Stationary})}},{key:"roundCueBallPosition",value:function(){var e=this.cueball.pos.clone();this.overlapsAny(e)||this.cueball.pos.copy(e)}},{key:"overlapsAny",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.cueball;return this.balls.filter(function(e){return e!==t}).some(function(t){return t.pos.distanceTo(e)<2*v.R})}}],t=[{key:"fromSerialised",value:function(e){var t=new n(e.balls.map(function(e){return h.c.fromSerialised(e)}));return t.updateFromSerialised(e),t}}],e&&y(n.prototype,e),t&&y(n,t),n}()},"./src/network/client/matchresult.ts"(e,t,n){n.d(t,{n:()=>l});var r=n("./src/events/chatevent.ts"),i=n("./src/events/notificationevent.ts"),o=n("./src/controller/end.ts"),s=n("./src/network/client/session.ts"),a=n("./src/utils/gameover.ts"),l=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"presentGameEnd",value:function(e,t){e.eventQueue.push(new r.b(null,"game over")),e.recorder.wholeGameLink();var n=s.N.hasInstance()?s.N.getInstance():null,i=s.N.playerIndex(),a=(e.scores[0]>=e.scores[1]?0:1)===i,l=this.getScoreSubtext(e,n,i);a?(this.notifyWin(e,l),this.sendLossNotification(e)):s.N.isSpectator()?this.notifySpectator(e,l):this.notifyLoss(e,l);var c=this.createMatchResult(e,t,n,i);return new o.o(e,a?c:void 0)}},{key:"notifyWin",value:function(e,t){e.notifyLocal({type:"GameOver",title:"YOU WON",subtext:t,icon:"ðŸ†",extraClass:"is-winner",extra:a.c.forMode(e.isSinglePlayer),duration:0})}},{key:"notifyLoss",value:function(e,t){e.notifyLocal({type:"GameOver",title:"YOU LOST",subtext:t,icon:"ðŸ¥ˆ",extraClass:"is-loser",extra:a.c.forMode(e.isSinglePlayer),duration:0})}},{key:"notifySpectator",value:function(e,t){e.notifyLocal({type:"GameOver",title:"GAME OVER",subtext:t,icon:"ðŸ†",extraClass:"",extra:a.c.lobby,duration:0})}},{key:"sendLossNotification",value:function(e){e.isSinglePlayer||e.sendEvent(new i.c({type:"GameOver",title:"YOU LOST",icon:"ðŸ¥ˆ",extraClass:"is-loser",extra:a.c.forMode(!1),duration:0}))}},{key:"getScoreSubtext",value:function(e,t,n){if(e.isSinglePlayer)return"Score: ".concat(e.scores[n]);var r=0===n?(null==t?void 0:t.playername)||"You":(null==t?void 0:t.opponentName)||"Opponent",i=1===n?(null==t?void 0:t.playername)||"You":(null==t?void 0:t.opponentName)||"Opponent";return"".concat(r," ").concat(e.scores[0]," - ").concat(e.scores[1]," ").concat(i)}},{key:"createMatchResult",value:function(e,t,n,r){var i=e.scores[0]>=e.scores[1]?0:1,o=1-i,s=i===r?(null==n?void 0:n.playername)||"Anon":(null==n?void 0:n.opponentName)||"Opponent",a=o===r?(null==n?void 0:n.playername)||"Anon":(null==n?void 0:n.opponentName)||"Opponent",l={winner:s,winnerScore:e.scores[i],ruleType:t};return(null==n?void 0:n.opponentName)&&(l.loser=a,l.loserScore=e.scores[o]),l}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/network/client/nchanmessagerelay.ts"(e,t,n){function r(e,t,n,r,i,o,s){try{var a=e[o](s),l=a.value}catch(e){n(e);return}a.done?t(l):Promise.resolve(l).then(r,i)}n.d(t,{p:()=>o});function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var o=function(){var e;function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"billiards-network.onrender.com";if(!(this instanceof t))throw TypeError("Cannot call a class as a function");i(this,"baseURL",void 0),i(this,"websockets",void 0),this.baseURL=e,this.websockets=new Map}return e=[{key:"subscribe",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"table",r="wss://".concat(this.baseURL,"/subscribe/").concat(n,"/").concat(e),i=new WebSocket(r);console.log("Subscribed to ",r),i.onmessage=function(e){try{var n=e.data;t(n)}catch(e){console.error("Error parsing message:",e)}},i.onerror=function(e){console.error("WebSocket error:",e)},i.onopen=function(){console.log("Connected to ".concat(r))},i.onclose=function(e){console.log("Disconnected from ".concat(r,":"),e.reason)},this.websockets.set("".concat(n,"/").concat(e),i)}},{key:"publish",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"table";fetch("https://".concat(this.baseURL,"/publish/").concat(n,"/").concat(e),{method:"POST",headers:{"Content-Type":"application/json"},body:t}).catch(function(e){console.error("Publication error:",e)})}},{key:"getOnlineCount",value:function(){var e;return(e=function(){var e;return function(e,t){var n,r,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype),a=Object.defineProperty;return a(s,"next",{value:l(0)}),a(s,"throw",{value:l(1)}),a(s,"return",{value:l(2)}),"function"==typeof Symbol&&a(s,Symbol.iterator,{value:function(){return this}}),s;function l(a){return function(l){var c=[a,l];if(n)throw TypeError("Generator is already executing.");for(;s&&(s=0,c[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&c[0]?r.return:c[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,c[1])).done)return i;switch(r=0,i&&(c=[2&c[0],i.value]),c[0]){case 0:case 1:i=c;break;case 4:return o.label++,{value:c[1],done:!1};case 5:o.label++,r=c[1],c=[0];continue;case 7:c=o.ops.pop(),o.trys.pop();continue;default:if(!(i=(i=o.trys).length>0&&i[i.length-1])&&(6===c[0]||2===c[0])){o=0;continue}if(3===c[0]&&(!i||c[1]>i[0]&&c[1]<i[3])){o.label=c[1];break}if(6===c[0]&&o.label<i[1]){o.label=i[1],i=c;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(c);break}i[2]&&o.ops.pop(),o.trys.pop();continue}c=t.call(e,o)}catch(e){c=[6,e],r=0}finally{n=i=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}}(this,function(t){switch(t.label){case 0:return t.trys.push([0,3,,4]),[4,fetch("https://".concat(this.baseURL,"/publish/presence/lobby"),{method:"POST",headers:{Accept:"application/json"}})];case 1:return[4,t.sent().json()];case 2:return[2,"number"==typeof(e=t.sent()).subscribers?e.subscribers:null];case 3:return t.sent(),[2,null];case 4:return[2]}})},function(){var t=this,n=arguments;return new Promise(function(i,o){var s=e.apply(t,n);function a(e){r(s,i,o,a,l,"next",e)}function l(e){r(s,i,o,a,l,"throw",e)}a(void 0)})}).call(this)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/network/client/session.ts"(e,t,n){n.d(t,{N:()=>i});function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var i=function(){var e;function t(e,n,i,o){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");r(this,"playername",void 0),r(this,"clientId",void 0),r(this,"tableId",void 0),r(this,"spectator",void 0),r(this,"opponentName",void 0),r(this,"playerIndex",void 0),this.playername=e,this.clientId=n,this.tableId=i,this.spectator=o,this.playerIndex=0}return e=[{key:"getInstance",value:function(){if(!t.instance)throw Error("Session not initialized");return t.instance}},{key:"hasInstance",value:function(){return void 0!==t.instance}},{key:"playerIndex",value:function(){return t.instance?t.instance.playerIndex:0}},{key:"isSpectator",value:function(){return void 0!==t.instance&&t.getInstance().spectator}},{key:"reset",value:function(){t.instance=void 0}},{key:"init",value:function(e,n,r,i){t.instance=new t(n,e,r,i)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();r(i,"instance",void 0)},"./src/utils/dom.ts"(e,t,n){function r(e){return document.getElementById(e)}function i(e){return document.getElementById(e)}function o(e){return document.getElementById(e)}function s(e){return document.getElementById(e)}n.d(t,{V4:()=>o,dX:()=>s,id:()=>r,vq:()=>i})},"./src/utils/gameover.ts"(e,t,n){n.d(t,{c:()=>r});var r={lobby:"<button onclick=\"location.href='".concat("https://scoreboard-tailuge.vercel.app/","'\">Lobby</button>"),newGame:'<button onclick="location.reload()">New Game</button>',replay:'<button onclick="location.reload()">Replay</button>',forMode:function(e){return e?this.newGame+this.lobby:this.lobby}}},"./src/utils/gltf.ts"(e,t,n){n.d(t,{KP:()=>ex,Ro:()=>eT});var r=n("./node_modules/three/build/three.core.js");let i={POSITION:["byte","byte normalized","unsigned byte","unsigned byte normalized","short","short normalized","unsigned short","unsigned short normalized"],NORMAL:["byte normalized","short normalized"],TANGENT:["byte normalized","short normalized"],TEXCOORD:["byte","byte normalized","unsigned byte","short","short normalized","unsigned short"]};class o{constructor(){this.textureUtils=null,this.pluginCallbacks=[],this.register(function(e){return new v(e)}),this.register(function(e){return new y(e)}),this.register(function(e){return new w(e)}),this.register(function(e){return new k(e)}),this.register(function(e){return new x(e)}),this.register(function(e){return new T(e)}),this.register(function(e){return new m(e)}),this.register(function(e){return new b(e)}),this.register(function(e){return new g(e)}),this.register(function(e){return new P(e)}),this.register(function(e){return new S(e)}),this.register(function(e){return new O(e)}),this.register(function(e){return new R(e)}),this.register(function(e){return new E(e)})}register(e){return -1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return -1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}setTextureUtils(e){return this.textureUtils=e,this}parse(e,t,n,r){let i=new d,o=[];for(let e=0,t=this.pluginCallbacks.length;e<t;e++)o.push(this.pluginCallbacks[e](i));i.setPlugins(o),i.setTextureUtils(this.textureUtils),i.writeAsync(e,t,r).catch(n)}parseAsync(e,t){let n=this;return new Promise(function(r,i){n.parse(e,r,i,t)})}}let s="KHR_mesh_quantization",a={};a[r.hxR]=9728,a[r.pHI]=9984,a[r.Cfg]=9986,a[r.k6q]=9729,a[r.kRr]=9985,a[r.$_I]=9987,a[r.ghU]=33071,a[r.GJx]=10497,a[r.kTW]=33648;let l={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},c=new r.Q1f;function u(e,t){return e.length===t.length&&e.every(function(e,n){return e===t[n]})}function h(e){return 4*Math.ceil(e/4)}function f(e,t=0){let n=h(e.byteLength);if(n!==e.byteLength){let r=new Uint8Array(n);if(r.set(new Uint8Array(e)),0!==t)for(let i=e.byteLength;i<n;i++)r[i]=t;return r.buffer}return e}function p(){return"u"<typeof document&&"u">typeof OffscreenCanvas?new OffscreenCanvas(1,1):document.createElement("canvas")}class d{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.extensionsRequired={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter r"+r.sPf}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map},this.textureUtils=null}setPlugins(e){this.plugins=e}setTextureUtils(e){this.textureUtils=e}async writeAsync(e,t,n={}){this.options=Object.assign({binary:!1,trs:!1,onlyVisible:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},n),this.options.animations.length>0&&(this.options.trs=!0),await this.processInputAsync(e),await Promise.all(this.pending);let r=this.buffers,i=this.json;n=this.options;let o=this.extensionsUsed,s=this.extensionsRequired,a=new Blob(r,{type:"application/octet-stream"}),l=Object.keys(o),c=Object.keys(s);if(l.length>0&&(i.extensionsUsed=l),c.length>0&&(i.extensionsRequired=c),i.buffers&&i.buffers.length>0&&(i.buffers[0].byteLength=a.size),!0===n.binary){let e=new FileReader;e.readAsArrayBuffer(a),e.onloadend=function(){var n;let r=f(e.result),o=new DataView(new ArrayBuffer(8));o.setUint32(0,r.byteLength,!0),o.setUint32(4,5130562,!0);let s=f((n=JSON.stringify(i),new TextEncoder().encode(n).buffer),32),a=new DataView(new ArrayBuffer(8));a.setUint32(0,s.byteLength,!0),a.setUint32(4,0x4e4f534a,!0);let l=new ArrayBuffer(12),c=new DataView(l);c.setUint32(0,0x46546c67,!0),c.setUint32(4,2,!0);let u=12+a.byteLength+s.byteLength+o.byteLength+r.byteLength;c.setUint32(8,u,!0);let h=new Blob([l,a,s,o,r],{type:"application/octet-stream"}),p=new FileReader;p.readAsArrayBuffer(h),p.onloadend=function(){t(p.result)}}}else if(i.buffers&&i.buffers.length>0){let e=new FileReader;e.readAsDataURL(a),e.onloadend=function(){let n=e.result;i.buffers[0].uri=n,t(i)}}else t(i)}serializeUserData(e,t){if(0===Object.keys(e.userData).length)return;let n=this.options,r=this.extensionsUsed;try{let i=JSON.parse(JSON.stringify(e.userData));if(n.includeCustomExtensions&&i.gltfExtensions){for(let e in void 0===t.extensions&&(t.extensions={}),i.gltfExtensions)t.extensions[e]=i.gltfExtensions[e],r[e]=!0;delete i.gltfExtensions}Object.keys(i).length>0&&(t.extras=i)}catch(t){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+t.message)}}getUID(e,t=!1){if(!1===this.uids.has(e)){let t=new Map;t.set(!0,this.uid++),t.set(!1,this.uid++),this.uids.set(e,t)}return this.uids.get(e).get(t)}isNormalizedNormalAttribute(e){if(this.cache.attributesNormalized.has(e))return!1;let t=new r.Pq0;for(let n=0,r=e.count;n<r;n++)if(Math.abs(t.fromBufferAttribute(e,n).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(e){let t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);let n=e.clone(),i=new r.Pq0;for(let e=0,t=n.count;e<t;e++)i.fromBufferAttribute(n,e),0===i.x&&0===i.y&&0===i.z?i.setX(1):i.normalize(),n.setXYZ(e,i.x,i.y,i.z);return t.attributesNormalized.set(e,n),n}applyTextureTransform(e,t){let n=!1,r={};(0!==t.offset.x||0!==t.offset.y)&&(r.offset=t.offset.toArray(),n=!0),0!==t.rotation&&(r.rotation=t.rotation,n=!0),(1!==t.repeat.x||1!==t.repeat.y)&&(r.scale=t.repeat.toArray(),n=!0),n&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=r,this.extensionsUsed.KHR_texture_transform=!0)}async buildMetalRoughTextureAsync(e,t){if(e===t)return e;function n(e){return e.colorSpace===r.er$?function(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}:function(e){return e}}e instanceof r.FvD&&(e=await this.decompressTextureAsync(e)),t instanceof r.FvD&&(t=await this.decompressTextureAsync(t));let i=e?e.image:null,o=t?t.image:null,s=Math.max(i?i.width:0,o?o.width:0),a=Math.max(i?i.height:0,o?o.height:0),l=p();l.width=s,l.height=a;let c=l.getContext("2d",{willReadFrequently:!0});c.fillStyle="#00ffff",c.fillRect(0,0,s,a);let u=c.getImageData(0,0,s,a);if(i){c.drawImage(i,0,0,s,a);let t=n(e),r=c.getImageData(0,0,s,a).data;for(let e=2;e<r.length;e+=4)u.data[e]=256*t(r[e]/256)}if(o){c.drawImage(o,0,0,s,a);let e=n(t),r=c.getImageData(0,0,s,a).data;for(let t=1;t<r.length;t+=4)u.data[t]=256*e(r[t]/256)}c.putImageData(u,0,0);let h=(e||t).clone();return h.source=new r.kLi(l),h.colorSpace=r.jf0,h.channel=(e||t).channel,e&&t&&e.channel!==t.channel&&console.warn("THREE.GLTFExporter: UV channels for metalnessMap and roughnessMap textures must match."),console.warn("THREE.GLTFExporter: Merged metalnessMap and roughnessMap textures."),h}async decompressTextureAsync(e,t=1/0){if(null===this.textureUtils)throw Error("THREE.GLTFExporter: setTextureUtils() must be called to process compressed textures.");return await this.textureUtils.decompress(e,t)}processBuffer(e){let t=this.json,n=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),n.push(e),0}processBufferView(e,t,n,i,o){let s,a=this.json;switch(!a.bufferViews&&(a.bufferViews=[]),t){case 5120:case 5121:s=1;break;case 5122:case 5123:s=2;break;default:s=4}let l=e.itemSize*s;34962===o&&(l=4*Math.ceil(l/4));let c=h(i*l),u=new DataView(new ArrayBuffer(c)),f=0;for(let o=n;o<n+i;o++){for(let n=0;n<e.itemSize;n++){let i;e.itemSize>4?i=e.array[o*e.itemSize+n]:(0===n?i=e.getX(o):1===n?i=e.getY(o):2===n?i=e.getZ(o):3===n&&(i=e.getW(o)),!0===e.normalized&&(i=r.cj9.normalize(i,e.array))),5126===t?u.setFloat32(f,i,!0):5124===t?u.setInt32(f,i,!0):5125===t?u.setUint32(f,i,!0):5122===t?u.setInt16(f,i,!0):5123===t?u.setUint16(f,i,!0):5120===t?u.setInt8(f,i):5121===t&&u.setUint8(f,i),f+=s}f%l!=0&&(f+=l-f%l)}let p={buffer:this.processBuffer(u.buffer),byteOffset:this.byteOffset,byteLength:c};return void 0!==o&&(p.target=o),34962===o&&(p.byteStride=l),this.byteOffset+=c,a.bufferViews.push(p),{id:a.bufferViews.length-1,byteLength:0}}processBufferViewImage(e){let t=this,n=t.json;return n.bufferViews||(n.bufferViews=[]),new Promise(function(r){let i=new FileReader;i.readAsArrayBuffer(e),i.onloadend=function(){let e=f(i.result),o={buffer:t.processBuffer(e),byteOffset:t.byteOffset,byteLength:e.byteLength};t.byteOffset+=e.byteLength,r(n.bufferViews.push(o)-1)}})}processAccessor(e,t,n,i){let o,s,a=this.json;if(e.array.constructor===Float32Array)o=5126;else if(e.array.constructor===Int32Array)o=5124;else if(e.array.constructor===Uint32Array)o=5125;else if(e.array.constructor===Int16Array)o=5122;else if(e.array.constructor===Uint16Array)o=5123;else if(e.array.constructor===Int8Array)o=5120;else if(e.array.constructor===Uint8Array)o=5121;else throw Error("THREE.GLTFExporter: Unsupported bufferAttribute component type: "+e.array.constructor.name);if(void 0===n&&(n=0),(void 0===i||i===1/0)&&(i=e.count),0===i)return null;let l=function(e,t,n){let i={min:Array(e.itemSize).fill(1/0),max:Array(e.itemSize).fill(-1/0)};for(let o=t;o<t+n;o++)for(let t=0;t<e.itemSize;t++){let n;e.itemSize>4?n=e.array[o*e.itemSize+t]:(0===t?n=e.getX(o):1===t?n=e.getY(o):2===t?n=e.getZ(o):3===t&&(n=e.getW(o)),!0===e.normalized&&(n=r.cj9.normalize(n,e.array))),i.min[t]=Math.min(i.min[t],n),i.max[t]=Math.max(i.max[t],n)}return i}(e,n,i);void 0!==t&&(s=e===t.index?34963:34962);let c=this.processBufferView(e,o,n,i,s),u={bufferView:c.id,byteOffset:c.byteOffset,componentType:o,count:i,max:l.max,min:l.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",9:"MAT3",16:"MAT4"}[e.itemSize]};return!0===e.normalized&&(u.normalized=!0),a.accessors||(a.accessors=[]),a.accessors.push(u)-1}processImage(e,t,n,i="image/png"){if(null!==e){let o=this,s=o.cache,a=o.json,l=o.options,c=o.pending;s.images.has(e)||s.images.set(e,{});let u=s.images.get(e),h=i+":flipY/"+n.toString();if(void 0!==u[h])return u[h];a.images||(a.images=[]);let f={mimeType:i},d=p();d.width=Math.min(e.width,l.maxTextureSize),d.height=Math.min(e.height,l.maxTextureSize);let v=d.getContext("2d",{willReadFrequently:!0});if(!0===n&&(v.translate(0,d.height),v.scale(1,-1)),void 0!==e.data){t!==r.GWd&&console.error("GLTFExporter: Only RGBAFormat is supported.",t),(e.width>l.maxTextureSize||e.height>l.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",e);let n=new Uint8ClampedArray(e.height*e.width*4);for(let t=0;t<n.length;t+=4)n[t+0]=e.data[t+0],n[t+1]=e.data[t+1],n[t+2]=e.data[t+2],n[t+3]=e.data[t+3];v.putImageData(new ImageData(n,e.width,e.height),0,0)}else if("u">typeof HTMLImageElement&&e instanceof HTMLImageElement||"u">typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"u">typeof ImageBitmap&&e instanceof ImageBitmap||"u">typeof OffscreenCanvas&&e instanceof OffscreenCanvas)v.drawImage(e,0,0,d.width,d.height);else throw Error("THREE.GLTFExporter: Invalid image type. Use HTMLImageElement, HTMLCanvasElement, ImageBitmap or OffscreenCanvas.");!0===l.binary?c.push((function(e,t){if(!("u">typeof OffscreenCanvas&&e instanceof OffscreenCanvas))return new Promise(n=>e.toBlob(n,t));{let n;return"image/jpeg"===t?n=.92:"image/webp"===t&&(n=.8),e.convertToBlob({type:t,quality:n})}})(d,i).then(e=>o.processBufferViewImage(e)).then(e=>{f.bufferView=e})):f.uri=r.HgN.getDataURL(d,i);let y=a.images.push(f)-1;return u[h]=y,y}throw Error("THREE.GLTFExporter: No valid image data found. Unable to process texture.")}processSampler(e){let t=this.json;t.samplers||(t.samplers=[]);let n={magFilter:a[e.magFilter],minFilter:a[e.minFilter],wrapS:a[e.wrapS],wrapT:a[e.wrapT]};return t.samplers.push(n)-1}async processTextureAsync(e){let t=this.options,n=this.cache,i=this.json;if(n.textures.has(e))return n.textures.get(e);i.textures||(i.textures=[]),e instanceof r.FvD&&(e=await this.decompressTextureAsync(e,t.maxTextureSize));let o=e.userData.mimeType;"image/webp"===o&&(o="image/png");let s={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY,o)};e.name&&(s.name=e.name),await this._invokeAllAsync(async function(t){t.writeTexture&&await t.writeTexture(e,s)});let a=i.textures.push(s)-1;return n.textures.set(e,a),a}async processMaterialAsync(e){let t=this.cache,n=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;n.materials||(n.materials=[]);let i={pbrMetallicRoughness:{}};!0!==e.isMeshStandardMaterial&&!0!==e.isMeshBasicMaterial&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");let o=e.color.toArray().concat([e.opacity]);if(u(o,[1,1,1,1])||(i.pbrMetallicRoughness.baseColorFactor=o),e.isMeshStandardMaterial?(i.pbrMetallicRoughness.metallicFactor=e.metalness,i.pbrMetallicRoughness.roughnessFactor=e.roughness):(i.pbrMetallicRoughness.metallicFactor=0,i.pbrMetallicRoughness.roughnessFactor=1),e.metalnessMap||e.roughnessMap){let t=await this.buildMetalRoughTextureAsync(e.metalnessMap,e.roughnessMap),n={index:await this.processTextureAsync(t),texCoord:t.channel};this.applyTextureTransform(n,t),i.pbrMetallicRoughness.metallicRoughnessTexture=n}if(e.map){let t={index:await this.processTextureAsync(e.map),texCoord:e.map.channel};this.applyTextureTransform(t,e.map),i.pbrMetallicRoughness.baseColorTexture=t}if(e.emissive){let t=e.emissive;if(Math.max(t.r,t.g,t.b)>0&&(i.emissiveFactor=e.emissive.toArray()),e.emissiveMap){let t={index:await this.processTextureAsync(e.emissiveMap),texCoord:e.emissiveMap.channel};this.applyTextureTransform(t,e.emissiveMap),i.emissiveTexture=t}}if(e.normalMap){let t={index:await this.processTextureAsync(e.normalMap),texCoord:e.normalMap.channel};e.normalScale&&1!==e.normalScale.x&&(t.scale=e.normalScale.x),this.applyTextureTransform(t,e.normalMap),i.normalTexture=t}if(e.aoMap){let t={index:await this.processTextureAsync(e.aoMap),texCoord:e.aoMap.channel};1!==e.aoMapIntensity&&(t.strength=e.aoMapIntensity),this.applyTextureTransform(t,e.aoMap),i.occlusionTexture=t}e.transparent?i.alphaMode="BLEND":e.alphaTest>0&&(i.alphaMode="MASK",i.alphaCutoff=e.alphaTest),e.side===r.$EB&&(i.doubleSided=!0),""!==e.name&&(i.name=e.name),this.serializeUserData(e,i),await this._invokeAllAsync(async function(t){t.writeMaterialAsync&&await t.writeMaterialAsync(e,i)});let s=n.materials.push(i)-1;return t.materials.set(e,s),s}async processMeshAsync(e){let t,n=this.cache,i=this.json,s=[e.geometry.uuid];if(Array.isArray(e.material))for(let t=0,n=e.material.length;t<n;t++)s.push(e.material[t].uuid);else s.push(e.material.uuid);let a=s.join(":");if(n.meshes.has(a))return n.meshes.get(a);let l=e.geometry;t=e.isLineSegments?1:e.isLineLoop?2:e.isLine?3:e.isPoints?0:e.material.wireframe?1:4;let c={},u={},h=[],f=[],p={uv:"TEXCOORD_0",uv1:"TEXCOORD_1",uv2:"TEXCOORD_2",uv3:"TEXCOORD_3",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},d=l.getAttribute("normal");void 0===d||this.isNormalizedNormalAttribute(d)||(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),l.setAttribute("normal",this.createNormalizedNormalAttribute(d)));let v=null;for(let e in l.attributes){if("morph"===e.slice(0,5))continue;let t=l.attributes[e];if(e=p[e]||e.toUpperCase(),/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(e)||(e="_"+e),n.attributes.has(this.getUID(t))){u[e]=n.attributes.get(this.getUID(t));continue}v=null;let i=t.array;"JOINTS_0"!==e||i instanceof Uint16Array||i instanceof Uint8Array?(i instanceof Uint32Array||i instanceof Int32Array)&&!e.startsWith("_")&&(console.warn(`GLTFExporter: Attribute "${e}" converted to type FLOAT.`),v=o.Utils.toFloat32BufferAttribute(t)):(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),v=new r.THS(new Uint16Array(i),t.itemSize,t.normalized));let s=this.processAccessor(v||t,l);null!==s&&(e.startsWith("_")||this.detectMeshQuantization(e,t),u[e]=s,n.attributes.set(this.getUID(t),s))}if(void 0!==d&&l.setAttribute("normal",d),0===Object.keys(u).length)return null;if(void 0!==e.morphTargetInfluences&&e.morphTargetInfluences.length>0){let t=[],r=[],i={};if(void 0!==e.morphTargetDictionary)for(let t in e.morphTargetDictionary)i[e.morphTargetDictionary[t]]=t;for(let o=0;o<e.morphTargetInfluences.length;++o){let s={},a=!1;for(let e in l.morphAttributes){if("position"!==e&&"normal"!==e){a||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),a=!0);continue}let t=l.morphAttributes[e][o],r=e.toUpperCase(),i=l.attributes[e];if(n.attributes.has(this.getUID(t,!0))){s[r]=n.attributes.get(this.getUID(t,!0));continue}let c=t.clone();if(!l.morphTargetsRelative)for(let e=0,n=t.count;e<n;e++)for(let n=0;n<t.itemSize;n++)0===n&&c.setX(e,t.getX(e)-i.getX(e)),1===n&&c.setY(e,t.getY(e)-i.getY(e)),2===n&&c.setZ(e,t.getZ(e)-i.getZ(e)),3===n&&c.setW(e,t.getW(e)-i.getW(e));s[r]=this.processAccessor(c,l),n.attributes.set(this.getUID(i,!0),s[r])}f.push(s),t.push(e.morphTargetInfluences[o]),void 0!==e.morphTargetDictionary&&r.push(i[o])}c.weights=t,r.length>0&&(c.extras={},c.extras.targetNames=r)}let y=Array.isArray(e.material);if(y&&0===l.groups.length)return null;let m=!1;if(y&&null===l.index){let e=[];for(let t=0,n=l.attributes.position.count;t<n;t++)e[t]=t;l.setIndex(e),m=!0}let b=y?e.material:[e.material],g=y?l.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let e=0,r=g.length;e<r;e++){let r={mode:t,attributes:u};if(this.serializeUserData(l,r),f.length>0&&(r.targets=f),null!==l.index){let t=this.getUID(l.index);(void 0!==g[e].start||void 0!==g[e].count)&&(t+=":"+g[e].start+":"+g[e].count),n.attributes.has(t)?r.indices=n.attributes.get(t):(r.indices=this.processAccessor(l.index,l,g[e].start,g[e].count),n.attributes.set(t,r.indices)),null===r.indices&&delete r.indices}let i=await this.processMaterialAsync(b[g[e].materialIndex]);null!==i&&(r.material=i),h.push(r)}!0===m&&l.setIndex(null),c.primitives=h,i.meshes||(i.meshes=[]),await this._invokeAllAsync(function(t){t.writeMesh&&t.writeMesh(e,c)});let w=i.meshes.push(c)-1;return n.meshes.set(a,w),w}detectMeshQuantization(e,t){let n;if(this.extensionsUsed[s])return;switch(t.array.constructor){case Int8Array:n="byte";break;case Uint8Array:n="unsigned byte";break;case Int16Array:n="short";break;case Uint16Array:n="unsigned short";break;default:return}t.normalized&&(n+=" normalized");let r=e.split("_",1)[0];i[r]&&i[r].includes(n)&&(this.extensionsUsed[s]=!0,this.extensionsRequired[s]=!0)}processCamera(e){let t=this.json;t.cameras||(t.cameras=[]);let n=e.isOrthographicCamera,i={type:n?"orthographic":"perspective"};return n?i.orthographic={xmag:2*e.right,ymag:2*e.top,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:i.perspective={aspectRatio:e.aspect,yfov:r.cj9.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},""!==e.name&&(i.name=e.type),t.cameras.push(i)-1}processAnimation(e,t){let n=this.json,i=this.nodeMap;n.animations||(n.animations=[]);let s=(e=o.Utils.mergeMorphTargetTracks(e.clone(),t)).tracks,a=[],c=[];for(let e=0;e<s.length;++e){let n,o=s[e],u=r.Nwf.parseTrackName(o.name),h=r.Nwf.findNode(t,u.nodeName),f=l[u.propertyName];if("bones"===u.objectName&&(h=!0===h.isSkinnedMesh?h.skeleton.getBoneByName(u.objectIndex):void 0),!h||!f){console.warn('THREE.GLTFExporter: Could not export animation track "%s".',o.name);continue}let p=o.values.length/o.times.length;f===l.morphTargetInfluences&&(p/=h.morphTargetInfluences.length),!0===o.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(n="CUBICSPLINE",p/=3):n=o.getInterpolation()===r.ljd?"STEP":"LINEAR",c.push({input:this.processAccessor(new r.THS(o.times,1)),output:this.processAccessor(new r.THS(o.values,p)),interpolation:n}),a.push({sampler:c.length-1,target:{node:i.get(h),path:f}})}let u={name:e.name||"clip_"+n.animations.length,samplers:c,channels:a};return this.serializeUserData(e,u),n.animations.push(u),n.animations.length-1}processSkin(e){let t=this.json,n=this.nodeMap,i=t.nodes[n.get(e)],o=e.skeleton;if(void 0===o)return null;let s=e.skeleton.bones[0];if(void 0===s)return null;let a=[],l=new Float32Array(16*o.bones.length),c=new r.kn4;for(let t=0;t<o.bones.length;++t)a.push(n.get(o.bones[t])),c.copy(o.boneInverses[t]),c.multiply(e.bindMatrix).toArray(l,16*t);return void 0===t.skins&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new r.THS(l,16)),joints:a,skeleton:n.get(s)}),i.skin=t.skins.length-1}async processNodeAsync(e){let t=this.json,n=this.options,r=this.nodeMap;t.nodes||(t.nodes=[]);let i={};if(n.trs){let t=e.quaternion.toArray(),n=e.position.toArray(),r=e.scale.toArray();u(t,[0,0,0,1])||(i.rotation=t),u(n,[0,0,0])||(i.translation=n),u(r,[1,1,1])||(i.scale=r)}else e.matrixAutoUpdate&&e.updateMatrix(),!1===u(e.matrix.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])&&(i.matrix=e.matrix.elements);if(""!==e.name&&(i.name=String(e.name)),this.serializeUserData(e,i),e.isMesh||e.isLine||e.isPoints){let t=await this.processMeshAsync(e);null!==t&&(i.mesh=t)}else e.isCamera&&(i.camera=this.processCamera(e));e.isSkinnedMesh&&this.skins.push(e);let o=t.nodes.push(i)-1;if(r.set(e,o),e.children.length>0){let t=[];for(let r=0,i=e.children.length;r<i;r++){let i=e.children[r];if(i.visible||!1===n.onlyVisible){let e=await this.processNodeAsync(i);null!==e&&t.push(e)}}t.length>0&&(i.children=t)}return await this._invokeAllAsync(function(t){t.writeNode&&t.writeNode(e,i)}),o}async processSceneAsync(e){let t=this.json,n=this.options;t.scenes||(t.scenes=[],t.scene=0);let r={};""!==e.name&&(r.name=e.name),t.scenes.push(r);let i=[];for(let t=0,r=e.children.length;t<r;t++){let r=e.children[t];if(r.visible||!1===n.onlyVisible){let e=await this.processNodeAsync(r);null!==e&&i.push(e)}}i.length>0&&(r.nodes=i),this.serializeUserData(e,r)}async processObjectsAsync(e){let t=new r.Z58;t.name="AuxScene";for(let n=0;n<e.length;n++)t.children.push(e[n]);await this.processSceneAsync(t)}async processInputAsync(e){let t=this.options;e=e instanceof Array?e:[e],await this._invokeAllAsync(function(t){t.beforeParse&&t.beforeParse(e)});let n=[];for(let t=0;t<e.length;t++)e[t]instanceof r.Z58?await this.processSceneAsync(e[t]):n.push(e[t]);n.length>0&&await this.processObjectsAsync(n);for(let e=0;e<this.skins.length;++e)this.processSkin(this.skins[e]);for(let n=0;n<t.animations.length;++n)this.processAnimation(t.animations[n],e[0]);await this._invokeAllAsync(function(t){t.afterParse&&t.afterParse(e)})}async _invokeAllAsync(e){for(let t=0,n=this.plugins.length;t<n;t++)await e(this.plugins[t])}}class v{constructor(e){this.writer=e,this.name="KHR_lights_punctual"}writeNode(e,t){if(!e.isLight)return;if(!e.isDirectionalLight&&!e.isPointLight&&!e.isSpotLight)return void console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e);let n=this.writer,r=n.json,i=n.extensionsUsed,o={};e.name&&(o.name=e.name),o.color=e.color.toArray(),o.intensity=e.intensity,e.isDirectionalLight?o.type="directional":e.isPointLight?(o.type="point",e.distance>0&&(o.range=e.distance)):e.isSpotLight&&(o.type="spot",e.distance>0&&(o.range=e.distance),o.spot={},o.spot.innerConeAngle=(1-e.penumbra)*e.angle,o.spot.outerConeAngle=e.angle),void 0!==e.decay&&2!==e.decay&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),e.target&&(e.target.parent!==e||0!==e.target.position.x||0!==e.target.position.y||-1!==e.target.position.z)&&console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),i[this.name]||(r.extensions=r.extensions||{},r.extensions[this.name]={lights:[]},i[this.name]=!0);let s=r.extensions[this.name].lights;s.push(o),t.extensions=t.extensions||{},t.extensions[this.name]={light:s.length-1}}}class y{constructor(e){this.writer=e,this.name="KHR_materials_unlit"}async writeMaterialAsync(e,t){if(!e.isMeshBasicMaterial)return;let n=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},n[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}}class m{constructor(e){this.writer=e,this.name="KHR_materials_clearcoat"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.clearcoat)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.clearcoatFactor=e.clearcoat,e.clearcoatMap){let t={index:await n.processTextureAsync(e.clearcoatMap),texCoord:e.clearcoatMap.channel};n.applyTextureTransform(t,e.clearcoatMap),i.clearcoatTexture=t}if(i.clearcoatRoughnessFactor=e.clearcoatRoughness,e.clearcoatRoughnessMap){let t={index:await n.processTextureAsync(e.clearcoatRoughnessMap),texCoord:e.clearcoatRoughnessMap.channel};n.applyTextureTransform(t,e.clearcoatRoughnessMap),i.clearcoatRoughnessTexture=t}if(e.clearcoatNormalMap){let t={index:await n.processTextureAsync(e.clearcoatNormalMap),texCoord:e.clearcoatNormalMap.channel};1!==e.clearcoatNormalScale.x&&(t.scale=e.clearcoatNormalScale.x),n.applyTextureTransform(t,e.clearcoatNormalMap),i.clearcoatNormalTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class b{constructor(e){this.writer=e,this.name="KHR_materials_dispersion"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.dispersion)return;let n=this.writer.extensionsUsed,r={};r.dispersion=e.dispersion,t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class g{constructor(e){this.writer=e,this.name="KHR_materials_iridescence"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.iridescence)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.iridescenceFactor=e.iridescence,e.iridescenceMap){let t={index:await n.processTextureAsync(e.iridescenceMap),texCoord:e.iridescenceMap.channel};n.applyTextureTransform(t,e.iridescenceMap),i.iridescenceTexture=t}if(i.iridescenceIor=e.iridescenceIOR,i.iridescenceThicknessMinimum=e.iridescenceThicknessRange[0],i.iridescenceThicknessMaximum=e.iridescenceThicknessRange[1],e.iridescenceThicknessMap){let t={index:await n.processTextureAsync(e.iridescenceThicknessMap),texCoord:e.iridescenceThicknessMap.channel};n.applyTextureTransform(t,e.iridescenceThicknessMap),i.iridescenceThicknessTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class w{constructor(e){this.writer=e,this.name="KHR_materials_transmission"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.transmissionFactor=e.transmission,e.transmissionMap){let t={index:await n.processTextureAsync(e.transmissionMap),texCoord:e.transmissionMap.channel};n.applyTextureTransform(t,e.transmissionMap),i.transmissionTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class k{constructor(e){this.writer=e,this.name="KHR_materials_volume"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.thicknessFactor=e.thickness,e.thicknessMap){let t={index:await n.processTextureAsync(e.thicknessMap),texCoord:e.thicknessMap.channel};n.applyTextureTransform(t,e.thicknessMap),i.thicknessTexture=t}e.attenuationDistance!==1/0&&(i.attenuationDistance=e.attenuationDistance),i.attenuationColor=e.attenuationColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class x{constructor(e){this.writer=e,this.name="KHR_materials_ior"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||1.5===e.ior)return;let n=this.writer.extensionsUsed,r={};r.ior=e.ior,t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class T{constructor(e){this.writer=e,this.name="KHR_materials_specular"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||1===e.specularIntensity&&e.specularColor.equals(c)&&!e.specularIntensityMap&&!e.specularColorMap)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.specularIntensityMap){let t={index:await n.processTextureAsync(e.specularIntensityMap),texCoord:e.specularIntensityMap.channel};n.applyTextureTransform(t,e.specularIntensityMap),i.specularTexture=t}if(e.specularColorMap){let t={index:await n.processTextureAsync(e.specularColorMap),texCoord:e.specularColorMap.channel};n.applyTextureTransform(t,e.specularColorMap),i.specularColorTexture=t}i.specularFactor=e.specularIntensity,i.specularColorFactor=e.specularColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class P{constructor(e){this.writer=e,this.name="KHR_materials_sheen"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0==e.sheen)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.sheenRoughnessMap){let t={index:await n.processTextureAsync(e.sheenRoughnessMap),texCoord:e.sheenRoughnessMap.channel};n.applyTextureTransform(t,e.sheenRoughnessMap),i.sheenRoughnessTexture=t}if(e.sheenColorMap){let t={index:await n.processTextureAsync(e.sheenColorMap),texCoord:e.sheenColorMap.channel};n.applyTextureTransform(t,e.sheenColorMap),i.sheenColorTexture=t}i.sheenRoughnessFactor=e.sheenRoughness,i.sheenColorFactor=e.sheenColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class S{constructor(e){this.writer=e,this.name="KHR_materials_anisotropy"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0==e.anisotropy)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.anisotropyMap){let t={index:await n.processTextureAsync(e.anisotropyMap)};n.applyTextureTransform(t,e.anisotropyMap),i.anisotropyTexture=t}i.anisotropyStrength=e.anisotropy,i.anisotropyRotation=e.anisotropyRotation,t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class O{constructor(e){this.writer=e,this.name="KHR_materials_emissive_strength"}async writeMaterialAsync(e,t){if(!e.isMeshStandardMaterial||1===e.emissiveIntensity)return;let n=this.writer.extensionsUsed,r={};r.emissiveStrength=e.emissiveIntensity,t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class R{constructor(e){this.writer=e,this.name="EXT_materials_bump"}async writeMaterialAsync(e,t){if(!e.isMeshStandardMaterial||1===e.bumpScale&&!e.bumpMap)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.bumpMap){let t={index:await n.processTextureAsync(e.bumpMap),texCoord:e.bumpMap.channel};n.applyTextureTransform(t,e.bumpMap),i.bumpTexture=t}i.bumpFactor=e.bumpScale,t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class E{constructor(e){this.writer=e,this.name="EXT_mesh_gpu_instancing"}writeNode(e,t){if(!e.isInstancedMesh)return;let n=this.writer,i=new Float32Array(3*e.count),o=new Float32Array(4*e.count),s=new Float32Array(3*e.count),a=new r.kn4,l=new r.Pq0,c=new r.PTz,u=new r.Pq0;for(let t=0;t<e.count;t++)e.getMatrixAt(t,a),a.decompose(l,c,u),l.toArray(i,3*t),c.toArray(o,4*t),u.toArray(s,3*t);let h={TRANSLATION:n.processAccessor(new r.THS(i,3)),ROTATION:n.processAccessor(new r.THS(o,4)),SCALE:n.processAccessor(new r.THS(s,3))};e.instanceColor&&(h._COLOR_0=n.processAccessor(e.instanceColor)),t.extensions=t.extensions||{},t.extensions[this.name]={attributes:h},n.extensionsUsed[this.name]=!0,n.extensionsRequired[this.name]=!0}}function A(e,t){if(t===r.RJ4)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(t!==r.rYR&&t!==r.O49)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),e;{let n=e.getIndex();if(null===n){let t=[],r=e.getAttribute("position");if(void 0===r)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<r.count;e++)t.push(e);e.setIndex(t),n=e.getIndex()}let i=n.count-2,o=[];if(t===r.rYR)for(let e=1;e<=i;e++)o.push(n.getX(0)),o.push(n.getX(e)),o.push(n.getX(e+1));else for(let e=0;e<i;e++)e%2==0?(o.push(n.getX(e)),o.push(n.getX(e+1)),o.push(n.getX(e+2))):(o.push(n.getX(e+2)),o.push(n.getX(e+1)),o.push(n.getX(e)));o.length/3!==i&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");let s=e.clone();return s.setIndex(o),s.clearGroups(),s}}o.Utils={insertKeyframe:function(e,t){let n,r=e.getValueSize(),i=new e.TimeBufferType(e.times.length+1),o=new e.ValueBufferType(e.values.length+r),s=e.createInterpolant(new e.ValueBufferType(r));if(0===e.times.length){i[0]=t;for(let e=0;e<r;e++)o[e]=0;n=0}else if(t<e.times[0]){if(.001>Math.abs(e.times[0]-t))return 0;i[0]=t,i.set(e.times,1),o.set(s.evaluate(t),0),o.set(e.values,r),n=0}else if(t>e.times[e.times.length-1]){if(.001>Math.abs(e.times[e.times.length-1]-t))return e.times.length-1;i[i.length-1]=t,i.set(e.times,0),o.set(e.values,0),o.set(s.evaluate(t),e.values.length),n=i.length-1}else for(let a=0;a<e.times.length;a++){if(.001>Math.abs(e.times[a]-t))return a;if(e.times[a]<t&&e.times[a+1]>t){i.set(e.times.slice(0,a+1),0),i[a+1]=t,i.set(e.times.slice(a+1),a+2),o.set(e.values.slice(0,(a+1)*r),0),o.set(s.evaluate(t),(a+1)*r),o.set(e.values.slice((a+1)*r),(a+2)*r),n=a+1;break}}return e.times=i,e.values=o,n},mergeMorphTargetTracks:function(e,t){let n=[],i={},o=e.tracks;for(let e=0;e<o.length;++e){let s,a=o[e],l=r.Nwf.parseTrackName(a.name),c=r.Nwf.findNode(t,l.nodeName);if("morphTargetInfluences"!==l.propertyName||void 0===l.propertyIndex){n.push(a);continue}if(a.createInterpolant!==a.InterpolantFactoryMethodDiscrete&&a.createInterpolant!==a.InterpolantFactoryMethodLinear){if(a.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),(a=a.clone()).setInterpolation(r.PJ3)}let u=c.morphTargetInfluences.length,h=c.morphTargetDictionary[l.propertyIndex];if(void 0===h)throw Error("THREE.GLTFExporter: Morph target name not found: "+l.propertyIndex);if(void 0===i[c.uuid]){let e=new(s=a.clone()).ValueBufferType(u*s.times.length);for(let t=0;t<s.times.length;t++)e[t*u+h]=s.values[t];s.name=(l.nodeName||"")+".morphTargetInfluences",s.values=e,i[c.uuid]=s,n.push(s);continue}let f=a.createInterpolant(new a.ValueBufferType(1));s=i[c.uuid];for(let e=0;e<s.times.length;e++)s.values[e*u+h]=f.evaluate(s.times[e]);for(let e=0;e<a.times.length;e++){let t=this.insertKeyframe(s,a.times[e]);s.values[t*u+h]=a.values[e]}}return e.tracks=n,e},toFloat32BufferAttribute:function(e){let t=new r.THS(new Float32Array(e.count*e.itemSize),e.itemSize,!1);if(!e.normalized&&!e.isInterleavedBufferAttribute)return t.array.set(e.array),t;for(let n=0,r=e.count;n<r;n++)for(let r=0;r<e.itemSize;r++)t.setComponent(n,r,e.getComponent(n,r));return t}};class M extends r.aHM{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(e){return new L(e)}),this.register(function(e){return new N(e)}),this.register(function(e){return new K(e)}),this.register(function(e){return new X(e)}),this.register(function(e){return new W(e)}),this.register(function(e){return new H(e)}),this.register(function(e){return new U(e)}),this.register(function(e){return new D(e)}),this.register(function(e){return new z(e)}),this.register(function(e){return new B(e)}),this.register(function(e){return new G(e)}),this.register(function(e){return new F(e)}),this.register(function(e){return new q(e)}),this.register(function(e){return new V(e)}),this.register(function(e){return new C(e)}),this.register(function(e){return new Y(e)}),this.register(function(e){return new J(e)})}load(e,t,n,i){let o,s=this;if(""!==this.resourcePath)o=this.resourcePath;else if(""!==this.path){let t=r.r6x.extractUrlBase(e);o=r.r6x.resolveURL(t,this.path)}else o=r.r6x.extractUrlBase(e);this.manager.itemStart(e);let a=function(t){i?i(t):console.error(t),s.manager.itemError(e),s.manager.itemEnd(e)},l=new r.Y9S(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials),l.load(e,function(n){try{s.parse(n,o,function(n){t(n),s.manager.itemEnd(e)},a)}catch(e){a(e)}},n,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return -1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return -1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,n,r){let i,o={},s={},a=new TextDecoder;if("string"==typeof e)i=JSON.parse(e);else if(e instanceof ArrayBuffer)if(a.decode(new Uint8Array(e,0,4))===Z){try{o[I.KHR_BINARY_GLTF]=new Q(e)}catch(e){r&&r(e);return}i=JSON.parse(o[I.KHR_BINARY_GLTF].content)}else i=JSON.parse(a.decode(e));else i=e;if(void 0===i.asset||i.asset.version[0]<2){r&&r(Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}let l=new eb(i,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){let t=this.pluginCallbacks[e](l);t.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),s[t.name]=t,o[t.name]=!0}if(i.extensionsUsed)for(let e=0;e<i.extensionsUsed.length;++e){let t=i.extensionsUsed[e],n=i.extensionsRequired||[];switch(t){case I.KHR_MATERIALS_UNLIT:o[t]=new j;break;case I.KHR_DRACO_MESH_COMPRESSION:o[t]=new $(i,this.dracoLoader);break;case I.KHR_TEXTURE_TRANSFORM:o[t]=new ee;break;case I.KHR_MESH_QUANTIZATION:o[t]=new et;break;default:n.indexOf(t)>=0&&void 0===s[t]&&console.warn('THREE.GLTFLoader: Unknown extension "'+t+'".')}}l.setExtensions(o),l.setPlugins(s),l.parse(n,r)}parseAsync(e,t){let n=this;return new Promise(function(r,i){n.parse(e,t,r,i)})}}function _(){let e={};return{get:function(t){return e[t]},add:function(t,n){e[t]=n},remove:function(t){delete e[t]},removeAll:function(){e={}}}}let I={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class C{constructor(e){this.parser=e,this.name=I.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){let e=this.parser,t=this.parser.json.nodes||[];for(let n=0,r=t.length;n<r;n++){let r=t[n];r.extensions&&r.extensions[this.name]&&void 0!==r.extensions[this.name].light&&e._addNodeRef(this.cache,r.extensions[this.name].light)}}_loadLight(e){let t,n=this.parser,i="light:"+e,o=n.cache.get(i);if(o)return o;let s=n.json,a=((s.extensions&&s.extensions[this.name]||{}).lights||[])[e],l=new r.Q1f(0xffffff);void 0!==a.color&&l.setRGB(a.color[0],a.color[1],a.color[2],r.Zr2);let c=void 0!==a.range?a.range:0;switch(a.type){case"directional":(t=new r.ZyN(l)).target.position.set(0,0,-1),t.add(t.target);break;case"point":(t=new r.HiM(l)).distance=c;break;case"spot":(t=new r.nCl(l)).distance=c,a.spot=a.spot||{},a.spot.innerConeAngle=void 0!==a.spot.innerConeAngle?a.spot.innerConeAngle:0,a.spot.outerConeAngle=void 0!==a.spot.outerConeAngle?a.spot.outerConeAngle:Math.PI/4,t.angle=a.spot.outerConeAngle,t.penumbra=1-a.spot.innerConeAngle/a.spot.outerConeAngle,t.target.position.set(0,0,-1),t.add(t.target);break;default:throw Error("THREE.GLTFLoader: Unexpected light type: "+a.type)}return t.position.set(0,0,0),ed(t,a),void 0!==a.intensity&&(t.intensity=a.intensity),t.name=n.createUniqueName(a.name||"light_"+e),o=Promise.resolve(t),n.cache.add(i,o),o}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){let t=this,n=this.parser,r=n.json.nodes[e],i=(r.extensions&&r.extensions[this.name]||{}).light;return void 0===i?null:this._loadLight(i).then(function(e){return n._getNodeRef(t.cache,i,e)})}}class j{constructor(){this.name=I.KHR_MATERIALS_UNLIT}getMaterialType(){return r.V9B}extendParams(e,t,n){let i=[];e.color=new r.Q1f(1,1,1),e.opacity=1;let o=t.pbrMetallicRoughness;if(o){if(Array.isArray(o.baseColorFactor)){let t=o.baseColorFactor;e.color.setRGB(t[0],t[1],t[2],r.Zr2),e.opacity=t[3]}void 0!==o.baseColorTexture&&i.push(n.assignTexture(e,"map",o.baseColorTexture,r.er$))}return Promise.all(i)}}class B{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){let n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=n.extensions[this.name].emissiveStrength;return void 0!==r&&(t.emissiveIntensity=r),Promise.resolve()}}class L{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let o=[],s=i.extensions[this.name];if(void 0!==s.clearcoatFactor&&(t.clearcoat=s.clearcoatFactor),void 0!==s.clearcoatTexture&&o.push(n.assignTexture(t,"clearcoatMap",s.clearcoatTexture)),void 0!==s.clearcoatRoughnessFactor&&(t.clearcoatRoughness=s.clearcoatRoughnessFactor),void 0!==s.clearcoatRoughnessTexture&&o.push(n.assignTexture(t,"clearcoatRoughnessMap",s.clearcoatRoughnessTexture)),void 0!==s.clearcoatNormalTexture&&(o.push(n.assignTexture(t,"clearcoatNormalMap",s.clearcoatNormalTexture)),void 0!==s.clearcoatNormalTexture.scale)){let e=s.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new r.I9Y(e,e)}return Promise.all(o)}}class N{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_DISPERSION}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=n.extensions[this.name];return t.dispersion=void 0!==r.dispersion?r.dispersion:0,Promise.resolve()}}class F{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],o=r.extensions[this.name];return void 0!==o.iridescenceFactor&&(t.iridescence=o.iridescenceFactor),void 0!==o.iridescenceTexture&&i.push(n.assignTexture(t,"iridescenceMap",o.iridescenceTexture)),void 0!==o.iridescenceIor&&(t.iridescenceIOR=o.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==o.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),void 0!==o.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),void 0!==o.iridescenceThicknessTexture&&i.push(n.assignTexture(t,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(i)}}class H{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_SHEEN}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let o=[];t.sheenColor=new r.Q1f(0,0,0),t.sheenRoughness=0,t.sheen=1;let s=i.extensions[this.name];if(void 0!==s.sheenColorFactor){let e=s.sheenColorFactor;t.sheenColor.setRGB(e[0],e[1],e[2],r.Zr2)}return void 0!==s.sheenRoughnessFactor&&(t.sheenRoughness=s.sheenRoughnessFactor),void 0!==s.sheenColorTexture&&o.push(n.assignTexture(t,"sheenColorMap",s.sheenColorTexture,r.er$)),void 0!==s.sheenRoughnessTexture&&o.push(n.assignTexture(t,"sheenRoughnessMap",s.sheenRoughnessTexture)),Promise.all(o)}}class U{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],o=r.extensions[this.name];return void 0!==o.transmissionFactor&&(t.transmission=o.transmissionFactor),void 0!==o.transmissionTexture&&i.push(n.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(i)}}class D{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_VOLUME}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let o=[],s=i.extensions[this.name];t.thickness=void 0!==s.thicknessFactor?s.thicknessFactor:0,void 0!==s.thicknessTexture&&o.push(n.assignTexture(t,"thicknessMap",s.thicknessTexture)),t.attenuationDistance=s.attenuationDistance||1/0;let a=s.attenuationColor||[1,1,1];return t.attenuationColor=new r.Q1f().setRGB(a[0],a[1],a[2],r.Zr2),Promise.all(o)}}class z{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_IOR}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=n.extensions[this.name];return t.ior=void 0!==r.ior?r.ior:1.5,Promise.resolve()}}class G{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_SPECULAR}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let o=[],s=i.extensions[this.name];t.specularIntensity=void 0!==s.specularFactor?s.specularFactor:1,void 0!==s.specularTexture&&o.push(n.assignTexture(t,"specularIntensityMap",s.specularTexture));let a=s.specularColorFactor||[1,1,1];return t.specularColor=new r.Q1f().setRGB(a[0],a[1],a[2],r.Zr2),void 0!==s.specularColorTexture&&o.push(n.assignTexture(t,"specularColorMap",s.specularColorTexture,r.er$)),Promise.all(o)}}class V{constructor(e){this.parser=e,this.name=I.EXT_MATERIALS_BUMP}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],o=r.extensions[this.name];return t.bumpScale=void 0!==o.bumpFactor?o.bumpFactor:1,void 0!==o.bumpTexture&&i.push(n.assignTexture(t,"bumpMap",o.bumpTexture)),Promise.all(i)}}class q{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],o=r.extensions[this.name];return void 0!==o.anisotropyStrength&&(t.anisotropy=o.anisotropyStrength),void 0!==o.anisotropyRotation&&(t.anisotropyRotation=o.anisotropyRotation),void 0!==o.anisotropyTexture&&i.push(n.assignTexture(t,"anisotropyMap",o.anisotropyTexture)),Promise.all(i)}}class K{constructor(e){this.parser=e,this.name=I.KHR_TEXTURE_BASISU}loadTexture(e){let t=this.parser,n=t.json,r=n.textures[e];if(!r.extensions||!r.extensions[this.name])return null;let i=r.extensions[this.name],o=t.options.ktx2Loader;if(!o)if(!(n.extensionsRequired&&n.extensionsRequired.indexOf(this.name)>=0))return null;else throw Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return t.loadTextureImage(e,i.source,o)}}class X{constructor(e){this.parser=e,this.name=I.EXT_TEXTURE_WEBP}loadTexture(e){let t=this.name,n=this.parser,r=n.json,i=r.textures[e];if(!i.extensions||!i.extensions[t])return null;let o=i.extensions[t],s=r.images[o.source],a=n.textureLoader;if(s.uri){let e=n.options.manager.getHandler(s.uri);null!==e&&(a=e)}return n.loadTextureImage(e,o.source,a)}}class W{constructor(e){this.parser=e,this.name=I.EXT_TEXTURE_AVIF}loadTexture(e){let t=this.name,n=this.parser,r=n.json,i=r.textures[e];if(!i.extensions||!i.extensions[t])return null;let o=i.extensions[t],s=r.images[o.source],a=n.textureLoader;if(s.uri){let e=n.options.manager.getHandler(s.uri);null!==e&&(a=e)}return n.loadTextureImage(e,o.source,a)}}class Y{constructor(e){this.name=I.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){let t=this.parser.json,n=t.bufferViews[e];if(!n.extensions||!n.extensions[this.name])return null;{let e=n.extensions[this.name],r=this.parser.getDependency("buffer",e.buffer),i=this.parser.options.meshoptDecoder;if(!i||!i.supported)if(!(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0))return null;else throw Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return r.then(function(t){let n=e.byteOffset||0,r=e.byteLength||0,o=e.count,s=e.byteStride,a=new Uint8Array(t,n,r);return i.decodeGltfBufferAsync?i.decodeGltfBufferAsync(o,s,a,e.mode,e.filter).then(function(e){return e.buffer}):i.ready.then(function(){let t=new ArrayBuffer(o*s);return i.decodeGltfBuffer(new Uint8Array(t),o,s,a,e.mode,e.filter),t})})}}}class J{constructor(e){this.name=I.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){let t=this.parser.json,n=t.nodes[e];if(!n.extensions||!n.extensions[this.name]||void 0===n.mesh)return null;for(let e of t.meshes[n.mesh].primitives)if(e.mode!==eo.TRIANGLES&&e.mode!==eo.TRIANGLE_STRIP&&e.mode!==eo.TRIANGLE_FAN&&void 0!==e.mode)return null;let i=n.extensions[this.name].attributes,o=[],s={};for(let e in i)o.push(this.parser.getDependency("accessor",i[e]).then(t=>(s[e]=t,s[e])));return o.length<1?null:(o.push(this.parser.createNodeMesh(e)),Promise.all(o).then(e=>{let t=e.pop(),n=t.isGroup?t.children:[t],i=e[0].count,o=[];for(let e of n){let t=new r.kn4,n=new r.Pq0,a=new r.PTz,l=new r.Pq0(1,1,1),c=new r.ZLX(e.geometry,e.material,i);for(let e=0;e<i;e++)s.TRANSLATION&&n.fromBufferAttribute(s.TRANSLATION,e),s.ROTATION&&a.fromBufferAttribute(s.ROTATION,e),s.SCALE&&l.fromBufferAttribute(s.SCALE,e),c.setMatrixAt(e,t.compose(n,a,l));for(let t in s)if("_COLOR_0"===t){let e=s[t];c.instanceColor=new r.uWO(e.array,e.itemSize,e.normalized)}else"TRANSLATION"!==t&&"ROTATION"!==t&&"SCALE"!==t&&e.geometry.setAttribute(t,s[t]);r.B69.prototype.copy.call(c,e),this.parser.assignFinalMaterial(c),o.push(c)}return t.isGroup?(t.clear(),t.add(...o),t):o[0]}))}}let Z="glTF";class Q{constructor(e){this.name=I.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12),n=new TextDecoder;if(this.header={magic:n.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Z)throw Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw Error("THREE.GLTFLoader: Legacy binary file detected.");const r=this.header.length-12,i=new DataView(e,12);let o=0;for(;o<r;){const t=i.getUint32(o,!0);o+=4;const r=i.getUint32(o,!0);if(o+=4,0x4e4f534a===r){const r=new Uint8Array(e,12+o,t);this.content=n.decode(r)}else if(5130562===r){const n=12+o;this.body=e.slice(n,n+t)}o+=t}if(null===this.content)throw Error("THREE.GLTFLoader: JSON content not found.")}}class ${constructor(e,t){if(!t)throw Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=I.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){let n=this.json,i=this.dracoLoader,o=e.extensions[this.name].bufferView,s=e.extensions[this.name].attributes,a={},l={},c={};for(let e in s)a[eu[e]||e.toLowerCase()]=s[e];for(let t in e.attributes){let r=eu[t]||t.toLowerCase();if(void 0!==s[t]){let i=n.accessors[e.attributes[t]],o=es[i.componentType];c[r]=o.name,l[r]=!0===i.normalized}}return t.getDependency("bufferView",o).then(function(e){return new Promise(function(t,n){i.decodeDracoFile(e,function(e){for(let t in e.attributes){let n=e.attributes[t],r=l[t];void 0!==r&&(n.normalized=r)}t(e)},a,c,r.Zr2,n)})})}}class ee{constructor(){this.name=I.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(void 0===t.texCoord||t.texCoord===e.channel)&&void 0===t.offset&&void 0===t.rotation&&void 0===t.scale||(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class et{constructor(){this.name=I.KHR_MESH_QUANTIZATION}}class en extends r.lGw{constructor(e,t,n,r){super(e,t,n,r)}copySampleValue_(e){let t=this.resultBuffer,n=this.sampleValues,r=this.valueSize,i=e*r*3+r;for(let e=0;e!==r;e++)t[e]=n[i+e];return t}interpolate_(e,t,n,r){let i=this.resultBuffer,o=this.sampleValues,s=this.valueSize,a=2*s,l=3*s,c=r-t,u=(n-t)/c,h=u*u,f=h*u,p=e*l,d=p-l,v=-2*f+3*h,y=f-h,m=1-v,b=y-h+u;for(let e=0;e!==s;e++){let t=o[d+e+s],n=o[d+e+a]*c,r=o[p+e+s],l=o[p+e]*c;i[e]=m*t+b*n+v*r+y*l}return i}}let er=new r.PTz;class ei extends en{interpolate_(e,t,n,r){let i=super.interpolate_(e,t,n,r);return er.fromArray(i).normalize().toArray(i),i}}let eo={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},es={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},ea={9728:r.hxR,9729:r.k6q,9984:r.pHI,9985:r.kRr,9986:r.Cfg,9987:r.$_I},el={33071:r.ghU,33648:r.kTW,10497:r.GJx},ec={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},eu={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},eh={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},ef={CUBICSPLINE:void 0,LINEAR:r.PJ3,STEP:r.ljd};function ep(e,t,n){for(let r in n.extensions)void 0===e[r]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[r]=n.extensions[r])}function ed(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function ev(e){let t="",n=Object.keys(e).sort();for(let r=0,i=n.length;r<i;r++)t+=n[r]+":"+e[n[r]]+";";return t}function ey(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}let em=new r.kn4;class eb{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new _,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let n=!1,i=-1,o=!1,s=-1;if("u">typeof navigator){const e=navigator.userAgent;n=!0===/^((?!chrome|android).)*safari/i.test(e);const t=e.match(/Version\/(\d+)/);i=n&&t?parseInt(t[1],10):-1,s=(o=e.indexOf("Firefox")>-1)?e.match(/Firefox\/([0-9]+)\./)[1]:-1}"u"<typeof createImageBitmap||n&&i<17||o&&s<98?this.textureLoader=new r.Tap(this.options.manager):this.textureLoader=new r.Kzg(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new r.Y9S(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){let n=this,r=this.json,i=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(e){return e._markDefs&&e._markDefs()}),Promise.all(this._invokeAll(function(e){return e.beforeRoot&&e.beforeRoot()})).then(function(){return Promise.all([n.getDependencies("scene"),n.getDependencies("animation"),n.getDependencies("camera")])}).then(function(t){let o={scene:t[0][r.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:r.asset,parser:n,userData:{}};return ep(i,o,r),ed(o,r),Promise.all(n._invokeAll(function(e){return e.afterRoot&&e.afterRoot(o)})).then(function(){for(let e of o.scenes)e.updateMatrixWorld();e(o)})}).catch(t)}_markDefs(){let e=this.json.nodes||[],t=this.json.skins||[],n=this.json.meshes||[];for(let n=0,r=t.length;n<r;n++){let r=t[n].joints;for(let t=0,n=r.length;t<n;t++)e[r[t]].isBone=!0}for(let t=0,r=e.length;t<r;t++){let r=e[t];void 0!==r.mesh&&(this._addNodeRef(this.meshCache,r.mesh),void 0!==r.skin&&(n[r.mesh].isSkinnedMesh=!0)),void 0!==r.camera&&this._addNodeRef(this.cameraCache,r.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,n){if(e.refs[t]<=1)return n;let r=n.clone(),i=(e,t)=>{let n=this.associations.get(e);for(let[r,o]of(null!=n&&this.associations.set(t,n),e.children.entries()))i(o,t.children[r])};return i(n,r),r.name+="_instance_"+e.uses[t]++,r}_invokeOne(e){let t=Object.values(this.plugins);t.push(this);for(let n=0;n<t.length;n++){let r=e(t[n]);if(r)return r}return null}_invokeAll(e){let t=Object.values(this.plugins);t.unshift(this);let n=[];for(let r=0;r<t.length;r++){let i=e(t[r]);i&&n.push(i)}return n}getDependency(e,t){let n=e+":"+t,r=this.cache.get(n);if(!r){switch(e){case"scene":r=this.loadScene(t);break;case"node":r=this._invokeOne(function(e){return e.loadNode&&e.loadNode(t)});break;case"mesh":r=this._invokeOne(function(e){return e.loadMesh&&e.loadMesh(t)});break;case"accessor":r=this.loadAccessor(t);break;case"bufferView":r=this._invokeOne(function(e){return e.loadBufferView&&e.loadBufferView(t)});break;case"buffer":r=this.loadBuffer(t);break;case"material":r=this._invokeOne(function(e){return e.loadMaterial&&e.loadMaterial(t)});break;case"texture":r=this._invokeOne(function(e){return e.loadTexture&&e.loadTexture(t)});break;case"skin":r=this.loadSkin(t);break;case"animation":r=this._invokeOne(function(e){return e.loadAnimation&&e.loadAnimation(t)});break;case"camera":r=this.loadCamera(t);break;default:if(!(r=this._invokeOne(function(n){return n!=this&&n.getDependency&&n.getDependency(e,t)})))throw Error("Unknown type: "+e)}this.cache.add(n,r)}return r}getDependencies(e){let t=this.cache.get(e);if(!t){let n=this;t=Promise.all((this.json[e+("mesh"===e?"es":"s")]||[]).map(function(t,r){return n.getDependency(e,r)})),this.cache.add(e,t)}return t}loadBuffer(e){let t=this.json.buffers[e],n=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[I.KHR_BINARY_GLTF].body);let i=this.options;return new Promise(function(e,o){n.load(r.r6x.resolveURL(t.uri,i.path),e,void 0,function(){o(Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){let t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(e){let n=t.byteLength||0,r=t.byteOffset||0;return e.slice(r,r+n)})}loadAccessor(e){let t=this,n=this.json,i=this.json.accessors[e];if(void 0===i.bufferView&&void 0===i.sparse){let e=ec[i.type],t=es[i.componentType],n=!0===i.normalized,o=new t(i.count*e);return Promise.resolve(new r.THS(o,e,n))}let o=[];return void 0!==i.bufferView?o.push(this.getDependency("bufferView",i.bufferView)):o.push(null),void 0!==i.sparse&&(o.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),o.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(o).then(function(e){let o,s,a=e[0],l=ec[i.type],c=es[i.componentType],u=c.BYTES_PER_ELEMENT,h=u*l,f=i.byteOffset||0,p=void 0!==i.bufferView?n.bufferViews[i.bufferView].byteStride:void 0,d=!0===i.normalized;if(p&&p!==h){let e=Math.floor(f/p),n="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+e+":"+i.count,h=t.cache.get(n);h||(o=new c(a,e*p,i.count*p/u),h=new r.eB$(o,p/u),t.cache.add(n,h)),s=new r.eHs(h,l,f%p/u,d)}else o=null===a?new c(i.count*l):new c(a,f,i.count*l),s=new r.THS(o,l,d);if(void 0!==i.sparse){let t=ec.SCALAR,n=es[i.sparse.indices.componentType],o=i.sparse.indices.byteOffset||0,u=i.sparse.values.byteOffset||0,h=new n(e[1],o,i.sparse.count*t),f=new c(e[2],u,i.sparse.count*l);null!==a&&(s=new r.THS(s.array.slice(),s.itemSize,s.normalized)),s.normalized=!1;for(let e=0,t=h.length;e<t;e++){let t=h[e];if(s.setX(t,f[e*l]),l>=2&&s.setY(t,f[e*l+1]),l>=3&&s.setZ(t,f[e*l+2]),l>=4&&s.setW(t,f[e*l+3]),l>=5)throw Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}s.normalized=d}return s})}loadTexture(e){let t=this.json,n=this.options,r=t.textures[e].source,i=t.images[r],o=this.textureLoader;if(i.uri){let e=n.manager.getHandler(i.uri);null!==e&&(o=e)}return this.loadTextureImage(e,r,o)}loadTextureImage(e,t,n){let i=this,o=this.json,s=o.textures[e],a=o.images[t],l=(a.uri||a.bufferView)+":"+s.sampler;if(this.textureCache[l])return this.textureCache[l];let c=this.loadImageSource(t,n).then(function(t){t.flipY=!1,t.name=s.name||a.name||"",""===t.name&&"string"==typeof a.uri&&!1===a.uri.startsWith("data:image/")&&(t.name=a.uri);let n=(o.samplers||{})[s.sampler]||{};return t.magFilter=ea[n.magFilter]||r.k6q,t.minFilter=ea[n.minFilter]||r.$_I,t.wrapS=el[n.wrapS]||r.GJx,t.wrapT=el[n.wrapT]||r.GJx,t.generateMipmaps=!t.isCompressedTexture&&t.minFilter!==r.hxR&&t.minFilter!==r.k6q,i.associations.set(t,{textures:e}),t}).catch(function(){return null});return this.textureCache[l]=c,c}loadImageSource(e,t){let n=this.json,i=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then(e=>e.clone());let o=n.images[e],s=self.URL||self.webkitURL,a=o.uri||"",l=!1;if(void 0!==o.bufferView)a=this.getDependency("bufferView",o.bufferView).then(function(e){l=!0;let t=new Blob([e],{type:o.mimeType});return a=s.createObjectURL(t)});else if(void 0===o.uri)throw Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");let c=Promise.resolve(a).then(function(e){return new Promise(function(n,o){let s=n;!0===t.isImageBitmapLoader&&(s=function(e){let t=new r.gPd(e);t.needsUpdate=!0,n(t)}),t.load(r.r6x.resolveURL(e,i.path),s,void 0,o)})}).then(function(e){var t;return!0===l&&s.revokeObjectURL(a),ed(e,o),e.userData.mimeType=o.mimeType||((t=o.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":t.search(/\.ktx2($|\?)/i)>0||0===t.search(/^data\:image\/ktx2/)?"image/ktx2":"image/png"),e}).catch(function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",a),e});return this.sourceCache[e]=c,c}assignTexture(e,t,n,r){let i=this;return this.getDependency("texture",n.index).then(function(o){if(!o)return null;if(void 0!==n.texCoord&&n.texCoord>0&&((o=o.clone()).channel=n.texCoord),i.extensions[I.KHR_TEXTURE_TRANSFORM]){let e=void 0!==n.extensions?n.extensions[I.KHR_TEXTURE_TRANSFORM]:void 0;if(e){let t=i.associations.get(o);o=i.extensions[I.KHR_TEXTURE_TRANSFORM].extendTexture(o,e),i.associations.set(o,t)}}return void 0!==r&&(o.colorSpace=r),e[t]=o,o})}assignFinalMaterial(e){let t=e.geometry,n=e.material,i=void 0===t.attributes.tangent,o=void 0!==t.attributes.color,s=void 0===t.attributes.normal;if(e.isPoints){let e="PointsMaterial:"+n.uuid,t=this.cache.get(e);t||(t=new r.BH$,r.imn.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,t.sizeAttenuation=!1,this.cache.add(e,t)),n=t}else if(e.isLine){let e="LineBasicMaterial:"+n.uuid,t=this.cache.get(e);t||(t=new r.mrM,r.imn.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,this.cache.add(e,t)),n=t}if(i||o||s){let e="ClonedMaterial:"+n.uuid+":";i&&(e+="derivative-tangents:"),o&&(e+="vertex-colors:"),s&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=n.clone(),o&&(t.vertexColors=!0),s&&(t.flatShading=!0),i&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(n))),n=t}e.material=n}getMaterialType(){return r._4j}loadMaterial(e){let t,n=this,i=this.json,o=this.extensions,s=i.materials[e],a={},l=s.extensions||{},c=[];if(l[I.KHR_MATERIALS_UNLIT]){let e=o[I.KHR_MATERIALS_UNLIT];t=e.getMaterialType(),c.push(e.extendParams(a,s,n))}else{let i=s.pbrMetallicRoughness||{};if(a.color=new r.Q1f(1,1,1),a.opacity=1,Array.isArray(i.baseColorFactor)){let e=i.baseColorFactor;a.color.setRGB(e[0],e[1],e[2],r.Zr2),a.opacity=e[3]}void 0!==i.baseColorTexture&&c.push(n.assignTexture(a,"map",i.baseColorTexture,r.er$)),a.metalness=void 0!==i.metallicFactor?i.metallicFactor:1,a.roughness=void 0!==i.roughnessFactor?i.roughnessFactor:1,void 0!==i.metallicRoughnessTexture&&(c.push(n.assignTexture(a,"metalnessMap",i.metallicRoughnessTexture)),c.push(n.assignTexture(a,"roughnessMap",i.metallicRoughnessTexture))),t=this._invokeOne(function(t){return t.getMaterialType&&t.getMaterialType(e)}),c.push(Promise.all(this._invokeAll(function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,a)})))}!0===s.doubleSided&&(a.side=r.$EB);let u=s.alphaMode||"OPAQUE";if("BLEND"===u?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,"MASK"===u&&(a.alphaTest=void 0!==s.alphaCutoff?s.alphaCutoff:.5)),void 0!==s.normalTexture&&t!==r.V9B&&(c.push(n.assignTexture(a,"normalMap",s.normalTexture)),a.normalScale=new r.I9Y(1,1),void 0!==s.normalTexture.scale)){let e=s.normalTexture.scale;a.normalScale.set(e,e)}if(void 0!==s.occlusionTexture&&t!==r.V9B&&(c.push(n.assignTexture(a,"aoMap",s.occlusionTexture)),void 0!==s.occlusionTexture.strength&&(a.aoMapIntensity=s.occlusionTexture.strength)),void 0!==s.emissiveFactor&&t!==r.V9B){let e=s.emissiveFactor;a.emissive=new r.Q1f().setRGB(e[0],e[1],e[2],r.Zr2)}return void 0!==s.emissiveTexture&&t!==r.V9B&&c.push(n.assignTexture(a,"emissiveMap",s.emissiveTexture,r.er$)),Promise.all(c).then(function(){let r=new t(a);return s.name&&(r.name=s.name),ed(r,s),n.associations.set(r,{materials:e}),s.extensions&&ep(o,r,s),r})}createUniqueName(e){let t=r.Nwf.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){let t=this,n=this.extensions,i=this.primitiveCache,o=[];for(let s=0,a=e.length;s<a;s++){let a=e[s],l=function(e){let t,n=e.extensions&&e.extensions[I.KHR_DRACO_MESH_COMPRESSION];if(t=n?"draco:"+n.bufferView+":"+n.indices+":"+ev(n.attributes):e.indices+":"+ev(e.attributes)+":"+e.mode,void 0!==e.targets)for(let n=0,r=e.targets.length;n<r;n++)t+=":"+ev(e.targets[n]);return t}(a),c=i[l];if(c)o.push(c.promise);else{let e;e=a.extensions&&a.extensions[I.KHR_DRACO_MESH_COMPRESSION]?function(e){return n[I.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then(function(n){return eg(n,e,t)})}(a):eg(new r.LoY,a,t),i[l]={primitive:a,promise:e},o.push(e)}}return Promise.all(o)}loadMesh(e){let t=this,n=this.json,i=this.extensions,o=n.meshes[e],s=o.primitives,a=[];for(let e=0,t=s.length;e<t;e++){var l;let t=void 0===s[e].material?(void 0===(l=this.cache).DefaultMaterial&&(l.DefaultMaterial=new r._4j({color:0xffffff,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:r.hB5})),l.DefaultMaterial):this.getDependency("material",s[e].material);a.push(t)}return a.push(t.loadGeometries(s)),Promise.all(a).then(function(n){let a=n.slice(0,n.length-1),l=n[n.length-1],c=[];for(let n=0,u=l.length;n<u;n++){let u,h=l[n],f=s[n],p=a[n];if(f.mode===eo.TRIANGLES||f.mode===eo.TRIANGLE_STRIP||f.mode===eo.TRIANGLE_FAN||void 0===f.mode)!0===(u=!0===o.isSkinnedMesh?new r.I46(h,p):new r.eaF(h,p)).isSkinnedMesh&&u.normalizeSkinWeights(),f.mode===eo.TRIANGLE_STRIP?u.geometry=A(u.geometry,r.O49):f.mode===eo.TRIANGLE_FAN&&(u.geometry=A(u.geometry,r.rYR));else if(f.mode===eo.LINES)u=new r.DXC(h,p);else if(f.mode===eo.LINE_STRIP)u=new r.N1A(h,p);else if(f.mode===eo.LINE_LOOP)u=new r.FCc(h,p);else if(f.mode===eo.POINTS)u=new r.ONl(h,p);else throw Error("THREE.GLTFLoader: Primitive mode unsupported: "+f.mode);Object.keys(u.geometry.morphAttributes).length>0&&function(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let n=0,r=t.weights.length;n<r;n++)e.morphTargetInfluences[n]=t.weights[n];if(t.extras&&Array.isArray(t.extras.targetNames)){let n=t.extras.targetNames;if(e.morphTargetInfluences.length===n.length){e.morphTargetDictionary={};for(let t=0,r=n.length;t<r;t++)e.morphTargetDictionary[n[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}(u,o),u.name=t.createUniqueName(o.name||"mesh_"+e),ed(u,o),f.extensions&&ep(i,u,f),t.assignFinalMaterial(u),c.push(u)}for(let n=0,r=c.length;n<r;n++)t.associations.set(c[n],{meshes:e,primitives:n});if(1===c.length)return o.extensions&&ep(i,c[0],o),c[0];let u=new r.YJl;o.extensions&&ep(i,u,o),t.associations.set(u,{meshes:e});for(let e=0,t=c.length;e<t;e++)u.add(c[e]);return u})}loadCamera(e){let t,n=this.json.cameras[e],i=n[n.type];return i?("perspective"===n.type?t=new r.ubm(r.cj9.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):"orthographic"===n.type&&(t=new r.qUd(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),n.name&&(t.name=this.createUniqueName(n.name)),ed(t,n),Promise.resolve(t)):void console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){let t=this.json.skins[e],n=[];for(let e=0,r=t.joints.length;e<r;e++)n.push(this._loadNodeShallow(t.joints[e]));return void 0!==t.inverseBindMatrices?n.push(this.getDependency("accessor",t.inverseBindMatrices)):n.push(null),Promise.all(n).then(function(e){let n=e.pop(),i=[],o=[];for(let s=0,a=e.length;s<a;s++){let a=e[s];if(a){i.push(a);let e=new r.kn4;null!==n&&e.fromArray(n.array,16*s),o.push(e)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[s])}return new r.EAD(i,o)})}loadAnimation(e){let t=this.json,n=this,i=t.animations[e],o=i.name?i.name:"animation_"+e,s=[],a=[],l=[],c=[],u=[];for(let e=0,t=i.channels.length;e<t;e++){let t=i.channels[e],n=i.samplers[t.sampler],r=t.target,o=r.node,h=void 0!==i.parameters?i.parameters[n.input]:n.input,f=void 0!==i.parameters?i.parameters[n.output]:n.output;void 0!==r.node&&(s.push(this.getDependency("node",o)),a.push(this.getDependency("accessor",h)),l.push(this.getDependency("accessor",f)),c.push(n),u.push(r))}return Promise.all([Promise.all(s),Promise.all(a),Promise.all(l),Promise.all(c),Promise.all(u)]).then(function(e){let t=e[0],s=e[1],a=e[2],l=e[3],c=e[4],u=[];for(let e=0,r=t.length;e<r;e++){let r=t[e],i=s[e],o=a[e],h=l[e],f=c[e];if(void 0===r)continue;r.updateMatrix&&r.updateMatrix();let p=n._createAnimationTracks(r,i,o,h,f);if(p)for(let e=0;e<p.length;e++)u.push(p[e])}let h=new r.tz3(o,void 0,u);return ed(h,i),h})}createNodeMesh(e){let t=this.json,n=this,r=t.nodes[e];return void 0===r.mesh?null:n.getDependency("mesh",r.mesh).then(function(e){let t=n._getNodeRef(n.meshCache,r.mesh,e);return void 0!==r.weights&&t.traverse(function(e){if(e.isMesh)for(let t=0,n=r.weights.length;t<n;t++)e.morphTargetInfluences[t]=r.weights[t]}),t})}loadNode(e){let t=this.json.nodes[e],n=this._loadNodeShallow(e),r=[],i=t.children||[];for(let e=0,t=i.length;e<t;e++)r.push(this.getDependency("node",i[e]));let o=void 0===t.skin?Promise.resolve(null):this.getDependency("skin",t.skin);return Promise.all([n,Promise.all(r),o]).then(function(e){let t=e[0],n=e[1],r=e[2];null!==r&&t.traverse(function(e){e.isSkinnedMesh&&e.bind(r,em)});for(let e=0,r=n.length;e<r;e++)t.add(n[e]);return t})}_loadNodeShallow(e){let t=this.json,n=this.extensions,i=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];let o=t.nodes[e],s=o.name?i.createUniqueName(o.name):"",a=[],l=i._invokeOne(function(t){return t.createNodeMesh&&t.createNodeMesh(e)});return l&&a.push(l),void 0!==o.camera&&a.push(i.getDependency("camera",o.camera).then(function(e){return i._getNodeRef(i.cameraCache,o.camera,e)})),i._invokeAll(function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)}).forEach(function(e){a.push(e)}),this.nodeCache[e]=Promise.all(a).then(function(t){let a;if((a=!0===o.isBone?new r.$Kf:t.length>1?new r.YJl:1===t.length?t[0]:new r.B69)!==t[0])for(let e=0,n=t.length;e<n;e++)a.add(t[e]);if(o.name&&(a.userData.name=o.name,a.name=s),ed(a,o),o.extensions&&ep(n,a,o),void 0!==o.matrix){let e=new r.kn4;e.fromArray(o.matrix),a.applyMatrix4(e)}else void 0!==o.translation&&a.position.fromArray(o.translation),void 0!==o.rotation&&a.quaternion.fromArray(o.rotation),void 0!==o.scale&&a.scale.fromArray(o.scale);if(i.associations.has(a)){if(void 0!==o.mesh&&i.meshCache.refs[o.mesh]>1){let e=i.associations.get(a);i.associations.set(a,{...e})}}else i.associations.set(a,{});return i.associations.get(a).nodes=e,a}),this.nodeCache[e]}loadScene(e){let t=this.extensions,n=this.json.scenes[e],i=this,o=new r.YJl;n.name&&(o.name=i.createUniqueName(n.name)),ed(o,n),n.extensions&&ep(t,o,n);let s=n.nodes||[],a=[];for(let e=0,t=s.length;e<t;e++)a.push(i.getDependency("node",s[e]));return Promise.all(a).then(function(e){for(let t=0,n=e.length;t<n;t++)o.add(e[t]);return i.associations=(e=>{let t=new Map;for(let[e,n]of i.associations)(e instanceof r.imn||e instanceof r.gPd)&&t.set(e,n);return e.traverse(e=>{let n=i.associations.get(e);null!=n&&t.set(e,n)}),t})(o),o})}_createAnimationTracks(e,t,n,i,o){let s,a=[],l=e.name?e.name:e.uuid,c=[];switch(eh[o.path]===eh.weights?e.traverse(function(e){e.morphTargetInfluences&&c.push(e.name?e.name:e.uuid)}):c.push(l),eh[o.path]){case eh.weights:s=r.Hit;break;case eh.rotation:s=r.MBL;break;case eh.translation:case eh.scale:s=r.RiT;break;default:s=1===n.itemSize?r.Hit:r.RiT}let u=void 0!==i.interpolation?ef[i.interpolation]:r.PJ3,h=this._getArrayFromAccessor(n);for(let e=0,n=c.length;e<n;e++){let n=new s(c[e]+"."+eh[o.path],t.array,h,u);"CUBICSPLINE"===i.interpolation&&this._createCubicSplineTrackInterpolant(n),a.push(n)}return a}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){let e=ey(t.constructor),n=new Float32Array(t.length);for(let r=0,i=t.length;r<i;r++)n[r]=t[r]*e;t=n}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof r.MBL?ei:en)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function eg(e,t,n){let i=t.attributes,o=[];for(let t in i){let r=eu[t]||t.toLowerCase();r in e.attributes||o.push(function(t,r){return n.getDependency("accessor",t).then(function(t){e.setAttribute(r,t)})}(i[t],r))}if(void 0!==t.indices&&!e.index){let r=n.getDependency("accessor",t.indices).then(function(t){e.setIndex(t)});o.push(r)}return r.ppV.workingColorSpace!==r.Zr2&&"COLOR_0"in i&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${r.ppV.workingColorSpace}" not supported.`),ed(e,t),!function(e,t,n){let i=t.attributes,o=new r.NRn;if(void 0===i.POSITION)return;{let e=n.json.accessors[i.POSITION],t=e.min,s=e.max;if(void 0===t||void 0===s)return console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(o.set(new r.Pq0(t[0],t[1],t[2]),new r.Pq0(s[0],s[1],s[2])),e.normalized){let t=ey(es[e.componentType]);o.min.multiplyScalar(t),o.max.multiplyScalar(t)}}let s=t.targets;if(void 0!==s){let e=new r.Pq0,t=new r.Pq0;for(let r=0,i=s.length;r<i;r++){let i=s[r];if(void 0!==i.POSITION){let r=n.json.accessors[i.POSITION],o=r.min,s=r.max;if(void 0!==o&&void 0!==s){if(t.setX(Math.max(Math.abs(o[0]),Math.abs(s[0]))),t.setY(Math.max(Math.abs(o[1]),Math.abs(s[1]))),t.setZ(Math.max(Math.abs(o[2]),Math.abs(s[2]))),r.normalized){let e=ey(es[r.componentType]);t.multiplyScalar(e)}e.max(t)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}o.expandByVector(e)}e.boundingBox=o;let a=new r.iyt;o.getCenter(a.center),a.radius=o.min.distanceTo(o.max)/2,e.boundingSphere=a}(e,t,n),Promise.all(o).then(function(){return void 0!==t.targets?function(e,t,n){let r=!1,i=!1,o=!1;for(let e=0,n=t.length;e<n;e++){let n=t[e];if(void 0!==n.POSITION&&(r=!0),void 0!==n.NORMAL&&(i=!0),void 0!==n.COLOR_0&&(o=!0),r&&i&&o)break}if(!r&&!i&&!o)return Promise.resolve(e);let s=[],a=[],l=[];for(let c=0,u=t.length;c<u;c++){let u=t[c];if(r){let t=void 0!==u.POSITION?n.getDependency("accessor",u.POSITION):e.attributes.position;s.push(t)}if(i){let t=void 0!==u.NORMAL?n.getDependency("accessor",u.NORMAL):e.attributes.normal;a.push(t)}if(o){let t=void 0!==u.COLOR_0?n.getDependency("accessor",u.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(s),Promise.all(a),Promise.all(l)]).then(function(t){let n=t[0],s=t[1],a=t[2];return r&&(e.morphAttributes.position=n),i&&(e.morphAttributes.normal=s),o&&(e.morphAttributes.color=a),e.morphTargetsRelative=!0,e})}(e,t.targets,n):e})}var ew=n("./src/model/physics/constants.ts"),ek=console.error;function ex(e){new o().parse(e,function(e){var t,n,r;console.log(e),t=e,n="scene.gltf",(r=document.createElement("a")).setAttribute("href","data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(t))),r.setAttribute("download",n),document.body.appendChild(r),r.click(),r.remove()},ek)}function eT(e,t){new M().load(e,function(n){n.scene.scale.set(ew.R/.5,ew.R/.5,ew.R/.5),n.scene.matrixAutoUpdate=!1,n.scene.updateMatrix(),n.scene.updateMatrixWorld(),n.scene.name=e,t(n)},function(t){return console.log(e+" "+t.loaded+" bytes loaded")},ek)}},"./src/utils/rack.ts"(e,t,n){n.d(t,{m:()=>h});var r=n("./src/model/ball.ts"),i=n("./src/utils/snookerconfig.ts"),o=n("./src/view/tablegeometry.ts"),s=n("./src/view/pocketgeometry.ts"),a=n("./node_modules/three/build/three.core.js"),l=n("./src/utils/utils.ts"),c=n("./src/model/physics/constants.ts");function u(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var h=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"jitter",value:function(e){return(0,l.ld)(e.clone().add(new a.Pq0(t.noise*(Math.random()-.5),t.noise*(Math.random()-.5),0)))}},{key:"cueBall",value:function(e,n){return new r.c(t.jitter(e),0xfaebd7,n)}},{key:"swapBallPositions",value:function(e,t){var n=e.pos.clone();e.pos.copy(t.pos),t.pos.copy(n)}},{key:"diamond",value:function(){var e=new a.Pq0(o.P.tableX/2,0,0),n=[],i=function(e,n,i){return new r.c(t.jitter(e),n,i)};return n.push(t.cueBall(t.spot)),n.push(i(e,t.BALL_COLORS[1],1)),e.add(t.diagonal),n.push(i(e,t.BALL_COLORS[2],2)),e.sub(t.across),n.push(i(e,t.BALL_COLORS[3],3)),e.add(t.diagonal),n.push(i(e,t.BALL_COLORS[4],4)),e.sub(t.across),n.push(i(e,t.BALL_COLORS[5],5)),e.addScaledVector(t.across,2),n.push(i(e,t.BALL_COLORS[6],6)),e.add(t.diagonal).sub(t.across),n.push(i(e,t.BALL_COLORS[7],7)),e.sub(t.across),n.push(i(e,t.BALL_COLORS[8],8)),e.add(t.diagonal),n.push(i(e,t.BALL_COLORS[9],9)),t.swapBallPositions(n[4],n[9]),n}},{key:"triangle",value:function(){var e=t.trianglePositions(),n=[];return n.push(t.cueBall(t.spot)),e.forEach(function(e,i){var o=i+1;n.push(new r.c(t.jitter(e),t.BALL_COLORS[o],o))}),t.swapBallPositions(n[4],n[9]),n}},{key:"trianglePositions",value:function(){var e=[],t=new a.Pq0(o.P.X/2,0,0);return e.push((0,l.t6)(t)),t.add(this.diagonal),e.push((0,l.t6)(t)),t.sub(this.across),e.push((0,l.t6)(t)),t.add(this.diagonal),e.push((0,l.t6)(t)),t.sub(this.across),e.push((0,l.t6)(t)),t.addScaledVector(this.across,2),e.push((0,l.t6)(t)),t.add(this.diagonal),e.push((0,l.t6)(t)),t.sub(this.across),e.push((0,l.t6)(t)),t.sub(this.across),e.push((0,l.t6)(t)),t.sub(this.across),e.push((0,l.t6)(t)),t.add(this.diagonal).sub(this.across),e.push((0,l.t6)(t)),t.add(this.across),e.push((0,l.t6)(t)),t.add(this.across),e.push((0,l.t6)(t)),t.add(this.across),e.push((0,l.t6)(t)),t.add(this.across),e.push((0,l.t6)(t)),e}},{key:"rerack",value:function(e,n){var i=t.trianglePositions(),o=i.shift();n.balls.filter(function(e){return e!==n.cueball}).filter(function(t){return t!==e}).forEach(function(e){e.pos.copy(t.jitter(i.shift())),e.state=r.U.Stationary}),n.overlapsAny(e.pos,e)&&e.pos.copy(o),n.overlapsAny(n.cueball.pos)&&n.cueball.pos.copy(t.spot)}},{key:"three",value:function(){var e=[],n=o.P.X/2,i=o.P.Y/4;return e.push(t.cueBall(t.jitter(new a.Pq0(-n,-i,0)))),e.push(new r.c(t.jitter(new a.Pq0(-n,0,0)),0xe0de36)),e.push(new r.c(t.jitter(new a.Pq0(n,0,0)),0xff0000)),e}},{key:"snooker",value:function(){var e=[],n=o.P.Y/4;e.push(t.cueBall(t.jitter(new a.Pq0(t.baulk,-(.5*n),0))));var l=t.snookerColourPositions();e.push(new r.c(t.jitter(l[0]),0xeede36)),e.push(new r.c(t.jitter(l[1]),824932)),e.push(new r.c(t.jitter(l[2]),0xbd723a)),e.push(new r.c(t.jitter(l[3]),558062)),e.push(new r.c(t.jitter(l[4]),0xffaacc)),e.push(new r.c(t.jitter(l[5]),65793));var u=Math.min(i.U.reds,15),h=t.trianglePositions().slice(0,15),f=s.f.pockets.pocketS.pocket.pos;return h.forEach(function(n,i){var o=new r.c(t.jitter(n.add(t.down)),0xee0000);i>=u&&(o.pos.copy(f),o.pos.setZ(-8.5*c.R),o.state=r.U.InPocket),e.push(o)}),e}},{key:"snookerColourPositions",value:function(){var e=o.P.X/2,n=o.P.X-2*o.P.X/11,r=[];return r.push(new a.Pq0(t.baulk,-t.sixth,0)),r.push(new a.Pq0(t.baulk,t.sixth,0)),r.push(new a.Pq0(t.baulk,0,0)),r.push(new a.Pq0(0,0,0)),r.push(new a.Pq0(e,0,0)),r.push(new a.Pq0(n,0,0)),r}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();u(h,"noise",.0233*c.R),u(h,"gap",2*c.R+2*h.noise),u(h,"up",new a.Pq0(0,0,-1)),u(h,"spot",new a.Pq0(-o.P.X/2,0,0)),u(h,"across",new a.Pq0(0,h.gap,0)),u(h,"down",new a.Pq0(h.gap,0,0)),u(h,"diagonal",h.across.clone().applyAxisAngle(h.up,Math.PI/3)),u(h,"BALL_COLORS",["#FFFFFF","#ffd900","#0000FF","#FF0000","#800080","#ff3300","#008000","#600000","#000000","#FFFF00","#0000FF","#FF0000","#800080","#FF8000","#008000","#600000"]),u(h,"sixth",2*o.P.Y/6),u(h,"baulk",-1.5*o.P.X*2/5)},"./src/utils/replay-encoder.ts"(e,t,n){n.d(t,{k:()=>i});var r=n("./node_modules/jsoncrush/JSONCrush.js"),i=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"fullyEncodeURI",value:function(e){return encodeURIComponent(e).replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/!/g,"%21").replace(/\*/g,"%2A")}},{key:"crush",value:function(e){return r.A.crush(e)}},{key:"createState",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5?arguments[5]:void 0,s={init:e,shots:t,start:n,now:Date.now(),score:r,wholeGame:i,v:1};return o&&(s.players=o),s}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/utils/respot.ts"(e,t,n){n.d(t,{k:()=>l});var r=n("./src/model/ball.ts"),i=n("./src/view/tablegeometry.ts"),o=n("./src/model/physics/constants.ts"),s=n("./src/utils/rack.ts"),a=n("./node_modules/three/build/three.core.js"),l=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"nineBall",value:function(e){var n=e.balls.find(function(e){return 9===e.id});if(n){var r=new a.Pq0(i.P.tableX/2,0,0);t.respotBehind(r,n,e)}}},{key:"respot",value:function(e,n){var i=s.m.snookerColourPositions();return i.push(i[e.id-1]),i.reverse(),i.some(function(t){return!n.overlapsAny(t,e)&&(e.pos.copy(t),e.state=r.U.Stationary,!0)})||t.respotBehind(i[0],e,n),e}},{key:"respotBehind",value:function(e,t,n){for(var s=e.clone();s.x<i.P.tableX&&n.overlapsAny(s,t);)s.x+=o.R/8;for(;s.x>-i.P.tableX&&n.overlapsAny(s,t);)s.x-=o.R/8;t.pos.copy(s),t.state=r.U.Stationary}},{key:"closest",value:function(e,t){var n=t.filter(function(e){return e.onTable()}).filter(function(t){return t!==e});if(0!==n.length){var r=function(t){return e.pos.distanceTo(t.pos)};return n.reduce(function(e,t){return r(e)<r(t)?e:t},n[0])}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/utils/snookerconfig.ts"(e,t,n){n.d(t,{U:()=>r});var r={reds:15}},"./src/utils/threecushionconfig.ts"(e,t,n){n.d(t,{Y:()=>r});var r={raceTo:7}},"./src/utils/utils.ts"(e,t,n){n.d(t,{Dz:()=>v,F8:()=>w,FP:()=>b,KM:()=>u,RZ:()=>x,gn:()=>k,hs:()=>a,ld:()=>m,n7:()=>g,oN:()=>T,rq:()=>d,t6:()=>l,up:()=>s,v_:()=>o,xb:()=>f});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/events/eventtype.ts"),o=new r.Pq0(0,0,0),s=new r.Pq0(0,0,1);function a(e){return!e.entries.some(function(e){return e.event.type===i.B.AIM})}function l(e){return new r.Pq0(e.x,e.y,e.z)}var c=new r.Pq0;function u(e){return c.copy(s).cross(e)}var h=new r.Pq0;function f(e){return h.copy(e).normalize()}var p=new r.Pq0;function d(e,t){return 0>=p.copy(e).add(t).dot(e)}function v(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new r.Pq0;return t.set(1,0,0).applyAxisAngle(s,e)}function y(e){return Math.sign(e)*Math.floor((Math.abs(e)+Number.EPSILON)*1e4)/1e4}function m(e){return e.x=y(e.x),e.y=y(e.y),e.z=y(e.z),e}function b(e,t){return Math.fround(Math.atan2(e,t))}function g(e,t){return Math.fround(Math.pow(e,t))}function w(e){return Math.fround(Math.sin(e))}function k(e){return Math.fround(Math.cos(e))}function x(e){return Math.fround(Math.sqrt(e))}function T(e){return Math.fround(Math.exp(e))}},"./src/view/assets.ts"(e,t,n){n.d(t,{s:()=>y});var r=n("./src/controller/rules/rulefactory.ts"),i=n("./src/utils/gltf.ts"),o=n("./node_modules/three/build/three.core.js");function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");s(this,"listener",void 0),s(this,"audioLoader",void 0),s(this,"ballcollision",void 0),s(this,"cue",void 0),s(this,"cushion",void 0),s(this,"pot",void 0),s(this,"success",void 0),s(this,"lastOutcomeTime",0),s(this,"loadAssets",void 0),this.loadAssets=e,e&&(this.listener=new o.Pf$,this.audioLoader=new o.Am1,this.ballcollision=new o.fP5(this.listener),this.load("sounds/ballcollision.ogg",this.ballcollision),this.cue=new o.fP5(this.listener),this.load("sounds/cue.ogg",this.cue),this.cushion=new o.fP5(this.listener),this.load("sounds/cushion.ogg",this.cushion),this.pot=new o.fP5(this.listener),this.load("sounds/pot.ogg",this.pot),this.success=new o.fP5(this.listener),this.load("sounds/success.ogg",this.success))}return e=[{key:"addCameraToListener",value:function(e){e.add(this.listener)}},{key:"load",value:function(e,t){this.audioLoader.load(e,function(e){t.setBuffer(e),t.setLoop(!1)},function(e){},function(e){})}},{key:"play",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(this.loadAssets){var r,i,s=o.UtX.getContext();if((null==s?void 0:s.state)==="suspended"){(null==(i=navigator)||null==(r=i.userActivation)?void 0:r.hasBeenActive)&&s.resume();return}e.setVolume(t),e.isPlaying&&e.stop(),e.play(o.cj9.randFloat(0,.01)),e.setDetune(n)}}},{key:"outcomeToSound",value:function(e){"Collision"===e.type&&this.play(this.ballcollision,e.incidentSpeed/80,5*e.incidentSpeed),"Pot"===e.type&&this.play(this.pot,e.incidentSpeed/10,-1e3+10*e.incidentSpeed),"Cushion"===e.type&&this.play(this.cushion,e.incidentSpeed/70),"Hit"===e.type&&this.play(this.cue,e.incidentSpeed/30)}},{key:"processOutcomes",value:function(e){var t=this;e.every(function(e){return!(e.timestamp>t.lastOutcomeTime)||(t.lastOutcomeTime=e.timestamp,t.outcomeToSound(e),!1)})}},{key:"playNotify",value:function(){this.play(this.pot,1)}},{key:"playSuccess",value:function(e){this.play(this.success,.1,100*e-2200)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),l=n("./src/view/tablegeometry.ts"),c=n("./src/view/pocketgeometry.ts"),u=n("./src/model/physics/constants.ts");function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var f=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");h(this,"logger",function(e){}),h(this,"cloth",new o.tXL({color:4478393,wireframe:!1,flatShading:!0,transparent:!1})),h(this,"cushion",new o.tXL({color:5531065,wireframe:!1,flatShading:!0,transparent:!1})),h(this,"pocket",new o.tXL({color:4478361,wireframe:!1,flatShading:!0,transparent:!0,opacity:.3}))}return e=[{key:"generateTable",value:function(e){var t=this,n=new o.YJl,r=new o.HiM(0xf0f0e8,22);if(r.position.set(0,0,50*u.R),n.add(r),this.addCushions(n,e),e){c.f.knuckles.forEach(function(e){return t.knuckleCylinder(e,n)}),c.f.pocketCenters.forEach(function(e){return t.knuckleCylinder(e,n,t.pocket)});var i=c.f.pockets.pocketNW.pocket,s=c.f.pockets.pocketNW.knuckleNE;this.logger("knuckle-pocket gap = "+(i.pos.distanceTo(s.pos)-i.radius-s.radius))}return n}},{key:"knuckleCylinder",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.cloth;this.cylinder(e.pos,e.radius,.75*u.R/.5,t,n).position.setZ(-(.25*u.R)/.5/2)}},{key:"cylinder",value:function(e,n,r,i,s){var a="".concat(n,"_").concat(r),l=t.cylinderCache.get(a);l||(l=new o.Ho_(n,n,r,16),t.cylinderCache.set(a,l));var c=new o.eaF(l,s);return c.position.copy(e),c.rotation.x=Math.PI/2,i.add(c),c}},{key:"addCushions",value:function(e,t){var n=10*u.R/.5;this.plane(new o.Pq0(0,0,-u.R-n/2),2*l.P.X,2*l.P.Y,n,e,this.cloth);var r=u.R/.5,i=.75*u.R/.5,s=-(.25*u.R)/.5/2,a=l.P.X,h=l.P.Y,f=Math.abs(c.f.pockets.pocketNW.knuckleNE.pos.x-c.f.pockets.pocketN.knuckleNW.pos.x),p=Math.abs(c.f.pockets.pocketNW.knuckleSW.pos.y-c.f.pockets.pocketSW.knuckleNW.pos.y);t||(f=2*l.P.Y,p=2*l.P.Y+4*u.R),this.plane(new o.Pq0(a+r/2,0,s),r,p,i,e),this.plane(new o.Pq0(-a-r/2,0,s),r,p,i,e),this.plane(new o.Pq0(-a/2,h+r/2,s),f,r,i,e),this.plane(new o.Pq0(-a/2,-h-r/2,s),f,r,i,e),this.plane(new o.Pq0(a/2,h+r/2,s),f,r,i,e),this.plane(new o.Pq0(a/2,-h-r/2,s),f,r,i,e)}},{key:"plane",value:function(e,n,r,i,s){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:this.cushion,l="".concat(n,"_").concat(r,"_").concat(i),c=t.boxCache.get(l);c||(c=new o.iNn(n,r,i),t.boxCache.set(l,c));var u=new o.eaF(c,a);u.receiveShadow=!0,u.position.copy(e),s.add(u)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();h(f,"mesh",void 0),h(f,"cylinderCache",new Map),h(f,"boxCache",new Map);var p=n("./src/view/cuemesh.ts");function d(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function v(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var y=function(){var e,t;function n(e){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");v(this,"ready",void 0),v(this,"rules",void 0),v(this,"background",void 0),v(this,"table",void 0),v(this,"cue",void 0),v(this,"sound",void 0),this.rules=r.V.create(e,null),this.rules.tableGeometry()}return e=[{key:"loadFromWeb",value:function(e){var t=this;this.ready=e,this.sound=new a(!0),(0,i.Ro)("models/background.gltf",function(e){t.background=e.scene,t.done()}),(0,i.Ro)(this.rules.asset(),function(e){t.table=e.scene,f.mesh=e.scene.children[0],t.done()}),(0,i.Ro)("models/cue.gltf",function(e){t.cue=e,p.l.mesh=e.scene.children[0],t.done()})}},{key:"createLocal",value:function(){this.sound=new a(!1),f.mesh=new f().generateTable(l.P.hasPockets),this.table=f.mesh}},{key:"done",value:function(){this.background&&this.table&&this.cue&&this.ready()}}],t=[{key:"localAssets",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=new n(e);return t.createLocal(),t}}],e&&d(n.prototype,e),t&&d(n,t),n}()},"./src/view/cameratop.ts"(e,t,n){n.d(t,{v:()=>a});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/view/tablegeometry.ts"),o=n("./src/model/physics/constants.ts");function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"viewPoint",value:function(e,n){var s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new r.Pq0;(n!==t.lastFov||t.zoomFactor!==t.lastZoom)&&(t.cachedDist=t.zoomFactor/(2*Math.tan(n*Math.PI/360)),t.lastFov=n,t.lastZoom=t.zoomFactor);var a=t.cachedDist;if(e>this.portrait){var l=e>t.aspectLimit?2.75*i.P.tableY:2.4*i.P.tableX/e;return s.set(0,-.01*o.R,a*l)}var c=e>1/t.aspectLimit?4.9*i.P.tableY:1.35*i.P.tableX/e;return s.set(-.01*o.R,0,a*c)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();s(a,"aspectLimit",1.78),s(a,"portrait",.95),s(a,"fov",20),s(a,"zoomFactor",1),s(a,"lastFov",void 0),s(a,"lastZoom",void 0),s(a,"cachedDist",void 0)},"./src/view/cue.ts"(e,t,n){n.d(t,{s:()=>f});var r=n("./src/view/tablegeometry.ts"),i=n("./src/utils/utils.ts"),o=n("./src/events/aimevent.ts"),s=n("./src/model/ball.ts"),a=n("./src/model/physics/physics.ts"),l=n("./src/view/cuemesh.ts"),c=n("./node_modules/three/build/three.core.js"),u=n("./src/model/physics/constants.ts");function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var f=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");h(this,"mesh",void 0),h(this,"helperMesh",void 0),h(this,"placerMesh",void 0),h(this,"offCenterLimit",.3),h(this,"maxPower",160*u.R),h(this,"t",0),h(this,"aimInputs",void 0),h(this,"aim",new o.w),h(this,"length",+r.P.tableX),h(this,"tempVec",new c.Pq0),h(this,"tempVec2",new c.Pq0),h(this,"tempVec3",new c.Pq0),h(this,"raycaster",new c.tBo),this.mesh=l.l.createCue(.05*u.R/.5,.15*u.R/.5,this.length),this.helperMesh=l.l.createHelper(),this.placerMesh=l.l.createPlacer()}return e=[{key:"rotateAim",value:function(e,t){this.aim.angle=this.aim.angle+e,this.mesh.rotation.z=this.aim.angle,this.helperMesh.rotation.z=this.aim.angle,this.aimInputs.showOverlap(),this.avoidCueTouchingOtherBall(t)}},{key:"adjustPower",value:function(e){this.aim.power=Math.min(this.maxPower,this.aim.power+e),this.updateAimInput()}},{key:"setPower",value:function(e){this.aim.power=e*this.maxPower}},{key:"hit",value:function(e){var t=this.aim;this.t=0,e.state=s.U.Sliding,e.vel.copy((0,i.Dz)(t.angle,this.tempVec).multiplyScalar(t.power)),e.rvel.copy((0,a.t6)(t.offset,e.vel))}},{key:"aimAtNext",value:function(e,t){if(t){var n=(0,i.xb)(this.tempVec.copy(t.pos).sub(e.pos));this.aim.angle=(0,i.FP)(n.y,n.x)}}},{key:"adjustSpin",value:function(e,t){var n=this.tempVec3.copy(this.aim.offset).add(e);this.setSpin(n,t)}},{key:"setSpin",value:function(e,t){e.length()>this.offCenterLimit&&e.normalize().multiplyScalar(this.offCenterLimit),this.aim.offset.copy(e),this.avoidCueTouchingOtherBall(t),this.updateAimInput()}},{key:"avoidCueTouchingOtherBall",value:function(e){for(var t=0;t++<20&&this.intersectsAnything(e);)this.aim.offset.y+=.1,this.aim.offset.length()>this.offCenterLimit&&this.aim.offset.normalize().multiplyScalar(this.offCenterLimit);t>1&&this.updateAimInput()}},{key:"updateAimInput",value:function(){var e,t,n;null==(e=this.aimInputs)||e.updateVisualState(this.aim.offset.x,this.aim.offset.y),null==(t=this.aimInputs)||t.updatePowerSlider(this.aim.power/this.maxPower),null==(n=this.aimInputs)||n.showOverlap()}},{key:"moveTo",value:function(e){this.aim.pos.copy(e),this.mesh.rotation.z=this.aim.angle,this.helperMesh.rotation.z=this.aim.angle;var t=this.spinOffset(),n=((0,i.F8)(this.t+Math.PI/2)-1)*2*u.R*(this.aim.power/this.maxPower),r=(0,i.Dz)(this.aim.angle,this.tempVec).multiplyScalar(n);this.mesh.position.copy(e).add(t).add(r),this.helperMesh.position.copy(e),this.placerMesh.position.copy(e),this.placerMesh.rotation.z=this.t}},{key:"update",value:function(e){this.t+=e,this.moveTo(this.aim.pos)}},{key:"placeBallMode",value:function(){this.mesh.visible=!1,this.placerMesh.visible=!0,this.aim.angle=0}},{key:"aimMode",value:function(){this.mesh.visible=!0,this.placerMesh.visible=!1}},{key:"spinOffset",value:function(){return(0,i.KM)((0,i.Dz)(this.aim.angle,this.tempVec2)).multiplyScalar(2*this.aim.offset.x*u.R).setZ(2*this.aim.offset.y*u.R)}},{key:"intersectsAnything",value:function(e){var t=this.spinOffset(),n=this.tempVec.copy(e.cueball.pos).add(t),r=(0,i.xb)((0,i.Dz)(this.aim.angle+Math.PI,this.tempVec2).setZ(.1));this.raycaster.set(n,r);var o=[],s=!0,a=!1,l=void 0;try{for(var c,u=e.balls[Symbol.iterator]();!(s=(c=u.next()).done);s=!0){var h=c.value;o.push(h.ballmesh.mesh)}}catch(e){a=!0,l=e}finally{try{s||null==u.return||u.return()}finally{if(a)throw l}}return e.mesh&&o.push(e.mesh),this.raycaster.intersectObjects(o,!0).length>0}},{key:"showHelper",value:function(e){this.helperMesh.visible=e}},{key:"toggleHelper",value:function(){this.showHelper(!this.helperMesh.visible)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/view/cuemesh.ts"(e,t,n){n.d(t,{l:()=>a});var r=n("./src/model/physics/constants.ts"),i=n("./src/utils/utils.ts"),o=n("./node_modules/three/build/three.core.js");function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"indicateValid",value:function(e){t.placermaterial.color.setHex(e?0xccffcc:0xff0000)}},{key:"createHelper",value:function(){var e=new o.Ho_(r.R,r.R,30*r.R/.5,12,1,!0),t=new o.eaF(e,this.helpermaterial);return t.geometry.applyMatrix4(new o.kn4().identity().makeRotationAxis(i.up,-Math.PI/2)).applyMatrix4(new o.kn4().identity().makeTranslation(15*r.R/.5,0,-(.01*r.R)/.5)),t.visible=!1,t.renderOrder=-1,t.material.depthTest=!1,t}},{key:"createPlacer",value:function(){var e=new o.Ho_(.01*r.R/.5,r.R,r.R,4),n=new o.eaF(e,t.placermaterial);return n.geometry.applyMatrix4(new o.kn4().identity().makeRotationAxis(new o.Pq0(1,0,0),-Math.PI/2)).applyMatrix4(new o.kn4().identity().makeTranslation(0,0,.7*r.R/.5)),n.visible=!1,n}},{key:"createCue",value:function(e,n,s){var a=new o.Ho_(e,n,s,11),l=new o.eaF(a,t.material);return l.castShadow=!1,l.geometry.applyMatrix4(new o.kn4().identity().makeRotationAxis(new o.Pq0(1,0,0),-.17)).applyMatrix4(new o.kn4().identity().makeRotationAxis(i.up,-Math.PI/2)).applyMatrix4(new o.kn4().identity().makeTranslation(-s/2-r.R,0,s/2*.16918234906699603+.25*r.R)),l}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();s(a,"mesh",void 0),s(a,"material",new o.tXL({color:8934775,wireframe:!1,flatShading:!1})),s(a,"placermaterial",new o.tXL({color:0xccffcc,wireframe:!1,flatShading:!1,transparent:!0,opacity:.5})),s(a,"helpermaterial",new o.BKk({uniforms:{lightDirection:{value:new o.Pq0(0,0,1)}},vertexShader:`
       varying vec2 vUv;
       varying vec3 vNormal;
       void main() {
         vNormal = normal;
         vUv = uv;
diff --git a/dist/diagram.js b/dist/diagram.js
index f78f79a..03471b2 100644
--- a/dist/diagram.js
+++ b/dist/diagram.js
@@ -1,6 +1,6 @@
-"use strict";(self.webpackChunkbilliards=self.webpackChunkbilliards||[]).push([[338],{"./src/container/container.ts"(e,t,n){n.d(t,{m:()=>$});var r=n("./src/network/client/session.ts"),i=n("./src/events/stationaryevent.ts"),o=n("./node_modules/three/build/three.core.js"),s=n("./src/utils/utils.ts"),a=n("./src/view/cameratop.ts"),l=n("./src/model/physics/constants.ts");function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var u=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");c(this,"camera",void 0),c(this,"mode",this.topView),c(this,"mainMode",this.aimView),c(this,"height",8*l.R),c(this,"target",new o.Pq0),c(this,"lookTarget",new o.Pq0),c(this,"tempVec",new o.Pq0),c(this,"elapsed",void 0),this.camera=new o.ubm(45,e,l.R,1e3*l.R)}return e=[{key:"update",value:function(e,t){this.elapsed=e,this.mode(t)}},{key:"topView",value:function(e){this.camera.fov=a.v.fov,this.camera.position.lerp(a.v.viewPoint(this.camera.aspect,this.camera.fov,this.tempVec),.9),this.camera.up=s.up,this.camera.lookAt(s.v_)}},{key:"aimView",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.08,n=this.height,r=this.camera.aspect<.8;if(this.camera.fov=r?60:40,n<10*l.R){var i=100*(10*l.R-n);this.camera.fov-=i*(r?3:1)}this.target.copy(e.pos).addScaledVector((0,s.Dz)(e.angle,this.tempVec),-(18*l.R)),this.camera.position.lerp(this.target,t),this.camera.position.z=n,this.camera.up=s.up,this.lookTarget.copy(e.pos).addScaledVector(s.up,n/2),this.camera.lookAt(this.lookTarget)}},{key:"adjustHeight",value:function(e){e=this.height<10*l.R?e/8:e,this.height=o.cj9.clamp(this.height+e,6*l.R,120*l.R),this.height>110*l.R&&this.suggestMode(this.topView),this.height<105*l.R&&this.suggestMode(this.aimView)}},{key:"suggestMode",value:function(e){this.mainMode===this.aimView&&(this.mode=e)}},{key:"forceMode",value:function(e){this.mode=e,this.mainMode=e}},{key:"forceMove",value:function(e){this.mode===this.aimView&&this.aimView(e,1)}},{key:"toggleMode",value:function(){this.mode===this.topView?this.mode=this.aimView:this.mode=this.topView,this.mainMode=this.mode}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),h=n("./src/view/tablegeometry.ts"),f=function(){var e;function t(){var e,n;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");e="material",n=new o.mrM({color:132,opacity:.15,transparent:!0}),e in this?Object.defineProperty(this,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):this[e]=n}return e=[{key:"generateLineSegments",value:function(){var e=this,t=[this.point(0,-11.13*l.R/.5),this.point(0,11.13*l.R/.5)],n=h.P.X/4,r=h.P.tableY+l.R;[1,2,3,-1,-2,-3].forEach(function(i){t.push(e.point(i*n,-r)),t.push(e.point(i*n,r))});var i=(h.P.Y+l.R)/2,s=h.P.tableX+l.R;[-1,0,1].forEach(function(n){t.push(e.point(-s,n*i)),t.push(e.point(s,n*i))});var a=new o.LoY().setFromPoints(t);return new o.DXC(a,this.material)}},{key:"point",value:function(e,t){var n=-(.485*l.R)/.5;return new o.Pq0(e,t,n)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),p=n("./node_modules/three/build/three.module.js"),d=n("./src/controller/rules/snooker.ts");function v(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var y=function(){var e;function t(e,n,r){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");v(this,"scene",new o.Z58),v(this,"renderer",void 0),v(this,"camera",void 0),v(this,"windowWidth",1),v(this,"windowHeight",1),v(this,"lastFov",0),v(this,"element",void 0),v(this,"table",void 0),v(this,"loadAssets",!0),v(this,"assets",void 0),v(this,"frustum",new o.PPD),v(this,"projScreenMatrix",new o.kn4),v(this,"ballToCheck",0),this.element=e,this.table=n,this.assets=r,this.renderer=function(e){if("u"<typeof process){var t=new p.JeP({antialias:!1});return t.shadowMap.enabled=!1,t.autoClear=!1,t.setSize(e.offsetWidth,e.offsetHeight),t.setPixelRatio(.75*window.devicePixelRatio),e.appendChild(t.domElement),t}}(e),this.camera=new u(e?e.offsetWidth/e.offsetHeight:1),this.initialiseScene()}return e=[{key:"update",value:function(e,t){this.camera.update(e,t)}},{key:"sizeChanged",value:function(){var e,t;return this.windowWidth!=(null==(e=this.element)?void 0:e.offsetWidth)||this.windowHeight!=(null==(t=this.element)?void 0:t.offsetHeight)}},{key:"updateSize",value:function(){var e,t,n=this.sizeChanged();return n&&(this.windowWidth=null==(e=this.element)?void 0:e.offsetWidth,this.windowHeight=null==(t=this.element)?void 0:t.offsetHeight),n}},{key:"render",value:function(){this.isInMotionNotVisible()&&this.camera.suggestMode(this.camera.topView),this.renderCamera(this.camera)}},{key:"renderCamera",value:function(e){var t=this.updateSize();if(t){var n,r,i,o,s,a=this.windowWidth,l=this.windowHeight;null==(r=this.renderer)||r.setSize(a,l),null==(i=this.renderer)||i.setViewport(0,0,a,l),null==(o=this.renderer)||o.setScissor(0,0,a,l),null==(s=this.renderer)||s.setScissorTest(!0),e.camera.aspect=a/l}(t||e.camera.fov!==this.lastFov)&&(e.camera.updateProjectionMatrix(),this.lastFov=e.camera.fov),null==(n=this.renderer)||n.render(this.scene,e.camera)}},{key:"initialiseScene",value:function(){this.scene.add(new o.$p8(39202,.3)),this.assets.background&&this.scene.add(this.assets.background),this.scene.add(this.assets.table),this.table.mesh=this.assets.table,this.assets.rules.asset()!==d.c.tablemodel&&this.scene.add(new f().generateLineSegments())}},{key:"isInMotionNotVisible",value:function(){var e=this.viewFrustum(),t=this.table.balls[this.ballToCheck++%this.table.balls.length];return t.inMotion()&&!e.intersectsObject(t.ballmesh.mesh)}},{key:"viewFrustum",value:function(){var e=this.camera.camera;return this.frustum.setFromProjectionMatrix(this.projScreenMatrix.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse)),this.frustum}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),m=n("./src/controller/init.ts"),b=n("./src/events/input.ts");function g(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var w=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");g(this,"line",new o.cZY),g(this,"balls",void 0),this.balls=e}return e=[{key:"getFirst",value:function(e,t){var n=this;this.line.set(e.pos,(0,s.xb)(t).multiplyScalar(4*h.P.X).add(e.pos));var r=new o.Pq0,i=this.balls.map(function(t){return n.line.closestPointToPoint(t.pos,!0,r),{ball:t,perpendicular:r.distanceTo(t.pos),distance:r.distanceTo(e.pos)}}).filter(function(e){return e.perpendicular<2*l.R}).filter(function(t){return t.ball!==e});return i.reduce(function(e,t){return e.distance<t.distance?e:t},i[0])}},{key:"getOverlapOffset",value:function(e,t){var n=this.getFirst(e,t);if(n){var r=n.ball.pos.clone().sub(e.pos),i=n.perpendicular*Math.sign(r.cross(t).z)/l.R;return{ball:n.ball,overlap:i}}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),k=n("./src/utils/dom.ts");function x(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var T=function(){var e;function t(e){var n,i=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");x(this,"cueBallElement",void 0),x(this,"cueTipElement",void 0),x(this,"cuePowerElement",void 0),x(this,"cueHitElement",void 0),x(this,"objectBallStyle",void 0),x(this,"container",void 0),x(this,"overlap",void 0),x(this,"ballWidth",void 0),x(this,"ballHeight",void 0),x(this,"tipRadius",void 0),x(this,"mousemove",function(e){1===e.buttons&&i.adjustSpin(e)}),x(this,"powerChanged",function(e){i.container.table.cue.setPower(i.cuePowerElement.value)}),x(this,"hit",function(e){var t;i.container.table.cue.setPower(null==(t=i.cuePowerElement)?void 0:t.value),i.container.inputQueue.push(new b.p(0,"SpaceUp"))}),x(this,"mousewheel",function(e){i.cuePowerElement&&(i.cuePowerElement.value-=Math.sign(e.deltaY)/10,i.container.table.cue.setPower(i.cuePowerElement.value),i.container.lastEventTime=performance.now())}),this.container=e,this.cueBallElement=(0,k.id)("cueBall"),this.cueTipElement=(0,k.id)("cueTip"),this.cuePowerElement=(0,k.id)("cuePower"),this.cueHitElement=(0,k.id)("cueHit"),this.objectBallStyle=null==(n=(0,k.id)("objectBall"))?void 0:n.style,this.overlap=new w(this.container.table.balls),this.addListeners(),r.N.isSpectator()&&this.setDisabled(!0)}return e=[{key:"addListeners",value:function(){var e,t,n,r,i,o=this;null==(e=this.cueBallElement)||e.addEventListener("pointermove",this.mousemove),null==(t=this.cueBallElement)||t.addEventListener("click",function(e){o.adjustSpin(e)}),null==(n=this.cueHitElement)||n.addEventListener("click",this.hit),null==(r=this.cuePowerElement)||r.addEventListener("change",this.powerChanged),"ontouchstart"in globalThis||null==(i=(0,k.id)("viewP1"))||i.addEventListener("dblclick",this.hit),document.addEventListener("wheel",this.mousewheel)}},{key:"setButtonText",value:function(e){this.cueHitElement&&(this.cueHitElement.innerText=e)}},{key:"setDisabled",value:function(e){this.cueHitElement&&(this.cueHitElement.disabled=e||r.N.isSpectator())}},{key:"readDimensions",value:function(){var e,t,n;this.ballWidth=null==(e=this.cueBallElement)?void 0:e.offsetWidth,this.ballHeight=null==(t=this.cueBallElement)?void 0:t.offsetHeight,this.tipRadius=(null==(n=this.cueTipElement)?void 0:n.offsetWidth)/2}},{key:"adjustSpin",value:function(e){this.readDimensions(),this.container.table.cue.setSpin(new o.Pq0(-(e.offsetX-this.ballWidth/2)/this.ballWidth,-(e.offsetY-this.ballHeight/2)/this.ballHeight),this.container.table),this.container.lastEventTime=performance.now()}},{key:"updateVisualState",value:function(e,t){this.readDimensions();var n,r=null==(n=this.cueTipElement)?void 0:n.style;r&&(r.left=(-e+.5)*this.ballWidth-this.tipRadius+"px",r.top=(-t+.5)*this.ballHeight-this.tipRadius+"px"),this.showOverlap()}},{key:"showOverlap",value:function(){if(this.objectBallStyle){var e=this.container.table,t=(0,s.Dz)(e.cue.aim.angle),n=this.overlap.getOverlapOffset(e.cueball,t);n?(this.readDimensions(),this.objectBallStyle.visibility="visible",this.objectBallStyle.left=5+n.overlap*this.ballWidth/2+"px",this.objectBallStyle.backgroundColor=new o.Q1f(0,0,0).lerp(n.ball.ballmesh.color,.5).getStyle()):this.objectBallStyle.visibility="hidden"}}},{key:"updatePowerSlider",value:function(e){var t;e>0&&(null==(t=this.cuePowerElement)?void 0:t.value)&&(this.cuePowerElement.value=e)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function P(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var S=function(){var e;function t(e){var n,r=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");P(this,"chatoutput",void 0),P(this,"chatInput",void 0),P(this,"chatSend",void 0),P(this,"chatInputText",void 0),P(this,"send",void 0),P(this,"sendClicked",function(e){var t,n;r.send(null==(t=r.chatInputText)?void 0:t.value),r.showMessage(null==(n=r.chatInputText)?void 0:n.value)}),this.chatoutput=(0,k.id)("chatoutput"),this.chatInputText=(0,k.V4)("chatinputtext"),this.chatSend=(0,k.id)("chatsend"),null==(n=this.chatSend)||n.addEventListener("click",this.sendClicked),this.send=e}return e=[{key:"showMessage",value:function(e){this.chatoutput&&(this.chatoutput.innerHTML+=e),this.updateScroll()}},{key:"updateScroll",value:function(){this.chatoutput&&(this.chatoutput.scrollTop=this.chatoutput.scrollHeight)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),R=n("./src/events/chatevent.ts"),O=n("./src/events/eventtype.ts");function E(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var A=function(){var e;function t(e,n){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");E(this,"period",void 0),E(this,"pending",null),E(this,"sentTime",0),E(this,"apply",function(e){}),this.period=e,this.apply=n}return e=[{key:"flush",value:function(){this.pending&&(this.apply(this.pending),this.pending=null)}},{key:"send",value:function(e){if(performance.now()>this.sentTime+this.period||e.type!==O.B.AIM){this.flush(),this.apply(e),this.sentTime=performance.now();return}this.pending=e}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),M=n("./src/view/sliders.ts"),_=n("./src/model/outcome.ts"),I=n("./src/utils/replay-encoder.ts");function C(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var j=function(){var e;function t(e,n){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");C(this,"container",void 0),C(this,"linkFormatter",void 0),C(this,"entries",[]),C(this,"start",Date.now()),C(this,"breakStart",void 0),C(this,"breakStartTime",void 0),this.container=e,this.linkFormatter=n}return e=[{key:"shots",get:function(){return this.entries.map(function(e){return e.event})}},{key:"states",get:function(){return this.entries.map(function(e){return e.state})}},{key:"record",value:function(e){var t=e;e.type===O.B.HIT&&(t=e.tablejson.aim),(e.type===O.B.HIT||e.type===O.B.RERACK||e.type===O.B.PLACEBALL||e.type===O.B.SCORE)&&this.entries.push({state:this.container.table.shortSerialise(),event:t,pots:0,isPartOfBreak:!1,time:Date.now()})}},{key:"findLastIndex",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[O.B.RERACK,O.B.SCORE],t=this.entries.length-1;t>=0&&e.includes(this.entries[t].event.type);)t--;return t}},{key:"getPlayerNames",value:function(){if(r.N.hasInstance()){var e=r.N.getInstance(),t=0===e.playerIndex;return{player1:(t?e.playername:e.opponentName)||"Player 1",player2:(t?e.opponentName:e.playername)||"Player 2"}}}},{key:"wholeGame",value:function(){var e;return I.k.createState(null==(e=this.entries[0])?void 0:e.state,this.entries.map(function(e){return e.event}),this.start,this.container.scores[r.N.playerIndex()],!0,this.getPlayerNames())}},{key:"last",value:function(){return this.findLastIndex()}},{key:"lastShot",value:function(){var e=this.last();if(!(e<0)){for(var t=this.entries[e],n=[t.event],r=e+1;r<this.entries.length;r++)this.entries[r].event.type===O.B.SCORE&&n.push(this.entries[r].event);return I.k.createState(t.state,n,0,0,!1,this.getPlayerNames())}}},{key:"currentBreak",value:function(){if(void 0!==this.breakStart){var e=this.entries.slice(this.breakStart);return I.k.createState(this.entries[this.breakStart].state,e.map(function(e){return e.event}),this.breakStartTime,this.container.rules.previousBreak,!1,this.getPlayerNames())}}},{key:"updateBreak",value:function(e,t,n){var r=_.P.potCount(e),i=this.last();if(i>=0&&(this.entries[i].pots=r,this.entries[i].isPartOfBreak=t),t||this.breakLink(n),this.lastShotLink(t||n,r,_.P.pots(e)),n&&this.breakLink(n),!t){this.breakStart=void 0;return}void 0===this.breakStart&&(this.breakStart=i,this.breakStartTime=Date.now())}},{key:"lastShotLink",value:function(e,t,n){var r=this.lastShot();r&&this.linkFormatter.lastShotLink(e,t,n,r)}},{key:"breakLink",value:function(e){var t=this.currentBreak();if(t){var n=0===this.container.rules.currentBreak?this.container.rules.previousBreak:this.container.rules.currentBreak;if(e)return void this.linkFormatter.breakLink(t,n,!0);for(var r=t.shots.slice();r.length>0&&(r[r.length-1].type===O.B.SCORE||r[r.length-1].type===O.B.RERACK);)r.pop();if(0!==r.length){var i,o,s=(i=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(t){C(e,t,n[t])})}return e}({},t),o=o={shots:r},Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(o)):(function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t.push.apply(t,n)}return t})(Object(o)).forEach(function(e){Object.defineProperty(i,e,Object.getOwnPropertyDescriptor(o,e))}),i);this.linkFormatter.breakLink(s,n,!1)}}}},{key:"wholeGameLink",value:function(){this.linkFormatter.wholeGameLink(this.wholeGame())}},{key:"getPastShots",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[O.B.RERACK,O.B.SCORE],n=[],r=this.entries.length-1;r>=0&&n.length<e;r--)t.includes(this.entries[r].event.type)||n.unshift(this.entries[r]);return n}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function B(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var L=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");B(this,"container",void 0),B(this,"replayUrl",""),B(this,"hiScoreUrl","https://scoreboard-tailuge.vercel.app/hiscore.html"),this.container=e}return e=[{key:"lastShotLink",value:function(e,t,n,r){var i="#000000";n.length>0&&n.forEach(function(e){e.ballmesh&&(i="#"+e.ballmesh.color.getHexString())});var o="âšˆ".repeat(t>1?t-1:0)+(e?"âšˆ":"âš†"),s=JSON.stringify(r);this.generateLink(o,s,i)}},{key:"breakLink",value:function(e,t,n){if(e&&(n||e.shots.pop(),1!==e.shots.length)){e.score=t;var r=JSON.stringify(e),i=I.k.crush(r);this.generateLink("break(".concat(t,")"),i,"black"),t>=2&&this.generateHiScoreLink(i)}}},{key:"wholeGameLink",value:function(e){var t="frame(".concat(this.shotCount(e.shots)," shots)"),n=JSON.stringify(e),r=I.k.crush(n);this.generateLink(t,r,"black")}},{key:"shotCount",value:function(e){return e.filter(function(e){return"RERACK"!==e.type}).length}},{key:"generateLink",value:function(e,t,n){var r="".concat(this.replayUrl).concat(I.k.fullyEncodeURI(t)),i='<a class="pill" style="color: '.concat(n,'" target="_blank" href="').concat(r,'">').concat(e,"</a>");this.container.eventQueue.push(new R.b(null,"".concat(i)))}},{key:"generateHiScoreLink",value:function(e){var t="".concat(this.hiScoreUrl,"?ruletype=").concat(this.container.rules.rulename,"&state=").concat(I.k.fullyEncodeURI(e)),n='<a class="pill" target="_blank" href="'.concat(t,'">').concat("hi score ðŸ†","</a>");this.container.eventQueue.push(new R.b(null,"".concat(n)))}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),N=n("./src/controller/rules/rulefactory.ts");function F(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var H=function(){var e;function t(e){var n=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");F(this,"container",void 0),F(this,"share",void 0),F(this,"camera",void 0),F(this,"disabled",!0),this.container=e,this.share=this.getElement("share"),this.camera=this.getElement("camera"),this.share&&(this.share.disabled=!0),this.camera&&(this.camera.onclick=function(e){n.adjustCamera()})}return e=[{key:"adjustCamera",value:function(){this.container.view.camera.toggleMode(),this.container.lastEventTime=performance.now()}},{key:"getElement",value:function(e){return(0,k.vq)(e)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function U(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var D=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");U(this,"p1Element",void 0),U(this,"p2Element",void 0),U(this,"breakElement",void 0),this.p1Element=(0,k.id)("p1Score"),this.p2Element=(0,k.id)("p2Score"),this.breakElement=(0,k.id)("breakScore")}return e=[{key:"setText",value:function(e,t){e&&(e.textContent=t)}},{key:"updateBreak",value:function(e){this.setText(this.p1Element,""),this.setText(this.p2Element,""),e>0&&this.breakElement?this.breakElement.innerHTML="Break</br>"+e:this.setText(this.breakElement,"")}},{key:"updateScores",value:function(e,t,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;this.setText(this.p1Element,""),this.setText(this.p2Element,""),this.setText(this.breakElement,""),n&&r?(this.setText(this.p1Element,"".concat(n,": ").concat(e)),this.setText(this.p2Element,"".concat(r,": ").concat(t))):n?this.setText(this.p1Element,"".concat(n,": ").concat(e)):r?this.setText(this.p2Element,"".concat(r,": ").concat(t)):this.setText(this.p1Element,"Score: ".concat(e)),i>0&&this.setText(this.breakElement,"Break: ".concat(i))}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function z(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function G(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var V=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");G(this,"element",void 0),G(this,"timeoutId",null),this.element=(0,k.id)("notification")}return e=[{key:"getIcon",value:function(e){return e.icon?e.icon:"Foul"===e.type?"ðŸŽ±":"GameOver"===e.type?"ðŸ†":"ðŸ”µ"}},{key:"show",value:function(e){var t,n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3e3;if(this.element){var i=r;if("string"==typeof e)t=this.renderStringContent(e),n="type-Info";else{var o=this.processData(e);t=o.content,n=o.typeClass,void 0!==e.duration&&(i=e.duration)}this.display(t,n,i)}}},{key:"renderStringContent",value:function(e){return`
+"use strict";(self.webpackChunkbilliards=self.webpackChunkbilliards||[]).push([[338],{"./src/container/container.ts"(e,t,n){n.d(t,{m:()=>$});var r=n("./src/network/client/session.ts"),i=n("./src/events/stationaryevent.ts"),o=n("./node_modules/three/build/three.core.js"),s=n("./src/utils/utils.ts"),a=n("./src/view/cameratop.ts"),l=n("./src/model/physics/constants.ts");function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var u=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");c(this,"camera",void 0),c(this,"mode",this.topView),c(this,"mainMode",this.aimView),c(this,"height",8*l.R),c(this,"target",new o.Pq0),c(this,"lookTarget",new o.Pq0),c(this,"tempVec",new o.Pq0),c(this,"elapsed",void 0),this.camera=new o.ubm(45,e,l.R,1e3*l.R)}return e=[{key:"update",value:function(e,t){this.elapsed=e,this.mode(t)}},{key:"topView",value:function(e){this.camera.fov=a.v.fov,this.camera.position.lerp(a.v.viewPoint(this.camera.aspect,this.camera.fov,this.tempVec),.9),this.camera.up=s.up,this.camera.lookAt(s.v_)}},{key:"aimView",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.08,n=this.height,r=this.camera.aspect<.8;if(this.camera.fov=r?60:40,n<10*l.R){var i=100*(10*l.R-n);this.camera.fov-=i*(r?3:1)}this.target.copy(e.pos).addScaledVector((0,s.Dz)(e.angle,this.tempVec),-(18*l.R)),this.camera.position.lerp(this.target,t),this.camera.position.z=n,this.camera.up=s.up,this.lookTarget.copy(e.pos).addScaledVector(s.up,n/2),this.camera.lookAt(this.lookTarget)}},{key:"adjustHeight",value:function(e){e=this.height<10*l.R?e/8:e,this.height=o.cj9.clamp(this.height+e,6*l.R,120*l.R),this.height>110*l.R&&this.suggestMode(this.topView),this.height<105*l.R&&this.suggestMode(this.aimView)}},{key:"suggestMode",value:function(e){this.mainMode===this.aimView&&(this.mode=e)}},{key:"forceMode",value:function(e){this.mode=e,this.mainMode=e}},{key:"forceMove",value:function(e){this.mode===this.aimView&&this.aimView(e,1)}},{key:"toggleMode",value:function(){this.mode===this.topView?this.mode=this.aimView:this.mode=this.topView,this.mainMode=this.mode}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),h=n("./src/view/tablegeometry.ts"),f=function(){var e;function t(){var e,n;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");e="material",n=new o.mrM({color:132,opacity:.15,transparent:!0}),e in this?Object.defineProperty(this,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):this[e]=n}return e=[{key:"generateLineSegments",value:function(){var e=this,t=[this.point(0,-11.13*l.R/.5),this.point(0,11.13*l.R/.5)],n=h.P.X/4,r=h.P.tableY+l.R;[1,2,3,-1,-2,-3].forEach(function(i){t.push(e.point(i*n,-r)),t.push(e.point(i*n,r))});var i=(h.P.Y+l.R)/2,s=h.P.tableX+l.R;[-1,0,1].forEach(function(n){t.push(e.point(-s,n*i)),t.push(e.point(s,n*i))});var a=new o.LoY().setFromPoints(t);return new o.DXC(a,this.material)}},{key:"point",value:function(e,t){var n=-(.485*l.R)/.5;return new o.Pq0(e,t,n)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),p=n("./node_modules/three/build/three.module.js"),d=n("./src/controller/rules/snooker.ts");function v(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var y=function(){var e;function t(e,n,r){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");v(this,"scene",new o.Z58),v(this,"renderer",void 0),v(this,"camera",void 0),v(this,"windowWidth",1),v(this,"windowHeight",1),v(this,"lastFov",0),v(this,"element",void 0),v(this,"table",void 0),v(this,"loadAssets",!0),v(this,"assets",void 0),v(this,"frustum",new o.PPD),v(this,"projScreenMatrix",new o.kn4),v(this,"ballToCheck",0),this.element=e,this.table=n,this.assets=r,this.renderer=function(e){if("u"<typeof process){var t=new p.JeP({antialias:!1});return t.shadowMap.enabled=!1,t.autoClear=!1,t.setSize(e.offsetWidth,e.offsetHeight),t.setPixelRatio(.75*window.devicePixelRatio),e.appendChild(t.domElement),t}}(e),this.camera=new u(e?e.offsetWidth/e.offsetHeight:1),this.initialiseScene()}return e=[{key:"update",value:function(e,t){this.camera.update(e,t)}},{key:"sizeChanged",value:function(){var e,t;return this.windowWidth!=(null==(e=this.element)?void 0:e.offsetWidth)||this.windowHeight!=(null==(t=this.element)?void 0:t.offsetHeight)}},{key:"updateSize",value:function(){var e,t,n=this.sizeChanged();return n&&(this.windowWidth=null==(e=this.element)?void 0:e.offsetWidth,this.windowHeight=null==(t=this.element)?void 0:t.offsetHeight),n}},{key:"render",value:function(){this.isInMotionNotVisible()&&this.camera.suggestMode(this.camera.topView),this.renderCamera(this.camera)}},{key:"renderCamera",value:function(e){var t=this.updateSize();if(t){var n,r,i,o,s,a=this.windowWidth,l=this.windowHeight;null==(r=this.renderer)||r.setSize(a,l),null==(i=this.renderer)||i.setViewport(0,0,a,l),null==(o=this.renderer)||o.setScissor(0,0,a,l),null==(s=this.renderer)||s.setScissorTest(!0),e.camera.aspect=a/l}(t||e.camera.fov!==this.lastFov)&&(e.camera.updateProjectionMatrix(),this.lastFov=e.camera.fov),null==(n=this.renderer)||n.render(this.scene,e.camera)}},{key:"initialiseScene",value:function(){this.scene.add(new o.$p8(39202,.3)),this.assets.background&&this.scene.add(this.assets.background),this.scene.add(this.assets.table),this.table.mesh=this.assets.table,this.assets.rules.asset()!==d.c.tablemodel&&this.scene.add(new f().generateLineSegments())}},{key:"isInMotionNotVisible",value:function(){var e=this.viewFrustum(),t=this.table.balls[this.ballToCheck++%this.table.balls.length];return t.inMotion()&&!e.intersectsObject(t.ballmesh.mesh)}},{key:"viewFrustum",value:function(){var e=this.camera.camera;return this.frustum.setFromProjectionMatrix(this.projScreenMatrix.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse)),this.frustum}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),m=n("./src/controller/init.ts"),b=n("./src/events/input.ts");function g(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var w=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");g(this,"line",new o.cZY),g(this,"balls",void 0),this.balls=e}return e=[{key:"getFirst",value:function(e,t){var n=this;this.line.set(e.pos,(0,s.xb)(t).multiplyScalar(4*h.P.X).add(e.pos));var r=new o.Pq0,i=this.balls.map(function(t){return n.line.closestPointToPoint(t.pos,!0,r),{ball:t,perpendicular:r.distanceTo(t.pos),distance:r.distanceTo(e.pos)}}).filter(function(e){return e.perpendicular<2*l.R}).filter(function(t){return t.ball!==e});return i.reduce(function(e,t){return e.distance<t.distance?e:t},i[0])}},{key:"getOverlapOffset",value:function(e,t){var n=this.getFirst(e,t);if(n){var r=n.ball.pos.clone().sub(e.pos),i=n.perpendicular*Math.sign(r.cross(t).z)/l.R;return{ball:n.ball,overlap:i}}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),k=n("./src/utils/dom.ts");function x(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var T=function(){var e;function t(e){var n,i=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");x(this,"cueBallElement",void 0),x(this,"cueTipElement",void 0),x(this,"cuePowerElement",void 0),x(this,"cueHitElement",void 0),x(this,"objectBallStyle",void 0),x(this,"container",void 0),x(this,"overlap",void 0),x(this,"ballWidth",void 0),x(this,"ballHeight",void 0),x(this,"tipRadius",void 0),x(this,"mousemove",function(e){1===e.buttons&&i.adjustSpin(e)}),x(this,"powerChanged",function(e){i.container.table.cue.setPower(i.cuePowerElement.value)}),x(this,"hit",function(e){var t;i.container.table.cue.setPower(null==(t=i.cuePowerElement)?void 0:t.value),i.container.inputQueue.push(new b.p(0,"SpaceUp"))}),x(this,"mousewheel",function(e){i.cuePowerElement&&(i.cuePowerElement.value-=Math.sign(e.deltaY)/10,i.container.table.cue.setPower(i.cuePowerElement.value),i.container.lastEventTime=performance.now())}),this.container=e,this.cueBallElement=(0,k.id)("cueBall"),this.cueTipElement=(0,k.id)("cueTip"),this.cuePowerElement=(0,k.id)("cuePower"),this.cueHitElement=(0,k.id)("cueHit"),this.objectBallStyle=null==(n=(0,k.id)("objectBall"))?void 0:n.style,this.overlap=new w(this.container.table.balls),this.addListeners(),r.N.isSpectator()&&this.setDisabled(!0)}return e=[{key:"addListeners",value:function(){var e,t,n,r,i,o=this;null==(e=this.cueBallElement)||e.addEventListener("pointermove",this.mousemove),null==(t=this.cueBallElement)||t.addEventListener("click",function(e){o.adjustSpin(e)}),null==(n=this.cueHitElement)||n.addEventListener("click",this.hit),null==(r=this.cuePowerElement)||r.addEventListener("change",this.powerChanged),"ontouchstart"in globalThis||null==(i=(0,k.id)("viewP1"))||i.addEventListener("dblclick",this.hit),document.addEventListener("wheel",this.mousewheel)}},{key:"setButtonText",value:function(e){this.cueHitElement&&(this.cueHitElement.innerText=e)}},{key:"setDisabled",value:function(e){this.cueHitElement&&(this.cueHitElement.disabled=e||r.N.isSpectator())}},{key:"readDimensions",value:function(){var e,t,n;this.ballWidth=null==(e=this.cueBallElement)?void 0:e.offsetWidth,this.ballHeight=null==(t=this.cueBallElement)?void 0:t.offsetHeight,this.tipRadius=(null==(n=this.cueTipElement)?void 0:n.offsetWidth)/2}},{key:"adjustSpin",value:function(e){this.readDimensions(),this.container.table.cue.setSpin(new o.Pq0(-(e.offsetX-this.ballWidth/2)/this.ballWidth,-(e.offsetY-this.ballHeight/2)/this.ballHeight),this.container.table),this.container.lastEventTime=performance.now()}},{key:"updateVisualState",value:function(e,t){this.readDimensions();var n,r=null==(n=this.cueTipElement)?void 0:n.style;r&&(r.left=(-e+.5)*this.ballWidth-this.tipRadius+"px",r.top=(-t+.5)*this.ballHeight-this.tipRadius+"px"),this.showOverlap()}},{key:"showOverlap",value:function(){if(this.objectBallStyle){var e=this.container.table,t=(0,s.Dz)(e.cue.aim.angle),n=this.overlap.getOverlapOffset(e.cueball,t);n?(this.readDimensions(),this.objectBallStyle.visibility="visible",this.objectBallStyle.left=5+n.overlap*this.ballWidth/2+"px",this.objectBallStyle.backgroundColor=new o.Q1f(0,0,0).lerp(n.ball.ballmesh.color,.5).getStyle()):this.objectBallStyle.visibility="hidden"}}},{key:"updatePowerSlider",value:function(e){var t;e>0&&(null==(t=this.cuePowerElement)?void 0:t.value)&&(this.cuePowerElement.value=e)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function P(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var S=function(){var e;function t(e){var n,r=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");P(this,"chatoutput",void 0),P(this,"chatInput",void 0),P(this,"chatSend",void 0),P(this,"chatInputText",void 0),P(this,"send",void 0),P(this,"sendClicked",function(e){var t,n;r.send(null==(t=r.chatInputText)?void 0:t.value),r.showMessage(null==(n=r.chatInputText)?void 0:n.value)}),this.chatoutput=(0,k.id)("chatoutput"),this.chatInputText=(0,k.V4)("chatinputtext"),this.chatSend=(0,k.id)("chatsend"),null==(n=this.chatSend)||n.addEventListener("click",this.sendClicked),this.send=e}return e=[{key:"showMessage",value:function(e){this.chatoutput&&(this.chatoutput.innerHTML+=e),this.updateScroll()}},{key:"updateScroll",value:function(){this.chatoutput&&(this.chatoutput.scrollTop=this.chatoutput.scrollHeight)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),R=n("./src/events/chatevent.ts"),O=n("./src/events/eventtype.ts");function E(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var A=function(){var e;function t(e,n){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");E(this,"period",void 0),E(this,"pending",null),E(this,"sentTime",0),E(this,"apply",function(e){}),this.period=e,this.apply=n}return e=[{key:"flush",value:function(){this.pending&&(this.apply(this.pending),this.pending=null)}},{key:"send",value:function(e){if(performance.now()>this.sentTime+this.period||e.type!==O.B.AIM){this.flush(),this.apply(e),this.sentTime=performance.now();return}this.pending=e}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),M=n("./src/view/sliders.ts"),_=n("./src/model/outcome.ts"),I=n("./src/utils/replay-encoder.ts");function C(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var j=function(){var e;function t(e,n){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");C(this,"container",void 0),C(this,"linkFormatter",void 0),C(this,"entries",[]),C(this,"start",Date.now()),C(this,"breakStart",void 0),C(this,"breakStartTime",void 0),this.container=e,this.linkFormatter=n}return e=[{key:"shots",get:function(){return this.entries.map(function(e){return e.event})}},{key:"states",get:function(){return this.entries.map(function(e){return e.state})}},{key:"record",value:function(e){var t=e;e.type===O.B.HIT&&(t=e.tablejson.aim),(e.type===O.B.HIT||e.type===O.B.RERACK||e.type===O.B.PLACEBALL||e.type===O.B.SCORE)&&this.entries.push({state:this.container.table.shortSerialise(),event:t,pots:0,isPartOfBreak:!1,time:Date.now()})}},{key:"findLastIndex",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[O.B.RERACK,O.B.SCORE],t=this.entries.length-1;t>=0&&e.includes(this.entries[t].event.type);)t--;return t}},{key:"getPlayerNames",value:function(){if(r.N.hasInstance()){var e=r.N.getInstance(),t=0===e.playerIndex;return{player1:(t?e.playername:e.opponentName)||"Player",player2:(t?e.opponentName:e.playername)||"Opponent"}}}},{key:"wholeGame",value:function(){var e;return I.k.createState(null==(e=this.entries[0])?void 0:e.state,this.entries.map(function(e){return e.event}),this.start,this.container.scores[r.N.playerIndex()],!0,this.getPlayerNames())}},{key:"last",value:function(){return this.findLastIndex()}},{key:"lastShot",value:function(){var e=this.last();if(!(e<0)){for(var t=this.entries[e],n=[t.event],r=e+1;r<this.entries.length;r++)this.entries[r].event.type===O.B.SCORE&&n.push(this.entries[r].event);return I.k.createState(t.state,n,0,0,!1,this.getPlayerNames())}}},{key:"currentBreak",value:function(){if(void 0!==this.breakStart){var e=this.entries.slice(this.breakStart);return I.k.createState(this.entries[this.breakStart].state,e.map(function(e){return e.event}),this.breakStartTime,this.container.rules.previousBreak,!1,this.getPlayerNames())}}},{key:"updateBreak",value:function(e,t,n){var r=_.P.potCount(e),i=this.last();if(i>=0&&(this.entries[i].pots=r,this.entries[i].isPartOfBreak=t),t||this.breakLink(n),this.lastShotLink(t||n,r,_.P.pots(e)),n&&this.breakLink(n),!t){this.breakStart=void 0;return}void 0===this.breakStart&&(this.breakStart=i,this.breakStartTime=Date.now())}},{key:"lastShotLink",value:function(e,t,n){var r=this.lastShot();r&&this.linkFormatter.lastShotLink(e,t,n,r)}},{key:"breakLink",value:function(e){var t=this.currentBreak();if(t){var n=0===this.container.rules.currentBreak?this.container.rules.previousBreak:this.container.rules.currentBreak;if(e)return void this.linkFormatter.breakLink(t,n,!0);for(var r=t.shots.slice();r.length>0&&(r[r.length-1].type===O.B.SCORE||r[r.length-1].type===O.B.RERACK);)r.pop();if(0!==r.length){var i,o,s=(i=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(t){C(e,t,n[t])})}return e}({},t),o=o={shots:r},Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(o)):(function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t.push.apply(t,n)}return t})(Object(o)).forEach(function(e){Object.defineProperty(i,e,Object.getOwnPropertyDescriptor(o,e))}),i);this.linkFormatter.breakLink(s,n,!1)}}}},{key:"wholeGameLink",value:function(){this.linkFormatter.wholeGameLink(this.wholeGame())}},{key:"getPastShots",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[O.B.RERACK,O.B.SCORE],n=[],r=this.entries.length-1;r>=0&&n.length<e;r--)t.includes(this.entries[r].event.type)||n.unshift(this.entries[r]);return n}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function B(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var L=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");B(this,"container",void 0),B(this,"replayUrl",""),B(this,"hiScoreUrl","https://scoreboard-tailuge.vercel.app/hiscore.html"),this.container=e}return e=[{key:"lastShotLink",value:function(e,t,n,r){var i="#000000";n.length>0&&n.forEach(function(e){e.ballmesh&&(i="#"+e.ballmesh.color.getHexString())});var o="âšˆ".repeat(t>1?t-1:0)+(e?"âšˆ":"âš†"),s=JSON.stringify(r);this.generateLink(o,s,i)}},{key:"breakLink",value:function(e,t,n){if(e&&(n||e.shots.pop(),1!==e.shots.length)){e.score=t;var r=JSON.stringify(e),i=I.k.crush(r);this.generateLink("break(".concat(t,")"),i,"black"),t>=2&&this.generateHiScoreLink(i)}}},{key:"wholeGameLink",value:function(e){var t="frame(".concat(this.shotCount(e.shots)," shots)"),n=JSON.stringify(e),r=I.k.crush(n);this.generateLink(t,r,"black")}},{key:"shotCount",value:function(e){return e.filter(function(e){return"RERACK"!==e.type}).length}},{key:"generateLink",value:function(e,t,n){var r="".concat(this.replayUrl).concat(I.k.fullyEncodeURI(t)),i='<a class="pill" style="color: '.concat(n,'" target="_blank" href="').concat(r,'">').concat(e,"</a>");this.container.eventQueue.push(new R.b(null,"".concat(i)))}},{key:"generateHiScoreLink",value:function(e){var t="".concat(this.hiScoreUrl,"?ruletype=").concat(this.container.rules.rulename,"&state=").concat(I.k.fullyEncodeURI(e)),n='<a class="pill" target="_blank" href="'.concat(t,'">').concat("hi score ðŸ†","</a>");this.container.eventQueue.push(new R.b(null,"".concat(n)))}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),N=n("./src/controller/rules/rulefactory.ts");function F(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var H=function(){var e;function t(e){var n=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");F(this,"container",void 0),F(this,"share",void 0),F(this,"camera",void 0),F(this,"disabled",!0),this.container=e,this.share=this.getElement("share"),this.camera=this.getElement("camera"),this.share&&(this.share.disabled=!0),this.camera&&(this.camera.onclick=function(e){n.adjustCamera()})}return e=[{key:"adjustCamera",value:function(){this.container.view.camera.toggleMode(),this.container.lastEventTime=performance.now()}},{key:"getElement",value:function(e){return(0,k.vq)(e)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function U(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var D=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");U(this,"p1Element",void 0),U(this,"p2Element",void 0),U(this,"breakElement",void 0),this.p1Element=(0,k.id)("p1Score"),this.p2Element=(0,k.id)("p2Score"),this.breakElement=(0,k.id)("breakScore")}return e=[{key:"setText",value:function(e,t){e&&(e.textContent=t)}},{key:"updateBreak",value:function(e){this.setText(this.p1Element,""),this.setText(this.p2Element,""),e>0&&this.breakElement?this.breakElement.innerHTML="Break</br>"+e:this.setText(this.breakElement,"")}},{key:"updateScores",value:function(e,t,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;this.setText(this.p1Element,""),this.setText(this.p2Element,""),this.setText(this.breakElement,""),n&&r?(this.setText(this.p1Element,"".concat(n,": ").concat(e)),this.setText(this.p2Element,"".concat(r,": ").concat(t))):n?this.setText(this.p1Element,"".concat(n,": ").concat(e)):r?this.setText(this.p2Element,"".concat(r,": ").concat(t)):this.setText(this.p1Element,"Score: ".concat(e)),i>0&&this.setText(this.breakElement,"Break: ".concat(i))}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function z(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function G(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var V=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");G(this,"element",void 0),G(this,"timeoutId",null),this.element=(0,k.id)("notification")}return e=[{key:"getIcon",value:function(e){return e.icon?e.icon:"Foul"===e.type?"ðŸŽ±":"GameOver"===e.type?"ðŸ†":"ðŸ”µ"}},{key:"show",value:function(e){var t,n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3e3;if(this.element){var i=r;if("string"==typeof e)t=this.renderStringContent(e),n="type-Info";else{var o=this.processData(e);t=o.content,n=o.typeClass,void 0!==e.duration&&(i=e.duration)}this.display(t,n,i)}}},{key:"renderStringContent",value:function(e){return`
       <div class="notification-banner">
         <div class="notification-text-group">
           <div class="notification-subtext">`.concat(e,`</div>
         </div>
       </div>
@@ -11,11 +11,11 @@
           <div class="notification-title">`).concat(e.title,`</div>
           `).concat(e.subtext?'<div class="notification-subtext">'.concat(e.subtext,"</div>"):"",`
         </div>
       </div>
       `).concat(r,`
-    `),typeClass:t}}},{key:"renderExtra",value:function(e){return e?e.includes("<")?'<div class="notification-extra">'.concat(e,"</div>"):'<div class="notification-badge">'.concat(e,"</div>"):""}},{key:"display",value:function(e,t,n){var r,i,o=this;this.element&&(this.element.innerHTML=e,this.element.className="",(i=this.element.classList).add.apply(i,function(e){if(Array.isArray(e))return z(e)}(r=t.split(" "))||function(e){if("u">typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(r)||function(e){if(e){if("string"==typeof e)return z(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return z(e,void 0)}}(r)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),this.element.style.display="flex",this.timeoutId&&globalThis.clearTimeout(this.timeoutId),n>0&&(this.timeoutId=globalThis.setTimeout(function(){o.clear()},n)))}},{key:"clear",value:function(){this.element&&(this.element.innerHTML="",this.element.style.display="none",this.element.className=""),this.timeoutId&&(globalThis.clearTimeout(this.timeoutId),this.timeoutId=null)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),q=n("./src/events/notificationevent.ts");function K(e,t,n,r,i,o,s){try{var a=e[o](s),l=a.value}catch(e){n(e);return}a.done?t(l):Promise.resolve(l).then(r,i)}function X(e){return function(){var t=this,n=arguments;return new Promise(function(r,i){var o=e.apply(t,n);function s(e){K(o,r,i,s,a,"next",e)}function a(e){K(o,r,i,s,a,"throw",e)}s(void 0)})}}function W(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Y(e,t){var n,r,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype),a=Object.defineProperty;return a(s,"next",{value:l(0)}),a(s,"throw",{value:l(1)}),a(s,"return",{value:l(2)}),"function"==typeof Symbol&&a(s,Symbol.iterator,{value:function(){return this}}),s;function l(a){return function(l){var c=[a,l];if(n)throw TypeError("Generator is already executing.");for(;s&&(s=0,c[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&c[0]?r.return:c[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,c[1])).done)return i;switch(r=0,i&&(c=[2&c[0],i.value]),c[0]){case 0:case 1:i=c;break;case 4:return o.label++,{value:c[1],done:!1};case 5:o.label++,r=c[1],c=[0];continue;case 7:c=o.ops.pop(),o.trys.pop();continue;default:if(!(i=(i=o.trys).length>0&&i[i.length-1])&&(6===c[0]||2===c[0])){o=0;continue}if(3===c[0]&&(!i||c[1]>i[0]&&c[1]<i[3])){o.label=c[1];break}if(6===c[0]&&o.label<i[1]){o.label=i[1],i=c;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(c);break}i[2]&&o.ops.pop(),o.trys.pop();continue}c=t.call(e,o)}catch(e){c=[6,e],r=0}finally{n=i=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}}var J=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");W(this,"relay",void 0),W(this,"element",void 0),this.relay=e,this.element=(0,k.id)("lobby")}return e=[{key:"init",value:function(){return X(function(){var e,t;return Y(this,function(n){switch(n.label){case 0:if(e=this,!this.relay||!this.element)return[2];return[4,(t=function(){return X(function(){var e,t;return Y(this,function(n){switch(n.label){case 0:return[4,null==(e=this.relay)?void 0:e.getOnlineCount()];case 1:return null!==(t=n.sent())&&this.element&&(this.element.textContent=" ".concat(t," ðŸ‘¥")),[2]}})}).call(e)})()];case 1:return n.sent(),this.relay.subscribe("lobby",function(e){try{var n=JSON.parse(e);"connected"===n.action&&t()}catch(e){}},"lobby"),[2]}})}).call(this)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),Q=n("./src/events/scoreevent.ts");function Z(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var $=function(){var e;function t(e,n,r,i,o,s){var a=this,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");Z(this,"table",void 0),Z(this,"view",void 0),Z(this,"controller",void 0),Z(this,"inputQueue",[]),Z(this,"eventQueue",[]),Z(this,"keyboard",void 0),Z(this,"sound",void 0),Z(this,"chat",void 0),Z(this,"sliders",void 0),Z(this,"recorder",void 0),Z(this,"linkFormatter",void 0),Z(this,"id",""),Z(this,"isSinglePlayer",!0),Z(this,"rules",void 0),Z(this,"menu",void 0),Z(this,"hud",void 0),Z(this,"notification",void 0),Z(this,"lobbyIndicator",void 0),Z(this,"relay",null),Z(this,"scoreReporter",null),Z(this,"frame",void 0),Z(this,"scores",[0,0]),Z(this,"currentBreak",0),Z(this,"last",performance.now()),Z(this,"step",.001953125),Z(this,"broadcast",function(){}),Z(this,"log",void 0),Z(this,"sendChat",function(e){a.sendEvent(new R.b(a.id,e))}),Z(this,"throttle",new A(0,function(e){a.broadcast(e)})),Z(this,"lastEventTime",performance.now()),this.log=n,this.rules=N.V.create(i,this),this.table=this.rules.table(),this.view=new y(e,this.table,r),this.table.cue.aimInputs=new T(this),this.keyboard=o,this.sound=r.sound,this.chat=new S(this.sendChat),this.sliders=new M.r,this.linkFormatter=new L(this),this.recorder=new j(this,this.linkFormatter),this.id=s,this.menu=new H(this),this.table.addToScene(this.view.scene),this.hud=new D,this.notification=new V,this.relay=l,this.scoreReporter=c,this.lobbyIndicator=new J(this.relay),this.lobbyIndicator.init(),this.updateController(new m.J(this))}return e=[{key:"sendEvent",value:function(e){this.recorder.record(e),this.throttle.send(e)}},{key:"updateScoreHud",value:function(e,t,n){this.scores=[e,t],this.currentBreak=n;var i=void 0,o=void 0;if(r.N.hasInstance()){var s=r.N.getInstance(),a=0===r.N.playerIndex();i=(a?s.playername:s.opponentName)||void 0,o=(a?s.opponentName:s.playername)||void 0}this.hud.updateScores(e,t,i,o,n)}},{key:"sendScoreUpdate",value:function(e,t,n){var r=this.scores[0]!==e||this.scores[1]!==t||this.currentBreak!==n;this.updateScoreHud(e,t,n),r&&this.sendEvent(new Q.P(e,t,n))}},{key:"notify",value:function(e,t){this.notification.show(e,t),this.sendEvent(new q.c(e,t))}},{key:"notifyLocal",value:function(e,t){this.notification.show(e,t)}},{key:"advance",value:function(e){null==(t=this.frame)||t.call(this,e);for(var t,n=Math.floor(e/this.step),r=n*this.step,o=this.table.allStationary(),s=0;s<n;s++)this.table.advance(this.step);this.table.updateBallMesh(r),this.view.update(r,this.table.cue.aim),this.table.cue.update(r),!o&&this.table.allStationary()&&this.eventQueue.push(new i.T),this.sound.processOutcomes(this.table.outcome)}},{key:"processEvents",value:function(){var e=this;for(this.keyboard&&this.keyboard.getEvents().forEach(function(t){return e.inputQueue.push(t)});this.inputQueue.length>0;){this.lastEventTime=this.last;var t=this.inputQueue.shift();t&&this.updateController(this.controller.handleInput(t))}if(this.table.allStationary()){var n=this.eventQueue.shift();n&&(this.lastEventTime=performance.now(),this.recorder.record(n),this.updateController(n.applyToController(this.controller)))}}},{key:"animate",value:function(e){var t=this;this.advance((e-this.last)/1e3),this.last=e,this.processEvents(),(e<this.lastEventTime+12e3||!this.table.allStationary()||this.view.sizeChanged())&&this.view.render(),requestAnimationFrame(function(e){t.animate(e)})}},{key:"updateController",value:function(e){if(e!==this.controller){var t=r.N.hasInstance()?r.N.getInstance().playername:"_";this.log("".concat(t,": Transition to ").concat(e.name)),this.controller=e,this.controller.onFirst()}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/controller/aim.ts"(e,t,n){n.d(t,{m:()=>d});var r=n("./src/controller/controller.ts"),i=n("./src/controller/controllerbase.ts");function o(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){var t,r,i;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return r=n,i=[e],r=s(r),(t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(r,i||[],s(this).constructor):r.apply(this,i))).hit(),t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&a(n,e),t=[{key:"handleStationary",value:function(e){var t,n=this.container.table,r=n.outcome,i=this.container.rules.update(r),s=function(e){if(Array.isArray(e))return e}(t=this.container.rules.getScores())||function(e){var t,n,r=null==e?null:"u">typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var i=[],o=!0,s=!1;try{for(r=r.call(e);!(o=(t=r.next()).done)&&(i.push(t.value),2!==i.length);o=!0);}catch(e){s=!0,n=e}finally{try{o||null==r.return||r.return()}finally{if(s)throw n}}return i}}(t)||function(e){if(e){if("string"==typeof e)return o(e,2);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return o(e,2)}}(t)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(),a=s[0],l=s[1],c=this.container.rules.currentBreak;this.container.sendScoreUpdate(a,l,c);var u=this.container.rules.isPartOfBreak(r),h=this.container.rules.isEndOfGame(r);return this.container.recorder.updateBreak(r,u,h),n.cue.aimAtNext(n.cueball,this.container.rules.nextCandidateBall()),i}},{key:"handleInput",value:function(e){return this.commonKeyHandler(e),this}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(i.y),u=n("./src/controller/replay.ts");function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function p(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(p=function(){return!!e})()}var d=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");t=n,r=[e],t=h(t);var t,r,i,o=(i=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,p()?Reflect.construct(t,r||[],h(this).constructor):t.apply(this,r))).container.table;return o.cue.aimMode(),o.cue.showHelper(!0),o.cueball=i.container.rules.cueball,o.cue.aim.i=o.balls.indexOf(o.cueball),o.cue.moveTo(o.cueball.pos),o.cue.aimAtNext(o.cueball,i.container.rules.nextCandidateBall()),i.container.view.camera.suggestMode(i.container.view.camera.aimView),o.cue.aimInputs.showOverlap(),i}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&f(n,e),t=[{key:"onFirst",value:function(){this.container.table.cue.aimInputs.setDisabled(!1)}},{key:"handleInput",value:function(e){switch(e.key){case"Space":this.container.table.cue.adjustPower(e.t*this.scale*.7);break;case"SpaceUp":return this.playShot();default:if(!this.commonKeyHandler(e))return this}return this.container.sendEvent(this.container.table.cue.aim),this}},{key:"handleBreak",value:function(e){return new u.e(this.container,e.init,e.shots,e.retry)}},{key:"playShot",value:function(){var e=new r.Qe(this.container.table.serialise());return this.container.sendEvent(e),new c(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(i.y)},"./src/controller/controller.ts"(e,t,n){n.d(t,{Qe:()=>i.Q,pd:()=>o.p,wG:()=>r.w,xI:()=>s}),n("./src/events/beginevent.ts");var r=n("./src/events/aimevent.ts"),i=n("./src/events/hitevent.ts"),o=n("./src/events/input.ts");n("./src/events/abortevent.ts"),n("./src/events/stationaryevent.ts");var s=function(){var e;function t(e){var n,r;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");r=void 0,(n="container")in this?Object.defineProperty(this,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):this[n]=r,this.container=e}return e=[{key:"name",get:function(){return this.constructor.name}},{key:"handleInput",value:function(e){return this}},{key:"handleBegin",value:function(e){return this}},{key:"handleBreak",value:function(e){return this}},{key:"handleStartAim",value:function(e){return this}},{key:"handleAim",value:function(e){return this}},{key:"handleHit",value:function(e){return this}},{key:"handleAbort",value:function(e){return this}},{key:"handleWatch",value:function(e){return this}},{key:"handlePlaceBall",value:function(e){return this}},{key:"handleStationary",value:function(e){return this}},{key:"handleChat",value:function(e){return this}},{key:"handleRejoin",value:function(e){return this}},{key:"handleNotification",value:function(e){return this}},{key:"handleScore",value:function(e){return this}},{key:"onFirst",value:function(){}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/controller/controllerbase.ts"(e,t,n){n.d(t,{y:()=>h});var r=n("./src/controller/controller.ts"),i=n("./src/utils/gltf.ts"),o=n("./src/model/outcome.ts"),s=n("./node_modules/three/build/three.core.js");function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(e){return e&&"u">typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(u=function(){return!!e})()}var h=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t,r,i,o;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return t=n,r=arguments,t=a(t),(o="scale")in(i=e=function(e,t){if(t&&("object"===c(t)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,u()?Reflect.construct(t,r||[],a(this).constructor):t.apply(this,r)))?Object.defineProperty(i,o,{value:.001,enumerable:!0,configurable:!0,writable:!0}):i[o]=.001,e}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&l(n,e),t=[{key:"handleChat",value:function(e){var t=e.sender?"".concat(e.sender,":"):"",n="".concat(t," ").concat(e.message);return this.container.chat.showMessage(n),this}},{key:"handleNotification",value:function(e){return this.container.notification.show(e.data,e.duration),this}},{key:"handleScore",value:function(e){return this.container.updateScoreHud(e.p1,e.p2,e.b),this}},{key:"hit",value:function(){this.container.table.outcome=[o.P.hit(this.container.table.cueball,this.container.table.cue.aim.power)],this.container.table.hit(),this.container.view.camera.suggestMode(this.container.view.camera.aimView),this.container.table.cue.showHelper(!1)}},{key:"commonKeyHandler",value:function(e){var t=this.container.table.cue,n=e.t*this.scale;switch(e.key){case"ArrowLeft":return t.rotateAim(-n,this.container.table),!0;case"ArrowRight":return t.rotateAim(n,this.container.table),!0;case"ArrowDown":return t.adjustSpin(new s.Pq0(0,-n),this.container.table),!0;case"ArrowUp":return t.adjustSpin(new s.Pq0(0,n),this.container.table),!0;case"ShiftArrowLeft":return t.adjustSpin(new s.Pq0(n,0),this.container.table),!0;case"ShiftArrowRight":return t.adjustSpin(new s.Pq0(-n,0),this.container.table),!0;case"KeyPUp":return(0,i.KP)(this.container.view.scene),!0;case"KeyHUp":return t.toggleHelper(),!0;case"movementXUp":return t.rotateAim(2*n,this.container.table),!0;case"movementYUp":case"NumpadSubtract":return this.container.view.camera.adjustHeight(8*n),!0;case"NumpadAdd":return this.container.view.camera.adjustHeight(-(8*n)),!0;case"KeyOUp":return this.container.view.camera.toggleMode(),!0;case"KeyDUp":return this.togglePanel(),!0;case"KeyFUp":return this.toggleFullscreen(),!0;default:return!1}}},{key:"togglePanel",value:function(){this.container.sliders.toggleVisibility(),this.container.table.showSpin(!0),this.container.table.showTraces(!0),("u"<typeof process?"undefined":c(process))!=="object"&&console.log(this.container.table.serialise())}},{key:"toggleFullscreen",value:function(){document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen()}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.xI)},"./src/controller/end.ts"(e,t,n){n.d(t,{o:()=>c});var r=n("./src/controller/controller.ts"),i=n("./src/controller/init.ts"),o=n("./src/utils/replay-encoder.ts");function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e,t){var r,i,o,a,c;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return i=n,o=[e],i=s(i),r=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(i,o||[],s(this).constructor):i.apply(this,o)),c=void 0,(a="result")in r?Object.defineProperty(r,a,{value:c,enumerable:!0,configurable:!0,writable:!0}):r[a]=c,r.result=t,r}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&a(n,e),t=[{key:"onFirst",value:function(){if(this.result&&this.container.scoreReporter){try{var e=this.container.recorder.wholeGame(),t=JSON.stringify(e);this.result.replayData=o.k.crush(t)}catch(e){console.error("Failed to encode replay data",e)}this.container.scoreReporter.submitMatchResult(this.result)}}},{key:"handleChat",value:function(e){var t=e.sender?"".concat(e.sender,":"):"",n="".concat(t," ").concat(e.message);return this.container.chat.showMessage(n),this}},{key:"handleBegin",value:function(e){return new i.J(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.xI)},"./src/controller/init.ts"(e,t,n){n.d(t,{J:()=>k});var r=n("./src/events/watchevent.ts"),i=n("./src/controller/watchaim.ts"),o=n("./src/controller/controllerbase.ts"),s=n("./src/controller/placeball.ts"),a=n("./src/controller/replay.ts"),l=n("./src/network/client/session.ts"),c=n("./src/controller/controller.ts"),u=n("./src/events/eventutil.ts");function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function f(e){return(f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(e,t){return null!=t&&"u">typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function v(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(v=function(){return!!e})()}var y=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e,t,r){var i,o,s;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return o=n,s=[e],o=f(o),h(i=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,v()?Reflect.construct(o,s||[],f(this).constructor):o.apply(this,s)),"messageRelay",void 0),h(i,"tableId",void 0),h(i,"messages",[]),i.messageRelay=t,i.tableId=r,i.messageRelay.subscribe(i.tableId,function(e){console.log(e);var t=u.d.fromSerialised(e);i.messages.push(t),(p(t,c.Qe)||p(t,c.wG))&&i.container.eventQueue.push(t)}),console.log("Spectate"),i}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&d(n,e),t=[{key:"handleAim",value:function(e){return this.container.table.cue.aim=e,this.container.table.cueball.pos.copy(e.pos),this}},{key:"handleHit",value:function(e){return console.log("Spectate Hit"),this.container.table.updateFromSerialised(e.tablejson),this.container.table.outcome=[],this.container.table.hit(),this}},{key:"handleInput",value:function(e){return this.commonKeyHandler(e),this}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(o.y),m=n("./src/network/client/nchanmessagerelay.ts");function b(e){return(b=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function g(e,t){return(g=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function w(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(w=function(){return!!e})()}var k=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return e=n,t=arguments,e=b(e),function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,w()?Reflect.construct(e,t||[],b(this).constructor):e.apply(this,t))}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&g(n,e),t=[{key:"handleBegin",value:function(e){if(l.N.isSpectator()){var t;return new y(this.container,null!=(t=this.container.relay)?t:new m.p,l.N.getInstance().tableId)}return this.container.chat.showMessage("Start"),this.container.sendEvent(new r.Q(this.container.table.serialise())),new s.x(this.container)}},{key:"handleWatch",value:function(e){return this.container.chat.showMessage("Opponent to break"),this.container.rules.secondToPlay(),this.container.table.updateFromSerialised(e.json),l.N.hasInstance()&&(l.N.getInstance().playerIndex=1),new i.r(this.container)}},{key:"handleBreak",value:function(e){return e.init?(this.container.table.updateFromShortSerialised(e.init),this.container.chat.showMessage("Replay"),new a.e(this.container,e.init,e.shots)):new s.x(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(o.y)},"./src/controller/placeball.ts"(e,t,n){n.d(t,{x:()=>d});var r=n("./src/controller/controllerbase.ts"),i=n("./src/controller/controller.ts"),o=n("./src/controller/aim.ts"),s=n("./src/events/breakevent.ts"),a=n("./src/model/physics/constants.ts"),l=n("./node_modules/three/build/three.core.js"),c=n("./src/view/cuemesh.ts");function u(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function p(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(p=function(){return!!e})()}var d=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e,t){var r,i,o;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return i=n,o=[e],i=h(i),u(r=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,p()?Reflect.construct(i,o||[],h(this).constructor):i.apply(this,o)),"placescale",.02*a.R),u(r,"startPos",void 0),r.startPos=t,r.container.table.cue.moveTo(r.container.table.cueball.pos),r.container.table.cue.aim.power=0,r.container.view.camera.forceMode(r.container.view.camera.aimView),r}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&f(n,e),t=[{key:"onFirst",value:function(){var e=this.container.table.cueball;this.container.rules.allowsPlaceBall()&&(this.startPos?e.pos.copy(this.container.rules.placeBall(this.startPos.clone())):e.pos.copy(this.container.rules.placeBall())),e.setStationary(),e.updateMesh(0),this.container.table.cue.placeBallMode(),this.container.table.cue.showHelper(!1),this.container.table.cue.moveTo(this.container.table.cueball.pos),this.container.table.cue.aimInputs.setButtonText(`Place
+    `),typeClass:t}}},{key:"renderExtra",value:function(e){return e?e.includes("<")?'<div class="notification-extra">'.concat(e,"</div>"):'<div class="notification-badge">'.concat(e,"</div>"):""}},{key:"display",value:function(e,t,n){var r,i,o=this;this.element&&(this.element.innerHTML=e,this.element.className="",(i=this.element.classList).add.apply(i,function(e){if(Array.isArray(e))return z(e)}(r=t.split(" "))||function(e){if("u">typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(r)||function(e){if(e){if("string"==typeof e)return z(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return z(e,void 0)}}(r)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),this.element.style.display="flex",this.timeoutId&&globalThis.clearTimeout(this.timeoutId),n>0&&(this.timeoutId=globalThis.setTimeout(function(){o.clear()},n)))}},{key:"clear",value:function(){this.element&&(this.element.innerHTML="",this.element.style.display="none",this.element.className=""),this.timeoutId&&(globalThis.clearTimeout(this.timeoutId),this.timeoutId=null)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),q=n("./src/events/notificationevent.ts");function K(e,t,n,r,i,o,s){try{var a=e[o](s),l=a.value}catch(e){n(e);return}a.done?t(l):Promise.resolve(l).then(r,i)}function X(e){return function(){var t=this,n=arguments;return new Promise(function(r,i){var o=e.apply(t,n);function s(e){K(o,r,i,s,a,"next",e)}function a(e){K(o,r,i,s,a,"throw",e)}s(void 0)})}}function W(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Y(e,t){var n,r,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype),a=Object.defineProperty;return a(s,"next",{value:l(0)}),a(s,"throw",{value:l(1)}),a(s,"return",{value:l(2)}),"function"==typeof Symbol&&a(s,Symbol.iterator,{value:function(){return this}}),s;function l(a){return function(l){var c=[a,l];if(n)throw TypeError("Generator is already executing.");for(;s&&(s=0,c[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&c[0]?r.return:c[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,c[1])).done)return i;switch(r=0,i&&(c=[2&c[0],i.value]),c[0]){case 0:case 1:i=c;break;case 4:return o.label++,{value:c[1],done:!1};case 5:o.label++,r=c[1],c=[0];continue;case 7:c=o.ops.pop(),o.trys.pop();continue;default:if(!(i=(i=o.trys).length>0&&i[i.length-1])&&(6===c[0]||2===c[0])){o=0;continue}if(3===c[0]&&(!i||c[1]>i[0]&&c[1]<i[3])){o.label=c[1];break}if(6===c[0]&&o.label<i[1]){o.label=i[1],i=c;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(c);break}i[2]&&o.ops.pop(),o.trys.pop();continue}c=t.call(e,o)}catch(e){c=[6,e],r=0}finally{n=i=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}}var J=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");W(this,"relay",void 0),W(this,"element",void 0),this.relay=e,this.element=(0,k.id)("lobby")}return e=[{key:"init",value:function(){return X(function(){var e,t;return Y(this,function(n){switch(n.label){case 0:if(e=this,!this.relay||!this.element)return[2];return[4,(t=function(){return X(function(){var e,t;return Y(this,function(n){switch(n.label){case 0:return[4,null==(e=this.relay)?void 0:e.getOnlineCount()];case 1:return null!==(t=n.sent())&&this.element&&(this.element.textContent=" ".concat(t," ðŸ‘¥")),[2]}})}).call(e)})()];case 1:return n.sent(),setInterval(t,3e5),[2]}})}).call(this)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),Q=n("./src/events/scoreevent.ts");function Z(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var $=function(){var e;function t(e,n,r,i,o,s){var a=this,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");Z(this,"table",void 0),Z(this,"view",void 0),Z(this,"controller",void 0),Z(this,"inputQueue",[]),Z(this,"eventQueue",[]),Z(this,"keyboard",void 0),Z(this,"sound",void 0),Z(this,"chat",void 0),Z(this,"sliders",void 0),Z(this,"recorder",void 0),Z(this,"linkFormatter",void 0),Z(this,"id",""),Z(this,"isSinglePlayer",!0),Z(this,"rules",void 0),Z(this,"menu",void 0),Z(this,"hud",void 0),Z(this,"notification",void 0),Z(this,"lobbyIndicator",void 0),Z(this,"relay",null),Z(this,"scoreReporter",null),Z(this,"frame",void 0),Z(this,"scores",[0,0]),Z(this,"currentBreak",0),Z(this,"last",performance.now()),Z(this,"step",.001953125),Z(this,"broadcast",function(){}),Z(this,"log",void 0),Z(this,"sendChat",function(e){a.sendEvent(new R.b(a.id,e))}),Z(this,"throttle",new A(0,function(e){a.broadcast(e)})),Z(this,"lastEventTime",performance.now()),this.log=n,this.rules=N.V.create(i,this),this.table=this.rules.table(),this.view=new y(e,this.table,r),this.table.cue.aimInputs=new T(this),this.keyboard=o,this.sound=r.sound,this.chat=new S(this.sendChat),this.sliders=new M.r,this.linkFormatter=new L(this),this.recorder=new j(this,this.linkFormatter),this.id=s,this.menu=new H(this),this.table.addToScene(this.view.scene),this.hud=new D,this.notification=new V,this.relay=l,this.scoreReporter=c,this.lobbyIndicator=new J(this.relay),this.lobbyIndicator.init(),this.updateController(new m.J(this))}return e=[{key:"sendEvent",value:function(e){this.recorder.record(e),this.throttle.send(e)}},{key:"updateScoreHud",value:function(e,t,n){this.scores=[e,t],this.currentBreak=n;var i=void 0,o=void 0;if(r.N.hasInstance()){var s=r.N.getInstance(),a=0===r.N.playerIndex();i=(a?s.playername:s.opponentName)||void 0,o=(a?s.opponentName:s.playername)||void 0}this.hud.updateScores(e,t,i,o,n)}},{key:"sendScoreUpdate",value:function(e,t,n){var r=this.scores[0]!==e||this.scores[1]!==t||this.currentBreak!==n;this.updateScoreHud(e,t,n),r&&this.sendEvent(new Q.P(e,t,n))}},{key:"notify",value:function(e,t){this.notification.show(e,t),this.sendEvent(new q.c(e,t))}},{key:"notifyLocal",value:function(e,t){this.notification.show(e,t)}},{key:"advance",value:function(e){null==(t=this.frame)||t.call(this,e);for(var t,n=Math.floor(e/this.step),r=n*this.step,o=this.table.allStationary(),s=0;s<n;s++)this.table.advance(this.step);this.table.updateBallMesh(r),this.view.update(r,this.table.cue.aim),this.table.cue.update(r),!o&&this.table.allStationary()&&this.eventQueue.push(new i.T),this.sound.processOutcomes(this.table.outcome)}},{key:"processEvents",value:function(){var e=this;for(this.keyboard&&this.keyboard.getEvents().forEach(function(t){return e.inputQueue.push(t)});this.inputQueue.length>0;){this.lastEventTime=this.last;var t=this.inputQueue.shift();t&&this.updateController(this.controller.handleInput(t))}if(this.table.allStationary()){var n=this.eventQueue.shift();n&&(this.lastEventTime=performance.now(),this.recorder.record(n),this.updateController(n.applyToController(this.controller)))}}},{key:"animate",value:function(e){var t=this;this.advance((e-this.last)/1e3),this.last=e,this.processEvents(),(e<this.lastEventTime+12e3||!this.table.allStationary()||this.view.sizeChanged())&&this.view.render(),requestAnimationFrame(function(e){t.animate(e)})}},{key:"updateController",value:function(e){if(e!==this.controller){var t=r.N.hasInstance()?r.N.getInstance().playername:"_";this.log("".concat(t,": Transition to ").concat(e.name)),this.controller=e,this.controller.onFirst()}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/controller/aim.ts"(e,t,n){n.d(t,{m:()=>d});var r=n("./src/controller/controller.ts"),i=n("./src/controller/controllerbase.ts");function o(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){var t,r,i;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return r=n,i=[e],r=s(r),(t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(r,i||[],s(this).constructor):r.apply(this,i))).hit(),t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&a(n,e),t=[{key:"handleStationary",value:function(e){var t,n=this.container.table,r=n.outcome,i=this.container.rules.update(r),s=function(e){if(Array.isArray(e))return e}(t=this.container.rules.getScores())||function(e){var t,n,r=null==e?null:"u">typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var i=[],o=!0,s=!1;try{for(r=r.call(e);!(o=(t=r.next()).done)&&(i.push(t.value),2!==i.length);o=!0);}catch(e){s=!0,n=e}finally{try{o||null==r.return||r.return()}finally{if(s)throw n}}return i}}(t)||function(e){if(e){if("string"==typeof e)return o(e,2);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return o(e,2)}}(t)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(),a=s[0],l=s[1],c=this.container.rules.currentBreak;this.container.sendScoreUpdate(a,l,c);var u=this.container.rules.isPartOfBreak(r),h=this.container.rules.isEndOfGame(r);return this.container.recorder.updateBreak(r,u,h),n.cue.aimAtNext(n.cueball,this.container.rules.nextCandidateBall()),i}},{key:"handleInput",value:function(e){return this.commonKeyHandler(e),this}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(i.y),u=n("./src/controller/replay.ts");function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function p(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(p=function(){return!!e})()}var d=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");t=n,r=[e],t=h(t);var t,r,i,o=(i=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,p()?Reflect.construct(t,r||[],h(this).constructor):t.apply(this,r))).container.table;return o.cue.aimMode(),o.cue.showHelper(!0),o.cueball=i.container.rules.cueball,o.cue.aim.i=o.balls.indexOf(o.cueball),o.cue.moveTo(o.cueball.pos),o.cue.aimAtNext(o.cueball,i.container.rules.nextCandidateBall()),i.container.view.camera.suggestMode(i.container.view.camera.aimView),o.cue.aimInputs.showOverlap(),i}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&f(n,e),t=[{key:"onFirst",value:function(){this.container.table.cue.aimInputs.setDisabled(!1)}},{key:"handleInput",value:function(e){switch(e.key){case"Space":this.container.table.cue.adjustPower(e.t*this.scale*.7);break;case"SpaceUp":return this.playShot();default:if(!this.commonKeyHandler(e))return this}return this.container.sendEvent(this.container.table.cue.aim),this}},{key:"handleBreak",value:function(e){return new u.e(this.container,e.init,e.shots,e.retry)}},{key:"playShot",value:function(){var e=new r.Qe(this.container.table.serialise());return this.container.sendEvent(e),new c(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(i.y)},"./src/controller/controller.ts"(e,t,n){n.d(t,{Qe:()=>i.Q,pd:()=>o.p,wG:()=>r.w,xI:()=>s}),n("./src/events/beginevent.ts");var r=n("./src/events/aimevent.ts"),i=n("./src/events/hitevent.ts"),o=n("./src/events/input.ts");n("./src/events/abortevent.ts"),n("./src/events/stationaryevent.ts");var s=function(){var e;function t(e){var n,r;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");r=void 0,(n="container")in this?Object.defineProperty(this,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):this[n]=r,this.container=e}return e=[{key:"name",get:function(){return this.constructor.name}},{key:"handleInput",value:function(e){return this}},{key:"handleBegin",value:function(e){return this}},{key:"handleBreak",value:function(e){return this}},{key:"handleStartAim",value:function(e){return this}},{key:"handleAim",value:function(e){return this}},{key:"handleHit",value:function(e){return this}},{key:"handleAbort",value:function(e){return this}},{key:"handleWatch",value:function(e){return this}},{key:"handlePlaceBall",value:function(e){return this}},{key:"handleStationary",value:function(e){return this}},{key:"handleChat",value:function(e){return this}},{key:"handleRejoin",value:function(e){return this}},{key:"handleNotification",value:function(e){return this}},{key:"handleScore",value:function(e){return this}},{key:"onFirst",value:function(){}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/controller/controllerbase.ts"(e,t,n){n.d(t,{y:()=>h});var r=n("./src/controller/controller.ts"),i=n("./src/utils/gltf.ts"),o=n("./src/model/outcome.ts"),s=n("./node_modules/three/build/three.core.js");function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(e){return e&&"u">typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(u=function(){return!!e})()}var h=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t,r,i,o;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return t=n,r=arguments,t=a(t),(o="scale")in(i=e=function(e,t){if(t&&("object"===c(t)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,u()?Reflect.construct(t,r||[],a(this).constructor):t.apply(this,r)))?Object.defineProperty(i,o,{value:.001,enumerable:!0,configurable:!0,writable:!0}):i[o]=.001,e}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&l(n,e),t=[{key:"handleChat",value:function(e){var t=e.sender?"".concat(e.sender,":"):"",n="".concat(t," ").concat(e.message);return this.container.chat.showMessage(n),this}},{key:"handleNotification",value:function(e){return this.container.notification.show(e.data,e.duration),this}},{key:"handleScore",value:function(e){return this.container.updateScoreHud(e.p1,e.p2,e.b),this}},{key:"hit",value:function(){this.container.table.outcome=[o.P.hit(this.container.table.cueball,this.container.table.cue.aim.power)],this.container.table.hit(),this.container.view.camera.suggestMode(this.container.view.camera.aimView),this.container.table.cue.showHelper(!1)}},{key:"commonKeyHandler",value:function(e){var t=this.container.table.cue,n=e.t*this.scale;switch(e.key){case"ArrowLeft":return t.rotateAim(-n,this.container.table),!0;case"ArrowRight":return t.rotateAim(n,this.container.table),!0;case"ArrowDown":return t.adjustSpin(new s.Pq0(0,-n),this.container.table),!0;case"ArrowUp":return t.adjustSpin(new s.Pq0(0,n),this.container.table),!0;case"ShiftArrowLeft":return t.adjustSpin(new s.Pq0(n,0),this.container.table),!0;case"ShiftArrowRight":return t.adjustSpin(new s.Pq0(-n,0),this.container.table),!0;case"KeyPUp":return(0,i.KP)(this.container.view.scene),!0;case"KeyHUp":return t.toggleHelper(),!0;case"movementXUp":return t.rotateAim(2*n,this.container.table),!0;case"movementYUp":case"NumpadSubtract":return this.container.view.camera.adjustHeight(8*n),!0;case"NumpadAdd":return this.container.view.camera.adjustHeight(-(8*n)),!0;case"KeyOUp":return this.container.view.camera.toggleMode(),!0;case"KeyDUp":return this.togglePanel(),!0;case"KeyFUp":return this.toggleFullscreen(),!0;default:return!1}}},{key:"togglePanel",value:function(){this.container.sliders.toggleVisibility(),this.container.table.showSpin(!0),this.container.table.showTraces(!0),("u"<typeof process?"undefined":c(process))!=="object"&&console.log(this.container.table.serialise())}},{key:"toggleFullscreen",value:function(){document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen()}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.xI)},"./src/controller/end.ts"(e,t,n){n.d(t,{o:()=>c});var r=n("./src/controller/controller.ts"),i=n("./src/controller/init.ts"),o=n("./src/utils/replay-encoder.ts");function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e,t){var r,i,o,a,c;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return i=n,o=[e],i=s(i),r=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(i,o||[],s(this).constructor):i.apply(this,o)),c=void 0,(a="result")in r?Object.defineProperty(r,a,{value:c,enumerable:!0,configurable:!0,writable:!0}):r[a]=c,r.result=t,r}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&a(n,e),t=[{key:"onFirst",value:function(){if(this.result&&this.container.scoreReporter){try{var e=this.container.recorder.wholeGame(),t=JSON.stringify(e);this.result.replayData=o.k.crush(t)}catch(e){console.error("Failed to encode replay data",e)}this.container.scoreReporter.submitMatchResult(this.result)}}},{key:"handleChat",value:function(e){var t=e.sender?"".concat(e.sender,":"):"",n="".concat(t," ").concat(e.message);return this.container.chat.showMessage(n),this}},{key:"handleBegin",value:function(e){return new i.J(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.xI)},"./src/controller/init.ts"(e,t,n){n.d(t,{J:()=>k});var r=n("./src/events/watchevent.ts"),i=n("./src/controller/watchaim.ts"),o=n("./src/controller/controllerbase.ts"),s=n("./src/controller/placeball.ts"),a=n("./src/controller/replay.ts"),l=n("./src/network/client/session.ts"),c=n("./src/controller/controller.ts"),u=n("./src/events/eventutil.ts");function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function f(e){return(f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(e,t){return null!=t&&"u">typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function v(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(v=function(){return!!e})()}var y=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e,t,r){var i,o,s;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return o=n,s=[e],o=f(o),h(i=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,v()?Reflect.construct(o,s||[],f(this).constructor):o.apply(this,s)),"messageRelay",void 0),h(i,"tableId",void 0),h(i,"messages",[]),i.messageRelay=t,i.tableId=r,i.messageRelay.subscribe(i.tableId,function(e){console.log(e);var t=u.d.fromSerialised(e);i.messages.push(t),(p(t,c.Qe)||p(t,c.wG))&&i.container.eventQueue.push(t)}),console.log("Spectate"),i}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&d(n,e),t=[{key:"handleAim",value:function(e){return this.container.table.cue.aim=e,this.container.table.cueball.pos.copy(e.pos),this}},{key:"handleHit",value:function(e){return console.log("Spectate Hit"),this.container.table.updateFromSerialised(e.tablejson),this.container.table.outcome=[],this.container.table.hit(),this}},{key:"handleInput",value:function(e){return this.commonKeyHandler(e),this}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(o.y),m=n("./src/network/client/nchanmessagerelay.ts");function b(e){return(b=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function g(e,t){return(g=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function w(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(w=function(){return!!e})()}var k=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return e=n,t=arguments,e=b(e),function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,w()?Reflect.construct(e,t||[],b(this).constructor):e.apply(this,t))}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&g(n,e),t=[{key:"handleBegin",value:function(e){if(l.N.isSpectator()){var t;return new y(this.container,null!=(t=this.container.relay)?t:new m.p,l.N.getInstance().tableId)}return this.container.chat.showMessage("Start"),this.container.sendEvent(new r.Q(this.container.table.serialise())),new s.x(this.container)}},{key:"handleWatch",value:function(e){return this.container.chat.showMessage("Opponent to break"),this.container.rules.secondToPlay(),this.container.table.updateFromSerialised(e.json),l.N.hasInstance()&&(l.N.getInstance().playerIndex=1),new i.r(this.container)}},{key:"handleBreak",value:function(e){return e.init?(this.container.table.updateFromShortSerialised(e.init),this.container.chat.showMessage("Replay"),new a.e(this.container,e.init,e.shots)):new s.x(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(o.y)},"./src/controller/placeball.ts"(e,t,n){n.d(t,{x:()=>d});var r=n("./src/controller/controllerbase.ts"),i=n("./src/controller/controller.ts"),o=n("./src/controller/aim.ts"),s=n("./src/events/breakevent.ts"),a=n("./src/model/physics/constants.ts"),l=n("./node_modules/three/build/three.core.js"),c=n("./src/view/cuemesh.ts");function u(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function p(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(p=function(){return!!e})()}var d=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e,t){var r,i,o;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return i=n,o=[e],i=h(i),u(r=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,p()?Reflect.construct(i,o||[],h(this).constructor):i.apply(this,o)),"placescale",.02*a.R),u(r,"startPos",void 0),r.startPos=t,r.container.table.cue.moveTo(r.container.table.cueball.pos),r.container.table.cue.aim.power=0,r.container.view.camera.forceMode(r.container.view.camera.aimView),r}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&f(n,e),t=[{key:"onFirst",value:function(){var e=this.container.table.cueball;this.container.rules.allowsPlaceBall()&&(this.startPos?e.pos.copy(this.container.rules.placeBall(this.startPos.clone())):e.pos.copy(this.container.rules.placeBall())),e.setStationary(),e.updateMesh(0),this.container.table.cue.placeBallMode(),this.container.table.cue.showHelper(!1),this.container.table.cue.moveTo(this.container.table.cueball.pos),this.container.table.cue.aimInputs.setButtonText(`Place
 Ball`),this.container.table.cue.aimInputs.setDisabled(!1),this.container.rules.allowsPlaceBall()||this.container.inputQueue.push(new i.pd(1,"SpaceUp"))}},{key:"handleInput",value:function(e){var t=this.container.table.cueball.pos;switch(e.key){case"ArrowLeft":case"KeyI":this.moveTo(0,e.t*this.placescale);break;case"ArrowRight":case"KeyK":this.moveTo(0,-e.t*this.placescale);break;case"movementXUp":this.moveTo(0,-e.t*this.placescale*2);break;case"movementYUp":this.moveTo(-e.t*this.placescale*2,0);break;case"KeyJ":this.moveTo(-e.t*this.placescale,0);break;case"KeyL":this.moveTo(e.t*this.placescale,0);break;case"SpaceUp":return this.placed();default:this.commonKeyHandler(e)}return this.container.table.cue.moveTo(t),this.container.view.camera.forceMove(this.container.table.cue.aim),this.container.sendEvent(this.container.table.cue.aim),this}},{key:"moveTo",value:function(e,t){var n=new l.Pq0(e,t),r=this.container.table.cueball.pos.add(n);r.copy(this.container.rules.placeBall(r)),c.l.indicateValid(!this.container.table.overlapsAny(r))}},{key:"placed",value:function(){return this.container.table.overlapsAny(this.container.table.cueball.pos)?this:(this.container.table.cue.aimInputs.setButtonText("Hit"),this.container.sound.playNotify(),this.container.sendEvent(new s.W(this.container.table.shortSerialise())),new o.m(this.container))}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.y)},"./src/controller/replay.ts"(e,t,n){n.d(t,{e:()=>k});var r=n("./src/events/hitevent.ts"),i=n("./src/controller/controllerbase.ts"),o=n("./src/events/aimevent.ts"),s=n("./src/events/breakevent.ts"),a=n("./src/controller/aim.ts"),l=n("./src/events/eventtype.ts"),c=n("./src/events/rerackevent.ts"),u=n("./src/events/placeballevent.ts"),h=n("./src/controller/end.ts"),f=n("./src/events/scoreevent.ts"),p=n("./src/events/chatevent.ts"),d=n("./src/utils/gameover.ts");function v(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function m(e){return(m=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function b(e,t){return(b=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function g(e){return function(e){if(Array.isArray(e))return v(e)}(e)||function(e){if("u">typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e){if(e){if("string"==typeof e)return v(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return v(e,void 0)}}(e)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function w(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(w=function(){return!!e})()}var k=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e,t,r){var i,o,a,l=arguments.length>3&&void 0!==arguments[3]&&arguments[3],c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1500;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");if(i=n,o=[e],i=m(i),y(a=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,w()?Reflect.construct(i,o||[],m(this).constructor):i.apply(this,o)),"delay",void 0),y(a,"shots",void 0),y(a,"firstShot",void 0),y(a,"timer",void 0),y(a,"init",void 0),a.init=t,a.shots=g(r),a.firstShot=a.shots[0],a.delay=c,a.container.table.showTraces(!0),a.container.table.updateFromShortSerialised(a.init),console.log(a.shots),l){var u=new s.W(t,r);u.retry=!0,a.container.eventQueue.push(u)}else a.container.view.camera.forceMode(a.container.view.camera.topView),a.playNextShot(1.5*a.delay);return a}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&b(n,e),t=[{key:"onFirst",value:function(){var e=this;this.container.table.cue.aimInputs.setDisabled(!0);var t=this.container.menu.share;t&&(t.disabled=!1,t.onclick=function(){!function(e,t){var n;if(("u"<typeof process?"undefined":(n=process)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)=="object")return t(e);fetch("https://scoreboard-tailuge.vercel.app/api/shorten",{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({input:new URL(e.replaceAll("(","%28").replaceAll(")","%29").replaceAll("!","%21").replaceAll("*","%2A")).search})}).then(function(e){return e.json()}).then(function(n){"shortUrl"in n?t(n.shortUrl):(console.log("Could not shorten url:"),console.log(n),t(e))})}(window.location.href,function(t){var n,r,i,o,s=(o={title:"Billiards",text:"Replay break",url:t},(null==(n=(r=navigator).canShare)?void 0:n.call(r,o))?(navigator.share(o).then(function(){return console.log("shared successfully")}).catch(function(e){console.log("Error: "+e)}),"link shared"):(null==(i=navigator.clipboard)||i.writeText(t),'link copied to clipboard <a href="'.concat(t,'">').concat(t,"</a>")));e.container.eventQueue.push(new p.b(null,s))})})}},{key:"playNextShot",value:function(e){var t=this,n=this.shots.shift();if((null==n?void 0:n.type)===l.B.RERACK){var i=c.x.fromJson(n.ballinfo);c.x.applyBallinfoToTable(this.container.table,i.ballinfo),this.shots.length>0&&this.playNextShot(e);return}if((null==n?void 0:n.type)===l.B.PLACEBALL){var s=u.z.fromJson(n);if(this.container.table.cueball.pos.copy(s.pos),this.container.table.cueball.setStationary(),s.respot){var a=this.container.table.balls[s.respot.id];a&&(a.pos.copy(s.respot.pos),a.setStationary())}this.shots.length>0&&this.playNextShot(e);return}if((null==n?void 0:n.type)===l.B.SCORE){f.P.fromJson(n).applyToController(this),this.shots.length>0&&this.playNextShot(e);return}var h=o.w.fromJson(n);this.container.table.cueball=this.container.table.balls[h.i],console.log(this.container.table.cueball.pos.distanceTo(h.pos)),this.container.table.cueball.pos.copy(h.pos),this.container.table.cue.aim=h,this.container.table.cue.updateAimInput(),this.container.table.cue.t=1,clearTimeout(this.timer),this.timer=setTimeout(function(){t.container.eventQueue.push(new r.Q(t.container.table.cue.aim)),t.timer=void 0},e)}},{key:"handleHit",value:function(e){return this.hit(),this}},{key:"handleStationary",value:function(e){return(this.shots.length>0&&void 0===this.timer&&this.playNextShot(this.delay),0===this.shots.length&&void 0===this.timer)?(this.container.notifyLocal({type:"GameOver",title:"Replay Complete",extra:d.c.replay+d.c.lobby},0),new h.o(this.container)):this}},{key:"handleInput",value:function(e){return this.commonKeyHandler(e),this}},{key:"handleBreak",value:function(e){return(this.container.table.updateFromShortSerialised(e.init),this.shots=g(e.shots),this.container.table.showSpin(!0),e.retry)?this.retry():(this.playNextShot(this.delay),this)}},{key:"handleAbort",value:function(e){return console.log("Replay aborted"),clearTimeout(this.timer),this.timer=void 0,new h.o(this.container)}},{key:"retry",value:function(){clearTimeout(this.timer),this.timer=void 0,this.container.table.updateFromShortSerialised(this.init);var e=o.w.fromJson(this.firstShot);return this.container.table.cueball=this.container.table.balls[e.i],this.container.rules.cueball=this.container.table.cueball,this.container.table.cueball.pos.copy(e.pos),this.container.table.cue.aim=e,this.container.view.camera.forceMode(this.container.view.camera.aimView),new a.m(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(i.y)},"./src/controller/rules/rulefactory.ts"(e,t,n){n.d(t,{V:()=>B});var r=n("./src/events/rerackevent.ts"),i=n("./src/model/outcome.ts"),o=n("./src/utils/rack.ts"),s=n("./node_modules/three/build/three.core.js"),a=n("./src/controller/aim.ts"),l=n("./src/controller/placeball.ts"),c=n("./src/controller/watchaim.ts"),u=n("./src/events/placeballevent.ts"),h=n("./src/events/watchevent.ts"),f=n("./src/model/table.ts"),p=n("./src/model/physics/constants.ts"),d=n("./src/utils/respot.ts"),v=n("./src/view/tablegeometry.ts"),y=n("./src/events/startaimevent.ts"),m=n("./src/network/client/matchresult.ts"),b=n("./src/network/client/session.ts");function g(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function w(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function k(e){return function(e){if(Array.isArray(e))return g(e)}(e)||function(e){if("u">typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e){if(e){if("string"==typeof e)return g(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return g(e,void 0)}}(e)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var x=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");w(this,"container",void 0),w(this,"cueball",void 0),w(this,"currentBreak",0),w(this,"previousBreak",0),w(this,"rulename","nineball"),this.container=e}return e=[{key:"getScores",value:function(){return this.container.scores}},{key:"startTurn",value:function(){this.previousBreak=this.currentBreak,this.currentBreak=0}},{key:"nextCandidateBall",value:function(){var e=this;return this.container.table.balls.filter(function(t){return t!==e.cueball&&t.onTable()}).sort(function(e,t){return(e.label||0)-(t.label||0)})[0]}},{key:"placeBall",value:function(e){if(e){var t=new s.Pq0(v.P.tableX,v.P.tableY),n=new s.Pq0(-v.P.tableX,-v.P.tableY);return e.clamp(n,t)}return new s.Pq0(-(11*p.R)/.5,0,0)}},{key:"asset",value:function(){return"models/p8.min.gltf"}},{key:"tableGeometry",value:function(){v.P.hasPockets=!0}},{key:"table",value:function(){var e=new f.X(this.rack());return this.cueball=e.cueball,e}},{key:"rack",value:function(){return o.m.diamond()}},{key:"update",value:function(e){var t=this.foulReason(e);return t?this.handleFoul(e,t):i.P.potCount(e)>0?this.handlePot(e):this.handleMiss()}},{key:"handleFoul",value:function(e,t){this.container.notify({type:"Foul",title:"FOUL",subtext:t,extra:"Ball in hand"}),this.startTurn();var n=i.P.pots(e).includes(this.container.table.balls[9]),o=this.container.table.cueball;if(n){this.respotNineBall();var s=this.container.table.balls[9];if(s){var a=r.x.fromJson({balls:[s.serialise()]});console.log("Respot nine ball sending rerack event",a),this.container.sendEvent(a)}}var h=o.onTable()?o.pos.clone():this.placeBall(),f=new u.z(h,void 0,!0);return(this.container.sendEvent(f),this.container.isSinglePlayer)?new l.x(this.container,h):new c.r(this.container)}},{key:"handlePot",value:function(e){var t=this.container.table,n=i.P.potCount(e);return(this.currentBreak+=n,this.container.scores[b.N.playerIndex()]+=n,this.container.sound.playSuccess(t.inPockets()),this.isEndOfGame(e))?this.handleGameEnd(!0):(this.container.sendEvent(new h.Q(t.serialise())),new a.m(this.container))}},{key:"handleGameEnd",value:function(e){return m.n.presentGameEnd(this.container,this.rulename)}},{key:"handleMiss",value:function(){var e=this.container.table;return(this.container.sendEvent(new y.M),this.container.isSinglePlayer)?(this.container.sendEvent(new h.Q(e.serialise())),this.startTurn(),new a.m(this.container)):new c.r(this.container)}},{key:"isPartOfBreak",value:function(e){return i.P.isBallPottedNoFoul(this.container.table.cueball,e)}},{key:"isEndOfGame",value:function(e){return!this.isFoul(e)&&i.P.pots(e).includes(this.container.table.balls[9])}},{key:"otherPlayersCueBall",value:function(){return this.cueball}},{key:"secondToPlay",value:function(){}},{key:"allowsPlaceBall",value:function(){return!0}},{key:"isFoul",value:function(e){return null!==this.foulReason(e)}},{key:"foulReason",value:function(e){var t=this.container.table.cueball;if(i.P.isCueBallPotted(t,e))return"Cue ball potted";var n=this.getLowestBallAtStartOfShot(e),r=i.P.firstCollision(i.P.cueBallFirst(t,e));if(!r)return"No ball hit";if(r.ballB!==n)return"Wrong ball hit first";if(0===i.P.potCount(e)){var o=e.indexOf(r);if(!e.slice(o+1).some(function(e){return e.type===i.$.Cushion}))return"No cushion after contact"}return null}},{key:"getLowestBallAtStartOfShot",value:function(e){var t=this,n=i.P.pots(e),r=this.container.table.balls.filter(function(e){return e!==t.cueball&&e.onTable()});return k(n).concat(k(r)).sort(function(e,t){return(e.label||0)-(t.label||0)})[0]}},{key:"respotNineBall",value:function(){d.k.nineBall(this.container.table)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function T(e,t,n){return(T="u">typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=P(e)););return e}(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(n||e):i.value}})(e,t,n||e)}function P(e){return(P=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function S(e,t){return(S=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function R(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(R=function(){return!!e})()}var O=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){var t,r,i;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return r=n,i=[e],r=P(r),(t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,R()?Reflect.construct(r,i||[],P(this).constructor):r.apply(this,i))).rulename="fourteenone",t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&S(n,e),t=[{key:"asset",value:function(){return"models/p8.min.gltf"}},{key:"rack",value:function(){return o.m.triangle()}},{key:"update",value:function(e){var t=this.container.table;return this.checkRerack(t),T(P(n.prototype),"update",this).call(this,e)}},{key:"isFoul",value:function(e){return i.P.isCueBallPotted(this.container.table.cueball,e)}},{key:"checkRerack",value:function(e){var t=e.balls.filter(function(e){return e.onTable()}).filter(function(t){return t!==e.cueball});if(1===t.length){o.m.rerack(t[0],e),this.container.sound.playSuccess(e.inPockets());var n=e.serialise(),i=r.x.fromJson(n);this.container.sendEvent(i),this.container.recorder.wholeGameLink()}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(x),E=n("./src/controller/rules/snooker.ts"),A=n("./src/view/cameratop.ts"),M=n("./src/utils/utils.ts"),_=n("./src/utils/threecushionconfig.ts");function I(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function C(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var j=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");C(this,"container",void 0),C(this,"cueball",void 0),C(this,"currentBreak",0),C(this,"previousBreak",0),C(this,"rulename","threecushion"),this.container=e}return e=[{key:"getScores",value:function(){return this.container.scores}},{key:"startTurn",value:function(){}},{key:"nextCandidateBall",value:function(){if(!(0,M.hs)(this.container.recorder))return d.k.closest(this.container.table.cueball,this.container.table.balls)}},{key:"placeBall",value:function(e){return M.v_}},{key:"asset",value:function(){return"models/threecushion.min.gltf"}},{key:"secondToPlay",value:function(){this.cueball=this.container.table.balls[1]}},{key:"tableGeometry",value:function(){v.P.tableX=49*p.R,v.P.tableY=24*p.R,v.P.X=v.P.tableX+p.R,v.P.Y=v.P.tableY+p.R,v.P.hasPockets=!1}},{key:"table",value:function(){this.tableGeometry(),A.v.zoomFactor=.92;var e=new f.X(this.rack());return this.cueball=e.cueball,e}},{key:"rack",value:function(){return o.m.three()}},{key:"update",value:function(e){return i.P.isThreeCushionPoint(this.cueball,e)?(this.container.sound.playSuccess(e.length/3),this.container.sendEvent(new h.Q(this.container.table.serialise())),this.currentBreak++,this.container.scores[b.N.playerIndex()]++,this.isEndOfGame(e))?this.handleGameEnd(!0):new a.m(this.container):(this.previousBreak=this.currentBreak,this.currentBreak=0,this.container.isSinglePlayer)?(this.cueball=this.otherPlayersCueBall(),this.container.table.cue.aim.i=this.container.table.balls.indexOf(this.cueball),new a.m(this.container)):(this.container.sendEvent(new y.M),new c.r(this.container))}},{key:"otherPlayersCueBall",value:function(){var e=this.container.table.balls;return this.cueball===e[0]?e[1]:e[0]}},{key:"isPartOfBreak",value:function(e){return i.P.isThreeCushionPoint(this.cueball,e)}},{key:"isEndOfGame",value:function(e){var t,n=function(e){if(Array.isArray(e))return e}(t=this.container.scores)||function(e){var t,n,r=null==e?null:"u">typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var i=[],o=!0,s=!1;try{for(r=r.call(e);!(o=(t=r.next()).done)&&(i.push(t.value),2!==i.length);o=!0);}catch(e){s=!0,n=e}finally{try{o||null==r.return||r.return()}finally{if(s)throw n}}return i}}(t)||function(e){if(e){if("string"==typeof e)return I(e,2);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return I(e,2)}}(t)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(),r=n[0],i=n[1];return r>=_.Y.raceTo||i>=_.Y.raceTo}},{key:"handleGameEnd",value:function(e){return m.n.presentGameEnd(this.container,this.rulename)}},{key:"allowsPlaceBall",value:function(){return!1}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),B=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"create",value:function(e,t){switch(e){case"threecushion":return new j(t);case"fourteenone":return new O(t);case"snooker":return new E.c(t);default:return new x(t)}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/controller/rules/snooker.ts"(e,t,n){n.d(t,{c:()=>T});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/events/watchevent.ts"),o=n("./src/model/outcome.ts"),s=n("./src/utils/rack.ts"),a=n("./src/utils/respot.ts"),l=n("./src/controller/aim.ts"),c=n("./src/controller/watchaim.ts"),u=n("./src/model/table.ts"),h=n("./src/view/tablegeometry.ts"),f=n("./src/controller/placeball.ts"),p=n("./src/events/placeballevent.ts"),d=n("./src/utils/utils.ts");function v(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}var y=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"shotInfo",value:function(e,n,r,i){var s=o.P.firstCollision(n);return{pots:o.P.potCount(n),firstCollision:s,legalFirstCollision:t.isLegalFirstCollision(e,r,i,s),whitePotted:o.P.isCueBallPotted(e.cueball,n),targetIsRed:r}}},{key:"isLegalFirstCollision",value:function(e,n,r,i){if(!i)return!1;var o=i.ballB.id;if(n)return o>=7;if(r)return o>=1&&o<=6;var s=t.coloursOnTable(e).sort(function(e,t){return e.id-t.id});return 0!==s.length&&o===s[0].id}},{key:"calculateFoul",value:function(e,n){return{points:t.foulPoints(e,n),reason:t.foulReason(e,n)}}},{key:"foulPoints",value:function(e,t){var n,r,i,s,a=o.P.pots(e).map(function(e){return e.id}).filter(function(e){return e<7}),l=null!=(r=null==(s=t.firstCollision)||null==(i=s.ballB)?void 0:i.id)?r:0;return l>6&&(l=0),(n=Math).max.apply(n,[3,l].concat(function(e){if(Array.isArray(e))return v(e)}(a)||function(e){if("u">typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(a)||function(e){if(e){if("string"==typeof e)return v(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return v(e,void 0)}}(a)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()))+1}},{key:"foulReason",value:function(e,n){if(n.whitePotted)return"White potted";if(!n.firstCollision)return"No ball hit";var r=null!=(l=null==(c=n.firstCollision.ballB)?void 0:c.id)?l:0;if(n.targetIsRed){if(r<7||0===r){var i=t.colourName(r);return"Hit ".concat(i," instead of red")}}else if(r>=7)return"Hit red instead of colour";var s=o.P.pots(e).filter(function(e){return e.id>0&&e.id<7});if(s.length>1){var a=s.map(function(e){return t.colourName(e.id)}).join(", ");return"Potted ".concat(a)}if(1===s.length){var l,c,u,h,f,p=s[0].id,d=null!=(u=null==(f=n.firstCollision)||null==(h=f.ballB)?void 0:h.id)?u:0;if(p!==d){var v=t.colourName(p),y=t.colourName(d);return"Potted ".concat(v," instead of ").concat(y)}}return null}},{key:"respotAllPottedColours",value:function(e,t){return o.P.pots(t).filter(function(e){return e.id<7}).filter(function(e){return 0!==e.id}).map(function(t){return a.k.respot(t,e)})}},{key:"redsOnTable",value:function(e){return e.balls.slice(7).filter(function(e){return e.onTable()})}},{key:"coloursOnTable",value:function(e){return e.balls.slice(1,7).filter(function(e){return e.onTable()})}},{key:"colourName",value:function(e){return({1:"Yellow",2:"Green",3:"Brown",4:"Blue",5:"Pink",6:"Black"})[e]||"Ball ".concat(e)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}(),m=n("./src/network/client/matchresult.ts"),b=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"presentGameEnd",value:function(e,t){return m.n.presentGameEnd(e,t)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}(),g=n("./src/events/startaimevent.ts"),w=n("./src/network/client/session.ts"),k=n("./src/events/rerackevent.ts");function x(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var T=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");x(this,"cueball",void 0),x(this,"previousPotRed",!1),x(this,"targetIsRed",!0),x(this,"currentBreak",0),x(this,"previousBreak",0),x(this,"foulPoints",0),x(this,"rulename","snooker"),x(this,"container",void 0),this.container=e}return e=[{key:"snookerrule",value:function(e){this.foulPoints=0;var t=y.shotInfo(this.container.table,e,this.targetIsRed,this.previousPotRed);return 0===t.pots?(this.targetIsRed=y.redsOnTable(this.container.table).length>0,t.legalFirstCollision)?this.switchPlayer():this.foul(e,t):this.targetIsRed?this.targetRedRule(e,t):this.targetColourRule(e,t)}},{key:"targetRedRule",value:function(e,t){return t.legalFirstCollision&&o.P.onlyRedsPotted(e)?(this.currentBreak+=t.pots,this.container.scores[w.N.playerIndex()]+=t.pots,this.targetIsRed=!1,this.previousPotRed=!0,this.continueBreak()):this.foul(e,t)}},{key:"targetColourRule",value:function(e,t){if(t.whitePotted)return this.foul(e,t);if(t.pots>1)return this.respot(e),this.foul(e,t);if(o.P.pots(e)[0].id>6)return this.foul(e,t);var n=o.P.pots(e)[0].id;return n!==t.firstCollision.ballB.id?this.foul(e,t):this.previousPotRed?(this.respot(e),this.currentBreak+=n+1,this.container.scores[w.N.playerIndex()]+=n+1,this.previousPotRed=!1,this.targetIsRed=y.redsOnTable(this.container.table).length>0,this.continueBreak()):y.coloursOnTable(this.container.table).filter(function(e){return e.id<n}).length>0?this.foul(e,t):(this.currentBreak+=n+1,this.container.scores[w.N.playerIndex()]+=n+1,this.previousPotRed=!1,this.targetIsRed=y.redsOnTable(this.container.table).length>0,this.continueBreak())}},{key:"foul",value:function(e,t){var n=y.calculateFoul(e,t);this.foulPoints=n.points;var r=w.N.playerIndex();this.container.scores[1-r]+=this.foulPoints;var i=t.whitePotted?{type:"Foul",title:"FOUL",subtext:n.reason||"Foul (".concat(this.foulPoints," points)"),extra:"Ball in hand"}:{type:"Foul",title:"FOUL",subtext:n.reason||"Foul (".concat(this.foulPoints," points)")};return(this.container.notify(i),this.respot(e),t.whitePotted)?this.whiteInHand():this.switchPlayer()}},{key:"tableGeometry",value:function(){h.P.hasPockets=!0}},{key:"table",value:function(){var e=new u.X(this.rack());return this.cueball=e.cueball,e}},{key:"otherPlayersCueBall",value:function(){return this.cueball}},{key:"secondToPlay",value:function(){}},{key:"isPartOfBreak",value:function(e){return this.currentBreak>0}},{key:"isEndOfGame",value:function(e){return o.P.isClearTable(this.container.table)&&this.currentBreak>0}},{key:"allowsPlaceBall",value:function(){return!0}},{key:"asset",value:function(){return t.tablemodel}},{key:"startTurn",value:function(){this.previousPotRed=!1,this.targetIsRed=y.redsOnTable(this.container.table).length>0,this.previousBreak=this.currentBreak,this.currentBreak=0}},{key:"getScores",value:function(){return this.container.scores}},{key:"rack",value:function(){return s.m.snooker()}},{key:"nextCandidateBall",value:function(){if((0,d.hs)(this.container.recorder))return void console.log("first shot");var e=this.container.table,t=y.redsOnTable(e),n=y.coloursOnTable(e);return this.previousPotRed?a.k.closest(e.cueball,n):t.length>0?a.k.closest(e.cueball,t):n.length>0?n[0]:void 0}},{key:"placeBall",value:function(e){if(e){var t=new r.Pq0(s.m.baulk,0,0),n=s.m.sixth,i=e.distanceTo(t);if(e.x>=s.m.baulk&&(e.x=s.m.baulk),!(i>n))return e;var o=e.clone().sub(t).normalize();return t.add(o.multiplyScalar(n))}return new r.Pq0(s.m.baulk,-s.m.sixth/2.6,0)}},{key:"switchPlayer",value:function(){var e=this.container.table;return(this.container.sendEvent(new g.M(this.foulPoints)),this.container.isSinglePlayer)?(this.container.sendEvent(new i.Q(e.serialise())),this.startTurn(),new l.m(this.container)):(this.startTurn(),new c.r(this.container))}},{key:"continueBreak",value:function(){var e=this.container.table;return(this.container.sound.playSuccess(e.inPockets()),o.P.isClearTable(e))?this.handleGameEnd(!0):(this.container.sendEvent(new i.Q(e.serialise())),new l.m(this.container))}},{key:"handleGameEnd",value:function(e){return b.presentGameEnd(this.container,this.rulename)}},{key:"whiteInHand",value:function(){return(this.startTurn(),this.container.isSinglePlayer)?new f.x(this.container):(this.container.sendEvent(new p.z(d.v_)),new c.r(this.container))}},{key:"update",value:function(e){return this.snookerrule(e)}},{key:"respot",value:function(e){var t=y.respotAllPottedColours(this.container.table,e);if(t.length>0){var n=k.x.fromJson({balls:t.map(function(e){return e.serialise()})});this.container.sendEvent(n)}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();x(T,"tablemodel","models/d-snooker.min.gltf")},"./src/controller/watchaim.ts"(e,t,n){n.d(t,{r:()=>d});var r=n("./src/controller/aim.ts"),i=n("./src/controller/controllerbase.ts"),o=n("./src/controller/placeball.ts"),s=n("./src/events/rerackevent.ts");function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(c=function(){return!!e})()}var u=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){var t,r,i;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return r=n,i=[e],r=a(r),(t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,c()?Reflect.construct(r,i||[],a(this).constructor):r.apply(this,i))).container.table.outcome=[],t.container.table.hit(),t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&l(n,e),t=[{key:"onFirst",value:function(){this.container.table.cue.aimInputs.setDisabled(!0)}},{key:"handleStationary",value:function(e){var t=this.container.table.outcome;return this.container.rules.isEndOfGame(t)?this.container.rules.handleGameEnd(!1):this}},{key:"handleStartAim",value:function(e){return this.container.rules.startTurn(),new r.m(this.container)}},{key:"handlePlaceBall",value:function(e){if(e.respot){var t=this.container.table.balls.find(function(t){return t.id===e.respot.id});t&&(t.pos.copy(e.respot.pos),t.setStationary())}return e.useStartPos?(this.container.rules.startTurn(),new o.x(this.container,e.pos.clone())):(this.container.rules.startTurn(),new o.x(this.container))}},{key:"handleWatch",value:function(e){return"rerack"in e.json?(console.log("Respot"),s.x.applyBallinfoToTable(this.container.table,e.json),this):new d(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(i.y);function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function p(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(p=function(){return!!e})()}var d=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){var t,r,i;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return r=n,i=[e],r=h(r),(t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,p()?Reflect.construct(r,i||[],h(this).constructor):r.apply(this,i))).container.table.cueball=t.container.rules.otherPlayersCueBall(),t.container.table.cue.moveTo(t.container.table.cueball.pos),t.container.view.camera.suggestMode(t.container.view.camera.topView),t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&f(n,e),t=[{key:"onFirst",value:function(){this.container.table.cue.aimInputs.setDisabled(!0)}},{key:"handleAim",value:function(e){return this.container.table.cue.aim=e,this.container.table.cueball.pos.copy(e.pos),this}},{key:"handleHit",value:function(e){return this.container.table.updateFromSerialised(e.tablejson),new u(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(i.y)},"./src/diagram/diagramcontainer.ts"(e,t,n){n.d(t,{n:()=>T});var r=n("./src/container/container.ts"),i=n("./src/events/keyboard.ts"),o=n("./src/events/breakevent.ts"),s=n("./src/view/cameratop.ts"),a=n("./src/model/physics/physics.ts"),l=n("./src/view/assets.ts"),c=n("./node_modules/three/build/three.core.js");function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}var h=function(){var e;function t(e){var n,r,i=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");r=void 0,(n="shots")in this?Object.defineProperty(this,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):this[n]=r,this.shots=e.map(function(e){return i.interpolateAllBalls(e)})}return e=[{key:"interpolateUntilMove",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.3,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e-5;return e.t.length>1&&e.t[1]-e.t[0]>t&&(e.t.splice(1,0,e.t[1]-n),e.x.splice(1,0,e.x[0]),e.y.splice(1,0,e.y[0])),e}},{key:"interpolateAllBalls",value:function(e){var t=this;return e.balls=Object.fromEntries(Object.entries(e.balls).map(function(e){var n=function(e){if(Array.isArray(e))return e}(e)||function(e){var t,n,r=null==e?null:"u">typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var i=[],o=!0,s=!1;try{for(r=r.call(e);!(o=(t=r.next()).done)&&(i.push(t.value),2!==i.length);o=!0);}catch(e){s=!0,n=e}finally{try{o||null==r.return||r.return()}finally{if(s)throw n}}return i}}(e)||function(e){if(e){if("string"==typeof e)return u(e,2);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return u(e,2)}}(e)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(),r=n[0],i=n[1];return[r,t.interpolateUntilMove(i)]})),e}},{key:"getInterpolatedPosition",value:function(e,t,n){if(!e||0===e.length||n<=e[0])return t[0];if(n>=e[e.length-1])return t[t.length-1];for(var r=0,i=e.length-1;r<i-1;){var o=Math.floor((r+i)/2);e[o]<n?r=o:i=o}var s=e[r],a=e[i],l=t[r];return l+(n-s)/(a-s)*(t[i]-l)}},{key:"getPositionsAtTime",value:function(e,t){var n=this.shots.find(function(t){return t.shotID===e}),r={};for(var i in n.balls){var o=n.balls[i],s=this.getInterpolatedPosition(o.t,o.x,t),a=this.getInterpolatedPosition(o.t,o.y,t);r[i]={x:s,y:a}}return r}},{key:"realToSim",value:function(e,t){return{x:2.3*(.71-t[e].x/2),y:2.3*(-.36+t[e].y/2)}}},{key:"identifyFirstMover",value:function(e){return console.log(e),e.balls["1"].t[1]<e.balls["2"].t[1]?"1":"2"}},{key:"estimateDirection",value:function(e){var t=this.getPositionsAtTime(e.shotID,0),n=this.getPositionsAtTime(e.shotID,.2),r=this.identifyFirstMover(e),i=t[r],o=new c.Pq0(i.x,i.y),s=n[r],a=new c.Pq0(s.x,s.y);return{pos1:t,pos2:n,firstMover:r,speed:2*o.distanceTo(a),angle:new c.Pq0(-1,0).angleTo(a.sub(o))}}},{key:"stateFrom",value:function(e){var t=this.getPositionsAtTime(e.shotID,0),n={init:[],shots:[]};for(var r in t){var i=this.realToSim(r,t);n.init.push(i.x),n.init.push(i.y)}var o=this.estimateDirection(e);console.log("estimated",o);var s=+("1"!=o.firstMover);return console.log(o),n.shots.push({type:"AIM",offset:{x:-0,y:0,z:0},angle:o.angle,power:o.speed,pos:{x:n.init[2*s],y:n.init[2*s+1],z:0},i:s}),n}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var p=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");f(this,"ctx",void 0),f(this,"canvas",void 0),f(this,"BALL_COLORS",{1:"white",2:"yellow",3:"red"}),f(this,"BALL_DIAMETER",.0615),f(this,"TABLE_WIDTH",2.84),f(this,"PIXELS_PER_METER",void 0),f(this,"ballPaths",{}),this.canvas=e,this.ctx=this.canvas.getContext("2d"),this.PIXELS_PER_METER=this.canvas.width/this.TABLE_WIDTH}return e=[{key:"drawBall",value:function(e,t,n){var r=this.BALL_DIAMETER/2*this.PIXELS_PER_METER,i=this.canvas.width-e;this.ctx.beginPath(),this.ctx.arc(i,t,r,0,2*Math.PI),this.ctx.fillStyle=n,this.ctx.fill(),this.ctx.strokeStyle="black",this.ctx.lineWidth=1,this.ctx.stroke()}},{key:"drawBallPath",value:function(e,t){var n=this,r=this.BALL_COLORS[e];this.ctx.save(),this.ctx.beginPath(),t.forEach(function(e,t){var r=n.canvas.width-e.x*n.PIXELS_PER_METER,i=n.canvas.height-e.y*n.PIXELS_PER_METER;0===t?n.ctx.moveTo(r,i):n.ctx.lineTo(r,i)}),this.ctx.setLineDash([4,4]),this.ctx.strokeStyle=r,this.ctx.lineWidth=1,this.ctx.stroke(),this.ctx.restore()}},{key:"clear",value:function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}},{key:"drawShot",value:function(e){for(var t in this.ballPaths)this.drawBallPath(t,this.ballPaths[t]);for(var n in e){var r=e[n],i=this.BALL_COLORS[n],o=r.x*this.PIXELS_PER_METER,s=this.canvas.height-r.y*this.PIXELS_PER_METER;this.drawBall(o,s,i)}}},{key:"resetCanvas",value:function(){this.clear(),this.ballPaths={}}},{key:"updateBallPaths",value:function(e,t){this.ballPaths[e]||(this.ballPaths[e]=[]),this.ballPaths[e].push(t)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),d=n("./src/events/abortevent.ts"),v=n("./src/events/beginevent.ts");function y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var m=function(){var e;function t(){var e;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");y(this,"aimBall",void 0),y(this,"aimCoordinatesDisplay",void 0),y(this,"aimBallContainer",void 0),y(this,"powerSlider",void 0),y(this,"directionSlider",void 0),y(this,"BALL_CONTAINER_RADIUS",void 0),y(this,"MAX_DISTANCE",.7),y(this,"position",{x:0,y:0}),y(this,"power",5),y(this,"direction",0),this.aimBall=document.getElementById("aim-ball"),this.aimCoordinatesDisplay=document.getElementById("aim-coordinates"),this.aimBallContainer=document.getElementById("aim-ball-container"),this.powerSlider=document.getElementById("power"),this.directionSlider=document.getElementById("direction"),this.BALL_CONTAINER_RADIUS=((null==(e=this.aimBallContainer)?void 0:e.clientWidth)||0)/2,this.addEventListeners()}return e=[{key:"addEventListeners",value:function(){var e,t,n,r=this;null==(e=this.aimBallContainer)||e.addEventListener("click",function(e){return r.handleClick(e)}),null==(t=this.powerSlider)||t.addEventListener("input",function(e){r.power=parseInt(e.target.value)}),null==(n=this.directionSlider)||n.addEventListener("input",function(e){r.direction=parseInt(e.target.value)})}},{key:"handleClick",value:function(e){if(this.aimBallContainer&&this.aimBall){var t=this.aimBallContainer.getBoundingClientRect(),n=e.clientX-t.left-t.width/2,r=e.clientY-t.top-t.height/2;if(Math.sqrt(n*n+r*r)>this.MAX_DISTANCE*this.BALL_CONTAINER_RADIUS){var i=Math.atan2(r,n);n=this.MAX_DISTANCE*this.BALL_CONTAINER_RADIUS*Math.cos(i),r=this.MAX_DISTANCE*this.BALL_CONTAINER_RADIUS*Math.sin(i)}var o=t.width/2-this.aimBall.offsetWidth/2,s=t.height/2-this.aimBall.offsetHeight/2,a=Math.max(-o,Math.min(o,n)),l=Math.max(-s,Math.min(s,r));this.position.x=a/this.BALL_CONTAINER_RADIUS,this.position.y=l/this.BALL_CONTAINER_RADIUS,this.updateDom()}}},{key:"updateDom",value:function(){if(this.aimBall&&this.aimBallContainer){var e=this.aimBallContainer.getBoundingClientRect(),t=this.position.x*this.BALL_CONTAINER_RADIUS,n=this.position.y*this.BALL_CONTAINER_RADIUS;this.aimBall.style.left="".concat(t+e.width/2-this.aimBall.offsetWidth/2,"px"),this.aimBall.style.top="".concat(n+e.height/2-this.aimBall.offsetHeight/2,"px"),this.aimCoordinatesDisplay&&(this.aimCoordinatesDisplay.textContent="x: ".concat(this.position.x.toFixed(2),", y: ").concat(this.position.y.toFixed(2)))}}},{key:"getAim",value:function(){return{offset:{x:this.position.x,y:this.position.y,z:0},angle:this.direction,power:this.power}}},{key:"setAim",value:function(e){this.position.x=e.offset.x,this.position.y=e.offset.y,this.power=e.power,this.powerSlider.value=e.power.toString(),this.direction=e.angle,this.directionSlider.value=e.angle.toString(),console.log("set aim",e),this.updateDom()}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function b(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var g=function(){var e;function t(e,n){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");b(this,"drawer",void 0),b(this,"aimInputs",void 0),b(this,"fileInput",document.getElementById("fileInput")),b(this,"shotIndexDisplay",document.getElementById("shotIndexDisplay")),b(this,"shotSelector",document.getElementById("shotSelector")),b(this,"replayButton",document.getElementById("replay")),b(this,"myIframe",document.getElementById("myIframe")),b(this,"allShots",[]),b(this,"currentShotIndex",0),b(this,"animationTimer",-2.35),b(this,"isPlaying",!1),b(this,"lastFrameTime",0),b(this,"animationStartTime",0),b(this,"realPosition",null),b(this,"elapsedTime",0),b(this,"container",void 0),this.drawer=new p(e),this.container=n,this.aimInputs=new m,n&&(n.frame=this.advance.bind(this)),this.start()}return e=[{key:"start",value:function(){console.log("real overlay start"),this.loadDefaultData(),this.addEventListeners()}},{key:"addEventListeners",value:function(){var e=this;this.fileInput.addEventListener("change",function(t){return e.handleFileChange(t)}),this.shotSelector.addEventListener("change",function(){return e.handleShotSelect()}),this.replayButton.addEventListener("click",function(){return e.handleReplay()})}},{key:"handleFileChange",value:function(e){var t=this,n=e.target.files[0];if(n){var r=new FileReader;r.onload=function(e){try{var n=JSON.parse(e.target.result);t.processShots(n)}catch(e){console.error("Error parsing JSON:",e),alert("Error parsing JSON file.")}},r.readAsText(n)}}},{key:"handleShotSelect",value:function(){this.currentShotIndex=parseInt(this.shotSelector.value,10),this.updateDisplay(),this.resetAnimation()}},{key:"loadDefaultData",value:function(){var e=this;fetch("simple_shots.json").then(function(e){if(!e.ok)throw Error("HTTP error! status: ".concat(e.status));return e.json()}).then(function(t){return e.processShots(t)})}},{key:"processShots",value:function(e){this.allShots=e,this.realPosition=new h(this.allShots),this.allShots.length>0&&(this.currentShotIndex=0,this.populateShotSelector(),this.updateDisplay(),this.resetAnimation())}},{key:"populateShotSelector",value:function(){var e=this;this.shotSelector.innerHTML="",this.allShots.forEach(function(t,n){var r=document.createElement("option");r.value=n.toString(),r.text="Shot ".concat(n+1," (ID: ").concat(t.shotID,")"),e.shotSelector.appendChild(r)}),this.allShots.length>0&&(this.shotSelector.value=this.currentShotIndex.toString())}},{key:"updateDisplay",value:function(){this.shotIndexDisplay.textContent="Shot: ".concat(this.currentShotIndex+1),this.allShots[this.currentShotIndex]&&(this.shotSelector.value=this.currentShotIndex.toString())}},{key:"drawShot",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(this.realPosition){var n=this.realPosition.getPositionsAtTime(e.shotID,t);if(n){for(var r in n)this.drawer.updateBallPaths(r,n[r]);this.drawer.clear(),this.drawer.drawShot(n)}}}},{key:"handleReplay",value:function(){this.resetAnimation()}},{key:"resetAnimation",value:function(){this.isPlaying=!1,this.animationTimer=-2.3,this.drawer.resetCanvas(),this.drawShot(this.allShots[this.currentShotIndex],0),this.resetSimulation(this.allShots[this.currentShotIndex])}},{key:"resetSimulation",value:function(e){console.log("reset simulation");var t=this.realPosition.stateFrom(e);this.container.table.updateFromShortSerialised(t.init),this.container.eventQueue.push(new d.h),this.container.eventQueue.push(new v.u),this.container.eventQueue.push(new o.W(t.init,t.shots)),this.aimInputs.setAim(t.shots[0])}},{key:"advance",value:function(e){this.elapsedTime+=e,this.animationTimer+=e;var t=this.allShots[this.currentShotIndex];this.drawShot(t,this.animationTimer)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),w=n("./src/utils/dom.ts");function k(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function x(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var T=function(){var e,t;function n(e,t,r){var i=this;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");x(this,"container",void 0),x(this,"canvas3d",void 0),x(this,"ruletype",void 0),x(this,"replay",void 0),x(this,"cushionModel",void 0),x(this,"breakState",{init:null,shots:[]}),x(this,"realOverlay",void 0),x(this,"onAssetsReady",function(){console.log("diagram ready");var e=(0,w.vq)("replay");i.replayButton(e);var t=(0,w.dX)("overlaycanvas");t?i.realOverlay=new g(t,i.container):(i.breakState=JSON.parse(decodeURIComponent(i.replay)),i.container.eventQueue.push(new o.W(i.breakState.init,i.breakState.shots))),i.container.animate(performance.now())}),this.replay=r,this.ruletype=t,this.canvas3d=e,s.v.zoomFactor=.88}return e=[{key:"start",value:function(){var e=new i.s(this.canvas3d);this.container=new r.m(this.canvas3d,console.log,l.s.localAssets(this.ruletype),this.ruletype,e,"diagram"),this.cushionModel&&(this.container.table.cushionModel=this.cushionModel),this.onAssetsReady()}},{key:"replayButton",value:function(e){var t=this;e.innerHTML="â†»",e.addEventListener("click",function(){var e;0==t.container.eventQueue.length&&t.container.eventQueue.push(new o.W(t.breakState.init,t.breakState.shots)),null==(e=t.realOverlay)||e.start()})}}],t=[{key:"fromDiamgramElement",value:function(e){var t=null==e?void 0:e.getElementsByClassName("topview")[0],r=null==t?void 0:t.getAttribute("data-state"),i=new URLSearchParams(r),o=null==e?void 0:e.getElementsByClassName("description")[0],s=(0,w.id)("common"),l=document.createElement("a");l.href="../".concat(r),l.innerHTML="â¬€",l.target="_blank",null==o||o.appendChild(l),null==s||s.appendChild(l);var c=document.createElement("button");null==o||o.appendChild(c);var u=new n(t,i.get("ruletype"),i.get("state"));return u.replayButton(c),"bounceHan"==i.get("cushionModel")&&(u.cushionModel=a.QV),u}}],e&&k(n.prototype,e),t&&k(n,t),n}()},"./src/diagrams.ts"(e,t,n){var r,i,o,s,a,l,c,u,h,f=n("./src/model/physics/physics.ts"),p=n("./node_modules/three/build/three.core.js");function d(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var v=function(){var e;function t(e,n){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");d(this,"canvas",void 0),d(this,"context",void 0),d(this,"endx",100),d(this,"endy",100),d(this,"scale",2e3),d(this,"r",20),e.firstElementChild.innerHTML=n,this.canvas=e.lastElementChild,this.context=this.canvas.getContext("2d")}return e=[{key:"drawBall",value:function(){this.context.beginPath(),this.context.strokeStyle="lightgray",this.context.fillStyle="beige",this.context.arc(this.endx,this.endy,this.r,0,2*Math.PI,!1),this.context.fill(),this.context.stroke()}},{key:"drawCushion",value:function(){var e=this.context.createLinearGradient(10,90,200,90);e.addColorStop(0,"lightgray"),e.addColorStop(.75,"white"),this.context.fillStyle=e,this.context.fillRect(this.endx+this.r,10,200,250)}},{key:"plot",value:function(e,t,n,r,i){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawCushion(),this.drawBall();for(var o=e;o<=t;o+=n){var s=r(o),a=i(o),l=(0,f.yO)(s,a)?[]:[2,2];this.context.setLineDash(l);var c=(o+360)*101%360;this.context.strokeStyle="hsl(".concat(c,",50%,50%)"),this.drawArrow(this.endx-s.x*this.scale,this.endy-s.y*this.scale,this.endx,this.endy);var u=(0,f.QK)(0,s,a,f.Qy);s.add(u.v),this.drawArrow(this.endx,this.endy,this.endx+s.x*this.scale,this.endy+s.y*this.scale)}}},{key:"drawArrow",value:function(e,t,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:.9,o={dx:n-e,dy:r-t},s={x:o.dx*i+e,y:o.dy*i+t},a={dx:n-s.x,dy:r-s.y};this.context.beginPath(),this.context.moveTo(e,t),this.context.lineTo(s.x,s.y),this.context.moveTo(s.x+.5*a.dy,s.y-.5*a.dx),this.context.lineTo(s.x-.5*a.dy,s.y+.5*a.dx),this.context.lineTo(n,r),this.context.closePath(),this.context.stroke()}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),y=n("./src/utils/dom.ts");function m(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function b(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function g(e){return function(e){if(Array.isArray(e))return m(e)}(e)||function(e){if("u">typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e){if(e){if("string"==typeof e)return m(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return m(e,void 0)}}(e)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var w=function(){var e;function t(e,n,r){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");b(this,"canvas",void 0),b(this,"ctx",void 0),b(this,"xAxis",void 0),b(this,"yAxis",void 0),b(this,"gutter",20),this.canvas=(0,y.dX)(e),this.ctx=this.canvas.getContext("2d"),this.canvas.previousElementSibling.innerHTML=n,this.canvas.nextElementSibling.innerHTML=r}return e=[{key:"plot",value:function(e,t,n){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.shadowColor="grey",this.ctx.shadowBlur=2;var r=g(t).concat(g(n));r.push(0),this.xAxis=this.axisInfo(e,this.canvas.width),this.yAxis=this.axisInfo(r,this.canvas.height),this.drawXAxis(e),this.drawYAxis(r),this.plotLine(e,t,"blue"),this.plotLine(e,n,"red")}},{key:"plotLine",value:function(e,t,n){this.ctx.beginPath();for(var r=0;r<e.length;r++){var i=this.scale(e[r],this.xAxis),o=this.canvas.height-.8*this.scale(t[r],this.yAxis)-this.gutter;0===r?this.ctx.moveTo(i,o):this.ctx.lineTo(i,o)}this.ctx.strokeStyle=n,this.ctx.stroke()}},{key:"drawXAxis",value:function(e){var t=this.canvas.height-this.gutter;this.ctx.beginPath(),this.ctx.moveTo(0,t),this.ctx.lineTo(this.canvas.width,t),this.ctx.strokeStyle="grey",this.ctx.stroke(),this.ctx.font="8px Arial",this.ctx.strokeStyle="grey";for(var n=!1,r=2;r<e.length-2;r++){var i=this.scale(e[r],this.xAxis);this.ctx.beginPath(),this.ctx.moveTo(i,t),this.ctx.lineTo(i,t+4),this.ctx.stroke(),n||this.ctx.fillText(e[r],i-5,t+10),n=!n}}},{key:"drawYAxis",value:function(e){var t,n=(t=Math).max.apply(t,g(e)),r=this.canvas.height-.8*this.scale(n,this.yAxis)-this.gutter,i=this.canvas.height-.8*this.scale(0,this.yAxis)-this.gutter;this.ctx.beginPath(),this.ctx.moveTo(0,i),this.ctx.lineTo(0,r),this.ctx.strokeStyle="grey",this.ctx.stroke(),this.ctx.fillText("".concat("0.000"),0,i),this.ctx.fillText("".concat(n.toFixed(3)),0,r)}},{key:"scale",value:function(e,t){return(e-t.min)*t.scale}},{key:"axisInfo",value:function(e,t){var n,r,i=(n=Math).min.apply(n,g(e)),o=(r=Math).max.apply(r,g(e));return{min:i,max:o,scale:t/(o-i||1)}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),k=n("./src/model/ball.ts"),x=n("./src/model/physics/constants.ts"),T=n("./src/utils/utils.ts");function P(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var S=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");P(this,"ball",void 0),P(this,"theta",0),P(this,"canvas",void 0),P(this,"ctx",void 0),P(this,"step",.01),this.canvas=e,this.ctx=this.canvas.getContext("2d"),this.ball=new k.c(T.v_),this.ball.vel.copy(new p.Pq0(32*x.R,0,0)),this.ball.rvel.copy(new p.Pq0(0,-(2*this.ball.vel.x)/x.R,0)),this.ball.state=k.U.Sliding}return e=[{key:"drawBall",value:function(e,t,n){var r=this.canvas.width,i=this.canvas.height,o=r/(27*x.R);this.ctx.beginPath(),this.ctx.strokeStyle=n,this.ctx.fillStyle=n;var s=e*o+2*x.R*o,a=t*o+i/2,l=x.R*o;this.ctx.ellipse(s,a,l,l,0,0,2*Math.PI),this.ctx.stroke();var c=s+-(x.R*Math.sin(this.theta))*o,u=a+x.R*Math.cos(this.theta)*o;this.ctx.beginPath(),this.ctx.strokeStyle="black",this.ctx.moveTo(s,a),this.ctx.lineTo(c,u),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.fillStyle="black",this.ctx.arc(c,u,3,0,2*Math.PI),this.ctx.fill()}},{key:"advance",value:function(e){this.ball.update(e);var t=this.ball.rvel.length()*e;this.theta+=t}},{key:"draw",value:function(e){this.ctx.clearRect(0,0,1,1);for(var t=0;t<e;){var n="blue";this.ball.isRolling()?n="red":this.ball.inMotion()&&(n="green"),this.drawBall(this.ball.pos.x,0,n),this.advance(this.step),t+=this.step}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),R=n("./src/view/sliders.ts"),O=n("./src/diagram/diagramcontainer.ts"),E=n("./src/view/cue.ts"),A=3*x.R;function M(e){A=e}function _(){r&&(function(){function e(e){return function(t){return I(0,0,e)}}var t=function(e){return I(Math.cos(e*Math.PI/180),Math.sin(e*Math.PI/180),0)};r.plot(10,80,10,t,function(e){return I(0,0,0)}),i.plot(10,80,10,t,e(-40)),o.plot(10,80,10,t,e(40)),s.plot(-6,6,1,function(e){return I(.7,.7,0)},function(e){return I(0,0,6*e)}),a.plot(-6,6,1,function(e){return I(2,2,0)},function(e){return I(0,0,6*e)})}(),function(){for(var e=[],t=[],n=[],r=-180;r<=180;r+=30){e.push(r);var i=new p.Pq0(.2*x.R,0,0),o=new p.Pq0(0,0,r*x.R);t.push((0,f.Gp)((0,f.c0)(i))),n.push((0,f.Un)((0,f.s0)(i,o)))}l.plot(e,t,n)}(),function(){for(var e=[],t=[],n=[],r=-180;r<=180;r+=30){e.push(r);var i=new p.Pq0(150*x.R,0,0),o=new p.Pq0(0,r*x.R,0);t.push((0,f.Gp)((0,f.c0)(i))),n.push((0,f.Un)((0,f.s0)(i,o)))}c.plot(e,t,n)}(),function(){for(var e=[],t=[],n=[],r=-80;r<=80;r+=10){e.push(r);var i=r*Math.PI/180,o=new p.Pq0(Math.cos(i)*x.R,Math.sin(i)*x.R,0);o.multiplyScalar(A);var s=new p.Pq0(0,0,-10*x.R);t.push((0,f.Gp)((0,f.c0)(o))),n.push((0,f.Un)((0,f.s0)(o,s)))}u.plot(e,t,n)}(),function(){for(var e=[],t=[],n=[],r=0;r<=88;r+=2){e.push(r);var i=r*Math.PI/180,o=new p.Pq0(Math.cos(i)*x.R,Math.sin(i)*x.R,0),s=new p.Pq0(0,0,50*x.R),a=(0,f.QV)(o,s),l=o.clone().add(a.v),c=-(180*Math.atan2(-l.y,-l.x))/Math.PI;t.push(c);var u=(0,f.$8)(o,s),d=o.clone().add(u.v),v=-(180*Math.atan2(-d.y,-d.x))/Math.PI;n.push(v)}h.plot(e,t,n)}())}function I(e,t,n){return new p.Pq0(e*x.R,t*x.R,n*x.R)}document.addEventListener("DOMContentLoaded",function(){for(var e=document.getElementsByClassName("replaydiagram"),t=0;t<e.length;t++){var n=e.item(t);O.n.fromDiamgramElement(n).start()}var d=(0,y.id)("rollcanvas");d?new S(d).draw(5):((0,y.id)("cushion1")&&(r=new v((0,y.id)("cushion1"),"stun shot"),i=new v((0,y.id)("cushion2"),"running side"),o=new v((0,y.id)("cushion3"),"check side"),s=new v((0,y.id)("cushion4"),"varying side"),a=new v((0,y.id)("cushion5"),"varying side high vel"),l=new w("plot1","Top spin ball played slow directly into cushion","top/back spin w.y"),c=new w("plot2","Top spin ball played hard directly into cushion","top/back spin w.y"),u=new w("plot3","Right hand spinning ball with varying incident angleand speed s","Incident angle (degrees) of ball to cushion with right side"),h=new w("plot4","Bounce angle of ball with check side (y-axis outward angle)","Incident angle (degrees) of ball to cushion, 0=perpendicular, 90=parallel. Blue=Han2005 Red=Blend"),_()),new R.r(_).initialiseSlider("s",A,M,4),(0,y.id)("derived")&&function(){var e=(0,y.id)("derived");if(e){var t=new p.Pq0(new E.s().maxPower,0,0),n=(0,f.t6)(new p.Pq0(.5),t);e.innerHTML+="Mx,My    = ".concat(x.x3.toFixed(6),`
 `),e.innerHTML+="Mz       = ".concat(x.Mz.toFixed(6),`
 `),e.innerHTML+="I        = ".concat(x.I.toFixed(6),`
 `),e.innerHTML+="Max vel  = ".concat(t.length().toFixed(6),`
 `),e.innerHTML+="Max rvel = ".concat(n.length().toFixed(4),`
@@ -36,11 +36,11 @@ Ball`),this.container.table.cue.aimInputs.setDisabled(!1),this.container.rules.a
          projUv = clamp(projUv, 0.0, 1.0);

          // sample & blend
          vec4 texColor = texture2D(numberTex, projUv);
          diffuseColor.rgb = texColor.rgb;
-        `))},this.materialCache.set(r,o),o}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();function y(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}o="materialCache",s=new Map,o in v?Object.defineProperty(v,o,{value:s,enumerable:!0,configurable:!0,writable:!0}):v[o]=s;var b=function(){var e,t;function n(e,t){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");m(this,"mesh",void 0),m(this,"shadow",void 0),m(this,"spinAxisArrow",void 0),m(this,"trace",void 0),m(this,"color",void 0),m(this,"m",new u.kn4),this.color=new u.Q1f(e),this.initialiseMesh(this.color,t)}return e=[{key:"updateAll",value:function(e,t){this.updatePosition(e.pos),this.updateArrows(e.pos,e.rvel,e.state),0!==e.rvel.lengthSq()&&(this.updateRotation(e.rvel,t),this.trace.addTrace(e.pos,e.vel))}},{key:"updatePosition",value:function(e){this.mesh.position.copy(e),this.shadow.position.copy(e)}},{key:"updateRotation",value:function(e,t){var n=e.length()*t;this.mesh.rotateOnWorldAxis((0,l.xb)(e),n)}},{key:"updateArrows",value:function(e,t,n){this.spinAxisArrow.setLength(h.R+h.R*t.length()/2,h.R,h.R),this.spinAxisArrow.position.copy(e),this.spinAxisArrow.setDirection((0,l.xb)(t)),n==k.Rolling?this.spinAxisArrow.setColor(0xcc0000):this.spinAxisArrow.setColor(52224)}},{key:"initialiseMesh",value:function(e,t){if(void 0===t){var r,i,o=e.getHex(),s=n._dottedGeometryCache.get(o);s||(s=new u.WBB(h.R,1),n.addDots(s,e),n._dottedGeometryCache.set(o,s)),r=s,i=v.createDottedMaterial(e)}else r=n.getBallGeometry(),i=v.createProjectedMaterial(t,e);this.mesh=new u.eaF(r,i),this.mesh.name="ball",this.updateRotation(new u.Pq0().random(),100),this.shadow=new u.eaF(n.getShadowGeometry(),n.getShadowMaterial()),this.spinAxisArrow=new u.E0M(l.up,l.v_,2,0,.01,.01),this.spinAxisArrow.visible=!1,this.trace=new p(500,e)}},{key:"addToScene",value:function(e){e.add(this.mesh),e.add(this.shadow),e.add(this.spinAxisArrow),e.add(this.trace.line)}}],t=[{key:"getBallGeometry",value:function(){return this._ballGeometry||(this._ballGeometry=new u.WBB(h.R,1)),this._ballGeometry}},{key:"getShadowGeometry",value:function(){return this._shadowGeometry||(this._shadowGeometry=new u.tcD(.9*h.R,9),this._shadowGeometry.applyMatrix4(new u.kn4().makeTranslation(0,0,-(.99*h.R)))),this._shadowGeometry}},{key:"getShadowMaterial",value:function(){return this._shadowMaterial||(this._shadowMaterial=new u.V9B({color:1118498})),this._shadowMaterial}},{key:"addDots",value:function(e,t){var r=e.attributes.position.count,i=new u.Q1f(t);e.setAttribute("color",new u.THS(new Float32Array(3*r),3));for(var o=e.attributes.color,s=0;s<r/3;s++)n.colorVerticesForFace(s,o,n.scaleNoise(i.r),n.scaleNoise(i.g),n.scaleNoise(i.b));var a=new u.Q1f(0xaa2222);[0,96,111,156,186,195].forEach(function(e){n.colorVerticesForFace(e/3,o,a.r,a.g,a.b)})}},{key:"colorVerticesForFace",value:function(e,t,n,r,i){t.setXYZ(3*e+0,n,r,i),t.setXYZ(3*e+1,n,r,i),t.setXYZ(3*e+2,n,r,i)}},{key:"scaleNoise",value:function(e){return(1-.25*Math.random())*e}}],e&&y(n.prototype,e),t&&y(n,t),n}();function g(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function w(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}m(b,"_ballGeometry",void 0),m(b,"_shadowGeometry",void 0),m(b,"_shadowMaterial",void 0),m(b,"_dottedGeometryCache",new Map);var k=((a={}).Stationary="Stationary",a.Rolling="Rolling",a.Sliding="Sliding",a.Falling="Falling",a.InPocket="InPocket",a),x=function(){var e,t;function n(e,t,r){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");w(this,"pos",void 0),w(this,"vel",l.v_.clone()),w(this,"rvel",l.v_.clone()),w(this,"futurePos",l.v_.clone()),w(this,"ballmesh",void 0),w(this,"state","Stationary"),w(this,"pocket",void 0),w(this,"id",n.id++),w(this,"label",void 0),this.pos=e.clone(),this.label=r,this.ballmesh=new b(t||0xeeeeee*Math.random(),r)}return e=[{key:"update",value:function(e){this.updatePosition(e),"Falling"==this.state?this.pocket.updateFall(this,e):this.updateVelocity(e)}},{key:"updateMesh",value:function(e){this.ballmesh.updateAll(this,e)}},{key:"updatePosition",value:function(e){this.pos.addScaledVector(this.vel,e)}},{key:"updateVelocity",value:function(e){this.inMotion()&&(this.isRolling()?(this.state="Rolling",(0,c.lx)(this.vel,this.rvel),this.addDelta(e,(0,c.JD)(this.rvel))):(this.state="Sliding",this.addDelta(e,(0,c.p2)(this.vel,this.rvel))))}},{key:"addDelta",value:function(e,t){t.v.multiplyScalar(e),t.w.multiplyScalar(e),this.passesZero(t)||(this.vel.add(t.v),this.rvel.add(t.w))}},{key:"passesZero",value:function(e){var t=(0,l.rq)(this.vel,e.v),n=(0,l.rq)(this.rvel,e.w);return!!(("Rolling"===this.state?t||n:t&&n)&&.01>Math.abs(this.rvel.z))&&(this.setStationary(),!0)}},{key:"setStationary",value:function(){this.vel.copy(l.v_),this.rvel.copy(l.v_),this.state="Stationary"}},{key:"isRolling",value:function(){return 0!==this.vel.lengthSq()&&0!==this.rvel.lengthSq()&&(0,c.Mq)(this.vel,this.rvel).length()<n.transition}},{key:"onTable",value:function(){return"Falling"!==this.state&&"InPocket"!==this.state}},{key:"inMotion",value:function(){return"Rolling"===this.state||"Sliding"===this.state||this.isFalling()}},{key:"isFalling",value:function(){return"Falling"===this.state}},{key:"futurePosition",value:function(e){return this.futurePos.copy(this.pos).addScaledVector(this.vel,e),this.futurePos}},{key:"fround",value:function(){this.pos.x=Math.fround(this.pos.x),this.pos.y=Math.fround(this.pos.y),this.vel.x=Math.fround(this.vel.x),this.vel.y=Math.fround(this.vel.y),this.rvel.x=Math.fround(this.rvel.x),this.rvel.y=Math.fround(this.rvel.y),this.rvel.z=Math.fround(this.rvel.z)}},{key:"serialise",value:function(){return{pos:this.pos.clone(),id:this.id}}}],t=[{key:"fromSerialised",value:function(e){return n.updateFromSerialised(new n((0,l.t6)(e.pos)),e)}},{key:"updateFromSerialised",value:function(e,t){var n,r;return e.pos.copy(t.pos),e.vel.copy(null!=(n=null==t?void 0:t.vel)?n:l.v_),e.rvel.copy(null!=(r=null==t?void 0:t.rvel)?r:l.v_),e}}],e&&g(n.prototype,e),t&&g(n,t),n}();w(x,"id",0),w(x,"transition",.05)},"./src/model/outcome.ts"(e,t,n){n.d(t,{$:()=>o,P:()=>s});function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var i,o=((i={}).Pot="Pot",i.Cushion="Cushion",i.Collision="Collision",i.Hit="Hit",i),s=function(){var e;function t(e,n,i,o){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");r(this,"type",void 0),r(this,"timestamp",void 0),r(this,"ballA",null),r(this,"ballB",null),r(this,"incidentSpeed",void 0),this.type=e,this.ballA=n,this.ballB=i,this.incidentSpeed=o,this.timestamp=Date.now()}return e=[{key:"pot",value:function(e,n){return new t("Pot",e,e,n)}},{key:"cushion",value:function(e,n){return new t("Cushion",e,e,n)}},{key:"collision",value:function(e,n,r){return new t("Collision",e,n,r)}},{key:"hit",value:function(e,n){return new t("Hit",e,e,n)}},{key:"isCueBallPotted",value:function(e,t){return t.some(function(t){return"Pot"==t.type&&t.ballA===e})}},{key:"isBallPottedNoFoul",value:function(e,n){return n.some(function(e){return"Pot"==e.type&&null!==e.ballA})&&!t.isCueBallPotted(e,n)}},{key:"pots",value:function(e){return e.filter(function(e){return"Pot"==e.type}).map(function(e){return e.ballA})}},{key:"potCount",value:function(e){return this.pots(e).length}},{key:"onlyRedsPotted",value:function(e){return this.pots(e).every(function(e){return e.id>6})}},{key:"firstCollision",value:function(e){var t=e.filter(function(e){return"Collision"===e.type});return t.length>0?t[0]:void 0}},{key:"isClearTable",value:function(e){var t=e.balls.filter(function(e){return e.onTable()});return 1===t.length&&t[0]===e.cueball}},{key:"isThreeCushionPoint",value:function(e,n){n=t.cueBallFirst(e,n).filter(function(t){return t.ballA===e});var r=new Set,i=0,o=!0,s=!1,a=void 0;try{for(var l,c=n[Symbol.iterator]();!(o=(l=c.next()).done);o=!0){var u=l.value;if("Cushion"===u.type&&i++,"Collision"===u.type&&(r.add(u.ballB),2===r.size))return i>=3}}catch(e){s=!0,a=e}finally{try{o||null==c.return||c.return()}finally{if(s)throw a}}return!1}},{key:"cueBallFirst",value:function(e,t){return t.forEach(function(t){"Collision"===t.type&&t.ballB===e&&(t.ballB=t.ballA,t.ballA=e)}),t}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/model/physics/collision.ts"(e,t,n){n.d(t,{F:()=>h});var r,i,o=n("./src/model/ball.ts"),s=n("./node_modules/three/build/three.core.js"),a=n("./src/model/physics/constants.ts"),l=n("./src/utils/utils.ts");function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var u=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");c(this,"normalImpulse",void 0),c(this,"tangentialImpulse",void 0)}return e=[{key:"dynamicFriction",value:function(e){return .01+.108*(0,l.oN)(-1.088*e)}},{key:"updateVelocities",value:function(e,t){var n=h.positionsAtContact(e,t);e.ballmesh.trace.forceTrace(n.a),t.ballmesh.trace.forceTrace(n.b);var r=n.b.sub(n.a).normalize(),i=new s.Pq0(-r.y,r.x,0),o=e.vel.clone().sub(t.vel).add(r.clone().multiplyScalar(-a.R).cross(e.rvel).sub(r.clone().multiplyScalar(a.R).cross(t.rvel))),l=r.dot(o),c=o.addScaledVector(r,-l),u=c.length(),f=i.dot(c),p=this.dynamicFriction(u);this.normalImpulse=-1.99*l/(2/a.m),this.tangentialImpulse=-(.25*Math.min(p*Math.abs(this.normalImpulse)/u,1/7)*f);var d=r.clone().multiplyScalar(this.normalImpulse),v=i.clone().multiplyScalar(this.tangentialImpulse);e.vel.addScaledVector(d,1/a.m).addScaledVector(v,1/a.m),t.vel.addScaledVector(d,-1/a.m).addScaledVector(v,-1/a.m);var y=r.clone().multiplyScalar(-a.R).cross(v),m=r.clone().multiplyScalar(a.R).cross(v);return e.rvel.addScaledVector(y,1/a.I),t.rvel.addScaledVector(m,1/a.I),l}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),h=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"willCollide",value:function(e,t,n){return(e.inMotion()||t.inMotion())&&e.onTable()&&t.onTable()&&e.futurePosition(n).distanceToSquared(t.futurePosition(n))<4*a.R*a.R}},{key:"collide",value:function(e,n){return t.updateVelocities(e,n)}},{key:"positionsAtContact",value:function(e,t){var n=e.pos.distanceTo(t.pos),r=e.vel.clone().sub(t.vel),i=(n-2*a.R)/r.length()||0;return{a:e.pos.clone().addScaledVector(e.vel,i),b:t.pos.clone().addScaledVector(t.vel,i)}}},{key:"updateVelocities",value:function(e,n){var r=t.model.updateVelocities(e,n);return e.state=o.U.Sliding,n.state=o.U.Sliding,r}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();r="model",i=new u,r in h?Object.defineProperty(h,r,{value:i,enumerable:!0,configurable:!0,writable:!0}):h[r]=i},"./src/model/physics/constants.ts"(e,t,n){n.d(t,{I:()=>o,Mz:()=>r,PX:()=>A,Qg:()=>k,R:()=>f,Wv:()=>T,Ys:()=>P,Z3:()=>m,_m:()=>y,cM:()=>S,e:()=>p,ee:()=>d,g:()=>s,gT:()=>c,gf:()=>l,jG:()=>w,kL:()=>u,kM:()=>R,ki:()=>E,ko:()=>O,m:()=>h,mu:()=>a,o5:()=>b,oV:()=>v,x3:()=>i,xO:()=>x});var r,i,o,s=9.8,a=.00985,l=.16,c=.85,u=.034,h=.23,f=.03275,p=.86,d=.98,v=.212,y=.14,m=.4,b=Math.sqrt(21)/5;function g(){r=a*h*s*2/3*u,i=7/(5*Math.sqrt(2))*f*a*h*s,o=.4*h*f*f}function w(e){f=e,g()}function k(e){h=e,g()}function x(e){a=e,g()}function T(e){u=e,g()}function P(e){l=e}function S(e){p=e}function R(e){c=e}function O(e){v=e}function E(e){y=e}function A(e){d=e}g()},"./src/model/physics/knuckle.ts"(e,t,n){n.d(t,{O:()=>a});var r=n("./src/model/physics/constants.ts"),i=n("./src/view/pocketgeometry.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e,t;function n(e,t){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");s(this,"pos",void 0),s(this,"radius",void 0),this.pos=e,this.radius=t}return e=[{key:"bounce",value:function(e){var t=e.pos.clone().sub(this.pos).normalize(),n=t.dot(e.vel);return e.vel.addScaledVector(t,-2*r.e*n),e.rvel.multiplyScalar(.5),Math.abs(n)}}],t=[{key:"willBounce",value:function(e,t){return t.distanceTo(e.pos)<r.R+e.radius}},{key:"findBouncing",value:function(e,t){var r=e.futurePosition(t);return i.f.knuckles.find(function(e){return n.willBounce(e,r)})}}],e&&o(n.prototype,e),t&&o(n,t),n}()},"./src/model/physics/mathaven.ts"(e,t,n){n.d(t,{z:()=>s});var r=n("./src/utils/utils.ts"),i=n("./src/model/physics/constants.ts");function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var s=function(){var e;function t(e,n,r,i,s){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");o(this,"P",0),o(this,"WzI",0),o(this,"vx",void 0),o(this,"vy",void 0),o(this,"Ï‰x",void 0),o(this,"Ï‰y",void 0),o(this,"Ï‰z",void 0),o(this,"s",void 0),o(this,"Ï†",void 0),o(this,"sÊ¹",void 0),o(this,"Ï†Ê¹",void 0),o(this,"i",0),o(this,"N",100),o(this,"M",void 0),o(this,"R",void 0),o(this,"Î¼s",void 0),o(this,"Î¼w",void 0),o(this,"ee",void 0),this.M=e,this.R=n,this.ee=r,this.Î¼s=i,this.Î¼w=s}return e=[{key:"updateSlipSpeedsAndAngles",value:function(){var e=this.R,t=this.vx+this.Ï‰y*e*i.Z3-this.Ï‰z*e*i.o5,n=-this.vy*i.Z3+this.Ï‰x*e,o=this.vx-this.Ï‰y*e,s=this.vy+this.Ï‰x*e;this.s=(0,r.RZ)((0,r.n7)(t,2)+(0,r.n7)(n,2)),this.Ï†=(0,r.FP)(n,t),this.Ï†<0&&(this.Ï†+=2*Math.PI),this.sÊ¹=(0,r.RZ)((0,r.n7)(o,2)+(0,r.n7)(s,2)),this.Ï†Ê¹=(0,r.FP)(s,o),this.Ï†Ê¹<0&&(this.Ï†Ê¹+=2*Math.PI)}},{key:"compressionPhase",value:function(){for(var e=Math.max(this.M*this.vy/this.N,.001);this.vy>0;)this.updateSingleStep(e)}},{key:"restitutionPhase",value:function(e){var t=Math.max(e/this.N,.001);for(this.WzI=0;this.WzI<e;)this.updateSingleStep(t)}},{key:"updateSingleStep",value:function(e){if(this.updateSlipSpeedsAndAngles(),this.updateVelocity(e),this.updateAngularVelocity(e),this.updateWorkDone(e),this.i++>10*this.N)throw Error("Solution not found")}},{key:"updateVelocity",value:function(e){var t=this.Î¼s,n=this.Î¼w,o=this.M;this.vx-=1/o*(n*(0,r.gn)(this.Ï†)+t*(0,r.gn)(this.Ï†Ê¹)*(i.Z3+n*(0,r.F8)(this.Ï†)*i.o5))*e,this.vy-=1/o*(i.o5-n*i.Z3*(0,r.F8)(this.Ï†)+t*(0,r.F8)(this.Ï†Ê¹)*(i.Z3+n*(0,r.F8)(this.Ï†)*i.o5))*e}},{key:"updateAngularVelocity",value:function(e){var t=this.Î¼s,n=this.Î¼w,o=this.M,s=this.R;this.Ï‰x+=-(5/(2*o*s))*(n*(0,r.F8)(this.Ï†)+t*(0,r.F8)(this.Ï†Ê¹)*(i.Z3+n*(0,r.F8)(this.Ï†)*i.o5))*e,this.Ï‰y+=-(5/(2*o*s))*(n*(0,r.gn)(this.Ï†)*i.Z3-t*(0,r.gn)(this.Ï†Ê¹)*(i.Z3+n*(0,r.F8)(this.Ï†)*i.o5))*e,this.Ï‰z+=5/(2*o*s)*(n*(0,r.gn)(this.Ï†)*i.o5)*e}},{key:"updateWorkDone",value:function(e){var t=e*Math.abs(this.vy);this.WzI+=t,this.P+=e}},{key:"solvePaper",value:function(e,t,n,i){this.solve(e*(0,r.gn)(t),e*(0,r.F8)(t),-i*(0,r.F8)(t),i*(0,r.gn)(t),n)}},{key:"solve",value:function(e,t,n,r,i){this.vx=e,this.vy=t,this.Ï‰x=n,this.Ï‰y=r,this.Ï‰z=i,this.WzI=0,this.P=0,this.i=0,this.compressionPhase();var o=this.ee*this.ee*this.WzI;this.restitutionPhase(o)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/model/physics/physics.ts"(e,t,n){n.d(t,{$8:()=>R,Gp:()=>w,JD:()=>h,Mq:()=>l,QK:()=>p,QV:()=>S,Qy:()=>A,Un:()=>g,c0:()=>b,lx:()=>f,p2:()=>u,s0:()=>m,t6:()=>M,yO:()=>k});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/utils/utils.ts"),o=n("./src/model/physics/constants.ts"),s=n("./src/model/physics/mathaven.ts"),a=new r.Pq0;function l(e,t){return a.copy(e).addScaledVector((0,i.KM)(t),o.R)}var c={v:new r.Pq0,w:new r.Pq0};function u(e,t){var n=l(e,t).setZ(0);return c.v.copy((0,i.xb)(n).multiplyScalar(-o.gf*o.g)),c.w.copy((0,i.xb)((0,i.KM)(n)).multiplyScalar(2.5*o.gf*o.g/o.R)),c.w.setZ(-2.5*(o.Mz/(o.m*o.R*o.R))*Math.sign(t.z)),c}function h(e){var t=new r.Pq0(e.x,e.y,0).length(),n=5/7*o.x3/(o.m*o.R)/t,i=5/7*o.x3/(o.m*o.R*o.R)/t;return c.v.set(-n*e.y,n*e.x,0),c.w.set(-i*e.x,-i*e.y,-2.5*(o.Mz/(o.m*o.R*o.R))*Math.sign(e.z)),c}function f(e,t){var n=t.z;t.copy((0,i.KM)(e).multiplyScalar(1/o.R)),t.setZ(n)}function p(e,t,n,r){var o=r(t.clone().applyAxisAngle(i.up,e),n.clone().applyAxisAngle(i.up,e));return o.v.applyAxisAngle(i.up,-e),o.w.applyAxisAngle(i.up,-e),o}Object.freeze(c);var d=Math.asin(.1*o.R/o.R),v=(0,i.F8)(d),y=(0,i.gn)(d);function m(e,t){return new r.Pq0(e.x*v-e.z*y+o.R*t.y,-e.y-o.R*t.z*y+o.R*t.x*v)}function b(e){return e.x*y}function g(e){var t=3.5/o.m;return e.length()/t}function w(e){var t,n=1/o.m,i=.39+.257*(t=new r.Pq0(e/y,0,0)).x-.044*t.x*t.x;return o.gT*((1+i)*e)/n}function k(e,t){var n=w(b(e));return g(m(e,t))<=n}function x(e,t){return{c:b(e),s:m(e,t),A:3.5/o.m,B:1/o.m}}function T(e,t){var n=x(e,t),r=n.c,i=n.s,s=n.A,a=n.B,l=(1+o.e)*(r/a);return O(-i.x/s*v-l*y,i.y/s,i.x/s*y-l*v)}function P(e,t){var n,r=x(e,t),i=r.c,s=r.B,a=(1+o.e)*(i/s),l=.471-.241*Math.atan2(Math.abs((n=e).y),n.x),c=Math.atan2(e.y,e.x),u=Math.cos(c);return O(-l*a*u*y-a*y,l*a*Math.sin(c),l*a*u*y-a*v)}function S(e,t){return k(e,t)?T(e,t):P(e,t)}function R(e,t){var n=T(e,t),r=P(e,t),i=Math.sign(e.y)===Math.sign(t.z)?Math.cos(Math.atan2(e.y,e.x)):1;return{v:r.v.lerp(n.v,i),w:r.w.lerp(n.w,i)}}function O(e,t,n){return{v:new r.Pq0(e/o.m,t/o.m),w:new r.Pq0(-o.R/o.I*t*v,o.R/o.I*(e*v-n*y),o.R/o.I*t*y)}}function E(e,t){var n=new s.z(o.m,o.R,o.ee,o.oV,o._m+.1);n.solve(e.x,e.y,t.x,t.y,t.z);var i=new r.Pq0(n.vx,n.vy,0),a=new r.Pq0(n.Ï‰x,n.Ï‰y,n.Ï‰z);return{v:i.sub(e),w:a.sub(t)}}function A(e,t){return p(Math.PI/2,e,t,E)}function M(e,t){var n=Math.atan2(-e.x,e.y),r=2.5*t.length()*(e.length()*o.R)/(o.R*o.R),s=t.clone().normalize();return(0,i.KM)(s).applyAxisAngle(s,n).multiplyScalar(r)}},"./src/model/physics/pocket.ts"(e,t,n){n.d(t,{Z:()=>l});var r=n("./src/model/ball.ts"),i=n("./src/model/physics/constants.ts"),o=n("./src/utils/utils.ts");function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var l=function(){var e,t;function n(e,t){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");a(this,"pos",void 0),a(this,"radius",void 0),this.pos=e,this.radius=t}return e=[{key:"fall",value:function(e,t){return e.vel.z=-i.g*t,e.state=r.U.Falling,e.pocket=this,e.vel.length()}},{key:"updateFall",value:function(e,t){e.vel.addScaledVector(o.up,-(10*i.R)*t*i.g);var n=e.pos.z;if(e.pos.clone().setZ(0).distanceTo(this.pos)>this.radius-i.R){var s=this.pos.clone().sub(e.pos).normalize().setZ(0);n>-i.R/2&&(e.vel.addScaledVector(s,7*i.R*t*i.g),e.rvel.addScaledVector((0,o.KM)(s),7*t*i.g)),0>e.vel.dot(s)&&(e.ballmesh.trace.forceTrace(e.pos),e.vel.x=s.x*e.vel.length()/2,e.vel.y=s.y*e.vel.length()/2)}var a=this.restingDepth(e);n<a&&0!==e.rvel.length()&&(e.pos.z=a,e.vel.z=-i.R/10,e.rvel.copy(o.v_)),n<a-i.R&&(e.pos.z=a-i.R,e.setStationary(),e.state=r.U.InPocket)}},{key:"restingDepth",value:function(e){return -3*i.R-i.R*e.id/4}}],t=[{key:"willFall",value:function(e,t){return t.distanceTo(e.pos)<e.radius}},{key:"findPocket",value:function(e,t,r){var i=t.futurePosition(r);return e.find(function(e){return n.willFall(e,i)})}}],e&&s(n.prototype,e),t&&s(n,t),n}()},"./src/model/table.ts"(e,t,n){n.d(t,{X:()=>b});var r=n("./src/view/tablegeometry.ts"),i=n("./src/model/physics/physics.ts"),o=n("./src/view/pocketgeometry.ts"),s=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"bounceAny",value:function(e,n){var o=!(arguments.length>2)||void 0===arguments[2]||arguments[2],s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:i.$8,a=e.futurePosition(n);if(t.willBounceLong(a,o)){var l=a.y>r.P.tableY?-Math.PI/2:Math.PI/2;return t.bounceIn(l,e,s)}if(t.willBounceShort(a,o)){var c=a.x>r.P.tableX?0:Math.PI;return t.bounceIn(c,e,s)}}},{key:"willBounceShort",value:function(e,n){return n?t.willBounceShortSegment(o.f.pockets.pocketNW.knuckleSW.pos.y,o.f.pockets.pocketSW.knuckleNW.pos.y,e):t.willBounceShortSegment(r.P.Y,-r.P.Y,e)}},{key:"willBounceLong",value:function(e,n){return n?t.willBounceLongSegment(o.f.pockets.pocketNW.knuckleNE.pos.x,o.f.pockets.pocketN.knuckleNW.pos.x,e)||t.willBounceLongSegment(o.f.pockets.pocketN.knuckleNE.pos.x,o.f.pockets.pocketNE.knuckleNW.pos.x,e):t.willBounceLongSegment(-r.P.X,r.P.X,e)}},{key:"willBounceLongSegment",value:function(e,t,n){return n.x>e&&n.x<t&&Math.abs(n.y)>r.P.tableY}},{key:"willBounceShortSegment",value:function(e,t,n){return n.y>t&&n.y<e&&Math.abs(n.x)>r.P.tableX}},{key:"bounceIn",value:function(e,t,n){t.ballmesh.trace.forceTrace(t.futurePos);var r=(0,i.QK)(e,t.vel,t.rvel,n);return t.vel.add(r.v),t.rvel.add(r.w),r.v.length()}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}(),a=n("./src/model/physics/collision.ts"),l=n("./src/model/physics/knuckle.ts"),c=n("./src/model/physics/pocket.ts"),u=n("./src/view/cue.ts"),h=n("./src/model/ball.ts"),f=n("./src/events/aimevent.ts"),p=n("./src/model/outcome.ts"),d=n("./src/utils/utils.ts"),v=n("./src/model/physics/constants.ts");function y(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var b=function(){var e,t;function n(e){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");m(this,"balls",void 0),m(this,"cue",new u.s),m(this,"pairs",void 0),m(this,"outcome",[]),m(this,"cueball",void 0),m(this,"cushionModel",i.$8),m(this,"mesh",void 0),this.cueball=e[0],this.initialiseBalls(e)}return e=[{key:"initialiseBalls",value:function(e){this.balls=e,this.pairs=[];for(var t=0;t<e.length;t++)for(var n=0;n<e.length;n++)t<n&&this.pairs.push({a:e[t],b:e[n]})}},{key:"updateBallMesh",value:function(e){this.balls.forEach(function(t){t.updateMesh(e)})}},{key:"advance",value:function(e){for(var t=0;!this.prepareAdvanceAll(e);)if(t++>100)throw Error("Depth exceeded resolving collisions");this.balls.forEach(function(t){t.update(e),t.fround()})}},{key:"prepareAdvanceAll",value:function(e){var t=this;return this.pairs.every(function(n){return t.prepareAdvancePair(n.a,n.b,e)})&&this.balls.every(function(n){return t.prepareAdvanceToCushions(n,e)})}},{key:"prepareAdvancePair",value:function(e,t,n){if(a.F.willCollide(e,t,n)){var r=a.F.collide(e,t);return this.outcome.push(p.P.collision(e,t,r)),!1}return!0}},{key:"prepareAdvanceToCushions",value:function(e,t){if(!e.onTable())return!0;var n=e.futurePosition(t);if(Math.abs(n.y)<r.P.tableY&&Math.abs(n.x)<r.P.tableX)return!0;var i=s.bounceAny(e,t,r.P.hasPockets,this.cushionModel);if(i)return this.outcome.push(p.P.cushion(e,i)),!1;var a=l.O.findBouncing(e,t);if(a){var u=a.bounce(e);return this.outcome.push(p.P.cushion(e,u)),!1}var h=c.Z.findPocket(o.f.pocketCenters,e,t);if(h){var f=h.fall(e,t);return this.outcome.push(p.P.pot(e,f)),!1}return!0}},{key:"allStationary",value:function(){return this.balls.every(function(e){return!e.inMotion()})}},{key:"inPockets",value:function(){return this.balls.reduce(function(e,t){return t.onTable()?e:e+1},0)}},{key:"hit",value:function(){this.cue.hit(this.cueball),this.balls.forEach(function(e){e.ballmesh.trace.reset()})}},{key:"serialise",value:function(){return{balls:this.balls.map(function(e){return e.serialise()}),aim:this.cue.aim.copy()}}},{key:"updateFromSerialised",value:function(e){var t=this;e.balls&&e.balls.forEach(function(e){return h.c.updateFromSerialised(t.balls[e.id],e)}),e.aim&&(this.cue.aim=f.w.fromJson(e.aim))}},{key:"shortSerialise",value:function(){return this.balls.map(function(e){return[e.pos.x,e.pos.y]}).reduce(function(e,t){return e.concat(t)},[])}},{key:"updateFromShortSerialised",value:function(e){this.balls.forEach(function(t,n){t.pos.x=e[2*n],t.pos.y=e[2*n+1],t.pos.z=0,t.vel.copy(d.v_),t.rvel.copy(d.v_),t.state=h.U.Stationary})}},{key:"addToScene",value:function(e){this.balls.forEach(function(t){t.ballmesh.addToScene(e)}),e.add(this.cue.mesh),e.add(this.cue.helperMesh),e.add(this.cue.placerMesh)}},{key:"showTraces",value:function(e){this.balls.forEach(function(t){t.ballmesh.trace.line.visible=e,t.ballmesh.trace.reset()})}},{key:"showSpin",value:function(e){this.balls.forEach(function(t){t.ballmesh.spinAxisArrow.visible=e})}},{key:"halt",value:function(){this.balls.forEach(function(e){e.vel.copy(d.v_),e.rvel.copy(d.v_),e.state=h.U.Stationary})}},{key:"roundCueBallPosition",value:function(){var e=this.cueball.pos.clone();this.overlapsAny(e)||this.cueball.pos.copy(e)}},{key:"overlapsAny",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.cueball;return this.balls.filter(function(e){return e!==t}).some(function(t){return t.pos.distanceTo(e)<2*v.R})}}],t=[{key:"fromSerialised",value:function(e){var t=new n(e.balls.map(function(e){return h.c.fromSerialised(e)}));return t.updateFromSerialised(e),t}}],e&&y(n.prototype,e),t&&y(n,t),n}()},"./src/network/client/matchresult.ts"(e,t,n){n.d(t,{n:()=>l});var r=n("./src/events/chatevent.ts"),i=n("./src/events/notificationevent.ts"),o=n("./src/controller/end.ts"),s=n("./src/network/client/session.ts"),a=n("./src/utils/gameover.ts"),l=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"presentGameEnd",value:function(e,t){e.eventQueue.push(new r.b(null,"game over")),e.recorder.wholeGameLink();var n=s.N.hasInstance()?s.N.getInstance():null,i=s.N.playerIndex(),a=(e.scores[0]>=e.scores[1]?0:1)===i,l=this.getScoreSubtext(e,n,i);a?(this.notifyWin(e,l),this.sendLossNotification(e)):s.N.isSpectator()?this.notifySpectator(e,l):this.notifyLoss(e,l);var c=this.createMatchResult(e,t,n,i);return new o.o(e,a?c:void 0)}},{key:"notifyWin",value:function(e,t){e.notifyLocal({type:"GameOver",title:"YOU WON",subtext:t,icon:"ðŸ†",extraClass:"is-winner",extra:a.c.forMode(e.isSinglePlayer),duration:0})}},{key:"notifyLoss",value:function(e,t){e.notifyLocal({type:"GameOver",title:"YOU LOST",subtext:t,icon:"ðŸ¥ˆ",extraClass:"is-loser",extra:a.c.forMode(e.isSinglePlayer),duration:0})}},{key:"notifySpectator",value:function(e,t){e.notifyLocal({type:"GameOver",title:"GAME OVER",subtext:t,icon:"ðŸ†",extraClass:"",extra:a.c.lobby,duration:0})}},{key:"sendLossNotification",value:function(e){e.isSinglePlayer||e.sendEvent(new i.c({type:"GameOver",title:"YOU LOST",icon:"ðŸ¥ˆ",extraClass:"is-loser",extra:a.c.forMode(!1),duration:0}))}},{key:"getScoreSubtext",value:function(e,t,n){if(e.isSinglePlayer)return"Score: ".concat(e.scores[n]);var r=0===n?(null==t?void 0:t.playername)||"You":(null==t?void 0:t.opponentName)||"Opponent",i=1===n?(null==t?void 0:t.playername)||"You":(null==t?void 0:t.opponentName)||"Opponent";return"".concat(r," ").concat(e.scores[0]," - ").concat(e.scores[1]," ").concat(i)}},{key:"createMatchResult",value:function(e,t,n,r){var i=e.scores[0]>=e.scores[1]?0:1,o=1-i,s=i===r?(null==n?void 0:n.playername)||"Anon":(null==n?void 0:n.opponentName)||"Opponent",a=o===r?(null==n?void 0:n.playername)||"Anon":(null==n?void 0:n.opponentName)||"Opponent",l={winner:s,winnerScore:e.scores[i],ruleType:t};return(null==n?void 0:n.opponentName)&&(l.loser=a,l.loserScore=e.scores[o]),l}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/network/client/nchanmessagerelay.ts"(e,t,n){function r(e,t,n,r,i,o,s){try{var a=e[o](s),l=a.value}catch(e){n(e);return}a.done?t(l):Promise.resolve(l).then(r,i)}n.d(t,{p:()=>o});function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var o=function(){var e;function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"billiards-network.onrender.com";if(!(this instanceof t))throw TypeError("Cannot call a class as a function");i(this,"baseURL",void 0),i(this,"websockets",void 0),this.baseURL=e,this.websockets=new Map}return e=[{key:"subscribe",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"table",r="wss://".concat(this.baseURL,"/subscribe/").concat(n,"/").concat(e),i=new WebSocket(r);console.log("Subscribed to ",r),i.onmessage=function(e){try{var n=e.data;t(n)}catch(e){console.error("Error parsing message:",e)}},i.onerror=function(e){console.error("WebSocket error:",e)},i.onopen=function(){console.log("Connected to ".concat(r))},i.onclose=function(e){console.log("Disconnected from ".concat(r,":"),e.reason)},this.websockets.set("".concat(n,"/").concat(e),i)}},{key:"publish",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"table";fetch("https://".concat(this.baseURL,"/publish/").concat(n,"/").concat(e),{method:"POST",headers:{"Content-Type":"application/json"},body:t}).catch(function(e){console.error("Publication error:",e)})}},{key:"getOnlineCount",value:function(){var e;return(e=function(){var e;return function(e,t){var n,r,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype),a=Object.defineProperty;return a(s,"next",{value:l(0)}),a(s,"throw",{value:l(1)}),a(s,"return",{value:l(2)}),"function"==typeof Symbol&&a(s,Symbol.iterator,{value:function(){return this}}),s;function l(a){return function(l){var c=[a,l];if(n)throw TypeError("Generator is already executing.");for(;s&&(s=0,c[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&c[0]?r.return:c[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,c[1])).done)return i;switch(r=0,i&&(c=[2&c[0],i.value]),c[0]){case 0:case 1:i=c;break;case 4:return o.label++,{value:c[1],done:!1};case 5:o.label++,r=c[1],c=[0];continue;case 7:c=o.ops.pop(),o.trys.pop();continue;default:if(!(i=(i=o.trys).length>0&&i[i.length-1])&&(6===c[0]||2===c[0])){o=0;continue}if(3===c[0]&&(!i||c[1]>i[0]&&c[1]<i[3])){o.label=c[1];break}if(6===c[0]&&o.label<i[1]){o.label=i[1],i=c;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(c);break}i[2]&&o.ops.pop(),o.trys.pop();continue}c=t.call(e,o)}catch(e){c=[6,e],r=0}finally{n=i=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}}(this,function(t){switch(t.label){case 0:return t.trys.push([0,3,,4]),[4,fetch("https://".concat(this.baseURL,"/basic_status"))];case 1:return[4,t.sent().text()];case 2:return[2,(e=t.sent().match(/Active connections:\s+(\d+)/))?Number.parseInt(e[1],10)-1:null];case 3:return t.sent(),[2,null];case 4:return[2]}})},function(){var t=this,n=arguments;return new Promise(function(i,o){var s=e.apply(t,n);function a(e){r(s,i,o,a,l,"next",e)}function l(e){r(s,i,o,a,l,"throw",e)}a(void 0)})}).call(this)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/network/client/session.ts"(e,t,n){n.d(t,{N:()=>i});function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var i=function(){var e;function t(e,n,i,o){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");r(this,"playername",void 0),r(this,"clientId",void 0),r(this,"tableId",void 0),r(this,"spectator",void 0),r(this,"opponentName",void 0),r(this,"playerIndex",void 0),this.playername=e,this.clientId=n,this.tableId=i,this.spectator=o,this.playerIndex=0}return e=[{key:"getInstance",value:function(){if(!t.instance)throw Error("Session not initialized");return t.instance}},{key:"hasInstance",value:function(){return void 0!==t.instance}},{key:"playerIndex",value:function(){return t.instance?t.instance.playerIndex:0}},{key:"isSpectator",value:function(){return void 0!==t.instance&&t.getInstance().spectator}},{key:"reset",value:function(){t.instance=void 0}},{key:"init",value:function(e,n,r,i){t.instance=new t(n,e,r,i)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();r(i,"instance",void 0)},"./src/utils/dom.ts"(e,t,n){function r(e){return document.getElementById(e)}function i(e){return document.getElementById(e)}function o(e){return document.getElementById(e)}function s(e){return document.getElementById(e)}n.d(t,{V4:()=>o,dX:()=>s,id:()=>r,vq:()=>i})},"./src/utils/gameover.ts"(e,t,n){n.d(t,{c:()=>r});var r={lobby:"<button onclick=\"location.href='".concat("https://scoreboard-tailuge.vercel.app/","'\">Lobby</button>"),newGame:'<button onclick="location.reload()">New Game</button>',replay:'<button onclick="location.reload()">Replay</button>',forMode:function(e){return e?this.newGame+this.lobby:this.lobby}}},"./src/utils/gltf.ts"(e,t,n){n.d(t,{KP:()=>ex,Ro:()=>eT});var r=n("./node_modules/three/build/three.core.js");let i={POSITION:["byte","byte normalized","unsigned byte","unsigned byte normalized","short","short normalized","unsigned short","unsigned short normalized"],NORMAL:["byte normalized","short normalized"],TANGENT:["byte normalized","short normalized"],TEXCOORD:["byte","byte normalized","unsigned byte","short","short normalized","unsigned short"]};class o{constructor(){this.textureUtils=null,this.pluginCallbacks=[],this.register(function(e){return new v(e)}),this.register(function(e){return new y(e)}),this.register(function(e){return new w(e)}),this.register(function(e){return new k(e)}),this.register(function(e){return new x(e)}),this.register(function(e){return new T(e)}),this.register(function(e){return new m(e)}),this.register(function(e){return new b(e)}),this.register(function(e){return new g(e)}),this.register(function(e){return new P(e)}),this.register(function(e){return new S(e)}),this.register(function(e){return new R(e)}),this.register(function(e){return new O(e)}),this.register(function(e){return new E(e)})}register(e){return -1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return -1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}setTextureUtils(e){return this.textureUtils=e,this}parse(e,t,n,r){let i=new d,o=[];for(let e=0,t=this.pluginCallbacks.length;e<t;e++)o.push(this.pluginCallbacks[e](i));i.setPlugins(o),i.setTextureUtils(this.textureUtils),i.writeAsync(e,t,r).catch(n)}parseAsync(e,t){let n=this;return new Promise(function(r,i){n.parse(e,r,i,t)})}}let s="KHR_mesh_quantization",a={};a[r.hxR]=9728,a[r.pHI]=9984,a[r.Cfg]=9986,a[r.k6q]=9729,a[r.kRr]=9985,a[r.$_I]=9987,a[r.ghU]=33071,a[r.GJx]=10497,a[r.kTW]=33648;let l={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},c=new r.Q1f;function u(e,t){return e.length===t.length&&e.every(function(e,n){return e===t[n]})}function h(e){return 4*Math.ceil(e/4)}function f(e,t=0){let n=h(e.byteLength);if(n!==e.byteLength){let r=new Uint8Array(n);if(r.set(new Uint8Array(e)),0!==t)for(let i=e.byteLength;i<n;i++)r[i]=t;return r.buffer}return e}function p(){return"u"<typeof document&&"u">typeof OffscreenCanvas?new OffscreenCanvas(1,1):document.createElement("canvas")}class d{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.extensionsRequired={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter r"+r.sPf}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map},this.textureUtils=null}setPlugins(e){this.plugins=e}setTextureUtils(e){this.textureUtils=e}async writeAsync(e,t,n={}){this.options=Object.assign({binary:!1,trs:!1,onlyVisible:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},n),this.options.animations.length>0&&(this.options.trs=!0),await this.processInputAsync(e),await Promise.all(this.pending);let r=this.buffers,i=this.json;n=this.options;let o=this.extensionsUsed,s=this.extensionsRequired,a=new Blob(r,{type:"application/octet-stream"}),l=Object.keys(o),c=Object.keys(s);if(l.length>0&&(i.extensionsUsed=l),c.length>0&&(i.extensionsRequired=c),i.buffers&&i.buffers.length>0&&(i.buffers[0].byteLength=a.size),!0===n.binary){let e=new FileReader;e.readAsArrayBuffer(a),e.onloadend=function(){var n;let r=f(e.result),o=new DataView(new ArrayBuffer(8));o.setUint32(0,r.byteLength,!0),o.setUint32(4,5130562,!0);let s=f((n=JSON.stringify(i),new TextEncoder().encode(n).buffer),32),a=new DataView(new ArrayBuffer(8));a.setUint32(0,s.byteLength,!0),a.setUint32(4,0x4e4f534a,!0);let l=new ArrayBuffer(12),c=new DataView(l);c.setUint32(0,0x46546c67,!0),c.setUint32(4,2,!0);let u=12+a.byteLength+s.byteLength+o.byteLength+r.byteLength;c.setUint32(8,u,!0);let h=new Blob([l,a,s,o,r],{type:"application/octet-stream"}),p=new FileReader;p.readAsArrayBuffer(h),p.onloadend=function(){t(p.result)}}}else if(i.buffers&&i.buffers.length>0){let e=new FileReader;e.readAsDataURL(a),e.onloadend=function(){let n=e.result;i.buffers[0].uri=n,t(i)}}else t(i)}serializeUserData(e,t){if(0===Object.keys(e.userData).length)return;let n=this.options,r=this.extensionsUsed;try{let i=JSON.parse(JSON.stringify(e.userData));if(n.includeCustomExtensions&&i.gltfExtensions){for(let e in void 0===t.extensions&&(t.extensions={}),i.gltfExtensions)t.extensions[e]=i.gltfExtensions[e],r[e]=!0;delete i.gltfExtensions}Object.keys(i).length>0&&(t.extras=i)}catch(t){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+t.message)}}getUID(e,t=!1){if(!1===this.uids.has(e)){let t=new Map;t.set(!0,this.uid++),t.set(!1,this.uid++),this.uids.set(e,t)}return this.uids.get(e).get(t)}isNormalizedNormalAttribute(e){if(this.cache.attributesNormalized.has(e))return!1;let t=new r.Pq0;for(let n=0,r=e.count;n<r;n++)if(Math.abs(t.fromBufferAttribute(e,n).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(e){let t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);let n=e.clone(),i=new r.Pq0;for(let e=0,t=n.count;e<t;e++)i.fromBufferAttribute(n,e),0===i.x&&0===i.y&&0===i.z?i.setX(1):i.normalize(),n.setXYZ(e,i.x,i.y,i.z);return t.attributesNormalized.set(e,n),n}applyTextureTransform(e,t){let n=!1,r={};(0!==t.offset.x||0!==t.offset.y)&&(r.offset=t.offset.toArray(),n=!0),0!==t.rotation&&(r.rotation=t.rotation,n=!0),(1!==t.repeat.x||1!==t.repeat.y)&&(r.scale=t.repeat.toArray(),n=!0),n&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=r,this.extensionsUsed.KHR_texture_transform=!0)}async buildMetalRoughTextureAsync(e,t){if(e===t)return e;function n(e){return e.colorSpace===r.er$?function(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}:function(e){return e}}e instanceof r.FvD&&(e=await this.decompressTextureAsync(e)),t instanceof r.FvD&&(t=await this.decompressTextureAsync(t));let i=e?e.image:null,o=t?t.image:null,s=Math.max(i?i.width:0,o?o.width:0),a=Math.max(i?i.height:0,o?o.height:0),l=p();l.width=s,l.height=a;let c=l.getContext("2d",{willReadFrequently:!0});c.fillStyle="#00ffff",c.fillRect(0,0,s,a);let u=c.getImageData(0,0,s,a);if(i){c.drawImage(i,0,0,s,a);let t=n(e),r=c.getImageData(0,0,s,a).data;for(let e=2;e<r.length;e+=4)u.data[e]=256*t(r[e]/256)}if(o){c.drawImage(o,0,0,s,a);let e=n(t),r=c.getImageData(0,0,s,a).data;for(let t=1;t<r.length;t+=4)u.data[t]=256*e(r[t]/256)}c.putImageData(u,0,0);let h=(e||t).clone();return h.source=new r.kLi(l),h.colorSpace=r.jf0,h.channel=(e||t).channel,e&&t&&e.channel!==t.channel&&console.warn("THREE.GLTFExporter: UV channels for metalnessMap and roughnessMap textures must match."),console.warn("THREE.GLTFExporter: Merged metalnessMap and roughnessMap textures."),h}async decompressTextureAsync(e,t=1/0){if(null===this.textureUtils)throw Error("THREE.GLTFExporter: setTextureUtils() must be called to process compressed textures.");return await this.textureUtils.decompress(e,t)}processBuffer(e){let t=this.json,n=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),n.push(e),0}processBufferView(e,t,n,i,o){let s,a=this.json;switch(!a.bufferViews&&(a.bufferViews=[]),t){case 5120:case 5121:s=1;break;case 5122:case 5123:s=2;break;default:s=4}let l=e.itemSize*s;34962===o&&(l=4*Math.ceil(l/4));let c=h(i*l),u=new DataView(new ArrayBuffer(c)),f=0;for(let o=n;o<n+i;o++){for(let n=0;n<e.itemSize;n++){let i;e.itemSize>4?i=e.array[o*e.itemSize+n]:(0===n?i=e.getX(o):1===n?i=e.getY(o):2===n?i=e.getZ(o):3===n&&(i=e.getW(o)),!0===e.normalized&&(i=r.cj9.normalize(i,e.array))),5126===t?u.setFloat32(f,i,!0):5124===t?u.setInt32(f,i,!0):5125===t?u.setUint32(f,i,!0):5122===t?u.setInt16(f,i,!0):5123===t?u.setUint16(f,i,!0):5120===t?u.setInt8(f,i):5121===t&&u.setUint8(f,i),f+=s}f%l!=0&&(f+=l-f%l)}let p={buffer:this.processBuffer(u.buffer),byteOffset:this.byteOffset,byteLength:c};return void 0!==o&&(p.target=o),34962===o&&(p.byteStride=l),this.byteOffset+=c,a.bufferViews.push(p),{id:a.bufferViews.length-1,byteLength:0}}processBufferViewImage(e){let t=this,n=t.json;return n.bufferViews||(n.bufferViews=[]),new Promise(function(r){let i=new FileReader;i.readAsArrayBuffer(e),i.onloadend=function(){let e=f(i.result),o={buffer:t.processBuffer(e),byteOffset:t.byteOffset,byteLength:e.byteLength};t.byteOffset+=e.byteLength,r(n.bufferViews.push(o)-1)}})}processAccessor(e,t,n,i){let o,s,a=this.json;if(e.array.constructor===Float32Array)o=5126;else if(e.array.constructor===Int32Array)o=5124;else if(e.array.constructor===Uint32Array)o=5125;else if(e.array.constructor===Int16Array)o=5122;else if(e.array.constructor===Uint16Array)o=5123;else if(e.array.constructor===Int8Array)o=5120;else if(e.array.constructor===Uint8Array)o=5121;else throw Error("THREE.GLTFExporter: Unsupported bufferAttribute component type: "+e.array.constructor.name);if(void 0===n&&(n=0),(void 0===i||i===1/0)&&(i=e.count),0===i)return null;let l=function(e,t,n){let i={min:Array(e.itemSize).fill(1/0),max:Array(e.itemSize).fill(-1/0)};for(let o=t;o<t+n;o++)for(let t=0;t<e.itemSize;t++){let n;e.itemSize>4?n=e.array[o*e.itemSize+t]:(0===t?n=e.getX(o):1===t?n=e.getY(o):2===t?n=e.getZ(o):3===t&&(n=e.getW(o)),!0===e.normalized&&(n=r.cj9.normalize(n,e.array))),i.min[t]=Math.min(i.min[t],n),i.max[t]=Math.max(i.max[t],n)}return i}(e,n,i);void 0!==t&&(s=e===t.index?34963:34962);let c=this.processBufferView(e,o,n,i,s),u={bufferView:c.id,byteOffset:c.byteOffset,componentType:o,count:i,max:l.max,min:l.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",9:"MAT3",16:"MAT4"}[e.itemSize]};return!0===e.normalized&&(u.normalized=!0),a.accessors||(a.accessors=[]),a.accessors.push(u)-1}processImage(e,t,n,i="image/png"){if(null!==e){let o=this,s=o.cache,a=o.json,l=o.options,c=o.pending;s.images.has(e)||s.images.set(e,{});let u=s.images.get(e),h=i+":flipY/"+n.toString();if(void 0!==u[h])return u[h];a.images||(a.images=[]);let f={mimeType:i},d=p();d.width=Math.min(e.width,l.maxTextureSize),d.height=Math.min(e.height,l.maxTextureSize);let v=d.getContext("2d",{willReadFrequently:!0});if(!0===n&&(v.translate(0,d.height),v.scale(1,-1)),void 0!==e.data){t!==r.GWd&&console.error("GLTFExporter: Only RGBAFormat is supported.",t),(e.width>l.maxTextureSize||e.height>l.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",e);let n=new Uint8ClampedArray(e.height*e.width*4);for(let t=0;t<n.length;t+=4)n[t+0]=e.data[t+0],n[t+1]=e.data[t+1],n[t+2]=e.data[t+2],n[t+3]=e.data[t+3];v.putImageData(new ImageData(n,e.width,e.height),0,0)}else if("u">typeof HTMLImageElement&&e instanceof HTMLImageElement||"u">typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"u">typeof ImageBitmap&&e instanceof ImageBitmap||"u">typeof OffscreenCanvas&&e instanceof OffscreenCanvas)v.drawImage(e,0,0,d.width,d.height);else throw Error("THREE.GLTFExporter: Invalid image type. Use HTMLImageElement, HTMLCanvasElement, ImageBitmap or OffscreenCanvas.");!0===l.binary?c.push((function(e,t){if(!("u">typeof OffscreenCanvas&&e instanceof OffscreenCanvas))return new Promise(n=>e.toBlob(n,t));{let n;return"image/jpeg"===t?n=.92:"image/webp"===t&&(n=.8),e.convertToBlob({type:t,quality:n})}})(d,i).then(e=>o.processBufferViewImage(e)).then(e=>{f.bufferView=e})):f.uri=r.HgN.getDataURL(d,i);let y=a.images.push(f)-1;return u[h]=y,y}throw Error("THREE.GLTFExporter: No valid image data found. Unable to process texture.")}processSampler(e){let t=this.json;t.samplers||(t.samplers=[]);let n={magFilter:a[e.magFilter],minFilter:a[e.minFilter],wrapS:a[e.wrapS],wrapT:a[e.wrapT]};return t.samplers.push(n)-1}async processTextureAsync(e){let t=this.options,n=this.cache,i=this.json;if(n.textures.has(e))return n.textures.get(e);i.textures||(i.textures=[]),e instanceof r.FvD&&(e=await this.decompressTextureAsync(e,t.maxTextureSize));let o=e.userData.mimeType;"image/webp"===o&&(o="image/png");let s={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY,o)};e.name&&(s.name=e.name),await this._invokeAllAsync(async function(t){t.writeTexture&&await t.writeTexture(e,s)});let a=i.textures.push(s)-1;return n.textures.set(e,a),a}async processMaterialAsync(e){let t=this.cache,n=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;n.materials||(n.materials=[]);let i={pbrMetallicRoughness:{}};!0!==e.isMeshStandardMaterial&&!0!==e.isMeshBasicMaterial&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");let o=e.color.toArray().concat([e.opacity]);if(u(o,[1,1,1,1])||(i.pbrMetallicRoughness.baseColorFactor=o),e.isMeshStandardMaterial?(i.pbrMetallicRoughness.metallicFactor=e.metalness,i.pbrMetallicRoughness.roughnessFactor=e.roughness):(i.pbrMetallicRoughness.metallicFactor=0,i.pbrMetallicRoughness.roughnessFactor=1),e.metalnessMap||e.roughnessMap){let t=await this.buildMetalRoughTextureAsync(e.metalnessMap,e.roughnessMap),n={index:await this.processTextureAsync(t),texCoord:t.channel};this.applyTextureTransform(n,t),i.pbrMetallicRoughness.metallicRoughnessTexture=n}if(e.map){let t={index:await this.processTextureAsync(e.map),texCoord:e.map.channel};this.applyTextureTransform(t,e.map),i.pbrMetallicRoughness.baseColorTexture=t}if(e.emissive){let t=e.emissive;if(Math.max(t.r,t.g,t.b)>0&&(i.emissiveFactor=e.emissive.toArray()),e.emissiveMap){let t={index:await this.processTextureAsync(e.emissiveMap),texCoord:e.emissiveMap.channel};this.applyTextureTransform(t,e.emissiveMap),i.emissiveTexture=t}}if(e.normalMap){let t={index:await this.processTextureAsync(e.normalMap),texCoord:e.normalMap.channel};e.normalScale&&1!==e.normalScale.x&&(t.scale=e.normalScale.x),this.applyTextureTransform(t,e.normalMap),i.normalTexture=t}if(e.aoMap){let t={index:await this.processTextureAsync(e.aoMap),texCoord:e.aoMap.channel};1!==e.aoMapIntensity&&(t.strength=e.aoMapIntensity),this.applyTextureTransform(t,e.aoMap),i.occlusionTexture=t}e.transparent?i.alphaMode="BLEND":e.alphaTest>0&&(i.alphaMode="MASK",i.alphaCutoff=e.alphaTest),e.side===r.$EB&&(i.doubleSided=!0),""!==e.name&&(i.name=e.name),this.serializeUserData(e,i),await this._invokeAllAsync(async function(t){t.writeMaterialAsync&&await t.writeMaterialAsync(e,i)});let s=n.materials.push(i)-1;return t.materials.set(e,s),s}async processMeshAsync(e){let t,n=this.cache,i=this.json,s=[e.geometry.uuid];if(Array.isArray(e.material))for(let t=0,n=e.material.length;t<n;t++)s.push(e.material[t].uuid);else s.push(e.material.uuid);let a=s.join(":");if(n.meshes.has(a))return n.meshes.get(a);let l=e.geometry;t=e.isLineSegments?1:e.isLineLoop?2:e.isLine?3:e.isPoints?0:e.material.wireframe?1:4;let c={},u={},h=[],f=[],p={uv:"TEXCOORD_0",uv1:"TEXCOORD_1",uv2:"TEXCOORD_2",uv3:"TEXCOORD_3",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},d=l.getAttribute("normal");void 0===d||this.isNormalizedNormalAttribute(d)||(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),l.setAttribute("normal",this.createNormalizedNormalAttribute(d)));let v=null;for(let e in l.attributes){if("morph"===e.slice(0,5))continue;let t=l.attributes[e];if(e=p[e]||e.toUpperCase(),/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(e)||(e="_"+e),n.attributes.has(this.getUID(t))){u[e]=n.attributes.get(this.getUID(t));continue}v=null;let i=t.array;"JOINTS_0"!==e||i instanceof Uint16Array||i instanceof Uint8Array?(i instanceof Uint32Array||i instanceof Int32Array)&&!e.startsWith("_")&&(console.warn(`GLTFExporter: Attribute "${e}" converted to type FLOAT.`),v=o.Utils.toFloat32BufferAttribute(t)):(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),v=new r.THS(new Uint16Array(i),t.itemSize,t.normalized));let s=this.processAccessor(v||t,l);null!==s&&(e.startsWith("_")||this.detectMeshQuantization(e,t),u[e]=s,n.attributes.set(this.getUID(t),s))}if(void 0!==d&&l.setAttribute("normal",d),0===Object.keys(u).length)return null;if(void 0!==e.morphTargetInfluences&&e.morphTargetInfluences.length>0){let t=[],r=[],i={};if(void 0!==e.morphTargetDictionary)for(let t in e.morphTargetDictionary)i[e.morphTargetDictionary[t]]=t;for(let o=0;o<e.morphTargetInfluences.length;++o){let s={},a=!1;for(let e in l.morphAttributes){if("position"!==e&&"normal"!==e){a||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),a=!0);continue}let t=l.morphAttributes[e][o],r=e.toUpperCase(),i=l.attributes[e];if(n.attributes.has(this.getUID(t,!0))){s[r]=n.attributes.get(this.getUID(t,!0));continue}let c=t.clone();if(!l.morphTargetsRelative)for(let e=0,n=t.count;e<n;e++)for(let n=0;n<t.itemSize;n++)0===n&&c.setX(e,t.getX(e)-i.getX(e)),1===n&&c.setY(e,t.getY(e)-i.getY(e)),2===n&&c.setZ(e,t.getZ(e)-i.getZ(e)),3===n&&c.setW(e,t.getW(e)-i.getW(e));s[r]=this.processAccessor(c,l),n.attributes.set(this.getUID(i,!0),s[r])}f.push(s),t.push(e.morphTargetInfluences[o]),void 0!==e.morphTargetDictionary&&r.push(i[o])}c.weights=t,r.length>0&&(c.extras={},c.extras.targetNames=r)}let y=Array.isArray(e.material);if(y&&0===l.groups.length)return null;let m=!1;if(y&&null===l.index){let e=[];for(let t=0,n=l.attributes.position.count;t<n;t++)e[t]=t;l.setIndex(e),m=!0}let b=y?e.material:[e.material],g=y?l.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let e=0,r=g.length;e<r;e++){let r={mode:t,attributes:u};if(this.serializeUserData(l,r),f.length>0&&(r.targets=f),null!==l.index){let t=this.getUID(l.index);(void 0!==g[e].start||void 0!==g[e].count)&&(t+=":"+g[e].start+":"+g[e].count),n.attributes.has(t)?r.indices=n.attributes.get(t):(r.indices=this.processAccessor(l.index,l,g[e].start,g[e].count),n.attributes.set(t,r.indices)),null===r.indices&&delete r.indices}let i=await this.processMaterialAsync(b[g[e].materialIndex]);null!==i&&(r.material=i),h.push(r)}!0===m&&l.setIndex(null),c.primitives=h,i.meshes||(i.meshes=[]),await this._invokeAllAsync(function(t){t.writeMesh&&t.writeMesh(e,c)});let w=i.meshes.push(c)-1;return n.meshes.set(a,w),w}detectMeshQuantization(e,t){let n;if(this.extensionsUsed[s])return;switch(t.array.constructor){case Int8Array:n="byte";break;case Uint8Array:n="unsigned byte";break;case Int16Array:n="short";break;case Uint16Array:n="unsigned short";break;default:return}t.normalized&&(n+=" normalized");let r=e.split("_",1)[0];i[r]&&i[r].includes(n)&&(this.extensionsUsed[s]=!0,this.extensionsRequired[s]=!0)}processCamera(e){let t=this.json;t.cameras||(t.cameras=[]);let n=e.isOrthographicCamera,i={type:n?"orthographic":"perspective"};return n?i.orthographic={xmag:2*e.right,ymag:2*e.top,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:i.perspective={aspectRatio:e.aspect,yfov:r.cj9.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},""!==e.name&&(i.name=e.type),t.cameras.push(i)-1}processAnimation(e,t){let n=this.json,i=this.nodeMap;n.animations||(n.animations=[]);let s=(e=o.Utils.mergeMorphTargetTracks(e.clone(),t)).tracks,a=[],c=[];for(let e=0;e<s.length;++e){let n,o=s[e],u=r.Nwf.parseTrackName(o.name),h=r.Nwf.findNode(t,u.nodeName),f=l[u.propertyName];if("bones"===u.objectName&&(h=!0===h.isSkinnedMesh?h.skeleton.getBoneByName(u.objectIndex):void 0),!h||!f){console.warn('THREE.GLTFExporter: Could not export animation track "%s".',o.name);continue}let p=o.values.length/o.times.length;f===l.morphTargetInfluences&&(p/=h.morphTargetInfluences.length),!0===o.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(n="CUBICSPLINE",p/=3):n=o.getInterpolation()===r.ljd?"STEP":"LINEAR",c.push({input:this.processAccessor(new r.THS(o.times,1)),output:this.processAccessor(new r.THS(o.values,p)),interpolation:n}),a.push({sampler:c.length-1,target:{node:i.get(h),path:f}})}let u={name:e.name||"clip_"+n.animations.length,samplers:c,channels:a};return this.serializeUserData(e,u),n.animations.push(u),n.animations.length-1}processSkin(e){let t=this.json,n=this.nodeMap,i=t.nodes[n.get(e)],o=e.skeleton;if(void 0===o)return null;let s=e.skeleton.bones[0];if(void 0===s)return null;let a=[],l=new Float32Array(16*o.bones.length),c=new r.kn4;for(let t=0;t<o.bones.length;++t)a.push(n.get(o.bones[t])),c.copy(o.boneInverses[t]),c.multiply(e.bindMatrix).toArray(l,16*t);return void 0===t.skins&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new r.THS(l,16)),joints:a,skeleton:n.get(s)}),i.skin=t.skins.length-1}async processNodeAsync(e){let t=this.json,n=this.options,r=this.nodeMap;t.nodes||(t.nodes=[]);let i={};if(n.trs){let t=e.quaternion.toArray(),n=e.position.toArray(),r=e.scale.toArray();u(t,[0,0,0,1])||(i.rotation=t),u(n,[0,0,0])||(i.translation=n),u(r,[1,1,1])||(i.scale=r)}else e.matrixAutoUpdate&&e.updateMatrix(),!1===u(e.matrix.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])&&(i.matrix=e.matrix.elements);if(""!==e.name&&(i.name=String(e.name)),this.serializeUserData(e,i),e.isMesh||e.isLine||e.isPoints){let t=await this.processMeshAsync(e);null!==t&&(i.mesh=t)}else e.isCamera&&(i.camera=this.processCamera(e));e.isSkinnedMesh&&this.skins.push(e);let o=t.nodes.push(i)-1;if(r.set(e,o),e.children.length>0){let t=[];for(let r=0,i=e.children.length;r<i;r++){let i=e.children[r];if(i.visible||!1===n.onlyVisible){let e=await this.processNodeAsync(i);null!==e&&t.push(e)}}t.length>0&&(i.children=t)}return await this._invokeAllAsync(function(t){t.writeNode&&t.writeNode(e,i)}),o}async processSceneAsync(e){let t=this.json,n=this.options;t.scenes||(t.scenes=[],t.scene=0);let r={};""!==e.name&&(r.name=e.name),t.scenes.push(r);let i=[];for(let t=0,r=e.children.length;t<r;t++){let r=e.children[t];if(r.visible||!1===n.onlyVisible){let e=await this.processNodeAsync(r);null!==e&&i.push(e)}}i.length>0&&(r.nodes=i),this.serializeUserData(e,r)}async processObjectsAsync(e){let t=new r.Z58;t.name="AuxScene";for(let n=0;n<e.length;n++)t.children.push(e[n]);await this.processSceneAsync(t)}async processInputAsync(e){let t=this.options;e=e instanceof Array?e:[e],await this._invokeAllAsync(function(t){t.beforeParse&&t.beforeParse(e)});let n=[];for(let t=0;t<e.length;t++)e[t]instanceof r.Z58?await this.processSceneAsync(e[t]):n.push(e[t]);n.length>0&&await this.processObjectsAsync(n);for(let e=0;e<this.skins.length;++e)this.processSkin(this.skins[e]);for(let n=0;n<t.animations.length;++n)this.processAnimation(t.animations[n],e[0]);await this._invokeAllAsync(function(t){t.afterParse&&t.afterParse(e)})}async _invokeAllAsync(e){for(let t=0,n=this.plugins.length;t<n;t++)await e(this.plugins[t])}}class v{constructor(e){this.writer=e,this.name="KHR_lights_punctual"}writeNode(e,t){if(!e.isLight)return;if(!e.isDirectionalLight&&!e.isPointLight&&!e.isSpotLight)return void console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e);let n=this.writer,r=n.json,i=n.extensionsUsed,o={};e.name&&(o.name=e.name),o.color=e.color.toArray(),o.intensity=e.intensity,e.isDirectionalLight?o.type="directional":e.isPointLight?(o.type="point",e.distance>0&&(o.range=e.distance)):e.isSpotLight&&(o.type="spot",e.distance>0&&(o.range=e.distance),o.spot={},o.spot.innerConeAngle=(1-e.penumbra)*e.angle,o.spot.outerConeAngle=e.angle),void 0!==e.decay&&2!==e.decay&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),e.target&&(e.target.parent!==e||0!==e.target.position.x||0!==e.target.position.y||-1!==e.target.position.z)&&console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),i[this.name]||(r.extensions=r.extensions||{},r.extensions[this.name]={lights:[]},i[this.name]=!0);let s=r.extensions[this.name].lights;s.push(o),t.extensions=t.extensions||{},t.extensions[this.name]={light:s.length-1}}}class y{constructor(e){this.writer=e,this.name="KHR_materials_unlit"}async writeMaterialAsync(e,t){if(!e.isMeshBasicMaterial)return;let n=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},n[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}}class m{constructor(e){this.writer=e,this.name="KHR_materials_clearcoat"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.clearcoat)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.clearcoatFactor=e.clearcoat,e.clearcoatMap){let t={index:await n.processTextureAsync(e.clearcoatMap),texCoord:e.clearcoatMap.channel};n.applyTextureTransform(t,e.clearcoatMap),i.clearcoatTexture=t}if(i.clearcoatRoughnessFactor=e.clearcoatRoughness,e.clearcoatRoughnessMap){let t={index:await n.processTextureAsync(e.clearcoatRoughnessMap),texCoord:e.clearcoatRoughnessMap.channel};n.applyTextureTransform(t,e.clearcoatRoughnessMap),i.clearcoatRoughnessTexture=t}if(e.clearcoatNormalMap){let t={index:await n.processTextureAsync(e.clearcoatNormalMap),texCoord:e.clearcoatNormalMap.channel};1!==e.clearcoatNormalScale.x&&(t.scale=e.clearcoatNormalScale.x),n.applyTextureTransform(t,e.clearcoatNormalMap),i.clearcoatNormalTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class b{constructor(e){this.writer=e,this.name="KHR_materials_dispersion"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.dispersion)return;let n=this.writer.extensionsUsed,r={};r.dispersion=e.dispersion,t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class g{constructor(e){this.writer=e,this.name="KHR_materials_iridescence"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.iridescence)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.iridescenceFactor=e.iridescence,e.iridescenceMap){let t={index:await n.processTextureAsync(e.iridescenceMap),texCoord:e.iridescenceMap.channel};n.applyTextureTransform(t,e.iridescenceMap),i.iridescenceTexture=t}if(i.iridescenceIor=e.iridescenceIOR,i.iridescenceThicknessMinimum=e.iridescenceThicknessRange[0],i.iridescenceThicknessMaximum=e.iridescenceThicknessRange[1],e.iridescenceThicknessMap){let t={index:await n.processTextureAsync(e.iridescenceThicknessMap),texCoord:e.iridescenceThicknessMap.channel};n.applyTextureTransform(t,e.iridescenceThicknessMap),i.iridescenceThicknessTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class w{constructor(e){this.writer=e,this.name="KHR_materials_transmission"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.transmissionFactor=e.transmission,e.transmissionMap){let t={index:await n.processTextureAsync(e.transmissionMap),texCoord:e.transmissionMap.channel};n.applyTextureTransform(t,e.transmissionMap),i.transmissionTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class k{constructor(e){this.writer=e,this.name="KHR_materials_volume"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.thicknessFactor=e.thickness,e.thicknessMap){let t={index:await n.processTextureAsync(e.thicknessMap),texCoord:e.thicknessMap.channel};n.applyTextureTransform(t,e.thicknessMap),i.thicknessTexture=t}e.attenuationDistance!==1/0&&(i.attenuationDistance=e.attenuationDistance),i.attenuationColor=e.attenuationColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class x{constructor(e){this.writer=e,this.name="KHR_materials_ior"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||1.5===e.ior)return;let n=this.writer.extensionsUsed,r={};r.ior=e.ior,t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class T{constructor(e){this.writer=e,this.name="KHR_materials_specular"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||1===e.specularIntensity&&e.specularColor.equals(c)&&!e.specularIntensityMap&&!e.specularColorMap)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.specularIntensityMap){let t={index:await n.processTextureAsync(e.specularIntensityMap),texCoord:e.specularIntensityMap.channel};n.applyTextureTransform(t,e.specularIntensityMap),i.specularTexture=t}if(e.specularColorMap){let t={index:await n.processTextureAsync(e.specularColorMap),texCoord:e.specularColorMap.channel};n.applyTextureTransform(t,e.specularColorMap),i.specularColorTexture=t}i.specularFactor=e.specularIntensity,i.specularColorFactor=e.specularColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class P{constructor(e){this.writer=e,this.name="KHR_materials_sheen"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0==e.sheen)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.sheenRoughnessMap){let t={index:await n.processTextureAsync(e.sheenRoughnessMap),texCoord:e.sheenRoughnessMap.channel};n.applyTextureTransform(t,e.sheenRoughnessMap),i.sheenRoughnessTexture=t}if(e.sheenColorMap){let t={index:await n.processTextureAsync(e.sheenColorMap),texCoord:e.sheenColorMap.channel};n.applyTextureTransform(t,e.sheenColorMap),i.sheenColorTexture=t}i.sheenRoughnessFactor=e.sheenRoughness,i.sheenColorFactor=e.sheenColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class S{constructor(e){this.writer=e,this.name="KHR_materials_anisotropy"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0==e.anisotropy)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.anisotropyMap){let t={index:await n.processTextureAsync(e.anisotropyMap)};n.applyTextureTransform(t,e.anisotropyMap),i.anisotropyTexture=t}i.anisotropyStrength=e.anisotropy,i.anisotropyRotation=e.anisotropyRotation,t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class R{constructor(e){this.writer=e,this.name="KHR_materials_emissive_strength"}async writeMaterialAsync(e,t){if(!e.isMeshStandardMaterial||1===e.emissiveIntensity)return;let n=this.writer.extensionsUsed,r={};r.emissiveStrength=e.emissiveIntensity,t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class O{constructor(e){this.writer=e,this.name="EXT_materials_bump"}async writeMaterialAsync(e,t){if(!e.isMeshStandardMaterial||1===e.bumpScale&&!e.bumpMap)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.bumpMap){let t={index:await n.processTextureAsync(e.bumpMap),texCoord:e.bumpMap.channel};n.applyTextureTransform(t,e.bumpMap),i.bumpTexture=t}i.bumpFactor=e.bumpScale,t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class E{constructor(e){this.writer=e,this.name="EXT_mesh_gpu_instancing"}writeNode(e,t){if(!e.isInstancedMesh)return;let n=this.writer,i=new Float32Array(3*e.count),o=new Float32Array(4*e.count),s=new Float32Array(3*e.count),a=new r.kn4,l=new r.Pq0,c=new r.PTz,u=new r.Pq0;for(let t=0;t<e.count;t++)e.getMatrixAt(t,a),a.decompose(l,c,u),l.toArray(i,3*t),c.toArray(o,4*t),u.toArray(s,3*t);let h={TRANSLATION:n.processAccessor(new r.THS(i,3)),ROTATION:n.processAccessor(new r.THS(o,4)),SCALE:n.processAccessor(new r.THS(s,3))};e.instanceColor&&(h._COLOR_0=n.processAccessor(e.instanceColor)),t.extensions=t.extensions||{},t.extensions[this.name]={attributes:h},n.extensionsUsed[this.name]=!0,n.extensionsRequired[this.name]=!0}}function A(e,t){if(t===r.RJ4)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(t!==r.rYR&&t!==r.O49)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),e;{let n=e.getIndex();if(null===n){let t=[],r=e.getAttribute("position");if(void 0===r)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<r.count;e++)t.push(e);e.setIndex(t),n=e.getIndex()}let i=n.count-2,o=[];if(t===r.rYR)for(let e=1;e<=i;e++)o.push(n.getX(0)),o.push(n.getX(e)),o.push(n.getX(e+1));else for(let e=0;e<i;e++)e%2==0?(o.push(n.getX(e)),o.push(n.getX(e+1)),o.push(n.getX(e+2))):(o.push(n.getX(e+2)),o.push(n.getX(e+1)),o.push(n.getX(e)));o.length/3!==i&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");let s=e.clone();return s.setIndex(o),s.clearGroups(),s}}o.Utils={insertKeyframe:function(e,t){let n,r=e.getValueSize(),i=new e.TimeBufferType(e.times.length+1),o=new e.ValueBufferType(e.values.length+r),s=e.createInterpolant(new e.ValueBufferType(r));if(0===e.times.length){i[0]=t;for(let e=0;e<r;e++)o[e]=0;n=0}else if(t<e.times[0]){if(.001>Math.abs(e.times[0]-t))return 0;i[0]=t,i.set(e.times,1),o.set(s.evaluate(t),0),o.set(e.values,r),n=0}else if(t>e.times[e.times.length-1]){if(.001>Math.abs(e.times[e.times.length-1]-t))return e.times.length-1;i[i.length-1]=t,i.set(e.times,0),o.set(e.values,0),o.set(s.evaluate(t),e.values.length),n=i.length-1}else for(let a=0;a<e.times.length;a++){if(.001>Math.abs(e.times[a]-t))return a;if(e.times[a]<t&&e.times[a+1]>t){i.set(e.times.slice(0,a+1),0),i[a+1]=t,i.set(e.times.slice(a+1),a+2),o.set(e.values.slice(0,(a+1)*r),0),o.set(s.evaluate(t),(a+1)*r),o.set(e.values.slice((a+1)*r),(a+2)*r),n=a+1;break}}return e.times=i,e.values=o,n},mergeMorphTargetTracks:function(e,t){let n=[],i={},o=e.tracks;for(let e=0;e<o.length;++e){let s,a=o[e],l=r.Nwf.parseTrackName(a.name),c=r.Nwf.findNode(t,l.nodeName);if("morphTargetInfluences"!==l.propertyName||void 0===l.propertyIndex){n.push(a);continue}if(a.createInterpolant!==a.InterpolantFactoryMethodDiscrete&&a.createInterpolant!==a.InterpolantFactoryMethodLinear){if(a.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),(a=a.clone()).setInterpolation(r.PJ3)}let u=c.morphTargetInfluences.length,h=c.morphTargetDictionary[l.propertyIndex];if(void 0===h)throw Error("THREE.GLTFExporter: Morph target name not found: "+l.propertyIndex);if(void 0===i[c.uuid]){let e=new(s=a.clone()).ValueBufferType(u*s.times.length);for(let t=0;t<s.times.length;t++)e[t*u+h]=s.values[t];s.name=(l.nodeName||"")+".morphTargetInfluences",s.values=e,i[c.uuid]=s,n.push(s);continue}let f=a.createInterpolant(new a.ValueBufferType(1));s=i[c.uuid];for(let e=0;e<s.times.length;e++)s.values[e*u+h]=f.evaluate(s.times[e]);for(let e=0;e<a.times.length;e++){let t=this.insertKeyframe(s,a.times[e]);s.values[t*u+h]=a.values[e]}}return e.tracks=n,e},toFloat32BufferAttribute:function(e){let t=new r.THS(new Float32Array(e.count*e.itemSize),e.itemSize,!1);if(!e.normalized&&!e.isInterleavedBufferAttribute)return t.array.set(e.array),t;for(let n=0,r=e.count;n<r;n++)for(let r=0;r<e.itemSize;r++)t.setComponent(n,r,e.getComponent(n,r));return t}};class M extends r.aHM{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(e){return new L(e)}),this.register(function(e){return new N(e)}),this.register(function(e){return new K(e)}),this.register(function(e){return new X(e)}),this.register(function(e){return new W(e)}),this.register(function(e){return new H(e)}),this.register(function(e){return new U(e)}),this.register(function(e){return new D(e)}),this.register(function(e){return new z(e)}),this.register(function(e){return new B(e)}),this.register(function(e){return new G(e)}),this.register(function(e){return new F(e)}),this.register(function(e){return new q(e)}),this.register(function(e){return new V(e)}),this.register(function(e){return new C(e)}),this.register(function(e){return new Y(e)}),this.register(function(e){return new J(e)})}load(e,t,n,i){let o,s=this;if(""!==this.resourcePath)o=this.resourcePath;else if(""!==this.path){let t=r.r6x.extractUrlBase(e);o=r.r6x.resolveURL(t,this.path)}else o=r.r6x.extractUrlBase(e);this.manager.itemStart(e);let a=function(t){i?i(t):console.error(t),s.manager.itemError(e),s.manager.itemEnd(e)},l=new r.Y9S(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials),l.load(e,function(n){try{s.parse(n,o,function(n){t(n),s.manager.itemEnd(e)},a)}catch(e){a(e)}},n,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return -1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return -1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,n,r){let i,o={},s={},a=new TextDecoder;if("string"==typeof e)i=JSON.parse(e);else if(e instanceof ArrayBuffer)if(a.decode(new Uint8Array(e,0,4))===Q){try{o[I.KHR_BINARY_GLTF]=new Z(e)}catch(e){r&&r(e);return}i=JSON.parse(o[I.KHR_BINARY_GLTF].content)}else i=JSON.parse(a.decode(e));else i=e;if(void 0===i.asset||i.asset.version[0]<2){r&&r(Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}let l=new eb(i,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){let t=this.pluginCallbacks[e](l);t.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),s[t.name]=t,o[t.name]=!0}if(i.extensionsUsed)for(let e=0;e<i.extensionsUsed.length;++e){let t=i.extensionsUsed[e],n=i.extensionsRequired||[];switch(t){case I.KHR_MATERIALS_UNLIT:o[t]=new j;break;case I.KHR_DRACO_MESH_COMPRESSION:o[t]=new $(i,this.dracoLoader);break;case I.KHR_TEXTURE_TRANSFORM:o[t]=new ee;break;case I.KHR_MESH_QUANTIZATION:o[t]=new et;break;default:n.indexOf(t)>=0&&void 0===s[t]&&console.warn('THREE.GLTFLoader: Unknown extension "'+t+'".')}}l.setExtensions(o),l.setPlugins(s),l.parse(n,r)}parseAsync(e,t){let n=this;return new Promise(function(r,i){n.parse(e,t,r,i)})}}function _(){let e={};return{get:function(t){return e[t]},add:function(t,n){e[t]=n},remove:function(t){delete e[t]},removeAll:function(){e={}}}}let I={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class C{constructor(e){this.parser=e,this.name=I.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){let e=this.parser,t=this.parser.json.nodes||[];for(let n=0,r=t.length;n<r;n++){let r=t[n];r.extensions&&r.extensions[this.name]&&void 0!==r.extensions[this.name].light&&e._addNodeRef(this.cache,r.extensions[this.name].light)}}_loadLight(e){let t,n=this.parser,i="light:"+e,o=n.cache.get(i);if(o)return o;let s=n.json,a=((s.extensions&&s.extensions[this.name]||{}).lights||[])[e],l=new r.Q1f(0xffffff);void 0!==a.color&&l.setRGB(a.color[0],a.color[1],a.color[2],r.Zr2);let c=void 0!==a.range?a.range:0;switch(a.type){case"directional":(t=new r.ZyN(l)).target.position.set(0,0,-1),t.add(t.target);break;case"point":(t=new r.HiM(l)).distance=c;break;case"spot":(t=new r.nCl(l)).distance=c,a.spot=a.spot||{},a.spot.innerConeAngle=void 0!==a.spot.innerConeAngle?a.spot.innerConeAngle:0,a.spot.outerConeAngle=void 0!==a.spot.outerConeAngle?a.spot.outerConeAngle:Math.PI/4,t.angle=a.spot.outerConeAngle,t.penumbra=1-a.spot.innerConeAngle/a.spot.outerConeAngle,t.target.position.set(0,0,-1),t.add(t.target);break;default:throw Error("THREE.GLTFLoader: Unexpected light type: "+a.type)}return t.position.set(0,0,0),ed(t,a),void 0!==a.intensity&&(t.intensity=a.intensity),t.name=n.createUniqueName(a.name||"light_"+e),o=Promise.resolve(t),n.cache.add(i,o),o}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){let t=this,n=this.parser,r=n.json.nodes[e],i=(r.extensions&&r.extensions[this.name]||{}).light;return void 0===i?null:this._loadLight(i).then(function(e){return n._getNodeRef(t.cache,i,e)})}}class j{constructor(){this.name=I.KHR_MATERIALS_UNLIT}getMaterialType(){return r.V9B}extendParams(e,t,n){let i=[];e.color=new r.Q1f(1,1,1),e.opacity=1;let o=t.pbrMetallicRoughness;if(o){if(Array.isArray(o.baseColorFactor)){let t=o.baseColorFactor;e.color.setRGB(t[0],t[1],t[2],r.Zr2),e.opacity=t[3]}void 0!==o.baseColorTexture&&i.push(n.assignTexture(e,"map",o.baseColorTexture,r.er$))}return Promise.all(i)}}class B{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){let n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=n.extensions[this.name].emissiveStrength;return void 0!==r&&(t.emissiveIntensity=r),Promise.resolve()}}class L{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let o=[],s=i.extensions[this.name];if(void 0!==s.clearcoatFactor&&(t.clearcoat=s.clearcoatFactor),void 0!==s.clearcoatTexture&&o.push(n.assignTexture(t,"clearcoatMap",s.clearcoatTexture)),void 0!==s.clearcoatRoughnessFactor&&(t.clearcoatRoughness=s.clearcoatRoughnessFactor),void 0!==s.clearcoatRoughnessTexture&&o.push(n.assignTexture(t,"clearcoatRoughnessMap",s.clearcoatRoughnessTexture)),void 0!==s.clearcoatNormalTexture&&(o.push(n.assignTexture(t,"clearcoatNormalMap",s.clearcoatNormalTexture)),void 0!==s.clearcoatNormalTexture.scale)){let e=s.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new r.I9Y(e,e)}return Promise.all(o)}}class N{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_DISPERSION}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=n.extensions[this.name];return t.dispersion=void 0!==r.dispersion?r.dispersion:0,Promise.resolve()}}class F{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],o=r.extensions[this.name];return void 0!==o.iridescenceFactor&&(t.iridescence=o.iridescenceFactor),void 0!==o.iridescenceTexture&&i.push(n.assignTexture(t,"iridescenceMap",o.iridescenceTexture)),void 0!==o.iridescenceIor&&(t.iridescenceIOR=o.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==o.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),void 0!==o.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),void 0!==o.iridescenceThicknessTexture&&i.push(n.assignTexture(t,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(i)}}class H{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_SHEEN}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let o=[];t.sheenColor=new r.Q1f(0,0,0),t.sheenRoughness=0,t.sheen=1;let s=i.extensions[this.name];if(void 0!==s.sheenColorFactor){let e=s.sheenColorFactor;t.sheenColor.setRGB(e[0],e[1],e[2],r.Zr2)}return void 0!==s.sheenRoughnessFactor&&(t.sheenRoughness=s.sheenRoughnessFactor),void 0!==s.sheenColorTexture&&o.push(n.assignTexture(t,"sheenColorMap",s.sheenColorTexture,r.er$)),void 0!==s.sheenRoughnessTexture&&o.push(n.assignTexture(t,"sheenRoughnessMap",s.sheenRoughnessTexture)),Promise.all(o)}}class U{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],o=r.extensions[this.name];return void 0!==o.transmissionFactor&&(t.transmission=o.transmissionFactor),void 0!==o.transmissionTexture&&i.push(n.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(i)}}class D{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_VOLUME}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let o=[],s=i.extensions[this.name];t.thickness=void 0!==s.thicknessFactor?s.thicknessFactor:0,void 0!==s.thicknessTexture&&o.push(n.assignTexture(t,"thicknessMap",s.thicknessTexture)),t.attenuationDistance=s.attenuationDistance||1/0;let a=s.attenuationColor||[1,1,1];return t.attenuationColor=new r.Q1f().setRGB(a[0],a[1],a[2],r.Zr2),Promise.all(o)}}class z{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_IOR}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=n.extensions[this.name];return t.ior=void 0!==r.ior?r.ior:1.5,Promise.resolve()}}class G{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_SPECULAR}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let o=[],s=i.extensions[this.name];t.specularIntensity=void 0!==s.specularFactor?s.specularFactor:1,void 0!==s.specularTexture&&o.push(n.assignTexture(t,"specularIntensityMap",s.specularTexture));let a=s.specularColorFactor||[1,1,1];return t.specularColor=new r.Q1f().setRGB(a[0],a[1],a[2],r.Zr2),void 0!==s.specularColorTexture&&o.push(n.assignTexture(t,"specularColorMap",s.specularColorTexture,r.er$)),Promise.all(o)}}class V{constructor(e){this.parser=e,this.name=I.EXT_MATERIALS_BUMP}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],o=r.extensions[this.name];return t.bumpScale=void 0!==o.bumpFactor?o.bumpFactor:1,void 0!==o.bumpTexture&&i.push(n.assignTexture(t,"bumpMap",o.bumpTexture)),Promise.all(i)}}class q{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],o=r.extensions[this.name];return void 0!==o.anisotropyStrength&&(t.anisotropy=o.anisotropyStrength),void 0!==o.anisotropyRotation&&(t.anisotropyRotation=o.anisotropyRotation),void 0!==o.anisotropyTexture&&i.push(n.assignTexture(t,"anisotropyMap",o.anisotropyTexture)),Promise.all(i)}}class K{constructor(e){this.parser=e,this.name=I.KHR_TEXTURE_BASISU}loadTexture(e){let t=this.parser,n=t.json,r=n.textures[e];if(!r.extensions||!r.extensions[this.name])return null;let i=r.extensions[this.name],o=t.options.ktx2Loader;if(!o)if(!(n.extensionsRequired&&n.extensionsRequired.indexOf(this.name)>=0))return null;else throw Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return t.loadTextureImage(e,i.source,o)}}class X{constructor(e){this.parser=e,this.name=I.EXT_TEXTURE_WEBP}loadTexture(e){let t=this.name,n=this.parser,r=n.json,i=r.textures[e];if(!i.extensions||!i.extensions[t])return null;let o=i.extensions[t],s=r.images[o.source],a=n.textureLoader;if(s.uri){let e=n.options.manager.getHandler(s.uri);null!==e&&(a=e)}return n.loadTextureImage(e,o.source,a)}}class W{constructor(e){this.parser=e,this.name=I.EXT_TEXTURE_AVIF}loadTexture(e){let t=this.name,n=this.parser,r=n.json,i=r.textures[e];if(!i.extensions||!i.extensions[t])return null;let o=i.extensions[t],s=r.images[o.source],a=n.textureLoader;if(s.uri){let e=n.options.manager.getHandler(s.uri);null!==e&&(a=e)}return n.loadTextureImage(e,o.source,a)}}class Y{constructor(e){this.name=I.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){let t=this.parser.json,n=t.bufferViews[e];if(!n.extensions||!n.extensions[this.name])return null;{let e=n.extensions[this.name],r=this.parser.getDependency("buffer",e.buffer),i=this.parser.options.meshoptDecoder;if(!i||!i.supported)if(!(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0))return null;else throw Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return r.then(function(t){let n=e.byteOffset||0,r=e.byteLength||0,o=e.count,s=e.byteStride,a=new Uint8Array(t,n,r);return i.decodeGltfBufferAsync?i.decodeGltfBufferAsync(o,s,a,e.mode,e.filter).then(function(e){return e.buffer}):i.ready.then(function(){let t=new ArrayBuffer(o*s);return i.decodeGltfBuffer(new Uint8Array(t),o,s,a,e.mode,e.filter),t})})}}}class J{constructor(e){this.name=I.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){let t=this.parser.json,n=t.nodes[e];if(!n.extensions||!n.extensions[this.name]||void 0===n.mesh)return null;for(let e of t.meshes[n.mesh].primitives)if(e.mode!==eo.TRIANGLES&&e.mode!==eo.TRIANGLE_STRIP&&e.mode!==eo.TRIANGLE_FAN&&void 0!==e.mode)return null;let i=n.extensions[this.name].attributes,o=[],s={};for(let e in i)o.push(this.parser.getDependency("accessor",i[e]).then(t=>(s[e]=t,s[e])));return o.length<1?null:(o.push(this.parser.createNodeMesh(e)),Promise.all(o).then(e=>{let t=e.pop(),n=t.isGroup?t.children:[t],i=e[0].count,o=[];for(let e of n){let t=new r.kn4,n=new r.Pq0,a=new r.PTz,l=new r.Pq0(1,1,1),c=new r.ZLX(e.geometry,e.material,i);for(let e=0;e<i;e++)s.TRANSLATION&&n.fromBufferAttribute(s.TRANSLATION,e),s.ROTATION&&a.fromBufferAttribute(s.ROTATION,e),s.SCALE&&l.fromBufferAttribute(s.SCALE,e),c.setMatrixAt(e,t.compose(n,a,l));for(let t in s)if("_COLOR_0"===t){let e=s[t];c.instanceColor=new r.uWO(e.array,e.itemSize,e.normalized)}else"TRANSLATION"!==t&&"ROTATION"!==t&&"SCALE"!==t&&e.geometry.setAttribute(t,s[t]);r.B69.prototype.copy.call(c,e),this.parser.assignFinalMaterial(c),o.push(c)}return t.isGroup?(t.clear(),t.add(...o),t):o[0]}))}}let Q="glTF";class Z{constructor(e){this.name=I.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12),n=new TextDecoder;if(this.header={magic:n.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Q)throw Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw Error("THREE.GLTFLoader: Legacy binary file detected.");const r=this.header.length-12,i=new DataView(e,12);let o=0;for(;o<r;){const t=i.getUint32(o,!0);o+=4;const r=i.getUint32(o,!0);if(o+=4,0x4e4f534a===r){const r=new Uint8Array(e,12+o,t);this.content=n.decode(r)}else if(5130562===r){const n=12+o;this.body=e.slice(n,n+t)}o+=t}if(null===this.content)throw Error("THREE.GLTFLoader: JSON content not found.")}}class ${constructor(e,t){if(!t)throw Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=I.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){let n=this.json,i=this.dracoLoader,o=e.extensions[this.name].bufferView,s=e.extensions[this.name].attributes,a={},l={},c={};for(let e in s)a[eu[e]||e.toLowerCase()]=s[e];for(let t in e.attributes){let r=eu[t]||t.toLowerCase();if(void 0!==s[t]){let i=n.accessors[e.attributes[t]],o=es[i.componentType];c[r]=o.name,l[r]=!0===i.normalized}}return t.getDependency("bufferView",o).then(function(e){return new Promise(function(t,n){i.decodeDracoFile(e,function(e){for(let t in e.attributes){let n=e.attributes[t],r=l[t];void 0!==r&&(n.normalized=r)}t(e)},a,c,r.Zr2,n)})})}}class ee{constructor(){this.name=I.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(void 0===t.texCoord||t.texCoord===e.channel)&&void 0===t.offset&&void 0===t.rotation&&void 0===t.scale||(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class et{constructor(){this.name=I.KHR_MESH_QUANTIZATION}}class en extends r.lGw{constructor(e,t,n,r){super(e,t,n,r)}copySampleValue_(e){let t=this.resultBuffer,n=this.sampleValues,r=this.valueSize,i=e*r*3+r;for(let e=0;e!==r;e++)t[e]=n[i+e];return t}interpolate_(e,t,n,r){let i=this.resultBuffer,o=this.sampleValues,s=this.valueSize,a=2*s,l=3*s,c=r-t,u=(n-t)/c,h=u*u,f=h*u,p=e*l,d=p-l,v=-2*f+3*h,y=f-h,m=1-v,b=y-h+u;for(let e=0;e!==s;e++){let t=o[d+e+s],n=o[d+e+a]*c,r=o[p+e+s],l=o[p+e]*c;i[e]=m*t+b*n+v*r+y*l}return i}}let er=new r.PTz;class ei extends en{interpolate_(e,t,n,r){let i=super.interpolate_(e,t,n,r);return er.fromArray(i).normalize().toArray(i),i}}let eo={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},es={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},ea={9728:r.hxR,9729:r.k6q,9984:r.pHI,9985:r.kRr,9986:r.Cfg,9987:r.$_I},el={33071:r.ghU,33648:r.kTW,10497:r.GJx},ec={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},eu={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},eh={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},ef={CUBICSPLINE:void 0,LINEAR:r.PJ3,STEP:r.ljd};function ep(e,t,n){for(let r in n.extensions)void 0===e[r]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[r]=n.extensions[r])}function ed(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function ev(e){let t="",n=Object.keys(e).sort();for(let r=0,i=n.length;r<i;r++)t+=n[r]+":"+e[n[r]]+";";return t}function ey(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}let em=new r.kn4;class eb{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new _,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let n=!1,i=-1,o=!1,s=-1;if("u">typeof navigator){const e=navigator.userAgent;n=!0===/^((?!chrome|android).)*safari/i.test(e);const t=e.match(/Version\/(\d+)/);i=n&&t?parseInt(t[1],10):-1,s=(o=e.indexOf("Firefox")>-1)?e.match(/Firefox\/([0-9]+)\./)[1]:-1}"u"<typeof createImageBitmap||n&&i<17||o&&s<98?this.textureLoader=new r.Tap(this.options.manager):this.textureLoader=new r.Kzg(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new r.Y9S(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){let n=this,r=this.json,i=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(e){return e._markDefs&&e._markDefs()}),Promise.all(this._invokeAll(function(e){return e.beforeRoot&&e.beforeRoot()})).then(function(){return Promise.all([n.getDependencies("scene"),n.getDependencies("animation"),n.getDependencies("camera")])}).then(function(t){let o={scene:t[0][r.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:r.asset,parser:n,userData:{}};return ep(i,o,r),ed(o,r),Promise.all(n._invokeAll(function(e){return e.afterRoot&&e.afterRoot(o)})).then(function(){for(let e of o.scenes)e.updateMatrixWorld();e(o)})}).catch(t)}_markDefs(){let e=this.json.nodes||[],t=this.json.skins||[],n=this.json.meshes||[];for(let n=0,r=t.length;n<r;n++){let r=t[n].joints;for(let t=0,n=r.length;t<n;t++)e[r[t]].isBone=!0}for(let t=0,r=e.length;t<r;t++){let r=e[t];void 0!==r.mesh&&(this._addNodeRef(this.meshCache,r.mesh),void 0!==r.skin&&(n[r.mesh].isSkinnedMesh=!0)),void 0!==r.camera&&this._addNodeRef(this.cameraCache,r.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,n){if(e.refs[t]<=1)return n;let r=n.clone(),i=(e,t)=>{let n=this.associations.get(e);for(let[r,o]of(null!=n&&this.associations.set(t,n),e.children.entries()))i(o,t.children[r])};return i(n,r),r.name+="_instance_"+e.uses[t]++,r}_invokeOne(e){let t=Object.values(this.plugins);t.push(this);for(let n=0;n<t.length;n++){let r=e(t[n]);if(r)return r}return null}_invokeAll(e){let t=Object.values(this.plugins);t.unshift(this);let n=[];for(let r=0;r<t.length;r++){let i=e(t[r]);i&&n.push(i)}return n}getDependency(e,t){let n=e+":"+t,r=this.cache.get(n);if(!r){switch(e){case"scene":r=this.loadScene(t);break;case"node":r=this._invokeOne(function(e){return e.loadNode&&e.loadNode(t)});break;case"mesh":r=this._invokeOne(function(e){return e.loadMesh&&e.loadMesh(t)});break;case"accessor":r=this.loadAccessor(t);break;case"bufferView":r=this._invokeOne(function(e){return e.loadBufferView&&e.loadBufferView(t)});break;case"buffer":r=this.loadBuffer(t);break;case"material":r=this._invokeOne(function(e){return e.loadMaterial&&e.loadMaterial(t)});break;case"texture":r=this._invokeOne(function(e){return e.loadTexture&&e.loadTexture(t)});break;case"skin":r=this.loadSkin(t);break;case"animation":r=this._invokeOne(function(e){return e.loadAnimation&&e.loadAnimation(t)});break;case"camera":r=this.loadCamera(t);break;default:if(!(r=this._invokeOne(function(n){return n!=this&&n.getDependency&&n.getDependency(e,t)})))throw Error("Unknown type: "+e)}this.cache.add(n,r)}return r}getDependencies(e){let t=this.cache.get(e);if(!t){let n=this;t=Promise.all((this.json[e+("mesh"===e?"es":"s")]||[]).map(function(t,r){return n.getDependency(e,r)})),this.cache.add(e,t)}return t}loadBuffer(e){let t=this.json.buffers[e],n=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[I.KHR_BINARY_GLTF].body);let i=this.options;return new Promise(function(e,o){n.load(r.r6x.resolveURL(t.uri,i.path),e,void 0,function(){o(Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){let t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(e){let n=t.byteLength||0,r=t.byteOffset||0;return e.slice(r,r+n)})}loadAccessor(e){let t=this,n=this.json,i=this.json.accessors[e];if(void 0===i.bufferView&&void 0===i.sparse){let e=ec[i.type],t=es[i.componentType],n=!0===i.normalized,o=new t(i.count*e);return Promise.resolve(new r.THS(o,e,n))}let o=[];return void 0!==i.bufferView?o.push(this.getDependency("bufferView",i.bufferView)):o.push(null),void 0!==i.sparse&&(o.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),o.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(o).then(function(e){let o,s,a=e[0],l=ec[i.type],c=es[i.componentType],u=c.BYTES_PER_ELEMENT,h=u*l,f=i.byteOffset||0,p=void 0!==i.bufferView?n.bufferViews[i.bufferView].byteStride:void 0,d=!0===i.normalized;if(p&&p!==h){let e=Math.floor(f/p),n="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+e+":"+i.count,h=t.cache.get(n);h||(o=new c(a,e*p,i.count*p/u),h=new r.eB$(o,p/u),t.cache.add(n,h)),s=new r.eHs(h,l,f%p/u,d)}else o=null===a?new c(i.count*l):new c(a,f,i.count*l),s=new r.THS(o,l,d);if(void 0!==i.sparse){let t=ec.SCALAR,n=es[i.sparse.indices.componentType],o=i.sparse.indices.byteOffset||0,u=i.sparse.values.byteOffset||0,h=new n(e[1],o,i.sparse.count*t),f=new c(e[2],u,i.sparse.count*l);null!==a&&(s=new r.THS(s.array.slice(),s.itemSize,s.normalized)),s.normalized=!1;for(let e=0,t=h.length;e<t;e++){let t=h[e];if(s.setX(t,f[e*l]),l>=2&&s.setY(t,f[e*l+1]),l>=3&&s.setZ(t,f[e*l+2]),l>=4&&s.setW(t,f[e*l+3]),l>=5)throw Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}s.normalized=d}return s})}loadTexture(e){let t=this.json,n=this.options,r=t.textures[e].source,i=t.images[r],o=this.textureLoader;if(i.uri){let e=n.manager.getHandler(i.uri);null!==e&&(o=e)}return this.loadTextureImage(e,r,o)}loadTextureImage(e,t,n){let i=this,o=this.json,s=o.textures[e],a=o.images[t],l=(a.uri||a.bufferView)+":"+s.sampler;if(this.textureCache[l])return this.textureCache[l];let c=this.loadImageSource(t,n).then(function(t){t.flipY=!1,t.name=s.name||a.name||"",""===t.name&&"string"==typeof a.uri&&!1===a.uri.startsWith("data:image/")&&(t.name=a.uri);let n=(o.samplers||{})[s.sampler]||{};return t.magFilter=ea[n.magFilter]||r.k6q,t.minFilter=ea[n.minFilter]||r.$_I,t.wrapS=el[n.wrapS]||r.GJx,t.wrapT=el[n.wrapT]||r.GJx,t.generateMipmaps=!t.isCompressedTexture&&t.minFilter!==r.hxR&&t.minFilter!==r.k6q,i.associations.set(t,{textures:e}),t}).catch(function(){return null});return this.textureCache[l]=c,c}loadImageSource(e,t){let n=this.json,i=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then(e=>e.clone());let o=n.images[e],s=self.URL||self.webkitURL,a=o.uri||"",l=!1;if(void 0!==o.bufferView)a=this.getDependency("bufferView",o.bufferView).then(function(e){l=!0;let t=new Blob([e],{type:o.mimeType});return a=s.createObjectURL(t)});else if(void 0===o.uri)throw Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");let c=Promise.resolve(a).then(function(e){return new Promise(function(n,o){let s=n;!0===t.isImageBitmapLoader&&(s=function(e){let t=new r.gPd(e);t.needsUpdate=!0,n(t)}),t.load(r.r6x.resolveURL(e,i.path),s,void 0,o)})}).then(function(e){var t;return!0===l&&s.revokeObjectURL(a),ed(e,o),e.userData.mimeType=o.mimeType||((t=o.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":t.search(/\.ktx2($|\?)/i)>0||0===t.search(/^data\:image\/ktx2/)?"image/ktx2":"image/png"),e}).catch(function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",a),e});return this.sourceCache[e]=c,c}assignTexture(e,t,n,r){let i=this;return this.getDependency("texture",n.index).then(function(o){if(!o)return null;if(void 0!==n.texCoord&&n.texCoord>0&&((o=o.clone()).channel=n.texCoord),i.extensions[I.KHR_TEXTURE_TRANSFORM]){let e=void 0!==n.extensions?n.extensions[I.KHR_TEXTURE_TRANSFORM]:void 0;if(e){let t=i.associations.get(o);o=i.extensions[I.KHR_TEXTURE_TRANSFORM].extendTexture(o,e),i.associations.set(o,t)}}return void 0!==r&&(o.colorSpace=r),e[t]=o,o})}assignFinalMaterial(e){let t=e.geometry,n=e.material,i=void 0===t.attributes.tangent,o=void 0!==t.attributes.color,s=void 0===t.attributes.normal;if(e.isPoints){let e="PointsMaterial:"+n.uuid,t=this.cache.get(e);t||(t=new r.BH$,r.imn.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,t.sizeAttenuation=!1,this.cache.add(e,t)),n=t}else if(e.isLine){let e="LineBasicMaterial:"+n.uuid,t=this.cache.get(e);t||(t=new r.mrM,r.imn.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,this.cache.add(e,t)),n=t}if(i||o||s){let e="ClonedMaterial:"+n.uuid+":";i&&(e+="derivative-tangents:"),o&&(e+="vertex-colors:"),s&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=n.clone(),o&&(t.vertexColors=!0),s&&(t.flatShading=!0),i&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(n))),n=t}e.material=n}getMaterialType(){return r._4j}loadMaterial(e){let t,n=this,i=this.json,o=this.extensions,s=i.materials[e],a={},l=s.extensions||{},c=[];if(l[I.KHR_MATERIALS_UNLIT]){let e=o[I.KHR_MATERIALS_UNLIT];t=e.getMaterialType(),c.push(e.extendParams(a,s,n))}else{let i=s.pbrMetallicRoughness||{};if(a.color=new r.Q1f(1,1,1),a.opacity=1,Array.isArray(i.baseColorFactor)){let e=i.baseColorFactor;a.color.setRGB(e[0],e[1],e[2],r.Zr2),a.opacity=e[3]}void 0!==i.baseColorTexture&&c.push(n.assignTexture(a,"map",i.baseColorTexture,r.er$)),a.metalness=void 0!==i.metallicFactor?i.metallicFactor:1,a.roughness=void 0!==i.roughnessFactor?i.roughnessFactor:1,void 0!==i.metallicRoughnessTexture&&(c.push(n.assignTexture(a,"metalnessMap",i.metallicRoughnessTexture)),c.push(n.assignTexture(a,"roughnessMap",i.metallicRoughnessTexture))),t=this._invokeOne(function(t){return t.getMaterialType&&t.getMaterialType(e)}),c.push(Promise.all(this._invokeAll(function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,a)})))}!0===s.doubleSided&&(a.side=r.$EB);let u=s.alphaMode||"OPAQUE";if("BLEND"===u?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,"MASK"===u&&(a.alphaTest=void 0!==s.alphaCutoff?s.alphaCutoff:.5)),void 0!==s.normalTexture&&t!==r.V9B&&(c.push(n.assignTexture(a,"normalMap",s.normalTexture)),a.normalScale=new r.I9Y(1,1),void 0!==s.normalTexture.scale)){let e=s.normalTexture.scale;a.normalScale.set(e,e)}if(void 0!==s.occlusionTexture&&t!==r.V9B&&(c.push(n.assignTexture(a,"aoMap",s.occlusionTexture)),void 0!==s.occlusionTexture.strength&&(a.aoMapIntensity=s.occlusionTexture.strength)),void 0!==s.emissiveFactor&&t!==r.V9B){let e=s.emissiveFactor;a.emissive=new r.Q1f().setRGB(e[0],e[1],e[2],r.Zr2)}return void 0!==s.emissiveTexture&&t!==r.V9B&&c.push(n.assignTexture(a,"emissiveMap",s.emissiveTexture,r.er$)),Promise.all(c).then(function(){let r=new t(a);return s.name&&(r.name=s.name),ed(r,s),n.associations.set(r,{materials:e}),s.extensions&&ep(o,r,s),r})}createUniqueName(e){let t=r.Nwf.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){let t=this,n=this.extensions,i=this.primitiveCache,o=[];for(let s=0,a=e.length;s<a;s++){let a=e[s],l=function(e){let t,n=e.extensions&&e.extensions[I.KHR_DRACO_MESH_COMPRESSION];if(t=n?"draco:"+n.bufferView+":"+n.indices+":"+ev(n.attributes):e.indices+":"+ev(e.attributes)+":"+e.mode,void 0!==e.targets)for(let n=0,r=e.targets.length;n<r;n++)t+=":"+ev(e.targets[n]);return t}(a),c=i[l];if(c)o.push(c.promise);else{let e;e=a.extensions&&a.extensions[I.KHR_DRACO_MESH_COMPRESSION]?function(e){return n[I.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then(function(n){return eg(n,e,t)})}(a):eg(new r.LoY,a,t),i[l]={primitive:a,promise:e},o.push(e)}}return Promise.all(o)}loadMesh(e){let t=this,n=this.json,i=this.extensions,o=n.meshes[e],s=o.primitives,a=[];for(let e=0,t=s.length;e<t;e++){var l;let t=void 0===s[e].material?(void 0===(l=this.cache).DefaultMaterial&&(l.DefaultMaterial=new r._4j({color:0xffffff,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:r.hB5})),l.DefaultMaterial):this.getDependency("material",s[e].material);a.push(t)}return a.push(t.loadGeometries(s)),Promise.all(a).then(function(n){let a=n.slice(0,n.length-1),l=n[n.length-1],c=[];for(let n=0,u=l.length;n<u;n++){let u,h=l[n],f=s[n],p=a[n];if(f.mode===eo.TRIANGLES||f.mode===eo.TRIANGLE_STRIP||f.mode===eo.TRIANGLE_FAN||void 0===f.mode)!0===(u=!0===o.isSkinnedMesh?new r.I46(h,p):new r.eaF(h,p)).isSkinnedMesh&&u.normalizeSkinWeights(),f.mode===eo.TRIANGLE_STRIP?u.geometry=A(u.geometry,r.O49):f.mode===eo.TRIANGLE_FAN&&(u.geometry=A(u.geometry,r.rYR));else if(f.mode===eo.LINES)u=new r.DXC(h,p);else if(f.mode===eo.LINE_STRIP)u=new r.N1A(h,p);else if(f.mode===eo.LINE_LOOP)u=new r.FCc(h,p);else if(f.mode===eo.POINTS)u=new r.ONl(h,p);else throw Error("THREE.GLTFLoader: Primitive mode unsupported: "+f.mode);Object.keys(u.geometry.morphAttributes).length>0&&function(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let n=0,r=t.weights.length;n<r;n++)e.morphTargetInfluences[n]=t.weights[n];if(t.extras&&Array.isArray(t.extras.targetNames)){let n=t.extras.targetNames;if(e.morphTargetInfluences.length===n.length){e.morphTargetDictionary={};for(let t=0,r=n.length;t<r;t++)e.morphTargetDictionary[n[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}(u,o),u.name=t.createUniqueName(o.name||"mesh_"+e),ed(u,o),f.extensions&&ep(i,u,f),t.assignFinalMaterial(u),c.push(u)}for(let n=0,r=c.length;n<r;n++)t.associations.set(c[n],{meshes:e,primitives:n});if(1===c.length)return o.extensions&&ep(i,c[0],o),c[0];let u=new r.YJl;o.extensions&&ep(i,u,o),t.associations.set(u,{meshes:e});for(let e=0,t=c.length;e<t;e++)u.add(c[e]);return u})}loadCamera(e){let t,n=this.json.cameras[e],i=n[n.type];return i?("perspective"===n.type?t=new r.ubm(r.cj9.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):"orthographic"===n.type&&(t=new r.qUd(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),n.name&&(t.name=this.createUniqueName(n.name)),ed(t,n),Promise.resolve(t)):void console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){let t=this.json.skins[e],n=[];for(let e=0,r=t.joints.length;e<r;e++)n.push(this._loadNodeShallow(t.joints[e]));return void 0!==t.inverseBindMatrices?n.push(this.getDependency("accessor",t.inverseBindMatrices)):n.push(null),Promise.all(n).then(function(e){let n=e.pop(),i=[],o=[];for(let s=0,a=e.length;s<a;s++){let a=e[s];if(a){i.push(a);let e=new r.kn4;null!==n&&e.fromArray(n.array,16*s),o.push(e)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[s])}return new r.EAD(i,o)})}loadAnimation(e){let t=this.json,n=this,i=t.animations[e],o=i.name?i.name:"animation_"+e,s=[],a=[],l=[],c=[],u=[];for(let e=0,t=i.channels.length;e<t;e++){let t=i.channels[e],n=i.samplers[t.sampler],r=t.target,o=r.node,h=void 0!==i.parameters?i.parameters[n.input]:n.input,f=void 0!==i.parameters?i.parameters[n.output]:n.output;void 0!==r.node&&(s.push(this.getDependency("node",o)),a.push(this.getDependency("accessor",h)),l.push(this.getDependency("accessor",f)),c.push(n),u.push(r))}return Promise.all([Promise.all(s),Promise.all(a),Promise.all(l),Promise.all(c),Promise.all(u)]).then(function(e){let t=e[0],s=e[1],a=e[2],l=e[3],c=e[4],u=[];for(let e=0,r=t.length;e<r;e++){let r=t[e],i=s[e],o=a[e],h=l[e],f=c[e];if(void 0===r)continue;r.updateMatrix&&r.updateMatrix();let p=n._createAnimationTracks(r,i,o,h,f);if(p)for(let e=0;e<p.length;e++)u.push(p[e])}let h=new r.tz3(o,void 0,u);return ed(h,i),h})}createNodeMesh(e){let t=this.json,n=this,r=t.nodes[e];return void 0===r.mesh?null:n.getDependency("mesh",r.mesh).then(function(e){let t=n._getNodeRef(n.meshCache,r.mesh,e);return void 0!==r.weights&&t.traverse(function(e){if(e.isMesh)for(let t=0,n=r.weights.length;t<n;t++)e.morphTargetInfluences[t]=r.weights[t]}),t})}loadNode(e){let t=this.json.nodes[e],n=this._loadNodeShallow(e),r=[],i=t.children||[];for(let e=0,t=i.length;e<t;e++)r.push(this.getDependency("node",i[e]));let o=void 0===t.skin?Promise.resolve(null):this.getDependency("skin",t.skin);return Promise.all([n,Promise.all(r),o]).then(function(e){let t=e[0],n=e[1],r=e[2];null!==r&&t.traverse(function(e){e.isSkinnedMesh&&e.bind(r,em)});for(let e=0,r=n.length;e<r;e++)t.add(n[e]);return t})}_loadNodeShallow(e){let t=this.json,n=this.extensions,i=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];let o=t.nodes[e],s=o.name?i.createUniqueName(o.name):"",a=[],l=i._invokeOne(function(t){return t.createNodeMesh&&t.createNodeMesh(e)});return l&&a.push(l),void 0!==o.camera&&a.push(i.getDependency("camera",o.camera).then(function(e){return i._getNodeRef(i.cameraCache,o.camera,e)})),i._invokeAll(function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)}).forEach(function(e){a.push(e)}),this.nodeCache[e]=Promise.all(a).then(function(t){let a;if((a=!0===o.isBone?new r.$Kf:t.length>1?new r.YJl:1===t.length?t[0]:new r.B69)!==t[0])for(let e=0,n=t.length;e<n;e++)a.add(t[e]);if(o.name&&(a.userData.name=o.name,a.name=s),ed(a,o),o.extensions&&ep(n,a,o),void 0!==o.matrix){let e=new r.kn4;e.fromArray(o.matrix),a.applyMatrix4(e)}else void 0!==o.translation&&a.position.fromArray(o.translation),void 0!==o.rotation&&a.quaternion.fromArray(o.rotation),void 0!==o.scale&&a.scale.fromArray(o.scale);if(i.associations.has(a)){if(void 0!==o.mesh&&i.meshCache.refs[o.mesh]>1){let e=i.associations.get(a);i.associations.set(a,{...e})}}else i.associations.set(a,{});return i.associations.get(a).nodes=e,a}),this.nodeCache[e]}loadScene(e){let t=this.extensions,n=this.json.scenes[e],i=this,o=new r.YJl;n.name&&(o.name=i.createUniqueName(n.name)),ed(o,n),n.extensions&&ep(t,o,n);let s=n.nodes||[],a=[];for(let e=0,t=s.length;e<t;e++)a.push(i.getDependency("node",s[e]));return Promise.all(a).then(function(e){for(let t=0,n=e.length;t<n;t++)o.add(e[t]);return i.associations=(e=>{let t=new Map;for(let[e,n]of i.associations)(e instanceof r.imn||e instanceof r.gPd)&&t.set(e,n);return e.traverse(e=>{let n=i.associations.get(e);null!=n&&t.set(e,n)}),t})(o),o})}_createAnimationTracks(e,t,n,i,o){let s,a=[],l=e.name?e.name:e.uuid,c=[];switch(eh[o.path]===eh.weights?e.traverse(function(e){e.morphTargetInfluences&&c.push(e.name?e.name:e.uuid)}):c.push(l),eh[o.path]){case eh.weights:s=r.Hit;break;case eh.rotation:s=r.MBL;break;case eh.translation:case eh.scale:s=r.RiT;break;default:s=1===n.itemSize?r.Hit:r.RiT}let u=void 0!==i.interpolation?ef[i.interpolation]:r.PJ3,h=this._getArrayFromAccessor(n);for(let e=0,n=c.length;e<n;e++){let n=new s(c[e]+"."+eh[o.path],t.array,h,u);"CUBICSPLINE"===i.interpolation&&this._createCubicSplineTrackInterpolant(n),a.push(n)}return a}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){let e=ey(t.constructor),n=new Float32Array(t.length);for(let r=0,i=t.length;r<i;r++)n[r]=t[r]*e;t=n}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof r.MBL?ei:en)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function eg(e,t,n){let i=t.attributes,o=[];for(let t in i){let r=eu[t]||t.toLowerCase();r in e.attributes||o.push(function(t,r){return n.getDependency("accessor",t).then(function(t){e.setAttribute(r,t)})}(i[t],r))}if(void 0!==t.indices&&!e.index){let r=n.getDependency("accessor",t.indices).then(function(t){e.setIndex(t)});o.push(r)}return r.ppV.workingColorSpace!==r.Zr2&&"COLOR_0"in i&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${r.ppV.workingColorSpace}" not supported.`),ed(e,t),!function(e,t,n){let i=t.attributes,o=new r.NRn;if(void 0===i.POSITION)return;{let e=n.json.accessors[i.POSITION],t=e.min,s=e.max;if(void 0===t||void 0===s)return console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(o.set(new r.Pq0(t[0],t[1],t[2]),new r.Pq0(s[0],s[1],s[2])),e.normalized){let t=ey(es[e.componentType]);o.min.multiplyScalar(t),o.max.multiplyScalar(t)}}let s=t.targets;if(void 0!==s){let e=new r.Pq0,t=new r.Pq0;for(let r=0,i=s.length;r<i;r++){let i=s[r];if(void 0!==i.POSITION){let r=n.json.accessors[i.POSITION],o=r.min,s=r.max;if(void 0!==o&&void 0!==s){if(t.setX(Math.max(Math.abs(o[0]),Math.abs(s[0]))),t.setY(Math.max(Math.abs(o[1]),Math.abs(s[1]))),t.setZ(Math.max(Math.abs(o[2]),Math.abs(s[2]))),r.normalized){let e=ey(es[r.componentType]);t.multiplyScalar(e)}e.max(t)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}o.expandByVector(e)}e.boundingBox=o;let a=new r.iyt;o.getCenter(a.center),a.radius=o.min.distanceTo(o.max)/2,e.boundingSphere=a}(e,t,n),Promise.all(o).then(function(){return void 0!==t.targets?function(e,t,n){let r=!1,i=!1,o=!1;for(let e=0,n=t.length;e<n;e++){let n=t[e];if(void 0!==n.POSITION&&(r=!0),void 0!==n.NORMAL&&(i=!0),void 0!==n.COLOR_0&&(o=!0),r&&i&&o)break}if(!r&&!i&&!o)return Promise.resolve(e);let s=[],a=[],l=[];for(let c=0,u=t.length;c<u;c++){let u=t[c];if(r){let t=void 0!==u.POSITION?n.getDependency("accessor",u.POSITION):e.attributes.position;s.push(t)}if(i){let t=void 0!==u.NORMAL?n.getDependency("accessor",u.NORMAL):e.attributes.normal;a.push(t)}if(o){let t=void 0!==u.COLOR_0?n.getDependency("accessor",u.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(s),Promise.all(a),Promise.all(l)]).then(function(t){let n=t[0],s=t[1],a=t[2];return r&&(e.morphAttributes.position=n),i&&(e.morphAttributes.normal=s),o&&(e.morphAttributes.color=a),e.morphTargetsRelative=!0,e})}(e,t.targets,n):e})}var ew=n("./src/model/physics/constants.ts"),ek=console.error;function ex(e){new o().parse(e,function(e){var t,n,r;console.log(e),t=e,n="scene.gltf",(r=document.createElement("a")).setAttribute("href","data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(t))),r.setAttribute("download",n),document.body.appendChild(r),r.click(),r.remove()},ek)}function eT(e,t){new M().load(e,function(n){n.scene.scale.set(ew.R/.5,ew.R/.5,ew.R/.5),n.scene.matrixAutoUpdate=!1,n.scene.updateMatrix(),n.scene.updateMatrixWorld(),n.scene.name=e,t(n)},function(t){return console.log(e+" "+t.loaded+" bytes loaded")},ek)}},"./src/utils/rack.ts"(e,t,n){n.d(t,{m:()=>h});var r=n("./src/model/ball.ts"),i=n("./src/utils/snookerconfig.ts"),o=n("./src/view/tablegeometry.ts"),s=n("./src/view/pocketgeometry.ts"),a=n("./node_modules/three/build/three.core.js"),l=n("./src/utils/utils.ts"),c=n("./src/model/physics/constants.ts");function u(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var h=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"jitter",value:function(e){return(0,l.ld)(e.clone().add(new a.Pq0(t.noise*(Math.random()-.5),t.noise*(Math.random()-.5),0)))}},{key:"cueBall",value:function(e,n){return new r.c(t.jitter(e),0xfaebd7,n)}},{key:"swapBallPositions",value:function(e,t){var n=e.pos.clone();e.pos.copy(t.pos),t.pos.copy(n)}},{key:"diamond",value:function(){var e=new a.Pq0(o.P.tableX/2,0,0),n=[],i=function(e,n,i){return new r.c(t.jitter(e),n,i)};return n.push(t.cueBall(t.spot)),n.push(i(e,t.BALL_COLORS[1],1)),e.add(t.diagonal),n.push(i(e,t.BALL_COLORS[2],2)),e.sub(t.across),n.push(i(e,t.BALL_COLORS[3],3)),e.add(t.diagonal),n.push(i(e,t.BALL_COLORS[4],4)),e.sub(t.across),n.push(i(e,t.BALL_COLORS[5],5)),e.addScaledVector(t.across,2),n.push(i(e,t.BALL_COLORS[6],6)),e.add(t.diagonal).sub(t.across),n.push(i(e,t.BALL_COLORS[7],7)),e.sub(t.across),n.push(i(e,t.BALL_COLORS[8],8)),e.add(t.diagonal),n.push(i(e,t.BALL_COLORS[9],9)),t.swapBallPositions(n[4],n[9]),n}},{key:"triangle",value:function(){var e=t.trianglePositions(),n=[];return n.push(t.cueBall(t.spot)),e.forEach(function(e,i){var o=i+1;n.push(new r.c(t.jitter(e),t.BALL_COLORS[o],o))}),t.swapBallPositions(n[4],n[9]),n}},{key:"trianglePositions",value:function(){var e=[],t=new a.Pq0(o.P.X/2,0,0);return e.push((0,l.t6)(t)),t.add(this.diagonal),e.push((0,l.t6)(t)),t.sub(this.across),e.push((0,l.t6)(t)),t.add(this.diagonal),e.push((0,l.t6)(t)),t.sub(this.across),e.push((0,l.t6)(t)),t.addScaledVector(this.across,2),e.push((0,l.t6)(t)),t.add(this.diagonal),e.push((0,l.t6)(t)),t.sub(this.across),e.push((0,l.t6)(t)),t.sub(this.across),e.push((0,l.t6)(t)),t.sub(this.across),e.push((0,l.t6)(t)),t.add(this.diagonal).sub(this.across),e.push((0,l.t6)(t)),t.add(this.across),e.push((0,l.t6)(t)),t.add(this.across),e.push((0,l.t6)(t)),t.add(this.across),e.push((0,l.t6)(t)),t.add(this.across),e.push((0,l.t6)(t)),e}},{key:"rerack",value:function(e,n){var i=t.trianglePositions(),o=i.shift();n.balls.filter(function(e){return e!==n.cueball}).filter(function(t){return t!==e}).forEach(function(e){e.pos.copy(t.jitter(i.shift())),e.state=r.U.Stationary}),n.overlapsAny(e.pos,e)&&e.pos.copy(o),n.overlapsAny(n.cueball.pos)&&n.cueball.pos.copy(t.spot)}},{key:"three",value:function(){var e=[],n=o.P.X/2,i=o.P.Y/4;return e.push(t.cueBall(t.jitter(new a.Pq0(-n,-i,0)))),e.push(new r.c(t.jitter(new a.Pq0(-n,0,0)),0xe0de36)),e.push(new r.c(t.jitter(new a.Pq0(n,0,0)),0xff0000)),e}},{key:"snooker",value:function(){var e=[],n=o.P.Y/4;e.push(t.cueBall(t.jitter(new a.Pq0(t.baulk,-(.5*n),0))));var l=t.snookerColourPositions();e.push(new r.c(t.jitter(l[0]),0xeede36)),e.push(new r.c(t.jitter(l[1]),824932)),e.push(new r.c(t.jitter(l[2]),0xbd723a)),e.push(new r.c(t.jitter(l[3]),558062)),e.push(new r.c(t.jitter(l[4]),0xffaacc)),e.push(new r.c(t.jitter(l[5]),65793));var u=Math.min(i.U.reds,15),h=t.trianglePositions().slice(0,15),f=s.f.pockets.pocketS.pocket.pos;return h.forEach(function(n,i){var o=new r.c(t.jitter(n.add(t.down)),0xee0000);i>=u&&(o.pos.copy(f),o.pos.setZ(-8.5*c.R),o.state=r.U.InPocket),e.push(o)}),e}},{key:"snookerColourPositions",value:function(){var e=o.P.X/2,n=o.P.X-2*o.P.X/11,r=[];return r.push(new a.Pq0(t.baulk,-t.sixth,0)),r.push(new a.Pq0(t.baulk,t.sixth,0)),r.push(new a.Pq0(t.baulk,0,0)),r.push(new a.Pq0(0,0,0)),r.push(new a.Pq0(e,0,0)),r.push(new a.Pq0(n,0,0)),r}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();u(h,"noise",.0233*c.R),u(h,"gap",2*c.R+2*h.noise),u(h,"up",new a.Pq0(0,0,-1)),u(h,"spot",new a.Pq0(-o.P.X/2,0,0)),u(h,"across",new a.Pq0(0,h.gap,0)),u(h,"down",new a.Pq0(h.gap,0,0)),u(h,"diagonal",h.across.clone().applyAxisAngle(h.up,Math.PI/3)),u(h,"BALL_COLORS",["#FFFFFF","#ffd900","#0000FF","#FF0000","#800080","#ff3300","#008000","#600000","#000000","#FFFF00","#0000FF","#FF0000","#800080","#FF8000","#008000","#600000"]),u(h,"sixth",2*o.P.Y/6),u(h,"baulk",-1.5*o.P.X*2/5)},"./src/utils/replay-encoder.ts"(e,t,n){n.d(t,{k:()=>i});var r=n("./node_modules/jsoncrush/JSONCrush.js"),i=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"fullyEncodeURI",value:function(e){return encodeURIComponent(e).replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/!/g,"%21").replace(/\*/g,"%2A")}},{key:"crush",value:function(e){return r.A.crush(e)}},{key:"createState",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5?arguments[5]:void 0,s={init:e,shots:t,start:n,now:Date.now(),score:r,wholeGame:i,v:1};return o&&(s.players=o),s}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/utils/respot.ts"(e,t,n){n.d(t,{k:()=>l});var r=n("./src/model/ball.ts"),i=n("./src/view/tablegeometry.ts"),o=n("./src/model/physics/constants.ts"),s=n("./src/utils/rack.ts"),a=n("./node_modules/three/build/three.core.js"),l=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"nineBall",value:function(e){var n=e.balls.find(function(e){return 9===e.id});if(n){var r=new a.Pq0(i.P.tableX/2,0,0);t.respotBehind(r,n,e)}}},{key:"respot",value:function(e,n){var i=s.m.snookerColourPositions();return i.push(i[e.id-1]),i.reverse(),i.some(function(t){return!n.overlapsAny(t,e)&&(e.pos.copy(t),e.state=r.U.Stationary,!0)})||t.respotBehind(i[0],e,n),e}},{key:"respotBehind",value:function(e,t,n){for(var s=e.clone();s.x<i.P.tableX&&n.overlapsAny(s,t);)s.x+=o.R/8;for(;s.x>-i.P.tableX&&n.overlapsAny(s,t);)s.x-=o.R/8;t.pos.copy(s),t.state=r.U.Stationary}},{key:"closest",value:function(e,t){var n=t.filter(function(e){return e.onTable()}).filter(function(t){return t!==e});if(0!==n.length){var r=function(t){return e.pos.distanceTo(t.pos)};return n.reduce(function(e,t){return r(e)<r(t)?e:t},n[0])}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/utils/snookerconfig.ts"(e,t,n){n.d(t,{U:()=>r});var r={reds:15}},"./src/utils/threecushionconfig.ts"(e,t,n){n.d(t,{Y:()=>r});var r={raceTo:7}},"./src/utils/utils.ts"(e,t,n){n.d(t,{Dz:()=>v,F8:()=>w,FP:()=>b,KM:()=>u,RZ:()=>x,gn:()=>k,hs:()=>a,ld:()=>m,n7:()=>g,oN:()=>T,rq:()=>d,t6:()=>l,up:()=>s,v_:()=>o,xb:()=>f});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/events/eventtype.ts"),o=new r.Pq0(0,0,0),s=new r.Pq0(0,0,1);function a(e){return!e.entries.some(function(e){return e.event.type===i.B.AIM})}function l(e){return new r.Pq0(e.x,e.y,e.z)}var c=new r.Pq0;function u(e){return c.copy(s).cross(e)}var h=new r.Pq0;function f(e){return h.copy(e).normalize()}var p=new r.Pq0;function d(e,t){return 0>=p.copy(e).add(t).dot(e)}function v(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new r.Pq0;return t.set(1,0,0).applyAxisAngle(s,e)}function y(e){return Math.sign(e)*Math.floor((Math.abs(e)+Number.EPSILON)*1e4)/1e4}function m(e){return e.x=y(e.x),e.y=y(e.y),e.z=y(e.z),e}function b(e,t){return Math.fround(Math.atan2(e,t))}function g(e,t){return Math.fround(Math.pow(e,t))}function w(e){return Math.fround(Math.sin(e))}function k(e){return Math.fround(Math.cos(e))}function x(e){return Math.fround(Math.sqrt(e))}function T(e){return Math.fround(Math.exp(e))}},"./src/view/assets.ts"(e,t,n){n.d(t,{s:()=>y});var r=n("./src/controller/rules/rulefactory.ts"),i=n("./src/utils/gltf.ts"),o=n("./node_modules/three/build/three.core.js");function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");s(this,"listener",void 0),s(this,"audioLoader",void 0),s(this,"ballcollision",void 0),s(this,"cue",void 0),s(this,"cushion",void 0),s(this,"pot",void 0),s(this,"success",void 0),s(this,"lastOutcomeTime",0),s(this,"loadAssets",void 0),this.loadAssets=e,e&&(this.listener=new o.Pf$,this.audioLoader=new o.Am1,this.ballcollision=new o.fP5(this.listener),this.load("sounds/ballcollision.ogg",this.ballcollision),this.cue=new o.fP5(this.listener),this.load("sounds/cue.ogg",this.cue),this.cushion=new o.fP5(this.listener),this.load("sounds/cushion.ogg",this.cushion),this.pot=new o.fP5(this.listener),this.load("sounds/pot.ogg",this.pot),this.success=new o.fP5(this.listener),this.load("sounds/success.ogg",this.success))}return e=[{key:"addCameraToListener",value:function(e){e.add(this.listener)}},{key:"load",value:function(e,t){this.audioLoader.load(e,function(e){t.setBuffer(e),t.setLoop(!1)},function(e){},function(e){})}},{key:"play",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(this.loadAssets){var r,i,s=o.UtX.getContext();if((null==s?void 0:s.state)==="suspended"){(null==(i=navigator)||null==(r=i.userActivation)?void 0:r.hasBeenActive)&&s.resume();return}e.setVolume(t),e.isPlaying&&e.stop(),e.play(o.cj9.randFloat(0,.01)),e.setDetune(n)}}},{key:"outcomeToSound",value:function(e){"Collision"===e.type&&this.play(this.ballcollision,e.incidentSpeed/80,5*e.incidentSpeed),"Pot"===e.type&&this.play(this.pot,e.incidentSpeed/10,-1e3+10*e.incidentSpeed),"Cushion"===e.type&&this.play(this.cushion,e.incidentSpeed/70),"Hit"===e.type&&this.play(this.cue,e.incidentSpeed/30)}},{key:"processOutcomes",value:function(e){var t=this;e.every(function(e){return!(e.timestamp>t.lastOutcomeTime)||(t.lastOutcomeTime=e.timestamp,t.outcomeToSound(e),!1)})}},{key:"playNotify",value:function(){this.play(this.pot,1)}},{key:"playSuccess",value:function(e){this.play(this.success,.1,100*e-2200)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),l=n("./src/view/tablegeometry.ts"),c=n("./src/view/pocketgeometry.ts"),u=n("./src/model/physics/constants.ts");function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var f=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");h(this,"logger",function(e){}),h(this,"cloth",new o.tXL({color:4478393,wireframe:!1,flatShading:!0,transparent:!1})),h(this,"cushion",new o.tXL({color:5531065,wireframe:!1,flatShading:!0,transparent:!1})),h(this,"pocket",new o.tXL({color:4478361,wireframe:!1,flatShading:!0,transparent:!0,opacity:.3}))}return e=[{key:"generateTable",value:function(e){var t=this,n=new o.YJl,r=new o.HiM(0xf0f0e8,22);if(r.position.set(0,0,50*u.R),n.add(r),this.addCushions(n,e),e){c.f.knuckles.forEach(function(e){return t.knuckleCylinder(e,n)}),c.f.pocketCenters.forEach(function(e){return t.knuckleCylinder(e,n,t.pocket)});var i=c.f.pockets.pocketNW.pocket,s=c.f.pockets.pocketNW.knuckleNE;this.logger("knuckle-pocket gap = "+(i.pos.distanceTo(s.pos)-i.radius-s.radius))}return n}},{key:"knuckleCylinder",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.cloth;this.cylinder(e.pos,e.radius,.75*u.R/.5,t,n).position.setZ(-(.25*u.R)/.5/2)}},{key:"cylinder",value:function(e,n,r,i,s){var a="".concat(n,"_").concat(r),l=t.cylinderCache.get(a);l||(l=new o.Ho_(n,n,r,16),t.cylinderCache.set(a,l));var c=new o.eaF(l,s);return c.position.copy(e),c.rotation.x=Math.PI/2,i.add(c),c}},{key:"addCushions",value:function(e,t){var n=10*u.R/.5;this.plane(new o.Pq0(0,0,-u.R-n/2),2*l.P.X,2*l.P.Y,n,e,this.cloth);var r=u.R/.5,i=.75*u.R/.5,s=-(.25*u.R)/.5/2,a=l.P.X,h=l.P.Y,f=Math.abs(c.f.pockets.pocketNW.knuckleNE.pos.x-c.f.pockets.pocketN.knuckleNW.pos.x),p=Math.abs(c.f.pockets.pocketNW.knuckleSW.pos.y-c.f.pockets.pocketSW.knuckleNW.pos.y);t||(f=2*l.P.Y,p=2*l.P.Y+4*u.R),this.plane(new o.Pq0(a+r/2,0,s),r,p,i,e),this.plane(new o.Pq0(-a-r/2,0,s),r,p,i,e),this.plane(new o.Pq0(-a/2,h+r/2,s),f,r,i,e),this.plane(new o.Pq0(-a/2,-h-r/2,s),f,r,i,e),this.plane(new o.Pq0(a/2,h+r/2,s),f,r,i,e),this.plane(new o.Pq0(a/2,-h-r/2,s),f,r,i,e)}},{key:"plane",value:function(e,n,r,i,s){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:this.cushion,l="".concat(n,"_").concat(r,"_").concat(i),c=t.boxCache.get(l);c||(c=new o.iNn(n,r,i),t.boxCache.set(l,c));var u=new o.eaF(c,a);u.receiveShadow=!0,u.position.copy(e),s.add(u)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();h(f,"mesh",void 0),h(f,"cylinderCache",new Map),h(f,"boxCache",new Map);var p=n("./src/view/cuemesh.ts");function d(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function v(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var y=function(){var e,t;function n(e){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");v(this,"ready",void 0),v(this,"rules",void 0),v(this,"background",void 0),v(this,"table",void 0),v(this,"cue",void 0),v(this,"sound",void 0),this.rules=r.V.create(e,null),this.rules.tableGeometry()}return e=[{key:"loadFromWeb",value:function(e){var t=this;this.ready=e,this.sound=new a(!0),(0,i.Ro)("models/background.gltf",function(e){t.background=e.scene,t.done()}),(0,i.Ro)(this.rules.asset(),function(e){t.table=e.scene,f.mesh=e.scene.children[0],t.done()}),(0,i.Ro)("models/cue.gltf",function(e){t.cue=e,p.l.mesh=e.scene.children[0],t.done()})}},{key:"createLocal",value:function(){this.sound=new a(!1),f.mesh=new f().generateTable(l.P.hasPockets),this.table=f.mesh}},{key:"done",value:function(){this.background&&this.table&&this.cue&&this.ready()}}],t=[{key:"localAssets",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=new n(e);return t.createLocal(),t}}],e&&d(n.prototype,e),t&&d(n,t),n}()},"./src/view/cameratop.ts"(e,t,n){n.d(t,{v:()=>a});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/view/tablegeometry.ts"),o=n("./src/model/physics/constants.ts");function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"viewPoint",value:function(e,n){var s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new r.Pq0;(n!==t.lastFov||t.zoomFactor!==t.lastZoom)&&(t.cachedDist=t.zoomFactor/(2*Math.tan(n*Math.PI/360)),t.lastFov=n,t.lastZoom=t.zoomFactor);var a=t.cachedDist;if(e>this.portrait){var l=e>t.aspectLimit?2.75*i.P.tableY:2.4*i.P.tableX/e;return s.set(0,-.01*o.R,a*l)}var c=e>1/t.aspectLimit?4.9*i.P.tableY:1.35*i.P.tableX/e;return s.set(-.01*o.R,0,a*c)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();s(a,"aspectLimit",1.78),s(a,"portrait",.95),s(a,"fov",20),s(a,"zoomFactor",1),s(a,"lastFov",void 0),s(a,"lastZoom",void 0),s(a,"cachedDist",void 0)},"./src/view/cue.ts"(e,t,n){n.d(t,{s:()=>f});var r=n("./src/view/tablegeometry.ts"),i=n("./src/utils/utils.ts"),o=n("./src/events/aimevent.ts"),s=n("./src/model/ball.ts"),a=n("./src/model/physics/physics.ts"),l=n("./src/view/cuemesh.ts"),c=n("./node_modules/three/build/three.core.js"),u=n("./src/model/physics/constants.ts");function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var f=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");h(this,"mesh",void 0),h(this,"helperMesh",void 0),h(this,"placerMesh",void 0),h(this,"offCenterLimit",.3),h(this,"maxPower",160*u.R),h(this,"t",0),h(this,"aimInputs",void 0),h(this,"aim",new o.w),h(this,"length",+r.P.tableX),h(this,"tempVec",new c.Pq0),h(this,"tempVec2",new c.Pq0),h(this,"tempVec3",new c.Pq0),h(this,"raycaster",new c.tBo),this.mesh=l.l.createCue(.05*u.R/.5,.15*u.R/.5,this.length),this.helperMesh=l.l.createHelper(),this.placerMesh=l.l.createPlacer()}return e=[{key:"rotateAim",value:function(e,t){this.aim.angle=this.aim.angle+e,this.mesh.rotation.z=this.aim.angle,this.helperMesh.rotation.z=this.aim.angle,this.aimInputs.showOverlap(),this.avoidCueTouchingOtherBall(t)}},{key:"adjustPower",value:function(e){this.aim.power=Math.min(this.maxPower,this.aim.power+e),this.updateAimInput()}},{key:"setPower",value:function(e){this.aim.power=e*this.maxPower}},{key:"hit",value:function(e){var t=this.aim;this.t=0,e.state=s.U.Sliding,e.vel.copy((0,i.Dz)(t.angle,this.tempVec).multiplyScalar(t.power)),e.rvel.copy((0,a.t6)(t.offset,e.vel))}},{key:"aimAtNext",value:function(e,t){if(t){var n=(0,i.xb)(this.tempVec.copy(t.pos).sub(e.pos));this.aim.angle=(0,i.FP)(n.y,n.x)}}},{key:"adjustSpin",value:function(e,t){var n=this.tempVec3.copy(this.aim.offset).add(e);this.setSpin(n,t)}},{key:"setSpin",value:function(e,t){e.length()>this.offCenterLimit&&e.normalize().multiplyScalar(this.offCenterLimit),this.aim.offset.copy(e),this.avoidCueTouchingOtherBall(t),this.updateAimInput()}},{key:"avoidCueTouchingOtherBall",value:function(e){for(var t=0;t++<20&&this.intersectsAnything(e);)this.aim.offset.y+=.1,this.aim.offset.length()>this.offCenterLimit&&this.aim.offset.normalize().multiplyScalar(this.offCenterLimit);t>1&&this.updateAimInput()}},{key:"updateAimInput",value:function(){var e,t,n;null==(e=this.aimInputs)||e.updateVisualState(this.aim.offset.x,this.aim.offset.y),null==(t=this.aimInputs)||t.updatePowerSlider(this.aim.power/this.maxPower),null==(n=this.aimInputs)||n.showOverlap()}},{key:"moveTo",value:function(e){this.aim.pos.copy(e),this.mesh.rotation.z=this.aim.angle,this.helperMesh.rotation.z=this.aim.angle;var t=this.spinOffset(),n=((0,i.F8)(this.t+Math.PI/2)-1)*2*u.R*(this.aim.power/this.maxPower),r=(0,i.Dz)(this.aim.angle,this.tempVec).multiplyScalar(n);this.mesh.position.copy(e).add(t).add(r),this.helperMesh.position.copy(e),this.placerMesh.position.copy(e),this.placerMesh.rotation.z=this.t}},{key:"update",value:function(e){this.t+=e,this.moveTo(this.aim.pos)}},{key:"placeBallMode",value:function(){this.mesh.visible=!1,this.placerMesh.visible=!0,this.aim.angle=0}},{key:"aimMode",value:function(){this.mesh.visible=!0,this.placerMesh.visible=!1}},{key:"spinOffset",value:function(){return(0,i.KM)((0,i.Dz)(this.aim.angle,this.tempVec2)).multiplyScalar(2*this.aim.offset.x*u.R).setZ(2*this.aim.offset.y*u.R)}},{key:"intersectsAnything",value:function(e){var t=this.spinOffset(),n=this.tempVec.copy(e.cueball.pos).add(t),r=(0,i.xb)((0,i.Dz)(this.aim.angle+Math.PI,this.tempVec2).setZ(.1));this.raycaster.set(n,r);var o=[],s=!0,a=!1,l=void 0;try{for(var c,u=e.balls[Symbol.iterator]();!(s=(c=u.next()).done);s=!0){var h=c.value;o.push(h.ballmesh.mesh)}}catch(e){a=!0,l=e}finally{try{s||null==u.return||u.return()}finally{if(a)throw l}}return e.mesh&&o.push(e.mesh),this.raycaster.intersectObjects(o,!0).length>0}},{key:"showHelper",value:function(e){this.helperMesh.visible=e}},{key:"toggleHelper",value:function(){this.showHelper(!this.helperMesh.visible)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/view/cuemesh.ts"(e,t,n){n.d(t,{l:()=>a});var r=n("./src/model/physics/constants.ts"),i=n("./src/utils/utils.ts"),o=n("./node_modules/three/build/three.core.js");function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"indicateValid",value:function(e){t.placermaterial.color.setHex(e?0xccffcc:0xff0000)}},{key:"createHelper",value:function(){var e=new o.Ho_(r.R,r.R,30*r.R/.5,12,1,!0),t=new o.eaF(e,this.helpermaterial);return t.geometry.applyMatrix4(new o.kn4().identity().makeRotationAxis(i.up,-Math.PI/2)).applyMatrix4(new o.kn4().identity().makeTranslation(15*r.R/.5,0,-(.01*r.R)/.5)),t.visible=!1,t.renderOrder=-1,t.material.depthTest=!1,t}},{key:"createPlacer",value:function(){var e=new o.Ho_(.01*r.R/.5,r.R,r.R,4),n=new o.eaF(e,t.placermaterial);return n.geometry.applyMatrix4(new o.kn4().identity().makeRotationAxis(new o.Pq0(1,0,0),-Math.PI/2)).applyMatrix4(new o.kn4().identity().makeTranslation(0,0,.7*r.R/.5)),n.visible=!1,n}},{key:"createCue",value:function(e,n,s){var a=new o.Ho_(e,n,s,11),l=new o.eaF(a,t.material);return l.castShadow=!1,l.geometry.applyMatrix4(new o.kn4().identity().makeRotationAxis(new o.Pq0(1,0,0),-.17)).applyMatrix4(new o.kn4().identity().makeRotationAxis(i.up,-Math.PI/2)).applyMatrix4(new o.kn4().identity().makeTranslation(-s/2-r.R,0,s/2*.16918234906699603+.25*r.R)),l}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();s(a,"mesh",void 0),s(a,"material",new o.tXL({color:8934775,wireframe:!1,flatShading:!1})),s(a,"placermaterial",new o.tXL({color:0xccffcc,wireframe:!1,flatShading:!1,transparent:!0,opacity:.5})),s(a,"helpermaterial",new o.BKk({uniforms:{lightDirection:{value:new o.Pq0(0,0,1)}},vertexShader:`
+        `))},this.materialCache.set(r,o),o}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();function y(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}o="materialCache",s=new Map,o in v?Object.defineProperty(v,o,{value:s,enumerable:!0,configurable:!0,writable:!0}):v[o]=s;var b=function(){var e,t;function n(e,t){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");m(this,"mesh",void 0),m(this,"shadow",void 0),m(this,"spinAxisArrow",void 0),m(this,"trace",void 0),m(this,"color",void 0),m(this,"m",new u.kn4),this.color=new u.Q1f(e),this.initialiseMesh(this.color,t)}return e=[{key:"updateAll",value:function(e,t){this.updatePosition(e.pos),this.updateArrows(e.pos,e.rvel,e.state),0!==e.rvel.lengthSq()&&(this.updateRotation(e.rvel,t),this.trace.addTrace(e.pos,e.vel))}},{key:"updatePosition",value:function(e){this.mesh.position.copy(e),this.shadow.position.copy(e)}},{key:"updateRotation",value:function(e,t){var n=e.length()*t;this.mesh.rotateOnWorldAxis((0,l.xb)(e),n)}},{key:"updateArrows",value:function(e,t,n){this.spinAxisArrow.setLength(h.R+h.R*t.length()/2,h.R,h.R),this.spinAxisArrow.position.copy(e),this.spinAxisArrow.setDirection((0,l.xb)(t)),n==k.Rolling?this.spinAxisArrow.setColor(0xcc0000):this.spinAxisArrow.setColor(52224)}},{key:"initialiseMesh",value:function(e,t){if(void 0===t){var r,i,o=e.getHex(),s=n._dottedGeometryCache.get(o);s||(s=new u.WBB(h.R,1),n.addDots(s,e),n._dottedGeometryCache.set(o,s)),r=s,i=v.createDottedMaterial(e)}else r=n.getBallGeometry(),i=v.createProjectedMaterial(t,e);this.mesh=new u.eaF(r,i),this.mesh.name="ball",this.updateRotation(new u.Pq0().random(),100),this.shadow=new u.eaF(n.getShadowGeometry(),n.getShadowMaterial()),this.spinAxisArrow=new u.E0M(l.up,l.v_,2,0,.01,.01),this.spinAxisArrow.visible=!1,this.trace=new p(500,e)}},{key:"addToScene",value:function(e){e.add(this.mesh),e.add(this.shadow),e.add(this.spinAxisArrow),e.add(this.trace.line)}}],t=[{key:"getBallGeometry",value:function(){return this._ballGeometry||(this._ballGeometry=new u.WBB(h.R,1)),this._ballGeometry}},{key:"getShadowGeometry",value:function(){return this._shadowGeometry||(this._shadowGeometry=new u.tcD(.9*h.R,9),this._shadowGeometry.applyMatrix4(new u.kn4().makeTranslation(0,0,-(.99*h.R)))),this._shadowGeometry}},{key:"getShadowMaterial",value:function(){return this._shadowMaterial||(this._shadowMaterial=new u.V9B({color:1118498})),this._shadowMaterial}},{key:"addDots",value:function(e,t){var r=e.attributes.position.count,i=new u.Q1f(t);e.setAttribute("color",new u.THS(new Float32Array(3*r),3));for(var o=e.attributes.color,s=0;s<r/3;s++)n.colorVerticesForFace(s,o,n.scaleNoise(i.r),n.scaleNoise(i.g),n.scaleNoise(i.b));var a=new u.Q1f(0xaa2222);[0,96,111,156,186,195].forEach(function(e){n.colorVerticesForFace(e/3,o,a.r,a.g,a.b)})}},{key:"colorVerticesForFace",value:function(e,t,n,r,i){t.setXYZ(3*e+0,n,r,i),t.setXYZ(3*e+1,n,r,i),t.setXYZ(3*e+2,n,r,i)}},{key:"scaleNoise",value:function(e){return(1-.25*Math.random())*e}}],e&&y(n.prototype,e),t&&y(n,t),n}();function g(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function w(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}m(b,"_ballGeometry",void 0),m(b,"_shadowGeometry",void 0),m(b,"_shadowMaterial",void 0),m(b,"_dottedGeometryCache",new Map);var k=((a={}).Stationary="Stationary",a.Rolling="Rolling",a.Sliding="Sliding",a.Falling="Falling",a.InPocket="InPocket",a),x=function(){var e,t;function n(e,t,r){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");w(this,"pos",void 0),w(this,"vel",l.v_.clone()),w(this,"rvel",l.v_.clone()),w(this,"futurePos",l.v_.clone()),w(this,"ballmesh",void 0),w(this,"state","Stationary"),w(this,"pocket",void 0),w(this,"id",n.id++),w(this,"label",void 0),this.pos=e.clone(),this.label=r,this.ballmesh=new b(t||0xeeeeee*Math.random(),r)}return e=[{key:"update",value:function(e){this.updatePosition(e),"Falling"==this.state?this.pocket.updateFall(this,e):this.updateVelocity(e)}},{key:"updateMesh",value:function(e){this.ballmesh.updateAll(this,e)}},{key:"updatePosition",value:function(e){this.pos.addScaledVector(this.vel,e)}},{key:"updateVelocity",value:function(e){this.inMotion()&&(this.isRolling()?(this.state="Rolling",(0,c.lx)(this.vel,this.rvel),this.addDelta(e,(0,c.JD)(this.rvel))):(this.state="Sliding",this.addDelta(e,(0,c.p2)(this.vel,this.rvel))))}},{key:"addDelta",value:function(e,t){t.v.multiplyScalar(e),t.w.multiplyScalar(e),this.passesZero(t)||(this.vel.add(t.v),this.rvel.add(t.w))}},{key:"passesZero",value:function(e){var t=(0,l.rq)(this.vel,e.v),n=(0,l.rq)(this.rvel,e.w);return!!(("Rolling"===this.state?t||n:t&&n)&&.01>Math.abs(this.rvel.z))&&(this.setStationary(),!0)}},{key:"setStationary",value:function(){this.vel.copy(l.v_),this.rvel.copy(l.v_),this.state="Stationary"}},{key:"isRolling",value:function(){return 0!==this.vel.lengthSq()&&0!==this.rvel.lengthSq()&&(0,c.Mq)(this.vel,this.rvel).length()<n.transition}},{key:"onTable",value:function(){return"Falling"!==this.state&&"InPocket"!==this.state}},{key:"inMotion",value:function(){return"Rolling"===this.state||"Sliding"===this.state||this.isFalling()}},{key:"isFalling",value:function(){return"Falling"===this.state}},{key:"futurePosition",value:function(e){return this.futurePos.copy(this.pos).addScaledVector(this.vel,e),this.futurePos}},{key:"fround",value:function(){this.pos.x=Math.fround(this.pos.x),this.pos.y=Math.fround(this.pos.y),this.vel.x=Math.fround(this.vel.x),this.vel.y=Math.fround(this.vel.y),this.rvel.x=Math.fround(this.rvel.x),this.rvel.y=Math.fround(this.rvel.y),this.rvel.z=Math.fround(this.rvel.z)}},{key:"serialise",value:function(){return{pos:this.pos.clone(),id:this.id}}}],t=[{key:"fromSerialised",value:function(e){return n.updateFromSerialised(new n((0,l.t6)(e.pos)),e)}},{key:"updateFromSerialised",value:function(e,t){var n,r;return e.pos.copy(t.pos),e.vel.copy(null!=(n=null==t?void 0:t.vel)?n:l.v_),e.rvel.copy(null!=(r=null==t?void 0:t.rvel)?r:l.v_),e}}],e&&g(n.prototype,e),t&&g(n,t),n}();w(x,"id",0),w(x,"transition",.05)},"./src/model/outcome.ts"(e,t,n){n.d(t,{$:()=>o,P:()=>s});function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var i,o=((i={}).Pot="Pot",i.Cushion="Cushion",i.Collision="Collision",i.Hit="Hit",i),s=function(){var e;function t(e,n,i,o){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");r(this,"type",void 0),r(this,"timestamp",void 0),r(this,"ballA",null),r(this,"ballB",null),r(this,"incidentSpeed",void 0),this.type=e,this.ballA=n,this.ballB=i,this.incidentSpeed=o,this.timestamp=Date.now()}return e=[{key:"pot",value:function(e,n){return new t("Pot",e,e,n)}},{key:"cushion",value:function(e,n){return new t("Cushion",e,e,n)}},{key:"collision",value:function(e,n,r){return new t("Collision",e,n,r)}},{key:"hit",value:function(e,n){return new t("Hit",e,e,n)}},{key:"isCueBallPotted",value:function(e,t){return t.some(function(t){return"Pot"==t.type&&t.ballA===e})}},{key:"isBallPottedNoFoul",value:function(e,n){return n.some(function(e){return"Pot"==e.type&&null!==e.ballA})&&!t.isCueBallPotted(e,n)}},{key:"pots",value:function(e){return e.filter(function(e){return"Pot"==e.type}).map(function(e){return e.ballA})}},{key:"potCount",value:function(e){return this.pots(e).length}},{key:"onlyRedsPotted",value:function(e){return this.pots(e).every(function(e){return e.id>6})}},{key:"firstCollision",value:function(e){var t=e.filter(function(e){return"Collision"===e.type});return t.length>0?t[0]:void 0}},{key:"isClearTable",value:function(e){var t=e.balls.filter(function(e){return e.onTable()});return 1===t.length&&t[0]===e.cueball}},{key:"isThreeCushionPoint",value:function(e,n){n=t.cueBallFirst(e,n).filter(function(t){return t.ballA===e});var r=new Set,i=0,o=!0,s=!1,a=void 0;try{for(var l,c=n[Symbol.iterator]();!(o=(l=c.next()).done);o=!0){var u=l.value;if("Cushion"===u.type&&i++,"Collision"===u.type&&(r.add(u.ballB),2===r.size))return i>=3}}catch(e){s=!0,a=e}finally{try{o||null==c.return||c.return()}finally{if(s)throw a}}return!1}},{key:"cueBallFirst",value:function(e,t){return t.forEach(function(t){"Collision"===t.type&&t.ballB===e&&(t.ballB=t.ballA,t.ballA=e)}),t}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/model/physics/collision.ts"(e,t,n){n.d(t,{F:()=>h});var r,i,o=n("./src/model/ball.ts"),s=n("./node_modules/three/build/three.core.js"),a=n("./src/model/physics/constants.ts"),l=n("./src/utils/utils.ts");function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var u=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");c(this,"normalImpulse",void 0),c(this,"tangentialImpulse",void 0)}return e=[{key:"dynamicFriction",value:function(e){return .01+.108*(0,l.oN)(-1.088*e)}},{key:"updateVelocities",value:function(e,t){var n=h.positionsAtContact(e,t);e.ballmesh.trace.forceTrace(n.a),t.ballmesh.trace.forceTrace(n.b);var r=n.b.sub(n.a).normalize(),i=new s.Pq0(-r.y,r.x,0),o=e.vel.clone().sub(t.vel).add(r.clone().multiplyScalar(-a.R).cross(e.rvel).sub(r.clone().multiplyScalar(a.R).cross(t.rvel))),l=r.dot(o),c=o.addScaledVector(r,-l),u=c.length(),f=i.dot(c),p=this.dynamicFriction(u);this.normalImpulse=-1.99*l/(2/a.m),this.tangentialImpulse=-(.25*Math.min(p*Math.abs(this.normalImpulse)/u,1/7)*f);var d=r.clone().multiplyScalar(this.normalImpulse),v=i.clone().multiplyScalar(this.tangentialImpulse);e.vel.addScaledVector(d,1/a.m).addScaledVector(v,1/a.m),t.vel.addScaledVector(d,-1/a.m).addScaledVector(v,-1/a.m);var y=r.clone().multiplyScalar(-a.R).cross(v),m=r.clone().multiplyScalar(a.R).cross(v);return e.rvel.addScaledVector(y,1/a.I),t.rvel.addScaledVector(m,1/a.I),l}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),h=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"willCollide",value:function(e,t,n){return(e.inMotion()||t.inMotion())&&e.onTable()&&t.onTable()&&e.futurePosition(n).distanceToSquared(t.futurePosition(n))<4*a.R*a.R}},{key:"collide",value:function(e,n){return t.updateVelocities(e,n)}},{key:"positionsAtContact",value:function(e,t){var n=e.pos.distanceTo(t.pos),r=e.vel.clone().sub(t.vel),i=(n-2*a.R)/r.length()||0;return{a:e.pos.clone().addScaledVector(e.vel,i),b:t.pos.clone().addScaledVector(t.vel,i)}}},{key:"updateVelocities",value:function(e,n){var r=t.model.updateVelocities(e,n);return e.state=o.U.Sliding,n.state=o.U.Sliding,r}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();r="model",i=new u,r in h?Object.defineProperty(h,r,{value:i,enumerable:!0,configurable:!0,writable:!0}):h[r]=i},"./src/model/physics/constants.ts"(e,t,n){n.d(t,{I:()=>o,Mz:()=>r,PX:()=>A,Qg:()=>k,R:()=>f,Wv:()=>T,Ys:()=>P,Z3:()=>m,_m:()=>y,cM:()=>S,e:()=>p,ee:()=>d,g:()=>s,gT:()=>c,gf:()=>l,jG:()=>w,kL:()=>u,kM:()=>R,ki:()=>E,ko:()=>O,m:()=>h,mu:()=>a,o5:()=>b,oV:()=>v,x3:()=>i,xO:()=>x});var r,i,o,s=9.8,a=.00985,l=.16,c=.85,u=.034,h=.23,f=.03275,p=.86,d=.98,v=.212,y=.14,m=.4,b=Math.sqrt(21)/5;function g(){r=a*h*s*2/3*u,i=7/(5*Math.sqrt(2))*f*a*h*s,o=.4*h*f*f}function w(e){f=e,g()}function k(e){h=e,g()}function x(e){a=e,g()}function T(e){u=e,g()}function P(e){l=e}function S(e){p=e}function R(e){c=e}function O(e){v=e}function E(e){y=e}function A(e){d=e}g()},"./src/model/physics/knuckle.ts"(e,t,n){n.d(t,{O:()=>a});var r=n("./src/model/physics/constants.ts"),i=n("./src/view/pocketgeometry.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e,t;function n(e,t){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");s(this,"pos",void 0),s(this,"radius",void 0),this.pos=e,this.radius=t}return e=[{key:"bounce",value:function(e){var t=e.pos.clone().sub(this.pos).normalize(),n=t.dot(e.vel);return e.vel.addScaledVector(t,-2*r.e*n),e.rvel.multiplyScalar(.5),Math.abs(n)}}],t=[{key:"willBounce",value:function(e,t){return t.distanceTo(e.pos)<r.R+e.radius}},{key:"findBouncing",value:function(e,t){var r=e.futurePosition(t);return i.f.knuckles.find(function(e){return n.willBounce(e,r)})}}],e&&o(n.prototype,e),t&&o(n,t),n}()},"./src/model/physics/mathaven.ts"(e,t,n){n.d(t,{z:()=>s});var r=n("./src/utils/utils.ts"),i=n("./src/model/physics/constants.ts");function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var s=function(){var e;function t(e,n,r,i,s){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");o(this,"P",0),o(this,"WzI",0),o(this,"vx",void 0),o(this,"vy",void 0),o(this,"Ï‰x",void 0),o(this,"Ï‰y",void 0),o(this,"Ï‰z",void 0),o(this,"s",void 0),o(this,"Ï†",void 0),o(this,"sÊ¹",void 0),o(this,"Ï†Ê¹",void 0),o(this,"i",0),o(this,"N",100),o(this,"M",void 0),o(this,"R",void 0),o(this,"Î¼s",void 0),o(this,"Î¼w",void 0),o(this,"ee",void 0),this.M=e,this.R=n,this.ee=r,this.Î¼s=i,this.Î¼w=s}return e=[{key:"updateSlipSpeedsAndAngles",value:function(){var e=this.R,t=this.vx+this.Ï‰y*e*i.Z3-this.Ï‰z*e*i.o5,n=-this.vy*i.Z3+this.Ï‰x*e,o=this.vx-this.Ï‰y*e,s=this.vy+this.Ï‰x*e;this.s=(0,r.RZ)((0,r.n7)(t,2)+(0,r.n7)(n,2)),this.Ï†=(0,r.FP)(n,t),this.Ï†<0&&(this.Ï†+=2*Math.PI),this.sÊ¹=(0,r.RZ)((0,r.n7)(o,2)+(0,r.n7)(s,2)),this.Ï†Ê¹=(0,r.FP)(s,o),this.Ï†Ê¹<0&&(this.Ï†Ê¹+=2*Math.PI)}},{key:"compressionPhase",value:function(){for(var e=Math.max(this.M*this.vy/this.N,.001);this.vy>0;)this.updateSingleStep(e)}},{key:"restitutionPhase",value:function(e){var t=Math.max(e/this.N,.001);for(this.WzI=0;this.WzI<e;)this.updateSingleStep(t)}},{key:"updateSingleStep",value:function(e){if(this.updateSlipSpeedsAndAngles(),this.updateVelocity(e),this.updateAngularVelocity(e),this.updateWorkDone(e),this.i++>10*this.N)throw Error("Solution not found")}},{key:"updateVelocity",value:function(e){var t=this.Î¼s,n=this.Î¼w,o=this.M;this.vx-=1/o*(n*(0,r.gn)(this.Ï†)+t*(0,r.gn)(this.Ï†Ê¹)*(i.Z3+n*(0,r.F8)(this.Ï†)*i.o5))*e,this.vy-=1/o*(i.o5-n*i.Z3*(0,r.F8)(this.Ï†)+t*(0,r.F8)(this.Ï†Ê¹)*(i.Z3+n*(0,r.F8)(this.Ï†)*i.o5))*e}},{key:"updateAngularVelocity",value:function(e){var t=this.Î¼s,n=this.Î¼w,o=this.M,s=this.R;this.Ï‰x+=-(5/(2*o*s))*(n*(0,r.F8)(this.Ï†)+t*(0,r.F8)(this.Ï†Ê¹)*(i.Z3+n*(0,r.F8)(this.Ï†)*i.o5))*e,this.Ï‰y+=-(5/(2*o*s))*(n*(0,r.gn)(this.Ï†)*i.Z3-t*(0,r.gn)(this.Ï†Ê¹)*(i.Z3+n*(0,r.F8)(this.Ï†)*i.o5))*e,this.Ï‰z+=5/(2*o*s)*(n*(0,r.gn)(this.Ï†)*i.o5)*e}},{key:"updateWorkDone",value:function(e){var t=e*Math.abs(this.vy);this.WzI+=t,this.P+=e}},{key:"solvePaper",value:function(e,t,n,i){this.solve(e*(0,r.gn)(t),e*(0,r.F8)(t),-i*(0,r.F8)(t),i*(0,r.gn)(t),n)}},{key:"solve",value:function(e,t,n,r,i){this.vx=e,this.vy=t,this.Ï‰x=n,this.Ï‰y=r,this.Ï‰z=i,this.WzI=0,this.P=0,this.i=0,this.compressionPhase();var o=this.ee*this.ee*this.WzI;this.restitutionPhase(o)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/model/physics/physics.ts"(e,t,n){n.d(t,{$8:()=>R,Gp:()=>w,JD:()=>h,Mq:()=>l,QK:()=>p,QV:()=>S,Qy:()=>A,Un:()=>g,c0:()=>b,lx:()=>f,p2:()=>u,s0:()=>m,t6:()=>M,yO:()=>k});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/utils/utils.ts"),o=n("./src/model/physics/constants.ts"),s=n("./src/model/physics/mathaven.ts"),a=new r.Pq0;function l(e,t){return a.copy(e).addScaledVector((0,i.KM)(t),o.R)}var c={v:new r.Pq0,w:new r.Pq0};function u(e,t){var n=l(e,t).setZ(0);return c.v.copy((0,i.xb)(n).multiplyScalar(-o.gf*o.g)),c.w.copy((0,i.xb)((0,i.KM)(n)).multiplyScalar(2.5*o.gf*o.g/o.R)),c.w.setZ(-2.5*(o.Mz/(o.m*o.R*o.R))*Math.sign(t.z)),c}function h(e){var t=new r.Pq0(e.x,e.y,0).length(),n=5/7*o.x3/(o.m*o.R)/t,i=5/7*o.x3/(o.m*o.R*o.R)/t;return c.v.set(-n*e.y,n*e.x,0),c.w.set(-i*e.x,-i*e.y,-2.5*(o.Mz/(o.m*o.R*o.R))*Math.sign(e.z)),c}function f(e,t){var n=t.z;t.copy((0,i.KM)(e).multiplyScalar(1/o.R)),t.setZ(n)}function p(e,t,n,r){var o=r(t.clone().applyAxisAngle(i.up,e),n.clone().applyAxisAngle(i.up,e));return o.v.applyAxisAngle(i.up,-e),o.w.applyAxisAngle(i.up,-e),o}Object.freeze(c);var d=Math.asin(.1*o.R/o.R),v=(0,i.F8)(d),y=(0,i.gn)(d);function m(e,t){return new r.Pq0(e.x*v-e.z*y+o.R*t.y,-e.y-o.R*t.z*y+o.R*t.x*v)}function b(e){return e.x*y}function g(e){var t=3.5/o.m;return e.length()/t}function w(e){var t,n=1/o.m,i=.39+.257*(t=new r.Pq0(e/y,0,0)).x-.044*t.x*t.x;return o.gT*((1+i)*e)/n}function k(e,t){var n=w(b(e));return g(m(e,t))<=n}function x(e,t){return{c:b(e),s:m(e,t),A:3.5/o.m,B:1/o.m}}function T(e,t){var n=x(e,t),r=n.c,i=n.s,s=n.A,a=n.B,l=(1+o.e)*(r/a);return O(-i.x/s*v-l*y,i.y/s,i.x/s*y-l*v)}function P(e,t){var n,r=x(e,t),i=r.c,s=r.B,a=(1+o.e)*(i/s),l=.471-.241*Math.atan2(Math.abs((n=e).y),n.x),c=Math.atan2(e.y,e.x),u=Math.cos(c);return O(-l*a*u*y-a*y,l*a*Math.sin(c),l*a*u*y-a*v)}function S(e,t){return k(e,t)?T(e,t):P(e,t)}function R(e,t){var n=T(e,t),r=P(e,t),i=Math.sign(e.y)===Math.sign(t.z)?Math.cos(Math.atan2(e.y,e.x)):1;return{v:r.v.lerp(n.v,i),w:r.w.lerp(n.w,i)}}function O(e,t,n){return{v:new r.Pq0(e/o.m,t/o.m),w:new r.Pq0(-o.R/o.I*t*v,o.R/o.I*(e*v-n*y),o.R/o.I*t*y)}}function E(e,t){var n=new s.z(o.m,o.R,o.ee,o.oV,o._m+.1);n.solve(e.x,e.y,t.x,t.y,t.z);var i=new r.Pq0(n.vx,n.vy,0),a=new r.Pq0(n.Ï‰x,n.Ï‰y,n.Ï‰z);return{v:i.sub(e),w:a.sub(t)}}function A(e,t){return p(Math.PI/2,e,t,E)}function M(e,t){var n=Math.atan2(-e.x,e.y),r=2.5*t.length()*(e.length()*o.R)/(o.R*o.R),s=t.clone().normalize();return(0,i.KM)(s).applyAxisAngle(s,n).multiplyScalar(r)}},"./src/model/physics/pocket.ts"(e,t,n){n.d(t,{Z:()=>l});var r=n("./src/model/ball.ts"),i=n("./src/model/physics/constants.ts"),o=n("./src/utils/utils.ts");function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var l=function(){var e,t;function n(e,t){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");a(this,"pos",void 0),a(this,"radius",void 0),this.pos=e,this.radius=t}return e=[{key:"fall",value:function(e,t){return e.vel.z=-i.g*t,e.state=r.U.Falling,e.pocket=this,e.vel.length()}},{key:"updateFall",value:function(e,t){e.vel.addScaledVector(o.up,-(10*i.R)*t*i.g);var n=e.pos.z;if(e.pos.clone().setZ(0).distanceTo(this.pos)>this.radius-i.R){var s=this.pos.clone().sub(e.pos).normalize().setZ(0);n>-i.R/2&&(e.vel.addScaledVector(s,7*i.R*t*i.g),e.rvel.addScaledVector((0,o.KM)(s),7*t*i.g)),0>e.vel.dot(s)&&(e.ballmesh.trace.forceTrace(e.pos),e.vel.x=s.x*e.vel.length()/2,e.vel.y=s.y*e.vel.length()/2)}var a=this.restingDepth(e);n<a&&0!==e.rvel.length()&&(e.pos.z=a,e.vel.z=-i.R/10,e.rvel.copy(o.v_)),n<a-i.R&&(e.pos.z=a-i.R,e.setStationary(),e.state=r.U.InPocket)}},{key:"restingDepth",value:function(e){return -3*i.R-i.R*e.id/4}}],t=[{key:"willFall",value:function(e,t){return t.distanceTo(e.pos)<e.radius}},{key:"findPocket",value:function(e,t,r){var i=t.futurePosition(r);return e.find(function(e){return n.willFall(e,i)})}}],e&&s(n.prototype,e),t&&s(n,t),n}()},"./src/model/table.ts"(e,t,n){n.d(t,{X:()=>b});var r=n("./src/view/tablegeometry.ts"),i=n("./src/model/physics/physics.ts"),o=n("./src/view/pocketgeometry.ts"),s=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"bounceAny",value:function(e,n){var o=!(arguments.length>2)||void 0===arguments[2]||arguments[2],s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:i.$8,a=e.futurePosition(n);if(t.willBounceLong(a,o)){var l=a.y>r.P.tableY?-Math.PI/2:Math.PI/2;return t.bounceIn(l,e,s)}if(t.willBounceShort(a,o)){var c=a.x>r.P.tableX?0:Math.PI;return t.bounceIn(c,e,s)}}},{key:"willBounceShort",value:function(e,n){return n?t.willBounceShortSegment(o.f.pockets.pocketNW.knuckleSW.pos.y,o.f.pockets.pocketSW.knuckleNW.pos.y,e):t.willBounceShortSegment(r.P.Y,-r.P.Y,e)}},{key:"willBounceLong",value:function(e,n){return n?t.willBounceLongSegment(o.f.pockets.pocketNW.knuckleNE.pos.x,o.f.pockets.pocketN.knuckleNW.pos.x,e)||t.willBounceLongSegment(o.f.pockets.pocketN.knuckleNE.pos.x,o.f.pockets.pocketNE.knuckleNW.pos.x,e):t.willBounceLongSegment(-r.P.X,r.P.X,e)}},{key:"willBounceLongSegment",value:function(e,t,n){return n.x>e&&n.x<t&&Math.abs(n.y)>r.P.tableY}},{key:"willBounceShortSegment",value:function(e,t,n){return n.y>t&&n.y<e&&Math.abs(n.x)>r.P.tableX}},{key:"bounceIn",value:function(e,t,n){t.ballmesh.trace.forceTrace(t.futurePos);var r=(0,i.QK)(e,t.vel,t.rvel,n);return t.vel.add(r.v),t.rvel.add(r.w),r.v.length()}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}(),a=n("./src/model/physics/collision.ts"),l=n("./src/model/physics/knuckle.ts"),c=n("./src/model/physics/pocket.ts"),u=n("./src/view/cue.ts"),h=n("./src/model/ball.ts"),f=n("./src/events/aimevent.ts"),p=n("./src/model/outcome.ts"),d=n("./src/utils/utils.ts"),v=n("./src/model/physics/constants.ts");function y(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var b=function(){var e,t;function n(e){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");m(this,"balls",void 0),m(this,"cue",new u.s),m(this,"pairs",void 0),m(this,"outcome",[]),m(this,"cueball",void 0),m(this,"cushionModel",i.$8),m(this,"mesh",void 0),this.cueball=e[0],this.initialiseBalls(e)}return e=[{key:"initialiseBalls",value:function(e){this.balls=e,this.pairs=[];for(var t=0;t<e.length;t++)for(var n=0;n<e.length;n++)t<n&&this.pairs.push({a:e[t],b:e[n]})}},{key:"updateBallMesh",value:function(e){this.balls.forEach(function(t){t.updateMesh(e)})}},{key:"advance",value:function(e){for(var t=0;!this.prepareAdvanceAll(e);)if(t++>100)throw Error("Depth exceeded resolving collisions");this.balls.forEach(function(t){t.update(e),t.fround()})}},{key:"prepareAdvanceAll",value:function(e){var t=this;return this.pairs.every(function(n){return t.prepareAdvancePair(n.a,n.b,e)})&&this.balls.every(function(n){return t.prepareAdvanceToCushions(n,e)})}},{key:"prepareAdvancePair",value:function(e,t,n){if(a.F.willCollide(e,t,n)){var r=a.F.collide(e,t);return this.outcome.push(p.P.collision(e,t,r)),!1}return!0}},{key:"prepareAdvanceToCushions",value:function(e,t){if(!e.onTable())return!0;var n=e.futurePosition(t);if(Math.abs(n.y)<r.P.tableY&&Math.abs(n.x)<r.P.tableX)return!0;var i=s.bounceAny(e,t,r.P.hasPockets,this.cushionModel);if(i)return this.outcome.push(p.P.cushion(e,i)),!1;var a=l.O.findBouncing(e,t);if(a){var u=a.bounce(e);return this.outcome.push(p.P.cushion(e,u)),!1}var h=c.Z.findPocket(o.f.pocketCenters,e,t);if(h){var f=h.fall(e,t);return this.outcome.push(p.P.pot(e,f)),!1}return!0}},{key:"allStationary",value:function(){return this.balls.every(function(e){return!e.inMotion()})}},{key:"inPockets",value:function(){return this.balls.reduce(function(e,t){return t.onTable()?e:e+1},0)}},{key:"hit",value:function(){this.cue.hit(this.cueball),this.balls.forEach(function(e){e.ballmesh.trace.reset()})}},{key:"serialise",value:function(){return{balls:this.balls.map(function(e){return e.serialise()}),aim:this.cue.aim.copy()}}},{key:"updateFromSerialised",value:function(e){var t=this;e.balls&&e.balls.forEach(function(e){return h.c.updateFromSerialised(t.balls[e.id],e)}),e.aim&&(this.cue.aim=f.w.fromJson(e.aim))}},{key:"shortSerialise",value:function(){return this.balls.map(function(e){return[e.pos.x,e.pos.y]}).reduce(function(e,t){return e.concat(t)},[])}},{key:"updateFromShortSerialised",value:function(e){this.balls.forEach(function(t,n){t.pos.x=e[2*n],t.pos.y=e[2*n+1],t.pos.z=0,t.vel.copy(d.v_),t.rvel.copy(d.v_),t.state=h.U.Stationary})}},{key:"addToScene",value:function(e){this.balls.forEach(function(t){t.ballmesh.addToScene(e)}),e.add(this.cue.mesh),e.add(this.cue.helperMesh),e.add(this.cue.placerMesh)}},{key:"showTraces",value:function(e){this.balls.forEach(function(t){t.ballmesh.trace.line.visible=e,t.ballmesh.trace.reset()})}},{key:"showSpin",value:function(e){this.balls.forEach(function(t){t.ballmesh.spinAxisArrow.visible=e})}},{key:"halt",value:function(){this.balls.forEach(function(e){e.vel.copy(d.v_),e.rvel.copy(d.v_),e.state=h.U.Stationary})}},{key:"roundCueBallPosition",value:function(){var e=this.cueball.pos.clone();this.overlapsAny(e)||this.cueball.pos.copy(e)}},{key:"overlapsAny",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.cueball;return this.balls.filter(function(e){return e!==t}).some(function(t){return t.pos.distanceTo(e)<2*v.R})}}],t=[{key:"fromSerialised",value:function(e){var t=new n(e.balls.map(function(e){return h.c.fromSerialised(e)}));return t.updateFromSerialised(e),t}}],e&&y(n.prototype,e),t&&y(n,t),n}()},"./src/network/client/matchresult.ts"(e,t,n){n.d(t,{n:()=>l});var r=n("./src/events/chatevent.ts"),i=n("./src/events/notificationevent.ts"),o=n("./src/controller/end.ts"),s=n("./src/network/client/session.ts"),a=n("./src/utils/gameover.ts"),l=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"presentGameEnd",value:function(e,t){e.eventQueue.push(new r.b(null,"game over")),e.recorder.wholeGameLink();var n=s.N.hasInstance()?s.N.getInstance():null,i=s.N.playerIndex(),a=(e.scores[0]>=e.scores[1]?0:1)===i,l=this.getScoreSubtext(e,n,i);a?(this.notifyWin(e,l),this.sendLossNotification(e)):s.N.isSpectator()?this.notifySpectator(e,l):this.notifyLoss(e,l);var c=this.createMatchResult(e,t,n,i);return new o.o(e,a?c:void 0)}},{key:"notifyWin",value:function(e,t){e.notifyLocal({type:"GameOver",title:"YOU WON",subtext:t,icon:"ðŸ†",extraClass:"is-winner",extra:a.c.forMode(e.isSinglePlayer),duration:0})}},{key:"notifyLoss",value:function(e,t){e.notifyLocal({type:"GameOver",title:"YOU LOST",subtext:t,icon:"ðŸ¥ˆ",extraClass:"is-loser",extra:a.c.forMode(e.isSinglePlayer),duration:0})}},{key:"notifySpectator",value:function(e,t){e.notifyLocal({type:"GameOver",title:"GAME OVER",subtext:t,icon:"ðŸ†",extraClass:"",extra:a.c.lobby,duration:0})}},{key:"sendLossNotification",value:function(e){e.isSinglePlayer||e.sendEvent(new i.c({type:"GameOver",title:"YOU LOST",icon:"ðŸ¥ˆ",extraClass:"is-loser",extra:a.c.forMode(!1),duration:0}))}},{key:"getScoreSubtext",value:function(e,t,n){if(e.isSinglePlayer)return"Score: ".concat(e.scores[n]);var r=0===n?(null==t?void 0:t.playername)||"You":(null==t?void 0:t.opponentName)||"Opponent",i=1===n?(null==t?void 0:t.playername)||"You":(null==t?void 0:t.opponentName)||"Opponent";return"".concat(r," ").concat(e.scores[0]," - ").concat(e.scores[1]," ").concat(i)}},{key:"createMatchResult",value:function(e,t,n,r){var i=e.scores[0]>=e.scores[1]?0:1,o=1-i,s=i===r?(null==n?void 0:n.playername)||"Anon":(null==n?void 0:n.opponentName)||"Opponent",a=o===r?(null==n?void 0:n.playername)||"Anon":(null==n?void 0:n.opponentName)||"Opponent",l={winner:s,winnerScore:e.scores[i],ruleType:t};return(null==n?void 0:n.opponentName)&&(l.loser=a,l.loserScore=e.scores[o]),l}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/network/client/nchanmessagerelay.ts"(e,t,n){function r(e,t,n,r,i,o,s){try{var a=e[o](s),l=a.value}catch(e){n(e);return}a.done?t(l):Promise.resolve(l).then(r,i)}n.d(t,{p:()=>o});function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var o=function(){var e;function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"billiards-network.onrender.com";if(!(this instanceof t))throw TypeError("Cannot call a class as a function");i(this,"baseURL",void 0),i(this,"websockets",void 0),this.baseURL=e,this.websockets=new Map}return e=[{key:"subscribe",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"table",r="wss://".concat(this.baseURL,"/subscribe/").concat(n,"/").concat(e),i=new WebSocket(r);console.log("Subscribed to ",r),i.onmessage=function(e){try{var n=e.data;t(n)}catch(e){console.error("Error parsing message:",e)}},i.onerror=function(e){console.error("WebSocket error:",e)},i.onopen=function(){console.log("Connected to ".concat(r))},i.onclose=function(e){console.log("Disconnected from ".concat(r,":"),e.reason)},this.websockets.set("".concat(n,"/").concat(e),i)}},{key:"publish",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"table";fetch("https://".concat(this.baseURL,"/publish/").concat(n,"/").concat(e),{method:"POST",headers:{"Content-Type":"application/json"},body:t}).catch(function(e){console.error("Publication error:",e)})}},{key:"getOnlineCount",value:function(){var e;return(e=function(){var e;return function(e,t){var n,r,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype),a=Object.defineProperty;return a(s,"next",{value:l(0)}),a(s,"throw",{value:l(1)}),a(s,"return",{value:l(2)}),"function"==typeof Symbol&&a(s,Symbol.iterator,{value:function(){return this}}),s;function l(a){return function(l){var c=[a,l];if(n)throw TypeError("Generator is already executing.");for(;s&&(s=0,c[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&c[0]?r.return:c[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,c[1])).done)return i;switch(r=0,i&&(c=[2&c[0],i.value]),c[0]){case 0:case 1:i=c;break;case 4:return o.label++,{value:c[1],done:!1};case 5:o.label++,r=c[1],c=[0];continue;case 7:c=o.ops.pop(),o.trys.pop();continue;default:if(!(i=(i=o.trys).length>0&&i[i.length-1])&&(6===c[0]||2===c[0])){o=0;continue}if(3===c[0]&&(!i||c[1]>i[0]&&c[1]<i[3])){o.label=c[1];break}if(6===c[0]&&o.label<i[1]){o.label=i[1],i=c;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(c);break}i[2]&&o.ops.pop(),o.trys.pop();continue}c=t.call(e,o)}catch(e){c=[6,e],r=0}finally{n=i=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}}(this,function(t){switch(t.label){case 0:return t.trys.push([0,3,,4]),[4,fetch("https://".concat(this.baseURL,"/publish/presence/lobby"),{method:"POST",headers:{Accept:"application/json"}})];case 1:return[4,t.sent().json()];case 2:return[2,"number"==typeof(e=t.sent()).subscribers?e.subscribers:null];case 3:return t.sent(),[2,null];case 4:return[2]}})},function(){var t=this,n=arguments;return new Promise(function(i,o){var s=e.apply(t,n);function a(e){r(s,i,o,a,l,"next",e)}function l(e){r(s,i,o,a,l,"throw",e)}a(void 0)})}).call(this)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/network/client/session.ts"(e,t,n){n.d(t,{N:()=>i});function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var i=function(){var e;function t(e,n,i,o){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");r(this,"playername",void 0),r(this,"clientId",void 0),r(this,"tableId",void 0),r(this,"spectator",void 0),r(this,"opponentName",void 0),r(this,"playerIndex",void 0),this.playername=e,this.clientId=n,this.tableId=i,this.spectator=o,this.playerIndex=0}return e=[{key:"getInstance",value:function(){if(!t.instance)throw Error("Session not initialized");return t.instance}},{key:"hasInstance",value:function(){return void 0!==t.instance}},{key:"playerIndex",value:function(){return t.instance?t.instance.playerIndex:0}},{key:"isSpectator",value:function(){return void 0!==t.instance&&t.getInstance().spectator}},{key:"reset",value:function(){t.instance=void 0}},{key:"init",value:function(e,n,r,i){t.instance=new t(n,e,r,i)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();r(i,"instance",void 0)},"./src/utils/dom.ts"(e,t,n){function r(e){return document.getElementById(e)}function i(e){return document.getElementById(e)}function o(e){return document.getElementById(e)}function s(e){return document.getElementById(e)}n.d(t,{V4:()=>o,dX:()=>s,id:()=>r,vq:()=>i})},"./src/utils/gameover.ts"(e,t,n){n.d(t,{c:()=>r});var r={lobby:"<button onclick=\"location.href='".concat("https://scoreboard-tailuge.vercel.app/","'\">Lobby</button>"),newGame:'<button onclick="location.reload()">New Game</button>',replay:'<button onclick="location.reload()">Replay</button>',forMode:function(e){return e?this.newGame+this.lobby:this.lobby}}},"./src/utils/gltf.ts"(e,t,n){n.d(t,{KP:()=>ex,Ro:()=>eT});var r=n("./node_modules/three/build/three.core.js");let i={POSITION:["byte","byte normalized","unsigned byte","unsigned byte normalized","short","short normalized","unsigned short","unsigned short normalized"],NORMAL:["byte normalized","short normalized"],TANGENT:["byte normalized","short normalized"],TEXCOORD:["byte","byte normalized","unsigned byte","short","short normalized","unsigned short"]};class o{constructor(){this.textureUtils=null,this.pluginCallbacks=[],this.register(function(e){return new v(e)}),this.register(function(e){return new y(e)}),this.register(function(e){return new w(e)}),this.register(function(e){return new k(e)}),this.register(function(e){return new x(e)}),this.register(function(e){return new T(e)}),this.register(function(e){return new m(e)}),this.register(function(e){return new b(e)}),this.register(function(e){return new g(e)}),this.register(function(e){return new P(e)}),this.register(function(e){return new S(e)}),this.register(function(e){return new R(e)}),this.register(function(e){return new O(e)}),this.register(function(e){return new E(e)})}register(e){return -1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return -1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}setTextureUtils(e){return this.textureUtils=e,this}parse(e,t,n,r){let i=new d,o=[];for(let e=0,t=this.pluginCallbacks.length;e<t;e++)o.push(this.pluginCallbacks[e](i));i.setPlugins(o),i.setTextureUtils(this.textureUtils),i.writeAsync(e,t,r).catch(n)}parseAsync(e,t){let n=this;return new Promise(function(r,i){n.parse(e,r,i,t)})}}let s="KHR_mesh_quantization",a={};a[r.hxR]=9728,a[r.pHI]=9984,a[r.Cfg]=9986,a[r.k6q]=9729,a[r.kRr]=9985,a[r.$_I]=9987,a[r.ghU]=33071,a[r.GJx]=10497,a[r.kTW]=33648;let l={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},c=new r.Q1f;function u(e,t){return e.length===t.length&&e.every(function(e,n){return e===t[n]})}function h(e){return 4*Math.ceil(e/4)}function f(e,t=0){let n=h(e.byteLength);if(n!==e.byteLength){let r=new Uint8Array(n);if(r.set(new Uint8Array(e)),0!==t)for(let i=e.byteLength;i<n;i++)r[i]=t;return r.buffer}return e}function p(){return"u"<typeof document&&"u">typeof OffscreenCanvas?new OffscreenCanvas(1,1):document.createElement("canvas")}class d{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.extensionsRequired={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter r"+r.sPf}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map},this.textureUtils=null}setPlugins(e){this.plugins=e}setTextureUtils(e){this.textureUtils=e}async writeAsync(e,t,n={}){this.options=Object.assign({binary:!1,trs:!1,onlyVisible:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},n),this.options.animations.length>0&&(this.options.trs=!0),await this.processInputAsync(e),await Promise.all(this.pending);let r=this.buffers,i=this.json;n=this.options;let o=this.extensionsUsed,s=this.extensionsRequired,a=new Blob(r,{type:"application/octet-stream"}),l=Object.keys(o),c=Object.keys(s);if(l.length>0&&(i.extensionsUsed=l),c.length>0&&(i.extensionsRequired=c),i.buffers&&i.buffers.length>0&&(i.buffers[0].byteLength=a.size),!0===n.binary){let e=new FileReader;e.readAsArrayBuffer(a),e.onloadend=function(){var n;let r=f(e.result),o=new DataView(new ArrayBuffer(8));o.setUint32(0,r.byteLength,!0),o.setUint32(4,5130562,!0);let s=f((n=JSON.stringify(i),new TextEncoder().encode(n).buffer),32),a=new DataView(new ArrayBuffer(8));a.setUint32(0,s.byteLength,!0),a.setUint32(4,0x4e4f534a,!0);let l=new ArrayBuffer(12),c=new DataView(l);c.setUint32(0,0x46546c67,!0),c.setUint32(4,2,!0);let u=12+a.byteLength+s.byteLength+o.byteLength+r.byteLength;c.setUint32(8,u,!0);let h=new Blob([l,a,s,o,r],{type:"application/octet-stream"}),p=new FileReader;p.readAsArrayBuffer(h),p.onloadend=function(){t(p.result)}}}else if(i.buffers&&i.buffers.length>0){let e=new FileReader;e.readAsDataURL(a),e.onloadend=function(){let n=e.result;i.buffers[0].uri=n,t(i)}}else t(i)}serializeUserData(e,t){if(0===Object.keys(e.userData).length)return;let n=this.options,r=this.extensionsUsed;try{let i=JSON.parse(JSON.stringify(e.userData));if(n.includeCustomExtensions&&i.gltfExtensions){for(let e in void 0===t.extensions&&(t.extensions={}),i.gltfExtensions)t.extensions[e]=i.gltfExtensions[e],r[e]=!0;delete i.gltfExtensions}Object.keys(i).length>0&&(t.extras=i)}catch(t){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+t.message)}}getUID(e,t=!1){if(!1===this.uids.has(e)){let t=new Map;t.set(!0,this.uid++),t.set(!1,this.uid++),this.uids.set(e,t)}return this.uids.get(e).get(t)}isNormalizedNormalAttribute(e){if(this.cache.attributesNormalized.has(e))return!1;let t=new r.Pq0;for(let n=0,r=e.count;n<r;n++)if(Math.abs(t.fromBufferAttribute(e,n).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(e){let t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);let n=e.clone(),i=new r.Pq0;for(let e=0,t=n.count;e<t;e++)i.fromBufferAttribute(n,e),0===i.x&&0===i.y&&0===i.z?i.setX(1):i.normalize(),n.setXYZ(e,i.x,i.y,i.z);return t.attributesNormalized.set(e,n),n}applyTextureTransform(e,t){let n=!1,r={};(0!==t.offset.x||0!==t.offset.y)&&(r.offset=t.offset.toArray(),n=!0),0!==t.rotation&&(r.rotation=t.rotation,n=!0),(1!==t.repeat.x||1!==t.repeat.y)&&(r.scale=t.repeat.toArray(),n=!0),n&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=r,this.extensionsUsed.KHR_texture_transform=!0)}async buildMetalRoughTextureAsync(e,t){if(e===t)return e;function n(e){return e.colorSpace===r.er$?function(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}:function(e){return e}}e instanceof r.FvD&&(e=await this.decompressTextureAsync(e)),t instanceof r.FvD&&(t=await this.decompressTextureAsync(t));let i=e?e.image:null,o=t?t.image:null,s=Math.max(i?i.width:0,o?o.width:0),a=Math.max(i?i.height:0,o?o.height:0),l=p();l.width=s,l.height=a;let c=l.getContext("2d",{willReadFrequently:!0});c.fillStyle="#00ffff",c.fillRect(0,0,s,a);let u=c.getImageData(0,0,s,a);if(i){c.drawImage(i,0,0,s,a);let t=n(e),r=c.getImageData(0,0,s,a).data;for(let e=2;e<r.length;e+=4)u.data[e]=256*t(r[e]/256)}if(o){c.drawImage(o,0,0,s,a);let e=n(t),r=c.getImageData(0,0,s,a).data;for(let t=1;t<r.length;t+=4)u.data[t]=256*e(r[t]/256)}c.putImageData(u,0,0);let h=(e||t).clone();return h.source=new r.kLi(l),h.colorSpace=r.jf0,h.channel=(e||t).channel,e&&t&&e.channel!==t.channel&&console.warn("THREE.GLTFExporter: UV channels for metalnessMap and roughnessMap textures must match."),console.warn("THREE.GLTFExporter: Merged metalnessMap and roughnessMap textures."),h}async decompressTextureAsync(e,t=1/0){if(null===this.textureUtils)throw Error("THREE.GLTFExporter: setTextureUtils() must be called to process compressed textures.");return await this.textureUtils.decompress(e,t)}processBuffer(e){let t=this.json,n=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),n.push(e),0}processBufferView(e,t,n,i,o){let s,a=this.json;switch(!a.bufferViews&&(a.bufferViews=[]),t){case 5120:case 5121:s=1;break;case 5122:case 5123:s=2;break;default:s=4}let l=e.itemSize*s;34962===o&&(l=4*Math.ceil(l/4));let c=h(i*l),u=new DataView(new ArrayBuffer(c)),f=0;for(let o=n;o<n+i;o++){for(let n=0;n<e.itemSize;n++){let i;e.itemSize>4?i=e.array[o*e.itemSize+n]:(0===n?i=e.getX(o):1===n?i=e.getY(o):2===n?i=e.getZ(o):3===n&&(i=e.getW(o)),!0===e.normalized&&(i=r.cj9.normalize(i,e.array))),5126===t?u.setFloat32(f,i,!0):5124===t?u.setInt32(f,i,!0):5125===t?u.setUint32(f,i,!0):5122===t?u.setInt16(f,i,!0):5123===t?u.setUint16(f,i,!0):5120===t?u.setInt8(f,i):5121===t&&u.setUint8(f,i),f+=s}f%l!=0&&(f+=l-f%l)}let p={buffer:this.processBuffer(u.buffer),byteOffset:this.byteOffset,byteLength:c};return void 0!==o&&(p.target=o),34962===o&&(p.byteStride=l),this.byteOffset+=c,a.bufferViews.push(p),{id:a.bufferViews.length-1,byteLength:0}}processBufferViewImage(e){let t=this,n=t.json;return n.bufferViews||(n.bufferViews=[]),new Promise(function(r){let i=new FileReader;i.readAsArrayBuffer(e),i.onloadend=function(){let e=f(i.result),o={buffer:t.processBuffer(e),byteOffset:t.byteOffset,byteLength:e.byteLength};t.byteOffset+=e.byteLength,r(n.bufferViews.push(o)-1)}})}processAccessor(e,t,n,i){let o,s,a=this.json;if(e.array.constructor===Float32Array)o=5126;else if(e.array.constructor===Int32Array)o=5124;else if(e.array.constructor===Uint32Array)o=5125;else if(e.array.constructor===Int16Array)o=5122;else if(e.array.constructor===Uint16Array)o=5123;else if(e.array.constructor===Int8Array)o=5120;else if(e.array.constructor===Uint8Array)o=5121;else throw Error("THREE.GLTFExporter: Unsupported bufferAttribute component type: "+e.array.constructor.name);if(void 0===n&&(n=0),(void 0===i||i===1/0)&&(i=e.count),0===i)return null;let l=function(e,t,n){let i={min:Array(e.itemSize).fill(1/0),max:Array(e.itemSize).fill(-1/0)};for(let o=t;o<t+n;o++)for(let t=0;t<e.itemSize;t++){let n;e.itemSize>4?n=e.array[o*e.itemSize+t]:(0===t?n=e.getX(o):1===t?n=e.getY(o):2===t?n=e.getZ(o):3===t&&(n=e.getW(o)),!0===e.normalized&&(n=r.cj9.normalize(n,e.array))),i.min[t]=Math.min(i.min[t],n),i.max[t]=Math.max(i.max[t],n)}return i}(e,n,i);void 0!==t&&(s=e===t.index?34963:34962);let c=this.processBufferView(e,o,n,i,s),u={bufferView:c.id,byteOffset:c.byteOffset,componentType:o,count:i,max:l.max,min:l.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",9:"MAT3",16:"MAT4"}[e.itemSize]};return!0===e.normalized&&(u.normalized=!0),a.accessors||(a.accessors=[]),a.accessors.push(u)-1}processImage(e,t,n,i="image/png"){if(null!==e){let o=this,s=o.cache,a=o.json,l=o.options,c=o.pending;s.images.has(e)||s.images.set(e,{});let u=s.images.get(e),h=i+":flipY/"+n.toString();if(void 0!==u[h])return u[h];a.images||(a.images=[]);let f={mimeType:i},d=p();d.width=Math.min(e.width,l.maxTextureSize),d.height=Math.min(e.height,l.maxTextureSize);let v=d.getContext("2d",{willReadFrequently:!0});if(!0===n&&(v.translate(0,d.height),v.scale(1,-1)),void 0!==e.data){t!==r.GWd&&console.error("GLTFExporter: Only RGBAFormat is supported.",t),(e.width>l.maxTextureSize||e.height>l.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",e);let n=new Uint8ClampedArray(e.height*e.width*4);for(let t=0;t<n.length;t+=4)n[t+0]=e.data[t+0],n[t+1]=e.data[t+1],n[t+2]=e.data[t+2],n[t+3]=e.data[t+3];v.putImageData(new ImageData(n,e.width,e.height),0,0)}else if("u">typeof HTMLImageElement&&e instanceof HTMLImageElement||"u">typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"u">typeof ImageBitmap&&e instanceof ImageBitmap||"u">typeof OffscreenCanvas&&e instanceof OffscreenCanvas)v.drawImage(e,0,0,d.width,d.height);else throw Error("THREE.GLTFExporter: Invalid image type. Use HTMLImageElement, HTMLCanvasElement, ImageBitmap or OffscreenCanvas.");!0===l.binary?c.push((function(e,t){if(!("u">typeof OffscreenCanvas&&e instanceof OffscreenCanvas))return new Promise(n=>e.toBlob(n,t));{let n;return"image/jpeg"===t?n=.92:"image/webp"===t&&(n=.8),e.convertToBlob({type:t,quality:n})}})(d,i).then(e=>o.processBufferViewImage(e)).then(e=>{f.bufferView=e})):f.uri=r.HgN.getDataURL(d,i);let y=a.images.push(f)-1;return u[h]=y,y}throw Error("THREE.GLTFExporter: No valid image data found. Unable to process texture.")}processSampler(e){let t=this.json;t.samplers||(t.samplers=[]);let n={magFilter:a[e.magFilter],minFilter:a[e.minFilter],wrapS:a[e.wrapS],wrapT:a[e.wrapT]};return t.samplers.push(n)-1}async processTextureAsync(e){let t=this.options,n=this.cache,i=this.json;if(n.textures.has(e))return n.textures.get(e);i.textures||(i.textures=[]),e instanceof r.FvD&&(e=await this.decompressTextureAsync(e,t.maxTextureSize));let o=e.userData.mimeType;"image/webp"===o&&(o="image/png");let s={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY,o)};e.name&&(s.name=e.name),await this._invokeAllAsync(async function(t){t.writeTexture&&await t.writeTexture(e,s)});let a=i.textures.push(s)-1;return n.textures.set(e,a),a}async processMaterialAsync(e){let t=this.cache,n=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;n.materials||(n.materials=[]);let i={pbrMetallicRoughness:{}};!0!==e.isMeshStandardMaterial&&!0!==e.isMeshBasicMaterial&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");let o=e.color.toArray().concat([e.opacity]);if(u(o,[1,1,1,1])||(i.pbrMetallicRoughness.baseColorFactor=o),e.isMeshStandardMaterial?(i.pbrMetallicRoughness.metallicFactor=e.metalness,i.pbrMetallicRoughness.roughnessFactor=e.roughness):(i.pbrMetallicRoughness.metallicFactor=0,i.pbrMetallicRoughness.roughnessFactor=1),e.metalnessMap||e.roughnessMap){let t=await this.buildMetalRoughTextureAsync(e.metalnessMap,e.roughnessMap),n={index:await this.processTextureAsync(t),texCoord:t.channel};this.applyTextureTransform(n,t),i.pbrMetallicRoughness.metallicRoughnessTexture=n}if(e.map){let t={index:await this.processTextureAsync(e.map),texCoord:e.map.channel};this.applyTextureTransform(t,e.map),i.pbrMetallicRoughness.baseColorTexture=t}if(e.emissive){let t=e.emissive;if(Math.max(t.r,t.g,t.b)>0&&(i.emissiveFactor=e.emissive.toArray()),e.emissiveMap){let t={index:await this.processTextureAsync(e.emissiveMap),texCoord:e.emissiveMap.channel};this.applyTextureTransform(t,e.emissiveMap),i.emissiveTexture=t}}if(e.normalMap){let t={index:await this.processTextureAsync(e.normalMap),texCoord:e.normalMap.channel};e.normalScale&&1!==e.normalScale.x&&(t.scale=e.normalScale.x),this.applyTextureTransform(t,e.normalMap),i.normalTexture=t}if(e.aoMap){let t={index:await this.processTextureAsync(e.aoMap),texCoord:e.aoMap.channel};1!==e.aoMapIntensity&&(t.strength=e.aoMapIntensity),this.applyTextureTransform(t,e.aoMap),i.occlusionTexture=t}e.transparent?i.alphaMode="BLEND":e.alphaTest>0&&(i.alphaMode="MASK",i.alphaCutoff=e.alphaTest),e.side===r.$EB&&(i.doubleSided=!0),""!==e.name&&(i.name=e.name),this.serializeUserData(e,i),await this._invokeAllAsync(async function(t){t.writeMaterialAsync&&await t.writeMaterialAsync(e,i)});let s=n.materials.push(i)-1;return t.materials.set(e,s),s}async processMeshAsync(e){let t,n=this.cache,i=this.json,s=[e.geometry.uuid];if(Array.isArray(e.material))for(let t=0,n=e.material.length;t<n;t++)s.push(e.material[t].uuid);else s.push(e.material.uuid);let a=s.join(":");if(n.meshes.has(a))return n.meshes.get(a);let l=e.geometry;t=e.isLineSegments?1:e.isLineLoop?2:e.isLine?3:e.isPoints?0:e.material.wireframe?1:4;let c={},u={},h=[],f=[],p={uv:"TEXCOORD_0",uv1:"TEXCOORD_1",uv2:"TEXCOORD_2",uv3:"TEXCOORD_3",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},d=l.getAttribute("normal");void 0===d||this.isNormalizedNormalAttribute(d)||(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),l.setAttribute("normal",this.createNormalizedNormalAttribute(d)));let v=null;for(let e in l.attributes){if("morph"===e.slice(0,5))continue;let t=l.attributes[e];if(e=p[e]||e.toUpperCase(),/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(e)||(e="_"+e),n.attributes.has(this.getUID(t))){u[e]=n.attributes.get(this.getUID(t));continue}v=null;let i=t.array;"JOINTS_0"!==e||i instanceof Uint16Array||i instanceof Uint8Array?(i instanceof Uint32Array||i instanceof Int32Array)&&!e.startsWith("_")&&(console.warn(`GLTFExporter: Attribute "${e}" converted to type FLOAT.`),v=o.Utils.toFloat32BufferAttribute(t)):(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),v=new r.THS(new Uint16Array(i),t.itemSize,t.normalized));let s=this.processAccessor(v||t,l);null!==s&&(e.startsWith("_")||this.detectMeshQuantization(e,t),u[e]=s,n.attributes.set(this.getUID(t),s))}if(void 0!==d&&l.setAttribute("normal",d),0===Object.keys(u).length)return null;if(void 0!==e.morphTargetInfluences&&e.morphTargetInfluences.length>0){let t=[],r=[],i={};if(void 0!==e.morphTargetDictionary)for(let t in e.morphTargetDictionary)i[e.morphTargetDictionary[t]]=t;for(let o=0;o<e.morphTargetInfluences.length;++o){let s={},a=!1;for(let e in l.morphAttributes){if("position"!==e&&"normal"!==e){a||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),a=!0);continue}let t=l.morphAttributes[e][o],r=e.toUpperCase(),i=l.attributes[e];if(n.attributes.has(this.getUID(t,!0))){s[r]=n.attributes.get(this.getUID(t,!0));continue}let c=t.clone();if(!l.morphTargetsRelative)for(let e=0,n=t.count;e<n;e++)for(let n=0;n<t.itemSize;n++)0===n&&c.setX(e,t.getX(e)-i.getX(e)),1===n&&c.setY(e,t.getY(e)-i.getY(e)),2===n&&c.setZ(e,t.getZ(e)-i.getZ(e)),3===n&&c.setW(e,t.getW(e)-i.getW(e));s[r]=this.processAccessor(c,l),n.attributes.set(this.getUID(i,!0),s[r])}f.push(s),t.push(e.morphTargetInfluences[o]),void 0!==e.morphTargetDictionary&&r.push(i[o])}c.weights=t,r.length>0&&(c.extras={},c.extras.targetNames=r)}let y=Array.isArray(e.material);if(y&&0===l.groups.length)return null;let m=!1;if(y&&null===l.index){let e=[];for(let t=0,n=l.attributes.position.count;t<n;t++)e[t]=t;l.setIndex(e),m=!0}let b=y?e.material:[e.material],g=y?l.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let e=0,r=g.length;e<r;e++){let r={mode:t,attributes:u};if(this.serializeUserData(l,r),f.length>0&&(r.targets=f),null!==l.index){let t=this.getUID(l.index);(void 0!==g[e].start||void 0!==g[e].count)&&(t+=":"+g[e].start+":"+g[e].count),n.attributes.has(t)?r.indices=n.attributes.get(t):(r.indices=this.processAccessor(l.index,l,g[e].start,g[e].count),n.attributes.set(t,r.indices)),null===r.indices&&delete r.indices}let i=await this.processMaterialAsync(b[g[e].materialIndex]);null!==i&&(r.material=i),h.push(r)}!0===m&&l.setIndex(null),c.primitives=h,i.meshes||(i.meshes=[]),await this._invokeAllAsync(function(t){t.writeMesh&&t.writeMesh(e,c)});let w=i.meshes.push(c)-1;return n.meshes.set(a,w),w}detectMeshQuantization(e,t){let n;if(this.extensionsUsed[s])return;switch(t.array.constructor){case Int8Array:n="byte";break;case Uint8Array:n="unsigned byte";break;case Int16Array:n="short";break;case Uint16Array:n="unsigned short";break;default:return}t.normalized&&(n+=" normalized");let r=e.split("_",1)[0];i[r]&&i[r].includes(n)&&(this.extensionsUsed[s]=!0,this.extensionsRequired[s]=!0)}processCamera(e){let t=this.json;t.cameras||(t.cameras=[]);let n=e.isOrthographicCamera,i={type:n?"orthographic":"perspective"};return n?i.orthographic={xmag:2*e.right,ymag:2*e.top,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:i.perspective={aspectRatio:e.aspect,yfov:r.cj9.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},""!==e.name&&(i.name=e.type),t.cameras.push(i)-1}processAnimation(e,t){let n=this.json,i=this.nodeMap;n.animations||(n.animations=[]);let s=(e=o.Utils.mergeMorphTargetTracks(e.clone(),t)).tracks,a=[],c=[];for(let e=0;e<s.length;++e){let n,o=s[e],u=r.Nwf.parseTrackName(o.name),h=r.Nwf.findNode(t,u.nodeName),f=l[u.propertyName];if("bones"===u.objectName&&(h=!0===h.isSkinnedMesh?h.skeleton.getBoneByName(u.objectIndex):void 0),!h||!f){console.warn('THREE.GLTFExporter: Could not export animation track "%s".',o.name);continue}let p=o.values.length/o.times.length;f===l.morphTargetInfluences&&(p/=h.morphTargetInfluences.length),!0===o.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(n="CUBICSPLINE",p/=3):n=o.getInterpolation()===r.ljd?"STEP":"LINEAR",c.push({input:this.processAccessor(new r.THS(o.times,1)),output:this.processAccessor(new r.THS(o.values,p)),interpolation:n}),a.push({sampler:c.length-1,target:{node:i.get(h),path:f}})}let u={name:e.name||"clip_"+n.animations.length,samplers:c,channels:a};return this.serializeUserData(e,u),n.animations.push(u),n.animations.length-1}processSkin(e){let t=this.json,n=this.nodeMap,i=t.nodes[n.get(e)],o=e.skeleton;if(void 0===o)return null;let s=e.skeleton.bones[0];if(void 0===s)return null;let a=[],l=new Float32Array(16*o.bones.length),c=new r.kn4;for(let t=0;t<o.bones.length;++t)a.push(n.get(o.bones[t])),c.copy(o.boneInverses[t]),c.multiply(e.bindMatrix).toArray(l,16*t);return void 0===t.skins&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new r.THS(l,16)),joints:a,skeleton:n.get(s)}),i.skin=t.skins.length-1}async processNodeAsync(e){let t=this.json,n=this.options,r=this.nodeMap;t.nodes||(t.nodes=[]);let i={};if(n.trs){let t=e.quaternion.toArray(),n=e.position.toArray(),r=e.scale.toArray();u(t,[0,0,0,1])||(i.rotation=t),u(n,[0,0,0])||(i.translation=n),u(r,[1,1,1])||(i.scale=r)}else e.matrixAutoUpdate&&e.updateMatrix(),!1===u(e.matrix.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])&&(i.matrix=e.matrix.elements);if(""!==e.name&&(i.name=String(e.name)),this.serializeUserData(e,i),e.isMesh||e.isLine||e.isPoints){let t=await this.processMeshAsync(e);null!==t&&(i.mesh=t)}else e.isCamera&&(i.camera=this.processCamera(e));e.isSkinnedMesh&&this.skins.push(e);let o=t.nodes.push(i)-1;if(r.set(e,o),e.children.length>0){let t=[];for(let r=0,i=e.children.length;r<i;r++){let i=e.children[r];if(i.visible||!1===n.onlyVisible){let e=await this.processNodeAsync(i);null!==e&&t.push(e)}}t.length>0&&(i.children=t)}return await this._invokeAllAsync(function(t){t.writeNode&&t.writeNode(e,i)}),o}async processSceneAsync(e){let t=this.json,n=this.options;t.scenes||(t.scenes=[],t.scene=0);let r={};""!==e.name&&(r.name=e.name),t.scenes.push(r);let i=[];for(let t=0,r=e.children.length;t<r;t++){let r=e.children[t];if(r.visible||!1===n.onlyVisible){let e=await this.processNodeAsync(r);null!==e&&i.push(e)}}i.length>0&&(r.nodes=i),this.serializeUserData(e,r)}async processObjectsAsync(e){let t=new r.Z58;t.name="AuxScene";for(let n=0;n<e.length;n++)t.children.push(e[n]);await this.processSceneAsync(t)}async processInputAsync(e){let t=this.options;e=e instanceof Array?e:[e],await this._invokeAllAsync(function(t){t.beforeParse&&t.beforeParse(e)});let n=[];for(let t=0;t<e.length;t++)e[t]instanceof r.Z58?await this.processSceneAsync(e[t]):n.push(e[t]);n.length>0&&await this.processObjectsAsync(n);for(let e=0;e<this.skins.length;++e)this.processSkin(this.skins[e]);for(let n=0;n<t.animations.length;++n)this.processAnimation(t.animations[n],e[0]);await this._invokeAllAsync(function(t){t.afterParse&&t.afterParse(e)})}async _invokeAllAsync(e){for(let t=0,n=this.plugins.length;t<n;t++)await e(this.plugins[t])}}class v{constructor(e){this.writer=e,this.name="KHR_lights_punctual"}writeNode(e,t){if(!e.isLight)return;if(!e.isDirectionalLight&&!e.isPointLight&&!e.isSpotLight)return void console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e);let n=this.writer,r=n.json,i=n.extensionsUsed,o={};e.name&&(o.name=e.name),o.color=e.color.toArray(),o.intensity=e.intensity,e.isDirectionalLight?o.type="directional":e.isPointLight?(o.type="point",e.distance>0&&(o.range=e.distance)):e.isSpotLight&&(o.type="spot",e.distance>0&&(o.range=e.distance),o.spot={},o.spot.innerConeAngle=(1-e.penumbra)*e.angle,o.spot.outerConeAngle=e.angle),void 0!==e.decay&&2!==e.decay&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),e.target&&(e.target.parent!==e||0!==e.target.position.x||0!==e.target.position.y||-1!==e.target.position.z)&&console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),i[this.name]||(r.extensions=r.extensions||{},r.extensions[this.name]={lights:[]},i[this.name]=!0);let s=r.extensions[this.name].lights;s.push(o),t.extensions=t.extensions||{},t.extensions[this.name]={light:s.length-1}}}class y{constructor(e){this.writer=e,this.name="KHR_materials_unlit"}async writeMaterialAsync(e,t){if(!e.isMeshBasicMaterial)return;let n=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},n[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}}class m{constructor(e){this.writer=e,this.name="KHR_materials_clearcoat"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.clearcoat)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.clearcoatFactor=e.clearcoat,e.clearcoatMap){let t={index:await n.processTextureAsync(e.clearcoatMap),texCoord:e.clearcoatMap.channel};n.applyTextureTransform(t,e.clearcoatMap),i.clearcoatTexture=t}if(i.clearcoatRoughnessFactor=e.clearcoatRoughness,e.clearcoatRoughnessMap){let t={index:await n.processTextureAsync(e.clearcoatRoughnessMap),texCoord:e.clearcoatRoughnessMap.channel};n.applyTextureTransform(t,e.clearcoatRoughnessMap),i.clearcoatRoughnessTexture=t}if(e.clearcoatNormalMap){let t={index:await n.processTextureAsync(e.clearcoatNormalMap),texCoord:e.clearcoatNormalMap.channel};1!==e.clearcoatNormalScale.x&&(t.scale=e.clearcoatNormalScale.x),n.applyTextureTransform(t,e.clearcoatNormalMap),i.clearcoatNormalTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class b{constructor(e){this.writer=e,this.name="KHR_materials_dispersion"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.dispersion)return;let n=this.writer.extensionsUsed,r={};r.dispersion=e.dispersion,t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class g{constructor(e){this.writer=e,this.name="KHR_materials_iridescence"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.iridescence)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.iridescenceFactor=e.iridescence,e.iridescenceMap){let t={index:await n.processTextureAsync(e.iridescenceMap),texCoord:e.iridescenceMap.channel};n.applyTextureTransform(t,e.iridescenceMap),i.iridescenceTexture=t}if(i.iridescenceIor=e.iridescenceIOR,i.iridescenceThicknessMinimum=e.iridescenceThicknessRange[0],i.iridescenceThicknessMaximum=e.iridescenceThicknessRange[1],e.iridescenceThicknessMap){let t={index:await n.processTextureAsync(e.iridescenceThicknessMap),texCoord:e.iridescenceThicknessMap.channel};n.applyTextureTransform(t,e.iridescenceThicknessMap),i.iridescenceThicknessTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class w{constructor(e){this.writer=e,this.name="KHR_materials_transmission"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.transmissionFactor=e.transmission,e.transmissionMap){let t={index:await n.processTextureAsync(e.transmissionMap),texCoord:e.transmissionMap.channel};n.applyTextureTransform(t,e.transmissionMap),i.transmissionTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class k{constructor(e){this.writer=e,this.name="KHR_materials_volume"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.thicknessFactor=e.thickness,e.thicknessMap){let t={index:await n.processTextureAsync(e.thicknessMap),texCoord:e.thicknessMap.channel};n.applyTextureTransform(t,e.thicknessMap),i.thicknessTexture=t}e.attenuationDistance!==1/0&&(i.attenuationDistance=e.attenuationDistance),i.attenuationColor=e.attenuationColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class x{constructor(e){this.writer=e,this.name="KHR_materials_ior"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||1.5===e.ior)return;let n=this.writer.extensionsUsed,r={};r.ior=e.ior,t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class T{constructor(e){this.writer=e,this.name="KHR_materials_specular"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||1===e.specularIntensity&&e.specularColor.equals(c)&&!e.specularIntensityMap&&!e.specularColorMap)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.specularIntensityMap){let t={index:await n.processTextureAsync(e.specularIntensityMap),texCoord:e.specularIntensityMap.channel};n.applyTextureTransform(t,e.specularIntensityMap),i.specularTexture=t}if(e.specularColorMap){let t={index:await n.processTextureAsync(e.specularColorMap),texCoord:e.specularColorMap.channel};n.applyTextureTransform(t,e.specularColorMap),i.specularColorTexture=t}i.specularFactor=e.specularIntensity,i.specularColorFactor=e.specularColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class P{constructor(e){this.writer=e,this.name="KHR_materials_sheen"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0==e.sheen)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.sheenRoughnessMap){let t={index:await n.processTextureAsync(e.sheenRoughnessMap),texCoord:e.sheenRoughnessMap.channel};n.applyTextureTransform(t,e.sheenRoughnessMap),i.sheenRoughnessTexture=t}if(e.sheenColorMap){let t={index:await n.processTextureAsync(e.sheenColorMap),texCoord:e.sheenColorMap.channel};n.applyTextureTransform(t,e.sheenColorMap),i.sheenColorTexture=t}i.sheenRoughnessFactor=e.sheenRoughness,i.sheenColorFactor=e.sheenColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class S{constructor(e){this.writer=e,this.name="KHR_materials_anisotropy"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0==e.anisotropy)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.anisotropyMap){let t={index:await n.processTextureAsync(e.anisotropyMap)};n.applyTextureTransform(t,e.anisotropyMap),i.anisotropyTexture=t}i.anisotropyStrength=e.anisotropy,i.anisotropyRotation=e.anisotropyRotation,t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class R{constructor(e){this.writer=e,this.name="KHR_materials_emissive_strength"}async writeMaterialAsync(e,t){if(!e.isMeshStandardMaterial||1===e.emissiveIntensity)return;let n=this.writer.extensionsUsed,r={};r.emissiveStrength=e.emissiveIntensity,t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class O{constructor(e){this.writer=e,this.name="EXT_materials_bump"}async writeMaterialAsync(e,t){if(!e.isMeshStandardMaterial||1===e.bumpScale&&!e.bumpMap)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.bumpMap){let t={index:await n.processTextureAsync(e.bumpMap),texCoord:e.bumpMap.channel};n.applyTextureTransform(t,e.bumpMap),i.bumpTexture=t}i.bumpFactor=e.bumpScale,t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class E{constructor(e){this.writer=e,this.name="EXT_mesh_gpu_instancing"}writeNode(e,t){if(!e.isInstancedMesh)return;let n=this.writer,i=new Float32Array(3*e.count),o=new Float32Array(4*e.count),s=new Float32Array(3*e.count),a=new r.kn4,l=new r.Pq0,c=new r.PTz,u=new r.Pq0;for(let t=0;t<e.count;t++)e.getMatrixAt(t,a),a.decompose(l,c,u),l.toArray(i,3*t),c.toArray(o,4*t),u.toArray(s,3*t);let h={TRANSLATION:n.processAccessor(new r.THS(i,3)),ROTATION:n.processAccessor(new r.THS(o,4)),SCALE:n.processAccessor(new r.THS(s,3))};e.instanceColor&&(h._COLOR_0=n.processAccessor(e.instanceColor)),t.extensions=t.extensions||{},t.extensions[this.name]={attributes:h},n.extensionsUsed[this.name]=!0,n.extensionsRequired[this.name]=!0}}function A(e,t){if(t===r.RJ4)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(t!==r.rYR&&t!==r.O49)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),e;{let n=e.getIndex();if(null===n){let t=[],r=e.getAttribute("position");if(void 0===r)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<r.count;e++)t.push(e);e.setIndex(t),n=e.getIndex()}let i=n.count-2,o=[];if(t===r.rYR)for(let e=1;e<=i;e++)o.push(n.getX(0)),o.push(n.getX(e)),o.push(n.getX(e+1));else for(let e=0;e<i;e++)e%2==0?(o.push(n.getX(e)),o.push(n.getX(e+1)),o.push(n.getX(e+2))):(o.push(n.getX(e+2)),o.push(n.getX(e+1)),o.push(n.getX(e)));o.length/3!==i&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");let s=e.clone();return s.setIndex(o),s.clearGroups(),s}}o.Utils={insertKeyframe:function(e,t){let n,r=e.getValueSize(),i=new e.TimeBufferType(e.times.length+1),o=new e.ValueBufferType(e.values.length+r),s=e.createInterpolant(new e.ValueBufferType(r));if(0===e.times.length){i[0]=t;for(let e=0;e<r;e++)o[e]=0;n=0}else if(t<e.times[0]){if(.001>Math.abs(e.times[0]-t))return 0;i[0]=t,i.set(e.times,1),o.set(s.evaluate(t),0),o.set(e.values,r),n=0}else if(t>e.times[e.times.length-1]){if(.001>Math.abs(e.times[e.times.length-1]-t))return e.times.length-1;i[i.length-1]=t,i.set(e.times,0),o.set(e.values,0),o.set(s.evaluate(t),e.values.length),n=i.length-1}else for(let a=0;a<e.times.length;a++){if(.001>Math.abs(e.times[a]-t))return a;if(e.times[a]<t&&e.times[a+1]>t){i.set(e.times.slice(0,a+1),0),i[a+1]=t,i.set(e.times.slice(a+1),a+2),o.set(e.values.slice(0,(a+1)*r),0),o.set(s.evaluate(t),(a+1)*r),o.set(e.values.slice((a+1)*r),(a+2)*r),n=a+1;break}}return e.times=i,e.values=o,n},mergeMorphTargetTracks:function(e,t){let n=[],i={},o=e.tracks;for(let e=0;e<o.length;++e){let s,a=o[e],l=r.Nwf.parseTrackName(a.name),c=r.Nwf.findNode(t,l.nodeName);if("morphTargetInfluences"!==l.propertyName||void 0===l.propertyIndex){n.push(a);continue}if(a.createInterpolant!==a.InterpolantFactoryMethodDiscrete&&a.createInterpolant!==a.InterpolantFactoryMethodLinear){if(a.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),(a=a.clone()).setInterpolation(r.PJ3)}let u=c.morphTargetInfluences.length,h=c.morphTargetDictionary[l.propertyIndex];if(void 0===h)throw Error("THREE.GLTFExporter: Morph target name not found: "+l.propertyIndex);if(void 0===i[c.uuid]){let e=new(s=a.clone()).ValueBufferType(u*s.times.length);for(let t=0;t<s.times.length;t++)e[t*u+h]=s.values[t];s.name=(l.nodeName||"")+".morphTargetInfluences",s.values=e,i[c.uuid]=s,n.push(s);continue}let f=a.createInterpolant(new a.ValueBufferType(1));s=i[c.uuid];for(let e=0;e<s.times.length;e++)s.values[e*u+h]=f.evaluate(s.times[e]);for(let e=0;e<a.times.length;e++){let t=this.insertKeyframe(s,a.times[e]);s.values[t*u+h]=a.values[e]}}return e.tracks=n,e},toFloat32BufferAttribute:function(e){let t=new r.THS(new Float32Array(e.count*e.itemSize),e.itemSize,!1);if(!e.normalized&&!e.isInterleavedBufferAttribute)return t.array.set(e.array),t;for(let n=0,r=e.count;n<r;n++)for(let r=0;r<e.itemSize;r++)t.setComponent(n,r,e.getComponent(n,r));return t}};class M extends r.aHM{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(e){return new L(e)}),this.register(function(e){return new N(e)}),this.register(function(e){return new K(e)}),this.register(function(e){return new X(e)}),this.register(function(e){return new W(e)}),this.register(function(e){return new H(e)}),this.register(function(e){return new U(e)}),this.register(function(e){return new D(e)}),this.register(function(e){return new z(e)}),this.register(function(e){return new B(e)}),this.register(function(e){return new G(e)}),this.register(function(e){return new F(e)}),this.register(function(e){return new q(e)}),this.register(function(e){return new V(e)}),this.register(function(e){return new C(e)}),this.register(function(e){return new Y(e)}),this.register(function(e){return new J(e)})}load(e,t,n,i){let o,s=this;if(""!==this.resourcePath)o=this.resourcePath;else if(""!==this.path){let t=r.r6x.extractUrlBase(e);o=r.r6x.resolveURL(t,this.path)}else o=r.r6x.extractUrlBase(e);this.manager.itemStart(e);let a=function(t){i?i(t):console.error(t),s.manager.itemError(e),s.manager.itemEnd(e)},l=new r.Y9S(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials),l.load(e,function(n){try{s.parse(n,o,function(n){t(n),s.manager.itemEnd(e)},a)}catch(e){a(e)}},n,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return -1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return -1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,n,r){let i,o={},s={},a=new TextDecoder;if("string"==typeof e)i=JSON.parse(e);else if(e instanceof ArrayBuffer)if(a.decode(new Uint8Array(e,0,4))===Q){try{o[I.KHR_BINARY_GLTF]=new Z(e)}catch(e){r&&r(e);return}i=JSON.parse(o[I.KHR_BINARY_GLTF].content)}else i=JSON.parse(a.decode(e));else i=e;if(void 0===i.asset||i.asset.version[0]<2){r&&r(Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}let l=new eb(i,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){let t=this.pluginCallbacks[e](l);t.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),s[t.name]=t,o[t.name]=!0}if(i.extensionsUsed)for(let e=0;e<i.extensionsUsed.length;++e){let t=i.extensionsUsed[e],n=i.extensionsRequired||[];switch(t){case I.KHR_MATERIALS_UNLIT:o[t]=new j;break;case I.KHR_DRACO_MESH_COMPRESSION:o[t]=new $(i,this.dracoLoader);break;case I.KHR_TEXTURE_TRANSFORM:o[t]=new ee;break;case I.KHR_MESH_QUANTIZATION:o[t]=new et;break;default:n.indexOf(t)>=0&&void 0===s[t]&&console.warn('THREE.GLTFLoader: Unknown extension "'+t+'".')}}l.setExtensions(o),l.setPlugins(s),l.parse(n,r)}parseAsync(e,t){let n=this;return new Promise(function(r,i){n.parse(e,t,r,i)})}}function _(){let e={};return{get:function(t){return e[t]},add:function(t,n){e[t]=n},remove:function(t){delete e[t]},removeAll:function(){e={}}}}let I={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class C{constructor(e){this.parser=e,this.name=I.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){let e=this.parser,t=this.parser.json.nodes||[];for(let n=0,r=t.length;n<r;n++){let r=t[n];r.extensions&&r.extensions[this.name]&&void 0!==r.extensions[this.name].light&&e._addNodeRef(this.cache,r.extensions[this.name].light)}}_loadLight(e){let t,n=this.parser,i="light:"+e,o=n.cache.get(i);if(o)return o;let s=n.json,a=((s.extensions&&s.extensions[this.name]||{}).lights||[])[e],l=new r.Q1f(0xffffff);void 0!==a.color&&l.setRGB(a.color[0],a.color[1],a.color[2],r.Zr2);let c=void 0!==a.range?a.range:0;switch(a.type){case"directional":(t=new r.ZyN(l)).target.position.set(0,0,-1),t.add(t.target);break;case"point":(t=new r.HiM(l)).distance=c;break;case"spot":(t=new r.nCl(l)).distance=c,a.spot=a.spot||{},a.spot.innerConeAngle=void 0!==a.spot.innerConeAngle?a.spot.innerConeAngle:0,a.spot.outerConeAngle=void 0!==a.spot.outerConeAngle?a.spot.outerConeAngle:Math.PI/4,t.angle=a.spot.outerConeAngle,t.penumbra=1-a.spot.innerConeAngle/a.spot.outerConeAngle,t.target.position.set(0,0,-1),t.add(t.target);break;default:throw Error("THREE.GLTFLoader: Unexpected light type: "+a.type)}return t.position.set(0,0,0),ed(t,a),void 0!==a.intensity&&(t.intensity=a.intensity),t.name=n.createUniqueName(a.name||"light_"+e),o=Promise.resolve(t),n.cache.add(i,o),o}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){let t=this,n=this.parser,r=n.json.nodes[e],i=(r.extensions&&r.extensions[this.name]||{}).light;return void 0===i?null:this._loadLight(i).then(function(e){return n._getNodeRef(t.cache,i,e)})}}class j{constructor(){this.name=I.KHR_MATERIALS_UNLIT}getMaterialType(){return r.V9B}extendParams(e,t,n){let i=[];e.color=new r.Q1f(1,1,1),e.opacity=1;let o=t.pbrMetallicRoughness;if(o){if(Array.isArray(o.baseColorFactor)){let t=o.baseColorFactor;e.color.setRGB(t[0],t[1],t[2],r.Zr2),e.opacity=t[3]}void 0!==o.baseColorTexture&&i.push(n.assignTexture(e,"map",o.baseColorTexture,r.er$))}return Promise.all(i)}}class B{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){let n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=n.extensions[this.name].emissiveStrength;return void 0!==r&&(t.emissiveIntensity=r),Promise.resolve()}}class L{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let o=[],s=i.extensions[this.name];if(void 0!==s.clearcoatFactor&&(t.clearcoat=s.clearcoatFactor),void 0!==s.clearcoatTexture&&o.push(n.assignTexture(t,"clearcoatMap",s.clearcoatTexture)),void 0!==s.clearcoatRoughnessFactor&&(t.clearcoatRoughness=s.clearcoatRoughnessFactor),void 0!==s.clearcoatRoughnessTexture&&o.push(n.assignTexture(t,"clearcoatRoughnessMap",s.clearcoatRoughnessTexture)),void 0!==s.clearcoatNormalTexture&&(o.push(n.assignTexture(t,"clearcoatNormalMap",s.clearcoatNormalTexture)),void 0!==s.clearcoatNormalTexture.scale)){let e=s.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new r.I9Y(e,e)}return Promise.all(o)}}class N{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_DISPERSION}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=n.extensions[this.name];return t.dispersion=void 0!==r.dispersion?r.dispersion:0,Promise.resolve()}}class F{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],o=r.extensions[this.name];return void 0!==o.iridescenceFactor&&(t.iridescence=o.iridescenceFactor),void 0!==o.iridescenceTexture&&i.push(n.assignTexture(t,"iridescenceMap",o.iridescenceTexture)),void 0!==o.iridescenceIor&&(t.iridescenceIOR=o.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==o.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),void 0!==o.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),void 0!==o.iridescenceThicknessTexture&&i.push(n.assignTexture(t,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(i)}}class H{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_SHEEN}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let o=[];t.sheenColor=new r.Q1f(0,0,0),t.sheenRoughness=0,t.sheen=1;let s=i.extensions[this.name];if(void 0!==s.sheenColorFactor){let e=s.sheenColorFactor;t.sheenColor.setRGB(e[0],e[1],e[2],r.Zr2)}return void 0!==s.sheenRoughnessFactor&&(t.sheenRoughness=s.sheenRoughnessFactor),void 0!==s.sheenColorTexture&&o.push(n.assignTexture(t,"sheenColorMap",s.sheenColorTexture,r.er$)),void 0!==s.sheenRoughnessTexture&&o.push(n.assignTexture(t,"sheenRoughnessMap",s.sheenRoughnessTexture)),Promise.all(o)}}class U{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],o=r.extensions[this.name];return void 0!==o.transmissionFactor&&(t.transmission=o.transmissionFactor),void 0!==o.transmissionTexture&&i.push(n.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(i)}}class D{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_VOLUME}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let o=[],s=i.extensions[this.name];t.thickness=void 0!==s.thicknessFactor?s.thicknessFactor:0,void 0!==s.thicknessTexture&&o.push(n.assignTexture(t,"thicknessMap",s.thicknessTexture)),t.attenuationDistance=s.attenuationDistance||1/0;let a=s.attenuationColor||[1,1,1];return t.attenuationColor=new r.Q1f().setRGB(a[0],a[1],a[2],r.Zr2),Promise.all(o)}}class z{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_IOR}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=n.extensions[this.name];return t.ior=void 0!==r.ior?r.ior:1.5,Promise.resolve()}}class G{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_SPECULAR}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let o=[],s=i.extensions[this.name];t.specularIntensity=void 0!==s.specularFactor?s.specularFactor:1,void 0!==s.specularTexture&&o.push(n.assignTexture(t,"specularIntensityMap",s.specularTexture));let a=s.specularColorFactor||[1,1,1];return t.specularColor=new r.Q1f().setRGB(a[0],a[1],a[2],r.Zr2),void 0!==s.specularColorTexture&&o.push(n.assignTexture(t,"specularColorMap",s.specularColorTexture,r.er$)),Promise.all(o)}}class V{constructor(e){this.parser=e,this.name=I.EXT_MATERIALS_BUMP}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],o=r.extensions[this.name];return t.bumpScale=void 0!==o.bumpFactor?o.bumpFactor:1,void 0!==o.bumpTexture&&i.push(n.assignTexture(t,"bumpMap",o.bumpTexture)),Promise.all(i)}}class q{constructor(e){this.parser=e,this.name=I.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],o=r.extensions[this.name];return void 0!==o.anisotropyStrength&&(t.anisotropy=o.anisotropyStrength),void 0!==o.anisotropyRotation&&(t.anisotropyRotation=o.anisotropyRotation),void 0!==o.anisotropyTexture&&i.push(n.assignTexture(t,"anisotropyMap",o.anisotropyTexture)),Promise.all(i)}}class K{constructor(e){this.parser=e,this.name=I.KHR_TEXTURE_BASISU}loadTexture(e){let t=this.parser,n=t.json,r=n.textures[e];if(!r.extensions||!r.extensions[this.name])return null;let i=r.extensions[this.name],o=t.options.ktx2Loader;if(!o)if(!(n.extensionsRequired&&n.extensionsRequired.indexOf(this.name)>=0))return null;else throw Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return t.loadTextureImage(e,i.source,o)}}class X{constructor(e){this.parser=e,this.name=I.EXT_TEXTURE_WEBP}loadTexture(e){let t=this.name,n=this.parser,r=n.json,i=r.textures[e];if(!i.extensions||!i.extensions[t])return null;let o=i.extensions[t],s=r.images[o.source],a=n.textureLoader;if(s.uri){let e=n.options.manager.getHandler(s.uri);null!==e&&(a=e)}return n.loadTextureImage(e,o.source,a)}}class W{constructor(e){this.parser=e,this.name=I.EXT_TEXTURE_AVIF}loadTexture(e){let t=this.name,n=this.parser,r=n.json,i=r.textures[e];if(!i.extensions||!i.extensions[t])return null;let o=i.extensions[t],s=r.images[o.source],a=n.textureLoader;if(s.uri){let e=n.options.manager.getHandler(s.uri);null!==e&&(a=e)}return n.loadTextureImage(e,o.source,a)}}class Y{constructor(e){this.name=I.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){let t=this.parser.json,n=t.bufferViews[e];if(!n.extensions||!n.extensions[this.name])return null;{let e=n.extensions[this.name],r=this.parser.getDependency("buffer",e.buffer),i=this.parser.options.meshoptDecoder;if(!i||!i.supported)if(!(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0))return null;else throw Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return r.then(function(t){let n=e.byteOffset||0,r=e.byteLength||0,o=e.count,s=e.byteStride,a=new Uint8Array(t,n,r);return i.decodeGltfBufferAsync?i.decodeGltfBufferAsync(o,s,a,e.mode,e.filter).then(function(e){return e.buffer}):i.ready.then(function(){let t=new ArrayBuffer(o*s);return i.decodeGltfBuffer(new Uint8Array(t),o,s,a,e.mode,e.filter),t})})}}}class J{constructor(e){this.name=I.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){let t=this.parser.json,n=t.nodes[e];if(!n.extensions||!n.extensions[this.name]||void 0===n.mesh)return null;for(let e of t.meshes[n.mesh].primitives)if(e.mode!==eo.TRIANGLES&&e.mode!==eo.TRIANGLE_STRIP&&e.mode!==eo.TRIANGLE_FAN&&void 0!==e.mode)return null;let i=n.extensions[this.name].attributes,o=[],s={};for(let e in i)o.push(this.parser.getDependency("accessor",i[e]).then(t=>(s[e]=t,s[e])));return o.length<1?null:(o.push(this.parser.createNodeMesh(e)),Promise.all(o).then(e=>{let t=e.pop(),n=t.isGroup?t.children:[t],i=e[0].count,o=[];for(let e of n){let t=new r.kn4,n=new r.Pq0,a=new r.PTz,l=new r.Pq0(1,1,1),c=new r.ZLX(e.geometry,e.material,i);for(let e=0;e<i;e++)s.TRANSLATION&&n.fromBufferAttribute(s.TRANSLATION,e),s.ROTATION&&a.fromBufferAttribute(s.ROTATION,e),s.SCALE&&l.fromBufferAttribute(s.SCALE,e),c.setMatrixAt(e,t.compose(n,a,l));for(let t in s)if("_COLOR_0"===t){let e=s[t];c.instanceColor=new r.uWO(e.array,e.itemSize,e.normalized)}else"TRANSLATION"!==t&&"ROTATION"!==t&&"SCALE"!==t&&e.geometry.setAttribute(t,s[t]);r.B69.prototype.copy.call(c,e),this.parser.assignFinalMaterial(c),o.push(c)}return t.isGroup?(t.clear(),t.add(...o),t):o[0]}))}}let Q="glTF";class Z{constructor(e){this.name=I.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12),n=new TextDecoder;if(this.header={magic:n.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Q)throw Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw Error("THREE.GLTFLoader: Legacy binary file detected.");const r=this.header.length-12,i=new DataView(e,12);let o=0;for(;o<r;){const t=i.getUint32(o,!0);o+=4;const r=i.getUint32(o,!0);if(o+=4,0x4e4f534a===r){const r=new Uint8Array(e,12+o,t);this.content=n.decode(r)}else if(5130562===r){const n=12+o;this.body=e.slice(n,n+t)}o+=t}if(null===this.content)throw Error("THREE.GLTFLoader: JSON content not found.")}}class ${constructor(e,t){if(!t)throw Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=I.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){let n=this.json,i=this.dracoLoader,o=e.extensions[this.name].bufferView,s=e.extensions[this.name].attributes,a={},l={},c={};for(let e in s)a[eu[e]||e.toLowerCase()]=s[e];for(let t in e.attributes){let r=eu[t]||t.toLowerCase();if(void 0!==s[t]){let i=n.accessors[e.attributes[t]],o=es[i.componentType];c[r]=o.name,l[r]=!0===i.normalized}}return t.getDependency("bufferView",o).then(function(e){return new Promise(function(t,n){i.decodeDracoFile(e,function(e){for(let t in e.attributes){let n=e.attributes[t],r=l[t];void 0!==r&&(n.normalized=r)}t(e)},a,c,r.Zr2,n)})})}}class ee{constructor(){this.name=I.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(void 0===t.texCoord||t.texCoord===e.channel)&&void 0===t.offset&&void 0===t.rotation&&void 0===t.scale||(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class et{constructor(){this.name=I.KHR_MESH_QUANTIZATION}}class en extends r.lGw{constructor(e,t,n,r){super(e,t,n,r)}copySampleValue_(e){let t=this.resultBuffer,n=this.sampleValues,r=this.valueSize,i=e*r*3+r;for(let e=0;e!==r;e++)t[e]=n[i+e];return t}interpolate_(e,t,n,r){let i=this.resultBuffer,o=this.sampleValues,s=this.valueSize,a=2*s,l=3*s,c=r-t,u=(n-t)/c,h=u*u,f=h*u,p=e*l,d=p-l,v=-2*f+3*h,y=f-h,m=1-v,b=y-h+u;for(let e=0;e!==s;e++){let t=o[d+e+s],n=o[d+e+a]*c,r=o[p+e+s],l=o[p+e]*c;i[e]=m*t+b*n+v*r+y*l}return i}}let er=new r.PTz;class ei extends en{interpolate_(e,t,n,r){let i=super.interpolate_(e,t,n,r);return er.fromArray(i).normalize().toArray(i),i}}let eo={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},es={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},ea={9728:r.hxR,9729:r.k6q,9984:r.pHI,9985:r.kRr,9986:r.Cfg,9987:r.$_I},el={33071:r.ghU,33648:r.kTW,10497:r.GJx},ec={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},eu={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},eh={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},ef={CUBICSPLINE:void 0,LINEAR:r.PJ3,STEP:r.ljd};function ep(e,t,n){for(let r in n.extensions)void 0===e[r]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[r]=n.extensions[r])}function ed(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function ev(e){let t="",n=Object.keys(e).sort();for(let r=0,i=n.length;r<i;r++)t+=n[r]+":"+e[n[r]]+";";return t}function ey(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}let em=new r.kn4;class eb{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new _,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let n=!1,i=-1,o=!1,s=-1;if("u">typeof navigator){const e=navigator.userAgent;n=!0===/^((?!chrome|android).)*safari/i.test(e);const t=e.match(/Version\/(\d+)/);i=n&&t?parseInt(t[1],10):-1,s=(o=e.indexOf("Firefox")>-1)?e.match(/Firefox\/([0-9]+)\./)[1]:-1}"u"<typeof createImageBitmap||n&&i<17||o&&s<98?this.textureLoader=new r.Tap(this.options.manager):this.textureLoader=new r.Kzg(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new r.Y9S(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){let n=this,r=this.json,i=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(e){return e._markDefs&&e._markDefs()}),Promise.all(this._invokeAll(function(e){return e.beforeRoot&&e.beforeRoot()})).then(function(){return Promise.all([n.getDependencies("scene"),n.getDependencies("animation"),n.getDependencies("camera")])}).then(function(t){let o={scene:t[0][r.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:r.asset,parser:n,userData:{}};return ep(i,o,r),ed(o,r),Promise.all(n._invokeAll(function(e){return e.afterRoot&&e.afterRoot(o)})).then(function(){for(let e of o.scenes)e.updateMatrixWorld();e(o)})}).catch(t)}_markDefs(){let e=this.json.nodes||[],t=this.json.skins||[],n=this.json.meshes||[];for(let n=0,r=t.length;n<r;n++){let r=t[n].joints;for(let t=0,n=r.length;t<n;t++)e[r[t]].isBone=!0}for(let t=0,r=e.length;t<r;t++){let r=e[t];void 0!==r.mesh&&(this._addNodeRef(this.meshCache,r.mesh),void 0!==r.skin&&(n[r.mesh].isSkinnedMesh=!0)),void 0!==r.camera&&this._addNodeRef(this.cameraCache,r.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,n){if(e.refs[t]<=1)return n;let r=n.clone(),i=(e,t)=>{let n=this.associations.get(e);for(let[r,o]of(null!=n&&this.associations.set(t,n),e.children.entries()))i(o,t.children[r])};return i(n,r),r.name+="_instance_"+e.uses[t]++,r}_invokeOne(e){let t=Object.values(this.plugins);t.push(this);for(let n=0;n<t.length;n++){let r=e(t[n]);if(r)return r}return null}_invokeAll(e){let t=Object.values(this.plugins);t.unshift(this);let n=[];for(let r=0;r<t.length;r++){let i=e(t[r]);i&&n.push(i)}return n}getDependency(e,t){let n=e+":"+t,r=this.cache.get(n);if(!r){switch(e){case"scene":r=this.loadScene(t);break;case"node":r=this._invokeOne(function(e){return e.loadNode&&e.loadNode(t)});break;case"mesh":r=this._invokeOne(function(e){return e.loadMesh&&e.loadMesh(t)});break;case"accessor":r=this.loadAccessor(t);break;case"bufferView":r=this._invokeOne(function(e){return e.loadBufferView&&e.loadBufferView(t)});break;case"buffer":r=this.loadBuffer(t);break;case"material":r=this._invokeOne(function(e){return e.loadMaterial&&e.loadMaterial(t)});break;case"texture":r=this._invokeOne(function(e){return e.loadTexture&&e.loadTexture(t)});break;case"skin":r=this.loadSkin(t);break;case"animation":r=this._invokeOne(function(e){return e.loadAnimation&&e.loadAnimation(t)});break;case"camera":r=this.loadCamera(t);break;default:if(!(r=this._invokeOne(function(n){return n!=this&&n.getDependency&&n.getDependency(e,t)})))throw Error("Unknown type: "+e)}this.cache.add(n,r)}return r}getDependencies(e){let t=this.cache.get(e);if(!t){let n=this;t=Promise.all((this.json[e+("mesh"===e?"es":"s")]||[]).map(function(t,r){return n.getDependency(e,r)})),this.cache.add(e,t)}return t}loadBuffer(e){let t=this.json.buffers[e],n=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[I.KHR_BINARY_GLTF].body);let i=this.options;return new Promise(function(e,o){n.load(r.r6x.resolveURL(t.uri,i.path),e,void 0,function(){o(Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){let t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(e){let n=t.byteLength||0,r=t.byteOffset||0;return e.slice(r,r+n)})}loadAccessor(e){let t=this,n=this.json,i=this.json.accessors[e];if(void 0===i.bufferView&&void 0===i.sparse){let e=ec[i.type],t=es[i.componentType],n=!0===i.normalized,o=new t(i.count*e);return Promise.resolve(new r.THS(o,e,n))}let o=[];return void 0!==i.bufferView?o.push(this.getDependency("bufferView",i.bufferView)):o.push(null),void 0!==i.sparse&&(o.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),o.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(o).then(function(e){let o,s,a=e[0],l=ec[i.type],c=es[i.componentType],u=c.BYTES_PER_ELEMENT,h=u*l,f=i.byteOffset||0,p=void 0!==i.bufferView?n.bufferViews[i.bufferView].byteStride:void 0,d=!0===i.normalized;if(p&&p!==h){let e=Math.floor(f/p),n="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+e+":"+i.count,h=t.cache.get(n);h||(o=new c(a,e*p,i.count*p/u),h=new r.eB$(o,p/u),t.cache.add(n,h)),s=new r.eHs(h,l,f%p/u,d)}else o=null===a?new c(i.count*l):new c(a,f,i.count*l),s=new r.THS(o,l,d);if(void 0!==i.sparse){let t=ec.SCALAR,n=es[i.sparse.indices.componentType],o=i.sparse.indices.byteOffset||0,u=i.sparse.values.byteOffset||0,h=new n(e[1],o,i.sparse.count*t),f=new c(e[2],u,i.sparse.count*l);null!==a&&(s=new r.THS(s.array.slice(),s.itemSize,s.normalized)),s.normalized=!1;for(let e=0,t=h.length;e<t;e++){let t=h[e];if(s.setX(t,f[e*l]),l>=2&&s.setY(t,f[e*l+1]),l>=3&&s.setZ(t,f[e*l+2]),l>=4&&s.setW(t,f[e*l+3]),l>=5)throw Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}s.normalized=d}return s})}loadTexture(e){let t=this.json,n=this.options,r=t.textures[e].source,i=t.images[r],o=this.textureLoader;if(i.uri){let e=n.manager.getHandler(i.uri);null!==e&&(o=e)}return this.loadTextureImage(e,r,o)}loadTextureImage(e,t,n){let i=this,o=this.json,s=o.textures[e],a=o.images[t],l=(a.uri||a.bufferView)+":"+s.sampler;if(this.textureCache[l])return this.textureCache[l];let c=this.loadImageSource(t,n).then(function(t){t.flipY=!1,t.name=s.name||a.name||"",""===t.name&&"string"==typeof a.uri&&!1===a.uri.startsWith("data:image/")&&(t.name=a.uri);let n=(o.samplers||{})[s.sampler]||{};return t.magFilter=ea[n.magFilter]||r.k6q,t.minFilter=ea[n.minFilter]||r.$_I,t.wrapS=el[n.wrapS]||r.GJx,t.wrapT=el[n.wrapT]||r.GJx,t.generateMipmaps=!t.isCompressedTexture&&t.minFilter!==r.hxR&&t.minFilter!==r.k6q,i.associations.set(t,{textures:e}),t}).catch(function(){return null});return this.textureCache[l]=c,c}loadImageSource(e,t){let n=this.json,i=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then(e=>e.clone());let o=n.images[e],s=self.URL||self.webkitURL,a=o.uri||"",l=!1;if(void 0!==o.bufferView)a=this.getDependency("bufferView",o.bufferView).then(function(e){l=!0;let t=new Blob([e],{type:o.mimeType});return a=s.createObjectURL(t)});else if(void 0===o.uri)throw Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");let c=Promise.resolve(a).then(function(e){return new Promise(function(n,o){let s=n;!0===t.isImageBitmapLoader&&(s=function(e){let t=new r.gPd(e);t.needsUpdate=!0,n(t)}),t.load(r.r6x.resolveURL(e,i.path),s,void 0,o)})}).then(function(e){var t;return!0===l&&s.revokeObjectURL(a),ed(e,o),e.userData.mimeType=o.mimeType||((t=o.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":t.search(/\.ktx2($|\?)/i)>0||0===t.search(/^data\:image\/ktx2/)?"image/ktx2":"image/png"),e}).catch(function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",a),e});return this.sourceCache[e]=c,c}assignTexture(e,t,n,r){let i=this;return this.getDependency("texture",n.index).then(function(o){if(!o)return null;if(void 0!==n.texCoord&&n.texCoord>0&&((o=o.clone()).channel=n.texCoord),i.extensions[I.KHR_TEXTURE_TRANSFORM]){let e=void 0!==n.extensions?n.extensions[I.KHR_TEXTURE_TRANSFORM]:void 0;if(e){let t=i.associations.get(o);o=i.extensions[I.KHR_TEXTURE_TRANSFORM].extendTexture(o,e),i.associations.set(o,t)}}return void 0!==r&&(o.colorSpace=r),e[t]=o,o})}assignFinalMaterial(e){let t=e.geometry,n=e.material,i=void 0===t.attributes.tangent,o=void 0!==t.attributes.color,s=void 0===t.attributes.normal;if(e.isPoints){let e="PointsMaterial:"+n.uuid,t=this.cache.get(e);t||(t=new r.BH$,r.imn.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,t.sizeAttenuation=!1,this.cache.add(e,t)),n=t}else if(e.isLine){let e="LineBasicMaterial:"+n.uuid,t=this.cache.get(e);t||(t=new r.mrM,r.imn.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,this.cache.add(e,t)),n=t}if(i||o||s){let e="ClonedMaterial:"+n.uuid+":";i&&(e+="derivative-tangents:"),o&&(e+="vertex-colors:"),s&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=n.clone(),o&&(t.vertexColors=!0),s&&(t.flatShading=!0),i&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(n))),n=t}e.material=n}getMaterialType(){return r._4j}loadMaterial(e){let t,n=this,i=this.json,o=this.extensions,s=i.materials[e],a={},l=s.extensions||{},c=[];if(l[I.KHR_MATERIALS_UNLIT]){let e=o[I.KHR_MATERIALS_UNLIT];t=e.getMaterialType(),c.push(e.extendParams(a,s,n))}else{let i=s.pbrMetallicRoughness||{};if(a.color=new r.Q1f(1,1,1),a.opacity=1,Array.isArray(i.baseColorFactor)){let e=i.baseColorFactor;a.color.setRGB(e[0],e[1],e[2],r.Zr2),a.opacity=e[3]}void 0!==i.baseColorTexture&&c.push(n.assignTexture(a,"map",i.baseColorTexture,r.er$)),a.metalness=void 0!==i.metallicFactor?i.metallicFactor:1,a.roughness=void 0!==i.roughnessFactor?i.roughnessFactor:1,void 0!==i.metallicRoughnessTexture&&(c.push(n.assignTexture(a,"metalnessMap",i.metallicRoughnessTexture)),c.push(n.assignTexture(a,"roughnessMap",i.metallicRoughnessTexture))),t=this._invokeOne(function(t){return t.getMaterialType&&t.getMaterialType(e)}),c.push(Promise.all(this._invokeAll(function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,a)})))}!0===s.doubleSided&&(a.side=r.$EB);let u=s.alphaMode||"OPAQUE";if("BLEND"===u?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,"MASK"===u&&(a.alphaTest=void 0!==s.alphaCutoff?s.alphaCutoff:.5)),void 0!==s.normalTexture&&t!==r.V9B&&(c.push(n.assignTexture(a,"normalMap",s.normalTexture)),a.normalScale=new r.I9Y(1,1),void 0!==s.normalTexture.scale)){let e=s.normalTexture.scale;a.normalScale.set(e,e)}if(void 0!==s.occlusionTexture&&t!==r.V9B&&(c.push(n.assignTexture(a,"aoMap",s.occlusionTexture)),void 0!==s.occlusionTexture.strength&&(a.aoMapIntensity=s.occlusionTexture.strength)),void 0!==s.emissiveFactor&&t!==r.V9B){let e=s.emissiveFactor;a.emissive=new r.Q1f().setRGB(e[0],e[1],e[2],r.Zr2)}return void 0!==s.emissiveTexture&&t!==r.V9B&&c.push(n.assignTexture(a,"emissiveMap",s.emissiveTexture,r.er$)),Promise.all(c).then(function(){let r=new t(a);return s.name&&(r.name=s.name),ed(r,s),n.associations.set(r,{materials:e}),s.extensions&&ep(o,r,s),r})}createUniqueName(e){let t=r.Nwf.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){let t=this,n=this.extensions,i=this.primitiveCache,o=[];for(let s=0,a=e.length;s<a;s++){let a=e[s],l=function(e){let t,n=e.extensions&&e.extensions[I.KHR_DRACO_MESH_COMPRESSION];if(t=n?"draco:"+n.bufferView+":"+n.indices+":"+ev(n.attributes):e.indices+":"+ev(e.attributes)+":"+e.mode,void 0!==e.targets)for(let n=0,r=e.targets.length;n<r;n++)t+=":"+ev(e.targets[n]);return t}(a),c=i[l];if(c)o.push(c.promise);else{let e;e=a.extensions&&a.extensions[I.KHR_DRACO_MESH_COMPRESSION]?function(e){return n[I.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then(function(n){return eg(n,e,t)})}(a):eg(new r.LoY,a,t),i[l]={primitive:a,promise:e},o.push(e)}}return Promise.all(o)}loadMesh(e){let t=this,n=this.json,i=this.extensions,o=n.meshes[e],s=o.primitives,a=[];for(let e=0,t=s.length;e<t;e++){var l;let t=void 0===s[e].material?(void 0===(l=this.cache).DefaultMaterial&&(l.DefaultMaterial=new r._4j({color:0xffffff,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:r.hB5})),l.DefaultMaterial):this.getDependency("material",s[e].material);a.push(t)}return a.push(t.loadGeometries(s)),Promise.all(a).then(function(n){let a=n.slice(0,n.length-1),l=n[n.length-1],c=[];for(let n=0,u=l.length;n<u;n++){let u,h=l[n],f=s[n],p=a[n];if(f.mode===eo.TRIANGLES||f.mode===eo.TRIANGLE_STRIP||f.mode===eo.TRIANGLE_FAN||void 0===f.mode)!0===(u=!0===o.isSkinnedMesh?new r.I46(h,p):new r.eaF(h,p)).isSkinnedMesh&&u.normalizeSkinWeights(),f.mode===eo.TRIANGLE_STRIP?u.geometry=A(u.geometry,r.O49):f.mode===eo.TRIANGLE_FAN&&(u.geometry=A(u.geometry,r.rYR));else if(f.mode===eo.LINES)u=new r.DXC(h,p);else if(f.mode===eo.LINE_STRIP)u=new r.N1A(h,p);else if(f.mode===eo.LINE_LOOP)u=new r.FCc(h,p);else if(f.mode===eo.POINTS)u=new r.ONl(h,p);else throw Error("THREE.GLTFLoader: Primitive mode unsupported: "+f.mode);Object.keys(u.geometry.morphAttributes).length>0&&function(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let n=0,r=t.weights.length;n<r;n++)e.morphTargetInfluences[n]=t.weights[n];if(t.extras&&Array.isArray(t.extras.targetNames)){let n=t.extras.targetNames;if(e.morphTargetInfluences.length===n.length){e.morphTargetDictionary={};for(let t=0,r=n.length;t<r;t++)e.morphTargetDictionary[n[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}(u,o),u.name=t.createUniqueName(o.name||"mesh_"+e),ed(u,o),f.extensions&&ep(i,u,f),t.assignFinalMaterial(u),c.push(u)}for(let n=0,r=c.length;n<r;n++)t.associations.set(c[n],{meshes:e,primitives:n});if(1===c.length)return o.extensions&&ep(i,c[0],o),c[0];let u=new r.YJl;o.extensions&&ep(i,u,o),t.associations.set(u,{meshes:e});for(let e=0,t=c.length;e<t;e++)u.add(c[e]);return u})}loadCamera(e){let t,n=this.json.cameras[e],i=n[n.type];return i?("perspective"===n.type?t=new r.ubm(r.cj9.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):"orthographic"===n.type&&(t=new r.qUd(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),n.name&&(t.name=this.createUniqueName(n.name)),ed(t,n),Promise.resolve(t)):void console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){let t=this.json.skins[e],n=[];for(let e=0,r=t.joints.length;e<r;e++)n.push(this._loadNodeShallow(t.joints[e]));return void 0!==t.inverseBindMatrices?n.push(this.getDependency("accessor",t.inverseBindMatrices)):n.push(null),Promise.all(n).then(function(e){let n=e.pop(),i=[],o=[];for(let s=0,a=e.length;s<a;s++){let a=e[s];if(a){i.push(a);let e=new r.kn4;null!==n&&e.fromArray(n.array,16*s),o.push(e)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[s])}return new r.EAD(i,o)})}loadAnimation(e){let t=this.json,n=this,i=t.animations[e],o=i.name?i.name:"animation_"+e,s=[],a=[],l=[],c=[],u=[];for(let e=0,t=i.channels.length;e<t;e++){let t=i.channels[e],n=i.samplers[t.sampler],r=t.target,o=r.node,h=void 0!==i.parameters?i.parameters[n.input]:n.input,f=void 0!==i.parameters?i.parameters[n.output]:n.output;void 0!==r.node&&(s.push(this.getDependency("node",o)),a.push(this.getDependency("accessor",h)),l.push(this.getDependency("accessor",f)),c.push(n),u.push(r))}return Promise.all([Promise.all(s),Promise.all(a),Promise.all(l),Promise.all(c),Promise.all(u)]).then(function(e){let t=e[0],s=e[1],a=e[2],l=e[3],c=e[4],u=[];for(let e=0,r=t.length;e<r;e++){let r=t[e],i=s[e],o=a[e],h=l[e],f=c[e];if(void 0===r)continue;r.updateMatrix&&r.updateMatrix();let p=n._createAnimationTracks(r,i,o,h,f);if(p)for(let e=0;e<p.length;e++)u.push(p[e])}let h=new r.tz3(o,void 0,u);return ed(h,i),h})}createNodeMesh(e){let t=this.json,n=this,r=t.nodes[e];return void 0===r.mesh?null:n.getDependency("mesh",r.mesh).then(function(e){let t=n._getNodeRef(n.meshCache,r.mesh,e);return void 0!==r.weights&&t.traverse(function(e){if(e.isMesh)for(let t=0,n=r.weights.length;t<n;t++)e.morphTargetInfluences[t]=r.weights[t]}),t})}loadNode(e){let t=this.json.nodes[e],n=this._loadNodeShallow(e),r=[],i=t.children||[];for(let e=0,t=i.length;e<t;e++)r.push(this.getDependency("node",i[e]));let o=void 0===t.skin?Promise.resolve(null):this.getDependency("skin",t.skin);return Promise.all([n,Promise.all(r),o]).then(function(e){let t=e[0],n=e[1],r=e[2];null!==r&&t.traverse(function(e){e.isSkinnedMesh&&e.bind(r,em)});for(let e=0,r=n.length;e<r;e++)t.add(n[e]);return t})}_loadNodeShallow(e){let t=this.json,n=this.extensions,i=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];let o=t.nodes[e],s=o.name?i.createUniqueName(o.name):"",a=[],l=i._invokeOne(function(t){return t.createNodeMesh&&t.createNodeMesh(e)});return l&&a.push(l),void 0!==o.camera&&a.push(i.getDependency("camera",o.camera).then(function(e){return i._getNodeRef(i.cameraCache,o.camera,e)})),i._invokeAll(function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)}).forEach(function(e){a.push(e)}),this.nodeCache[e]=Promise.all(a).then(function(t){let a;if((a=!0===o.isBone?new r.$Kf:t.length>1?new r.YJl:1===t.length?t[0]:new r.B69)!==t[0])for(let e=0,n=t.length;e<n;e++)a.add(t[e]);if(o.name&&(a.userData.name=o.name,a.name=s),ed(a,o),o.extensions&&ep(n,a,o),void 0!==o.matrix){let e=new r.kn4;e.fromArray(o.matrix),a.applyMatrix4(e)}else void 0!==o.translation&&a.position.fromArray(o.translation),void 0!==o.rotation&&a.quaternion.fromArray(o.rotation),void 0!==o.scale&&a.scale.fromArray(o.scale);if(i.associations.has(a)){if(void 0!==o.mesh&&i.meshCache.refs[o.mesh]>1){let e=i.associations.get(a);i.associations.set(a,{...e})}}else i.associations.set(a,{});return i.associations.get(a).nodes=e,a}),this.nodeCache[e]}loadScene(e){let t=this.extensions,n=this.json.scenes[e],i=this,o=new r.YJl;n.name&&(o.name=i.createUniqueName(n.name)),ed(o,n),n.extensions&&ep(t,o,n);let s=n.nodes||[],a=[];for(let e=0,t=s.length;e<t;e++)a.push(i.getDependency("node",s[e]));return Promise.all(a).then(function(e){for(let t=0,n=e.length;t<n;t++)o.add(e[t]);return i.associations=(e=>{let t=new Map;for(let[e,n]of i.associations)(e instanceof r.imn||e instanceof r.gPd)&&t.set(e,n);return e.traverse(e=>{let n=i.associations.get(e);null!=n&&t.set(e,n)}),t})(o),o})}_createAnimationTracks(e,t,n,i,o){let s,a=[],l=e.name?e.name:e.uuid,c=[];switch(eh[o.path]===eh.weights?e.traverse(function(e){e.morphTargetInfluences&&c.push(e.name?e.name:e.uuid)}):c.push(l),eh[o.path]){case eh.weights:s=r.Hit;break;case eh.rotation:s=r.MBL;break;case eh.translation:case eh.scale:s=r.RiT;break;default:s=1===n.itemSize?r.Hit:r.RiT}let u=void 0!==i.interpolation?ef[i.interpolation]:r.PJ3,h=this._getArrayFromAccessor(n);for(let e=0,n=c.length;e<n;e++){let n=new s(c[e]+"."+eh[o.path],t.array,h,u);"CUBICSPLINE"===i.interpolation&&this._createCubicSplineTrackInterpolant(n),a.push(n)}return a}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){let e=ey(t.constructor),n=new Float32Array(t.length);for(let r=0,i=t.length;r<i;r++)n[r]=t[r]*e;t=n}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof r.MBL?ei:en)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function eg(e,t,n){let i=t.attributes,o=[];for(let t in i){let r=eu[t]||t.toLowerCase();r in e.attributes||o.push(function(t,r){return n.getDependency("accessor",t).then(function(t){e.setAttribute(r,t)})}(i[t],r))}if(void 0!==t.indices&&!e.index){let r=n.getDependency("accessor",t.indices).then(function(t){e.setIndex(t)});o.push(r)}return r.ppV.workingColorSpace!==r.Zr2&&"COLOR_0"in i&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${r.ppV.workingColorSpace}" not supported.`),ed(e,t),!function(e,t,n){let i=t.attributes,o=new r.NRn;if(void 0===i.POSITION)return;{let e=n.json.accessors[i.POSITION],t=e.min,s=e.max;if(void 0===t||void 0===s)return console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(o.set(new r.Pq0(t[0],t[1],t[2]),new r.Pq0(s[0],s[1],s[2])),e.normalized){let t=ey(es[e.componentType]);o.min.multiplyScalar(t),o.max.multiplyScalar(t)}}let s=t.targets;if(void 0!==s){let e=new r.Pq0,t=new r.Pq0;for(let r=0,i=s.length;r<i;r++){let i=s[r];if(void 0!==i.POSITION){let r=n.json.accessors[i.POSITION],o=r.min,s=r.max;if(void 0!==o&&void 0!==s){if(t.setX(Math.max(Math.abs(o[0]),Math.abs(s[0]))),t.setY(Math.max(Math.abs(o[1]),Math.abs(s[1]))),t.setZ(Math.max(Math.abs(o[2]),Math.abs(s[2]))),r.normalized){let e=ey(es[r.componentType]);t.multiplyScalar(e)}e.max(t)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}o.expandByVector(e)}e.boundingBox=o;let a=new r.iyt;o.getCenter(a.center),a.radius=o.min.distanceTo(o.max)/2,e.boundingSphere=a}(e,t,n),Promise.all(o).then(function(){return void 0!==t.targets?function(e,t,n){let r=!1,i=!1,o=!1;for(let e=0,n=t.length;e<n;e++){let n=t[e];if(void 0!==n.POSITION&&(r=!0),void 0!==n.NORMAL&&(i=!0),void 0!==n.COLOR_0&&(o=!0),r&&i&&o)break}if(!r&&!i&&!o)return Promise.resolve(e);let s=[],a=[],l=[];for(let c=0,u=t.length;c<u;c++){let u=t[c];if(r){let t=void 0!==u.POSITION?n.getDependency("accessor",u.POSITION):e.attributes.position;s.push(t)}if(i){let t=void 0!==u.NORMAL?n.getDependency("accessor",u.NORMAL):e.attributes.normal;a.push(t)}if(o){let t=void 0!==u.COLOR_0?n.getDependency("accessor",u.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(s),Promise.all(a),Promise.all(l)]).then(function(t){let n=t[0],s=t[1],a=t[2];return r&&(e.morphAttributes.position=n),i&&(e.morphAttributes.normal=s),o&&(e.morphAttributes.color=a),e.morphTargetsRelative=!0,e})}(e,t.targets,n):e})}var ew=n("./src/model/physics/constants.ts"),ek=console.error;function ex(e){new o().parse(e,function(e){var t,n,r;console.log(e),t=e,n="scene.gltf",(r=document.createElement("a")).setAttribute("href","data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(t))),r.setAttribute("download",n),document.body.appendChild(r),r.click(),r.remove()},ek)}function eT(e,t){new M().load(e,function(n){n.scene.scale.set(ew.R/.5,ew.R/.5,ew.R/.5),n.scene.matrixAutoUpdate=!1,n.scene.updateMatrix(),n.scene.updateMatrixWorld(),n.scene.name=e,t(n)},function(t){return console.log(e+" "+t.loaded+" bytes loaded")},ek)}},"./src/utils/rack.ts"(e,t,n){n.d(t,{m:()=>h});var r=n("./src/model/ball.ts"),i=n("./src/utils/snookerconfig.ts"),o=n("./src/view/tablegeometry.ts"),s=n("./src/view/pocketgeometry.ts"),a=n("./node_modules/three/build/three.core.js"),l=n("./src/utils/utils.ts"),c=n("./src/model/physics/constants.ts");function u(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var h=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"jitter",value:function(e){return(0,l.ld)(e.clone().add(new a.Pq0(t.noise*(Math.random()-.5),t.noise*(Math.random()-.5),0)))}},{key:"cueBall",value:function(e,n){return new r.c(t.jitter(e),0xfaebd7,n)}},{key:"swapBallPositions",value:function(e,t){var n=e.pos.clone();e.pos.copy(t.pos),t.pos.copy(n)}},{key:"diamond",value:function(){var e=new a.Pq0(o.P.tableX/2,0,0),n=[],i=function(e,n,i){return new r.c(t.jitter(e),n,i)};return n.push(t.cueBall(t.spot)),n.push(i(e,t.BALL_COLORS[1],1)),e.add(t.diagonal),n.push(i(e,t.BALL_COLORS[2],2)),e.sub(t.across),n.push(i(e,t.BALL_COLORS[3],3)),e.add(t.diagonal),n.push(i(e,t.BALL_COLORS[4],4)),e.sub(t.across),n.push(i(e,t.BALL_COLORS[5],5)),e.addScaledVector(t.across,2),n.push(i(e,t.BALL_COLORS[6],6)),e.add(t.diagonal).sub(t.across),n.push(i(e,t.BALL_COLORS[7],7)),e.sub(t.across),n.push(i(e,t.BALL_COLORS[8],8)),e.add(t.diagonal),n.push(i(e,t.BALL_COLORS[9],9)),t.swapBallPositions(n[4],n[9]),n}},{key:"triangle",value:function(){var e=t.trianglePositions(),n=[];return n.push(t.cueBall(t.spot)),e.forEach(function(e,i){var o=i+1;n.push(new r.c(t.jitter(e),t.BALL_COLORS[o],o))}),t.swapBallPositions(n[4],n[9]),n}},{key:"trianglePositions",value:function(){var e=[],t=new a.Pq0(o.P.X/2,0,0);return e.push((0,l.t6)(t)),t.add(this.diagonal),e.push((0,l.t6)(t)),t.sub(this.across),e.push((0,l.t6)(t)),t.add(this.diagonal),e.push((0,l.t6)(t)),t.sub(this.across),e.push((0,l.t6)(t)),t.addScaledVector(this.across,2),e.push((0,l.t6)(t)),t.add(this.diagonal),e.push((0,l.t6)(t)),t.sub(this.across),e.push((0,l.t6)(t)),t.sub(this.across),e.push((0,l.t6)(t)),t.sub(this.across),e.push((0,l.t6)(t)),t.add(this.diagonal).sub(this.across),e.push((0,l.t6)(t)),t.add(this.across),e.push((0,l.t6)(t)),t.add(this.across),e.push((0,l.t6)(t)),t.add(this.across),e.push((0,l.t6)(t)),t.add(this.across),e.push((0,l.t6)(t)),e}},{key:"rerack",value:function(e,n){var i=t.trianglePositions(),o=i.shift();n.balls.filter(function(e){return e!==n.cueball}).filter(function(t){return t!==e}).forEach(function(e){e.pos.copy(t.jitter(i.shift())),e.state=r.U.Stationary}),n.overlapsAny(e.pos,e)&&e.pos.copy(o),n.overlapsAny(n.cueball.pos)&&n.cueball.pos.copy(t.spot)}},{key:"three",value:function(){var e=[],n=o.P.X/2,i=o.P.Y/4;return e.push(t.cueBall(t.jitter(new a.Pq0(-n,-i,0)))),e.push(new r.c(t.jitter(new a.Pq0(-n,0,0)),0xe0de36)),e.push(new r.c(t.jitter(new a.Pq0(n,0,0)),0xff0000)),e}},{key:"snooker",value:function(){var e=[],n=o.P.Y/4;e.push(t.cueBall(t.jitter(new a.Pq0(t.baulk,-(.5*n),0))));var l=t.snookerColourPositions();e.push(new r.c(t.jitter(l[0]),0xeede36)),e.push(new r.c(t.jitter(l[1]),824932)),e.push(new r.c(t.jitter(l[2]),0xbd723a)),e.push(new r.c(t.jitter(l[3]),558062)),e.push(new r.c(t.jitter(l[4]),0xffaacc)),e.push(new r.c(t.jitter(l[5]),65793));var u=Math.min(i.U.reds,15),h=t.trianglePositions().slice(0,15),f=s.f.pockets.pocketS.pocket.pos;return h.forEach(function(n,i){var o=new r.c(t.jitter(n.add(t.down)),0xee0000);i>=u&&(o.pos.copy(f),o.pos.setZ(-8.5*c.R),o.state=r.U.InPocket),e.push(o)}),e}},{key:"snookerColourPositions",value:function(){var e=o.P.X/2,n=o.P.X-2*o.P.X/11,r=[];return r.push(new a.Pq0(t.baulk,-t.sixth,0)),r.push(new a.Pq0(t.baulk,t.sixth,0)),r.push(new a.Pq0(t.baulk,0,0)),r.push(new a.Pq0(0,0,0)),r.push(new a.Pq0(e,0,0)),r.push(new a.Pq0(n,0,0)),r}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();u(h,"noise",.0233*c.R),u(h,"gap",2*c.R+2*h.noise),u(h,"up",new a.Pq0(0,0,-1)),u(h,"spot",new a.Pq0(-o.P.X/2,0,0)),u(h,"across",new a.Pq0(0,h.gap,0)),u(h,"down",new a.Pq0(h.gap,0,0)),u(h,"diagonal",h.across.clone().applyAxisAngle(h.up,Math.PI/3)),u(h,"BALL_COLORS",["#FFFFFF","#ffd900","#0000FF","#FF0000","#800080","#ff3300","#008000","#600000","#000000","#FFFF00","#0000FF","#FF0000","#800080","#FF8000","#008000","#600000"]),u(h,"sixth",2*o.P.Y/6),u(h,"baulk",-1.5*o.P.X*2/5)},"./src/utils/replay-encoder.ts"(e,t,n){n.d(t,{k:()=>i});var r=n("./node_modules/jsoncrush/JSONCrush.js"),i=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"fullyEncodeURI",value:function(e){return encodeURIComponent(e).replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/!/g,"%21").replace(/\*/g,"%2A")}},{key:"crush",value:function(e){return r.A.crush(e)}},{key:"createState",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5?arguments[5]:void 0,s={init:e,shots:t,start:n,now:Date.now(),score:r,wholeGame:i,v:1};return o&&(s.players=o),s}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/utils/respot.ts"(e,t,n){n.d(t,{k:()=>l});var r=n("./src/model/ball.ts"),i=n("./src/view/tablegeometry.ts"),o=n("./src/model/physics/constants.ts"),s=n("./src/utils/rack.ts"),a=n("./node_modules/three/build/three.core.js"),l=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"nineBall",value:function(e){var n=e.balls.find(function(e){return 9===e.id});if(n){var r=new a.Pq0(i.P.tableX/2,0,0);t.respotBehind(r,n,e)}}},{key:"respot",value:function(e,n){var i=s.m.snookerColourPositions();return i.push(i[e.id-1]),i.reverse(),i.some(function(t){return!n.overlapsAny(t,e)&&(e.pos.copy(t),e.state=r.U.Stationary,!0)})||t.respotBehind(i[0],e,n),e}},{key:"respotBehind",value:function(e,t,n){for(var s=e.clone();s.x<i.P.tableX&&n.overlapsAny(s,t);)s.x+=o.R/8;for(;s.x>-i.P.tableX&&n.overlapsAny(s,t);)s.x-=o.R/8;t.pos.copy(s),t.state=r.U.Stationary}},{key:"closest",value:function(e,t){var n=t.filter(function(e){return e.onTable()}).filter(function(t){return t!==e});if(0!==n.length){var r=function(t){return e.pos.distanceTo(t.pos)};return n.reduce(function(e,t){return r(e)<r(t)?e:t},n[0])}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/utils/snookerconfig.ts"(e,t,n){n.d(t,{U:()=>r});var r={reds:15}},"./src/utils/threecushionconfig.ts"(e,t,n){n.d(t,{Y:()=>r});var r={raceTo:7}},"./src/utils/utils.ts"(e,t,n){n.d(t,{Dz:()=>v,F8:()=>w,FP:()=>b,KM:()=>u,RZ:()=>x,gn:()=>k,hs:()=>a,ld:()=>m,n7:()=>g,oN:()=>T,rq:()=>d,t6:()=>l,up:()=>s,v_:()=>o,xb:()=>f});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/events/eventtype.ts"),o=new r.Pq0(0,0,0),s=new r.Pq0(0,0,1);function a(e){return!e.entries.some(function(e){return e.event.type===i.B.AIM})}function l(e){return new r.Pq0(e.x,e.y,e.z)}var c=new r.Pq0;function u(e){return c.copy(s).cross(e)}var h=new r.Pq0;function f(e){return h.copy(e).normalize()}var p=new r.Pq0;function d(e,t){return 0>=p.copy(e).add(t).dot(e)}function v(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new r.Pq0;return t.set(1,0,0).applyAxisAngle(s,e)}function y(e){return Math.sign(e)*Math.floor((Math.abs(e)+Number.EPSILON)*1e4)/1e4}function m(e){return e.x=y(e.x),e.y=y(e.y),e.z=y(e.z),e}function b(e,t){return Math.fround(Math.atan2(e,t))}function g(e,t){return Math.fround(Math.pow(e,t))}function w(e){return Math.fround(Math.sin(e))}function k(e){return Math.fround(Math.cos(e))}function x(e){return Math.fround(Math.sqrt(e))}function T(e){return Math.fround(Math.exp(e))}},"./src/view/assets.ts"(e,t,n){n.d(t,{s:()=>y});var r=n("./src/controller/rules/rulefactory.ts"),i=n("./src/utils/gltf.ts"),o=n("./node_modules/three/build/three.core.js");function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");s(this,"listener",void 0),s(this,"audioLoader",void 0),s(this,"ballcollision",void 0),s(this,"cue",void 0),s(this,"cushion",void 0),s(this,"pot",void 0),s(this,"success",void 0),s(this,"lastOutcomeTime",0),s(this,"loadAssets",void 0),this.loadAssets=e,e&&(this.listener=new o.Pf$,this.audioLoader=new o.Am1,this.ballcollision=new o.fP5(this.listener),this.load("sounds/ballcollision.ogg",this.ballcollision),this.cue=new o.fP5(this.listener),this.load("sounds/cue.ogg",this.cue),this.cushion=new o.fP5(this.listener),this.load("sounds/cushion.ogg",this.cushion),this.pot=new o.fP5(this.listener),this.load("sounds/pot.ogg",this.pot),this.success=new o.fP5(this.listener),this.load("sounds/success.ogg",this.success))}return e=[{key:"addCameraToListener",value:function(e){e.add(this.listener)}},{key:"load",value:function(e,t){this.audioLoader.load(e,function(e){t.setBuffer(e),t.setLoop(!1)},function(e){},function(e){})}},{key:"play",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(this.loadAssets){var r,i,s=o.UtX.getContext();if((null==s?void 0:s.state)==="suspended"){(null==(i=navigator)||null==(r=i.userActivation)?void 0:r.hasBeenActive)&&s.resume();return}e.setVolume(t),e.isPlaying&&e.stop(),e.play(o.cj9.randFloat(0,.01)),e.setDetune(n)}}},{key:"outcomeToSound",value:function(e){"Collision"===e.type&&this.play(this.ballcollision,e.incidentSpeed/80,5*e.incidentSpeed),"Pot"===e.type&&this.play(this.pot,e.incidentSpeed/10,-1e3+10*e.incidentSpeed),"Cushion"===e.type&&this.play(this.cushion,e.incidentSpeed/70),"Hit"===e.type&&this.play(this.cue,e.incidentSpeed/30)}},{key:"processOutcomes",value:function(e){var t=this;e.every(function(e){return!(e.timestamp>t.lastOutcomeTime)||(t.lastOutcomeTime=e.timestamp,t.outcomeToSound(e),!1)})}},{key:"playNotify",value:function(){this.play(this.pot,1)}},{key:"playSuccess",value:function(e){this.play(this.success,.1,100*e-2200)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),l=n("./src/view/tablegeometry.ts"),c=n("./src/view/pocketgeometry.ts"),u=n("./src/model/physics/constants.ts");function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var f=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");h(this,"logger",function(e){}),h(this,"cloth",new o.tXL({color:4478393,wireframe:!1,flatShading:!0,transparent:!1})),h(this,"cushion",new o.tXL({color:5531065,wireframe:!1,flatShading:!0,transparent:!1})),h(this,"pocket",new o.tXL({color:4478361,wireframe:!1,flatShading:!0,transparent:!0,opacity:.3}))}return e=[{key:"generateTable",value:function(e){var t=this,n=new o.YJl,r=new o.HiM(0xf0f0e8,22);if(r.position.set(0,0,50*u.R),n.add(r),this.addCushions(n,e),e){c.f.knuckles.forEach(function(e){return t.knuckleCylinder(e,n)}),c.f.pocketCenters.forEach(function(e){return t.knuckleCylinder(e,n,t.pocket)});var i=c.f.pockets.pocketNW.pocket,s=c.f.pockets.pocketNW.knuckleNE;this.logger("knuckle-pocket gap = "+(i.pos.distanceTo(s.pos)-i.radius-s.radius))}return n}},{key:"knuckleCylinder",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.cloth;this.cylinder(e.pos,e.radius,.75*u.R/.5,t,n).position.setZ(-(.25*u.R)/.5/2)}},{key:"cylinder",value:function(e,n,r,i,s){var a="".concat(n,"_").concat(r),l=t.cylinderCache.get(a);l||(l=new o.Ho_(n,n,r,16),t.cylinderCache.set(a,l));var c=new o.eaF(l,s);return c.position.copy(e),c.rotation.x=Math.PI/2,i.add(c),c}},{key:"addCushions",value:function(e,t){var n=10*u.R/.5;this.plane(new o.Pq0(0,0,-u.R-n/2),2*l.P.X,2*l.P.Y,n,e,this.cloth);var r=u.R/.5,i=.75*u.R/.5,s=-(.25*u.R)/.5/2,a=l.P.X,h=l.P.Y,f=Math.abs(c.f.pockets.pocketNW.knuckleNE.pos.x-c.f.pockets.pocketN.knuckleNW.pos.x),p=Math.abs(c.f.pockets.pocketNW.knuckleSW.pos.y-c.f.pockets.pocketSW.knuckleNW.pos.y);t||(f=2*l.P.Y,p=2*l.P.Y+4*u.R),this.plane(new o.Pq0(a+r/2,0,s),r,p,i,e),this.plane(new o.Pq0(-a-r/2,0,s),r,p,i,e),this.plane(new o.Pq0(-a/2,h+r/2,s),f,r,i,e),this.plane(new o.Pq0(-a/2,-h-r/2,s),f,r,i,e),this.plane(new o.Pq0(a/2,h+r/2,s),f,r,i,e),this.plane(new o.Pq0(a/2,-h-r/2,s),f,r,i,e)}},{key:"plane",value:function(e,n,r,i,s){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:this.cushion,l="".concat(n,"_").concat(r,"_").concat(i),c=t.boxCache.get(l);c||(c=new o.iNn(n,r,i),t.boxCache.set(l,c));var u=new o.eaF(c,a);u.receiveShadow=!0,u.position.copy(e),s.add(u)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();h(f,"mesh",void 0),h(f,"cylinderCache",new Map),h(f,"boxCache",new Map);var p=n("./src/view/cuemesh.ts");function d(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function v(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var y=function(){var e,t;function n(e){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");v(this,"ready",void 0),v(this,"rules",void 0),v(this,"background",void 0),v(this,"table",void 0),v(this,"cue",void 0),v(this,"sound",void 0),this.rules=r.V.create(e,null),this.rules.tableGeometry()}return e=[{key:"loadFromWeb",value:function(e){var t=this;this.ready=e,this.sound=new a(!0),(0,i.Ro)("models/background.gltf",function(e){t.background=e.scene,t.done()}),(0,i.Ro)(this.rules.asset(),function(e){t.table=e.scene,f.mesh=e.scene.children[0],t.done()}),(0,i.Ro)("models/cue.gltf",function(e){t.cue=e,p.l.mesh=e.scene.children[0],t.done()})}},{key:"createLocal",value:function(){this.sound=new a(!1),f.mesh=new f().generateTable(l.P.hasPockets),this.table=f.mesh}},{key:"done",value:function(){this.background&&this.table&&this.cue&&this.ready()}}],t=[{key:"localAssets",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=new n(e);return t.createLocal(),t}}],e&&d(n.prototype,e),t&&d(n,t),n}()},"./src/view/cameratop.ts"(e,t,n){n.d(t,{v:()=>a});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/view/tablegeometry.ts"),o=n("./src/model/physics/constants.ts");function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"viewPoint",value:function(e,n){var s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new r.Pq0;(n!==t.lastFov||t.zoomFactor!==t.lastZoom)&&(t.cachedDist=t.zoomFactor/(2*Math.tan(n*Math.PI/360)),t.lastFov=n,t.lastZoom=t.zoomFactor);var a=t.cachedDist;if(e>this.portrait){var l=e>t.aspectLimit?2.75*i.P.tableY:2.4*i.P.tableX/e;return s.set(0,-.01*o.R,a*l)}var c=e>1/t.aspectLimit?4.9*i.P.tableY:1.35*i.P.tableX/e;return s.set(-.01*o.R,0,a*c)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();s(a,"aspectLimit",1.78),s(a,"portrait",.95),s(a,"fov",20),s(a,"zoomFactor",1),s(a,"lastFov",void 0),s(a,"lastZoom",void 0),s(a,"cachedDist",void 0)},"./src/view/cue.ts"(e,t,n){n.d(t,{s:()=>f});var r=n("./src/view/tablegeometry.ts"),i=n("./src/utils/utils.ts"),o=n("./src/events/aimevent.ts"),s=n("./src/model/ball.ts"),a=n("./src/model/physics/physics.ts"),l=n("./src/view/cuemesh.ts"),c=n("./node_modules/three/build/three.core.js"),u=n("./src/model/physics/constants.ts");function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var f=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");h(this,"mesh",void 0),h(this,"helperMesh",void 0),h(this,"placerMesh",void 0),h(this,"offCenterLimit",.3),h(this,"maxPower",160*u.R),h(this,"t",0),h(this,"aimInputs",void 0),h(this,"aim",new o.w),h(this,"length",+r.P.tableX),h(this,"tempVec",new c.Pq0),h(this,"tempVec2",new c.Pq0),h(this,"tempVec3",new c.Pq0),h(this,"raycaster",new c.tBo),this.mesh=l.l.createCue(.05*u.R/.5,.15*u.R/.5,this.length),this.helperMesh=l.l.createHelper(),this.placerMesh=l.l.createPlacer()}return e=[{key:"rotateAim",value:function(e,t){this.aim.angle=this.aim.angle+e,this.mesh.rotation.z=this.aim.angle,this.helperMesh.rotation.z=this.aim.angle,this.aimInputs.showOverlap(),this.avoidCueTouchingOtherBall(t)}},{key:"adjustPower",value:function(e){this.aim.power=Math.min(this.maxPower,this.aim.power+e),this.updateAimInput()}},{key:"setPower",value:function(e){this.aim.power=e*this.maxPower}},{key:"hit",value:function(e){var t=this.aim;this.t=0,e.state=s.U.Sliding,e.vel.copy((0,i.Dz)(t.angle,this.tempVec).multiplyScalar(t.power)),e.rvel.copy((0,a.t6)(t.offset,e.vel))}},{key:"aimAtNext",value:function(e,t){if(t){var n=(0,i.xb)(this.tempVec.copy(t.pos).sub(e.pos));this.aim.angle=(0,i.FP)(n.y,n.x)}}},{key:"adjustSpin",value:function(e,t){var n=this.tempVec3.copy(this.aim.offset).add(e);this.setSpin(n,t)}},{key:"setSpin",value:function(e,t){e.length()>this.offCenterLimit&&e.normalize().multiplyScalar(this.offCenterLimit),this.aim.offset.copy(e),this.avoidCueTouchingOtherBall(t),this.updateAimInput()}},{key:"avoidCueTouchingOtherBall",value:function(e){for(var t=0;t++<20&&this.intersectsAnything(e);)this.aim.offset.y+=.1,this.aim.offset.length()>this.offCenterLimit&&this.aim.offset.normalize().multiplyScalar(this.offCenterLimit);t>1&&this.updateAimInput()}},{key:"updateAimInput",value:function(){var e,t,n;null==(e=this.aimInputs)||e.updateVisualState(this.aim.offset.x,this.aim.offset.y),null==(t=this.aimInputs)||t.updatePowerSlider(this.aim.power/this.maxPower),null==(n=this.aimInputs)||n.showOverlap()}},{key:"moveTo",value:function(e){this.aim.pos.copy(e),this.mesh.rotation.z=this.aim.angle,this.helperMesh.rotation.z=this.aim.angle;var t=this.spinOffset(),n=((0,i.F8)(this.t+Math.PI/2)-1)*2*u.R*(this.aim.power/this.maxPower),r=(0,i.Dz)(this.aim.angle,this.tempVec).multiplyScalar(n);this.mesh.position.copy(e).add(t).add(r),this.helperMesh.position.copy(e),this.placerMesh.position.copy(e),this.placerMesh.rotation.z=this.t}},{key:"update",value:function(e){this.t+=e,this.moveTo(this.aim.pos)}},{key:"placeBallMode",value:function(){this.mesh.visible=!1,this.placerMesh.visible=!0,this.aim.angle=0}},{key:"aimMode",value:function(){this.mesh.visible=!0,this.placerMesh.visible=!1}},{key:"spinOffset",value:function(){return(0,i.KM)((0,i.Dz)(this.aim.angle,this.tempVec2)).multiplyScalar(2*this.aim.offset.x*u.R).setZ(2*this.aim.offset.y*u.R)}},{key:"intersectsAnything",value:function(e){var t=this.spinOffset(),n=this.tempVec.copy(e.cueball.pos).add(t),r=(0,i.xb)((0,i.Dz)(this.aim.angle+Math.PI,this.tempVec2).setZ(.1));this.raycaster.set(n,r);var o=[],s=!0,a=!1,l=void 0;try{for(var c,u=e.balls[Symbol.iterator]();!(s=(c=u.next()).done);s=!0){var h=c.value;o.push(h.ballmesh.mesh)}}catch(e){a=!0,l=e}finally{try{s||null==u.return||u.return()}finally{if(a)throw l}}return e.mesh&&o.push(e.mesh),this.raycaster.intersectObjects(o,!0).length>0}},{key:"showHelper",value:function(e){this.helperMesh.visible=e}},{key:"toggleHelper",value:function(){this.showHelper(!this.helperMesh.visible)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/view/cuemesh.ts"(e,t,n){n.d(t,{l:()=>a});var r=n("./src/model/physics/constants.ts"),i=n("./src/utils/utils.ts"),o=n("./node_modules/three/build/three.core.js");function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"indicateValid",value:function(e){t.placermaterial.color.setHex(e?0xccffcc:0xff0000)}},{key:"createHelper",value:function(){var e=new o.Ho_(r.R,r.R,30*r.R/.5,12,1,!0),t=new o.eaF(e,this.helpermaterial);return t.geometry.applyMatrix4(new o.kn4().identity().makeRotationAxis(i.up,-Math.PI/2)).applyMatrix4(new o.kn4().identity().makeTranslation(15*r.R/.5,0,-(.01*r.R)/.5)),t.visible=!1,t.renderOrder=-1,t.material.depthTest=!1,t}},{key:"createPlacer",value:function(){var e=new o.Ho_(.01*r.R/.5,r.R,r.R,4),n=new o.eaF(e,t.placermaterial);return n.geometry.applyMatrix4(new o.kn4().identity().makeRotationAxis(new o.Pq0(1,0,0),-Math.PI/2)).applyMatrix4(new o.kn4().identity().makeTranslation(0,0,.7*r.R/.5)),n.visible=!1,n}},{key:"createCue",value:function(e,n,s){var a=new o.Ho_(e,n,s,11),l=new o.eaF(a,t.material);return l.castShadow=!1,l.geometry.applyMatrix4(new o.kn4().identity().makeRotationAxis(new o.Pq0(1,0,0),-.17)).applyMatrix4(new o.kn4().identity().makeRotationAxis(i.up,-Math.PI/2)).applyMatrix4(new o.kn4().identity().makeTranslation(-s/2-r.R,0,s/2*.16918234906699603+.25*r.R)),l}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();s(a,"mesh",void 0),s(a,"material",new o.tXL({color:8934775,wireframe:!1,flatShading:!1})),s(a,"placermaterial",new o.tXL({color:0xccffcc,wireframe:!1,flatShading:!1,transparent:!0,opacity:.5})),s(a,"helpermaterial",new o.BKk({uniforms:{lightDirection:{value:new o.Pq0(0,0,1)}},vertexShader:`
       varying vec2 vUv;
       varying vec3 vNormal;
       void main() {
         vNormal = normal;
         vUv = uv;
diff --git a/dist/embed.html b/dist/embed.html
index ada1a98..7d23da1 100644
--- a/dist/embed.html
+++ b/dist/embed.html
@@ -10,11 +10,14 @@
       content="Embed billiards pool game on your website. Lightweight, embeddable billiards simulation with realistic physics."
     />
     <meta name="robots" content="index,follow" />
     <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
     <meta http-equiv="Permissions-Policy" content="interest-cohort=()" />
-    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
+    <meta
+      name="viewport"
+      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
+    />
     <link
       rel="canonical"
       href="https://tailuge.github.io/billiards/dist/embed.html"
     />
     <meta property="og:title" content="Billiards Embed - Pool Game Widget" />
@@ -35,20 +38,19 @@
     />
     <link rel="stylesheet" type="text/css" href="index.css" />
   </head>

   <body>
-    <main>
-      <div id="viewP1" class="view3d">
+    <div id="viewP1" class="view3d">
       <div id="snookerScoreOverlay">
         <div id="snookerScore" aria-live="polite">
           <div id="p1Score" class="p1Score"></div>
           <div id="p2Score" class="p2Score"></div>
           <div id="breakScore" class="breakScore"></div>
         </div>
       </div>
-    </main>
+    </div>
     <script async src="vendor.js"></script>
     <script async src="index.js"></script>
     <script>
       document.getElementById("viewP1").style.height = "100%"
     </script>
diff --git a/dist/index.html b/dist/index.html
index f58decf..4e3eecd 100644
--- a/dist/index.html
+++ b/dist/index.html
@@ -10,11 +10,14 @@
       content="Play free online billiards with realistic physics simulation. Browser-based pool game with multiplayer support. Built by tailuge - open source and playable on desktop and mobile."
     />
     <meta name="robots" content="index,follow" />
     <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
     <meta http-equiv="Permissions-Policy" content="interest-cohort=()" />
-    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
+    <meta
+      name="viewport"
+      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
+    />
     <link rel="canonical" href="https://tailuge.github.io/billiards/dist/" />
     <meta
       property="og:title"
       content="Billiards Pool Game - Free Online Physics Simulator"
     />
@@ -57,12 +60,11 @@
     </script>
     <link rel="stylesheet" type="text/css" href="index.css" />
   </head>

   <body>
-    <main>
-      <div id="viewP1" class="view3d">
+    <div id="viewP1" class="view3d">
       <div id="snookerScoreOverlay">
         <div id="snookerScore" aria-live="polite">
           <div id="p1Score" class="p1Score"></div>
           <div id="p2Score" class="p2Score"></div>
           <div id="breakScore" class="breakScore"></div>
@@ -142,39 +144,38 @@
             ðŸŽ¥
           </button>
         </div>
       </div>
     </div>
-      <div class="constants" id="constants">
-        <p>Physical Constants</p>
-        <div class="nw">
-          <input id="R" type="range" /><label for="R">R</label>
-        </div>
-        <div class="nw">
-          <input id="m" type="range" /><label for="m">m</label>
-        </div>
-        <div class="nw">
-          <input id="e" type="range" /><label for="e">e</label>
-        </div>
-        <div class="nw">
-          <input id="mu" type="range" /><label for="mu">mu</label>
-        </div>
-        <div class="nw">
-          <input id="muS" type="range" /><label for="muS">muS</label>
-        </div>
-        <div class="nw">
-          <input id="muC" type="range" /><label for="muC">muC</label>
-        </div>
-        <div class="nw">
-          <input id="rho" type="range" /><label for="rho">rho</label>
-        </div>
-        <div class="nw">
-          <button id="network" aria-label="Toggle network settings">
-            networkðŸ—²
-          </button>
-        </div>
+    <div class="constants" id="constants">
+      <p>Physical Constants</p>
+      <div class="nw">
+        <input id="R" type="range" /><label for="R">R</label>
+      </div>
+      <div class="nw">
+        <input id="m" type="range" /><label for="m">m</label>
+      </div>
+      <div class="nw">
+        <input id="e" type="range" /><label for="e">e</label>
+      </div>
+      <div class="nw">
+        <input id="mu" type="range" /><label for="mu">mu</label>
+      </div>
+      <div class="nw">
+        <input id="muS" type="range" /><label for="muS">muS</label>
       </div>
-    </main>
+      <div class="nw">
+        <input id="muC" type="range" /><label for="muC">muC</label>
+      </div>
+      <div class="nw">
+        <input id="rho" type="range" /><label for="rho">rho</label>
+      </div>
+      <div class="nw">
+        <button id="network" aria-label="Toggle network settings">
+          networkðŸ—²
+        </button>
+      </div>
+    </div>
     <script async src="vendor.js"></script>
     <script async src="index.js"></script>
   </body>
 </html>
diff --git a/dist/index.js b/dist/index.js
index dbb8670..7c70141 100644
--- a/dist/index.js
+++ b/dist/index.js
@@ -1,6 +1,6 @@
-"use strict";(self.webpackChunkbilliards=self.webpackChunkbilliards||[]).push([[57],{"./src/container/container.ts"(e,t,n){n.d(t,{m:()=>$});var r=n("./src/network/client/session.ts"),i=n("./src/events/stationaryevent.ts"),o=n("./node_modules/three/build/three.core.js"),s=n("./src/utils/utils.ts"),a=n("./src/view/cameratop.ts"),l=n("./src/model/physics/constants.ts");function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var u=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");c(this,"camera",void 0),c(this,"mode",this.topView),c(this,"mainMode",this.aimView),c(this,"height",8*l.R),c(this,"target",new o.Pq0),c(this,"lookTarget",new o.Pq0),c(this,"tempVec",new o.Pq0),c(this,"elapsed",void 0),this.camera=new o.ubm(45,e,l.R,1e3*l.R)}return e=[{key:"update",value:function(e,t){this.elapsed=e,this.mode(t)}},{key:"topView",value:function(e){this.camera.fov=a.v.fov,this.camera.position.lerp(a.v.viewPoint(this.camera.aspect,this.camera.fov,this.tempVec),.9),this.camera.up=s.up,this.camera.lookAt(s.v_)}},{key:"aimView",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.08,n=this.height,r=this.camera.aspect<.8;if(this.camera.fov=r?60:40,n<10*l.R){var i=100*(10*l.R-n);this.camera.fov-=i*(r?3:1)}this.target.copy(e.pos).addScaledVector((0,s.Dz)(e.angle,this.tempVec),-(18*l.R)),this.camera.position.lerp(this.target,t),this.camera.position.z=n,this.camera.up=s.up,this.lookTarget.copy(e.pos).addScaledVector(s.up,n/2),this.camera.lookAt(this.lookTarget)}},{key:"adjustHeight",value:function(e){e=this.height<10*l.R?e/8:e,this.height=o.cj9.clamp(this.height+e,6*l.R,120*l.R),this.height>110*l.R&&this.suggestMode(this.topView),this.height<105*l.R&&this.suggestMode(this.aimView)}},{key:"suggestMode",value:function(e){this.mainMode===this.aimView&&(this.mode=e)}},{key:"forceMode",value:function(e){this.mode=e,this.mainMode=e}},{key:"forceMove",value:function(e){this.mode===this.aimView&&this.aimView(e,1)}},{key:"toggleMode",value:function(){this.mode===this.topView?this.mode=this.aimView:this.mode=this.topView,this.mainMode=this.mode}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),h=n("./src/view/tablegeometry.ts"),f=function(){var e;function t(){var e,n;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");e="material",n=new o.mrM({color:132,opacity:.15,transparent:!0}),e in this?Object.defineProperty(this,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):this[e]=n}return e=[{key:"generateLineSegments",value:function(){var e=this,t=[this.point(0,-11.13*l.R/.5),this.point(0,11.13*l.R/.5)],n=h.P.X/4,r=h.P.tableY+l.R;[1,2,3,-1,-2,-3].forEach(function(i){t.push(e.point(i*n,-r)),t.push(e.point(i*n,r))});var i=(h.P.Y+l.R)/2,s=h.P.tableX+l.R;[-1,0,1].forEach(function(n){t.push(e.point(-s,n*i)),t.push(e.point(s,n*i))});var a=new o.LoY().setFromPoints(t);return new o.DXC(a,this.material)}},{key:"point",value:function(e,t){var n=-(.485*l.R)/.5;return new o.Pq0(e,t,n)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),p=n("./node_modules/three/build/three.module.js"),d=n("./src/controller/rules/snooker.ts");function v(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var y=function(){var e;function t(e,n,r){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");v(this,"scene",new o.Z58),v(this,"renderer",void 0),v(this,"camera",void 0),v(this,"windowWidth",1),v(this,"windowHeight",1),v(this,"lastFov",0),v(this,"element",void 0),v(this,"table",void 0),v(this,"loadAssets",!0),v(this,"assets",void 0),v(this,"frustum",new o.PPD),v(this,"projScreenMatrix",new o.kn4),v(this,"ballToCheck",0),this.element=e,this.table=n,this.assets=r,this.renderer=function(e){if("u"<typeof process){var t=new p.JeP({antialias:!1});return t.shadowMap.enabled=!1,t.autoClear=!1,t.setSize(e.offsetWidth,e.offsetHeight),t.setPixelRatio(.75*window.devicePixelRatio),e.appendChild(t.domElement),t}}(e),this.camera=new u(e?e.offsetWidth/e.offsetHeight:1),this.initialiseScene()}return e=[{key:"update",value:function(e,t){this.camera.update(e,t)}},{key:"sizeChanged",value:function(){var e,t;return this.windowWidth!=(null==(e=this.element)?void 0:e.offsetWidth)||this.windowHeight!=(null==(t=this.element)?void 0:t.offsetHeight)}},{key:"updateSize",value:function(){var e,t,n=this.sizeChanged();return n&&(this.windowWidth=null==(e=this.element)?void 0:e.offsetWidth,this.windowHeight=null==(t=this.element)?void 0:t.offsetHeight),n}},{key:"render",value:function(){this.isInMotionNotVisible()&&this.camera.suggestMode(this.camera.topView),this.renderCamera(this.camera)}},{key:"renderCamera",value:function(e){var t=this.updateSize();if(t){var n,r,i,o,s,a=this.windowWidth,l=this.windowHeight;null==(r=this.renderer)||r.setSize(a,l),null==(i=this.renderer)||i.setViewport(0,0,a,l),null==(o=this.renderer)||o.setScissor(0,0,a,l),null==(s=this.renderer)||s.setScissorTest(!0),e.camera.aspect=a/l}(t||e.camera.fov!==this.lastFov)&&(e.camera.updateProjectionMatrix(),this.lastFov=e.camera.fov),null==(n=this.renderer)||n.render(this.scene,e.camera)}},{key:"initialiseScene",value:function(){this.scene.add(new o.$p8(39202,.3)),this.assets.background&&this.scene.add(this.assets.background),this.scene.add(this.assets.table),this.table.mesh=this.assets.table,this.assets.rules.asset()!==d.c.tablemodel&&this.scene.add(new f().generateLineSegments())}},{key:"isInMotionNotVisible",value:function(){var e=this.viewFrustum(),t=this.table.balls[this.ballToCheck++%this.table.balls.length];return t.inMotion()&&!e.intersectsObject(t.ballmesh.mesh)}},{key:"viewFrustum",value:function(){var e=this.camera.camera;return this.frustum.setFromProjectionMatrix(this.projScreenMatrix.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse)),this.frustum}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),m=n("./src/controller/init.ts"),b=n("./src/events/input.ts");function g(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var w=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");g(this,"line",new o.cZY),g(this,"balls",void 0),this.balls=e}return e=[{key:"getFirst",value:function(e,t){var n=this;this.line.set(e.pos,(0,s.xb)(t).multiplyScalar(4*h.P.X).add(e.pos));var r=new o.Pq0,i=this.balls.map(function(t){return n.line.closestPointToPoint(t.pos,!0,r),{ball:t,perpendicular:r.distanceTo(t.pos),distance:r.distanceTo(e.pos)}}).filter(function(e){return e.perpendicular<2*l.R}).filter(function(t){return t.ball!==e});return i.reduce(function(e,t){return e.distance<t.distance?e:t},i[0])}},{key:"getOverlapOffset",value:function(e,t){var n=this.getFirst(e,t);if(n){var r=n.ball.pos.clone().sub(e.pos),i=n.perpendicular*Math.sign(r.cross(t).z)/l.R;return{ball:n.ball,overlap:i}}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),k=n("./src/utils/dom.ts");function T(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var x=function(){var e;function t(e){var n,i=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");T(this,"cueBallElement",void 0),T(this,"cueTipElement",void 0),T(this,"cuePowerElement",void 0),T(this,"cueHitElement",void 0),T(this,"objectBallStyle",void 0),T(this,"container",void 0),T(this,"overlap",void 0),T(this,"ballWidth",void 0),T(this,"ballHeight",void 0),T(this,"tipRadius",void 0),T(this,"mousemove",function(e){1===e.buttons&&i.adjustSpin(e)}),T(this,"powerChanged",function(e){i.container.table.cue.setPower(i.cuePowerElement.value)}),T(this,"hit",function(e){var t;i.container.table.cue.setPower(null==(t=i.cuePowerElement)?void 0:t.value),i.container.inputQueue.push(new b.p(0,"SpaceUp"))}),T(this,"mousewheel",function(e){i.cuePowerElement&&(i.cuePowerElement.value-=Math.sign(e.deltaY)/10,i.container.table.cue.setPower(i.cuePowerElement.value),i.container.lastEventTime=performance.now())}),this.container=e,this.cueBallElement=(0,k.id)("cueBall"),this.cueTipElement=(0,k.id)("cueTip"),this.cuePowerElement=(0,k.id)("cuePower"),this.cueHitElement=(0,k.id)("cueHit"),this.objectBallStyle=null==(n=(0,k.id)("objectBall"))?void 0:n.style,this.overlap=new w(this.container.table.balls),this.addListeners(),r.N.isSpectator()&&this.setDisabled(!0)}return e=[{key:"addListeners",value:function(){var e,t,n,r,i,o=this;null==(e=this.cueBallElement)||e.addEventListener("pointermove",this.mousemove),null==(t=this.cueBallElement)||t.addEventListener("click",function(e){o.adjustSpin(e)}),null==(n=this.cueHitElement)||n.addEventListener("click",this.hit),null==(r=this.cuePowerElement)||r.addEventListener("change",this.powerChanged),"ontouchstart"in globalThis||null==(i=(0,k.id)("viewP1"))||i.addEventListener("dblclick",this.hit),document.addEventListener("wheel",this.mousewheel)}},{key:"setButtonText",value:function(e){this.cueHitElement&&(this.cueHitElement.innerText=e)}},{key:"setDisabled",value:function(e){this.cueHitElement&&(this.cueHitElement.disabled=e||r.N.isSpectator())}},{key:"readDimensions",value:function(){var e,t,n;this.ballWidth=null==(e=this.cueBallElement)?void 0:e.offsetWidth,this.ballHeight=null==(t=this.cueBallElement)?void 0:t.offsetHeight,this.tipRadius=(null==(n=this.cueTipElement)?void 0:n.offsetWidth)/2}},{key:"adjustSpin",value:function(e){this.readDimensions(),this.container.table.cue.setSpin(new o.Pq0(-(e.offsetX-this.ballWidth/2)/this.ballWidth,-(e.offsetY-this.ballHeight/2)/this.ballHeight),this.container.table),this.container.lastEventTime=performance.now()}},{key:"updateVisualState",value:function(e,t){this.readDimensions();var n,r=null==(n=this.cueTipElement)?void 0:n.style;r&&(r.left=(-e+.5)*this.ballWidth-this.tipRadius+"px",r.top=(-t+.5)*this.ballHeight-this.tipRadius+"px"),this.showOverlap()}},{key:"showOverlap",value:function(){if(this.objectBallStyle){var e=this.container.table,t=(0,s.Dz)(e.cue.aim.angle),n=this.overlap.getOverlapOffset(e.cueball,t);n?(this.readDimensions(),this.objectBallStyle.visibility="visible",this.objectBallStyle.left=5+n.overlap*this.ballWidth/2+"px",this.objectBallStyle.backgroundColor=new o.Q1f(0,0,0).lerp(n.ball.ballmesh.color,.5).getStyle()):this.objectBallStyle.visibility="hidden"}}},{key:"updatePowerSlider",value:function(e){var t;e>0&&(null==(t=this.cuePowerElement)?void 0:t.value)&&(this.cuePowerElement.value=e)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function P(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var S=function(){var e;function t(e){var n,r=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");P(this,"chatoutput",void 0),P(this,"chatInput",void 0),P(this,"chatSend",void 0),P(this,"chatInputText",void 0),P(this,"send",void 0),P(this,"sendClicked",function(e){var t,n;r.send(null==(t=r.chatInputText)?void 0:t.value),r.showMessage(null==(n=r.chatInputText)?void 0:n.value)}),this.chatoutput=(0,k.id)("chatoutput"),this.chatInputText=(0,k.V4)("chatinputtext"),this.chatSend=(0,k.id)("chatsend"),null==(n=this.chatSend)||n.addEventListener("click",this.sendClicked),this.send=e}return e=[{key:"showMessage",value:function(e){this.chatoutput&&(this.chatoutput.innerHTML+=e),this.updateScroll()}},{key:"updateScroll",value:function(){this.chatoutput&&(this.chatoutput.scrollTop=this.chatoutput.scrollHeight)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),O=n("./src/events/chatevent.ts"),R=n("./src/events/eventtype.ts");function E(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var A=function(){var e;function t(e,n){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");E(this,"period",void 0),E(this,"pending",null),E(this,"sentTime",0),E(this,"apply",function(e){}),this.period=e,this.apply=n}return e=[{key:"flush",value:function(){this.pending&&(this.apply(this.pending),this.pending=null)}},{key:"send",value:function(e){if(performance.now()>this.sentTime+this.period||e.type!==R.B.AIM){this.flush(),this.apply(e),this.sentTime=performance.now();return}this.pending=e}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),M=n("./src/view/sliders.ts"),_=n("./src/model/outcome.ts"),C=n("./src/utils/replay-encoder.ts");function I(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var j=function(){var e;function t(e,n){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");I(this,"container",void 0),I(this,"linkFormatter",void 0),I(this,"entries",[]),I(this,"start",Date.now()),I(this,"breakStart",void 0),I(this,"breakStartTime",void 0),this.container=e,this.linkFormatter=n}return e=[{key:"shots",get:function(){return this.entries.map(function(e){return e.event})}},{key:"states",get:function(){return this.entries.map(function(e){return e.state})}},{key:"record",value:function(e){var t=e;e.type===R.B.HIT&&(t=e.tablejson.aim),(e.type===R.B.HIT||e.type===R.B.RERACK||e.type===R.B.PLACEBALL||e.type===R.B.SCORE)&&this.entries.push({state:this.container.table.shortSerialise(),event:t,pots:0,isPartOfBreak:!1,time:Date.now()})}},{key:"findLastIndex",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[R.B.RERACK,R.B.SCORE],t=this.entries.length-1;t>=0&&e.includes(this.entries[t].event.type);)t--;return t}},{key:"getPlayerNames",value:function(){if(r.N.hasInstance()){var e=r.N.getInstance(),t=0===e.playerIndex;return{player1:(t?e.playername:e.opponentName)||"Player 1",player2:(t?e.opponentName:e.playername)||"Player 2"}}}},{key:"wholeGame",value:function(){var e;return C.k.createState(null==(e=this.entries[0])?void 0:e.state,this.entries.map(function(e){return e.event}),this.start,this.container.scores[r.N.playerIndex()],!0,this.getPlayerNames())}},{key:"last",value:function(){return this.findLastIndex()}},{key:"lastShot",value:function(){var e=this.last();if(!(e<0)){for(var t=this.entries[e],n=[t.event],r=e+1;r<this.entries.length;r++)this.entries[r].event.type===R.B.SCORE&&n.push(this.entries[r].event);return C.k.createState(t.state,n,0,0,!1,this.getPlayerNames())}}},{key:"currentBreak",value:function(){if(void 0!==this.breakStart){var e=this.entries.slice(this.breakStart);return C.k.createState(this.entries[this.breakStart].state,e.map(function(e){return e.event}),this.breakStartTime,this.container.rules.previousBreak,!1,this.getPlayerNames())}}},{key:"updateBreak",value:function(e,t,n){var r=_.P.potCount(e),i=this.last();if(i>=0&&(this.entries[i].pots=r,this.entries[i].isPartOfBreak=t),t||this.breakLink(n),this.lastShotLink(t||n,r,_.P.pots(e)),n&&this.breakLink(n),!t){this.breakStart=void 0;return}void 0===this.breakStart&&(this.breakStart=i,this.breakStartTime=Date.now())}},{key:"lastShotLink",value:function(e,t,n){var r=this.lastShot();r&&this.linkFormatter.lastShotLink(e,t,n,r)}},{key:"breakLink",value:function(e){var t=this.currentBreak();if(t){var n=0===this.container.rules.currentBreak?this.container.rules.previousBreak:this.container.rules.currentBreak;if(e)return void this.linkFormatter.breakLink(t,n,!0);for(var r=t.shots.slice();r.length>0&&(r[r.length-1].type===R.B.SCORE||r[r.length-1].type===R.B.RERACK);)r.pop();if(0!==r.length){var i,o,s=(i=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(t){I(e,t,n[t])})}return e}({},t),o=o={shots:r},Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(o)):(function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t.push.apply(t,n)}return t})(Object(o)).forEach(function(e){Object.defineProperty(i,e,Object.getOwnPropertyDescriptor(o,e))}),i);this.linkFormatter.breakLink(s,n,!1)}}}},{key:"wholeGameLink",value:function(){this.linkFormatter.wholeGameLink(this.wholeGame())}},{key:"getPastShots",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[R.B.RERACK,R.B.SCORE],n=[],r=this.entries.length-1;r>=0&&n.length<e;r--)t.includes(this.entries[r].event.type)||n.unshift(this.entries[r]);return n}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function L(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var B=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");L(this,"container",void 0),L(this,"replayUrl",""),L(this,"hiScoreUrl","https://scoreboard-tailuge.vercel.app/hiscore.html"),this.container=e}return e=[{key:"lastShotLink",value:function(e,t,n,r){var i="#000000";n.length>0&&n.forEach(function(e){e.ballmesh&&(i="#"+e.ballmesh.color.getHexString())});var o="âšˆ".repeat(t>1?t-1:0)+(e?"âšˆ":"âš†"),s=JSON.stringify(r);this.generateLink(o,s,i)}},{key:"breakLink",value:function(e,t,n){if(e&&(n||e.shots.pop(),1!==e.shots.length)){e.score=t;var r=JSON.stringify(e),i=C.k.crush(r);this.generateLink("break(".concat(t,")"),i,"black"),t>=2&&this.generateHiScoreLink(i)}}},{key:"wholeGameLink",value:function(e){var t="frame(".concat(this.shotCount(e.shots)," shots)"),n=JSON.stringify(e),r=C.k.crush(n);this.generateLink(t,r,"black")}},{key:"shotCount",value:function(e){return e.filter(function(e){return"RERACK"!==e.type}).length}},{key:"generateLink",value:function(e,t,n){var r="".concat(this.replayUrl).concat(C.k.fullyEncodeURI(t)),i='<a class="pill" style="color: '.concat(n,'" target="_blank" href="').concat(r,'">').concat(e,"</a>");this.container.eventQueue.push(new O.b(null,"".concat(i)))}},{key:"generateHiScoreLink",value:function(e){var t="".concat(this.hiScoreUrl,"?ruletype=").concat(this.container.rules.rulename,"&state=").concat(C.k.fullyEncodeURI(e)),n='<a class="pill" target="_blank" href="'.concat(t,'">').concat("hi score ðŸ†","</a>");this.container.eventQueue.push(new O.b(null,"".concat(n)))}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),N=n("./src/controller/rules/rulefactory.ts");function F(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var H=function(){var e;function t(e){var n=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");F(this,"container",void 0),F(this,"share",void 0),F(this,"camera",void 0),F(this,"disabled",!0),this.container=e,this.share=this.getElement("share"),this.camera=this.getElement("camera"),this.share&&(this.share.disabled=!0),this.camera&&(this.camera.onclick=function(e){n.adjustCamera()})}return e=[{key:"adjustCamera",value:function(){this.container.view.camera.toggleMode(),this.container.lastEventTime=performance.now()}},{key:"getElement",value:function(e){return(0,k.vq)(e)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function U(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var D=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");U(this,"p1Element",void 0),U(this,"p2Element",void 0),U(this,"breakElement",void 0),this.p1Element=(0,k.id)("p1Score"),this.p2Element=(0,k.id)("p2Score"),this.breakElement=(0,k.id)("breakScore")}return e=[{key:"setText",value:function(e,t){e&&(e.textContent=t)}},{key:"updateBreak",value:function(e){this.setText(this.p1Element,""),this.setText(this.p2Element,""),e>0&&this.breakElement?this.breakElement.innerHTML="Break</br>"+e:this.setText(this.breakElement,"")}},{key:"updateScores",value:function(e,t,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;this.setText(this.p1Element,""),this.setText(this.p2Element,""),this.setText(this.breakElement,""),n&&r?(this.setText(this.p1Element,"".concat(n,": ").concat(e)),this.setText(this.p2Element,"".concat(r,": ").concat(t))):n?this.setText(this.p1Element,"".concat(n,": ").concat(e)):r?this.setText(this.p2Element,"".concat(r,": ").concat(t)):this.setText(this.p1Element,"Score: ".concat(e)),i>0&&this.setText(this.breakElement,"Break: ".concat(i))}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function z(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function G(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var V=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");G(this,"element",void 0),G(this,"timeoutId",null),this.element=(0,k.id)("notification")}return e=[{key:"getIcon",value:function(e){return e.icon?e.icon:"Foul"===e.type?"ðŸŽ±":"GameOver"===e.type?"ðŸ†":"ðŸ”µ"}},{key:"show",value:function(e){var t,n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3e3;if(this.element){var i=r;if("string"==typeof e)t=this.renderStringContent(e),n="type-Info";else{var o=this.processData(e);t=o.content,n=o.typeClass,void 0!==e.duration&&(i=e.duration)}this.display(t,n,i)}}},{key:"renderStringContent",value:function(e){return`
+"use strict";(self.webpackChunkbilliards=self.webpackChunkbilliards||[]).push([[57],{"./src/container/container.ts"(e,t,n){n.d(t,{m:()=>$});var r=n("./src/network/client/session.ts"),i=n("./src/events/stationaryevent.ts"),o=n("./node_modules/three/build/three.core.js"),s=n("./src/utils/utils.ts"),a=n("./src/view/cameratop.ts"),l=n("./src/model/physics/constants.ts");function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var u=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");c(this,"camera",void 0),c(this,"mode",this.topView),c(this,"mainMode",this.aimView),c(this,"height",8*l.R),c(this,"target",new o.Pq0),c(this,"lookTarget",new o.Pq0),c(this,"tempVec",new o.Pq0),c(this,"elapsed",void 0),this.camera=new o.ubm(45,e,l.R,1e3*l.R)}return e=[{key:"update",value:function(e,t){this.elapsed=e,this.mode(t)}},{key:"topView",value:function(e){this.camera.fov=a.v.fov,this.camera.position.lerp(a.v.viewPoint(this.camera.aspect,this.camera.fov,this.tempVec),.9),this.camera.up=s.up,this.camera.lookAt(s.v_)}},{key:"aimView",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.08,n=this.height,r=this.camera.aspect<.8;if(this.camera.fov=r?60:40,n<10*l.R){var i=100*(10*l.R-n);this.camera.fov-=i*(r?3:1)}this.target.copy(e.pos).addScaledVector((0,s.Dz)(e.angle,this.tempVec),-(18*l.R)),this.camera.position.lerp(this.target,t),this.camera.position.z=n,this.camera.up=s.up,this.lookTarget.copy(e.pos).addScaledVector(s.up,n/2),this.camera.lookAt(this.lookTarget)}},{key:"adjustHeight",value:function(e){e=this.height<10*l.R?e/8:e,this.height=o.cj9.clamp(this.height+e,6*l.R,120*l.R),this.height>110*l.R&&this.suggestMode(this.topView),this.height<105*l.R&&this.suggestMode(this.aimView)}},{key:"suggestMode",value:function(e){this.mainMode===this.aimView&&(this.mode=e)}},{key:"forceMode",value:function(e){this.mode=e,this.mainMode=e}},{key:"forceMove",value:function(e){this.mode===this.aimView&&this.aimView(e,1)}},{key:"toggleMode",value:function(){this.mode===this.topView?this.mode=this.aimView:this.mode=this.topView,this.mainMode=this.mode}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),h=n("./src/view/tablegeometry.ts"),f=function(){var e;function t(){var e,n;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");e="material",n=new o.mrM({color:132,opacity:.15,transparent:!0}),e in this?Object.defineProperty(this,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):this[e]=n}return e=[{key:"generateLineSegments",value:function(){var e=this,t=[this.point(0,-11.13*l.R/.5),this.point(0,11.13*l.R/.5)],n=h.P.X/4,r=h.P.tableY+l.R;[1,2,3,-1,-2,-3].forEach(function(i){t.push(e.point(i*n,-r)),t.push(e.point(i*n,r))});var i=(h.P.Y+l.R)/2,s=h.P.tableX+l.R;[-1,0,1].forEach(function(n){t.push(e.point(-s,n*i)),t.push(e.point(s,n*i))});var a=new o.LoY().setFromPoints(t);return new o.DXC(a,this.material)}},{key:"point",value:function(e,t){var n=-(.485*l.R)/.5;return new o.Pq0(e,t,n)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),p=n("./node_modules/three/build/three.module.js"),d=n("./src/controller/rules/snooker.ts");function v(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var y=function(){var e;function t(e,n,r){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");v(this,"scene",new o.Z58),v(this,"renderer",void 0),v(this,"camera",void 0),v(this,"windowWidth",1),v(this,"windowHeight",1),v(this,"lastFov",0),v(this,"element",void 0),v(this,"table",void 0),v(this,"loadAssets",!0),v(this,"assets",void 0),v(this,"frustum",new o.PPD),v(this,"projScreenMatrix",new o.kn4),v(this,"ballToCheck",0),this.element=e,this.table=n,this.assets=r,this.renderer=function(e){if("u"<typeof process){var t=new p.JeP({antialias:!1});return t.shadowMap.enabled=!1,t.autoClear=!1,t.setSize(e.offsetWidth,e.offsetHeight),t.setPixelRatio(.75*window.devicePixelRatio),e.appendChild(t.domElement),t}}(e),this.camera=new u(e?e.offsetWidth/e.offsetHeight:1),this.initialiseScene()}return e=[{key:"update",value:function(e,t){this.camera.update(e,t)}},{key:"sizeChanged",value:function(){var e,t;return this.windowWidth!=(null==(e=this.element)?void 0:e.offsetWidth)||this.windowHeight!=(null==(t=this.element)?void 0:t.offsetHeight)}},{key:"updateSize",value:function(){var e,t,n=this.sizeChanged();return n&&(this.windowWidth=null==(e=this.element)?void 0:e.offsetWidth,this.windowHeight=null==(t=this.element)?void 0:t.offsetHeight),n}},{key:"render",value:function(){this.isInMotionNotVisible()&&this.camera.suggestMode(this.camera.topView),this.renderCamera(this.camera)}},{key:"renderCamera",value:function(e){var t=this.updateSize();if(t){var n,r,i,o,s,a=this.windowWidth,l=this.windowHeight;null==(r=this.renderer)||r.setSize(a,l),null==(i=this.renderer)||i.setViewport(0,0,a,l),null==(o=this.renderer)||o.setScissor(0,0,a,l),null==(s=this.renderer)||s.setScissorTest(!0),e.camera.aspect=a/l}(t||e.camera.fov!==this.lastFov)&&(e.camera.updateProjectionMatrix(),this.lastFov=e.camera.fov),null==(n=this.renderer)||n.render(this.scene,e.camera)}},{key:"initialiseScene",value:function(){this.scene.add(new o.$p8(39202,.3)),this.assets.background&&this.scene.add(this.assets.background),this.scene.add(this.assets.table),this.table.mesh=this.assets.table,this.assets.rules.asset()!==d.c.tablemodel&&this.scene.add(new f().generateLineSegments())}},{key:"isInMotionNotVisible",value:function(){var e=this.viewFrustum(),t=this.table.balls[this.ballToCheck++%this.table.balls.length];return t.inMotion()&&!e.intersectsObject(t.ballmesh.mesh)}},{key:"viewFrustum",value:function(){var e=this.camera.camera;return this.frustum.setFromProjectionMatrix(this.projScreenMatrix.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse)),this.frustum}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),m=n("./src/controller/init.ts"),b=n("./src/events/input.ts");function g(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var w=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");g(this,"line",new o.cZY),g(this,"balls",void 0),this.balls=e}return e=[{key:"getFirst",value:function(e,t){var n=this;this.line.set(e.pos,(0,s.xb)(t).multiplyScalar(4*h.P.X).add(e.pos));var r=new o.Pq0,i=this.balls.map(function(t){return n.line.closestPointToPoint(t.pos,!0,r),{ball:t,perpendicular:r.distanceTo(t.pos),distance:r.distanceTo(e.pos)}}).filter(function(e){return e.perpendicular<2*l.R}).filter(function(t){return t.ball!==e});return i.reduce(function(e,t){return e.distance<t.distance?e:t},i[0])}},{key:"getOverlapOffset",value:function(e,t){var n=this.getFirst(e,t);if(n){var r=n.ball.pos.clone().sub(e.pos),i=n.perpendicular*Math.sign(r.cross(t).z)/l.R;return{ball:n.ball,overlap:i}}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),k=n("./src/utils/dom.ts");function T(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var x=function(){var e;function t(e){var n,i=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");T(this,"cueBallElement",void 0),T(this,"cueTipElement",void 0),T(this,"cuePowerElement",void 0),T(this,"cueHitElement",void 0),T(this,"objectBallStyle",void 0),T(this,"container",void 0),T(this,"overlap",void 0),T(this,"ballWidth",void 0),T(this,"ballHeight",void 0),T(this,"tipRadius",void 0),T(this,"mousemove",function(e){1===e.buttons&&i.adjustSpin(e)}),T(this,"powerChanged",function(e){i.container.table.cue.setPower(i.cuePowerElement.value)}),T(this,"hit",function(e){var t;i.container.table.cue.setPower(null==(t=i.cuePowerElement)?void 0:t.value),i.container.inputQueue.push(new b.p(0,"SpaceUp"))}),T(this,"mousewheel",function(e){i.cuePowerElement&&(i.cuePowerElement.value-=Math.sign(e.deltaY)/10,i.container.table.cue.setPower(i.cuePowerElement.value),i.container.lastEventTime=performance.now())}),this.container=e,this.cueBallElement=(0,k.id)("cueBall"),this.cueTipElement=(0,k.id)("cueTip"),this.cuePowerElement=(0,k.id)("cuePower"),this.cueHitElement=(0,k.id)("cueHit"),this.objectBallStyle=null==(n=(0,k.id)("objectBall"))?void 0:n.style,this.overlap=new w(this.container.table.balls),this.addListeners(),r.N.isSpectator()&&this.setDisabled(!0)}return e=[{key:"addListeners",value:function(){var e,t,n,r,i,o=this;null==(e=this.cueBallElement)||e.addEventListener("pointermove",this.mousemove),null==(t=this.cueBallElement)||t.addEventListener("click",function(e){o.adjustSpin(e)}),null==(n=this.cueHitElement)||n.addEventListener("click",this.hit),null==(r=this.cuePowerElement)||r.addEventListener("change",this.powerChanged),"ontouchstart"in globalThis||null==(i=(0,k.id)("viewP1"))||i.addEventListener("dblclick",this.hit),document.addEventListener("wheel",this.mousewheel)}},{key:"setButtonText",value:function(e){this.cueHitElement&&(this.cueHitElement.innerText=e)}},{key:"setDisabled",value:function(e){this.cueHitElement&&(this.cueHitElement.disabled=e||r.N.isSpectator())}},{key:"readDimensions",value:function(){var e,t,n;this.ballWidth=null==(e=this.cueBallElement)?void 0:e.offsetWidth,this.ballHeight=null==(t=this.cueBallElement)?void 0:t.offsetHeight,this.tipRadius=(null==(n=this.cueTipElement)?void 0:n.offsetWidth)/2}},{key:"adjustSpin",value:function(e){this.readDimensions(),this.container.table.cue.setSpin(new o.Pq0(-(e.offsetX-this.ballWidth/2)/this.ballWidth,-(e.offsetY-this.ballHeight/2)/this.ballHeight),this.container.table),this.container.lastEventTime=performance.now()}},{key:"updateVisualState",value:function(e,t){this.readDimensions();var n,r=null==(n=this.cueTipElement)?void 0:n.style;r&&(r.left=(-e+.5)*this.ballWidth-this.tipRadius+"px",r.top=(-t+.5)*this.ballHeight-this.tipRadius+"px"),this.showOverlap()}},{key:"showOverlap",value:function(){if(this.objectBallStyle){var e=this.container.table,t=(0,s.Dz)(e.cue.aim.angle),n=this.overlap.getOverlapOffset(e.cueball,t);n?(this.readDimensions(),this.objectBallStyle.visibility="visible",this.objectBallStyle.left=5+n.overlap*this.ballWidth/2+"px",this.objectBallStyle.backgroundColor=new o.Q1f(0,0,0).lerp(n.ball.ballmesh.color,.5).getStyle()):this.objectBallStyle.visibility="hidden"}}},{key:"updatePowerSlider",value:function(e){var t;e>0&&(null==(t=this.cuePowerElement)?void 0:t.value)&&(this.cuePowerElement.value=e)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function P(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var S=function(){var e;function t(e){var n,r=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");P(this,"chatoutput",void 0),P(this,"chatInput",void 0),P(this,"chatSend",void 0),P(this,"chatInputText",void 0),P(this,"send",void 0),P(this,"sendClicked",function(e){var t,n;r.send(null==(t=r.chatInputText)?void 0:t.value),r.showMessage(null==(n=r.chatInputText)?void 0:n.value)}),this.chatoutput=(0,k.id)("chatoutput"),this.chatInputText=(0,k.V4)("chatinputtext"),this.chatSend=(0,k.id)("chatsend"),null==(n=this.chatSend)||n.addEventListener("click",this.sendClicked),this.send=e}return e=[{key:"showMessage",value:function(e){this.chatoutput&&(this.chatoutput.innerHTML+=e),this.updateScroll()}},{key:"updateScroll",value:function(){this.chatoutput&&(this.chatoutput.scrollTop=this.chatoutput.scrollHeight)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),O=n("./src/events/chatevent.ts"),R=n("./src/events/eventtype.ts");function E(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var A=function(){var e;function t(e,n){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");E(this,"period",void 0),E(this,"pending",null),E(this,"sentTime",0),E(this,"apply",function(e){}),this.period=e,this.apply=n}return e=[{key:"flush",value:function(){this.pending&&(this.apply(this.pending),this.pending=null)}},{key:"send",value:function(e){if(performance.now()>this.sentTime+this.period||e.type!==R.B.AIM){this.flush(),this.apply(e),this.sentTime=performance.now();return}this.pending=e}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),M=n("./src/view/sliders.ts"),_=n("./src/model/outcome.ts"),C=n("./src/utils/replay-encoder.ts");function I(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var j=function(){var e;function t(e,n){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");I(this,"container",void 0),I(this,"linkFormatter",void 0),I(this,"entries",[]),I(this,"start",Date.now()),I(this,"breakStart",void 0),I(this,"breakStartTime",void 0),this.container=e,this.linkFormatter=n}return e=[{key:"shots",get:function(){return this.entries.map(function(e){return e.event})}},{key:"states",get:function(){return this.entries.map(function(e){return e.state})}},{key:"record",value:function(e){var t=e;e.type===R.B.HIT&&(t=e.tablejson.aim),(e.type===R.B.HIT||e.type===R.B.RERACK||e.type===R.B.PLACEBALL||e.type===R.B.SCORE)&&this.entries.push({state:this.container.table.shortSerialise(),event:t,pots:0,isPartOfBreak:!1,time:Date.now()})}},{key:"findLastIndex",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[R.B.RERACK,R.B.SCORE],t=this.entries.length-1;t>=0&&e.includes(this.entries[t].event.type);)t--;return t}},{key:"getPlayerNames",value:function(){if(r.N.hasInstance()){var e=r.N.getInstance(),t=0===e.playerIndex;return{player1:(t?e.playername:e.opponentName)||"Player",player2:(t?e.opponentName:e.playername)||"Opponent"}}}},{key:"wholeGame",value:function(){var e;return C.k.createState(null==(e=this.entries[0])?void 0:e.state,this.entries.map(function(e){return e.event}),this.start,this.container.scores[r.N.playerIndex()],!0,this.getPlayerNames())}},{key:"last",value:function(){return this.findLastIndex()}},{key:"lastShot",value:function(){var e=this.last();if(!(e<0)){for(var t=this.entries[e],n=[t.event],r=e+1;r<this.entries.length;r++)this.entries[r].event.type===R.B.SCORE&&n.push(this.entries[r].event);return C.k.createState(t.state,n,0,0,!1,this.getPlayerNames())}}},{key:"currentBreak",value:function(){if(void 0!==this.breakStart){var e=this.entries.slice(this.breakStart);return C.k.createState(this.entries[this.breakStart].state,e.map(function(e){return e.event}),this.breakStartTime,this.container.rules.previousBreak,!1,this.getPlayerNames())}}},{key:"updateBreak",value:function(e,t,n){var r=_.P.potCount(e),i=this.last();if(i>=0&&(this.entries[i].pots=r,this.entries[i].isPartOfBreak=t),t||this.breakLink(n),this.lastShotLink(t||n,r,_.P.pots(e)),n&&this.breakLink(n),!t){this.breakStart=void 0;return}void 0===this.breakStart&&(this.breakStart=i,this.breakStartTime=Date.now())}},{key:"lastShotLink",value:function(e,t,n){var r=this.lastShot();r&&this.linkFormatter.lastShotLink(e,t,n,r)}},{key:"breakLink",value:function(e){var t=this.currentBreak();if(t){var n=0===this.container.rules.currentBreak?this.container.rules.previousBreak:this.container.rules.currentBreak;if(e)return void this.linkFormatter.breakLink(t,n,!0);for(var r=t.shots.slice();r.length>0&&(r[r.length-1].type===R.B.SCORE||r[r.length-1].type===R.B.RERACK);)r.pop();if(0!==r.length){var i,o,s=(i=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(t){I(e,t,n[t])})}return e}({},t),o=o={shots:r},Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(o)):(function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t.push.apply(t,n)}return t})(Object(o)).forEach(function(e){Object.defineProperty(i,e,Object.getOwnPropertyDescriptor(o,e))}),i);this.linkFormatter.breakLink(s,n,!1)}}}},{key:"wholeGameLink",value:function(){this.linkFormatter.wholeGameLink(this.wholeGame())}},{key:"getPastShots",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[R.B.RERACK,R.B.SCORE],n=[],r=this.entries.length-1;r>=0&&n.length<e;r--)t.includes(this.entries[r].event.type)||n.unshift(this.entries[r]);return n}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function L(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var B=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");L(this,"container",void 0),L(this,"replayUrl",""),L(this,"hiScoreUrl","https://scoreboard-tailuge.vercel.app/hiscore.html"),this.container=e}return e=[{key:"lastShotLink",value:function(e,t,n,r){var i="#000000";n.length>0&&n.forEach(function(e){e.ballmesh&&(i="#"+e.ballmesh.color.getHexString())});var o="âšˆ".repeat(t>1?t-1:0)+(e?"âšˆ":"âš†"),s=JSON.stringify(r);this.generateLink(o,s,i)}},{key:"breakLink",value:function(e,t,n){if(e&&(n||e.shots.pop(),1!==e.shots.length)){e.score=t;var r=JSON.stringify(e),i=C.k.crush(r);this.generateLink("break(".concat(t,")"),i,"black"),t>=2&&this.generateHiScoreLink(i)}}},{key:"wholeGameLink",value:function(e){var t="frame(".concat(this.shotCount(e.shots)," shots)"),n=JSON.stringify(e),r=C.k.crush(n);this.generateLink(t,r,"black")}},{key:"shotCount",value:function(e){return e.filter(function(e){return"RERACK"!==e.type}).length}},{key:"generateLink",value:function(e,t,n){var r="".concat(this.replayUrl).concat(C.k.fullyEncodeURI(t)),i='<a class="pill" style="color: '.concat(n,'" target="_blank" href="').concat(r,'">').concat(e,"</a>");this.container.eventQueue.push(new O.b(null,"".concat(i)))}},{key:"generateHiScoreLink",value:function(e){var t="".concat(this.hiScoreUrl,"?ruletype=").concat(this.container.rules.rulename,"&state=").concat(C.k.fullyEncodeURI(e)),n='<a class="pill" target="_blank" href="'.concat(t,'">').concat("hi score ðŸ†","</a>");this.container.eventQueue.push(new O.b(null,"".concat(n)))}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),N=n("./src/controller/rules/rulefactory.ts");function F(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var H=function(){var e;function t(e){var n=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");F(this,"container",void 0),F(this,"share",void 0),F(this,"camera",void 0),F(this,"disabled",!0),this.container=e,this.share=this.getElement("share"),this.camera=this.getElement("camera"),this.share&&(this.share.disabled=!0),this.camera&&(this.camera.onclick=function(e){n.adjustCamera()})}return e=[{key:"adjustCamera",value:function(){this.container.view.camera.toggleMode(),this.container.lastEventTime=performance.now()}},{key:"getElement",value:function(e){return(0,k.vq)(e)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function U(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var D=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");U(this,"p1Element",void 0),U(this,"p2Element",void 0),U(this,"breakElement",void 0),this.p1Element=(0,k.id)("p1Score"),this.p2Element=(0,k.id)("p2Score"),this.breakElement=(0,k.id)("breakScore")}return e=[{key:"setText",value:function(e,t){e&&(e.textContent=t)}},{key:"updateBreak",value:function(e){this.setText(this.p1Element,""),this.setText(this.p2Element,""),e>0&&this.breakElement?this.breakElement.innerHTML="Break</br>"+e:this.setText(this.breakElement,"")}},{key:"updateScores",value:function(e,t,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;this.setText(this.p1Element,""),this.setText(this.p2Element,""),this.setText(this.breakElement,""),n&&r?(this.setText(this.p1Element,"".concat(n,": ").concat(e)),this.setText(this.p2Element,"".concat(r,": ").concat(t))):n?this.setText(this.p1Element,"".concat(n,": ").concat(e)):r?this.setText(this.p2Element,"".concat(r,": ").concat(t)):this.setText(this.p1Element,"Score: ".concat(e)),i>0&&this.setText(this.breakElement,"Break: ".concat(i))}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function z(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function G(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var V=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");G(this,"element",void 0),G(this,"timeoutId",null),this.element=(0,k.id)("notification")}return e=[{key:"getIcon",value:function(e){return e.icon?e.icon:"Foul"===e.type?"ðŸŽ±":"GameOver"===e.type?"ðŸ†":"ðŸ”µ"}},{key:"show",value:function(e){var t,n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3e3;if(this.element){var i=r;if("string"==typeof e)t=this.renderStringContent(e),n="type-Info";else{var o=this.processData(e);t=o.content,n=o.typeClass,void 0!==e.duration&&(i=e.duration)}this.display(t,n,i)}}},{key:"renderStringContent",value:function(e){return`
       <div class="notification-banner">
         <div class="notification-text-group">
           <div class="notification-subtext">`.concat(e,`</div>
         </div>
       </div>
@@ -11,11 +11,11 @@
           <div class="notification-title">`).concat(e.title,`</div>
           `).concat(e.subtext?'<div class="notification-subtext">'.concat(e.subtext,"</div>"):"",`
         </div>
       </div>
       `).concat(r,`
-    `),typeClass:t}}},{key:"renderExtra",value:function(e){return e?e.includes("<")?'<div class="notification-extra">'.concat(e,"</div>"):'<div class="notification-badge">'.concat(e,"</div>"):""}},{key:"display",value:function(e,t,n){var r,i,o=this;this.element&&(this.element.innerHTML=e,this.element.className="",(i=this.element.classList).add.apply(i,function(e){if(Array.isArray(e))return z(e)}(r=t.split(" "))||function(e){if("u">typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(r)||function(e){if(e){if("string"==typeof e)return z(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return z(e,void 0)}}(r)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),this.element.style.display="flex",this.timeoutId&&globalThis.clearTimeout(this.timeoutId),n>0&&(this.timeoutId=globalThis.setTimeout(function(){o.clear()},n)))}},{key:"clear",value:function(){this.element&&(this.element.innerHTML="",this.element.style.display="none",this.element.className=""),this.timeoutId&&(globalThis.clearTimeout(this.timeoutId),this.timeoutId=null)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),q=n("./src/events/notificationevent.ts");function K(e,t,n,r,i,o,s){try{var a=e[o](s),l=a.value}catch(e){n(e);return}a.done?t(l):Promise.resolve(l).then(r,i)}function X(e){return function(){var t=this,n=arguments;return new Promise(function(r,i){var o=e.apply(t,n);function s(e){K(o,r,i,s,a,"next",e)}function a(e){K(o,r,i,s,a,"throw",e)}s(void 0)})}}function W(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Y(e,t){var n,r,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype),a=Object.defineProperty;return a(s,"next",{value:l(0)}),a(s,"throw",{value:l(1)}),a(s,"return",{value:l(2)}),"function"==typeof Symbol&&a(s,Symbol.iterator,{value:function(){return this}}),s;function l(a){return function(l){var c=[a,l];if(n)throw TypeError("Generator is already executing.");for(;s&&(s=0,c[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&c[0]?r.return:c[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,c[1])).done)return i;switch(r=0,i&&(c=[2&c[0],i.value]),c[0]){case 0:case 1:i=c;break;case 4:return o.label++,{value:c[1],done:!1};case 5:o.label++,r=c[1],c=[0];continue;case 7:c=o.ops.pop(),o.trys.pop();continue;default:if(!(i=(i=o.trys).length>0&&i[i.length-1])&&(6===c[0]||2===c[0])){o=0;continue}if(3===c[0]&&(!i||c[1]>i[0]&&c[1]<i[3])){o.label=c[1];break}if(6===c[0]&&o.label<i[1]){o.label=i[1],i=c;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(c);break}i[2]&&o.ops.pop(),o.trys.pop();continue}c=t.call(e,o)}catch(e){c=[6,e],r=0}finally{n=i=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}}var J=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");W(this,"relay",void 0),W(this,"element",void 0),this.relay=e,this.element=(0,k.id)("lobby")}return e=[{key:"init",value:function(){return X(function(){var e,t;return Y(this,function(n){switch(n.label){case 0:if(e=this,!this.relay||!this.element)return[2];return[4,(t=function(){return X(function(){var e,t;return Y(this,function(n){switch(n.label){case 0:return[4,null==(e=this.relay)?void 0:e.getOnlineCount()];case 1:return null!==(t=n.sent())&&this.element&&(this.element.textContent=" ".concat(t," ðŸ‘¥")),[2]}})}).call(e)})()];case 1:return n.sent(),this.relay.subscribe("lobby",function(e){try{var n=JSON.parse(e);"connected"===n.action&&t()}catch(e){}},"lobby"),[2]}})}).call(this)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),Z=n("./src/events/scoreevent.ts");function Q(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var $=function(){var e;function t(e,n,r,i,o,s){var a=this,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");Q(this,"table",void 0),Q(this,"view",void 0),Q(this,"controller",void 0),Q(this,"inputQueue",[]),Q(this,"eventQueue",[]),Q(this,"keyboard",void 0),Q(this,"sound",void 0),Q(this,"chat",void 0),Q(this,"sliders",void 0),Q(this,"recorder",void 0),Q(this,"linkFormatter",void 0),Q(this,"id",""),Q(this,"isSinglePlayer",!0),Q(this,"rules",void 0),Q(this,"menu",void 0),Q(this,"hud",void 0),Q(this,"notification",void 0),Q(this,"lobbyIndicator",void 0),Q(this,"relay",null),Q(this,"scoreReporter",null),Q(this,"frame",void 0),Q(this,"scores",[0,0]),Q(this,"currentBreak",0),Q(this,"last",performance.now()),Q(this,"step",.001953125),Q(this,"broadcast",function(){}),Q(this,"log",void 0),Q(this,"sendChat",function(e){a.sendEvent(new O.b(a.id,e))}),Q(this,"throttle",new A(0,function(e){a.broadcast(e)})),Q(this,"lastEventTime",performance.now()),this.log=n,this.rules=N.V.create(i,this),this.table=this.rules.table(),this.view=new y(e,this.table,r),this.table.cue.aimInputs=new x(this),this.keyboard=o,this.sound=r.sound,this.chat=new S(this.sendChat),this.sliders=new M.r,this.linkFormatter=new B(this),this.recorder=new j(this,this.linkFormatter),this.id=s,this.menu=new H(this),this.table.addToScene(this.view.scene),this.hud=new D,this.notification=new V,this.relay=l,this.scoreReporter=c,this.lobbyIndicator=new J(this.relay),this.lobbyIndicator.init(),this.updateController(new m.J(this))}return e=[{key:"sendEvent",value:function(e){this.recorder.record(e),this.throttle.send(e)}},{key:"updateScoreHud",value:function(e,t,n){this.scores=[e,t],this.currentBreak=n;var i=void 0,o=void 0;if(r.N.hasInstance()){var s=r.N.getInstance(),a=0===r.N.playerIndex();i=(a?s.playername:s.opponentName)||void 0,o=(a?s.opponentName:s.playername)||void 0}this.hud.updateScores(e,t,i,o,n)}},{key:"sendScoreUpdate",value:function(e,t,n){var r=this.scores[0]!==e||this.scores[1]!==t||this.currentBreak!==n;this.updateScoreHud(e,t,n),r&&this.sendEvent(new Z.P(e,t,n))}},{key:"notify",value:function(e,t){this.notification.show(e,t),this.sendEvent(new q.c(e,t))}},{key:"notifyLocal",value:function(e,t){this.notification.show(e,t)}},{key:"advance",value:function(e){null==(t=this.frame)||t.call(this,e);for(var t,n=Math.floor(e/this.step),r=n*this.step,o=this.table.allStationary(),s=0;s<n;s++)this.table.advance(this.step);this.table.updateBallMesh(r),this.view.update(r,this.table.cue.aim),this.table.cue.update(r),!o&&this.table.allStationary()&&this.eventQueue.push(new i.T),this.sound.processOutcomes(this.table.outcome)}},{key:"processEvents",value:function(){var e=this;for(this.keyboard&&this.keyboard.getEvents().forEach(function(t){return e.inputQueue.push(t)});this.inputQueue.length>0;){this.lastEventTime=this.last;var t=this.inputQueue.shift();t&&this.updateController(this.controller.handleInput(t))}if(this.table.allStationary()){var n=this.eventQueue.shift();n&&(this.lastEventTime=performance.now(),this.recorder.record(n),this.updateController(n.applyToController(this.controller)))}}},{key:"animate",value:function(e){var t=this;this.advance((e-this.last)/1e3),this.last=e,this.processEvents(),(e<this.lastEventTime+12e3||!this.table.allStationary()||this.view.sizeChanged())&&this.view.render(),requestAnimationFrame(function(e){t.animate(e)})}},{key:"updateController",value:function(e){if(e!==this.controller){var t=r.N.hasInstance()?r.N.getInstance().playername:"_";this.log("".concat(t,": Transition to ").concat(e.name)),this.controller=e,this.controller.onFirst()}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/controller/aim.ts"(e,t,n){n.d(t,{m:()=>d});var r=n("./src/controller/controller.ts"),i=n("./src/controller/controllerbase.ts");function o(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){var t,r,i;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return r=n,i=[e],r=s(r),(t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(r,i||[],s(this).constructor):r.apply(this,i))).hit(),t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&a(n,e),t=[{key:"handleStationary",value:function(e){var t,n=this.container.table,r=n.outcome,i=this.container.rules.update(r),s=function(e){if(Array.isArray(e))return e}(t=this.container.rules.getScores())||function(e){var t,n,r=null==e?null:"u">typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var i=[],o=!0,s=!1;try{for(r=r.call(e);!(o=(t=r.next()).done)&&(i.push(t.value),2!==i.length);o=!0);}catch(e){s=!0,n=e}finally{try{o||null==r.return||r.return()}finally{if(s)throw n}}return i}}(t)||function(e){if(e){if("string"==typeof e)return o(e,2);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return o(e,2)}}(t)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(),a=s[0],l=s[1],c=this.container.rules.currentBreak;this.container.sendScoreUpdate(a,l,c);var u=this.container.rules.isPartOfBreak(r),h=this.container.rules.isEndOfGame(r);return this.container.recorder.updateBreak(r,u,h),n.cue.aimAtNext(n.cueball,this.container.rules.nextCandidateBall()),i}},{key:"handleInput",value:function(e){return this.commonKeyHandler(e),this}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(i.y),u=n("./src/controller/replay.ts");function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function p(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(p=function(){return!!e})()}var d=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");t=n,r=[e],t=h(t);var t,r,i,o=(i=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,p()?Reflect.construct(t,r||[],h(this).constructor):t.apply(this,r))).container.table;return o.cue.aimMode(),o.cue.showHelper(!0),o.cueball=i.container.rules.cueball,o.cue.aim.i=o.balls.indexOf(o.cueball),o.cue.moveTo(o.cueball.pos),o.cue.aimAtNext(o.cueball,i.container.rules.nextCandidateBall()),i.container.view.camera.suggestMode(i.container.view.camera.aimView),o.cue.aimInputs.showOverlap(),i}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&f(n,e),t=[{key:"onFirst",value:function(){this.container.table.cue.aimInputs.setDisabled(!1)}},{key:"handleInput",value:function(e){switch(e.key){case"Space":this.container.table.cue.adjustPower(e.t*this.scale*.7);break;case"SpaceUp":return this.playShot();default:if(!this.commonKeyHandler(e))return this}return this.container.sendEvent(this.container.table.cue.aim),this}},{key:"handleBreak",value:function(e){return new u.e(this.container,e.init,e.shots,e.retry)}},{key:"playShot",value:function(){var e=new r.Qe(this.container.table.serialise());return this.container.sendEvent(e),new c(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(i.y)},"./src/controller/controller.ts"(e,t,n){n.d(t,{Qe:()=>i.Q,pd:()=>o.p,wG:()=>r.w,xI:()=>s}),n("./src/events/beginevent.ts");var r=n("./src/events/aimevent.ts"),i=n("./src/events/hitevent.ts"),o=n("./src/events/input.ts");n("./src/events/abortevent.ts"),n("./src/events/stationaryevent.ts");var s=function(){var e;function t(e){var n,r;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");r=void 0,(n="container")in this?Object.defineProperty(this,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):this[n]=r,this.container=e}return e=[{key:"name",get:function(){return this.constructor.name}},{key:"handleInput",value:function(e){return this}},{key:"handleBegin",value:function(e){return this}},{key:"handleBreak",value:function(e){return this}},{key:"handleStartAim",value:function(e){return this}},{key:"handleAim",value:function(e){return this}},{key:"handleHit",value:function(e){return this}},{key:"handleAbort",value:function(e){return this}},{key:"handleWatch",value:function(e){return this}},{key:"handlePlaceBall",value:function(e){return this}},{key:"handleStationary",value:function(e){return this}},{key:"handleChat",value:function(e){return this}},{key:"handleRejoin",value:function(e){return this}},{key:"handleNotification",value:function(e){return this}},{key:"handleScore",value:function(e){return this}},{key:"onFirst",value:function(){}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/controller/controllerbase.ts"(e,t,n){n.d(t,{y:()=>h});var r=n("./src/controller/controller.ts"),i=n("./src/utils/gltf.ts"),o=n("./src/model/outcome.ts"),s=n("./node_modules/three/build/three.core.js");function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(e){return e&&"u">typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(u=function(){return!!e})()}var h=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t,r,i,o;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return t=n,r=arguments,t=a(t),(o="scale")in(i=e=function(e,t){if(t&&("object"===c(t)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,u()?Reflect.construct(t,r||[],a(this).constructor):t.apply(this,r)))?Object.defineProperty(i,o,{value:.001,enumerable:!0,configurable:!0,writable:!0}):i[o]=.001,e}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&l(n,e),t=[{key:"handleChat",value:function(e){var t=e.sender?"".concat(e.sender,":"):"",n="".concat(t," ").concat(e.message);return this.container.chat.showMessage(n),this}},{key:"handleNotification",value:function(e){return this.container.notification.show(e.data,e.duration),this}},{key:"handleScore",value:function(e){return this.container.updateScoreHud(e.p1,e.p2,e.b),this}},{key:"hit",value:function(){this.container.table.outcome=[o.P.hit(this.container.table.cueball,this.container.table.cue.aim.power)],this.container.table.hit(),this.container.view.camera.suggestMode(this.container.view.camera.aimView),this.container.table.cue.showHelper(!1)}},{key:"commonKeyHandler",value:function(e){var t=this.container.table.cue,n=e.t*this.scale;switch(e.key){case"ArrowLeft":return t.rotateAim(-n,this.container.table),!0;case"ArrowRight":return t.rotateAim(n,this.container.table),!0;case"ArrowDown":return t.adjustSpin(new s.Pq0(0,-n),this.container.table),!0;case"ArrowUp":return t.adjustSpin(new s.Pq0(0,n),this.container.table),!0;case"ShiftArrowLeft":return t.adjustSpin(new s.Pq0(n,0),this.container.table),!0;case"ShiftArrowRight":return t.adjustSpin(new s.Pq0(-n,0),this.container.table),!0;case"KeyPUp":return(0,i.KP)(this.container.view.scene),!0;case"KeyHUp":return t.toggleHelper(),!0;case"movementXUp":return t.rotateAim(2*n,this.container.table),!0;case"movementYUp":case"NumpadSubtract":return this.container.view.camera.adjustHeight(8*n),!0;case"NumpadAdd":return this.container.view.camera.adjustHeight(-(8*n)),!0;case"KeyOUp":return this.container.view.camera.toggleMode(),!0;case"KeyDUp":return this.togglePanel(),!0;case"KeyFUp":return this.toggleFullscreen(),!0;default:return!1}}},{key:"togglePanel",value:function(){this.container.sliders.toggleVisibility(),this.container.table.showSpin(!0),this.container.table.showTraces(!0),("u"<typeof process?"undefined":c(process))!=="object"&&console.log(this.container.table.serialise())}},{key:"toggleFullscreen",value:function(){document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen()}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.xI)},"./src/controller/end.ts"(e,t,n){n.d(t,{o:()=>c});var r=n("./src/controller/controller.ts"),i=n("./src/controller/init.ts"),o=n("./src/utils/replay-encoder.ts");function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e,t){var r,i,o,a,c;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return i=n,o=[e],i=s(i),r=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(i,o||[],s(this).constructor):i.apply(this,o)),c=void 0,(a="result")in r?Object.defineProperty(r,a,{value:c,enumerable:!0,configurable:!0,writable:!0}):r[a]=c,r.result=t,r}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&a(n,e),t=[{key:"onFirst",value:function(){if(this.result&&this.container.scoreReporter){try{var e=this.container.recorder.wholeGame(),t=JSON.stringify(e);this.result.replayData=o.k.crush(t)}catch(e){console.error("Failed to encode replay data",e)}this.container.scoreReporter.submitMatchResult(this.result)}}},{key:"handleChat",value:function(e){var t=e.sender?"".concat(e.sender,":"):"",n="".concat(t," ").concat(e.message);return this.container.chat.showMessage(n),this}},{key:"handleBegin",value:function(e){return new i.J(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.xI)},"./src/controller/init.ts"(e,t,n){n.d(t,{J:()=>k});var r=n("./src/events/watchevent.ts"),i=n("./src/controller/watchaim.ts"),o=n("./src/controller/controllerbase.ts"),s=n("./src/controller/placeball.ts"),a=n("./src/controller/replay.ts"),l=n("./src/network/client/session.ts"),c=n("./src/controller/controller.ts"),u=n("./src/events/eventutil.ts");function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function f(e){return(f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(e,t){return null!=t&&"u">typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function v(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(v=function(){return!!e})()}var y=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e,t,r){var i,o,s;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return o=n,s=[e],o=f(o),h(i=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,v()?Reflect.construct(o,s||[],f(this).constructor):o.apply(this,s)),"messageRelay",void 0),h(i,"tableId",void 0),h(i,"messages",[]),i.messageRelay=t,i.tableId=r,i.messageRelay.subscribe(i.tableId,function(e){console.log(e);var t=u.d.fromSerialised(e);i.messages.push(t),(p(t,c.Qe)||p(t,c.wG))&&i.container.eventQueue.push(t)}),console.log("Spectate"),i}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&d(n,e),t=[{key:"handleAim",value:function(e){return this.container.table.cue.aim=e,this.container.table.cueball.pos.copy(e.pos),this}},{key:"handleHit",value:function(e){return console.log("Spectate Hit"),this.container.table.updateFromSerialised(e.tablejson),this.container.table.outcome=[],this.container.table.hit(),this}},{key:"handleInput",value:function(e){return this.commonKeyHandler(e),this}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(o.y),m=n("./src/network/client/nchanmessagerelay.ts");function b(e){return(b=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function g(e,t){return(g=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function w(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(w=function(){return!!e})()}var k=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return e=n,t=arguments,e=b(e),function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,w()?Reflect.construct(e,t||[],b(this).constructor):e.apply(this,t))}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&g(n,e),t=[{key:"handleBegin",value:function(e){if(l.N.isSpectator()){var t;return new y(this.container,null!=(t=this.container.relay)?t:new m.p,l.N.getInstance().tableId)}return this.container.chat.showMessage("Start"),this.container.sendEvent(new r.Q(this.container.table.serialise())),new s.x(this.container)}},{key:"handleWatch",value:function(e){return this.container.chat.showMessage("Opponent to break"),this.container.rules.secondToPlay(),this.container.table.updateFromSerialised(e.json),l.N.hasInstance()&&(l.N.getInstance().playerIndex=1),new i.r(this.container)}},{key:"handleBreak",value:function(e){return e.init?(this.container.table.updateFromShortSerialised(e.init),this.container.chat.showMessage("Replay"),new a.e(this.container,e.init,e.shots)):new s.x(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(o.y)},"./src/controller/placeball.ts"(e,t,n){n.d(t,{x:()=>d});var r=n("./src/controller/controllerbase.ts"),i=n("./src/controller/controller.ts"),o=n("./src/controller/aim.ts"),s=n("./src/events/breakevent.ts"),a=n("./src/model/physics/constants.ts"),l=n("./node_modules/three/build/three.core.js"),c=n("./src/view/cuemesh.ts");function u(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function p(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(p=function(){return!!e})()}var d=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e,t){var r,i,o;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return i=n,o=[e],i=h(i),u(r=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,p()?Reflect.construct(i,o||[],h(this).constructor):i.apply(this,o)),"placescale",.02*a.R),u(r,"startPos",void 0),r.startPos=t,r.container.table.cue.moveTo(r.container.table.cueball.pos),r.container.table.cue.aim.power=0,r.container.view.camera.forceMode(r.container.view.camera.aimView),r}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&f(n,e),t=[{key:"onFirst",value:function(){var e=this.container.table.cueball;this.container.rules.allowsPlaceBall()&&(this.startPos?e.pos.copy(this.container.rules.placeBall(this.startPos.clone())):e.pos.copy(this.container.rules.placeBall())),e.setStationary(),e.updateMesh(0),this.container.table.cue.placeBallMode(),this.container.table.cue.showHelper(!1),this.container.table.cue.moveTo(this.container.table.cueball.pos),this.container.table.cue.aimInputs.setButtonText(`Place
+    `),typeClass:t}}},{key:"renderExtra",value:function(e){return e?e.includes("<")?'<div class="notification-extra">'.concat(e,"</div>"):'<div class="notification-badge">'.concat(e,"</div>"):""}},{key:"display",value:function(e,t,n){var r,i,o=this;this.element&&(this.element.innerHTML=e,this.element.className="",(i=this.element.classList).add.apply(i,function(e){if(Array.isArray(e))return z(e)}(r=t.split(" "))||function(e){if("u">typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(r)||function(e){if(e){if("string"==typeof e)return z(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return z(e,void 0)}}(r)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),this.element.style.display="flex",this.timeoutId&&globalThis.clearTimeout(this.timeoutId),n>0&&(this.timeoutId=globalThis.setTimeout(function(){o.clear()},n)))}},{key:"clear",value:function(){this.element&&(this.element.innerHTML="",this.element.style.display="none",this.element.className=""),this.timeoutId&&(globalThis.clearTimeout(this.timeoutId),this.timeoutId=null)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),q=n("./src/events/notificationevent.ts");function K(e,t,n,r,i,o,s){try{var a=e[o](s),l=a.value}catch(e){n(e);return}a.done?t(l):Promise.resolve(l).then(r,i)}function X(e){return function(){var t=this,n=arguments;return new Promise(function(r,i){var o=e.apply(t,n);function s(e){K(o,r,i,s,a,"next",e)}function a(e){K(o,r,i,s,a,"throw",e)}s(void 0)})}}function W(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Y(e,t){var n,r,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype),a=Object.defineProperty;return a(s,"next",{value:l(0)}),a(s,"throw",{value:l(1)}),a(s,"return",{value:l(2)}),"function"==typeof Symbol&&a(s,Symbol.iterator,{value:function(){return this}}),s;function l(a){return function(l){var c=[a,l];if(n)throw TypeError("Generator is already executing.");for(;s&&(s=0,c[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&c[0]?r.return:c[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,c[1])).done)return i;switch(r=0,i&&(c=[2&c[0],i.value]),c[0]){case 0:case 1:i=c;break;case 4:return o.label++,{value:c[1],done:!1};case 5:o.label++,r=c[1],c=[0];continue;case 7:c=o.ops.pop(),o.trys.pop();continue;default:if(!(i=(i=o.trys).length>0&&i[i.length-1])&&(6===c[0]||2===c[0])){o=0;continue}if(3===c[0]&&(!i||c[1]>i[0]&&c[1]<i[3])){o.label=c[1];break}if(6===c[0]&&o.label<i[1]){o.label=i[1],i=c;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(c);break}i[2]&&o.ops.pop(),o.trys.pop();continue}c=t.call(e,o)}catch(e){c=[6,e],r=0}finally{n=i=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}}var J=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");W(this,"relay",void 0),W(this,"element",void 0),this.relay=e,this.element=(0,k.id)("lobby")}return e=[{key:"init",value:function(){return X(function(){var e,t;return Y(this,function(n){switch(n.label){case 0:if(e=this,!this.relay||!this.element)return[2];return[4,(t=function(){return X(function(){var e,t;return Y(this,function(n){switch(n.label){case 0:return[4,null==(e=this.relay)?void 0:e.getOnlineCount()];case 1:return null!==(t=n.sent())&&this.element&&(this.element.textContent=" ".concat(t," ðŸ‘¥")),[2]}})}).call(e)})()];case 1:return n.sent(),setInterval(t,3e5),[2]}})}).call(this)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),Z=n("./src/events/scoreevent.ts");function Q(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var $=function(){var e;function t(e,n,r,i,o,s){var a=this,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");Q(this,"table",void 0),Q(this,"view",void 0),Q(this,"controller",void 0),Q(this,"inputQueue",[]),Q(this,"eventQueue",[]),Q(this,"keyboard",void 0),Q(this,"sound",void 0),Q(this,"chat",void 0),Q(this,"sliders",void 0),Q(this,"recorder",void 0),Q(this,"linkFormatter",void 0),Q(this,"id",""),Q(this,"isSinglePlayer",!0),Q(this,"rules",void 0),Q(this,"menu",void 0),Q(this,"hud",void 0),Q(this,"notification",void 0),Q(this,"lobbyIndicator",void 0),Q(this,"relay",null),Q(this,"scoreReporter",null),Q(this,"frame",void 0),Q(this,"scores",[0,0]),Q(this,"currentBreak",0),Q(this,"last",performance.now()),Q(this,"step",.001953125),Q(this,"broadcast",function(){}),Q(this,"log",void 0),Q(this,"sendChat",function(e){a.sendEvent(new O.b(a.id,e))}),Q(this,"throttle",new A(0,function(e){a.broadcast(e)})),Q(this,"lastEventTime",performance.now()),this.log=n,this.rules=N.V.create(i,this),this.table=this.rules.table(),this.view=new y(e,this.table,r),this.table.cue.aimInputs=new x(this),this.keyboard=o,this.sound=r.sound,this.chat=new S(this.sendChat),this.sliders=new M.r,this.linkFormatter=new B(this),this.recorder=new j(this,this.linkFormatter),this.id=s,this.menu=new H(this),this.table.addToScene(this.view.scene),this.hud=new D,this.notification=new V,this.relay=l,this.scoreReporter=c,this.lobbyIndicator=new J(this.relay),this.lobbyIndicator.init(),this.updateController(new m.J(this))}return e=[{key:"sendEvent",value:function(e){this.recorder.record(e),this.throttle.send(e)}},{key:"updateScoreHud",value:function(e,t,n){this.scores=[e,t],this.currentBreak=n;var i=void 0,o=void 0;if(r.N.hasInstance()){var s=r.N.getInstance(),a=0===r.N.playerIndex();i=(a?s.playername:s.opponentName)||void 0,o=(a?s.opponentName:s.playername)||void 0}this.hud.updateScores(e,t,i,o,n)}},{key:"sendScoreUpdate",value:function(e,t,n){var r=this.scores[0]!==e||this.scores[1]!==t||this.currentBreak!==n;this.updateScoreHud(e,t,n),r&&this.sendEvent(new Z.P(e,t,n))}},{key:"notify",value:function(e,t){this.notification.show(e,t),this.sendEvent(new q.c(e,t))}},{key:"notifyLocal",value:function(e,t){this.notification.show(e,t)}},{key:"advance",value:function(e){null==(t=this.frame)||t.call(this,e);for(var t,n=Math.floor(e/this.step),r=n*this.step,o=this.table.allStationary(),s=0;s<n;s++)this.table.advance(this.step);this.table.updateBallMesh(r),this.view.update(r,this.table.cue.aim),this.table.cue.update(r),!o&&this.table.allStationary()&&this.eventQueue.push(new i.T),this.sound.processOutcomes(this.table.outcome)}},{key:"processEvents",value:function(){var e=this;for(this.keyboard&&this.keyboard.getEvents().forEach(function(t){return e.inputQueue.push(t)});this.inputQueue.length>0;){this.lastEventTime=this.last;var t=this.inputQueue.shift();t&&this.updateController(this.controller.handleInput(t))}if(this.table.allStationary()){var n=this.eventQueue.shift();n&&(this.lastEventTime=performance.now(),this.recorder.record(n),this.updateController(n.applyToController(this.controller)))}}},{key:"animate",value:function(e){var t=this;this.advance((e-this.last)/1e3),this.last=e,this.processEvents(),(e<this.lastEventTime+12e3||!this.table.allStationary()||this.view.sizeChanged())&&this.view.render(),requestAnimationFrame(function(e){t.animate(e)})}},{key:"updateController",value:function(e){if(e!==this.controller){var t=r.N.hasInstance()?r.N.getInstance().playername:"_";this.log("".concat(t,": Transition to ").concat(e.name)),this.controller=e,this.controller.onFirst()}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/controller/aim.ts"(e,t,n){n.d(t,{m:()=>d});var r=n("./src/controller/controller.ts"),i=n("./src/controller/controllerbase.ts");function o(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){var t,r,i;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return r=n,i=[e],r=s(r),(t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(r,i||[],s(this).constructor):r.apply(this,i))).hit(),t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&a(n,e),t=[{key:"handleStationary",value:function(e){var t,n=this.container.table,r=n.outcome,i=this.container.rules.update(r),s=function(e){if(Array.isArray(e))return e}(t=this.container.rules.getScores())||function(e){var t,n,r=null==e?null:"u">typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var i=[],o=!0,s=!1;try{for(r=r.call(e);!(o=(t=r.next()).done)&&(i.push(t.value),2!==i.length);o=!0);}catch(e){s=!0,n=e}finally{try{o||null==r.return||r.return()}finally{if(s)throw n}}return i}}(t)||function(e){if(e){if("string"==typeof e)return o(e,2);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return o(e,2)}}(t)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(),a=s[0],l=s[1],c=this.container.rules.currentBreak;this.container.sendScoreUpdate(a,l,c);var u=this.container.rules.isPartOfBreak(r),h=this.container.rules.isEndOfGame(r);return this.container.recorder.updateBreak(r,u,h),n.cue.aimAtNext(n.cueball,this.container.rules.nextCandidateBall()),i}},{key:"handleInput",value:function(e){return this.commonKeyHandler(e),this}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(i.y),u=n("./src/controller/replay.ts");function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function p(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(p=function(){return!!e})()}var d=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");t=n,r=[e],t=h(t);var t,r,i,o=(i=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,p()?Reflect.construct(t,r||[],h(this).constructor):t.apply(this,r))).container.table;return o.cue.aimMode(),o.cue.showHelper(!0),o.cueball=i.container.rules.cueball,o.cue.aim.i=o.balls.indexOf(o.cueball),o.cue.moveTo(o.cueball.pos),o.cue.aimAtNext(o.cueball,i.container.rules.nextCandidateBall()),i.container.view.camera.suggestMode(i.container.view.camera.aimView),o.cue.aimInputs.showOverlap(),i}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&f(n,e),t=[{key:"onFirst",value:function(){this.container.table.cue.aimInputs.setDisabled(!1)}},{key:"handleInput",value:function(e){switch(e.key){case"Space":this.container.table.cue.adjustPower(e.t*this.scale*.7);break;case"SpaceUp":return this.playShot();default:if(!this.commonKeyHandler(e))return this}return this.container.sendEvent(this.container.table.cue.aim),this}},{key:"handleBreak",value:function(e){return new u.e(this.container,e.init,e.shots,e.retry)}},{key:"playShot",value:function(){var e=new r.Qe(this.container.table.serialise());return this.container.sendEvent(e),new c(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(i.y)},"./src/controller/controller.ts"(e,t,n){n.d(t,{Qe:()=>i.Q,pd:()=>o.p,wG:()=>r.w,xI:()=>s}),n("./src/events/beginevent.ts");var r=n("./src/events/aimevent.ts"),i=n("./src/events/hitevent.ts"),o=n("./src/events/input.ts");n("./src/events/abortevent.ts"),n("./src/events/stationaryevent.ts");var s=function(){var e;function t(e){var n,r;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");r=void 0,(n="container")in this?Object.defineProperty(this,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):this[n]=r,this.container=e}return e=[{key:"name",get:function(){return this.constructor.name}},{key:"handleInput",value:function(e){return this}},{key:"handleBegin",value:function(e){return this}},{key:"handleBreak",value:function(e){return this}},{key:"handleStartAim",value:function(e){return this}},{key:"handleAim",value:function(e){return this}},{key:"handleHit",value:function(e){return this}},{key:"handleAbort",value:function(e){return this}},{key:"handleWatch",value:function(e){return this}},{key:"handlePlaceBall",value:function(e){return this}},{key:"handleStationary",value:function(e){return this}},{key:"handleChat",value:function(e){return this}},{key:"handleRejoin",value:function(e){return this}},{key:"handleNotification",value:function(e){return this}},{key:"handleScore",value:function(e){return this}},{key:"onFirst",value:function(){}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/controller/controllerbase.ts"(e,t,n){n.d(t,{y:()=>h});var r=n("./src/controller/controller.ts"),i=n("./src/utils/gltf.ts"),o=n("./src/model/outcome.ts"),s=n("./node_modules/three/build/three.core.js");function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(e){return e&&"u">typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(u=function(){return!!e})()}var h=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t,r,i,o;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return t=n,r=arguments,t=a(t),(o="scale")in(i=e=function(e,t){if(t&&("object"===c(t)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,u()?Reflect.construct(t,r||[],a(this).constructor):t.apply(this,r)))?Object.defineProperty(i,o,{value:.001,enumerable:!0,configurable:!0,writable:!0}):i[o]=.001,e}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&l(n,e),t=[{key:"handleChat",value:function(e){var t=e.sender?"".concat(e.sender,":"):"",n="".concat(t," ").concat(e.message);return this.container.chat.showMessage(n),this}},{key:"handleNotification",value:function(e){return this.container.notification.show(e.data,e.duration),this}},{key:"handleScore",value:function(e){return this.container.updateScoreHud(e.p1,e.p2,e.b),this}},{key:"hit",value:function(){this.container.table.outcome=[o.P.hit(this.container.table.cueball,this.container.table.cue.aim.power)],this.container.table.hit(),this.container.view.camera.suggestMode(this.container.view.camera.aimView),this.container.table.cue.showHelper(!1)}},{key:"commonKeyHandler",value:function(e){var t=this.container.table.cue,n=e.t*this.scale;switch(e.key){case"ArrowLeft":return t.rotateAim(-n,this.container.table),!0;case"ArrowRight":return t.rotateAim(n,this.container.table),!0;case"ArrowDown":return t.adjustSpin(new s.Pq0(0,-n),this.container.table),!0;case"ArrowUp":return t.adjustSpin(new s.Pq0(0,n),this.container.table),!0;case"ShiftArrowLeft":return t.adjustSpin(new s.Pq0(n,0),this.container.table),!0;case"ShiftArrowRight":return t.adjustSpin(new s.Pq0(-n,0),this.container.table),!0;case"KeyPUp":return(0,i.KP)(this.container.view.scene),!0;case"KeyHUp":return t.toggleHelper(),!0;case"movementXUp":return t.rotateAim(2*n,this.container.table),!0;case"movementYUp":case"NumpadSubtract":return this.container.view.camera.adjustHeight(8*n),!0;case"NumpadAdd":return this.container.view.camera.adjustHeight(-(8*n)),!0;case"KeyOUp":return this.container.view.camera.toggleMode(),!0;case"KeyDUp":return this.togglePanel(),!0;case"KeyFUp":return this.toggleFullscreen(),!0;default:return!1}}},{key:"togglePanel",value:function(){this.container.sliders.toggleVisibility(),this.container.table.showSpin(!0),this.container.table.showTraces(!0),("u"<typeof process?"undefined":c(process))!=="object"&&console.log(this.container.table.serialise())}},{key:"toggleFullscreen",value:function(){document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen()}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.xI)},"./src/controller/end.ts"(e,t,n){n.d(t,{o:()=>c});var r=n("./src/controller/controller.ts"),i=n("./src/controller/init.ts"),o=n("./src/utils/replay-encoder.ts");function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e,t){var r,i,o,a,c;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return i=n,o=[e],i=s(i),r=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(i,o||[],s(this).constructor):i.apply(this,o)),c=void 0,(a="result")in r?Object.defineProperty(r,a,{value:c,enumerable:!0,configurable:!0,writable:!0}):r[a]=c,r.result=t,r}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&a(n,e),t=[{key:"onFirst",value:function(){if(this.result&&this.container.scoreReporter){try{var e=this.container.recorder.wholeGame(),t=JSON.stringify(e);this.result.replayData=o.k.crush(t)}catch(e){console.error("Failed to encode replay data",e)}this.container.scoreReporter.submitMatchResult(this.result)}}},{key:"handleChat",value:function(e){var t=e.sender?"".concat(e.sender,":"):"",n="".concat(t," ").concat(e.message);return this.container.chat.showMessage(n),this}},{key:"handleBegin",value:function(e){return new i.J(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.xI)},"./src/controller/init.ts"(e,t,n){n.d(t,{J:()=>k});var r=n("./src/events/watchevent.ts"),i=n("./src/controller/watchaim.ts"),o=n("./src/controller/controllerbase.ts"),s=n("./src/controller/placeball.ts"),a=n("./src/controller/replay.ts"),l=n("./src/network/client/session.ts"),c=n("./src/controller/controller.ts"),u=n("./src/events/eventutil.ts");function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function f(e){return(f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(e,t){return null!=t&&"u">typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function v(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(v=function(){return!!e})()}var y=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e,t,r){var i,o,s;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return o=n,s=[e],o=f(o),h(i=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,v()?Reflect.construct(o,s||[],f(this).constructor):o.apply(this,s)),"messageRelay",void 0),h(i,"tableId",void 0),h(i,"messages",[]),i.messageRelay=t,i.tableId=r,i.messageRelay.subscribe(i.tableId,function(e){console.log(e);var t=u.d.fromSerialised(e);i.messages.push(t),(p(t,c.Qe)||p(t,c.wG))&&i.container.eventQueue.push(t)}),console.log("Spectate"),i}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&d(n,e),t=[{key:"handleAim",value:function(e){return this.container.table.cue.aim=e,this.container.table.cueball.pos.copy(e.pos),this}},{key:"handleHit",value:function(e){return console.log("Spectate Hit"),this.container.table.updateFromSerialised(e.tablejson),this.container.table.outcome=[],this.container.table.hit(),this}},{key:"handleInput",value:function(e){return this.commonKeyHandler(e),this}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(o.y),m=n("./src/network/client/nchanmessagerelay.ts");function b(e){return(b=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function g(e,t){return(g=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function w(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(w=function(){return!!e})()}var k=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return e=n,t=arguments,e=b(e),function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,w()?Reflect.construct(e,t||[],b(this).constructor):e.apply(this,t))}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&g(n,e),t=[{key:"handleBegin",value:function(e){if(l.N.isSpectator()){var t;return new y(this.container,null!=(t=this.container.relay)?t:new m.p,l.N.getInstance().tableId)}return this.container.chat.showMessage("Start"),this.container.sendEvent(new r.Q(this.container.table.serialise())),new s.x(this.container)}},{key:"handleWatch",value:function(e){return this.container.chat.showMessage("Opponent to break"),this.container.rules.secondToPlay(),this.container.table.updateFromSerialised(e.json),l.N.hasInstance()&&(l.N.getInstance().playerIndex=1),new i.r(this.container)}},{key:"handleBreak",value:function(e){return e.init?(this.container.table.updateFromShortSerialised(e.init),this.container.chat.showMessage("Replay"),new a.e(this.container,e.init,e.shots)):new s.x(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(o.y)},"./src/controller/placeball.ts"(e,t,n){n.d(t,{x:()=>d});var r=n("./src/controller/controllerbase.ts"),i=n("./src/controller/controller.ts"),o=n("./src/controller/aim.ts"),s=n("./src/events/breakevent.ts"),a=n("./src/model/physics/constants.ts"),l=n("./node_modules/three/build/three.core.js"),c=n("./src/view/cuemesh.ts");function u(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function p(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(p=function(){return!!e})()}var d=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e,t){var r,i,o;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return i=n,o=[e],i=h(i),u(r=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,p()?Reflect.construct(i,o||[],h(this).constructor):i.apply(this,o)),"placescale",.02*a.R),u(r,"startPos",void 0),r.startPos=t,r.container.table.cue.moveTo(r.container.table.cueball.pos),r.container.table.cue.aim.power=0,r.container.view.camera.forceMode(r.container.view.camera.aimView),r}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&f(n,e),t=[{key:"onFirst",value:function(){var e=this.container.table.cueball;this.container.rules.allowsPlaceBall()&&(this.startPos?e.pos.copy(this.container.rules.placeBall(this.startPos.clone())):e.pos.copy(this.container.rules.placeBall())),e.setStationary(),e.updateMesh(0),this.container.table.cue.placeBallMode(),this.container.table.cue.showHelper(!1),this.container.table.cue.moveTo(this.container.table.cueball.pos),this.container.table.cue.aimInputs.setButtonText(`Place
 Ball`),this.container.table.cue.aimInputs.setDisabled(!1),this.container.rules.allowsPlaceBall()||this.container.inputQueue.push(new i.pd(1,"SpaceUp"))}},{key:"handleInput",value:function(e){var t=this.container.table.cueball.pos;switch(e.key){case"ArrowLeft":case"KeyI":this.moveTo(0,e.t*this.placescale);break;case"ArrowRight":case"KeyK":this.moveTo(0,-e.t*this.placescale);break;case"movementXUp":this.moveTo(0,-e.t*this.placescale*2);break;case"movementYUp":this.moveTo(-e.t*this.placescale*2,0);break;case"KeyJ":this.moveTo(-e.t*this.placescale,0);break;case"KeyL":this.moveTo(e.t*this.placescale,0);break;case"SpaceUp":return this.placed();default:this.commonKeyHandler(e)}return this.container.table.cue.moveTo(t),this.container.view.camera.forceMove(this.container.table.cue.aim),this.container.sendEvent(this.container.table.cue.aim),this}},{key:"moveTo",value:function(e,t){var n=new l.Pq0(e,t),r=this.container.table.cueball.pos.add(n);r.copy(this.container.rules.placeBall(r)),c.l.indicateValid(!this.container.table.overlapsAny(r))}},{key:"placed",value:function(){return this.container.table.overlapsAny(this.container.table.cueball.pos)?this:(this.container.table.cue.aimInputs.setButtonText("Hit"),this.container.sound.playNotify(),this.container.sendEvent(new s.W(this.container.table.shortSerialise())),new o.m(this.container))}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.y)},"./src/controller/replay.ts"(e,t,n){n.d(t,{e:()=>k});var r=n("./src/events/hitevent.ts"),i=n("./src/controller/controllerbase.ts"),o=n("./src/events/aimevent.ts"),s=n("./src/events/breakevent.ts"),a=n("./src/controller/aim.ts"),l=n("./src/events/eventtype.ts"),c=n("./src/events/rerackevent.ts"),u=n("./src/events/placeballevent.ts"),h=n("./src/controller/end.ts"),f=n("./src/events/scoreevent.ts"),p=n("./src/events/chatevent.ts"),d=n("./src/utils/gameover.ts");function v(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function m(e){return(m=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function b(e,t){return(b=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function g(e){return function(e){if(Array.isArray(e))return v(e)}(e)||function(e){if("u">typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e){if(e){if("string"==typeof e)return v(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return v(e,void 0)}}(e)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function w(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(w=function(){return!!e})()}var k=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e,t,r){var i,o,a,l=arguments.length>3&&void 0!==arguments[3]&&arguments[3],c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1500;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");if(i=n,o=[e],i=m(i),y(a=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,w()?Reflect.construct(i,o||[],m(this).constructor):i.apply(this,o)),"delay",void 0),y(a,"shots",void 0),y(a,"firstShot",void 0),y(a,"timer",void 0),y(a,"init",void 0),a.init=t,a.shots=g(r),a.firstShot=a.shots[0],a.delay=c,a.container.table.showTraces(!0),a.container.table.updateFromShortSerialised(a.init),console.log(a.shots),l){var u=new s.W(t,r);u.retry=!0,a.container.eventQueue.push(u)}else a.container.view.camera.forceMode(a.container.view.camera.topView),a.playNextShot(1.5*a.delay);return a}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&b(n,e),t=[{key:"onFirst",value:function(){var e=this;this.container.table.cue.aimInputs.setDisabled(!0);var t=this.container.menu.share;t&&(t.disabled=!1,t.onclick=function(){!function(e,t){var n;if(("u"<typeof process?"undefined":(n=process)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)=="object")return t(e);fetch("https://scoreboard-tailuge.vercel.app/api/shorten",{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({input:new URL(e.replaceAll("(","%28").replaceAll(")","%29").replaceAll("!","%21").replaceAll("*","%2A")).search})}).then(function(e){return e.json()}).then(function(n){"shortUrl"in n?t(n.shortUrl):(console.log("Could not shorten url:"),console.log(n),t(e))})}(window.location.href,function(t){var n,r,i,o,s=(o={title:"Billiards",text:"Replay break",url:t},(null==(n=(r=navigator).canShare)?void 0:n.call(r,o))?(navigator.share(o).then(function(){return console.log("shared successfully")}).catch(function(e){console.log("Error: "+e)}),"link shared"):(null==(i=navigator.clipboard)||i.writeText(t),'link copied to clipboard <a href="'.concat(t,'">').concat(t,"</a>")));e.container.eventQueue.push(new p.b(null,s))})})}},{key:"playNextShot",value:function(e){var t=this,n=this.shots.shift();if((null==n?void 0:n.type)===l.B.RERACK){var i=c.x.fromJson(n.ballinfo);c.x.applyBallinfoToTable(this.container.table,i.ballinfo),this.shots.length>0&&this.playNextShot(e);return}if((null==n?void 0:n.type)===l.B.PLACEBALL){var s=u.z.fromJson(n);if(this.container.table.cueball.pos.copy(s.pos),this.container.table.cueball.setStationary(),s.respot){var a=this.container.table.balls[s.respot.id];a&&(a.pos.copy(s.respot.pos),a.setStationary())}this.shots.length>0&&this.playNextShot(e);return}if((null==n?void 0:n.type)===l.B.SCORE){f.P.fromJson(n).applyToController(this),this.shots.length>0&&this.playNextShot(e);return}var h=o.w.fromJson(n);this.container.table.cueball=this.container.table.balls[h.i],console.log(this.container.table.cueball.pos.distanceTo(h.pos)),this.container.table.cueball.pos.copy(h.pos),this.container.table.cue.aim=h,this.container.table.cue.updateAimInput(),this.container.table.cue.t=1,clearTimeout(this.timer),this.timer=setTimeout(function(){t.container.eventQueue.push(new r.Q(t.container.table.cue.aim)),t.timer=void 0},e)}},{key:"handleHit",value:function(e){return this.hit(),this}},{key:"handleStationary",value:function(e){return(this.shots.length>0&&void 0===this.timer&&this.playNextShot(this.delay),0===this.shots.length&&void 0===this.timer)?(this.container.notifyLocal({type:"GameOver",title:"Replay Complete",extra:d.c.replay+d.c.lobby},0),new h.o(this.container)):this}},{key:"handleInput",value:function(e){return this.commonKeyHandler(e),this}},{key:"handleBreak",value:function(e){return(this.container.table.updateFromShortSerialised(e.init),this.shots=g(e.shots),this.container.table.showSpin(!0),e.retry)?this.retry():(this.playNextShot(this.delay),this)}},{key:"handleAbort",value:function(e){return console.log("Replay aborted"),clearTimeout(this.timer),this.timer=void 0,new h.o(this.container)}},{key:"retry",value:function(){clearTimeout(this.timer),this.timer=void 0,this.container.table.updateFromShortSerialised(this.init);var e=o.w.fromJson(this.firstShot);return this.container.table.cueball=this.container.table.balls[e.i],this.container.rules.cueball=this.container.table.cueball,this.container.table.cueball.pos.copy(e.pos),this.container.table.cue.aim=e,this.container.view.camera.forceMode(this.container.view.camera.aimView),new a.m(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(i.y)},"./src/controller/rules/rulefactory.ts"(e,t,n){n.d(t,{V:()=>L});var r=n("./src/events/rerackevent.ts"),i=n("./src/model/outcome.ts"),o=n("./src/utils/rack.ts"),s=n("./node_modules/three/build/three.core.js"),a=n("./src/controller/aim.ts"),l=n("./src/controller/placeball.ts"),c=n("./src/controller/watchaim.ts"),u=n("./src/events/placeballevent.ts"),h=n("./src/events/watchevent.ts"),f=n("./src/model/table.ts"),p=n("./src/model/physics/constants.ts"),d=n("./src/utils/respot.ts"),v=n("./src/view/tablegeometry.ts"),y=n("./src/events/startaimevent.ts"),m=n("./src/network/client/matchresult.ts"),b=n("./src/network/client/session.ts");function g(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function w(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function k(e){return function(e){if(Array.isArray(e))return g(e)}(e)||function(e){if("u">typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e){if(e){if("string"==typeof e)return g(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return g(e,void 0)}}(e)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var T=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");w(this,"container",void 0),w(this,"cueball",void 0),w(this,"currentBreak",0),w(this,"previousBreak",0),w(this,"rulename","nineball"),this.container=e}return e=[{key:"getScores",value:function(){return this.container.scores}},{key:"startTurn",value:function(){this.previousBreak=this.currentBreak,this.currentBreak=0}},{key:"nextCandidateBall",value:function(){var e=this;return this.container.table.balls.filter(function(t){return t!==e.cueball&&t.onTable()}).sort(function(e,t){return(e.label||0)-(t.label||0)})[0]}},{key:"placeBall",value:function(e){if(e){var t=new s.Pq0(v.P.tableX,v.P.tableY),n=new s.Pq0(-v.P.tableX,-v.P.tableY);return e.clamp(n,t)}return new s.Pq0(-(11*p.R)/.5,0,0)}},{key:"asset",value:function(){return"models/p8.min.gltf"}},{key:"tableGeometry",value:function(){v.P.hasPockets=!0}},{key:"table",value:function(){var e=new f.X(this.rack());return this.cueball=e.cueball,e}},{key:"rack",value:function(){return o.m.diamond()}},{key:"update",value:function(e){var t=this.foulReason(e);return t?this.handleFoul(e,t):i.P.potCount(e)>0?this.handlePot(e):this.handleMiss()}},{key:"handleFoul",value:function(e,t){this.container.notify({type:"Foul",title:"FOUL",subtext:t,extra:"Ball in hand"}),this.startTurn();var n=i.P.pots(e).includes(this.container.table.balls[9]),o=this.container.table.cueball;if(n){this.respotNineBall();var s=this.container.table.balls[9];if(s){var a=r.x.fromJson({balls:[s.serialise()]});console.log("Respot nine ball sending rerack event",a),this.container.sendEvent(a)}}var h=o.onTable()?o.pos.clone():this.placeBall(),f=new u.z(h,void 0,!0);return(this.container.sendEvent(f),this.container.isSinglePlayer)?new l.x(this.container,h):new c.r(this.container)}},{key:"handlePot",value:function(e){var t=this.container.table,n=i.P.potCount(e);return(this.currentBreak+=n,this.container.scores[b.N.playerIndex()]+=n,this.container.sound.playSuccess(t.inPockets()),this.isEndOfGame(e))?this.handleGameEnd(!0):(this.container.sendEvent(new h.Q(t.serialise())),new a.m(this.container))}},{key:"handleGameEnd",value:function(e){return m.n.presentGameEnd(this.container,this.rulename)}},{key:"handleMiss",value:function(){var e=this.container.table;return(this.container.sendEvent(new y.M),this.container.isSinglePlayer)?(this.container.sendEvent(new h.Q(e.serialise())),this.startTurn(),new a.m(this.container)):new c.r(this.container)}},{key:"isPartOfBreak",value:function(e){return i.P.isBallPottedNoFoul(this.container.table.cueball,e)}},{key:"isEndOfGame",value:function(e){return!this.isFoul(e)&&i.P.pots(e).includes(this.container.table.balls[9])}},{key:"otherPlayersCueBall",value:function(){return this.cueball}},{key:"secondToPlay",value:function(){}},{key:"allowsPlaceBall",value:function(){return!0}},{key:"isFoul",value:function(e){return null!==this.foulReason(e)}},{key:"foulReason",value:function(e){var t=this.container.table.cueball;if(i.P.isCueBallPotted(t,e))return"Cue ball potted";var n=this.getLowestBallAtStartOfShot(e),r=i.P.firstCollision(i.P.cueBallFirst(t,e));if(!r)return"No ball hit";if(r.ballB!==n)return"Wrong ball hit first";if(0===i.P.potCount(e)){var o=e.indexOf(r);if(!e.slice(o+1).some(function(e){return e.type===i.$.Cushion}))return"No cushion after contact"}return null}},{key:"getLowestBallAtStartOfShot",value:function(e){var t=this,n=i.P.pots(e),r=this.container.table.balls.filter(function(e){return e!==t.cueball&&e.onTable()});return k(n).concat(k(r)).sort(function(e,t){return(e.label||0)-(t.label||0)})[0]}},{key:"respotNineBall",value:function(){d.k.nineBall(this.container.table)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function x(e,t,n){return(x="u">typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=P(e)););return e}(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(n||e):i.value}})(e,t,n||e)}function P(e){return(P=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function S(e,t){return(S=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function O(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(O=function(){return!!e})()}var R=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){var t,r,i;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return r=n,i=[e],r=P(r),(t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,O()?Reflect.construct(r,i||[],P(this).constructor):r.apply(this,i))).rulename="fourteenone",t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&S(n,e),t=[{key:"asset",value:function(){return"models/p8.min.gltf"}},{key:"rack",value:function(){return o.m.triangle()}},{key:"update",value:function(e){var t=this.container.table;return this.checkRerack(t),x(P(n.prototype),"update",this).call(this,e)}},{key:"isFoul",value:function(e){return i.P.isCueBallPotted(this.container.table.cueball,e)}},{key:"checkRerack",value:function(e){var t=e.balls.filter(function(e){return e.onTable()}).filter(function(t){return t!==e.cueball});if(1===t.length){o.m.rerack(t[0],e),this.container.sound.playSuccess(e.inPockets());var n=e.serialise(),i=r.x.fromJson(n);this.container.sendEvent(i),this.container.recorder.wholeGameLink()}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(T),E=n("./src/controller/rules/snooker.ts"),A=n("./src/view/cameratop.ts"),M=n("./src/utils/utils.ts"),_=n("./src/utils/threecushionconfig.ts");function C(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function I(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var j=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");I(this,"container",void 0),I(this,"cueball",void 0),I(this,"currentBreak",0),I(this,"previousBreak",0),I(this,"rulename","threecushion"),this.container=e}return e=[{key:"getScores",value:function(){return this.container.scores}},{key:"startTurn",value:function(){}},{key:"nextCandidateBall",value:function(){if(!(0,M.hs)(this.container.recorder))return d.k.closest(this.container.table.cueball,this.container.table.balls)}},{key:"placeBall",value:function(e){return M.v_}},{key:"asset",value:function(){return"models/threecushion.min.gltf"}},{key:"secondToPlay",value:function(){this.cueball=this.container.table.balls[1]}},{key:"tableGeometry",value:function(){v.P.tableX=49*p.R,v.P.tableY=24*p.R,v.P.X=v.P.tableX+p.R,v.P.Y=v.P.tableY+p.R,v.P.hasPockets=!1}},{key:"table",value:function(){this.tableGeometry(),A.v.zoomFactor=.92;var e=new f.X(this.rack());return this.cueball=e.cueball,e}},{key:"rack",value:function(){return o.m.three()}},{key:"update",value:function(e){return i.P.isThreeCushionPoint(this.cueball,e)?(this.container.sound.playSuccess(e.length/3),this.container.sendEvent(new h.Q(this.container.table.serialise())),this.currentBreak++,this.container.scores[b.N.playerIndex()]++,this.isEndOfGame(e))?this.handleGameEnd(!0):new a.m(this.container):(this.previousBreak=this.currentBreak,this.currentBreak=0,this.container.isSinglePlayer)?(this.cueball=this.otherPlayersCueBall(),this.container.table.cue.aim.i=this.container.table.balls.indexOf(this.cueball),new a.m(this.container)):(this.container.sendEvent(new y.M),new c.r(this.container))}},{key:"otherPlayersCueBall",value:function(){var e=this.container.table.balls;return this.cueball===e[0]?e[1]:e[0]}},{key:"isPartOfBreak",value:function(e){return i.P.isThreeCushionPoint(this.cueball,e)}},{key:"isEndOfGame",value:function(e){var t,n=function(e){if(Array.isArray(e))return e}(t=this.container.scores)||function(e){var t,n,r=null==e?null:"u">typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var i=[],o=!0,s=!1;try{for(r=r.call(e);!(o=(t=r.next()).done)&&(i.push(t.value),2!==i.length);o=!0);}catch(e){s=!0,n=e}finally{try{o||null==r.return||r.return()}finally{if(s)throw n}}return i}}(t)||function(e){if(e){if("string"==typeof e)return C(e,2);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return C(e,2)}}(t)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(),r=n[0],i=n[1];return r>=_.Y.raceTo||i>=_.Y.raceTo}},{key:"handleGameEnd",value:function(e){return m.n.presentGameEnd(this.container,this.rulename)}},{key:"allowsPlaceBall",value:function(){return!1}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),L=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"create",value:function(e,t){switch(e){case"threecushion":return new j(t);case"fourteenone":return new R(t);case"snooker":return new E.c(t);default:return new T(t)}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/controller/rules/snooker.ts"(e,t,n){n.d(t,{c:()=>x});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/events/watchevent.ts"),o=n("./src/model/outcome.ts"),s=n("./src/utils/rack.ts"),a=n("./src/utils/respot.ts"),l=n("./src/controller/aim.ts"),c=n("./src/controller/watchaim.ts"),u=n("./src/model/table.ts"),h=n("./src/view/tablegeometry.ts"),f=n("./src/controller/placeball.ts"),p=n("./src/events/placeballevent.ts"),d=n("./src/utils/utils.ts");function v(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}var y=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"shotInfo",value:function(e,n,r,i){var s=o.P.firstCollision(n);return{pots:o.P.potCount(n),firstCollision:s,legalFirstCollision:t.isLegalFirstCollision(e,r,i,s),whitePotted:o.P.isCueBallPotted(e.cueball,n),targetIsRed:r}}},{key:"isLegalFirstCollision",value:function(e,n,r,i){if(!i)return!1;var o=i.ballB.id;if(n)return o>=7;if(r)return o>=1&&o<=6;var s=t.coloursOnTable(e).sort(function(e,t){return e.id-t.id});return 0!==s.length&&o===s[0].id}},{key:"calculateFoul",value:function(e,n){return{points:t.foulPoints(e,n),reason:t.foulReason(e,n)}}},{key:"foulPoints",value:function(e,t){var n,r,i,s,a=o.P.pots(e).map(function(e){return e.id}).filter(function(e){return e<7}),l=null!=(r=null==(s=t.firstCollision)||null==(i=s.ballB)?void 0:i.id)?r:0;return l>6&&(l=0),(n=Math).max.apply(n,[3,l].concat(function(e){if(Array.isArray(e))return v(e)}(a)||function(e){if("u">typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(a)||function(e){if(e){if("string"==typeof e)return v(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);if("Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t)return Array.from(t);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return v(e,void 0)}}(a)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()))+1}},{key:"foulReason",value:function(e,n){if(n.whitePotted)return"White potted";if(!n.firstCollision)return"No ball hit";var r=null!=(l=null==(c=n.firstCollision.ballB)?void 0:c.id)?l:0;if(n.targetIsRed){if(r<7||0===r){var i=t.colourName(r);return"Hit ".concat(i," instead of red")}}else if(r>=7)return"Hit red instead of colour";var s=o.P.pots(e).filter(function(e){return e.id>0&&e.id<7});if(s.length>1){var a=s.map(function(e){return t.colourName(e.id)}).join(", ");return"Potted ".concat(a)}if(1===s.length){var l,c,u,h,f,p=s[0].id,d=null!=(u=null==(f=n.firstCollision)||null==(h=f.ballB)?void 0:h.id)?u:0;if(p!==d){var v=t.colourName(p),y=t.colourName(d);return"Potted ".concat(v," instead of ").concat(y)}}return null}},{key:"respotAllPottedColours",value:function(e,t){return o.P.pots(t).filter(function(e){return e.id<7}).filter(function(e){return 0!==e.id}).map(function(t){return a.k.respot(t,e)})}},{key:"redsOnTable",value:function(e){return e.balls.slice(7).filter(function(e){return e.onTable()})}},{key:"coloursOnTable",value:function(e){return e.balls.slice(1,7).filter(function(e){return e.onTable()})}},{key:"colourName",value:function(e){return({1:"Yellow",2:"Green",3:"Brown",4:"Blue",5:"Pink",6:"Black"})[e]||"Ball ".concat(e)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}(),m=n("./src/network/client/matchresult.ts"),b=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"presentGameEnd",value:function(e,t){return m.n.presentGameEnd(e,t)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}(),g=n("./src/events/startaimevent.ts"),w=n("./src/network/client/session.ts"),k=n("./src/events/rerackevent.ts");function T(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var x=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");T(this,"cueball",void 0),T(this,"previousPotRed",!1),T(this,"targetIsRed",!0),T(this,"currentBreak",0),T(this,"previousBreak",0),T(this,"foulPoints",0),T(this,"rulename","snooker"),T(this,"container",void 0),this.container=e}return e=[{key:"snookerrule",value:function(e){this.foulPoints=0;var t=y.shotInfo(this.container.table,e,this.targetIsRed,this.previousPotRed);return 0===t.pots?(this.targetIsRed=y.redsOnTable(this.container.table).length>0,t.legalFirstCollision)?this.switchPlayer():this.foul(e,t):this.targetIsRed?this.targetRedRule(e,t):this.targetColourRule(e,t)}},{key:"targetRedRule",value:function(e,t){return t.legalFirstCollision&&o.P.onlyRedsPotted(e)?(this.currentBreak+=t.pots,this.container.scores[w.N.playerIndex()]+=t.pots,this.targetIsRed=!1,this.previousPotRed=!0,this.continueBreak()):this.foul(e,t)}},{key:"targetColourRule",value:function(e,t){if(t.whitePotted)return this.foul(e,t);if(t.pots>1)return this.respot(e),this.foul(e,t);if(o.P.pots(e)[0].id>6)return this.foul(e,t);var n=o.P.pots(e)[0].id;return n!==t.firstCollision.ballB.id?this.foul(e,t):this.previousPotRed?(this.respot(e),this.currentBreak+=n+1,this.container.scores[w.N.playerIndex()]+=n+1,this.previousPotRed=!1,this.targetIsRed=y.redsOnTable(this.container.table).length>0,this.continueBreak()):y.coloursOnTable(this.container.table).filter(function(e){return e.id<n}).length>0?this.foul(e,t):(this.currentBreak+=n+1,this.container.scores[w.N.playerIndex()]+=n+1,this.previousPotRed=!1,this.targetIsRed=y.redsOnTable(this.container.table).length>0,this.continueBreak())}},{key:"foul",value:function(e,t){var n=y.calculateFoul(e,t);this.foulPoints=n.points;var r=w.N.playerIndex();this.container.scores[1-r]+=this.foulPoints;var i=t.whitePotted?{type:"Foul",title:"FOUL",subtext:n.reason||"Foul (".concat(this.foulPoints," points)"),extra:"Ball in hand"}:{type:"Foul",title:"FOUL",subtext:n.reason||"Foul (".concat(this.foulPoints," points)")};return(this.container.notify(i),this.respot(e),t.whitePotted)?this.whiteInHand():this.switchPlayer()}},{key:"tableGeometry",value:function(){h.P.hasPockets=!0}},{key:"table",value:function(){var e=new u.X(this.rack());return this.cueball=e.cueball,e}},{key:"otherPlayersCueBall",value:function(){return this.cueball}},{key:"secondToPlay",value:function(){}},{key:"isPartOfBreak",value:function(e){return this.currentBreak>0}},{key:"isEndOfGame",value:function(e){return o.P.isClearTable(this.container.table)&&this.currentBreak>0}},{key:"allowsPlaceBall",value:function(){return!0}},{key:"asset",value:function(){return t.tablemodel}},{key:"startTurn",value:function(){this.previousPotRed=!1,this.targetIsRed=y.redsOnTable(this.container.table).length>0,this.previousBreak=this.currentBreak,this.currentBreak=0}},{key:"getScores",value:function(){return this.container.scores}},{key:"rack",value:function(){return s.m.snooker()}},{key:"nextCandidateBall",value:function(){if((0,d.hs)(this.container.recorder))return void console.log("first shot");var e=this.container.table,t=y.redsOnTable(e),n=y.coloursOnTable(e);return this.previousPotRed?a.k.closest(e.cueball,n):t.length>0?a.k.closest(e.cueball,t):n.length>0?n[0]:void 0}},{key:"placeBall",value:function(e){if(e){var t=new r.Pq0(s.m.baulk,0,0),n=s.m.sixth,i=e.distanceTo(t);if(e.x>=s.m.baulk&&(e.x=s.m.baulk),!(i>n))return e;var o=e.clone().sub(t).normalize();return t.add(o.multiplyScalar(n))}return new r.Pq0(s.m.baulk,-s.m.sixth/2.6,0)}},{key:"switchPlayer",value:function(){var e=this.container.table;return(this.container.sendEvent(new g.M(this.foulPoints)),this.container.isSinglePlayer)?(this.container.sendEvent(new i.Q(e.serialise())),this.startTurn(),new l.m(this.container)):(this.startTurn(),new c.r(this.container))}},{key:"continueBreak",value:function(){var e=this.container.table;return(this.container.sound.playSuccess(e.inPockets()),o.P.isClearTable(e))?this.handleGameEnd(!0):(this.container.sendEvent(new i.Q(e.serialise())),new l.m(this.container))}},{key:"handleGameEnd",value:function(e){return b.presentGameEnd(this.container,this.rulename)}},{key:"whiteInHand",value:function(){return(this.startTurn(),this.container.isSinglePlayer)?new f.x(this.container):(this.container.sendEvent(new p.z(d.v_)),new c.r(this.container))}},{key:"update",value:function(e){return this.snookerrule(e)}},{key:"respot",value:function(e){var t=y.respotAllPottedColours(this.container.table,e);if(t.length>0){var n=k.x.fromJson({balls:t.map(function(e){return e.serialise()})});this.container.sendEvent(n)}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();T(x,"tablemodel","models/d-snooker.min.gltf")},"./src/controller/watchaim.ts"(e,t,n){n.d(t,{r:()=>d});var r=n("./src/controller/aim.ts"),i=n("./src/controller/controllerbase.ts"),o=n("./src/controller/placeball.ts"),s=n("./src/events/rerackevent.ts");function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(c=function(){return!!e})()}var u=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){var t,r,i;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return r=n,i=[e],r=a(r),(t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,c()?Reflect.construct(r,i||[],a(this).constructor):r.apply(this,i))).container.table.outcome=[],t.container.table.hit(),t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&l(n,e),t=[{key:"onFirst",value:function(){this.container.table.cue.aimInputs.setDisabled(!0)}},{key:"handleStationary",value:function(e){var t=this.container.table.outcome;return this.container.rules.isEndOfGame(t)?this.container.rules.handleGameEnd(!1):this}},{key:"handleStartAim",value:function(e){return this.container.rules.startTurn(),new r.m(this.container)}},{key:"handlePlaceBall",value:function(e){if(e.respot){var t=this.container.table.balls.find(function(t){return t.id===e.respot.id});t&&(t.pos.copy(e.respot.pos),t.setStationary())}return e.useStartPos?(this.container.rules.startTurn(),new o.x(this.container,e.pos.clone())):(this.container.rules.startTurn(),new o.x(this.container))}},{key:"handleWatch",value:function(e){return"rerack"in e.json?(console.log("Respot"),s.x.applyBallinfoToTable(this.container.table,e.json),this):new d(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(i.y);function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function p(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(p=function(){return!!e})()}var d=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){var t,r,i;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return r=n,i=[e],r=h(r),(t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,p()?Reflect.construct(r,i||[],h(this).constructor):r.apply(this,i))).container.table.cueball=t.container.rules.otherPlayersCueBall(),t.container.table.cue.moveTo(t.container.table.cueball.pos),t.container.view.camera.suggestMode(t.container.view.camera.topView),t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&f(n,e),t=[{key:"onFirst",value:function(){this.container.table.cue.aimInputs.setDisabled(!0)}},{key:"handleAim",value:function(e){return this.container.table.cue.aim=e,this.container.table.cueball.pos.copy(e.pos),this}},{key:"handleHit",value:function(e){return this.container.table.updateFromSerialised(e.tablejson),new u(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(i.y)},"./src/events/abortevent.ts"(e,t,n){n.d(t,{h:()=>l});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function a(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(a=function(){return!!e})()}var l=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return t=o(t=n),(e=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,a()?Reflect.construct(t,[],o(this).constructor):t.apply(this,void 0))).type=i.B.ABORT,e}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&s(n,e),t=[{key:"applyToController",value:function(e){return e.handleAbort(this)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.F)},"./src/events/aimevent.ts"(e,t,n){n.d(t,{w:()=>f});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts"),o=n("./src/utils/utils.ts"),s=n("./node_modules/three/build/three.core.js");function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function u(e,t){return(u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function h(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(h=function(){return!!e})()}var f=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(){var e,t;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return t=c(t=r),l(e=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,h()?Reflect.construct(t,[],c(this).constructor):t.apply(this,void 0)),"offset",new s.Pq0(0,0,0)),l(e,"angle",0),l(e,"power",0),l(e,"pos",new s.Pq0(0,0,0)),l(e,"i",0),e.type=i.B.AIM,e}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&u(r,e),t=[{key:"applyToController",value:function(e){return e.handleAim(this)}},{key:"copy",value:function(){return r.fromJson(this)}}],n=[{key:"fromJson",value:function(e){var t=new r;return t.pos=(0,o.t6)(e.pos),t.angle=e.angle,t.offset=(0,o.t6)(e.offset),t.power=e.power,e.i&&(t.i=e.i),t}}],t&&a(r.prototype,t),n&&a(r,n),r}(r.F)},"./src/events/beginevent.ts"(e,t,n){n.d(t,{u:()=>l});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function a(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(a=function(){return!!e})()}var l=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return t=o(t=n),(e=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,a()?Reflect.construct(t,[],o(this).constructor):t.apply(this,void 0))).type=i.B.BEGIN,e}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&s(n,e),t=[{key:"applyToController",value:function(e){return e.handleBegin(this)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.F)},"./src/events/breakevent.ts"(e,t,n){n.d(t,{W:()=>u});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(c=function(){return!!e})()}var u=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(e,t){var n,o;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return o=a(o=r),s(n=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,c()?Reflect.construct(o,[],a(this).constructor):o.apply(this,void 0)),"init",void 0),s(n,"shots",void 0),s(n,"retry",void 0),n.init=e,n.shots=t,n.type=i.B.BREAK,n}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&l(r,e),t=[{key:"applyToController",value:function(e){return e.handleBreak(this)}}],n=[{key:"fromJson",value:function(e){return new r(e.init,e.shots)}}],t&&o(r.prototype,t),n&&o(r,n),r}(r.F)},"./src/events/chatevent.ts"(e,t,n){n.d(t,{b:()=>u});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(c=function(){return!!e})()}var u=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(e,t){var n,o;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return o=a(o=r),s(n=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,c()?Reflect.construct(o,[],a(this).constructor):o.apply(this,void 0)),"sender",void 0),s(n,"message",void 0),n.sender=e,n.message=t,n.type=i.B.CHAT,n}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&l(r,e),t=[{key:"applyToController",value:function(e){return e.handleChat(this)}}],n=[{key:"fromJson",value:function(e){return new r(e.sender,e.message)}}],t&&o(r.prototype,t),n&&o(r,n),r}(r.F)},"./src/events/eventtype.ts"(e,t,n){n.d(t,{B:()=>i});var r,i=((r={}).BEGIN="BEGIN",r.BREAK="BREAK",r.WATCHAIM="WATCHAIM",r.AIM="AIM",r.HIT="HIT",r.STATIONARY="STATIONARY",r.CHAT="CHAT",r.ABORT="ABORT",r.PLACEBALL="PLACEBALL",r.REJOIN="REJOIN",r.RERACK="RERACK",r.STARTAIM="STARTAIM",r.NOTIFICATION="NOTIFICATION",r.SCORE="SCORE",r)},"./src/events/eventutil.ts"(e,t,n){n.d(t,{d:()=>T});var r=n("./src/events/eventtype.ts"),i=n("./src/events/aimevent.ts"),o=n("./src/events/watchevent.ts"),s=n("./src/events/hitevent.ts"),a=n("./src/events/abortevent.ts"),l=n("./src/events/breakevent.ts"),c=n("./src/events/beginevent.ts"),u=n("./src/events/chatevent.ts");function h(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function p(e){return(p=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function v(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(v=function(){return!!e})()}var y=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function i(){var e,t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(!(this instanceof i))throw TypeError("Cannot call a class as a function");return e=p(e=i),f(t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,v()?Reflect.construct(e,[],p(this).constructor):e.apply(this,void 0)),"clientResendFrom",void 0),f(t,"serverResendFrom",void 0),t.type=r.B.REJOIN,t.clientResendFrom=n,t.serverResendFrom=o,t}return i.prototype=Object.create(e&&e.prototype,{constructor:{value:i,writable:!0,configurable:!0}}),e&&d(i,e),t=[{key:"applyToController",value:function(e){return e.handleRejoin(this)}}],n=[{key:"fromJson",value:function(e){return new i(e.clientResendFrom,e.serverResendFrom)}}],t&&h(i.prototype,t),n&&h(i,n),i}(n("./src/events/gameevent.ts").F),m=n("./src/events/placeballevent.ts"),b=n("./src/events/rerackevent.ts"),g=n("./src/events/startaimevent.ts"),w=n("./src/events/notificationevent.ts"),k=n("./src/events/scoreevent.ts"),T=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"serialise",value:function(e){return JSON.stringify(e)}},{key:"fromJson",value:function(e){switch(e.type){case r.B.BEGIN:return new c.u;case r.B.AIM:return i.w.fromJson(e);case r.B.BREAK:return l.W.fromJson(e);case r.B.WATCHAIM:return o.Q.fromJson(e.json);case r.B.HIT:return s.Q.fromJson(e);case r.B.CHAT:return u.b.fromJson(e);case r.B.REJOIN:return y.fromJson(e);case r.B.ABORT:return new a.h;case r.B.PLACEBALL:return m.z.fromJson(e);case r.B.RERACK:return b.x.fromJson(e);case r.B.STARTAIM:return g.M.fromJson(e);case r.B.NOTIFICATION:return w.c.fromJson(e);case r.B.SCORE:return k.P.fromJson(e);default:throw Error("Unknown GameEvent :"+e)}}},{key:"fromSerialised",value:function(e){var n=JSON.parse(e),r=t.fromJson(n);return"sequence"in n&&(r.sequence=n.sequence),"clientId"in n&&(r.clientId=n.clientId),"playername"in n&&(r.playername=n.playername),r}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/events/gameevent.ts"(e,t,n){function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,{F:()=>i});var i=function e(){if(!(this instanceof e))throw TypeError("Cannot call a class as a function");r(this,"type",void 0),r(this,"sequence",void 0),r(this,"clientId",void 0),r(this,"playername",void 0)}},"./src/events/hitevent.ts"(e,t,n){n.d(t,{Q:()=>c});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(e){var t,n,o,a;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return n=s(n=r),t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(n,[],s(this).constructor):n.apply(this,void 0)),a=void 0,(o="tablejson")in t?Object.defineProperty(t,o,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[o]=a,t.type=i.B.HIT,t.tablejson=e,t}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&a(r,e),t=[{key:"applyToController",value:function(e){return e.handleHit(this)}}],n=[{key:"fromJson",value:function(e){return new r(e.tablejson)}}],t&&o(r.prototype,t),n&&o(r,n),r}(r.F)},"./src/events/input.ts"(e,t,n){function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,{p:()=>i});var i=function e(t,n){if(!(this instanceof e))throw TypeError("Cannot call a class as a function");r(this,"t",void 0),r(this,"key",void 0),this.t=t,this.key=n}},"./src/events/keyboard.ts"(e,t,n){n.d(t,{s:()=>a});var r=n("./src/events/input.ts"),i=n("./node_modules/interactjs/dist/interact.min.js"),o=n.n(i);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e;function t(e){var n=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");s(this,"pressed",{}),s(this,"released",{}),s(this,"keydown",function(e){null==n.pressed[e.code]&&(n.pressed[e.code]=performance.now()),e.stopImmediatePropagation(),"F12"!==e.key&&e.preventDefault()}),s(this,"keyup",function(e){n.released[e.code]=performance.now()-n.pressed[e.code],delete n.pressed[e.code],e.stopImmediatePropagation(),"F12"!==e.key&&e.preventDefault()}),s(this,"mousetouch",function(e){var t,r,i=n.released,o=e.client.y<e.rect.height/2||e.ctrlKey?.5:1,s=e.dx*o,a=.8*e.dy;i.movementY=(null!=(t=i.movementY)?t:0)+a,i.movementX=(null!=(r=i.movementX)?r:0)+s,Math.abs(i.movementX)>Math.abs(i.movementY)&&(i.movementY=0)}),this.addHandlers(e),/Android|iPhone/i.test(navigator.userAgent)||(e.contentEditable="true")}return e=[{key:"getEvents",value:function(){var e=this,t=Object.keys(this.pressed).filter(function(e){return!/Shift/.test(e)}).filter(function(e){return!/Control/.test(e)}),n=Object.keys(this.pressed).some(function(e){return/Shift/.test(e)}),i=Object.keys(this.pressed).some(function(e){return/Control/.test(e)}),o=[];return t.forEach(function(t){var s=performance.now()-e.pressed[t];o.push(new r.p(i?s/3:s,n?"Shift"+t:t)),"Space"!=t&&(e.pressed[t]=performance.now())}),Object.keys(this.released).forEach(function(t){return o.push(new r.p(e.released[t],t+"Up"))}),this.released={},o}},{key:"addHandlers",value:function(e){var t=this;e.addEventListener("keydown",this.keydown),e.addEventListener("keyup",this.keyup),e.focus(),o()(e).draggable({listeners:{move:function(e){t.mousetouch(e)}}}),o()(e).gesturable({onmove:function(e){e.dx/=3,t.mousetouch(e)}})}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/events/notificationevent.ts"(e,t,n){n.d(t,{c:()=>u});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(c=function(){return!!e})()}var u=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(e,t){var n,o;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return o=a(o=r),s(n=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,c()?Reflect.construct(o,[],a(this).constructor):o.apply(this,void 0)),"data",void 0),s(n,"duration",void 0),n.data=e,n.duration=t,n.type=i.B.NOTIFICATION,n}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&l(r,e),t=[{key:"applyToController",value:function(e){return e.handleNotification(this)}}],n=[{key:"fromJson",value:function(e){return new r(e.data,e.duration)}}],t&&o(r.prototype,t),n&&o(r,n),r}(r.F)},"./src/events/placeballevent.ts"(e,t,n){n.d(t,{z:()=>h});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts"),o=n("./src/utils/utils.ts");function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(u=function(){return!!e})()}var h=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(e,t,n){var o,s;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return s=l(s=r),a(o=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,u()?Reflect.construct(s,[],l(this).constructor):s.apply(this,void 0)),"pos",void 0),a(o,"respot",void 0),a(o,"useStartPos",void 0),o.pos=e,o.respot=t,o.useStartPos=n,o.type=i.B.PLACEBALL,o}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&c(r,e),t=[{key:"applyToController",value:function(e){return e.handlePlaceBall(this)}}],n=[{key:"fromJson",value:function(e){var t,n=e.respot?{id:e.respot.id,pos:(0,o.t6)(e.respot.pos)}:void 0;return new r((0,o.t6)(e.pos),n,null!=(t=e.useStartPos)&&t)}}],t&&s(r.prototype,t),n&&s(r,n),r}(r.F)},"./src/events/rerackevent.ts"(e,t,n){n.d(t,{x:()=>c});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(){var e,t,n,o;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return t=s(t=r),e=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(t,[],s(this).constructor):t.apply(this,void 0)),o=void 0,(n="ballinfo")in e?Object.defineProperty(e,n,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[n]=o,e.type=i.B.RERACK,e}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&a(r,e),t=[{key:"applyToController",value:function(e){return r.applyBallinfoToTable(e.container.table,this.ballinfo),e}}],n=[{key:"fromJson",value:function(e){var t,n=new r;return n.ballinfo=null!=(t=e.ballinfo)?t:e,n}},{key:"applyBallinfoToTable",value:function(e,t){e.updateFromSerialised(t),(null==t?void 0:t.balls)&&t.balls.forEach(function(t){var n=e.balls[t.id];n&&(n.pos.copy(t.pos),n.setStationary())})}}],t&&o(r.prototype,t),n&&o(r,n),r}(r.F)},"./src/events/scoreevent.ts"(e,t,n){n.d(t,{P:()=>c});var r=n("./src/events/eventtype.ts");function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function c(e,t,n){var i,a;if(!(this instanceof c))throw TypeError("Cannot call a class as a function");return a=s(a=c),o(i=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(a,[],s(this).constructor):a.apply(this,void 0)),"p1",void 0),o(i,"p2",void 0),o(i,"b",void 0),i.p1=e,i.p2=t,i.b=n,i.type=r.B.SCORE,i}return c.prototype=Object.create(e&&e.prototype,{constructor:{value:c,writable:!0,configurable:!0}}),e&&a(c,e),t=[{key:"applyToController",value:function(e){return e.handleScore(this)}}],n=[{key:"fromJson",value:function(e){return new c(e.p1,e.p2,e.b)}}],t&&i(c.prototype,t),n&&i(c,n),c}(n("./src/events/gameevent.ts").F)},"./src/events/startaimevent.ts"(e,t,n){n.d(t,{M:()=>c});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(){var e,t,n,o,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return e=s(e=r),(n="foul")in(t=o=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(e,[],s(this).constructor):e.apply(this,void 0)))?Object.defineProperty(t,n,{value:0,enumerable:!0,configurable:!0,writable:!0}):t[n]=0,o.type=i.B.STARTAIM,o.foul=a,o}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&a(r,e),t=[{key:"applyToController",value:function(e){return e.handleStartAim(this)}}],n=[{key:"fromJson",value:function(e){return new r(e.foul)}}],t&&o(r.prototype,t),n&&o(r,n),r}(r.F)},"./src/events/stationaryevent.ts"(e,t,n){n.d(t,{T:()=>l});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function a(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(a=function(){return!!e})()}var l=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return t=o(t=n),(e=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,a()?Reflect.construct(t,[],o(this).constructor):t.apply(this,void 0))).type=i.B.STATIONARY,e}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&s(n,e),t=[{key:"applyToController",value:function(e){return e.handleStationary(this)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.F)},"./src/events/watchevent.ts"(e,t,n){n.d(t,{Q:()=>c});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(e){var t,n,o,a;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return n=s(n=r),t=function(e,t){var n;if(t&&("object"==((n=t)&&"u">typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(n,[],s(this).constructor):n.apply(this,void 0)),a=void 0,(o="json")in t?Object.defineProperty(t,o,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[o]=a,t.type=i.B.WATCHAIM,t.json=e,t}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&a(r,e),t=[{key:"applyToController",value:function(e){return e.handleWatch(this)}}],n=[{key:"fromJson",value:function(e){return new r(e)}}],t&&o(r.prototype,t),n&&o(r,n),r}(r.F)},"./src/index.ts"(e,t,n){var r=n("./src/container/container.ts"),i=n("./src/events/keyboard.ts"),o=n("./src/events/eventutil.ts"),s=n("./src/events/breakevent.ts"),a=n("./src/model/physics/physics.ts"),l=n("./node_modules/jsoncrush/JSONCrush.js"),c=n("./src/view/assets.ts"),u=n("./src/utils/snookerconfig.ts"),h=n("./src/utils/threecushionconfig.ts"),f=n("./src/network/client/session.ts"),p=n("./src/network/client/nchanmessagerelay.ts");function d(e,t,n,r,i,o,s){try{var a=e[o](s),l=a.value}catch(e){n(e);return}a.done?t(l):Promise.resolve(l).then(r,i)}function v(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var y=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");v(this,"baseURL",void 0),v(this,"defaultBaseURL","scoreboard-tailuge.vercel.app"),this.baseURL=e||this.defaultBaseURL}return e=[{key:"submitMatchResult",value:function(e){var t;return(t=function(){var t,n,r;return function(e,t){var n,r,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype),a=Object.defineProperty;return a(s,"next",{value:l(0)}),a(s,"throw",{value:l(1)}),a(s,"return",{value:l(2)}),"function"==typeof Symbol&&a(s,Symbol.iterator,{value:function(){return this}}),s;function l(a){return function(l){var c=[a,l];if(n)throw TypeError("Generator is already executing.");for(;s&&(s=0,c[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&c[0]?r.return:c[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,c[1])).done)return i;switch(r=0,i&&(c=[2&c[0],i.value]),c[0]){case 0:case 1:i=c;break;case 4:return o.label++,{value:c[1],done:!1};case 5:o.label++,r=c[1],c=[0];continue;case 7:c=o.ops.pop(),o.trys.pop();continue;default:if(!(i=(i=o.trys).length>0&&i[i.length-1])&&(6===c[0]||2===c[0])){o=0;continue}if(3===c[0]&&(!i||c[1]>i[0]&&c[1]<i[3])){o.label=c[1];break}if(6===c[0]&&o.label<i[1]){o.label=i[1],i=c;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(c);break}i[2]&&o.ops.pop(),o.trys.pop();continue}c=t.call(e,o)}catch(e){c=[6,e],r=0}finally{n=i=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}}(this,function(i){switch(i.label){case 0:t="https://".concat(this.baseURL,"/api/match-results"),console.log("Submitting match result payload:",JSON.stringify(e,null,2)),i.label=1;case 1:return i.trys.push([1,6,,7]),[4,fetch(t,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})];case 2:if(!(n=i.sent()).ok)return[3,3];return console.log("Match result submitted successfully:",e),[3,5];case 3:return[4,n.text()];case 4:r=i.sent(),console.error("Failed to submit match result:",n.status,n.statusText,r),i.label=5;case 5:return[3,7];case 6:return console.error("Error submitting match result:",i.sent()),[3,7];case 7:return[2]}})},function(){var e=this,n=arguments;return new Promise(function(r,i){var o=t.apply(e,n);function s(e){d(o,r,i,s,a,"next",e)}function a(e){d(o,r,i,s,a,"throw",e)}s(void 0)})}).call(this)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),m=n("./src/events/beginevent.ts"),b=n("./src/events/eventtype.ts");function g(e,t,n){t.type!==b.B.AIM&&console.log("".concat(e," ").concat(n," ").concat(t.type," : ").concat(t.clientId))}function w(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var k=function(){var e;function t(e,n){var r,i,o,s,a,l,c;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");w(this,"container",void 0),w(this,"canvas3d",void 0),w(this,"tableId",void 0),w(this,"clientId",void 0),w(this,"wss",void 0),w(this,"ruletype",void 0),w(this,"playername",void 0),w(this,"replay",void 0),w(this,"messageRelay",null),w(this,"breakState",{init:null,shots:[],now:0,score:0}),w(this,"cushionModel",void 0),w(this,"spectator",void 0),w(this,"first",void 0),w(this,"assets",void 0),w(this,"now",void 0),this.now=Date.now(),this.playername=null!=(r=null!=(i=n.get("name"))?i:n.get("playername"))?r:"Anon",this.tableId=null!=(o=n.get("tableId"))?o:"default",this.clientId=null!=(s=n.get("clientId"))?s:"default",this.replay=n.get("state"),this.ruletype=null!=(a=n.get("ruletype"))?a:"nineball",this.wss=n.get("websocketserver"),this.canvas3d=e,this.cushionModel=this.cushion(n.get("cushionModel")),this.spectator=n.has("spectator"),this.first=n.has("first"),u.U.reds=parseInt(null!=(l=n.get("reds"))?l:"15")||15,h.Y.raceTo=parseInt(null!=(c=n.get("raceTo"))?c:"2")||2,console.log("clientId: ".concat(this.clientId," playername: ").concat(this.playername," tableId: ").concat(this.tableId," spectator: ").concat(this.spectator)),f.N.init(this.clientId,this.playername,this.tableId,this.spectator)}return e=[{key:"cushion",value:function(e){switch(e){case"bounceHan":return a.QV;case"bounceHanBlend":return a.$8;default:return a.Qy}}},{key:"start",value:function(){var e=this;this.assets=new c.s(this.ruletype),this.assets.loadFromWeb(function(){e.onAssetsReady()})}},{key:"onAssetsReady",value:function(){var e=this;console.log("".concat(this.playername," assets ready")),this.messageRelay=new p.p;var t=new y;if(this.container=new r.m(this.canvas3d,console.log,this.assets,this.ruletype,new i.s(this.canvas3d),this.playername,this.messageRelay,t),this.container.broadcast=function(t){e.broadcast(t)},this.container.table.cushionModel=this.cushionModel,this.setReplayLink(),this.spectator){this.container.eventQueue.push(new m.u),this.container.animate(performance.now());return}this.wss&&(this.container.isSinglePlayer=!1,this.messageRelay.subscribe(this.tableId,function(t){e.netEvent(t)}),this.first||this.spectator||this.broadcast(new m.u)),this.replay?this.startReplay(this.replay):this.container.isSinglePlayer&&this.container.eventQueue.push(new s.W),this.container.animate(performance.now())}},{key:"netEvent",value:function(e){var t=o.d.fromSerialised(e);g(this.playername,t,"receive"),t.clientId!==f.N.getInstance().clientId?(t.playername&&(f.N.getInstance().opponentName=t.playername),this.container.eventQueue.push(t)):console.log("Ignoring own event")}},{key:"broadcast",value:function(e){this.wss&&this.messageRelay&&(e.clientId=f.N.getInstance().clientId,e.playername=f.N.getInstance().playername,g(this.playername,e,"broadcast"),this.messageRelay.publish(this.tableId,o.d.serialise(e)))}},{key:"setReplayLink",value:function(){var e=window.location.href.split("?")[0],t="".concat(e,"?ruletype=").concat(this.ruletype,"&state=");this.container.linkFormatter.replayUrl=t}},{key:"startReplay",value:function(e){if(this.breakState=this.parse(e),this.breakState.players){var t=f.N.getInstance();t.playername=this.breakState.players.player1,t.opponentName=this.breakState.players.player2}var n=new s.W(this.breakState.init,this.breakState.shots);this.container.eventQueue.push(n)}},{key:"parse",value:function(e){try{return JSON.parse(e)}catch(t){return JSON.parse(l.A.uncrush(e))}}},{key:"offerUpload",value:function(){this.container.chat.showMessage('<a class="pill" target="_blank" href="https://scoreboard-tailuge.vercel.app/hiscore.html'.concat(location.search,'"> upload high score ðŸ†</a'))}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),T=n("./src/utils/dom.ts");new k((0,T.dX)("viewP1"),new URLSearchParams(location.search)).start(),"localhost"===globalThis.location.hostname||"127.0.0.1"===globalThis.location.hostname?console.log("Skipping usage fetch for localhost."):fetch("https://scoreboard-tailuge.vercel.app/api/usage/game",{method:"PUT",mode:"cors"}).then(function(e){e.ok||console.error("HTTP error:",e.status,e.statusText)}).catch(function(e){console.error("Fetch error:",e)})},"./src/model/ball.ts"(e,t,n){n.d(t,{c:()=>T,U:()=>k});var r,i,o,s,a,l=n("./src/utils/utils.ts"),c=n("./src/model/physics/physics.ts"),u=n("./node_modules/three/build/three.core.js"),h=n("./src/model/physics/constants.ts");function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var p=function(){var e;function t(e,n){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");f(this,"line",void 0),f(this,"geometry",void 0),f(this,"positions",void 0),f(this,"lastPos",new u.Pq0),f(this,"lastVel",new u.Pq0),this.geometry=new u.LoY,this.positions=new Float32Array(3*e),this.geometry.setAttribute("position",new u.THS(this.positions,3)),this.reset();var r=new u.mrM({color:n,opacity:.25,linewidth:3,transparent:!0});this.line=new u.N1A(this.geometry,r),this.line.visible=!1}return e=[{key:"reset",value:function(){this.geometry.setDrawRange(0,0),this.lastVel.setZ(1)}},{key:"forceTrace",value:function(e){this.lastVel.z=1,this.addTraceGiven(e,this.lastVel,1,.1,1)}},{key:"addTrace",value:function(e,t){if(0!==t.length()){var n=this.lastVel.angleTo(t),r=n>Math.PI/32?.01*h.R:h.R,i=this.lastPos.distanceTo(e);this.addTraceGiven(e,t,i,r,n)}}},{key:"addTraceGiven",value:function(e,t,n,r,i){var o=this.geometry.drawRange.count;0!==o&&n<r||(o>1&&i<1e-4&&o--,this.lastPos.copy(e),this.lastVel.copy(t),this.addPoint(e,o))}},{key:"addPoint",value:function(e,t){var n=3*t;n>this.positions.length||(this.positions[n++]=e.x,this.positions[n++]=e.y,this.positions[n]=e.z,this.geometry.setDrawRange(0,t+1),this.line.geometry.attributes.position.needsUpdate=!0)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),d=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"getOrCreateTexture",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:256,r="".concat(e,"_").concat(t.getHex(),"_").concat(n);if(this.textureCache.has(r))return this.textureCache.get(r);var i=this.createNumberTexture(e,t,n);return this.textureCache.set(r,i),i}},{key:"createNumberTexture",value:function(e,t,n){var r=n/256,i=document.createElement("canvas");i.width=n,i.height=n;var o=i.getContext("2d");if(!o)return new u.GOR(i);if(o.fillStyle="#".concat(t.getHexString()),o.fillRect(0,0,i.width,i.height),e>=9&&(o.fillStyle="white",o.fillRect(0,0,n,.2*n),o.fillRect(0,.8*n,n,.2*n)),e>0){var s=n/2,a=n/2,l=Math.round(52*r),c=Math.round(15*r);o.beginPath(),o.arc(s,a,l+c,0,2*Math.PI),o.fillStyle="black",o.fill(),o.beginPath(),o.arc(s,a,l,0,2*Math.PI),o.fillStyle="white",o.fill(),o.fillStyle="black",o.strokeStyle="black";var h=Math.round(97*r);o.lineWidth=.05*h,o.font="900 ".concat(h,'px "Arial Black", Arial, sans-serif'),o.textAlign="center",o.textBaseline="middle";var f=a+Math.round(5*r);o.strokeText(e.toString(),s,f),o.fillText(e.toString(),s,f)}var p=new u.GOR(i);return p.flipY=!1,p}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();r="textureCache",i=new Map,r in d?Object.defineProperty(d,r,{value:i,enumerable:!0,configurable:!0,writable:!0}):d[r]=i;var v=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"createDottedMaterial",value:function(e){var t="dotted_".concat(e.getHex());if(this.materialCache.has(t))return this.materialCache.get(t);var n=new u.tXL({emissive:0,flatShading:!0,vertexColors:!0,forceSinglePass:!0,shininess:25,specular:5592371});return this.materialCache.set(t,n),n}},{key:"createProjectedMaterial",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:256,r="projected_".concat(e,"_").concat(t.getHex(),"_").concat(n);if(this.materialCache.has(r))return this.materialCache.get(r);var i=d.getOrCreateTexture(e,t,n),o=new u._4j({color:t,roughness:.5,metalness:0,flatShading:!0});return o.onBeforeCompile=function(e){e.uniforms.numberTex={value:i},e.uniforms.projSize={value:2},e.vertexShader=e.vertexShader.replace("#include <common>",`#include <common>
          varying vec3 vLocalPosition;
          varying vec3 vNormalVar;`),e.vertexShader=e.vertexShader.replace("#include <begin_vertex>",`#include <begin_vertex>
          vLocalPosition = position;
          vNormalVar = normal;`),e.fragmentShader=e.fragmentShader.replace("#include <common>",`#include <common>
@@ -31,11 +31,11 @@ Ball`),this.container.table.cue.aimInputs.setDisabled(!1),this.container.rules.a
          projUv = clamp(projUv, 0.0, 1.0);

          // sample & blend
          vec4 texColor = texture2D(numberTex, projUv);
          diffuseColor.rgb = texColor.rgb;
-        `))},this.materialCache.set(r,o),o}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();function y(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}o="materialCache",s=new Map,o in v?Object.defineProperty(v,o,{value:s,enumerable:!0,configurable:!0,writable:!0}):v[o]=s;var b=function(){var e,t;function n(e,t){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");m(this,"mesh",void 0),m(this,"shadow",void 0),m(this,"spinAxisArrow",void 0),m(this,"trace",void 0),m(this,"color",void 0),m(this,"m",new u.kn4),this.color=new u.Q1f(e),this.initialiseMesh(this.color,t)}return e=[{key:"updateAll",value:function(e,t){this.updatePosition(e.pos),this.updateArrows(e.pos,e.rvel,e.state),0!==e.rvel.lengthSq()&&(this.updateRotation(e.rvel,t),this.trace.addTrace(e.pos,e.vel))}},{key:"updatePosition",value:function(e){this.mesh.position.copy(e),this.shadow.position.copy(e)}},{key:"updateRotation",value:function(e,t){var n=e.length()*t;this.mesh.rotateOnWorldAxis((0,l.xb)(e),n)}},{key:"updateArrows",value:function(e,t,n){this.spinAxisArrow.setLength(h.R+h.R*t.length()/2,h.R,h.R),this.spinAxisArrow.position.copy(e),this.spinAxisArrow.setDirection((0,l.xb)(t)),n==k.Rolling?this.spinAxisArrow.setColor(0xcc0000):this.spinAxisArrow.setColor(52224)}},{key:"initialiseMesh",value:function(e,t){if(void 0===t){var r,i,o=e.getHex(),s=n._dottedGeometryCache.get(o);s||(s=new u.WBB(h.R,1),n.addDots(s,e),n._dottedGeometryCache.set(o,s)),r=s,i=v.createDottedMaterial(e)}else r=n.getBallGeometry(),i=v.createProjectedMaterial(t,e);this.mesh=new u.eaF(r,i),this.mesh.name="ball",this.updateRotation(new u.Pq0().random(),100),this.shadow=new u.eaF(n.getShadowGeometry(),n.getShadowMaterial()),this.spinAxisArrow=new u.E0M(l.up,l.v_,2,0,.01,.01),this.spinAxisArrow.visible=!1,this.trace=new p(500,e)}},{key:"addToScene",value:function(e){e.add(this.mesh),e.add(this.shadow),e.add(this.spinAxisArrow),e.add(this.trace.line)}}],t=[{key:"getBallGeometry",value:function(){return this._ballGeometry||(this._ballGeometry=new u.WBB(h.R,1)),this._ballGeometry}},{key:"getShadowGeometry",value:function(){return this._shadowGeometry||(this._shadowGeometry=new u.tcD(.9*h.R,9),this._shadowGeometry.applyMatrix4(new u.kn4().makeTranslation(0,0,-(.99*h.R)))),this._shadowGeometry}},{key:"getShadowMaterial",value:function(){return this._shadowMaterial||(this._shadowMaterial=new u.V9B({color:1118498})),this._shadowMaterial}},{key:"addDots",value:function(e,t){var r=e.attributes.position.count,i=new u.Q1f(t);e.setAttribute("color",new u.THS(new Float32Array(3*r),3));for(var o=e.attributes.color,s=0;s<r/3;s++)n.colorVerticesForFace(s,o,n.scaleNoise(i.r),n.scaleNoise(i.g),n.scaleNoise(i.b));var a=new u.Q1f(0xaa2222);[0,96,111,156,186,195].forEach(function(e){n.colorVerticesForFace(e/3,o,a.r,a.g,a.b)})}},{key:"colorVerticesForFace",value:function(e,t,n,r,i){t.setXYZ(3*e+0,n,r,i),t.setXYZ(3*e+1,n,r,i),t.setXYZ(3*e+2,n,r,i)}},{key:"scaleNoise",value:function(e){return(1-.25*Math.random())*e}}],e&&y(n.prototype,e),t&&y(n,t),n}();function g(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function w(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}m(b,"_ballGeometry",void 0),m(b,"_shadowGeometry",void 0),m(b,"_shadowMaterial",void 0),m(b,"_dottedGeometryCache",new Map);var k=((a={}).Stationary="Stationary",a.Rolling="Rolling",a.Sliding="Sliding",a.Falling="Falling",a.InPocket="InPocket",a),T=function(){var e,t;function n(e,t,r){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");w(this,"pos",void 0),w(this,"vel",l.v_.clone()),w(this,"rvel",l.v_.clone()),w(this,"futurePos",l.v_.clone()),w(this,"ballmesh",void 0),w(this,"state","Stationary"),w(this,"pocket",void 0),w(this,"id",n.id++),w(this,"label",void 0),this.pos=e.clone(),this.label=r,this.ballmesh=new b(t||0xeeeeee*Math.random(),r)}return e=[{key:"update",value:function(e){this.updatePosition(e),"Falling"==this.state?this.pocket.updateFall(this,e):this.updateVelocity(e)}},{key:"updateMesh",value:function(e){this.ballmesh.updateAll(this,e)}},{key:"updatePosition",value:function(e){this.pos.addScaledVector(this.vel,e)}},{key:"updateVelocity",value:function(e){this.inMotion()&&(this.isRolling()?(this.state="Rolling",(0,c.lx)(this.vel,this.rvel),this.addDelta(e,(0,c.JD)(this.rvel))):(this.state="Sliding",this.addDelta(e,(0,c.p2)(this.vel,this.rvel))))}},{key:"addDelta",value:function(e,t){t.v.multiplyScalar(e),t.w.multiplyScalar(e),this.passesZero(t)||(this.vel.add(t.v),this.rvel.add(t.w))}},{key:"passesZero",value:function(e){var t=(0,l.rq)(this.vel,e.v),n=(0,l.rq)(this.rvel,e.w);return!!(("Rolling"===this.state?t||n:t&&n)&&.01>Math.abs(this.rvel.z))&&(this.setStationary(),!0)}},{key:"setStationary",value:function(){this.vel.copy(l.v_),this.rvel.copy(l.v_),this.state="Stationary"}},{key:"isRolling",value:function(){return 0!==this.vel.lengthSq()&&0!==this.rvel.lengthSq()&&(0,c.Mq)(this.vel,this.rvel).length()<n.transition}},{key:"onTable",value:function(){return"Falling"!==this.state&&"InPocket"!==this.state}},{key:"inMotion",value:function(){return"Rolling"===this.state||"Sliding"===this.state||this.isFalling()}},{key:"isFalling",value:function(){return"Falling"===this.state}},{key:"futurePosition",value:function(e){return this.futurePos.copy(this.pos).addScaledVector(this.vel,e),this.futurePos}},{key:"fround",value:function(){this.pos.x=Math.fround(this.pos.x),this.pos.y=Math.fround(this.pos.y),this.vel.x=Math.fround(this.vel.x),this.vel.y=Math.fround(this.vel.y),this.rvel.x=Math.fround(this.rvel.x),this.rvel.y=Math.fround(this.rvel.y),this.rvel.z=Math.fround(this.rvel.z)}},{key:"serialise",value:function(){return{pos:this.pos.clone(),id:this.id}}}],t=[{key:"fromSerialised",value:function(e){return n.updateFromSerialised(new n((0,l.t6)(e.pos)),e)}},{key:"updateFromSerialised",value:function(e,t){var n,r;return e.pos.copy(t.pos),e.vel.copy(null!=(n=null==t?void 0:t.vel)?n:l.v_),e.rvel.copy(null!=(r=null==t?void 0:t.rvel)?r:l.v_),e}}],e&&g(n.prototype,e),t&&g(n,t),n}();w(T,"id",0),w(T,"transition",.05)},"./src/model/outcome.ts"(e,t,n){n.d(t,{$:()=>o,P:()=>s});function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var i,o=((i={}).Pot="Pot",i.Cushion="Cushion",i.Collision="Collision",i.Hit="Hit",i),s=function(){var e;function t(e,n,i,o){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");r(this,"type",void 0),r(this,"timestamp",void 0),r(this,"ballA",null),r(this,"ballB",null),r(this,"incidentSpeed",void 0),this.type=e,this.ballA=n,this.ballB=i,this.incidentSpeed=o,this.timestamp=Date.now()}return e=[{key:"pot",value:function(e,n){return new t("Pot",e,e,n)}},{key:"cushion",value:function(e,n){return new t("Cushion",e,e,n)}},{key:"collision",value:function(e,n,r){return new t("Collision",e,n,r)}},{key:"hit",value:function(e,n){return new t("Hit",e,e,n)}},{key:"isCueBallPotted",value:function(e,t){return t.some(function(t){return"Pot"==t.type&&t.ballA===e})}},{key:"isBallPottedNoFoul",value:function(e,n){return n.some(function(e){return"Pot"==e.type&&null!==e.ballA})&&!t.isCueBallPotted(e,n)}},{key:"pots",value:function(e){return e.filter(function(e){return"Pot"==e.type}).map(function(e){return e.ballA})}},{key:"potCount",value:function(e){return this.pots(e).length}},{key:"onlyRedsPotted",value:function(e){return this.pots(e).every(function(e){return e.id>6})}},{key:"firstCollision",value:function(e){var t=e.filter(function(e){return"Collision"===e.type});return t.length>0?t[0]:void 0}},{key:"isClearTable",value:function(e){var t=e.balls.filter(function(e){return e.onTable()});return 1===t.length&&t[0]===e.cueball}},{key:"isThreeCushionPoint",value:function(e,n){n=t.cueBallFirst(e,n).filter(function(t){return t.ballA===e});var r=new Set,i=0,o=!0,s=!1,a=void 0;try{for(var l,c=n[Symbol.iterator]();!(o=(l=c.next()).done);o=!0){var u=l.value;if("Cushion"===u.type&&i++,"Collision"===u.type&&(r.add(u.ballB),2===r.size))return i>=3}}catch(e){s=!0,a=e}finally{try{o||null==c.return||c.return()}finally{if(s)throw a}}return!1}},{key:"cueBallFirst",value:function(e,t){return t.forEach(function(t){"Collision"===t.type&&t.ballB===e&&(t.ballB=t.ballA,t.ballA=e)}),t}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/model/physics/collision.ts"(e,t,n){n.d(t,{F:()=>h});var r,i,o=n("./src/model/ball.ts"),s=n("./node_modules/three/build/three.core.js"),a=n("./src/model/physics/constants.ts"),l=n("./src/utils/utils.ts");function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var u=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");c(this,"normalImpulse",void 0),c(this,"tangentialImpulse",void 0)}return e=[{key:"dynamicFriction",value:function(e){return .01+.108*(0,l.oN)(-1.088*e)}},{key:"updateVelocities",value:function(e,t){var n=h.positionsAtContact(e,t);e.ballmesh.trace.forceTrace(n.a),t.ballmesh.trace.forceTrace(n.b);var r=n.b.sub(n.a).normalize(),i=new s.Pq0(-r.y,r.x,0),o=e.vel.clone().sub(t.vel).add(r.clone().multiplyScalar(-a.R).cross(e.rvel).sub(r.clone().multiplyScalar(a.R).cross(t.rvel))),l=r.dot(o),c=o.addScaledVector(r,-l),u=c.length(),f=i.dot(c),p=this.dynamicFriction(u);this.normalImpulse=-1.99*l/(2/a.m),this.tangentialImpulse=-(.25*Math.min(p*Math.abs(this.normalImpulse)/u,1/7)*f);var d=r.clone().multiplyScalar(this.normalImpulse),v=i.clone().multiplyScalar(this.tangentialImpulse);e.vel.addScaledVector(d,1/a.m).addScaledVector(v,1/a.m),t.vel.addScaledVector(d,-1/a.m).addScaledVector(v,-1/a.m);var y=r.clone().multiplyScalar(-a.R).cross(v),m=r.clone().multiplyScalar(a.R).cross(v);return e.rvel.addScaledVector(y,1/a.I),t.rvel.addScaledVector(m,1/a.I),l}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),h=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"willCollide",value:function(e,t,n){return(e.inMotion()||t.inMotion())&&e.onTable()&&t.onTable()&&e.futurePosition(n).distanceToSquared(t.futurePosition(n))<4*a.R*a.R}},{key:"collide",value:function(e,n){return t.updateVelocities(e,n)}},{key:"positionsAtContact",value:function(e,t){var n=e.pos.distanceTo(t.pos),r=e.vel.clone().sub(t.vel),i=(n-2*a.R)/r.length()||0;return{a:e.pos.clone().addScaledVector(e.vel,i),b:t.pos.clone().addScaledVector(t.vel,i)}}},{key:"updateVelocities",value:function(e,n){var r=t.model.updateVelocities(e,n);return e.state=o.U.Sliding,n.state=o.U.Sliding,r}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();r="model",i=new u,r in h?Object.defineProperty(h,r,{value:i,enumerable:!0,configurable:!0,writable:!0}):h[r]=i},"./src/model/physics/constants.ts"(e,t,n){n.d(t,{I:()=>o,Mz:()=>r,PX:()=>A,Qg:()=>k,R:()=>f,Wv:()=>x,Ys:()=>P,Z3:()=>m,_m:()=>y,cM:()=>S,e:()=>p,ee:()=>d,g:()=>s,gT:()=>c,gf:()=>l,jG:()=>w,kL:()=>u,kM:()=>O,ki:()=>E,ko:()=>R,m:()=>h,mu:()=>a,o5:()=>b,oV:()=>v,x3:()=>i,xO:()=>T});var r,i,o,s=9.8,a=.00985,l=.16,c=.85,u=.034,h=.23,f=.03275,p=.86,d=.98,v=.212,y=.14,m=.4,b=Math.sqrt(21)/5;function g(){r=a*h*s*2/3*u,i=7/(5*Math.sqrt(2))*f*a*h*s,o=.4*h*f*f}function w(e){f=e,g()}function k(e){h=e,g()}function T(e){a=e,g()}function x(e){u=e,g()}function P(e){l=e}function S(e){p=e}function O(e){c=e}function R(e){v=e}function E(e){y=e}function A(e){d=e}g()},"./src/model/physics/knuckle.ts"(e,t,n){n.d(t,{O:()=>a});var r=n("./src/model/physics/constants.ts"),i=n("./src/view/pocketgeometry.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e,t;function n(e,t){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");s(this,"pos",void 0),s(this,"radius",void 0),this.pos=e,this.radius=t}return e=[{key:"bounce",value:function(e){var t=e.pos.clone().sub(this.pos).normalize(),n=t.dot(e.vel);return e.vel.addScaledVector(t,-2*r.e*n),e.rvel.multiplyScalar(.5),Math.abs(n)}}],t=[{key:"willBounce",value:function(e,t){return t.distanceTo(e.pos)<r.R+e.radius}},{key:"findBouncing",value:function(e,t){var r=e.futurePosition(t);return i.f.knuckles.find(function(e){return n.willBounce(e,r)})}}],e&&o(n.prototype,e),t&&o(n,t),n}()},"./src/model/physics/mathaven.ts"(e,t,n){n.d(t,{z:()=>s});var r=n("./src/utils/utils.ts"),i=n("./src/model/physics/constants.ts");function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var s=function(){var e;function t(e,n,r,i,s){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");o(this,"P",0),o(this,"WzI",0),o(this,"vx",void 0),o(this,"vy",void 0),o(this,"Ï‰x",void 0),o(this,"Ï‰y",void 0),o(this,"Ï‰z",void 0),o(this,"s",void 0),o(this,"Ï†",void 0),o(this,"sÊ¹",void 0),o(this,"Ï†Ê¹",void 0),o(this,"i",0),o(this,"N",100),o(this,"M",void 0),o(this,"R",void 0),o(this,"Î¼s",void 0),o(this,"Î¼w",void 0),o(this,"ee",void 0),this.M=e,this.R=n,this.ee=r,this.Î¼s=i,this.Î¼w=s}return e=[{key:"updateSlipSpeedsAndAngles",value:function(){var e=this.R,t=this.vx+this.Ï‰y*e*i.Z3-this.Ï‰z*e*i.o5,n=-this.vy*i.Z3+this.Ï‰x*e,o=this.vx-this.Ï‰y*e,s=this.vy+this.Ï‰x*e;this.s=(0,r.RZ)((0,r.n7)(t,2)+(0,r.n7)(n,2)),this.Ï†=(0,r.FP)(n,t),this.Ï†<0&&(this.Ï†+=2*Math.PI),this.sÊ¹=(0,r.RZ)((0,r.n7)(o,2)+(0,r.n7)(s,2)),this.Ï†Ê¹=(0,r.FP)(s,o),this.Ï†Ê¹<0&&(this.Ï†Ê¹+=2*Math.PI)}},{key:"compressionPhase",value:function(){for(var e=Math.max(this.M*this.vy/this.N,.001);this.vy>0;)this.updateSingleStep(e)}},{key:"restitutionPhase",value:function(e){var t=Math.max(e/this.N,.001);for(this.WzI=0;this.WzI<e;)this.updateSingleStep(t)}},{key:"updateSingleStep",value:function(e){if(this.updateSlipSpeedsAndAngles(),this.updateVelocity(e),this.updateAngularVelocity(e),this.updateWorkDone(e),this.i++>10*this.N)throw Error("Solution not found")}},{key:"updateVelocity",value:function(e){var t=this.Î¼s,n=this.Î¼w,o=this.M;this.vx-=1/o*(n*(0,r.gn)(this.Ï†)+t*(0,r.gn)(this.Ï†Ê¹)*(i.Z3+n*(0,r.F8)(this.Ï†)*i.o5))*e,this.vy-=1/o*(i.o5-n*i.Z3*(0,r.F8)(this.Ï†)+t*(0,r.F8)(this.Ï†Ê¹)*(i.Z3+n*(0,r.F8)(this.Ï†)*i.o5))*e}},{key:"updateAngularVelocity",value:function(e){var t=this.Î¼s,n=this.Î¼w,o=this.M,s=this.R;this.Ï‰x+=-(5/(2*o*s))*(n*(0,r.F8)(this.Ï†)+t*(0,r.F8)(this.Ï†Ê¹)*(i.Z3+n*(0,r.F8)(this.Ï†)*i.o5))*e,this.Ï‰y+=-(5/(2*o*s))*(n*(0,r.gn)(this.Ï†)*i.Z3-t*(0,r.gn)(this.Ï†Ê¹)*(i.Z3+n*(0,r.F8)(this.Ï†)*i.o5))*e,this.Ï‰z+=5/(2*o*s)*(n*(0,r.gn)(this.Ï†)*i.o5)*e}},{key:"updateWorkDone",value:function(e){var t=e*Math.abs(this.vy);this.WzI+=t,this.P+=e}},{key:"solvePaper",value:function(e,t,n,i){this.solve(e*(0,r.gn)(t),e*(0,r.F8)(t),-i*(0,r.F8)(t),i*(0,r.gn)(t),n)}},{key:"solve",value:function(e,t,n,r,i){this.vx=e,this.vy=t,this.Ï‰x=n,this.Ï‰y=r,this.Ï‰z=i,this.WzI=0,this.P=0,this.i=0,this.compressionPhase();var o=this.ee*this.ee*this.WzI;this.restitutionPhase(o)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/model/physics/physics.ts"(e,t,n){n.d(t,{$8:()=>O,Gp:()=>w,JD:()=>h,Mq:()=>l,QK:()=>p,QV:()=>S,Qy:()=>A,Un:()=>g,c0:()=>b,lx:()=>f,p2:()=>u,s0:()=>m,t6:()=>M,yO:()=>k});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/utils/utils.ts"),o=n("./src/model/physics/constants.ts"),s=n("./src/model/physics/mathaven.ts"),a=new r.Pq0;function l(e,t){return a.copy(e).addScaledVector((0,i.KM)(t),o.R)}var c={v:new r.Pq0,w:new r.Pq0};function u(e,t){var n=l(e,t).setZ(0);return c.v.copy((0,i.xb)(n).multiplyScalar(-o.gf*o.g)),c.w.copy((0,i.xb)((0,i.KM)(n)).multiplyScalar(2.5*o.gf*o.g/o.R)),c.w.setZ(-2.5*(o.Mz/(o.m*o.R*o.R))*Math.sign(t.z)),c}function h(e){var t=new r.Pq0(e.x,e.y,0).length(),n=5/7*o.x3/(o.m*o.R)/t,i=5/7*o.x3/(o.m*o.R*o.R)/t;return c.v.set(-n*e.y,n*e.x,0),c.w.set(-i*e.x,-i*e.y,-2.5*(o.Mz/(o.m*o.R*o.R))*Math.sign(e.z)),c}function f(e,t){var n=t.z;t.copy((0,i.KM)(e).multiplyScalar(1/o.R)),t.setZ(n)}function p(e,t,n,r){var o=r(t.clone().applyAxisAngle(i.up,e),n.clone().applyAxisAngle(i.up,e));return o.v.applyAxisAngle(i.up,-e),o.w.applyAxisAngle(i.up,-e),o}Object.freeze(c);var d=Math.asin(.1*o.R/o.R),v=(0,i.F8)(d),y=(0,i.gn)(d);function m(e,t){return new r.Pq0(e.x*v-e.z*y+o.R*t.y,-e.y-o.R*t.z*y+o.R*t.x*v)}function b(e){return e.x*y}function g(e){var t=3.5/o.m;return e.length()/t}function w(e){var t,n=1/o.m,i=.39+.257*(t=new r.Pq0(e/y,0,0)).x-.044*t.x*t.x;return o.gT*((1+i)*e)/n}function k(e,t){var n=w(b(e));return g(m(e,t))<=n}function T(e,t){return{c:b(e),s:m(e,t),A:3.5/o.m,B:1/o.m}}function x(e,t){var n=T(e,t),r=n.c,i=n.s,s=n.A,a=n.B,l=(1+o.e)*(r/a);return R(-i.x/s*v-l*y,i.y/s,i.x/s*y-l*v)}function P(e,t){var n,r=T(e,t),i=r.c,s=r.B,a=(1+o.e)*(i/s),l=.471-.241*Math.atan2(Math.abs((n=e).y),n.x),c=Math.atan2(e.y,e.x),u=Math.cos(c);return R(-l*a*u*y-a*y,l*a*Math.sin(c),l*a*u*y-a*v)}function S(e,t){return k(e,t)?x(e,t):P(e,t)}function O(e,t){var n=x(e,t),r=P(e,t),i=Math.sign(e.y)===Math.sign(t.z)?Math.cos(Math.atan2(e.y,e.x)):1;return{v:r.v.lerp(n.v,i),w:r.w.lerp(n.w,i)}}function R(e,t,n){return{v:new r.Pq0(e/o.m,t/o.m),w:new r.Pq0(-o.R/o.I*t*v,o.R/o.I*(e*v-n*y),o.R/o.I*t*y)}}function E(e,t){var n=new s.z(o.m,o.R,o.ee,o.oV,o._m+.1);n.solve(e.x,e.y,t.x,t.y,t.z);var i=new r.Pq0(n.vx,n.vy,0),a=new r.Pq0(n.Ï‰x,n.Ï‰y,n.Ï‰z);return{v:i.sub(e),w:a.sub(t)}}function A(e,t){return p(Math.PI/2,e,t,E)}function M(e,t){var n=Math.atan2(-e.x,e.y),r=2.5*t.length()*(e.length()*o.R)/(o.R*o.R),s=t.clone().normalize();return(0,i.KM)(s).applyAxisAngle(s,n).multiplyScalar(r)}},"./src/model/physics/pocket.ts"(e,t,n){n.d(t,{Z:()=>l});var r=n("./src/model/ball.ts"),i=n("./src/model/physics/constants.ts"),o=n("./src/utils/utils.ts");function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var l=function(){var e,t;function n(e,t){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");a(this,"pos",void 0),a(this,"radius",void 0),this.pos=e,this.radius=t}return e=[{key:"fall",value:function(e,t){return e.vel.z=-i.g*t,e.state=r.U.Falling,e.pocket=this,e.vel.length()}},{key:"updateFall",value:function(e,t){e.vel.addScaledVector(o.up,-(10*i.R)*t*i.g);var n=e.pos.z;if(e.pos.clone().setZ(0).distanceTo(this.pos)>this.radius-i.R){var s=this.pos.clone().sub(e.pos).normalize().setZ(0);n>-i.R/2&&(e.vel.addScaledVector(s,7*i.R*t*i.g),e.rvel.addScaledVector((0,o.KM)(s),7*t*i.g)),0>e.vel.dot(s)&&(e.ballmesh.trace.forceTrace(e.pos),e.vel.x=s.x*e.vel.length()/2,e.vel.y=s.y*e.vel.length()/2)}var a=this.restingDepth(e);n<a&&0!==e.rvel.length()&&(e.pos.z=a,e.vel.z=-i.R/10,e.rvel.copy(o.v_)),n<a-i.R&&(e.pos.z=a-i.R,e.setStationary(),e.state=r.U.InPocket)}},{key:"restingDepth",value:function(e){return -3*i.R-i.R*e.id/4}}],t=[{key:"willFall",value:function(e,t){return t.distanceTo(e.pos)<e.radius}},{key:"findPocket",value:function(e,t,r){var i=t.futurePosition(r);return e.find(function(e){return n.willFall(e,i)})}}],e&&s(n.prototype,e),t&&s(n,t),n}()},"./src/model/table.ts"(e,t,n){n.d(t,{X:()=>b});var r=n("./src/view/tablegeometry.ts"),i=n("./src/model/physics/physics.ts"),o=n("./src/view/pocketgeometry.ts"),s=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"bounceAny",value:function(e,n){var o=!(arguments.length>2)||void 0===arguments[2]||arguments[2],s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:i.$8,a=e.futurePosition(n);if(t.willBounceLong(a,o)){var l=a.y>r.P.tableY?-Math.PI/2:Math.PI/2;return t.bounceIn(l,e,s)}if(t.willBounceShort(a,o)){var c=a.x>r.P.tableX?0:Math.PI;return t.bounceIn(c,e,s)}}},{key:"willBounceShort",value:function(e,n){return n?t.willBounceShortSegment(o.f.pockets.pocketNW.knuckleSW.pos.y,o.f.pockets.pocketSW.knuckleNW.pos.y,e):t.willBounceShortSegment(r.P.Y,-r.P.Y,e)}},{key:"willBounceLong",value:function(e,n){return n?t.willBounceLongSegment(o.f.pockets.pocketNW.knuckleNE.pos.x,o.f.pockets.pocketN.knuckleNW.pos.x,e)||t.willBounceLongSegment(o.f.pockets.pocketN.knuckleNE.pos.x,o.f.pockets.pocketNE.knuckleNW.pos.x,e):t.willBounceLongSegment(-r.P.X,r.P.X,e)}},{key:"willBounceLongSegment",value:function(e,t,n){return n.x>e&&n.x<t&&Math.abs(n.y)>r.P.tableY}},{key:"willBounceShortSegment",value:function(e,t,n){return n.y>t&&n.y<e&&Math.abs(n.x)>r.P.tableX}},{key:"bounceIn",value:function(e,t,n){t.ballmesh.trace.forceTrace(t.futurePos);var r=(0,i.QK)(e,t.vel,t.rvel,n);return t.vel.add(r.v),t.rvel.add(r.w),r.v.length()}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}(),a=n("./src/model/physics/collision.ts"),l=n("./src/model/physics/knuckle.ts"),c=n("./src/model/physics/pocket.ts"),u=n("./src/view/cue.ts"),h=n("./src/model/ball.ts"),f=n("./src/events/aimevent.ts"),p=n("./src/model/outcome.ts"),d=n("./src/utils/utils.ts"),v=n("./src/model/physics/constants.ts");function y(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var b=function(){var e,t;function n(e){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");m(this,"balls",void 0),m(this,"cue",new u.s),m(this,"pairs",void 0),m(this,"outcome",[]),m(this,"cueball",void 0),m(this,"cushionModel",i.$8),m(this,"mesh",void 0),this.cueball=e[0],this.initialiseBalls(e)}return e=[{key:"initialiseBalls",value:function(e){this.balls=e,this.pairs=[];for(var t=0;t<e.length;t++)for(var n=0;n<e.length;n++)t<n&&this.pairs.push({a:e[t],b:e[n]})}},{key:"updateBallMesh",value:function(e){this.balls.forEach(function(t){t.updateMesh(e)})}},{key:"advance",value:function(e){for(var t=0;!this.prepareAdvanceAll(e);)if(t++>100)throw Error("Depth exceeded resolving collisions");this.balls.forEach(function(t){t.update(e),t.fround()})}},{key:"prepareAdvanceAll",value:function(e){var t=this;return this.pairs.every(function(n){return t.prepareAdvancePair(n.a,n.b,e)})&&this.balls.every(function(n){return t.prepareAdvanceToCushions(n,e)})}},{key:"prepareAdvancePair",value:function(e,t,n){if(a.F.willCollide(e,t,n)){var r=a.F.collide(e,t);return this.outcome.push(p.P.collision(e,t,r)),!1}return!0}},{key:"prepareAdvanceToCushions",value:function(e,t){if(!e.onTable())return!0;var n=e.futurePosition(t);if(Math.abs(n.y)<r.P.tableY&&Math.abs(n.x)<r.P.tableX)return!0;var i=s.bounceAny(e,t,r.P.hasPockets,this.cushionModel);if(i)return this.outcome.push(p.P.cushion(e,i)),!1;var a=l.O.findBouncing(e,t);if(a){var u=a.bounce(e);return this.outcome.push(p.P.cushion(e,u)),!1}var h=c.Z.findPocket(o.f.pocketCenters,e,t);if(h){var f=h.fall(e,t);return this.outcome.push(p.P.pot(e,f)),!1}return!0}},{key:"allStationary",value:function(){return this.balls.every(function(e){return!e.inMotion()})}},{key:"inPockets",value:function(){return this.balls.reduce(function(e,t){return t.onTable()?e:e+1},0)}},{key:"hit",value:function(){this.cue.hit(this.cueball),this.balls.forEach(function(e){e.ballmesh.trace.reset()})}},{key:"serialise",value:function(){return{balls:this.balls.map(function(e){return e.serialise()}),aim:this.cue.aim.copy()}}},{key:"updateFromSerialised",value:function(e){var t=this;e.balls&&e.balls.forEach(function(e){return h.c.updateFromSerialised(t.balls[e.id],e)}),e.aim&&(this.cue.aim=f.w.fromJson(e.aim))}},{key:"shortSerialise",value:function(){return this.balls.map(function(e){return[e.pos.x,e.pos.y]}).reduce(function(e,t){return e.concat(t)},[])}},{key:"updateFromShortSerialised",value:function(e){this.balls.forEach(function(t,n){t.pos.x=e[2*n],t.pos.y=e[2*n+1],t.pos.z=0,t.vel.copy(d.v_),t.rvel.copy(d.v_),t.state=h.U.Stationary})}},{key:"addToScene",value:function(e){this.balls.forEach(function(t){t.ballmesh.addToScene(e)}),e.add(this.cue.mesh),e.add(this.cue.helperMesh),e.add(this.cue.placerMesh)}},{key:"showTraces",value:function(e){this.balls.forEach(function(t){t.ballmesh.trace.line.visible=e,t.ballmesh.trace.reset()})}},{key:"showSpin",value:function(e){this.balls.forEach(function(t){t.ballmesh.spinAxisArrow.visible=e})}},{key:"halt",value:function(){this.balls.forEach(function(e){e.vel.copy(d.v_),e.rvel.copy(d.v_),e.state=h.U.Stationary})}},{key:"roundCueBallPosition",value:function(){var e=this.cueball.pos.clone();this.overlapsAny(e)||this.cueball.pos.copy(e)}},{key:"overlapsAny",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.cueball;return this.balls.filter(function(e){return e!==t}).some(function(t){return t.pos.distanceTo(e)<2*v.R})}}],t=[{key:"fromSerialised",value:function(e){var t=new n(e.balls.map(function(e){return h.c.fromSerialised(e)}));return t.updateFromSerialised(e),t}}],e&&y(n.prototype,e),t&&y(n,t),n}()},"./src/network/client/matchresult.ts"(e,t,n){n.d(t,{n:()=>l});var r=n("./src/events/chatevent.ts"),i=n("./src/events/notificationevent.ts"),o=n("./src/controller/end.ts"),s=n("./src/network/client/session.ts"),a=n("./src/utils/gameover.ts"),l=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"presentGameEnd",value:function(e,t){e.eventQueue.push(new r.b(null,"game over")),e.recorder.wholeGameLink();var n=s.N.hasInstance()?s.N.getInstance():null,i=s.N.playerIndex(),a=(e.scores[0]>=e.scores[1]?0:1)===i,l=this.getScoreSubtext(e,n,i);a?(this.notifyWin(e,l),this.sendLossNotification(e)):s.N.isSpectator()?this.notifySpectator(e,l):this.notifyLoss(e,l);var c=this.createMatchResult(e,t,n,i);return new o.o(e,a?c:void 0)}},{key:"notifyWin",value:function(e,t){e.notifyLocal({type:"GameOver",title:"YOU WON",subtext:t,icon:"ðŸ†",extraClass:"is-winner",extra:a.c.forMode(e.isSinglePlayer),duration:0})}},{key:"notifyLoss",value:function(e,t){e.notifyLocal({type:"GameOver",title:"YOU LOST",subtext:t,icon:"ðŸ¥ˆ",extraClass:"is-loser",extra:a.c.forMode(e.isSinglePlayer),duration:0})}},{key:"notifySpectator",value:function(e,t){e.notifyLocal({type:"GameOver",title:"GAME OVER",subtext:t,icon:"ðŸ†",extraClass:"",extra:a.c.lobby,duration:0})}},{key:"sendLossNotification",value:function(e){e.isSinglePlayer||e.sendEvent(new i.c({type:"GameOver",title:"YOU LOST",icon:"ðŸ¥ˆ",extraClass:"is-loser",extra:a.c.forMode(!1),duration:0}))}},{key:"getScoreSubtext",value:function(e,t,n){if(e.isSinglePlayer)return"Score: ".concat(e.scores[n]);var r=0===n?(null==t?void 0:t.playername)||"You":(null==t?void 0:t.opponentName)||"Opponent",i=1===n?(null==t?void 0:t.playername)||"You":(null==t?void 0:t.opponentName)||"Opponent";return"".concat(r," ").concat(e.scores[0]," - ").concat(e.scores[1]," ").concat(i)}},{key:"createMatchResult",value:function(e,t,n,r){var i=e.scores[0]>=e.scores[1]?0:1,o=1-i,s=i===r?(null==n?void 0:n.playername)||"Anon":(null==n?void 0:n.opponentName)||"Opponent",a=o===r?(null==n?void 0:n.playername)||"Anon":(null==n?void 0:n.opponentName)||"Opponent",l={winner:s,winnerScore:e.scores[i],ruleType:t};return(null==n?void 0:n.opponentName)&&(l.loser=a,l.loserScore=e.scores[o]),l}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/network/client/nchanmessagerelay.ts"(e,t,n){function r(e,t,n,r,i,o,s){try{var a=e[o](s),l=a.value}catch(e){n(e);return}a.done?t(l):Promise.resolve(l).then(r,i)}n.d(t,{p:()=>o});function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var o=function(){var e;function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"billiards-network.onrender.com";if(!(this instanceof t))throw TypeError("Cannot call a class as a function");i(this,"baseURL",void 0),i(this,"websockets",void 0),this.baseURL=e,this.websockets=new Map}return e=[{key:"subscribe",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"table",r="wss://".concat(this.baseURL,"/subscribe/").concat(n,"/").concat(e),i=new WebSocket(r);console.log("Subscribed to ",r),i.onmessage=function(e){try{var n=e.data;t(n)}catch(e){console.error("Error parsing message:",e)}},i.onerror=function(e){console.error("WebSocket error:",e)},i.onopen=function(){console.log("Connected to ".concat(r))},i.onclose=function(e){console.log("Disconnected from ".concat(r,":"),e.reason)},this.websockets.set("".concat(n,"/").concat(e),i)}},{key:"publish",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"table";fetch("https://".concat(this.baseURL,"/publish/").concat(n,"/").concat(e),{method:"POST",headers:{"Content-Type":"application/json"},body:t}).catch(function(e){console.error("Publication error:",e)})}},{key:"getOnlineCount",value:function(){var e;return(e=function(){var e;return function(e,t){var n,r,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype),a=Object.defineProperty;return a(s,"next",{value:l(0)}),a(s,"throw",{value:l(1)}),a(s,"return",{value:l(2)}),"function"==typeof Symbol&&a(s,Symbol.iterator,{value:function(){return this}}),s;function l(a){return function(l){var c=[a,l];if(n)throw TypeError("Generator is already executing.");for(;s&&(s=0,c[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&c[0]?r.return:c[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,c[1])).done)return i;switch(r=0,i&&(c=[2&c[0],i.value]),c[0]){case 0:case 1:i=c;break;case 4:return o.label++,{value:c[1],done:!1};case 5:o.label++,r=c[1],c=[0];continue;case 7:c=o.ops.pop(),o.trys.pop();continue;default:if(!(i=(i=o.trys).length>0&&i[i.length-1])&&(6===c[0]||2===c[0])){o=0;continue}if(3===c[0]&&(!i||c[1]>i[0]&&c[1]<i[3])){o.label=c[1];break}if(6===c[0]&&o.label<i[1]){o.label=i[1],i=c;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(c);break}i[2]&&o.ops.pop(),o.trys.pop();continue}c=t.call(e,o)}catch(e){c=[6,e],r=0}finally{n=i=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}}(this,function(t){switch(t.label){case 0:return t.trys.push([0,3,,4]),[4,fetch("https://".concat(this.baseURL,"/basic_status"))];case 1:return[4,t.sent().text()];case 2:return[2,(e=t.sent().match(/Active connections:\s+(\d+)/))?Number.parseInt(e[1],10)-1:null];case 3:return t.sent(),[2,null];case 4:return[2]}})},function(){var t=this,n=arguments;return new Promise(function(i,o){var s=e.apply(t,n);function a(e){r(s,i,o,a,l,"next",e)}function l(e){r(s,i,o,a,l,"throw",e)}a(void 0)})}).call(this)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/network/client/session.ts"(e,t,n){n.d(t,{N:()=>i});function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var i=function(){var e;function t(e,n,i,o){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");r(this,"playername",void 0),r(this,"clientId",void 0),r(this,"tableId",void 0),r(this,"spectator",void 0),r(this,"opponentName",void 0),r(this,"playerIndex",void 0),this.playername=e,this.clientId=n,this.tableId=i,this.spectator=o,this.playerIndex=0}return e=[{key:"getInstance",value:function(){if(!t.instance)throw Error("Session not initialized");return t.instance}},{key:"hasInstance",value:function(){return void 0!==t.instance}},{key:"playerIndex",value:function(){return t.instance?t.instance.playerIndex:0}},{key:"isSpectator",value:function(){return void 0!==t.instance&&t.getInstance().spectator}},{key:"reset",value:function(){t.instance=void 0}},{key:"init",value:function(e,n,r,i){t.instance=new t(n,e,r,i)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();r(i,"instance",void 0)},"./src/utils/dom.ts"(e,t,n){function r(e){return document.getElementById(e)}function i(e){return document.getElementById(e)}function o(e){return document.getElementById(e)}function s(e){return document.getElementById(e)}n.d(t,{V4:()=>o,dX:()=>s,id:()=>r,vq:()=>i})},"./src/utils/gameover.ts"(e,t,n){n.d(t,{c:()=>r});var r={lobby:"<button onclick=\"location.href='".concat("https://scoreboard-tailuge.vercel.app/","'\">Lobby</button>"),newGame:'<button onclick="location.reload()">New Game</button>',replay:'<button onclick="location.reload()">Replay</button>',forMode:function(e){return e?this.newGame+this.lobby:this.lobby}}},"./src/utils/gltf.ts"(e,t,n){n.d(t,{KP:()=>eT,Ro:()=>ex});var r=n("./node_modules/three/build/three.core.js");let i={POSITION:["byte","byte normalized","unsigned byte","unsigned byte normalized","short","short normalized","unsigned short","unsigned short normalized"],NORMAL:["byte normalized","short normalized"],TANGENT:["byte normalized","short normalized"],TEXCOORD:["byte","byte normalized","unsigned byte","short","short normalized","unsigned short"]};class o{constructor(){this.textureUtils=null,this.pluginCallbacks=[],this.register(function(e){return new v(e)}),this.register(function(e){return new y(e)}),this.register(function(e){return new w(e)}),this.register(function(e){return new k(e)}),this.register(function(e){return new T(e)}),this.register(function(e){return new x(e)}),this.register(function(e){return new m(e)}),this.register(function(e){return new b(e)}),this.register(function(e){return new g(e)}),this.register(function(e){return new P(e)}),this.register(function(e){return new S(e)}),this.register(function(e){return new O(e)}),this.register(function(e){return new R(e)}),this.register(function(e){return new E(e)})}register(e){return -1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return -1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}setTextureUtils(e){return this.textureUtils=e,this}parse(e,t,n,r){let i=new d,o=[];for(let e=0,t=this.pluginCallbacks.length;e<t;e++)o.push(this.pluginCallbacks[e](i));i.setPlugins(o),i.setTextureUtils(this.textureUtils),i.writeAsync(e,t,r).catch(n)}parseAsync(e,t){let n=this;return new Promise(function(r,i){n.parse(e,r,i,t)})}}let s="KHR_mesh_quantization",a={};a[r.hxR]=9728,a[r.pHI]=9984,a[r.Cfg]=9986,a[r.k6q]=9729,a[r.kRr]=9985,a[r.$_I]=9987,a[r.ghU]=33071,a[r.GJx]=10497,a[r.kTW]=33648;let l={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},c=new r.Q1f;function u(e,t){return e.length===t.length&&e.every(function(e,n){return e===t[n]})}function h(e){return 4*Math.ceil(e/4)}function f(e,t=0){let n=h(e.byteLength);if(n!==e.byteLength){let r=new Uint8Array(n);if(r.set(new Uint8Array(e)),0!==t)for(let i=e.byteLength;i<n;i++)r[i]=t;return r.buffer}return e}function p(){return"u"<typeof document&&"u">typeof OffscreenCanvas?new OffscreenCanvas(1,1):document.createElement("canvas")}class d{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.extensionsRequired={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter r"+r.sPf}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map},this.textureUtils=null}setPlugins(e){this.plugins=e}setTextureUtils(e){this.textureUtils=e}async writeAsync(e,t,n={}){this.options=Object.assign({binary:!1,trs:!1,onlyVisible:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},n),this.options.animations.length>0&&(this.options.trs=!0),await this.processInputAsync(e),await Promise.all(this.pending);let r=this.buffers,i=this.json;n=this.options;let o=this.extensionsUsed,s=this.extensionsRequired,a=new Blob(r,{type:"application/octet-stream"}),l=Object.keys(o),c=Object.keys(s);if(l.length>0&&(i.extensionsUsed=l),c.length>0&&(i.extensionsRequired=c),i.buffers&&i.buffers.length>0&&(i.buffers[0].byteLength=a.size),!0===n.binary){let e=new FileReader;e.readAsArrayBuffer(a),e.onloadend=function(){var n;let r=f(e.result),o=new DataView(new ArrayBuffer(8));o.setUint32(0,r.byteLength,!0),o.setUint32(4,5130562,!0);let s=f((n=JSON.stringify(i),new TextEncoder().encode(n).buffer),32),a=new DataView(new ArrayBuffer(8));a.setUint32(0,s.byteLength,!0),a.setUint32(4,0x4e4f534a,!0);let l=new ArrayBuffer(12),c=new DataView(l);c.setUint32(0,0x46546c67,!0),c.setUint32(4,2,!0);let u=12+a.byteLength+s.byteLength+o.byteLength+r.byteLength;c.setUint32(8,u,!0);let h=new Blob([l,a,s,o,r],{type:"application/octet-stream"}),p=new FileReader;p.readAsArrayBuffer(h),p.onloadend=function(){t(p.result)}}}else if(i.buffers&&i.buffers.length>0){let e=new FileReader;e.readAsDataURL(a),e.onloadend=function(){let n=e.result;i.buffers[0].uri=n,t(i)}}else t(i)}serializeUserData(e,t){if(0===Object.keys(e.userData).length)return;let n=this.options,r=this.extensionsUsed;try{let i=JSON.parse(JSON.stringify(e.userData));if(n.includeCustomExtensions&&i.gltfExtensions){for(let e in void 0===t.extensions&&(t.extensions={}),i.gltfExtensions)t.extensions[e]=i.gltfExtensions[e],r[e]=!0;delete i.gltfExtensions}Object.keys(i).length>0&&(t.extras=i)}catch(t){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+t.message)}}getUID(e,t=!1){if(!1===this.uids.has(e)){let t=new Map;t.set(!0,this.uid++),t.set(!1,this.uid++),this.uids.set(e,t)}return this.uids.get(e).get(t)}isNormalizedNormalAttribute(e){if(this.cache.attributesNormalized.has(e))return!1;let t=new r.Pq0;for(let n=0,r=e.count;n<r;n++)if(Math.abs(t.fromBufferAttribute(e,n).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(e){let t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);let n=e.clone(),i=new r.Pq0;for(let e=0,t=n.count;e<t;e++)i.fromBufferAttribute(n,e),0===i.x&&0===i.y&&0===i.z?i.setX(1):i.normalize(),n.setXYZ(e,i.x,i.y,i.z);return t.attributesNormalized.set(e,n),n}applyTextureTransform(e,t){let n=!1,r={};(0!==t.offset.x||0!==t.offset.y)&&(r.offset=t.offset.toArray(),n=!0),0!==t.rotation&&(r.rotation=t.rotation,n=!0),(1!==t.repeat.x||1!==t.repeat.y)&&(r.scale=t.repeat.toArray(),n=!0),n&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=r,this.extensionsUsed.KHR_texture_transform=!0)}async buildMetalRoughTextureAsync(e,t){if(e===t)return e;function n(e){return e.colorSpace===r.er$?function(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}:function(e){return e}}e instanceof r.FvD&&(e=await this.decompressTextureAsync(e)),t instanceof r.FvD&&(t=await this.decompressTextureAsync(t));let i=e?e.image:null,o=t?t.image:null,s=Math.max(i?i.width:0,o?o.width:0),a=Math.max(i?i.height:0,o?o.height:0),l=p();l.width=s,l.height=a;let c=l.getContext("2d",{willReadFrequently:!0});c.fillStyle="#00ffff",c.fillRect(0,0,s,a);let u=c.getImageData(0,0,s,a);if(i){c.drawImage(i,0,0,s,a);let t=n(e),r=c.getImageData(0,0,s,a).data;for(let e=2;e<r.length;e+=4)u.data[e]=256*t(r[e]/256)}if(o){c.drawImage(o,0,0,s,a);let e=n(t),r=c.getImageData(0,0,s,a).data;for(let t=1;t<r.length;t+=4)u.data[t]=256*e(r[t]/256)}c.putImageData(u,0,0);let h=(e||t).clone();return h.source=new r.kLi(l),h.colorSpace=r.jf0,h.channel=(e||t).channel,e&&t&&e.channel!==t.channel&&console.warn("THREE.GLTFExporter: UV channels for metalnessMap and roughnessMap textures must match."),console.warn("THREE.GLTFExporter: Merged metalnessMap and roughnessMap textures."),h}async decompressTextureAsync(e,t=1/0){if(null===this.textureUtils)throw Error("THREE.GLTFExporter: setTextureUtils() must be called to process compressed textures.");return await this.textureUtils.decompress(e,t)}processBuffer(e){let t=this.json,n=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),n.push(e),0}processBufferView(e,t,n,i,o){let s,a=this.json;switch(!a.bufferViews&&(a.bufferViews=[]),t){case 5120:case 5121:s=1;break;case 5122:case 5123:s=2;break;default:s=4}let l=e.itemSize*s;34962===o&&(l=4*Math.ceil(l/4));let c=h(i*l),u=new DataView(new ArrayBuffer(c)),f=0;for(let o=n;o<n+i;o++){for(let n=0;n<e.itemSize;n++){let i;e.itemSize>4?i=e.array[o*e.itemSize+n]:(0===n?i=e.getX(o):1===n?i=e.getY(o):2===n?i=e.getZ(o):3===n&&(i=e.getW(o)),!0===e.normalized&&(i=r.cj9.normalize(i,e.array))),5126===t?u.setFloat32(f,i,!0):5124===t?u.setInt32(f,i,!0):5125===t?u.setUint32(f,i,!0):5122===t?u.setInt16(f,i,!0):5123===t?u.setUint16(f,i,!0):5120===t?u.setInt8(f,i):5121===t&&u.setUint8(f,i),f+=s}f%l!=0&&(f+=l-f%l)}let p={buffer:this.processBuffer(u.buffer),byteOffset:this.byteOffset,byteLength:c};return void 0!==o&&(p.target=o),34962===o&&(p.byteStride=l),this.byteOffset+=c,a.bufferViews.push(p),{id:a.bufferViews.length-1,byteLength:0}}processBufferViewImage(e){let t=this,n=t.json;return n.bufferViews||(n.bufferViews=[]),new Promise(function(r){let i=new FileReader;i.readAsArrayBuffer(e),i.onloadend=function(){let e=f(i.result),o={buffer:t.processBuffer(e),byteOffset:t.byteOffset,byteLength:e.byteLength};t.byteOffset+=e.byteLength,r(n.bufferViews.push(o)-1)}})}processAccessor(e,t,n,i){let o,s,a=this.json;if(e.array.constructor===Float32Array)o=5126;else if(e.array.constructor===Int32Array)o=5124;else if(e.array.constructor===Uint32Array)o=5125;else if(e.array.constructor===Int16Array)o=5122;else if(e.array.constructor===Uint16Array)o=5123;else if(e.array.constructor===Int8Array)o=5120;else if(e.array.constructor===Uint8Array)o=5121;else throw Error("THREE.GLTFExporter: Unsupported bufferAttribute component type: "+e.array.constructor.name);if(void 0===n&&(n=0),(void 0===i||i===1/0)&&(i=e.count),0===i)return null;let l=function(e,t,n){let i={min:Array(e.itemSize).fill(1/0),max:Array(e.itemSize).fill(-1/0)};for(let o=t;o<t+n;o++)for(let t=0;t<e.itemSize;t++){let n;e.itemSize>4?n=e.array[o*e.itemSize+t]:(0===t?n=e.getX(o):1===t?n=e.getY(o):2===t?n=e.getZ(o):3===t&&(n=e.getW(o)),!0===e.normalized&&(n=r.cj9.normalize(n,e.array))),i.min[t]=Math.min(i.min[t],n),i.max[t]=Math.max(i.max[t],n)}return i}(e,n,i);void 0!==t&&(s=e===t.index?34963:34962);let c=this.processBufferView(e,o,n,i,s),u={bufferView:c.id,byteOffset:c.byteOffset,componentType:o,count:i,max:l.max,min:l.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",9:"MAT3",16:"MAT4"}[e.itemSize]};return!0===e.normalized&&(u.normalized=!0),a.accessors||(a.accessors=[]),a.accessors.push(u)-1}processImage(e,t,n,i="image/png"){if(null!==e){let o=this,s=o.cache,a=o.json,l=o.options,c=o.pending;s.images.has(e)||s.images.set(e,{});let u=s.images.get(e),h=i+":flipY/"+n.toString();if(void 0!==u[h])return u[h];a.images||(a.images=[]);let f={mimeType:i},d=p();d.width=Math.min(e.width,l.maxTextureSize),d.height=Math.min(e.height,l.maxTextureSize);let v=d.getContext("2d",{willReadFrequently:!0});if(!0===n&&(v.translate(0,d.height),v.scale(1,-1)),void 0!==e.data){t!==r.GWd&&console.error("GLTFExporter: Only RGBAFormat is supported.",t),(e.width>l.maxTextureSize||e.height>l.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",e);let n=new Uint8ClampedArray(e.height*e.width*4);for(let t=0;t<n.length;t+=4)n[t+0]=e.data[t+0],n[t+1]=e.data[t+1],n[t+2]=e.data[t+2],n[t+3]=e.data[t+3];v.putImageData(new ImageData(n,e.width,e.height),0,0)}else if("u">typeof HTMLImageElement&&e instanceof HTMLImageElement||"u">typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"u">typeof ImageBitmap&&e instanceof ImageBitmap||"u">typeof OffscreenCanvas&&e instanceof OffscreenCanvas)v.drawImage(e,0,0,d.width,d.height);else throw Error("THREE.GLTFExporter: Invalid image type. Use HTMLImageElement, HTMLCanvasElement, ImageBitmap or OffscreenCanvas.");!0===l.binary?c.push((function(e,t){if(!("u">typeof OffscreenCanvas&&e instanceof OffscreenCanvas))return new Promise(n=>e.toBlob(n,t));{let n;return"image/jpeg"===t?n=.92:"image/webp"===t&&(n=.8),e.convertToBlob({type:t,quality:n})}})(d,i).then(e=>o.processBufferViewImage(e)).then(e=>{f.bufferView=e})):f.uri=r.HgN.getDataURL(d,i);let y=a.images.push(f)-1;return u[h]=y,y}throw Error("THREE.GLTFExporter: No valid image data found. Unable to process texture.")}processSampler(e){let t=this.json;t.samplers||(t.samplers=[]);let n={magFilter:a[e.magFilter],minFilter:a[e.minFilter],wrapS:a[e.wrapS],wrapT:a[e.wrapT]};return t.samplers.push(n)-1}async processTextureAsync(e){let t=this.options,n=this.cache,i=this.json;if(n.textures.has(e))return n.textures.get(e);i.textures||(i.textures=[]),e instanceof r.FvD&&(e=await this.decompressTextureAsync(e,t.maxTextureSize));let o=e.userData.mimeType;"image/webp"===o&&(o="image/png");let s={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY,o)};e.name&&(s.name=e.name),await this._invokeAllAsync(async function(t){t.writeTexture&&await t.writeTexture(e,s)});let a=i.textures.push(s)-1;return n.textures.set(e,a),a}async processMaterialAsync(e){let t=this.cache,n=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;n.materials||(n.materials=[]);let i={pbrMetallicRoughness:{}};!0!==e.isMeshStandardMaterial&&!0!==e.isMeshBasicMaterial&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");let o=e.color.toArray().concat([e.opacity]);if(u(o,[1,1,1,1])||(i.pbrMetallicRoughness.baseColorFactor=o),e.isMeshStandardMaterial?(i.pbrMetallicRoughness.metallicFactor=e.metalness,i.pbrMetallicRoughness.roughnessFactor=e.roughness):(i.pbrMetallicRoughness.metallicFactor=0,i.pbrMetallicRoughness.roughnessFactor=1),e.metalnessMap||e.roughnessMap){let t=await this.buildMetalRoughTextureAsync(e.metalnessMap,e.roughnessMap),n={index:await this.processTextureAsync(t),texCoord:t.channel};this.applyTextureTransform(n,t),i.pbrMetallicRoughness.metallicRoughnessTexture=n}if(e.map){let t={index:await this.processTextureAsync(e.map),texCoord:e.map.channel};this.applyTextureTransform(t,e.map),i.pbrMetallicRoughness.baseColorTexture=t}if(e.emissive){let t=e.emissive;if(Math.max(t.r,t.g,t.b)>0&&(i.emissiveFactor=e.emissive.toArray()),e.emissiveMap){let t={index:await this.processTextureAsync(e.emissiveMap),texCoord:e.emissiveMap.channel};this.applyTextureTransform(t,e.emissiveMap),i.emissiveTexture=t}}if(e.normalMap){let t={index:await this.processTextureAsync(e.normalMap),texCoord:e.normalMap.channel};e.normalScale&&1!==e.normalScale.x&&(t.scale=e.normalScale.x),this.applyTextureTransform(t,e.normalMap),i.normalTexture=t}if(e.aoMap){let t={index:await this.processTextureAsync(e.aoMap),texCoord:e.aoMap.channel};1!==e.aoMapIntensity&&(t.strength=e.aoMapIntensity),this.applyTextureTransform(t,e.aoMap),i.occlusionTexture=t}e.transparent?i.alphaMode="BLEND":e.alphaTest>0&&(i.alphaMode="MASK",i.alphaCutoff=e.alphaTest),e.side===r.$EB&&(i.doubleSided=!0),""!==e.name&&(i.name=e.name),this.serializeUserData(e,i),await this._invokeAllAsync(async function(t){t.writeMaterialAsync&&await t.writeMaterialAsync(e,i)});let s=n.materials.push(i)-1;return t.materials.set(e,s),s}async processMeshAsync(e){let t,n=this.cache,i=this.json,s=[e.geometry.uuid];if(Array.isArray(e.material))for(let t=0,n=e.material.length;t<n;t++)s.push(e.material[t].uuid);else s.push(e.material.uuid);let a=s.join(":");if(n.meshes.has(a))return n.meshes.get(a);let l=e.geometry;t=e.isLineSegments?1:e.isLineLoop?2:e.isLine?3:e.isPoints?0:e.material.wireframe?1:4;let c={},u={},h=[],f=[],p={uv:"TEXCOORD_0",uv1:"TEXCOORD_1",uv2:"TEXCOORD_2",uv3:"TEXCOORD_3",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},d=l.getAttribute("normal");void 0===d||this.isNormalizedNormalAttribute(d)||(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),l.setAttribute("normal",this.createNormalizedNormalAttribute(d)));let v=null;for(let e in l.attributes){if("morph"===e.slice(0,5))continue;let t=l.attributes[e];if(e=p[e]||e.toUpperCase(),/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(e)||(e="_"+e),n.attributes.has(this.getUID(t))){u[e]=n.attributes.get(this.getUID(t));continue}v=null;let i=t.array;"JOINTS_0"!==e||i instanceof Uint16Array||i instanceof Uint8Array?(i instanceof Uint32Array||i instanceof Int32Array)&&!e.startsWith("_")&&(console.warn(`GLTFExporter: Attribute "${e}" converted to type FLOAT.`),v=o.Utils.toFloat32BufferAttribute(t)):(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),v=new r.THS(new Uint16Array(i),t.itemSize,t.normalized));let s=this.processAccessor(v||t,l);null!==s&&(e.startsWith("_")||this.detectMeshQuantization(e,t),u[e]=s,n.attributes.set(this.getUID(t),s))}if(void 0!==d&&l.setAttribute("normal",d),0===Object.keys(u).length)return null;if(void 0!==e.morphTargetInfluences&&e.morphTargetInfluences.length>0){let t=[],r=[],i={};if(void 0!==e.morphTargetDictionary)for(let t in e.morphTargetDictionary)i[e.morphTargetDictionary[t]]=t;for(let o=0;o<e.morphTargetInfluences.length;++o){let s={},a=!1;for(let e in l.morphAttributes){if("position"!==e&&"normal"!==e){a||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),a=!0);continue}let t=l.morphAttributes[e][o],r=e.toUpperCase(),i=l.attributes[e];if(n.attributes.has(this.getUID(t,!0))){s[r]=n.attributes.get(this.getUID(t,!0));continue}let c=t.clone();if(!l.morphTargetsRelative)for(let e=0,n=t.count;e<n;e++)for(let n=0;n<t.itemSize;n++)0===n&&c.setX(e,t.getX(e)-i.getX(e)),1===n&&c.setY(e,t.getY(e)-i.getY(e)),2===n&&c.setZ(e,t.getZ(e)-i.getZ(e)),3===n&&c.setW(e,t.getW(e)-i.getW(e));s[r]=this.processAccessor(c,l),n.attributes.set(this.getUID(i,!0),s[r])}f.push(s),t.push(e.morphTargetInfluences[o]),void 0!==e.morphTargetDictionary&&r.push(i[o])}c.weights=t,r.length>0&&(c.extras={},c.extras.targetNames=r)}let y=Array.isArray(e.material);if(y&&0===l.groups.length)return null;let m=!1;if(y&&null===l.index){let e=[];for(let t=0,n=l.attributes.position.count;t<n;t++)e[t]=t;l.setIndex(e),m=!0}let b=y?e.material:[e.material],g=y?l.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let e=0,r=g.length;e<r;e++){let r={mode:t,attributes:u};if(this.serializeUserData(l,r),f.length>0&&(r.targets=f),null!==l.index){let t=this.getUID(l.index);(void 0!==g[e].start||void 0!==g[e].count)&&(t+=":"+g[e].start+":"+g[e].count),n.attributes.has(t)?r.indices=n.attributes.get(t):(r.indices=this.processAccessor(l.index,l,g[e].start,g[e].count),n.attributes.set(t,r.indices)),null===r.indices&&delete r.indices}let i=await this.processMaterialAsync(b[g[e].materialIndex]);null!==i&&(r.material=i),h.push(r)}!0===m&&l.setIndex(null),c.primitives=h,i.meshes||(i.meshes=[]),await this._invokeAllAsync(function(t){t.writeMesh&&t.writeMesh(e,c)});let w=i.meshes.push(c)-1;return n.meshes.set(a,w),w}detectMeshQuantization(e,t){let n;if(this.extensionsUsed[s])return;switch(t.array.constructor){case Int8Array:n="byte";break;case Uint8Array:n="unsigned byte";break;case Int16Array:n="short";break;case Uint16Array:n="unsigned short";break;default:return}t.normalized&&(n+=" normalized");let r=e.split("_",1)[0];i[r]&&i[r].includes(n)&&(this.extensionsUsed[s]=!0,this.extensionsRequired[s]=!0)}processCamera(e){let t=this.json;t.cameras||(t.cameras=[]);let n=e.isOrthographicCamera,i={type:n?"orthographic":"perspective"};return n?i.orthographic={xmag:2*e.right,ymag:2*e.top,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:i.perspective={aspectRatio:e.aspect,yfov:r.cj9.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},""!==e.name&&(i.name=e.type),t.cameras.push(i)-1}processAnimation(e,t){let n=this.json,i=this.nodeMap;n.animations||(n.animations=[]);let s=(e=o.Utils.mergeMorphTargetTracks(e.clone(),t)).tracks,a=[],c=[];for(let e=0;e<s.length;++e){let n,o=s[e],u=r.Nwf.parseTrackName(o.name),h=r.Nwf.findNode(t,u.nodeName),f=l[u.propertyName];if("bones"===u.objectName&&(h=!0===h.isSkinnedMesh?h.skeleton.getBoneByName(u.objectIndex):void 0),!h||!f){console.warn('THREE.GLTFExporter: Could not export animation track "%s".',o.name);continue}let p=o.values.length/o.times.length;f===l.morphTargetInfluences&&(p/=h.morphTargetInfluences.length),!0===o.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(n="CUBICSPLINE",p/=3):n=o.getInterpolation()===r.ljd?"STEP":"LINEAR",c.push({input:this.processAccessor(new r.THS(o.times,1)),output:this.processAccessor(new r.THS(o.values,p)),interpolation:n}),a.push({sampler:c.length-1,target:{node:i.get(h),path:f}})}let u={name:e.name||"clip_"+n.animations.length,samplers:c,channels:a};return this.serializeUserData(e,u),n.animations.push(u),n.animations.length-1}processSkin(e){let t=this.json,n=this.nodeMap,i=t.nodes[n.get(e)],o=e.skeleton;if(void 0===o)return null;let s=e.skeleton.bones[0];if(void 0===s)return null;let a=[],l=new Float32Array(16*o.bones.length),c=new r.kn4;for(let t=0;t<o.bones.length;++t)a.push(n.get(o.bones[t])),c.copy(o.boneInverses[t]),c.multiply(e.bindMatrix).toArray(l,16*t);return void 0===t.skins&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new r.THS(l,16)),joints:a,skeleton:n.get(s)}),i.skin=t.skins.length-1}async processNodeAsync(e){let t=this.json,n=this.options,r=this.nodeMap;t.nodes||(t.nodes=[]);let i={};if(n.trs){let t=e.quaternion.toArray(),n=e.position.toArray(),r=e.scale.toArray();u(t,[0,0,0,1])||(i.rotation=t),u(n,[0,0,0])||(i.translation=n),u(r,[1,1,1])||(i.scale=r)}else e.matrixAutoUpdate&&e.updateMatrix(),!1===u(e.matrix.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])&&(i.matrix=e.matrix.elements);if(""!==e.name&&(i.name=String(e.name)),this.serializeUserData(e,i),e.isMesh||e.isLine||e.isPoints){let t=await this.processMeshAsync(e);null!==t&&(i.mesh=t)}else e.isCamera&&(i.camera=this.processCamera(e));e.isSkinnedMesh&&this.skins.push(e);let o=t.nodes.push(i)-1;if(r.set(e,o),e.children.length>0){let t=[];for(let r=0,i=e.children.length;r<i;r++){let i=e.children[r];if(i.visible||!1===n.onlyVisible){let e=await this.processNodeAsync(i);null!==e&&t.push(e)}}t.length>0&&(i.children=t)}return await this._invokeAllAsync(function(t){t.writeNode&&t.writeNode(e,i)}),o}async processSceneAsync(e){let t=this.json,n=this.options;t.scenes||(t.scenes=[],t.scene=0);let r={};""!==e.name&&(r.name=e.name),t.scenes.push(r);let i=[];for(let t=0,r=e.children.length;t<r;t++){let r=e.children[t];if(r.visible||!1===n.onlyVisible){let e=await this.processNodeAsync(r);null!==e&&i.push(e)}}i.length>0&&(r.nodes=i),this.serializeUserData(e,r)}async processObjectsAsync(e){let t=new r.Z58;t.name="AuxScene";for(let n=0;n<e.length;n++)t.children.push(e[n]);await this.processSceneAsync(t)}async processInputAsync(e){let t=this.options;e=e instanceof Array?e:[e],await this._invokeAllAsync(function(t){t.beforeParse&&t.beforeParse(e)});let n=[];for(let t=0;t<e.length;t++)e[t]instanceof r.Z58?await this.processSceneAsync(e[t]):n.push(e[t]);n.length>0&&await this.processObjectsAsync(n);for(let e=0;e<this.skins.length;++e)this.processSkin(this.skins[e]);for(let n=0;n<t.animations.length;++n)this.processAnimation(t.animations[n],e[0]);await this._invokeAllAsync(function(t){t.afterParse&&t.afterParse(e)})}async _invokeAllAsync(e){for(let t=0,n=this.plugins.length;t<n;t++)await e(this.plugins[t])}}class v{constructor(e){this.writer=e,this.name="KHR_lights_punctual"}writeNode(e,t){if(!e.isLight)return;if(!e.isDirectionalLight&&!e.isPointLight&&!e.isSpotLight)return void console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e);let n=this.writer,r=n.json,i=n.extensionsUsed,o={};e.name&&(o.name=e.name),o.color=e.color.toArray(),o.intensity=e.intensity,e.isDirectionalLight?o.type="directional":e.isPointLight?(o.type="point",e.distance>0&&(o.range=e.distance)):e.isSpotLight&&(o.type="spot",e.distance>0&&(o.range=e.distance),o.spot={},o.spot.innerConeAngle=(1-e.penumbra)*e.angle,o.spot.outerConeAngle=e.angle),void 0!==e.decay&&2!==e.decay&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),e.target&&(e.target.parent!==e||0!==e.target.position.x||0!==e.target.position.y||-1!==e.target.position.z)&&console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),i[this.name]||(r.extensions=r.extensions||{},r.extensions[this.name]={lights:[]},i[this.name]=!0);let s=r.extensions[this.name].lights;s.push(o),t.extensions=t.extensions||{},t.extensions[this.name]={light:s.length-1}}}class y{constructor(e){this.writer=e,this.name="KHR_materials_unlit"}async writeMaterialAsync(e,t){if(!e.isMeshBasicMaterial)return;let n=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},n[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}}class m{constructor(e){this.writer=e,this.name="KHR_materials_clearcoat"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.clearcoat)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.clearcoatFactor=e.clearcoat,e.clearcoatMap){let t={index:await n.processTextureAsync(e.clearcoatMap),texCoord:e.clearcoatMap.channel};n.applyTextureTransform(t,e.clearcoatMap),i.clearcoatTexture=t}if(i.clearcoatRoughnessFactor=e.clearcoatRoughness,e.clearcoatRoughnessMap){let t={index:await n.processTextureAsync(e.clearcoatRoughnessMap),texCoord:e.clearcoatRoughnessMap.channel};n.applyTextureTransform(t,e.clearcoatRoughnessMap),i.clearcoatRoughnessTexture=t}if(e.clearcoatNormalMap){let t={index:await n.processTextureAsync(e.clearcoatNormalMap),texCoord:e.clearcoatNormalMap.channel};1!==e.clearcoatNormalScale.x&&(t.scale=e.clearcoatNormalScale.x),n.applyTextureTransform(t,e.clearcoatNormalMap),i.clearcoatNormalTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class b{constructor(e){this.writer=e,this.name="KHR_materials_dispersion"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.dispersion)return;let n=this.writer.extensionsUsed,r={};r.dispersion=e.dispersion,t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class g{constructor(e){this.writer=e,this.name="KHR_materials_iridescence"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.iridescence)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.iridescenceFactor=e.iridescence,e.iridescenceMap){let t={index:await n.processTextureAsync(e.iridescenceMap),texCoord:e.iridescenceMap.channel};n.applyTextureTransform(t,e.iridescenceMap),i.iridescenceTexture=t}if(i.iridescenceIor=e.iridescenceIOR,i.iridescenceThicknessMinimum=e.iridescenceThicknessRange[0],i.iridescenceThicknessMaximum=e.iridescenceThicknessRange[1],e.iridescenceThicknessMap){let t={index:await n.processTextureAsync(e.iridescenceThicknessMap),texCoord:e.iridescenceThicknessMap.channel};n.applyTextureTransform(t,e.iridescenceThicknessMap),i.iridescenceThicknessTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class w{constructor(e){this.writer=e,this.name="KHR_materials_transmission"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.transmissionFactor=e.transmission,e.transmissionMap){let t={index:await n.processTextureAsync(e.transmissionMap),texCoord:e.transmissionMap.channel};n.applyTextureTransform(t,e.transmissionMap),i.transmissionTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class k{constructor(e){this.writer=e,this.name="KHR_materials_volume"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.thicknessFactor=e.thickness,e.thicknessMap){let t={index:await n.processTextureAsync(e.thicknessMap),texCoord:e.thicknessMap.channel};n.applyTextureTransform(t,e.thicknessMap),i.thicknessTexture=t}e.attenuationDistance!==1/0&&(i.attenuationDistance=e.attenuationDistance),i.attenuationColor=e.attenuationColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class T{constructor(e){this.writer=e,this.name="KHR_materials_ior"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||1.5===e.ior)return;let n=this.writer.extensionsUsed,r={};r.ior=e.ior,t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class x{constructor(e){this.writer=e,this.name="KHR_materials_specular"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||1===e.specularIntensity&&e.specularColor.equals(c)&&!e.specularIntensityMap&&!e.specularColorMap)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.specularIntensityMap){let t={index:await n.processTextureAsync(e.specularIntensityMap),texCoord:e.specularIntensityMap.channel};n.applyTextureTransform(t,e.specularIntensityMap),i.specularTexture=t}if(e.specularColorMap){let t={index:await n.processTextureAsync(e.specularColorMap),texCoord:e.specularColorMap.channel};n.applyTextureTransform(t,e.specularColorMap),i.specularColorTexture=t}i.specularFactor=e.specularIntensity,i.specularColorFactor=e.specularColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class P{constructor(e){this.writer=e,this.name="KHR_materials_sheen"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0==e.sheen)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.sheenRoughnessMap){let t={index:await n.processTextureAsync(e.sheenRoughnessMap),texCoord:e.sheenRoughnessMap.channel};n.applyTextureTransform(t,e.sheenRoughnessMap),i.sheenRoughnessTexture=t}if(e.sheenColorMap){let t={index:await n.processTextureAsync(e.sheenColorMap),texCoord:e.sheenColorMap.channel};n.applyTextureTransform(t,e.sheenColorMap),i.sheenColorTexture=t}i.sheenRoughnessFactor=e.sheenRoughness,i.sheenColorFactor=e.sheenColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class S{constructor(e){this.writer=e,this.name="KHR_materials_anisotropy"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0==e.anisotropy)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.anisotropyMap){let t={index:await n.processTextureAsync(e.anisotropyMap)};n.applyTextureTransform(t,e.anisotropyMap),i.anisotropyTexture=t}i.anisotropyStrength=e.anisotropy,i.anisotropyRotation=e.anisotropyRotation,t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class O{constructor(e){this.writer=e,this.name="KHR_materials_emissive_strength"}async writeMaterialAsync(e,t){if(!e.isMeshStandardMaterial||1===e.emissiveIntensity)return;let n=this.writer.extensionsUsed,r={};r.emissiveStrength=e.emissiveIntensity,t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class R{constructor(e){this.writer=e,this.name="EXT_materials_bump"}async writeMaterialAsync(e,t){if(!e.isMeshStandardMaterial||1===e.bumpScale&&!e.bumpMap)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.bumpMap){let t={index:await n.processTextureAsync(e.bumpMap),texCoord:e.bumpMap.channel};n.applyTextureTransform(t,e.bumpMap),i.bumpTexture=t}i.bumpFactor=e.bumpScale,t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class E{constructor(e){this.writer=e,this.name="EXT_mesh_gpu_instancing"}writeNode(e,t){if(!e.isInstancedMesh)return;let n=this.writer,i=new Float32Array(3*e.count),o=new Float32Array(4*e.count),s=new Float32Array(3*e.count),a=new r.kn4,l=new r.Pq0,c=new r.PTz,u=new r.Pq0;for(let t=0;t<e.count;t++)e.getMatrixAt(t,a),a.decompose(l,c,u),l.toArray(i,3*t),c.toArray(o,4*t),u.toArray(s,3*t);let h={TRANSLATION:n.processAccessor(new r.THS(i,3)),ROTATION:n.processAccessor(new r.THS(o,4)),SCALE:n.processAccessor(new r.THS(s,3))};e.instanceColor&&(h._COLOR_0=n.processAccessor(e.instanceColor)),t.extensions=t.extensions||{},t.extensions[this.name]={attributes:h},n.extensionsUsed[this.name]=!0,n.extensionsRequired[this.name]=!0}}function A(e,t){if(t===r.RJ4)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(t!==r.rYR&&t!==r.O49)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),e;{let n=e.getIndex();if(null===n){let t=[],r=e.getAttribute("position");if(void 0===r)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<r.count;e++)t.push(e);e.setIndex(t),n=e.getIndex()}let i=n.count-2,o=[];if(t===r.rYR)for(let e=1;e<=i;e++)o.push(n.getX(0)),o.push(n.getX(e)),o.push(n.getX(e+1));else for(let e=0;e<i;e++)e%2==0?(o.push(n.getX(e)),o.push(n.getX(e+1)),o.push(n.getX(e+2))):(o.push(n.getX(e+2)),o.push(n.getX(e+1)),o.push(n.getX(e)));o.length/3!==i&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");let s=e.clone();return s.setIndex(o),s.clearGroups(),s}}o.Utils={insertKeyframe:function(e,t){let n,r=e.getValueSize(),i=new e.TimeBufferType(e.times.length+1),o=new e.ValueBufferType(e.values.length+r),s=e.createInterpolant(new e.ValueBufferType(r));if(0===e.times.length){i[0]=t;for(let e=0;e<r;e++)o[e]=0;n=0}else if(t<e.times[0]){if(.001>Math.abs(e.times[0]-t))return 0;i[0]=t,i.set(e.times,1),o.set(s.evaluate(t),0),o.set(e.values,r),n=0}else if(t>e.times[e.times.length-1]){if(.001>Math.abs(e.times[e.times.length-1]-t))return e.times.length-1;i[i.length-1]=t,i.set(e.times,0),o.set(e.values,0),o.set(s.evaluate(t),e.values.length),n=i.length-1}else for(let a=0;a<e.times.length;a++){if(.001>Math.abs(e.times[a]-t))return a;if(e.times[a]<t&&e.times[a+1]>t){i.set(e.times.slice(0,a+1),0),i[a+1]=t,i.set(e.times.slice(a+1),a+2),o.set(e.values.slice(0,(a+1)*r),0),o.set(s.evaluate(t),(a+1)*r),o.set(e.values.slice((a+1)*r),(a+2)*r),n=a+1;break}}return e.times=i,e.values=o,n},mergeMorphTargetTracks:function(e,t){let n=[],i={},o=e.tracks;for(let e=0;e<o.length;++e){let s,a=o[e],l=r.Nwf.parseTrackName(a.name),c=r.Nwf.findNode(t,l.nodeName);if("morphTargetInfluences"!==l.propertyName||void 0===l.propertyIndex){n.push(a);continue}if(a.createInterpolant!==a.InterpolantFactoryMethodDiscrete&&a.createInterpolant!==a.InterpolantFactoryMethodLinear){if(a.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),(a=a.clone()).setInterpolation(r.PJ3)}let u=c.morphTargetInfluences.length,h=c.morphTargetDictionary[l.propertyIndex];if(void 0===h)throw Error("THREE.GLTFExporter: Morph target name not found: "+l.propertyIndex);if(void 0===i[c.uuid]){let e=new(s=a.clone()).ValueBufferType(u*s.times.length);for(let t=0;t<s.times.length;t++)e[t*u+h]=s.values[t];s.name=(l.nodeName||"")+".morphTargetInfluences",s.values=e,i[c.uuid]=s,n.push(s);continue}let f=a.createInterpolant(new a.ValueBufferType(1));s=i[c.uuid];for(let e=0;e<s.times.length;e++)s.values[e*u+h]=f.evaluate(s.times[e]);for(let e=0;e<a.times.length;e++){let t=this.insertKeyframe(s,a.times[e]);s.values[t*u+h]=a.values[e]}}return e.tracks=n,e},toFloat32BufferAttribute:function(e){let t=new r.THS(new Float32Array(e.count*e.itemSize),e.itemSize,!1);if(!e.normalized&&!e.isInterleavedBufferAttribute)return t.array.set(e.array),t;for(let n=0,r=e.count;n<r;n++)for(let r=0;r<e.itemSize;r++)t.setComponent(n,r,e.getComponent(n,r));return t}};class M extends r.aHM{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(e){return new B(e)}),this.register(function(e){return new N(e)}),this.register(function(e){return new K(e)}),this.register(function(e){return new X(e)}),this.register(function(e){return new W(e)}),this.register(function(e){return new H(e)}),this.register(function(e){return new U(e)}),this.register(function(e){return new D(e)}),this.register(function(e){return new z(e)}),this.register(function(e){return new L(e)}),this.register(function(e){return new G(e)}),this.register(function(e){return new F(e)}),this.register(function(e){return new q(e)}),this.register(function(e){return new V(e)}),this.register(function(e){return new I(e)}),this.register(function(e){return new Y(e)}),this.register(function(e){return new J(e)})}load(e,t,n,i){let o,s=this;if(""!==this.resourcePath)o=this.resourcePath;else if(""!==this.path){let t=r.r6x.extractUrlBase(e);o=r.r6x.resolveURL(t,this.path)}else o=r.r6x.extractUrlBase(e);this.manager.itemStart(e);let a=function(t){i?i(t):console.error(t),s.manager.itemError(e),s.manager.itemEnd(e)},l=new r.Y9S(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials),l.load(e,function(n){try{s.parse(n,o,function(n){t(n),s.manager.itemEnd(e)},a)}catch(e){a(e)}},n,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return -1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return -1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,n,r){let i,o={},s={},a=new TextDecoder;if("string"==typeof e)i=JSON.parse(e);else if(e instanceof ArrayBuffer)if(a.decode(new Uint8Array(e,0,4))===Z){try{o[C.KHR_BINARY_GLTF]=new Q(e)}catch(e){r&&r(e);return}i=JSON.parse(o[C.KHR_BINARY_GLTF].content)}else i=JSON.parse(a.decode(e));else i=e;if(void 0===i.asset||i.asset.version[0]<2){r&&r(Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}let l=new eb(i,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){let t=this.pluginCallbacks[e](l);t.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),s[t.name]=t,o[t.name]=!0}if(i.extensionsUsed)for(let e=0;e<i.extensionsUsed.length;++e){let t=i.extensionsUsed[e],n=i.extensionsRequired||[];switch(t){case C.KHR_MATERIALS_UNLIT:o[t]=new j;break;case C.KHR_DRACO_MESH_COMPRESSION:o[t]=new $(i,this.dracoLoader);break;case C.KHR_TEXTURE_TRANSFORM:o[t]=new ee;break;case C.KHR_MESH_QUANTIZATION:o[t]=new et;break;default:n.indexOf(t)>=0&&void 0===s[t]&&console.warn('THREE.GLTFLoader: Unknown extension "'+t+'".')}}l.setExtensions(o),l.setPlugins(s),l.parse(n,r)}parseAsync(e,t){let n=this;return new Promise(function(r,i){n.parse(e,t,r,i)})}}function _(){let e={};return{get:function(t){return e[t]},add:function(t,n){e[t]=n},remove:function(t){delete e[t]},removeAll:function(){e={}}}}let C={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class I{constructor(e){this.parser=e,this.name=C.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){let e=this.parser,t=this.parser.json.nodes||[];for(let n=0,r=t.length;n<r;n++){let r=t[n];r.extensions&&r.extensions[this.name]&&void 0!==r.extensions[this.name].light&&e._addNodeRef(this.cache,r.extensions[this.name].light)}}_loadLight(e){let t,n=this.parser,i="light:"+e,o=n.cache.get(i);if(o)return o;let s=n.json,a=((s.extensions&&s.extensions[this.name]||{}).lights||[])[e],l=new r.Q1f(0xffffff);void 0!==a.color&&l.setRGB(a.color[0],a.color[1],a.color[2],r.Zr2);let c=void 0!==a.range?a.range:0;switch(a.type){case"directional":(t=new r.ZyN(l)).target.position.set(0,0,-1),t.add(t.target);break;case"point":(t=new r.HiM(l)).distance=c;break;case"spot":(t=new r.nCl(l)).distance=c,a.spot=a.spot||{},a.spot.innerConeAngle=void 0!==a.spot.innerConeAngle?a.spot.innerConeAngle:0,a.spot.outerConeAngle=void 0!==a.spot.outerConeAngle?a.spot.outerConeAngle:Math.PI/4,t.angle=a.spot.outerConeAngle,t.penumbra=1-a.spot.innerConeAngle/a.spot.outerConeAngle,t.target.position.set(0,0,-1),t.add(t.target);break;default:throw Error("THREE.GLTFLoader: Unexpected light type: "+a.type)}return t.position.set(0,0,0),ed(t,a),void 0!==a.intensity&&(t.intensity=a.intensity),t.name=n.createUniqueName(a.name||"light_"+e),o=Promise.resolve(t),n.cache.add(i,o),o}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){let t=this,n=this.parser,r=n.json.nodes[e],i=(r.extensions&&r.extensions[this.name]||{}).light;return void 0===i?null:this._loadLight(i).then(function(e){return n._getNodeRef(t.cache,i,e)})}}class j{constructor(){this.name=C.KHR_MATERIALS_UNLIT}getMaterialType(){return r.V9B}extendParams(e,t,n){let i=[];e.color=new r.Q1f(1,1,1),e.opacity=1;let o=t.pbrMetallicRoughness;if(o){if(Array.isArray(o.baseColorFactor)){let t=o.baseColorFactor;e.color.setRGB(t[0],t[1],t[2],r.Zr2),e.opacity=t[3]}void 0!==o.baseColorTexture&&i.push(n.assignTexture(e,"map",o.baseColorTexture,r.er$))}return Promise.all(i)}}class L{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){let n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=n.extensions[this.name].emissiveStrength;return void 0!==r&&(t.emissiveIntensity=r),Promise.resolve()}}class B{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let o=[],s=i.extensions[this.name];if(void 0!==s.clearcoatFactor&&(t.clearcoat=s.clearcoatFactor),void 0!==s.clearcoatTexture&&o.push(n.assignTexture(t,"clearcoatMap",s.clearcoatTexture)),void 0!==s.clearcoatRoughnessFactor&&(t.clearcoatRoughness=s.clearcoatRoughnessFactor),void 0!==s.clearcoatRoughnessTexture&&o.push(n.assignTexture(t,"clearcoatRoughnessMap",s.clearcoatRoughnessTexture)),void 0!==s.clearcoatNormalTexture&&(o.push(n.assignTexture(t,"clearcoatNormalMap",s.clearcoatNormalTexture)),void 0!==s.clearcoatNormalTexture.scale)){let e=s.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new r.I9Y(e,e)}return Promise.all(o)}}class N{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_DISPERSION}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=n.extensions[this.name];return t.dispersion=void 0!==r.dispersion?r.dispersion:0,Promise.resolve()}}class F{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],o=r.extensions[this.name];return void 0!==o.iridescenceFactor&&(t.iridescence=o.iridescenceFactor),void 0!==o.iridescenceTexture&&i.push(n.assignTexture(t,"iridescenceMap",o.iridescenceTexture)),void 0!==o.iridescenceIor&&(t.iridescenceIOR=o.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==o.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),void 0!==o.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),void 0!==o.iridescenceThicknessTexture&&i.push(n.assignTexture(t,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(i)}}class H{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_SHEEN}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let o=[];t.sheenColor=new r.Q1f(0,0,0),t.sheenRoughness=0,t.sheen=1;let s=i.extensions[this.name];if(void 0!==s.sheenColorFactor){let e=s.sheenColorFactor;t.sheenColor.setRGB(e[0],e[1],e[2],r.Zr2)}return void 0!==s.sheenRoughnessFactor&&(t.sheenRoughness=s.sheenRoughnessFactor),void 0!==s.sheenColorTexture&&o.push(n.assignTexture(t,"sheenColorMap",s.sheenColorTexture,r.er$)),void 0!==s.sheenRoughnessTexture&&o.push(n.assignTexture(t,"sheenRoughnessMap",s.sheenRoughnessTexture)),Promise.all(o)}}class U{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],o=r.extensions[this.name];return void 0!==o.transmissionFactor&&(t.transmission=o.transmissionFactor),void 0!==o.transmissionTexture&&i.push(n.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(i)}}class D{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_VOLUME}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let o=[],s=i.extensions[this.name];t.thickness=void 0!==s.thicknessFactor?s.thicknessFactor:0,void 0!==s.thicknessTexture&&o.push(n.assignTexture(t,"thicknessMap",s.thicknessTexture)),t.attenuationDistance=s.attenuationDistance||1/0;let a=s.attenuationColor||[1,1,1];return t.attenuationColor=new r.Q1f().setRGB(a[0],a[1],a[2],r.Zr2),Promise.all(o)}}class z{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_IOR}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=n.extensions[this.name];return t.ior=void 0!==r.ior?r.ior:1.5,Promise.resolve()}}class G{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_SPECULAR}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let o=[],s=i.extensions[this.name];t.specularIntensity=void 0!==s.specularFactor?s.specularFactor:1,void 0!==s.specularTexture&&o.push(n.assignTexture(t,"specularIntensityMap",s.specularTexture));let a=s.specularColorFactor||[1,1,1];return t.specularColor=new r.Q1f().setRGB(a[0],a[1],a[2],r.Zr2),void 0!==s.specularColorTexture&&o.push(n.assignTexture(t,"specularColorMap",s.specularColorTexture,r.er$)),Promise.all(o)}}class V{constructor(e){this.parser=e,this.name=C.EXT_MATERIALS_BUMP}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],o=r.extensions[this.name];return t.bumpScale=void 0!==o.bumpFactor?o.bumpFactor:1,void 0!==o.bumpTexture&&i.push(n.assignTexture(t,"bumpMap",o.bumpTexture)),Promise.all(i)}}class q{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],o=r.extensions[this.name];return void 0!==o.anisotropyStrength&&(t.anisotropy=o.anisotropyStrength),void 0!==o.anisotropyRotation&&(t.anisotropyRotation=o.anisotropyRotation),void 0!==o.anisotropyTexture&&i.push(n.assignTexture(t,"anisotropyMap",o.anisotropyTexture)),Promise.all(i)}}class K{constructor(e){this.parser=e,this.name=C.KHR_TEXTURE_BASISU}loadTexture(e){let t=this.parser,n=t.json,r=n.textures[e];if(!r.extensions||!r.extensions[this.name])return null;let i=r.extensions[this.name],o=t.options.ktx2Loader;if(!o)if(!(n.extensionsRequired&&n.extensionsRequired.indexOf(this.name)>=0))return null;else throw Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return t.loadTextureImage(e,i.source,o)}}class X{constructor(e){this.parser=e,this.name=C.EXT_TEXTURE_WEBP}loadTexture(e){let t=this.name,n=this.parser,r=n.json,i=r.textures[e];if(!i.extensions||!i.extensions[t])return null;let o=i.extensions[t],s=r.images[o.source],a=n.textureLoader;if(s.uri){let e=n.options.manager.getHandler(s.uri);null!==e&&(a=e)}return n.loadTextureImage(e,o.source,a)}}class W{constructor(e){this.parser=e,this.name=C.EXT_TEXTURE_AVIF}loadTexture(e){let t=this.name,n=this.parser,r=n.json,i=r.textures[e];if(!i.extensions||!i.extensions[t])return null;let o=i.extensions[t],s=r.images[o.source],a=n.textureLoader;if(s.uri){let e=n.options.manager.getHandler(s.uri);null!==e&&(a=e)}return n.loadTextureImage(e,o.source,a)}}class Y{constructor(e){this.name=C.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){let t=this.parser.json,n=t.bufferViews[e];if(!n.extensions||!n.extensions[this.name])return null;{let e=n.extensions[this.name],r=this.parser.getDependency("buffer",e.buffer),i=this.parser.options.meshoptDecoder;if(!i||!i.supported)if(!(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0))return null;else throw Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return r.then(function(t){let n=e.byteOffset||0,r=e.byteLength||0,o=e.count,s=e.byteStride,a=new Uint8Array(t,n,r);return i.decodeGltfBufferAsync?i.decodeGltfBufferAsync(o,s,a,e.mode,e.filter).then(function(e){return e.buffer}):i.ready.then(function(){let t=new ArrayBuffer(o*s);return i.decodeGltfBuffer(new Uint8Array(t),o,s,a,e.mode,e.filter),t})})}}}class J{constructor(e){this.name=C.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){let t=this.parser.json,n=t.nodes[e];if(!n.extensions||!n.extensions[this.name]||void 0===n.mesh)return null;for(let e of t.meshes[n.mesh].primitives)if(e.mode!==eo.TRIANGLES&&e.mode!==eo.TRIANGLE_STRIP&&e.mode!==eo.TRIANGLE_FAN&&void 0!==e.mode)return null;let i=n.extensions[this.name].attributes,o=[],s={};for(let e in i)o.push(this.parser.getDependency("accessor",i[e]).then(t=>(s[e]=t,s[e])));return o.length<1?null:(o.push(this.parser.createNodeMesh(e)),Promise.all(o).then(e=>{let t=e.pop(),n=t.isGroup?t.children:[t],i=e[0].count,o=[];for(let e of n){let t=new r.kn4,n=new r.Pq0,a=new r.PTz,l=new r.Pq0(1,1,1),c=new r.ZLX(e.geometry,e.material,i);for(let e=0;e<i;e++)s.TRANSLATION&&n.fromBufferAttribute(s.TRANSLATION,e),s.ROTATION&&a.fromBufferAttribute(s.ROTATION,e),s.SCALE&&l.fromBufferAttribute(s.SCALE,e),c.setMatrixAt(e,t.compose(n,a,l));for(let t in s)if("_COLOR_0"===t){let e=s[t];c.instanceColor=new r.uWO(e.array,e.itemSize,e.normalized)}else"TRANSLATION"!==t&&"ROTATION"!==t&&"SCALE"!==t&&e.geometry.setAttribute(t,s[t]);r.B69.prototype.copy.call(c,e),this.parser.assignFinalMaterial(c),o.push(c)}return t.isGroup?(t.clear(),t.add(...o),t):o[0]}))}}let Z="glTF";class Q{constructor(e){this.name=C.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12),n=new TextDecoder;if(this.header={magic:n.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Z)throw Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw Error("THREE.GLTFLoader: Legacy binary file detected.");const r=this.header.length-12,i=new DataView(e,12);let o=0;for(;o<r;){const t=i.getUint32(o,!0);o+=4;const r=i.getUint32(o,!0);if(o+=4,0x4e4f534a===r){const r=new Uint8Array(e,12+o,t);this.content=n.decode(r)}else if(5130562===r){const n=12+o;this.body=e.slice(n,n+t)}o+=t}if(null===this.content)throw Error("THREE.GLTFLoader: JSON content not found.")}}class ${constructor(e,t){if(!t)throw Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=C.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){let n=this.json,i=this.dracoLoader,o=e.extensions[this.name].bufferView,s=e.extensions[this.name].attributes,a={},l={},c={};for(let e in s)a[eu[e]||e.toLowerCase()]=s[e];for(let t in e.attributes){let r=eu[t]||t.toLowerCase();if(void 0!==s[t]){let i=n.accessors[e.attributes[t]],o=es[i.componentType];c[r]=o.name,l[r]=!0===i.normalized}}return t.getDependency("bufferView",o).then(function(e){return new Promise(function(t,n){i.decodeDracoFile(e,function(e){for(let t in e.attributes){let n=e.attributes[t],r=l[t];void 0!==r&&(n.normalized=r)}t(e)},a,c,r.Zr2,n)})})}}class ee{constructor(){this.name=C.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(void 0===t.texCoord||t.texCoord===e.channel)&&void 0===t.offset&&void 0===t.rotation&&void 0===t.scale||(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class et{constructor(){this.name=C.KHR_MESH_QUANTIZATION}}class en extends r.lGw{constructor(e,t,n,r){super(e,t,n,r)}copySampleValue_(e){let t=this.resultBuffer,n=this.sampleValues,r=this.valueSize,i=e*r*3+r;for(let e=0;e!==r;e++)t[e]=n[i+e];return t}interpolate_(e,t,n,r){let i=this.resultBuffer,o=this.sampleValues,s=this.valueSize,a=2*s,l=3*s,c=r-t,u=(n-t)/c,h=u*u,f=h*u,p=e*l,d=p-l,v=-2*f+3*h,y=f-h,m=1-v,b=y-h+u;for(let e=0;e!==s;e++){let t=o[d+e+s],n=o[d+e+a]*c,r=o[p+e+s],l=o[p+e]*c;i[e]=m*t+b*n+v*r+y*l}return i}}let er=new r.PTz;class ei extends en{interpolate_(e,t,n,r){let i=super.interpolate_(e,t,n,r);return er.fromArray(i).normalize().toArray(i),i}}let eo={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},es={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},ea={9728:r.hxR,9729:r.k6q,9984:r.pHI,9985:r.kRr,9986:r.Cfg,9987:r.$_I},el={33071:r.ghU,33648:r.kTW,10497:r.GJx},ec={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},eu={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},eh={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},ef={CUBICSPLINE:void 0,LINEAR:r.PJ3,STEP:r.ljd};function ep(e,t,n){for(let r in n.extensions)void 0===e[r]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[r]=n.extensions[r])}function ed(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function ev(e){let t="",n=Object.keys(e).sort();for(let r=0,i=n.length;r<i;r++)t+=n[r]+":"+e[n[r]]+";";return t}function ey(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}let em=new r.kn4;class eb{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new _,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let n=!1,i=-1,o=!1,s=-1;if("u">typeof navigator){const e=navigator.userAgent;n=!0===/^((?!chrome|android).)*safari/i.test(e);const t=e.match(/Version\/(\d+)/);i=n&&t?parseInt(t[1],10):-1,s=(o=e.indexOf("Firefox")>-1)?e.match(/Firefox\/([0-9]+)\./)[1]:-1}"u"<typeof createImageBitmap||n&&i<17||o&&s<98?this.textureLoader=new r.Tap(this.options.manager):this.textureLoader=new r.Kzg(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new r.Y9S(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){let n=this,r=this.json,i=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(e){return e._markDefs&&e._markDefs()}),Promise.all(this._invokeAll(function(e){return e.beforeRoot&&e.beforeRoot()})).then(function(){return Promise.all([n.getDependencies("scene"),n.getDependencies("animation"),n.getDependencies("camera")])}).then(function(t){let o={scene:t[0][r.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:r.asset,parser:n,userData:{}};return ep(i,o,r),ed(o,r),Promise.all(n._invokeAll(function(e){return e.afterRoot&&e.afterRoot(o)})).then(function(){for(let e of o.scenes)e.updateMatrixWorld();e(o)})}).catch(t)}_markDefs(){let e=this.json.nodes||[],t=this.json.skins||[],n=this.json.meshes||[];for(let n=0,r=t.length;n<r;n++){let r=t[n].joints;for(let t=0,n=r.length;t<n;t++)e[r[t]].isBone=!0}for(let t=0,r=e.length;t<r;t++){let r=e[t];void 0!==r.mesh&&(this._addNodeRef(this.meshCache,r.mesh),void 0!==r.skin&&(n[r.mesh].isSkinnedMesh=!0)),void 0!==r.camera&&this._addNodeRef(this.cameraCache,r.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,n){if(e.refs[t]<=1)return n;let r=n.clone(),i=(e,t)=>{let n=this.associations.get(e);for(let[r,o]of(null!=n&&this.associations.set(t,n),e.children.entries()))i(o,t.children[r])};return i(n,r),r.name+="_instance_"+e.uses[t]++,r}_invokeOne(e){let t=Object.values(this.plugins);t.push(this);for(let n=0;n<t.length;n++){let r=e(t[n]);if(r)return r}return null}_invokeAll(e){let t=Object.values(this.plugins);t.unshift(this);let n=[];for(let r=0;r<t.length;r++){let i=e(t[r]);i&&n.push(i)}return n}getDependency(e,t){let n=e+":"+t,r=this.cache.get(n);if(!r){switch(e){case"scene":r=this.loadScene(t);break;case"node":r=this._invokeOne(function(e){return e.loadNode&&e.loadNode(t)});break;case"mesh":r=this._invokeOne(function(e){return e.loadMesh&&e.loadMesh(t)});break;case"accessor":r=this.loadAccessor(t);break;case"bufferView":r=this._invokeOne(function(e){return e.loadBufferView&&e.loadBufferView(t)});break;case"buffer":r=this.loadBuffer(t);break;case"material":r=this._invokeOne(function(e){return e.loadMaterial&&e.loadMaterial(t)});break;case"texture":r=this._invokeOne(function(e){return e.loadTexture&&e.loadTexture(t)});break;case"skin":r=this.loadSkin(t);break;case"animation":r=this._invokeOne(function(e){return e.loadAnimation&&e.loadAnimation(t)});break;case"camera":r=this.loadCamera(t);break;default:if(!(r=this._invokeOne(function(n){return n!=this&&n.getDependency&&n.getDependency(e,t)})))throw Error("Unknown type: "+e)}this.cache.add(n,r)}return r}getDependencies(e){let t=this.cache.get(e);if(!t){let n=this;t=Promise.all((this.json[e+("mesh"===e?"es":"s")]||[]).map(function(t,r){return n.getDependency(e,r)})),this.cache.add(e,t)}return t}loadBuffer(e){let t=this.json.buffers[e],n=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[C.KHR_BINARY_GLTF].body);let i=this.options;return new Promise(function(e,o){n.load(r.r6x.resolveURL(t.uri,i.path),e,void 0,function(){o(Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){let t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(e){let n=t.byteLength||0,r=t.byteOffset||0;return e.slice(r,r+n)})}loadAccessor(e){let t=this,n=this.json,i=this.json.accessors[e];if(void 0===i.bufferView&&void 0===i.sparse){let e=ec[i.type],t=es[i.componentType],n=!0===i.normalized,o=new t(i.count*e);return Promise.resolve(new r.THS(o,e,n))}let o=[];return void 0!==i.bufferView?o.push(this.getDependency("bufferView",i.bufferView)):o.push(null),void 0!==i.sparse&&(o.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),o.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(o).then(function(e){let o,s,a=e[0],l=ec[i.type],c=es[i.componentType],u=c.BYTES_PER_ELEMENT,h=u*l,f=i.byteOffset||0,p=void 0!==i.bufferView?n.bufferViews[i.bufferView].byteStride:void 0,d=!0===i.normalized;if(p&&p!==h){let e=Math.floor(f/p),n="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+e+":"+i.count,h=t.cache.get(n);h||(o=new c(a,e*p,i.count*p/u),h=new r.eB$(o,p/u),t.cache.add(n,h)),s=new r.eHs(h,l,f%p/u,d)}else o=null===a?new c(i.count*l):new c(a,f,i.count*l),s=new r.THS(o,l,d);if(void 0!==i.sparse){let t=ec.SCALAR,n=es[i.sparse.indices.componentType],o=i.sparse.indices.byteOffset||0,u=i.sparse.values.byteOffset||0,h=new n(e[1],o,i.sparse.count*t),f=new c(e[2],u,i.sparse.count*l);null!==a&&(s=new r.THS(s.array.slice(),s.itemSize,s.normalized)),s.normalized=!1;for(let e=0,t=h.length;e<t;e++){let t=h[e];if(s.setX(t,f[e*l]),l>=2&&s.setY(t,f[e*l+1]),l>=3&&s.setZ(t,f[e*l+2]),l>=4&&s.setW(t,f[e*l+3]),l>=5)throw Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}s.normalized=d}return s})}loadTexture(e){let t=this.json,n=this.options,r=t.textures[e].source,i=t.images[r],o=this.textureLoader;if(i.uri){let e=n.manager.getHandler(i.uri);null!==e&&(o=e)}return this.loadTextureImage(e,r,o)}loadTextureImage(e,t,n){let i=this,o=this.json,s=o.textures[e],a=o.images[t],l=(a.uri||a.bufferView)+":"+s.sampler;if(this.textureCache[l])return this.textureCache[l];let c=this.loadImageSource(t,n).then(function(t){t.flipY=!1,t.name=s.name||a.name||"",""===t.name&&"string"==typeof a.uri&&!1===a.uri.startsWith("data:image/")&&(t.name=a.uri);let n=(o.samplers||{})[s.sampler]||{};return t.magFilter=ea[n.magFilter]||r.k6q,t.minFilter=ea[n.minFilter]||r.$_I,t.wrapS=el[n.wrapS]||r.GJx,t.wrapT=el[n.wrapT]||r.GJx,t.generateMipmaps=!t.isCompressedTexture&&t.minFilter!==r.hxR&&t.minFilter!==r.k6q,i.associations.set(t,{textures:e}),t}).catch(function(){return null});return this.textureCache[l]=c,c}loadImageSource(e,t){let n=this.json,i=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then(e=>e.clone());let o=n.images[e],s=self.URL||self.webkitURL,a=o.uri||"",l=!1;if(void 0!==o.bufferView)a=this.getDependency("bufferView",o.bufferView).then(function(e){l=!0;let t=new Blob([e],{type:o.mimeType});return a=s.createObjectURL(t)});else if(void 0===o.uri)throw Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");let c=Promise.resolve(a).then(function(e){return new Promise(function(n,o){let s=n;!0===t.isImageBitmapLoader&&(s=function(e){let t=new r.gPd(e);t.needsUpdate=!0,n(t)}),t.load(r.r6x.resolveURL(e,i.path),s,void 0,o)})}).then(function(e){var t;return!0===l&&s.revokeObjectURL(a),ed(e,o),e.userData.mimeType=o.mimeType||((t=o.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":t.search(/\.ktx2($|\?)/i)>0||0===t.search(/^data\:image\/ktx2/)?"image/ktx2":"image/png"),e}).catch(function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",a),e});return this.sourceCache[e]=c,c}assignTexture(e,t,n,r){let i=this;return this.getDependency("texture",n.index).then(function(o){if(!o)return null;if(void 0!==n.texCoord&&n.texCoord>0&&((o=o.clone()).channel=n.texCoord),i.extensions[C.KHR_TEXTURE_TRANSFORM]){let e=void 0!==n.extensions?n.extensions[C.KHR_TEXTURE_TRANSFORM]:void 0;if(e){let t=i.associations.get(o);o=i.extensions[C.KHR_TEXTURE_TRANSFORM].extendTexture(o,e),i.associations.set(o,t)}}return void 0!==r&&(o.colorSpace=r),e[t]=o,o})}assignFinalMaterial(e){let t=e.geometry,n=e.material,i=void 0===t.attributes.tangent,o=void 0!==t.attributes.color,s=void 0===t.attributes.normal;if(e.isPoints){let e="PointsMaterial:"+n.uuid,t=this.cache.get(e);t||(t=new r.BH$,r.imn.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,t.sizeAttenuation=!1,this.cache.add(e,t)),n=t}else if(e.isLine){let e="LineBasicMaterial:"+n.uuid,t=this.cache.get(e);t||(t=new r.mrM,r.imn.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,this.cache.add(e,t)),n=t}if(i||o||s){let e="ClonedMaterial:"+n.uuid+":";i&&(e+="derivative-tangents:"),o&&(e+="vertex-colors:"),s&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=n.clone(),o&&(t.vertexColors=!0),s&&(t.flatShading=!0),i&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(n))),n=t}e.material=n}getMaterialType(){return r._4j}loadMaterial(e){let t,n=this,i=this.json,o=this.extensions,s=i.materials[e],a={},l=s.extensions||{},c=[];if(l[C.KHR_MATERIALS_UNLIT]){let e=o[C.KHR_MATERIALS_UNLIT];t=e.getMaterialType(),c.push(e.extendParams(a,s,n))}else{let i=s.pbrMetallicRoughness||{};if(a.color=new r.Q1f(1,1,1),a.opacity=1,Array.isArray(i.baseColorFactor)){let e=i.baseColorFactor;a.color.setRGB(e[0],e[1],e[2],r.Zr2),a.opacity=e[3]}void 0!==i.baseColorTexture&&c.push(n.assignTexture(a,"map",i.baseColorTexture,r.er$)),a.metalness=void 0!==i.metallicFactor?i.metallicFactor:1,a.roughness=void 0!==i.roughnessFactor?i.roughnessFactor:1,void 0!==i.metallicRoughnessTexture&&(c.push(n.assignTexture(a,"metalnessMap",i.metallicRoughnessTexture)),c.push(n.assignTexture(a,"roughnessMap",i.metallicRoughnessTexture))),t=this._invokeOne(function(t){return t.getMaterialType&&t.getMaterialType(e)}),c.push(Promise.all(this._invokeAll(function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,a)})))}!0===s.doubleSided&&(a.side=r.$EB);let u=s.alphaMode||"OPAQUE";if("BLEND"===u?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,"MASK"===u&&(a.alphaTest=void 0!==s.alphaCutoff?s.alphaCutoff:.5)),void 0!==s.normalTexture&&t!==r.V9B&&(c.push(n.assignTexture(a,"normalMap",s.normalTexture)),a.normalScale=new r.I9Y(1,1),void 0!==s.normalTexture.scale)){let e=s.normalTexture.scale;a.normalScale.set(e,e)}if(void 0!==s.occlusionTexture&&t!==r.V9B&&(c.push(n.assignTexture(a,"aoMap",s.occlusionTexture)),void 0!==s.occlusionTexture.strength&&(a.aoMapIntensity=s.occlusionTexture.strength)),void 0!==s.emissiveFactor&&t!==r.V9B){let e=s.emissiveFactor;a.emissive=new r.Q1f().setRGB(e[0],e[1],e[2],r.Zr2)}return void 0!==s.emissiveTexture&&t!==r.V9B&&c.push(n.assignTexture(a,"emissiveMap",s.emissiveTexture,r.er$)),Promise.all(c).then(function(){let r=new t(a);return s.name&&(r.name=s.name),ed(r,s),n.associations.set(r,{materials:e}),s.extensions&&ep(o,r,s),r})}createUniqueName(e){let t=r.Nwf.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){let t=this,n=this.extensions,i=this.primitiveCache,o=[];for(let s=0,a=e.length;s<a;s++){let a=e[s],l=function(e){let t,n=e.extensions&&e.extensions[C.KHR_DRACO_MESH_COMPRESSION];if(t=n?"draco:"+n.bufferView+":"+n.indices+":"+ev(n.attributes):e.indices+":"+ev(e.attributes)+":"+e.mode,void 0!==e.targets)for(let n=0,r=e.targets.length;n<r;n++)t+=":"+ev(e.targets[n]);return t}(a),c=i[l];if(c)o.push(c.promise);else{let e;e=a.extensions&&a.extensions[C.KHR_DRACO_MESH_COMPRESSION]?function(e){return n[C.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then(function(n){return eg(n,e,t)})}(a):eg(new r.LoY,a,t),i[l]={primitive:a,promise:e},o.push(e)}}return Promise.all(o)}loadMesh(e){let t=this,n=this.json,i=this.extensions,o=n.meshes[e],s=o.primitives,a=[];for(let e=0,t=s.length;e<t;e++){var l;let t=void 0===s[e].material?(void 0===(l=this.cache).DefaultMaterial&&(l.DefaultMaterial=new r._4j({color:0xffffff,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:r.hB5})),l.DefaultMaterial):this.getDependency("material",s[e].material);a.push(t)}return a.push(t.loadGeometries(s)),Promise.all(a).then(function(n){let a=n.slice(0,n.length-1),l=n[n.length-1],c=[];for(let n=0,u=l.length;n<u;n++){let u,h=l[n],f=s[n],p=a[n];if(f.mode===eo.TRIANGLES||f.mode===eo.TRIANGLE_STRIP||f.mode===eo.TRIANGLE_FAN||void 0===f.mode)!0===(u=!0===o.isSkinnedMesh?new r.I46(h,p):new r.eaF(h,p)).isSkinnedMesh&&u.normalizeSkinWeights(),f.mode===eo.TRIANGLE_STRIP?u.geometry=A(u.geometry,r.O49):f.mode===eo.TRIANGLE_FAN&&(u.geometry=A(u.geometry,r.rYR));else if(f.mode===eo.LINES)u=new r.DXC(h,p);else if(f.mode===eo.LINE_STRIP)u=new r.N1A(h,p);else if(f.mode===eo.LINE_LOOP)u=new r.FCc(h,p);else if(f.mode===eo.POINTS)u=new r.ONl(h,p);else throw Error("THREE.GLTFLoader: Primitive mode unsupported: "+f.mode);Object.keys(u.geometry.morphAttributes).length>0&&function(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let n=0,r=t.weights.length;n<r;n++)e.morphTargetInfluences[n]=t.weights[n];if(t.extras&&Array.isArray(t.extras.targetNames)){let n=t.extras.targetNames;if(e.morphTargetInfluences.length===n.length){e.morphTargetDictionary={};for(let t=0,r=n.length;t<r;t++)e.morphTargetDictionary[n[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}(u,o),u.name=t.createUniqueName(o.name||"mesh_"+e),ed(u,o),f.extensions&&ep(i,u,f),t.assignFinalMaterial(u),c.push(u)}for(let n=0,r=c.length;n<r;n++)t.associations.set(c[n],{meshes:e,primitives:n});if(1===c.length)return o.extensions&&ep(i,c[0],o),c[0];let u=new r.YJl;o.extensions&&ep(i,u,o),t.associations.set(u,{meshes:e});for(let e=0,t=c.length;e<t;e++)u.add(c[e]);return u})}loadCamera(e){let t,n=this.json.cameras[e],i=n[n.type];return i?("perspective"===n.type?t=new r.ubm(r.cj9.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):"orthographic"===n.type&&(t=new r.qUd(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),n.name&&(t.name=this.createUniqueName(n.name)),ed(t,n),Promise.resolve(t)):void console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){let t=this.json.skins[e],n=[];for(let e=0,r=t.joints.length;e<r;e++)n.push(this._loadNodeShallow(t.joints[e]));return void 0!==t.inverseBindMatrices?n.push(this.getDependency("accessor",t.inverseBindMatrices)):n.push(null),Promise.all(n).then(function(e){let n=e.pop(),i=[],o=[];for(let s=0,a=e.length;s<a;s++){let a=e[s];if(a){i.push(a);let e=new r.kn4;null!==n&&e.fromArray(n.array,16*s),o.push(e)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[s])}return new r.EAD(i,o)})}loadAnimation(e){let t=this.json,n=this,i=t.animations[e],o=i.name?i.name:"animation_"+e,s=[],a=[],l=[],c=[],u=[];for(let e=0,t=i.channels.length;e<t;e++){let t=i.channels[e],n=i.samplers[t.sampler],r=t.target,o=r.node,h=void 0!==i.parameters?i.parameters[n.input]:n.input,f=void 0!==i.parameters?i.parameters[n.output]:n.output;void 0!==r.node&&(s.push(this.getDependency("node",o)),a.push(this.getDependency("accessor",h)),l.push(this.getDependency("accessor",f)),c.push(n),u.push(r))}return Promise.all([Promise.all(s),Promise.all(a),Promise.all(l),Promise.all(c),Promise.all(u)]).then(function(e){let t=e[0],s=e[1],a=e[2],l=e[3],c=e[4],u=[];for(let e=0,r=t.length;e<r;e++){let r=t[e],i=s[e],o=a[e],h=l[e],f=c[e];if(void 0===r)continue;r.updateMatrix&&r.updateMatrix();let p=n._createAnimationTracks(r,i,o,h,f);if(p)for(let e=0;e<p.length;e++)u.push(p[e])}let h=new r.tz3(o,void 0,u);return ed(h,i),h})}createNodeMesh(e){let t=this.json,n=this,r=t.nodes[e];return void 0===r.mesh?null:n.getDependency("mesh",r.mesh).then(function(e){let t=n._getNodeRef(n.meshCache,r.mesh,e);return void 0!==r.weights&&t.traverse(function(e){if(e.isMesh)for(let t=0,n=r.weights.length;t<n;t++)e.morphTargetInfluences[t]=r.weights[t]}),t})}loadNode(e){let t=this.json.nodes[e],n=this._loadNodeShallow(e),r=[],i=t.children||[];for(let e=0,t=i.length;e<t;e++)r.push(this.getDependency("node",i[e]));let o=void 0===t.skin?Promise.resolve(null):this.getDependency("skin",t.skin);return Promise.all([n,Promise.all(r),o]).then(function(e){let t=e[0],n=e[1],r=e[2];null!==r&&t.traverse(function(e){e.isSkinnedMesh&&e.bind(r,em)});for(let e=0,r=n.length;e<r;e++)t.add(n[e]);return t})}_loadNodeShallow(e){let t=this.json,n=this.extensions,i=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];let o=t.nodes[e],s=o.name?i.createUniqueName(o.name):"",a=[],l=i._invokeOne(function(t){return t.createNodeMesh&&t.createNodeMesh(e)});return l&&a.push(l),void 0!==o.camera&&a.push(i.getDependency("camera",o.camera).then(function(e){return i._getNodeRef(i.cameraCache,o.camera,e)})),i._invokeAll(function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)}).forEach(function(e){a.push(e)}),this.nodeCache[e]=Promise.all(a).then(function(t){let a;if((a=!0===o.isBone?new r.$Kf:t.length>1?new r.YJl:1===t.length?t[0]:new r.B69)!==t[0])for(let e=0,n=t.length;e<n;e++)a.add(t[e]);if(o.name&&(a.userData.name=o.name,a.name=s),ed(a,o),o.extensions&&ep(n,a,o),void 0!==o.matrix){let e=new r.kn4;e.fromArray(o.matrix),a.applyMatrix4(e)}else void 0!==o.translation&&a.position.fromArray(o.translation),void 0!==o.rotation&&a.quaternion.fromArray(o.rotation),void 0!==o.scale&&a.scale.fromArray(o.scale);if(i.associations.has(a)){if(void 0!==o.mesh&&i.meshCache.refs[o.mesh]>1){let e=i.associations.get(a);i.associations.set(a,{...e})}}else i.associations.set(a,{});return i.associations.get(a).nodes=e,a}),this.nodeCache[e]}loadScene(e){let t=this.extensions,n=this.json.scenes[e],i=this,o=new r.YJl;n.name&&(o.name=i.createUniqueName(n.name)),ed(o,n),n.extensions&&ep(t,o,n);let s=n.nodes||[],a=[];for(let e=0,t=s.length;e<t;e++)a.push(i.getDependency("node",s[e]));return Promise.all(a).then(function(e){for(let t=0,n=e.length;t<n;t++)o.add(e[t]);return i.associations=(e=>{let t=new Map;for(let[e,n]of i.associations)(e instanceof r.imn||e instanceof r.gPd)&&t.set(e,n);return e.traverse(e=>{let n=i.associations.get(e);null!=n&&t.set(e,n)}),t})(o),o})}_createAnimationTracks(e,t,n,i,o){let s,a=[],l=e.name?e.name:e.uuid,c=[];switch(eh[o.path]===eh.weights?e.traverse(function(e){e.morphTargetInfluences&&c.push(e.name?e.name:e.uuid)}):c.push(l),eh[o.path]){case eh.weights:s=r.Hit;break;case eh.rotation:s=r.MBL;break;case eh.translation:case eh.scale:s=r.RiT;break;default:s=1===n.itemSize?r.Hit:r.RiT}let u=void 0!==i.interpolation?ef[i.interpolation]:r.PJ3,h=this._getArrayFromAccessor(n);for(let e=0,n=c.length;e<n;e++){let n=new s(c[e]+"."+eh[o.path],t.array,h,u);"CUBICSPLINE"===i.interpolation&&this._createCubicSplineTrackInterpolant(n),a.push(n)}return a}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){let e=ey(t.constructor),n=new Float32Array(t.length);for(let r=0,i=t.length;r<i;r++)n[r]=t[r]*e;t=n}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof r.MBL?ei:en)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function eg(e,t,n){let i=t.attributes,o=[];for(let t in i){let r=eu[t]||t.toLowerCase();r in e.attributes||o.push(function(t,r){return n.getDependency("accessor",t).then(function(t){e.setAttribute(r,t)})}(i[t],r))}if(void 0!==t.indices&&!e.index){let r=n.getDependency("accessor",t.indices).then(function(t){e.setIndex(t)});o.push(r)}return r.ppV.workingColorSpace!==r.Zr2&&"COLOR_0"in i&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${r.ppV.workingColorSpace}" not supported.`),ed(e,t),!function(e,t,n){let i=t.attributes,o=new r.NRn;if(void 0===i.POSITION)return;{let e=n.json.accessors[i.POSITION],t=e.min,s=e.max;if(void 0===t||void 0===s)return console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(o.set(new r.Pq0(t[0],t[1],t[2]),new r.Pq0(s[0],s[1],s[2])),e.normalized){let t=ey(es[e.componentType]);o.min.multiplyScalar(t),o.max.multiplyScalar(t)}}let s=t.targets;if(void 0!==s){let e=new r.Pq0,t=new r.Pq0;for(let r=0,i=s.length;r<i;r++){let i=s[r];if(void 0!==i.POSITION){let r=n.json.accessors[i.POSITION],o=r.min,s=r.max;if(void 0!==o&&void 0!==s){if(t.setX(Math.max(Math.abs(o[0]),Math.abs(s[0]))),t.setY(Math.max(Math.abs(o[1]),Math.abs(s[1]))),t.setZ(Math.max(Math.abs(o[2]),Math.abs(s[2]))),r.normalized){let e=ey(es[r.componentType]);t.multiplyScalar(e)}e.max(t)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}o.expandByVector(e)}e.boundingBox=o;let a=new r.iyt;o.getCenter(a.center),a.radius=o.min.distanceTo(o.max)/2,e.boundingSphere=a}(e,t,n),Promise.all(o).then(function(){return void 0!==t.targets?function(e,t,n){let r=!1,i=!1,o=!1;for(let e=0,n=t.length;e<n;e++){let n=t[e];if(void 0!==n.POSITION&&(r=!0),void 0!==n.NORMAL&&(i=!0),void 0!==n.COLOR_0&&(o=!0),r&&i&&o)break}if(!r&&!i&&!o)return Promise.resolve(e);let s=[],a=[],l=[];for(let c=0,u=t.length;c<u;c++){let u=t[c];if(r){let t=void 0!==u.POSITION?n.getDependency("accessor",u.POSITION):e.attributes.position;s.push(t)}if(i){let t=void 0!==u.NORMAL?n.getDependency("accessor",u.NORMAL):e.attributes.normal;a.push(t)}if(o){let t=void 0!==u.COLOR_0?n.getDependency("accessor",u.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(s),Promise.all(a),Promise.all(l)]).then(function(t){let n=t[0],s=t[1],a=t[2];return r&&(e.morphAttributes.position=n),i&&(e.morphAttributes.normal=s),o&&(e.morphAttributes.color=a),e.morphTargetsRelative=!0,e})}(e,t.targets,n):e})}var ew=n("./src/model/physics/constants.ts"),ek=console.error;function eT(e){new o().parse(e,function(e){var t,n,r;console.log(e),t=e,n="scene.gltf",(r=document.createElement("a")).setAttribute("href","data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(t))),r.setAttribute("download",n),document.body.appendChild(r),r.click(),r.remove()},ek)}function ex(e,t){new M().load(e,function(n){n.scene.scale.set(ew.R/.5,ew.R/.5,ew.R/.5),n.scene.matrixAutoUpdate=!1,n.scene.updateMatrix(),n.scene.updateMatrixWorld(),n.scene.name=e,t(n)},function(t){return console.log(e+" "+t.loaded+" bytes loaded")},ek)}},"./src/utils/rack.ts"(e,t,n){n.d(t,{m:()=>h});var r=n("./src/model/ball.ts"),i=n("./src/utils/snookerconfig.ts"),o=n("./src/view/tablegeometry.ts"),s=n("./src/view/pocketgeometry.ts"),a=n("./node_modules/three/build/three.core.js"),l=n("./src/utils/utils.ts"),c=n("./src/model/physics/constants.ts");function u(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var h=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"jitter",value:function(e){return(0,l.ld)(e.clone().add(new a.Pq0(t.noise*(Math.random()-.5),t.noise*(Math.random()-.5),0)))}},{key:"cueBall",value:function(e,n){return new r.c(t.jitter(e),0xfaebd7,n)}},{key:"swapBallPositions",value:function(e,t){var n=e.pos.clone();e.pos.copy(t.pos),t.pos.copy(n)}},{key:"diamond",value:function(){var e=new a.Pq0(o.P.tableX/2,0,0),n=[],i=function(e,n,i){return new r.c(t.jitter(e),n,i)};return n.push(t.cueBall(t.spot)),n.push(i(e,t.BALL_COLORS[1],1)),e.add(t.diagonal),n.push(i(e,t.BALL_COLORS[2],2)),e.sub(t.across),n.push(i(e,t.BALL_COLORS[3],3)),e.add(t.diagonal),n.push(i(e,t.BALL_COLORS[4],4)),e.sub(t.across),n.push(i(e,t.BALL_COLORS[5],5)),e.addScaledVector(t.across,2),n.push(i(e,t.BALL_COLORS[6],6)),e.add(t.diagonal).sub(t.across),n.push(i(e,t.BALL_COLORS[7],7)),e.sub(t.across),n.push(i(e,t.BALL_COLORS[8],8)),e.add(t.diagonal),n.push(i(e,t.BALL_COLORS[9],9)),t.swapBallPositions(n[4],n[9]),n}},{key:"triangle",value:function(){var e=t.trianglePositions(),n=[];return n.push(t.cueBall(t.spot)),e.forEach(function(e,i){var o=i+1;n.push(new r.c(t.jitter(e),t.BALL_COLORS[o],o))}),t.swapBallPositions(n[4],n[9]),n}},{key:"trianglePositions",value:function(){var e=[],t=new a.Pq0(o.P.X/2,0,0);return e.push((0,l.t6)(t)),t.add(this.diagonal),e.push((0,l.t6)(t)),t.sub(this.across),e.push((0,l.t6)(t)),t.add(this.diagonal),e.push((0,l.t6)(t)),t.sub(this.across),e.push((0,l.t6)(t)),t.addScaledVector(this.across,2),e.push((0,l.t6)(t)),t.add(this.diagonal),e.push((0,l.t6)(t)),t.sub(this.across),e.push((0,l.t6)(t)),t.sub(this.across),e.push((0,l.t6)(t)),t.sub(this.across),e.push((0,l.t6)(t)),t.add(this.diagonal).sub(this.across),e.push((0,l.t6)(t)),t.add(this.across),e.push((0,l.t6)(t)),t.add(this.across),e.push((0,l.t6)(t)),t.add(this.across),e.push((0,l.t6)(t)),t.add(this.across),e.push((0,l.t6)(t)),e}},{key:"rerack",value:function(e,n){var i=t.trianglePositions(),o=i.shift();n.balls.filter(function(e){return e!==n.cueball}).filter(function(t){return t!==e}).forEach(function(e){e.pos.copy(t.jitter(i.shift())),e.state=r.U.Stationary}),n.overlapsAny(e.pos,e)&&e.pos.copy(o),n.overlapsAny(n.cueball.pos)&&n.cueball.pos.copy(t.spot)}},{key:"three",value:function(){var e=[],n=o.P.X/2,i=o.P.Y/4;return e.push(t.cueBall(t.jitter(new a.Pq0(-n,-i,0)))),e.push(new r.c(t.jitter(new a.Pq0(-n,0,0)),0xe0de36)),e.push(new r.c(t.jitter(new a.Pq0(n,0,0)),0xff0000)),e}},{key:"snooker",value:function(){var e=[],n=o.P.Y/4;e.push(t.cueBall(t.jitter(new a.Pq0(t.baulk,-(.5*n),0))));var l=t.snookerColourPositions();e.push(new r.c(t.jitter(l[0]),0xeede36)),e.push(new r.c(t.jitter(l[1]),824932)),e.push(new r.c(t.jitter(l[2]),0xbd723a)),e.push(new r.c(t.jitter(l[3]),558062)),e.push(new r.c(t.jitter(l[4]),0xffaacc)),e.push(new r.c(t.jitter(l[5]),65793));var u=Math.min(i.U.reds,15),h=t.trianglePositions().slice(0,15),f=s.f.pockets.pocketS.pocket.pos;return h.forEach(function(n,i){var o=new r.c(t.jitter(n.add(t.down)),0xee0000);i>=u&&(o.pos.copy(f),o.pos.setZ(-8.5*c.R),o.state=r.U.InPocket),e.push(o)}),e}},{key:"snookerColourPositions",value:function(){var e=o.P.X/2,n=o.P.X-2*o.P.X/11,r=[];return r.push(new a.Pq0(t.baulk,-t.sixth,0)),r.push(new a.Pq0(t.baulk,t.sixth,0)),r.push(new a.Pq0(t.baulk,0,0)),r.push(new a.Pq0(0,0,0)),r.push(new a.Pq0(e,0,0)),r.push(new a.Pq0(n,0,0)),r}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();u(h,"noise",.0233*c.R),u(h,"gap",2*c.R+2*h.noise),u(h,"up",new a.Pq0(0,0,-1)),u(h,"spot",new a.Pq0(-o.P.X/2,0,0)),u(h,"across",new a.Pq0(0,h.gap,0)),u(h,"down",new a.Pq0(h.gap,0,0)),u(h,"diagonal",h.across.clone().applyAxisAngle(h.up,Math.PI/3)),u(h,"BALL_COLORS",["#FFFFFF","#ffd900","#0000FF","#FF0000","#800080","#ff3300","#008000","#600000","#000000","#FFFF00","#0000FF","#FF0000","#800080","#FF8000","#008000","#600000"]),u(h,"sixth",2*o.P.Y/6),u(h,"baulk",-1.5*o.P.X*2/5)},"./src/utils/replay-encoder.ts"(e,t,n){n.d(t,{k:()=>i});var r=n("./node_modules/jsoncrush/JSONCrush.js"),i=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"fullyEncodeURI",value:function(e){return encodeURIComponent(e).replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/!/g,"%21").replace(/\*/g,"%2A")}},{key:"crush",value:function(e){return r.A.crush(e)}},{key:"createState",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5?arguments[5]:void 0,s={init:e,shots:t,start:n,now:Date.now(),score:r,wholeGame:i,v:1};return o&&(s.players=o),s}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/utils/respot.ts"(e,t,n){n.d(t,{k:()=>l});var r=n("./src/model/ball.ts"),i=n("./src/view/tablegeometry.ts"),o=n("./src/model/physics/constants.ts"),s=n("./src/utils/rack.ts"),a=n("./node_modules/three/build/three.core.js"),l=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"nineBall",value:function(e){var n=e.balls.find(function(e){return 9===e.id});if(n){var r=new a.Pq0(i.P.tableX/2,0,0);t.respotBehind(r,n,e)}}},{key:"respot",value:function(e,n){var i=s.m.snookerColourPositions();return i.push(i[e.id-1]),i.reverse(),i.some(function(t){return!n.overlapsAny(t,e)&&(e.pos.copy(t),e.state=r.U.Stationary,!0)})||t.respotBehind(i[0],e,n),e}},{key:"respotBehind",value:function(e,t,n){for(var s=e.clone();s.x<i.P.tableX&&n.overlapsAny(s,t);)s.x+=o.R/8;for(;s.x>-i.P.tableX&&n.overlapsAny(s,t);)s.x-=o.R/8;t.pos.copy(s),t.state=r.U.Stationary}},{key:"closest",value:function(e,t){var n=t.filter(function(e){return e.onTable()}).filter(function(t){return t!==e});if(0!==n.length){var r=function(t){return e.pos.distanceTo(t.pos)};return n.reduce(function(e,t){return r(e)<r(t)?e:t},n[0])}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/utils/snookerconfig.ts"(e,t,n){n.d(t,{U:()=>r});var r={reds:15}},"./src/utils/threecushionconfig.ts"(e,t,n){n.d(t,{Y:()=>r});var r={raceTo:7}},"./src/utils/utils.ts"(e,t,n){n.d(t,{Dz:()=>v,F8:()=>w,FP:()=>b,KM:()=>u,RZ:()=>T,gn:()=>k,hs:()=>a,ld:()=>m,n7:()=>g,oN:()=>x,rq:()=>d,t6:()=>l,up:()=>s,v_:()=>o,xb:()=>f});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/events/eventtype.ts"),o=new r.Pq0(0,0,0),s=new r.Pq0(0,0,1);function a(e){return!e.entries.some(function(e){return e.event.type===i.B.AIM})}function l(e){return new r.Pq0(e.x,e.y,e.z)}var c=new r.Pq0;function u(e){return c.copy(s).cross(e)}var h=new r.Pq0;function f(e){return h.copy(e).normalize()}var p=new r.Pq0;function d(e,t){return 0>=p.copy(e).add(t).dot(e)}function v(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new r.Pq0;return t.set(1,0,0).applyAxisAngle(s,e)}function y(e){return Math.sign(e)*Math.floor((Math.abs(e)+Number.EPSILON)*1e4)/1e4}function m(e){return e.x=y(e.x),e.y=y(e.y),e.z=y(e.z),e}function b(e,t){return Math.fround(Math.atan2(e,t))}function g(e,t){return Math.fround(Math.pow(e,t))}function w(e){return Math.fround(Math.sin(e))}function k(e){return Math.fround(Math.cos(e))}function T(e){return Math.fround(Math.sqrt(e))}function x(e){return Math.fround(Math.exp(e))}},"./src/view/assets.ts"(e,t,n){n.d(t,{s:()=>y});var r=n("./src/controller/rules/rulefactory.ts"),i=n("./src/utils/gltf.ts"),o=n("./node_modules/three/build/three.core.js");function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");s(this,"listener",void 0),s(this,"audioLoader",void 0),s(this,"ballcollision",void 0),s(this,"cue",void 0),s(this,"cushion",void 0),s(this,"pot",void 0),s(this,"success",void 0),s(this,"lastOutcomeTime",0),s(this,"loadAssets",void 0),this.loadAssets=e,e&&(this.listener=new o.Pf$,this.audioLoader=new o.Am1,this.ballcollision=new o.fP5(this.listener),this.load("sounds/ballcollision.ogg",this.ballcollision),this.cue=new o.fP5(this.listener),this.load("sounds/cue.ogg",this.cue),this.cushion=new o.fP5(this.listener),this.load("sounds/cushion.ogg",this.cushion),this.pot=new o.fP5(this.listener),this.load("sounds/pot.ogg",this.pot),this.success=new o.fP5(this.listener),this.load("sounds/success.ogg",this.success))}return e=[{key:"addCameraToListener",value:function(e){e.add(this.listener)}},{key:"load",value:function(e,t){this.audioLoader.load(e,function(e){t.setBuffer(e),t.setLoop(!1)},function(e){},function(e){})}},{key:"play",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(this.loadAssets){var r,i,s=o.UtX.getContext();if((null==s?void 0:s.state)==="suspended"){(null==(i=navigator)||null==(r=i.userActivation)?void 0:r.hasBeenActive)&&s.resume();return}e.setVolume(t),e.isPlaying&&e.stop(),e.play(o.cj9.randFloat(0,.01)),e.setDetune(n)}}},{key:"outcomeToSound",value:function(e){"Collision"===e.type&&this.play(this.ballcollision,e.incidentSpeed/80,5*e.incidentSpeed),"Pot"===e.type&&this.play(this.pot,e.incidentSpeed/10,-1e3+10*e.incidentSpeed),"Cushion"===e.type&&this.play(this.cushion,e.incidentSpeed/70),"Hit"===e.type&&this.play(this.cue,e.incidentSpeed/30)}},{key:"processOutcomes",value:function(e){var t=this;e.every(function(e){return!(e.timestamp>t.lastOutcomeTime)||(t.lastOutcomeTime=e.timestamp,t.outcomeToSound(e),!1)})}},{key:"playNotify",value:function(){this.play(this.pot,1)}},{key:"playSuccess",value:function(e){this.play(this.success,.1,100*e-2200)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),l=n("./src/view/tablegeometry.ts"),c=n("./src/view/pocketgeometry.ts"),u=n("./src/model/physics/constants.ts");function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var f=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");h(this,"logger",function(e){}),h(this,"cloth",new o.tXL({color:4478393,wireframe:!1,flatShading:!0,transparent:!1})),h(this,"cushion",new o.tXL({color:5531065,wireframe:!1,flatShading:!0,transparent:!1})),h(this,"pocket",new o.tXL({color:4478361,wireframe:!1,flatShading:!0,transparent:!0,opacity:.3}))}return e=[{key:"generateTable",value:function(e){var t=this,n=new o.YJl,r=new o.HiM(0xf0f0e8,22);if(r.position.set(0,0,50*u.R),n.add(r),this.addCushions(n,e),e){c.f.knuckles.forEach(function(e){return t.knuckleCylinder(e,n)}),c.f.pocketCenters.forEach(function(e){return t.knuckleCylinder(e,n,t.pocket)});var i=c.f.pockets.pocketNW.pocket,s=c.f.pockets.pocketNW.knuckleNE;this.logger("knuckle-pocket gap = "+(i.pos.distanceTo(s.pos)-i.radius-s.radius))}return n}},{key:"knuckleCylinder",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.cloth;this.cylinder(e.pos,e.radius,.75*u.R/.5,t,n).position.setZ(-(.25*u.R)/.5/2)}},{key:"cylinder",value:function(e,n,r,i,s){var a="".concat(n,"_").concat(r),l=t.cylinderCache.get(a);l||(l=new o.Ho_(n,n,r,16),t.cylinderCache.set(a,l));var c=new o.eaF(l,s);return c.position.copy(e),c.rotation.x=Math.PI/2,i.add(c),c}},{key:"addCushions",value:function(e,t){var n=10*u.R/.5;this.plane(new o.Pq0(0,0,-u.R-n/2),2*l.P.X,2*l.P.Y,n,e,this.cloth);var r=u.R/.5,i=.75*u.R/.5,s=-(.25*u.R)/.5/2,a=l.P.X,h=l.P.Y,f=Math.abs(c.f.pockets.pocketNW.knuckleNE.pos.x-c.f.pockets.pocketN.knuckleNW.pos.x),p=Math.abs(c.f.pockets.pocketNW.knuckleSW.pos.y-c.f.pockets.pocketSW.knuckleNW.pos.y);t||(f=2*l.P.Y,p=2*l.P.Y+4*u.R),this.plane(new o.Pq0(a+r/2,0,s),r,p,i,e),this.plane(new o.Pq0(-a-r/2,0,s),r,p,i,e),this.plane(new o.Pq0(-a/2,h+r/2,s),f,r,i,e),this.plane(new o.Pq0(-a/2,-h-r/2,s),f,r,i,e),this.plane(new o.Pq0(a/2,h+r/2,s),f,r,i,e),this.plane(new o.Pq0(a/2,-h-r/2,s),f,r,i,e)}},{key:"plane",value:function(e,n,r,i,s){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:this.cushion,l="".concat(n,"_").concat(r,"_").concat(i),c=t.boxCache.get(l);c||(c=new o.iNn(n,r,i),t.boxCache.set(l,c));var u=new o.eaF(c,a);u.receiveShadow=!0,u.position.copy(e),s.add(u)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();h(f,"mesh",void 0),h(f,"cylinderCache",new Map),h(f,"boxCache",new Map);var p=n("./src/view/cuemesh.ts");function d(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function v(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var y=function(){var e,t;function n(e){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");v(this,"ready",void 0),v(this,"rules",void 0),v(this,"background",void 0),v(this,"table",void 0),v(this,"cue",void 0),v(this,"sound",void 0),this.rules=r.V.create(e,null),this.rules.tableGeometry()}return e=[{key:"loadFromWeb",value:function(e){var t=this;this.ready=e,this.sound=new a(!0),(0,i.Ro)("models/background.gltf",function(e){t.background=e.scene,t.done()}),(0,i.Ro)(this.rules.asset(),function(e){t.table=e.scene,f.mesh=e.scene.children[0],t.done()}),(0,i.Ro)("models/cue.gltf",function(e){t.cue=e,p.l.mesh=e.scene.children[0],t.done()})}},{key:"createLocal",value:function(){this.sound=new a(!1),f.mesh=new f().generateTable(l.P.hasPockets),this.table=f.mesh}},{key:"done",value:function(){this.background&&this.table&&this.cue&&this.ready()}}],t=[{key:"localAssets",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=new n(e);return t.createLocal(),t}}],e&&d(n.prototype,e),t&&d(n,t),n}()},"./src/view/cameratop.ts"(e,t,n){n.d(t,{v:()=>a});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/view/tablegeometry.ts"),o=n("./src/model/physics/constants.ts");function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"viewPoint",value:function(e,n){var s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new r.Pq0;(n!==t.lastFov||t.zoomFactor!==t.lastZoom)&&(t.cachedDist=t.zoomFactor/(2*Math.tan(n*Math.PI/360)),t.lastFov=n,t.lastZoom=t.zoomFactor);var a=t.cachedDist;if(e>this.portrait){var l=e>t.aspectLimit?2.75*i.P.tableY:2.4*i.P.tableX/e;return s.set(0,-.01*o.R,a*l)}var c=e>1/t.aspectLimit?4.9*i.P.tableY:1.35*i.P.tableX/e;return s.set(-.01*o.R,0,a*c)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();s(a,"aspectLimit",1.78),s(a,"portrait",.95),s(a,"fov",20),s(a,"zoomFactor",1),s(a,"lastFov",void 0),s(a,"lastZoom",void 0),s(a,"cachedDist",void 0)},"./src/view/cue.ts"(e,t,n){n.d(t,{s:()=>f});var r=n("./src/view/tablegeometry.ts"),i=n("./src/utils/utils.ts"),o=n("./src/events/aimevent.ts"),s=n("./src/model/ball.ts"),a=n("./src/model/physics/physics.ts"),l=n("./src/view/cuemesh.ts"),c=n("./node_modules/three/build/three.core.js"),u=n("./src/model/physics/constants.ts");function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var f=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");h(this,"mesh",void 0),h(this,"helperMesh",void 0),h(this,"placerMesh",void 0),h(this,"offCenterLimit",.3),h(this,"maxPower",160*u.R),h(this,"t",0),h(this,"aimInputs",void 0),h(this,"aim",new o.w),h(this,"length",+r.P.tableX),h(this,"tempVec",new c.Pq0),h(this,"tempVec2",new c.Pq0),h(this,"tempVec3",new c.Pq0),h(this,"raycaster",new c.tBo),this.mesh=l.l.createCue(.05*u.R/.5,.15*u.R/.5,this.length),this.helperMesh=l.l.createHelper(),this.placerMesh=l.l.createPlacer()}return e=[{key:"rotateAim",value:function(e,t){this.aim.angle=this.aim.angle+e,this.mesh.rotation.z=this.aim.angle,this.helperMesh.rotation.z=this.aim.angle,this.aimInputs.showOverlap(),this.avoidCueTouchingOtherBall(t)}},{key:"adjustPower",value:function(e){this.aim.power=Math.min(this.maxPower,this.aim.power+e),this.updateAimInput()}},{key:"setPower",value:function(e){this.aim.power=e*this.maxPower}},{key:"hit",value:function(e){var t=this.aim;this.t=0,e.state=s.U.Sliding,e.vel.copy((0,i.Dz)(t.angle,this.tempVec).multiplyScalar(t.power)),e.rvel.copy((0,a.t6)(t.offset,e.vel))}},{key:"aimAtNext",value:function(e,t){if(t){var n=(0,i.xb)(this.tempVec.copy(t.pos).sub(e.pos));this.aim.angle=(0,i.FP)(n.y,n.x)}}},{key:"adjustSpin",value:function(e,t){var n=this.tempVec3.copy(this.aim.offset).add(e);this.setSpin(n,t)}},{key:"setSpin",value:function(e,t){e.length()>this.offCenterLimit&&e.normalize().multiplyScalar(this.offCenterLimit),this.aim.offset.copy(e),this.avoidCueTouchingOtherBall(t),this.updateAimInput()}},{key:"avoidCueTouchingOtherBall",value:function(e){for(var t=0;t++<20&&this.intersectsAnything(e);)this.aim.offset.y+=.1,this.aim.offset.length()>this.offCenterLimit&&this.aim.offset.normalize().multiplyScalar(this.offCenterLimit);t>1&&this.updateAimInput()}},{key:"updateAimInput",value:function(){var e,t,n;null==(e=this.aimInputs)||e.updateVisualState(this.aim.offset.x,this.aim.offset.y),null==(t=this.aimInputs)||t.updatePowerSlider(this.aim.power/this.maxPower),null==(n=this.aimInputs)||n.showOverlap()}},{key:"moveTo",value:function(e){this.aim.pos.copy(e),this.mesh.rotation.z=this.aim.angle,this.helperMesh.rotation.z=this.aim.angle;var t=this.spinOffset(),n=((0,i.F8)(this.t+Math.PI/2)-1)*2*u.R*(this.aim.power/this.maxPower),r=(0,i.Dz)(this.aim.angle,this.tempVec).multiplyScalar(n);this.mesh.position.copy(e).add(t).add(r),this.helperMesh.position.copy(e),this.placerMesh.position.copy(e),this.placerMesh.rotation.z=this.t}},{key:"update",value:function(e){this.t+=e,this.moveTo(this.aim.pos)}},{key:"placeBallMode",value:function(){this.mesh.visible=!1,this.placerMesh.visible=!0,this.aim.angle=0}},{key:"aimMode",value:function(){this.mesh.visible=!0,this.placerMesh.visible=!1}},{key:"spinOffset",value:function(){return(0,i.KM)((0,i.Dz)(this.aim.angle,this.tempVec2)).multiplyScalar(2*this.aim.offset.x*u.R).setZ(2*this.aim.offset.y*u.R)}},{key:"intersectsAnything",value:function(e){var t=this.spinOffset(),n=this.tempVec.copy(e.cueball.pos).add(t),r=(0,i.xb)((0,i.Dz)(this.aim.angle+Math.PI,this.tempVec2).setZ(.1));this.raycaster.set(n,r);var o=[],s=!0,a=!1,l=void 0;try{for(var c,u=e.balls[Symbol.iterator]();!(s=(c=u.next()).done);s=!0){var h=c.value;o.push(h.ballmesh.mesh)}}catch(e){a=!0,l=e}finally{try{s||null==u.return||u.return()}finally{if(a)throw l}}return e.mesh&&o.push(e.mesh),this.raycaster.intersectObjects(o,!0).length>0}},{key:"showHelper",value:function(e){this.helperMesh.visible=e}},{key:"toggleHelper",value:function(){this.showHelper(!this.helperMesh.visible)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/view/cuemesh.ts"(e,t,n){n.d(t,{l:()=>a});var r=n("./src/model/physics/constants.ts"),i=n("./src/utils/utils.ts"),o=n("./node_modules/three/build/three.core.js");function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"indicateValid",value:function(e){t.placermaterial.color.setHex(e?0xccffcc:0xff0000)}},{key:"createHelper",value:function(){var e=new o.Ho_(r.R,r.R,30*r.R/.5,12,1,!0),t=new o.eaF(e,this.helpermaterial);return t.geometry.applyMatrix4(new o.kn4().identity().makeRotationAxis(i.up,-Math.PI/2)).applyMatrix4(new o.kn4().identity().makeTranslation(15*r.R/.5,0,-(.01*r.R)/.5)),t.visible=!1,t.renderOrder=-1,t.material.depthTest=!1,t}},{key:"createPlacer",value:function(){var e=new o.Ho_(.01*r.R/.5,r.R,r.R,4),n=new o.eaF(e,t.placermaterial);return n.geometry.applyMatrix4(new o.kn4().identity().makeRotationAxis(new o.Pq0(1,0,0),-Math.PI/2)).applyMatrix4(new o.kn4().identity().makeTranslation(0,0,.7*r.R/.5)),n.visible=!1,n}},{key:"createCue",value:function(e,n,s){var a=new o.Ho_(e,n,s,11),l=new o.eaF(a,t.material);return l.castShadow=!1,l.geometry.applyMatrix4(new o.kn4().identity().makeRotationAxis(new o.Pq0(1,0,0),-.17)).applyMatrix4(new o.kn4().identity().makeRotationAxis(i.up,-Math.PI/2)).applyMatrix4(new o.kn4().identity().makeTranslation(-s/2-r.R,0,s/2*.16918234906699603+.25*r.R)),l}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();s(a,"mesh",void 0),s(a,"material",new o.tXL({color:8934775,wireframe:!1,flatShading:!1})),s(a,"placermaterial",new o.tXL({color:0xccffcc,wireframe:!1,flatShading:!1,transparent:!0,opacity:.5})),s(a,"helpermaterial",new o.BKk({uniforms:{lightDirection:{value:new o.Pq0(0,0,1)}},vertexShader:`
+        `))},this.materialCache.set(r,o),o}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();function y(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}o="materialCache",s=new Map,o in v?Object.defineProperty(v,o,{value:s,enumerable:!0,configurable:!0,writable:!0}):v[o]=s;var b=function(){var e,t;function n(e,t){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");m(this,"mesh",void 0),m(this,"shadow",void 0),m(this,"spinAxisArrow",void 0),m(this,"trace",void 0),m(this,"color",void 0),m(this,"m",new u.kn4),this.color=new u.Q1f(e),this.initialiseMesh(this.color,t)}return e=[{key:"updateAll",value:function(e,t){this.updatePosition(e.pos),this.updateArrows(e.pos,e.rvel,e.state),0!==e.rvel.lengthSq()&&(this.updateRotation(e.rvel,t),this.trace.addTrace(e.pos,e.vel))}},{key:"updatePosition",value:function(e){this.mesh.position.copy(e),this.shadow.position.copy(e)}},{key:"updateRotation",value:function(e,t){var n=e.length()*t;this.mesh.rotateOnWorldAxis((0,l.xb)(e),n)}},{key:"updateArrows",value:function(e,t,n){this.spinAxisArrow.setLength(h.R+h.R*t.length()/2,h.R,h.R),this.spinAxisArrow.position.copy(e),this.spinAxisArrow.setDirection((0,l.xb)(t)),n==k.Rolling?this.spinAxisArrow.setColor(0xcc0000):this.spinAxisArrow.setColor(52224)}},{key:"initialiseMesh",value:function(e,t){if(void 0===t){var r,i,o=e.getHex(),s=n._dottedGeometryCache.get(o);s||(s=new u.WBB(h.R,1),n.addDots(s,e),n._dottedGeometryCache.set(o,s)),r=s,i=v.createDottedMaterial(e)}else r=n.getBallGeometry(),i=v.createProjectedMaterial(t,e);this.mesh=new u.eaF(r,i),this.mesh.name="ball",this.updateRotation(new u.Pq0().random(),100),this.shadow=new u.eaF(n.getShadowGeometry(),n.getShadowMaterial()),this.spinAxisArrow=new u.E0M(l.up,l.v_,2,0,.01,.01),this.spinAxisArrow.visible=!1,this.trace=new p(500,e)}},{key:"addToScene",value:function(e){e.add(this.mesh),e.add(this.shadow),e.add(this.spinAxisArrow),e.add(this.trace.line)}}],t=[{key:"getBallGeometry",value:function(){return this._ballGeometry||(this._ballGeometry=new u.WBB(h.R,1)),this._ballGeometry}},{key:"getShadowGeometry",value:function(){return this._shadowGeometry||(this._shadowGeometry=new u.tcD(.9*h.R,9),this._shadowGeometry.applyMatrix4(new u.kn4().makeTranslation(0,0,-(.99*h.R)))),this._shadowGeometry}},{key:"getShadowMaterial",value:function(){return this._shadowMaterial||(this._shadowMaterial=new u.V9B({color:1118498})),this._shadowMaterial}},{key:"addDots",value:function(e,t){var r=e.attributes.position.count,i=new u.Q1f(t);e.setAttribute("color",new u.THS(new Float32Array(3*r),3));for(var o=e.attributes.color,s=0;s<r/3;s++)n.colorVerticesForFace(s,o,n.scaleNoise(i.r),n.scaleNoise(i.g),n.scaleNoise(i.b));var a=new u.Q1f(0xaa2222);[0,96,111,156,186,195].forEach(function(e){n.colorVerticesForFace(e/3,o,a.r,a.g,a.b)})}},{key:"colorVerticesForFace",value:function(e,t,n,r,i){t.setXYZ(3*e+0,n,r,i),t.setXYZ(3*e+1,n,r,i),t.setXYZ(3*e+2,n,r,i)}},{key:"scaleNoise",value:function(e){return(1-.25*Math.random())*e}}],e&&y(n.prototype,e),t&&y(n,t),n}();function g(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function w(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}m(b,"_ballGeometry",void 0),m(b,"_shadowGeometry",void 0),m(b,"_shadowMaterial",void 0),m(b,"_dottedGeometryCache",new Map);var k=((a={}).Stationary="Stationary",a.Rolling="Rolling",a.Sliding="Sliding",a.Falling="Falling",a.InPocket="InPocket",a),T=function(){var e,t;function n(e,t,r){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");w(this,"pos",void 0),w(this,"vel",l.v_.clone()),w(this,"rvel",l.v_.clone()),w(this,"futurePos",l.v_.clone()),w(this,"ballmesh",void 0),w(this,"state","Stationary"),w(this,"pocket",void 0),w(this,"id",n.id++),w(this,"label",void 0),this.pos=e.clone(),this.label=r,this.ballmesh=new b(t||0xeeeeee*Math.random(),r)}return e=[{key:"update",value:function(e){this.updatePosition(e),"Falling"==this.state?this.pocket.updateFall(this,e):this.updateVelocity(e)}},{key:"updateMesh",value:function(e){this.ballmesh.updateAll(this,e)}},{key:"updatePosition",value:function(e){this.pos.addScaledVector(this.vel,e)}},{key:"updateVelocity",value:function(e){this.inMotion()&&(this.isRolling()?(this.state="Rolling",(0,c.lx)(this.vel,this.rvel),this.addDelta(e,(0,c.JD)(this.rvel))):(this.state="Sliding",this.addDelta(e,(0,c.p2)(this.vel,this.rvel))))}},{key:"addDelta",value:function(e,t){t.v.multiplyScalar(e),t.w.multiplyScalar(e),this.passesZero(t)||(this.vel.add(t.v),this.rvel.add(t.w))}},{key:"passesZero",value:function(e){var t=(0,l.rq)(this.vel,e.v),n=(0,l.rq)(this.rvel,e.w);return!!(("Rolling"===this.state?t||n:t&&n)&&.01>Math.abs(this.rvel.z))&&(this.setStationary(),!0)}},{key:"setStationary",value:function(){this.vel.copy(l.v_),this.rvel.copy(l.v_),this.state="Stationary"}},{key:"isRolling",value:function(){return 0!==this.vel.lengthSq()&&0!==this.rvel.lengthSq()&&(0,c.Mq)(this.vel,this.rvel).length()<n.transition}},{key:"onTable",value:function(){return"Falling"!==this.state&&"InPocket"!==this.state}},{key:"inMotion",value:function(){return"Rolling"===this.state||"Sliding"===this.state||this.isFalling()}},{key:"isFalling",value:function(){return"Falling"===this.state}},{key:"futurePosition",value:function(e){return this.futurePos.copy(this.pos).addScaledVector(this.vel,e),this.futurePos}},{key:"fround",value:function(){this.pos.x=Math.fround(this.pos.x),this.pos.y=Math.fround(this.pos.y),this.vel.x=Math.fround(this.vel.x),this.vel.y=Math.fround(this.vel.y),this.rvel.x=Math.fround(this.rvel.x),this.rvel.y=Math.fround(this.rvel.y),this.rvel.z=Math.fround(this.rvel.z)}},{key:"serialise",value:function(){return{pos:this.pos.clone(),id:this.id}}}],t=[{key:"fromSerialised",value:function(e){return n.updateFromSerialised(new n((0,l.t6)(e.pos)),e)}},{key:"updateFromSerialised",value:function(e,t){var n,r;return e.pos.copy(t.pos),e.vel.copy(null!=(n=null==t?void 0:t.vel)?n:l.v_),e.rvel.copy(null!=(r=null==t?void 0:t.rvel)?r:l.v_),e}}],e&&g(n.prototype,e),t&&g(n,t),n}();w(T,"id",0),w(T,"transition",.05)},"./src/model/outcome.ts"(e,t,n){n.d(t,{$:()=>o,P:()=>s});function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var i,o=((i={}).Pot="Pot",i.Cushion="Cushion",i.Collision="Collision",i.Hit="Hit",i),s=function(){var e;function t(e,n,i,o){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");r(this,"type",void 0),r(this,"timestamp",void 0),r(this,"ballA",null),r(this,"ballB",null),r(this,"incidentSpeed",void 0),this.type=e,this.ballA=n,this.ballB=i,this.incidentSpeed=o,this.timestamp=Date.now()}return e=[{key:"pot",value:function(e,n){return new t("Pot",e,e,n)}},{key:"cushion",value:function(e,n){return new t("Cushion",e,e,n)}},{key:"collision",value:function(e,n,r){return new t("Collision",e,n,r)}},{key:"hit",value:function(e,n){return new t("Hit",e,e,n)}},{key:"isCueBallPotted",value:function(e,t){return t.some(function(t){return"Pot"==t.type&&t.ballA===e})}},{key:"isBallPottedNoFoul",value:function(e,n){return n.some(function(e){return"Pot"==e.type&&null!==e.ballA})&&!t.isCueBallPotted(e,n)}},{key:"pots",value:function(e){return e.filter(function(e){return"Pot"==e.type}).map(function(e){return e.ballA})}},{key:"potCount",value:function(e){return this.pots(e).length}},{key:"onlyRedsPotted",value:function(e){return this.pots(e).every(function(e){return e.id>6})}},{key:"firstCollision",value:function(e){var t=e.filter(function(e){return"Collision"===e.type});return t.length>0?t[0]:void 0}},{key:"isClearTable",value:function(e){var t=e.balls.filter(function(e){return e.onTable()});return 1===t.length&&t[0]===e.cueball}},{key:"isThreeCushionPoint",value:function(e,n){n=t.cueBallFirst(e,n).filter(function(t){return t.ballA===e});var r=new Set,i=0,o=!0,s=!1,a=void 0;try{for(var l,c=n[Symbol.iterator]();!(o=(l=c.next()).done);o=!0){var u=l.value;if("Cushion"===u.type&&i++,"Collision"===u.type&&(r.add(u.ballB),2===r.size))return i>=3}}catch(e){s=!0,a=e}finally{try{o||null==c.return||c.return()}finally{if(s)throw a}}return!1}},{key:"cueBallFirst",value:function(e,t){return t.forEach(function(t){"Collision"===t.type&&t.ballB===e&&(t.ballB=t.ballA,t.ballA=e)}),t}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/model/physics/collision.ts"(e,t,n){n.d(t,{F:()=>h});var r,i,o=n("./src/model/ball.ts"),s=n("./node_modules/three/build/three.core.js"),a=n("./src/model/physics/constants.ts"),l=n("./src/utils/utils.ts");function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var u=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");c(this,"normalImpulse",void 0),c(this,"tangentialImpulse",void 0)}return e=[{key:"dynamicFriction",value:function(e){return .01+.108*(0,l.oN)(-1.088*e)}},{key:"updateVelocities",value:function(e,t){var n=h.positionsAtContact(e,t);e.ballmesh.trace.forceTrace(n.a),t.ballmesh.trace.forceTrace(n.b);var r=n.b.sub(n.a).normalize(),i=new s.Pq0(-r.y,r.x,0),o=e.vel.clone().sub(t.vel).add(r.clone().multiplyScalar(-a.R).cross(e.rvel).sub(r.clone().multiplyScalar(a.R).cross(t.rvel))),l=r.dot(o),c=o.addScaledVector(r,-l),u=c.length(),f=i.dot(c),p=this.dynamicFriction(u);this.normalImpulse=-1.99*l/(2/a.m),this.tangentialImpulse=-(.25*Math.min(p*Math.abs(this.normalImpulse)/u,1/7)*f);var d=r.clone().multiplyScalar(this.normalImpulse),v=i.clone().multiplyScalar(this.tangentialImpulse);e.vel.addScaledVector(d,1/a.m).addScaledVector(v,1/a.m),t.vel.addScaledVector(d,-1/a.m).addScaledVector(v,-1/a.m);var y=r.clone().multiplyScalar(-a.R).cross(v),m=r.clone().multiplyScalar(a.R).cross(v);return e.rvel.addScaledVector(y,1/a.I),t.rvel.addScaledVector(m,1/a.I),l}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),h=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"willCollide",value:function(e,t,n){return(e.inMotion()||t.inMotion())&&e.onTable()&&t.onTable()&&e.futurePosition(n).distanceToSquared(t.futurePosition(n))<4*a.R*a.R}},{key:"collide",value:function(e,n){return t.updateVelocities(e,n)}},{key:"positionsAtContact",value:function(e,t){var n=e.pos.distanceTo(t.pos),r=e.vel.clone().sub(t.vel),i=(n-2*a.R)/r.length()||0;return{a:e.pos.clone().addScaledVector(e.vel,i),b:t.pos.clone().addScaledVector(t.vel,i)}}},{key:"updateVelocities",value:function(e,n){var r=t.model.updateVelocities(e,n);return e.state=o.U.Sliding,n.state=o.U.Sliding,r}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();r="model",i=new u,r in h?Object.defineProperty(h,r,{value:i,enumerable:!0,configurable:!0,writable:!0}):h[r]=i},"./src/model/physics/constants.ts"(e,t,n){n.d(t,{I:()=>o,Mz:()=>r,PX:()=>A,Qg:()=>k,R:()=>f,Wv:()=>x,Ys:()=>P,Z3:()=>m,_m:()=>y,cM:()=>S,e:()=>p,ee:()=>d,g:()=>s,gT:()=>c,gf:()=>l,jG:()=>w,kL:()=>u,kM:()=>O,ki:()=>E,ko:()=>R,m:()=>h,mu:()=>a,o5:()=>b,oV:()=>v,x3:()=>i,xO:()=>T});var r,i,o,s=9.8,a=.00985,l=.16,c=.85,u=.034,h=.23,f=.03275,p=.86,d=.98,v=.212,y=.14,m=.4,b=Math.sqrt(21)/5;function g(){r=a*h*s*2/3*u,i=7/(5*Math.sqrt(2))*f*a*h*s,o=.4*h*f*f}function w(e){f=e,g()}function k(e){h=e,g()}function T(e){a=e,g()}function x(e){u=e,g()}function P(e){l=e}function S(e){p=e}function O(e){c=e}function R(e){v=e}function E(e){y=e}function A(e){d=e}g()},"./src/model/physics/knuckle.ts"(e,t,n){n.d(t,{O:()=>a});var r=n("./src/model/physics/constants.ts"),i=n("./src/view/pocketgeometry.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e,t;function n(e,t){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");s(this,"pos",void 0),s(this,"radius",void 0),this.pos=e,this.radius=t}return e=[{key:"bounce",value:function(e){var t=e.pos.clone().sub(this.pos).normalize(),n=t.dot(e.vel);return e.vel.addScaledVector(t,-2*r.e*n),e.rvel.multiplyScalar(.5),Math.abs(n)}}],t=[{key:"willBounce",value:function(e,t){return t.distanceTo(e.pos)<r.R+e.radius}},{key:"findBouncing",value:function(e,t){var r=e.futurePosition(t);return i.f.knuckles.find(function(e){return n.willBounce(e,r)})}}],e&&o(n.prototype,e),t&&o(n,t),n}()},"./src/model/physics/mathaven.ts"(e,t,n){n.d(t,{z:()=>s});var r=n("./src/utils/utils.ts"),i=n("./src/model/physics/constants.ts");function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var s=function(){var e;function t(e,n,r,i,s){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");o(this,"P",0),o(this,"WzI",0),o(this,"vx",void 0),o(this,"vy",void 0),o(this,"Ï‰x",void 0),o(this,"Ï‰y",void 0),o(this,"Ï‰z",void 0),o(this,"s",void 0),o(this,"Ï†",void 0),o(this,"sÊ¹",void 0),o(this,"Ï†Ê¹",void 0),o(this,"i",0),o(this,"N",100),o(this,"M",void 0),o(this,"R",void 0),o(this,"Î¼s",void 0),o(this,"Î¼w",void 0),o(this,"ee",void 0),this.M=e,this.R=n,this.ee=r,this.Î¼s=i,this.Î¼w=s}return e=[{key:"updateSlipSpeedsAndAngles",value:function(){var e=this.R,t=this.vx+this.Ï‰y*e*i.Z3-this.Ï‰z*e*i.o5,n=-this.vy*i.Z3+this.Ï‰x*e,o=this.vx-this.Ï‰y*e,s=this.vy+this.Ï‰x*e;this.s=(0,r.RZ)((0,r.n7)(t,2)+(0,r.n7)(n,2)),this.Ï†=(0,r.FP)(n,t),this.Ï†<0&&(this.Ï†+=2*Math.PI),this.sÊ¹=(0,r.RZ)((0,r.n7)(o,2)+(0,r.n7)(s,2)),this.Ï†Ê¹=(0,r.FP)(s,o),this.Ï†Ê¹<0&&(this.Ï†Ê¹+=2*Math.PI)}},{key:"compressionPhase",value:function(){for(var e=Math.max(this.M*this.vy/this.N,.001);this.vy>0;)this.updateSingleStep(e)}},{key:"restitutionPhase",value:function(e){var t=Math.max(e/this.N,.001);for(this.WzI=0;this.WzI<e;)this.updateSingleStep(t)}},{key:"updateSingleStep",value:function(e){if(this.updateSlipSpeedsAndAngles(),this.updateVelocity(e),this.updateAngularVelocity(e),this.updateWorkDone(e),this.i++>10*this.N)throw Error("Solution not found")}},{key:"updateVelocity",value:function(e){var t=this.Î¼s,n=this.Î¼w,o=this.M;this.vx-=1/o*(n*(0,r.gn)(this.Ï†)+t*(0,r.gn)(this.Ï†Ê¹)*(i.Z3+n*(0,r.F8)(this.Ï†)*i.o5))*e,this.vy-=1/o*(i.o5-n*i.Z3*(0,r.F8)(this.Ï†)+t*(0,r.F8)(this.Ï†Ê¹)*(i.Z3+n*(0,r.F8)(this.Ï†)*i.o5))*e}},{key:"updateAngularVelocity",value:function(e){var t=this.Î¼s,n=this.Î¼w,o=this.M,s=this.R;this.Ï‰x+=-(5/(2*o*s))*(n*(0,r.F8)(this.Ï†)+t*(0,r.F8)(this.Ï†Ê¹)*(i.Z3+n*(0,r.F8)(this.Ï†)*i.o5))*e,this.Ï‰y+=-(5/(2*o*s))*(n*(0,r.gn)(this.Ï†)*i.Z3-t*(0,r.gn)(this.Ï†Ê¹)*(i.Z3+n*(0,r.F8)(this.Ï†)*i.o5))*e,this.Ï‰z+=5/(2*o*s)*(n*(0,r.gn)(this.Ï†)*i.o5)*e}},{key:"updateWorkDone",value:function(e){var t=e*Math.abs(this.vy);this.WzI+=t,this.P+=e}},{key:"solvePaper",value:function(e,t,n,i){this.solve(e*(0,r.gn)(t),e*(0,r.F8)(t),-i*(0,r.F8)(t),i*(0,r.gn)(t),n)}},{key:"solve",value:function(e,t,n,r,i){this.vx=e,this.vy=t,this.Ï‰x=n,this.Ï‰y=r,this.Ï‰z=i,this.WzI=0,this.P=0,this.i=0,this.compressionPhase();var o=this.ee*this.ee*this.WzI;this.restitutionPhase(o)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/model/physics/physics.ts"(e,t,n){n.d(t,{$8:()=>O,Gp:()=>w,JD:()=>h,Mq:()=>l,QK:()=>p,QV:()=>S,Qy:()=>A,Un:()=>g,c0:()=>b,lx:()=>f,p2:()=>u,s0:()=>m,t6:()=>M,yO:()=>k});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/utils/utils.ts"),o=n("./src/model/physics/constants.ts"),s=n("./src/model/physics/mathaven.ts"),a=new r.Pq0;function l(e,t){return a.copy(e).addScaledVector((0,i.KM)(t),o.R)}var c={v:new r.Pq0,w:new r.Pq0};function u(e,t){var n=l(e,t).setZ(0);return c.v.copy((0,i.xb)(n).multiplyScalar(-o.gf*o.g)),c.w.copy((0,i.xb)((0,i.KM)(n)).multiplyScalar(2.5*o.gf*o.g/o.R)),c.w.setZ(-2.5*(o.Mz/(o.m*o.R*o.R))*Math.sign(t.z)),c}function h(e){var t=new r.Pq0(e.x,e.y,0).length(),n=5/7*o.x3/(o.m*o.R)/t,i=5/7*o.x3/(o.m*o.R*o.R)/t;return c.v.set(-n*e.y,n*e.x,0),c.w.set(-i*e.x,-i*e.y,-2.5*(o.Mz/(o.m*o.R*o.R))*Math.sign(e.z)),c}function f(e,t){var n=t.z;t.copy((0,i.KM)(e).multiplyScalar(1/o.R)),t.setZ(n)}function p(e,t,n,r){var o=r(t.clone().applyAxisAngle(i.up,e),n.clone().applyAxisAngle(i.up,e));return o.v.applyAxisAngle(i.up,-e),o.w.applyAxisAngle(i.up,-e),o}Object.freeze(c);var d=Math.asin(.1*o.R/o.R),v=(0,i.F8)(d),y=(0,i.gn)(d);function m(e,t){return new r.Pq0(e.x*v-e.z*y+o.R*t.y,-e.y-o.R*t.z*y+o.R*t.x*v)}function b(e){return e.x*y}function g(e){var t=3.5/o.m;return e.length()/t}function w(e){var t,n=1/o.m,i=.39+.257*(t=new r.Pq0(e/y,0,0)).x-.044*t.x*t.x;return o.gT*((1+i)*e)/n}function k(e,t){var n=w(b(e));return g(m(e,t))<=n}function T(e,t){return{c:b(e),s:m(e,t),A:3.5/o.m,B:1/o.m}}function x(e,t){var n=T(e,t),r=n.c,i=n.s,s=n.A,a=n.B,l=(1+o.e)*(r/a);return R(-i.x/s*v-l*y,i.y/s,i.x/s*y-l*v)}function P(e,t){var n,r=T(e,t),i=r.c,s=r.B,a=(1+o.e)*(i/s),l=.471-.241*Math.atan2(Math.abs((n=e).y),n.x),c=Math.atan2(e.y,e.x),u=Math.cos(c);return R(-l*a*u*y-a*y,l*a*Math.sin(c),l*a*u*y-a*v)}function S(e,t){return k(e,t)?x(e,t):P(e,t)}function O(e,t){var n=x(e,t),r=P(e,t),i=Math.sign(e.y)===Math.sign(t.z)?Math.cos(Math.atan2(e.y,e.x)):1;return{v:r.v.lerp(n.v,i),w:r.w.lerp(n.w,i)}}function R(e,t,n){return{v:new r.Pq0(e/o.m,t/o.m),w:new r.Pq0(-o.R/o.I*t*v,o.R/o.I*(e*v-n*y),o.R/o.I*t*y)}}function E(e,t){var n=new s.z(o.m,o.R,o.ee,o.oV,o._m+.1);n.solve(e.x,e.y,t.x,t.y,t.z);var i=new r.Pq0(n.vx,n.vy,0),a=new r.Pq0(n.Ï‰x,n.Ï‰y,n.Ï‰z);return{v:i.sub(e),w:a.sub(t)}}function A(e,t){return p(Math.PI/2,e,t,E)}function M(e,t){var n=Math.atan2(-e.x,e.y),r=2.5*t.length()*(e.length()*o.R)/(o.R*o.R),s=t.clone().normalize();return(0,i.KM)(s).applyAxisAngle(s,n).multiplyScalar(r)}},"./src/model/physics/pocket.ts"(e,t,n){n.d(t,{Z:()=>l});var r=n("./src/model/ball.ts"),i=n("./src/model/physics/constants.ts"),o=n("./src/utils/utils.ts");function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var l=function(){var e,t;function n(e,t){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");a(this,"pos",void 0),a(this,"radius",void 0),this.pos=e,this.radius=t}return e=[{key:"fall",value:function(e,t){return e.vel.z=-i.g*t,e.state=r.U.Falling,e.pocket=this,e.vel.length()}},{key:"updateFall",value:function(e,t){e.vel.addScaledVector(o.up,-(10*i.R)*t*i.g);var n=e.pos.z;if(e.pos.clone().setZ(0).distanceTo(this.pos)>this.radius-i.R){var s=this.pos.clone().sub(e.pos).normalize().setZ(0);n>-i.R/2&&(e.vel.addScaledVector(s,7*i.R*t*i.g),e.rvel.addScaledVector((0,o.KM)(s),7*t*i.g)),0>e.vel.dot(s)&&(e.ballmesh.trace.forceTrace(e.pos),e.vel.x=s.x*e.vel.length()/2,e.vel.y=s.y*e.vel.length()/2)}var a=this.restingDepth(e);n<a&&0!==e.rvel.length()&&(e.pos.z=a,e.vel.z=-i.R/10,e.rvel.copy(o.v_)),n<a-i.R&&(e.pos.z=a-i.R,e.setStationary(),e.state=r.U.InPocket)}},{key:"restingDepth",value:function(e){return -3*i.R-i.R*e.id/4}}],t=[{key:"willFall",value:function(e,t){return t.distanceTo(e.pos)<e.radius}},{key:"findPocket",value:function(e,t,r){var i=t.futurePosition(r);return e.find(function(e){return n.willFall(e,i)})}}],e&&s(n.prototype,e),t&&s(n,t),n}()},"./src/model/table.ts"(e,t,n){n.d(t,{X:()=>b});var r=n("./src/view/tablegeometry.ts"),i=n("./src/model/physics/physics.ts"),o=n("./src/view/pocketgeometry.ts"),s=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"bounceAny",value:function(e,n){var o=!(arguments.length>2)||void 0===arguments[2]||arguments[2],s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:i.$8,a=e.futurePosition(n);if(t.willBounceLong(a,o)){var l=a.y>r.P.tableY?-Math.PI/2:Math.PI/2;return t.bounceIn(l,e,s)}if(t.willBounceShort(a,o)){var c=a.x>r.P.tableX?0:Math.PI;return t.bounceIn(c,e,s)}}},{key:"willBounceShort",value:function(e,n){return n?t.willBounceShortSegment(o.f.pockets.pocketNW.knuckleSW.pos.y,o.f.pockets.pocketSW.knuckleNW.pos.y,e):t.willBounceShortSegment(r.P.Y,-r.P.Y,e)}},{key:"willBounceLong",value:function(e,n){return n?t.willBounceLongSegment(o.f.pockets.pocketNW.knuckleNE.pos.x,o.f.pockets.pocketN.knuckleNW.pos.x,e)||t.willBounceLongSegment(o.f.pockets.pocketN.knuckleNE.pos.x,o.f.pockets.pocketNE.knuckleNW.pos.x,e):t.willBounceLongSegment(-r.P.X,r.P.X,e)}},{key:"willBounceLongSegment",value:function(e,t,n){return n.x>e&&n.x<t&&Math.abs(n.y)>r.P.tableY}},{key:"willBounceShortSegment",value:function(e,t,n){return n.y>t&&n.y<e&&Math.abs(n.x)>r.P.tableX}},{key:"bounceIn",value:function(e,t,n){t.ballmesh.trace.forceTrace(t.futurePos);var r=(0,i.QK)(e,t.vel,t.rvel,n);return t.vel.add(r.v),t.rvel.add(r.w),r.v.length()}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}(),a=n("./src/model/physics/collision.ts"),l=n("./src/model/physics/knuckle.ts"),c=n("./src/model/physics/pocket.ts"),u=n("./src/view/cue.ts"),h=n("./src/model/ball.ts"),f=n("./src/events/aimevent.ts"),p=n("./src/model/outcome.ts"),d=n("./src/utils/utils.ts"),v=n("./src/model/physics/constants.ts");function y(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var b=function(){var e,t;function n(e){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");m(this,"balls",void 0),m(this,"cue",new u.s),m(this,"pairs",void 0),m(this,"outcome",[]),m(this,"cueball",void 0),m(this,"cushionModel",i.$8),m(this,"mesh",void 0),this.cueball=e[0],this.initialiseBalls(e)}return e=[{key:"initialiseBalls",value:function(e){this.balls=e,this.pairs=[];for(var t=0;t<e.length;t++)for(var n=0;n<e.length;n++)t<n&&this.pairs.push({a:e[t],b:e[n]})}},{key:"updateBallMesh",value:function(e){this.balls.forEach(function(t){t.updateMesh(e)})}},{key:"advance",value:function(e){for(var t=0;!this.prepareAdvanceAll(e);)if(t++>100)throw Error("Depth exceeded resolving collisions");this.balls.forEach(function(t){t.update(e),t.fround()})}},{key:"prepareAdvanceAll",value:function(e){var t=this;return this.pairs.every(function(n){return t.prepareAdvancePair(n.a,n.b,e)})&&this.balls.every(function(n){return t.prepareAdvanceToCushions(n,e)})}},{key:"prepareAdvancePair",value:function(e,t,n){if(a.F.willCollide(e,t,n)){var r=a.F.collide(e,t);return this.outcome.push(p.P.collision(e,t,r)),!1}return!0}},{key:"prepareAdvanceToCushions",value:function(e,t){if(!e.onTable())return!0;var n=e.futurePosition(t);if(Math.abs(n.y)<r.P.tableY&&Math.abs(n.x)<r.P.tableX)return!0;var i=s.bounceAny(e,t,r.P.hasPockets,this.cushionModel);if(i)return this.outcome.push(p.P.cushion(e,i)),!1;var a=l.O.findBouncing(e,t);if(a){var u=a.bounce(e);return this.outcome.push(p.P.cushion(e,u)),!1}var h=c.Z.findPocket(o.f.pocketCenters,e,t);if(h){var f=h.fall(e,t);return this.outcome.push(p.P.pot(e,f)),!1}return!0}},{key:"allStationary",value:function(){return this.balls.every(function(e){return!e.inMotion()})}},{key:"inPockets",value:function(){return this.balls.reduce(function(e,t){return t.onTable()?e:e+1},0)}},{key:"hit",value:function(){this.cue.hit(this.cueball),this.balls.forEach(function(e){e.ballmesh.trace.reset()})}},{key:"serialise",value:function(){return{balls:this.balls.map(function(e){return e.serialise()}),aim:this.cue.aim.copy()}}},{key:"updateFromSerialised",value:function(e){var t=this;e.balls&&e.balls.forEach(function(e){return h.c.updateFromSerialised(t.balls[e.id],e)}),e.aim&&(this.cue.aim=f.w.fromJson(e.aim))}},{key:"shortSerialise",value:function(){return this.balls.map(function(e){return[e.pos.x,e.pos.y]}).reduce(function(e,t){return e.concat(t)},[])}},{key:"updateFromShortSerialised",value:function(e){this.balls.forEach(function(t,n){t.pos.x=e[2*n],t.pos.y=e[2*n+1],t.pos.z=0,t.vel.copy(d.v_),t.rvel.copy(d.v_),t.state=h.U.Stationary})}},{key:"addToScene",value:function(e){this.balls.forEach(function(t){t.ballmesh.addToScene(e)}),e.add(this.cue.mesh),e.add(this.cue.helperMesh),e.add(this.cue.placerMesh)}},{key:"showTraces",value:function(e){this.balls.forEach(function(t){t.ballmesh.trace.line.visible=e,t.ballmesh.trace.reset()})}},{key:"showSpin",value:function(e){this.balls.forEach(function(t){t.ballmesh.spinAxisArrow.visible=e})}},{key:"halt",value:function(){this.balls.forEach(function(e){e.vel.copy(d.v_),e.rvel.copy(d.v_),e.state=h.U.Stationary})}},{key:"roundCueBallPosition",value:function(){var e=this.cueball.pos.clone();this.overlapsAny(e)||this.cueball.pos.copy(e)}},{key:"overlapsAny",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.cueball;return this.balls.filter(function(e){return e!==t}).some(function(t){return t.pos.distanceTo(e)<2*v.R})}}],t=[{key:"fromSerialised",value:function(e){var t=new n(e.balls.map(function(e){return h.c.fromSerialised(e)}));return t.updateFromSerialised(e),t}}],e&&y(n.prototype,e),t&&y(n,t),n}()},"./src/network/client/matchresult.ts"(e,t,n){n.d(t,{n:()=>l});var r=n("./src/events/chatevent.ts"),i=n("./src/events/notificationevent.ts"),o=n("./src/controller/end.ts"),s=n("./src/network/client/session.ts"),a=n("./src/utils/gameover.ts"),l=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"presentGameEnd",value:function(e,t){e.eventQueue.push(new r.b(null,"game over")),e.recorder.wholeGameLink();var n=s.N.hasInstance()?s.N.getInstance():null,i=s.N.playerIndex(),a=(e.scores[0]>=e.scores[1]?0:1)===i,l=this.getScoreSubtext(e,n,i);a?(this.notifyWin(e,l),this.sendLossNotification(e)):s.N.isSpectator()?this.notifySpectator(e,l):this.notifyLoss(e,l);var c=this.createMatchResult(e,t,n,i);return new o.o(e,a?c:void 0)}},{key:"notifyWin",value:function(e,t){e.notifyLocal({type:"GameOver",title:"YOU WON",subtext:t,icon:"ðŸ†",extraClass:"is-winner",extra:a.c.forMode(e.isSinglePlayer),duration:0})}},{key:"notifyLoss",value:function(e,t){e.notifyLocal({type:"GameOver",title:"YOU LOST",subtext:t,icon:"ðŸ¥ˆ",extraClass:"is-loser",extra:a.c.forMode(e.isSinglePlayer),duration:0})}},{key:"notifySpectator",value:function(e,t){e.notifyLocal({type:"GameOver",title:"GAME OVER",subtext:t,icon:"ðŸ†",extraClass:"",extra:a.c.lobby,duration:0})}},{key:"sendLossNotification",value:function(e){e.isSinglePlayer||e.sendEvent(new i.c({type:"GameOver",title:"YOU LOST",icon:"ðŸ¥ˆ",extraClass:"is-loser",extra:a.c.forMode(!1),duration:0}))}},{key:"getScoreSubtext",value:function(e,t,n){if(e.isSinglePlayer)return"Score: ".concat(e.scores[n]);var r=0===n?(null==t?void 0:t.playername)||"You":(null==t?void 0:t.opponentName)||"Opponent",i=1===n?(null==t?void 0:t.playername)||"You":(null==t?void 0:t.opponentName)||"Opponent";return"".concat(r," ").concat(e.scores[0]," - ").concat(e.scores[1]," ").concat(i)}},{key:"createMatchResult",value:function(e,t,n,r){var i=e.scores[0]>=e.scores[1]?0:1,o=1-i,s=i===r?(null==n?void 0:n.playername)||"Anon":(null==n?void 0:n.opponentName)||"Opponent",a=o===r?(null==n?void 0:n.playername)||"Anon":(null==n?void 0:n.opponentName)||"Opponent",l={winner:s,winnerScore:e.scores[i],ruleType:t};return(null==n?void 0:n.opponentName)&&(l.loser=a,l.loserScore=e.scores[o]),l}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/network/client/nchanmessagerelay.ts"(e,t,n){function r(e,t,n,r,i,o,s){try{var a=e[o](s),l=a.value}catch(e){n(e);return}a.done?t(l):Promise.resolve(l).then(r,i)}n.d(t,{p:()=>o});function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var o=function(){var e;function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"billiards-network.onrender.com";if(!(this instanceof t))throw TypeError("Cannot call a class as a function");i(this,"baseURL",void 0),i(this,"websockets",void 0),this.baseURL=e,this.websockets=new Map}return e=[{key:"subscribe",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"table",r="wss://".concat(this.baseURL,"/subscribe/").concat(n,"/").concat(e),i=new WebSocket(r);console.log("Subscribed to ",r),i.onmessage=function(e){try{var n=e.data;t(n)}catch(e){console.error("Error parsing message:",e)}},i.onerror=function(e){console.error("WebSocket error:",e)},i.onopen=function(){console.log("Connected to ".concat(r))},i.onclose=function(e){console.log("Disconnected from ".concat(r,":"),e.reason)},this.websockets.set("".concat(n,"/").concat(e),i)}},{key:"publish",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"table";fetch("https://".concat(this.baseURL,"/publish/").concat(n,"/").concat(e),{method:"POST",headers:{"Content-Type":"application/json"},body:t}).catch(function(e){console.error("Publication error:",e)})}},{key:"getOnlineCount",value:function(){var e;return(e=function(){var e;return function(e,t){var n,r,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype),a=Object.defineProperty;return a(s,"next",{value:l(0)}),a(s,"throw",{value:l(1)}),a(s,"return",{value:l(2)}),"function"==typeof Symbol&&a(s,Symbol.iterator,{value:function(){return this}}),s;function l(a){return function(l){var c=[a,l];if(n)throw TypeError("Generator is already executing.");for(;s&&(s=0,c[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&c[0]?r.return:c[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,c[1])).done)return i;switch(r=0,i&&(c=[2&c[0],i.value]),c[0]){case 0:case 1:i=c;break;case 4:return o.label++,{value:c[1],done:!1};case 5:o.label++,r=c[1],c=[0];continue;case 7:c=o.ops.pop(),o.trys.pop();continue;default:if(!(i=(i=o.trys).length>0&&i[i.length-1])&&(6===c[0]||2===c[0])){o=0;continue}if(3===c[0]&&(!i||c[1]>i[0]&&c[1]<i[3])){o.label=c[1];break}if(6===c[0]&&o.label<i[1]){o.label=i[1],i=c;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(c);break}i[2]&&o.ops.pop(),o.trys.pop();continue}c=t.call(e,o)}catch(e){c=[6,e],r=0}finally{n=i=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}}(this,function(t){switch(t.label){case 0:return t.trys.push([0,3,,4]),[4,fetch("https://".concat(this.baseURL,"/publish/presence/lobby"),{method:"POST",headers:{Accept:"application/json"}})];case 1:return[4,t.sent().json()];case 2:return[2,"number"==typeof(e=t.sent()).subscribers?e.subscribers:null];case 3:return t.sent(),[2,null];case 4:return[2]}})},function(){var t=this,n=arguments;return new Promise(function(i,o){var s=e.apply(t,n);function a(e){r(s,i,o,a,l,"next",e)}function l(e){r(s,i,o,a,l,"throw",e)}a(void 0)})}).call(this)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/network/client/session.ts"(e,t,n){n.d(t,{N:()=>i});function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var i=function(){var e;function t(e,n,i,o){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");r(this,"playername",void 0),r(this,"clientId",void 0),r(this,"tableId",void 0),r(this,"spectator",void 0),r(this,"opponentName",void 0),r(this,"playerIndex",void 0),this.playername=e,this.clientId=n,this.tableId=i,this.spectator=o,this.playerIndex=0}return e=[{key:"getInstance",value:function(){if(!t.instance)throw Error("Session not initialized");return t.instance}},{key:"hasInstance",value:function(){return void 0!==t.instance}},{key:"playerIndex",value:function(){return t.instance?t.instance.playerIndex:0}},{key:"isSpectator",value:function(){return void 0!==t.instance&&t.getInstance().spectator}},{key:"reset",value:function(){t.instance=void 0}},{key:"init",value:function(e,n,r,i){t.instance=new t(n,e,r,i)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();r(i,"instance",void 0)},"./src/utils/dom.ts"(e,t,n){function r(e){return document.getElementById(e)}function i(e){return document.getElementById(e)}function o(e){return document.getElementById(e)}function s(e){return document.getElementById(e)}n.d(t,{V4:()=>o,dX:()=>s,id:()=>r,vq:()=>i})},"./src/utils/gameover.ts"(e,t,n){n.d(t,{c:()=>r});var r={lobby:"<button onclick=\"location.href='".concat("https://scoreboard-tailuge.vercel.app/","'\">Lobby</button>"),newGame:'<button onclick="location.reload()">New Game</button>',replay:'<button onclick="location.reload()">Replay</button>',forMode:function(e){return e?this.newGame+this.lobby:this.lobby}}},"./src/utils/gltf.ts"(e,t,n){n.d(t,{KP:()=>eT,Ro:()=>ex});var r=n("./node_modules/three/build/three.core.js");let i={POSITION:["byte","byte normalized","unsigned byte","unsigned byte normalized","short","short normalized","unsigned short","unsigned short normalized"],NORMAL:["byte normalized","short normalized"],TANGENT:["byte normalized","short normalized"],TEXCOORD:["byte","byte normalized","unsigned byte","short","short normalized","unsigned short"]};class o{constructor(){this.textureUtils=null,this.pluginCallbacks=[],this.register(function(e){return new v(e)}),this.register(function(e){return new y(e)}),this.register(function(e){return new w(e)}),this.register(function(e){return new k(e)}),this.register(function(e){return new T(e)}),this.register(function(e){return new x(e)}),this.register(function(e){return new m(e)}),this.register(function(e){return new b(e)}),this.register(function(e){return new g(e)}),this.register(function(e){return new P(e)}),this.register(function(e){return new S(e)}),this.register(function(e){return new O(e)}),this.register(function(e){return new R(e)}),this.register(function(e){return new E(e)})}register(e){return -1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return -1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}setTextureUtils(e){return this.textureUtils=e,this}parse(e,t,n,r){let i=new d,o=[];for(let e=0,t=this.pluginCallbacks.length;e<t;e++)o.push(this.pluginCallbacks[e](i));i.setPlugins(o),i.setTextureUtils(this.textureUtils),i.writeAsync(e,t,r).catch(n)}parseAsync(e,t){let n=this;return new Promise(function(r,i){n.parse(e,r,i,t)})}}let s="KHR_mesh_quantization",a={};a[r.hxR]=9728,a[r.pHI]=9984,a[r.Cfg]=9986,a[r.k6q]=9729,a[r.kRr]=9985,a[r.$_I]=9987,a[r.ghU]=33071,a[r.GJx]=10497,a[r.kTW]=33648;let l={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},c=new r.Q1f;function u(e,t){return e.length===t.length&&e.every(function(e,n){return e===t[n]})}function h(e){return 4*Math.ceil(e/4)}function f(e,t=0){let n=h(e.byteLength);if(n!==e.byteLength){let r=new Uint8Array(n);if(r.set(new Uint8Array(e)),0!==t)for(let i=e.byteLength;i<n;i++)r[i]=t;return r.buffer}return e}function p(){return"u"<typeof document&&"u">typeof OffscreenCanvas?new OffscreenCanvas(1,1):document.createElement("canvas")}class d{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.extensionsRequired={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter r"+r.sPf}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map},this.textureUtils=null}setPlugins(e){this.plugins=e}setTextureUtils(e){this.textureUtils=e}async writeAsync(e,t,n={}){this.options=Object.assign({binary:!1,trs:!1,onlyVisible:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},n),this.options.animations.length>0&&(this.options.trs=!0),await this.processInputAsync(e),await Promise.all(this.pending);let r=this.buffers,i=this.json;n=this.options;let o=this.extensionsUsed,s=this.extensionsRequired,a=new Blob(r,{type:"application/octet-stream"}),l=Object.keys(o),c=Object.keys(s);if(l.length>0&&(i.extensionsUsed=l),c.length>0&&(i.extensionsRequired=c),i.buffers&&i.buffers.length>0&&(i.buffers[0].byteLength=a.size),!0===n.binary){let e=new FileReader;e.readAsArrayBuffer(a),e.onloadend=function(){var n;let r=f(e.result),o=new DataView(new ArrayBuffer(8));o.setUint32(0,r.byteLength,!0),o.setUint32(4,5130562,!0);let s=f((n=JSON.stringify(i),new TextEncoder().encode(n).buffer),32),a=new DataView(new ArrayBuffer(8));a.setUint32(0,s.byteLength,!0),a.setUint32(4,0x4e4f534a,!0);let l=new ArrayBuffer(12),c=new DataView(l);c.setUint32(0,0x46546c67,!0),c.setUint32(4,2,!0);let u=12+a.byteLength+s.byteLength+o.byteLength+r.byteLength;c.setUint32(8,u,!0);let h=new Blob([l,a,s,o,r],{type:"application/octet-stream"}),p=new FileReader;p.readAsArrayBuffer(h),p.onloadend=function(){t(p.result)}}}else if(i.buffers&&i.buffers.length>0){let e=new FileReader;e.readAsDataURL(a),e.onloadend=function(){let n=e.result;i.buffers[0].uri=n,t(i)}}else t(i)}serializeUserData(e,t){if(0===Object.keys(e.userData).length)return;let n=this.options,r=this.extensionsUsed;try{let i=JSON.parse(JSON.stringify(e.userData));if(n.includeCustomExtensions&&i.gltfExtensions){for(let e in void 0===t.extensions&&(t.extensions={}),i.gltfExtensions)t.extensions[e]=i.gltfExtensions[e],r[e]=!0;delete i.gltfExtensions}Object.keys(i).length>0&&(t.extras=i)}catch(t){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+t.message)}}getUID(e,t=!1){if(!1===this.uids.has(e)){let t=new Map;t.set(!0,this.uid++),t.set(!1,this.uid++),this.uids.set(e,t)}return this.uids.get(e).get(t)}isNormalizedNormalAttribute(e){if(this.cache.attributesNormalized.has(e))return!1;let t=new r.Pq0;for(let n=0,r=e.count;n<r;n++)if(Math.abs(t.fromBufferAttribute(e,n).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(e){let t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);let n=e.clone(),i=new r.Pq0;for(let e=0,t=n.count;e<t;e++)i.fromBufferAttribute(n,e),0===i.x&&0===i.y&&0===i.z?i.setX(1):i.normalize(),n.setXYZ(e,i.x,i.y,i.z);return t.attributesNormalized.set(e,n),n}applyTextureTransform(e,t){let n=!1,r={};(0!==t.offset.x||0!==t.offset.y)&&(r.offset=t.offset.toArray(),n=!0),0!==t.rotation&&(r.rotation=t.rotation,n=!0),(1!==t.repeat.x||1!==t.repeat.y)&&(r.scale=t.repeat.toArray(),n=!0),n&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=r,this.extensionsUsed.KHR_texture_transform=!0)}async buildMetalRoughTextureAsync(e,t){if(e===t)return e;function n(e){return e.colorSpace===r.er$?function(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}:function(e){return e}}e instanceof r.FvD&&(e=await this.decompressTextureAsync(e)),t instanceof r.FvD&&(t=await this.decompressTextureAsync(t));let i=e?e.image:null,o=t?t.image:null,s=Math.max(i?i.width:0,o?o.width:0),a=Math.max(i?i.height:0,o?o.height:0),l=p();l.width=s,l.height=a;let c=l.getContext("2d",{willReadFrequently:!0});c.fillStyle="#00ffff",c.fillRect(0,0,s,a);let u=c.getImageData(0,0,s,a);if(i){c.drawImage(i,0,0,s,a);let t=n(e),r=c.getImageData(0,0,s,a).data;for(let e=2;e<r.length;e+=4)u.data[e]=256*t(r[e]/256)}if(o){c.drawImage(o,0,0,s,a);let e=n(t),r=c.getImageData(0,0,s,a).data;for(let t=1;t<r.length;t+=4)u.data[t]=256*e(r[t]/256)}c.putImageData(u,0,0);let h=(e||t).clone();return h.source=new r.kLi(l),h.colorSpace=r.jf0,h.channel=(e||t).channel,e&&t&&e.channel!==t.channel&&console.warn("THREE.GLTFExporter: UV channels for metalnessMap and roughnessMap textures must match."),console.warn("THREE.GLTFExporter: Merged metalnessMap and roughnessMap textures."),h}async decompressTextureAsync(e,t=1/0){if(null===this.textureUtils)throw Error("THREE.GLTFExporter: setTextureUtils() must be called to process compressed textures.");return await this.textureUtils.decompress(e,t)}processBuffer(e){let t=this.json,n=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),n.push(e),0}processBufferView(e,t,n,i,o){let s,a=this.json;switch(!a.bufferViews&&(a.bufferViews=[]),t){case 5120:case 5121:s=1;break;case 5122:case 5123:s=2;break;default:s=4}let l=e.itemSize*s;34962===o&&(l=4*Math.ceil(l/4));let c=h(i*l),u=new DataView(new ArrayBuffer(c)),f=0;for(let o=n;o<n+i;o++){for(let n=0;n<e.itemSize;n++){let i;e.itemSize>4?i=e.array[o*e.itemSize+n]:(0===n?i=e.getX(o):1===n?i=e.getY(o):2===n?i=e.getZ(o):3===n&&(i=e.getW(o)),!0===e.normalized&&(i=r.cj9.normalize(i,e.array))),5126===t?u.setFloat32(f,i,!0):5124===t?u.setInt32(f,i,!0):5125===t?u.setUint32(f,i,!0):5122===t?u.setInt16(f,i,!0):5123===t?u.setUint16(f,i,!0):5120===t?u.setInt8(f,i):5121===t&&u.setUint8(f,i),f+=s}f%l!=0&&(f+=l-f%l)}let p={buffer:this.processBuffer(u.buffer),byteOffset:this.byteOffset,byteLength:c};return void 0!==o&&(p.target=o),34962===o&&(p.byteStride=l),this.byteOffset+=c,a.bufferViews.push(p),{id:a.bufferViews.length-1,byteLength:0}}processBufferViewImage(e){let t=this,n=t.json;return n.bufferViews||(n.bufferViews=[]),new Promise(function(r){let i=new FileReader;i.readAsArrayBuffer(e),i.onloadend=function(){let e=f(i.result),o={buffer:t.processBuffer(e),byteOffset:t.byteOffset,byteLength:e.byteLength};t.byteOffset+=e.byteLength,r(n.bufferViews.push(o)-1)}})}processAccessor(e,t,n,i){let o,s,a=this.json;if(e.array.constructor===Float32Array)o=5126;else if(e.array.constructor===Int32Array)o=5124;else if(e.array.constructor===Uint32Array)o=5125;else if(e.array.constructor===Int16Array)o=5122;else if(e.array.constructor===Uint16Array)o=5123;else if(e.array.constructor===Int8Array)o=5120;else if(e.array.constructor===Uint8Array)o=5121;else throw Error("THREE.GLTFExporter: Unsupported bufferAttribute component type: "+e.array.constructor.name);if(void 0===n&&(n=0),(void 0===i||i===1/0)&&(i=e.count),0===i)return null;let l=function(e,t,n){let i={min:Array(e.itemSize).fill(1/0),max:Array(e.itemSize).fill(-1/0)};for(let o=t;o<t+n;o++)for(let t=0;t<e.itemSize;t++){let n;e.itemSize>4?n=e.array[o*e.itemSize+t]:(0===t?n=e.getX(o):1===t?n=e.getY(o):2===t?n=e.getZ(o):3===t&&(n=e.getW(o)),!0===e.normalized&&(n=r.cj9.normalize(n,e.array))),i.min[t]=Math.min(i.min[t],n),i.max[t]=Math.max(i.max[t],n)}return i}(e,n,i);void 0!==t&&(s=e===t.index?34963:34962);let c=this.processBufferView(e,o,n,i,s),u={bufferView:c.id,byteOffset:c.byteOffset,componentType:o,count:i,max:l.max,min:l.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",9:"MAT3",16:"MAT4"}[e.itemSize]};return!0===e.normalized&&(u.normalized=!0),a.accessors||(a.accessors=[]),a.accessors.push(u)-1}processImage(e,t,n,i="image/png"){if(null!==e){let o=this,s=o.cache,a=o.json,l=o.options,c=o.pending;s.images.has(e)||s.images.set(e,{});let u=s.images.get(e),h=i+":flipY/"+n.toString();if(void 0!==u[h])return u[h];a.images||(a.images=[]);let f={mimeType:i},d=p();d.width=Math.min(e.width,l.maxTextureSize),d.height=Math.min(e.height,l.maxTextureSize);let v=d.getContext("2d",{willReadFrequently:!0});if(!0===n&&(v.translate(0,d.height),v.scale(1,-1)),void 0!==e.data){t!==r.GWd&&console.error("GLTFExporter: Only RGBAFormat is supported.",t),(e.width>l.maxTextureSize||e.height>l.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",e);let n=new Uint8ClampedArray(e.height*e.width*4);for(let t=0;t<n.length;t+=4)n[t+0]=e.data[t+0],n[t+1]=e.data[t+1],n[t+2]=e.data[t+2],n[t+3]=e.data[t+3];v.putImageData(new ImageData(n,e.width,e.height),0,0)}else if("u">typeof HTMLImageElement&&e instanceof HTMLImageElement||"u">typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"u">typeof ImageBitmap&&e instanceof ImageBitmap||"u">typeof OffscreenCanvas&&e instanceof OffscreenCanvas)v.drawImage(e,0,0,d.width,d.height);else throw Error("THREE.GLTFExporter: Invalid image type. Use HTMLImageElement, HTMLCanvasElement, ImageBitmap or OffscreenCanvas.");!0===l.binary?c.push((function(e,t){if(!("u">typeof OffscreenCanvas&&e instanceof OffscreenCanvas))return new Promise(n=>e.toBlob(n,t));{let n;return"image/jpeg"===t?n=.92:"image/webp"===t&&(n=.8),e.convertToBlob({type:t,quality:n})}})(d,i).then(e=>o.processBufferViewImage(e)).then(e=>{f.bufferView=e})):f.uri=r.HgN.getDataURL(d,i);let y=a.images.push(f)-1;return u[h]=y,y}throw Error("THREE.GLTFExporter: No valid image data found. Unable to process texture.")}processSampler(e){let t=this.json;t.samplers||(t.samplers=[]);let n={magFilter:a[e.magFilter],minFilter:a[e.minFilter],wrapS:a[e.wrapS],wrapT:a[e.wrapT]};return t.samplers.push(n)-1}async processTextureAsync(e){let t=this.options,n=this.cache,i=this.json;if(n.textures.has(e))return n.textures.get(e);i.textures||(i.textures=[]),e instanceof r.FvD&&(e=await this.decompressTextureAsync(e,t.maxTextureSize));let o=e.userData.mimeType;"image/webp"===o&&(o="image/png");let s={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY,o)};e.name&&(s.name=e.name),await this._invokeAllAsync(async function(t){t.writeTexture&&await t.writeTexture(e,s)});let a=i.textures.push(s)-1;return n.textures.set(e,a),a}async processMaterialAsync(e){let t=this.cache,n=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;n.materials||(n.materials=[]);let i={pbrMetallicRoughness:{}};!0!==e.isMeshStandardMaterial&&!0!==e.isMeshBasicMaterial&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");let o=e.color.toArray().concat([e.opacity]);if(u(o,[1,1,1,1])||(i.pbrMetallicRoughness.baseColorFactor=o),e.isMeshStandardMaterial?(i.pbrMetallicRoughness.metallicFactor=e.metalness,i.pbrMetallicRoughness.roughnessFactor=e.roughness):(i.pbrMetallicRoughness.metallicFactor=0,i.pbrMetallicRoughness.roughnessFactor=1),e.metalnessMap||e.roughnessMap){let t=await this.buildMetalRoughTextureAsync(e.metalnessMap,e.roughnessMap),n={index:await this.processTextureAsync(t),texCoord:t.channel};this.applyTextureTransform(n,t),i.pbrMetallicRoughness.metallicRoughnessTexture=n}if(e.map){let t={index:await this.processTextureAsync(e.map),texCoord:e.map.channel};this.applyTextureTransform(t,e.map),i.pbrMetallicRoughness.baseColorTexture=t}if(e.emissive){let t=e.emissive;if(Math.max(t.r,t.g,t.b)>0&&(i.emissiveFactor=e.emissive.toArray()),e.emissiveMap){let t={index:await this.processTextureAsync(e.emissiveMap),texCoord:e.emissiveMap.channel};this.applyTextureTransform(t,e.emissiveMap),i.emissiveTexture=t}}if(e.normalMap){let t={index:await this.processTextureAsync(e.normalMap),texCoord:e.normalMap.channel};e.normalScale&&1!==e.normalScale.x&&(t.scale=e.normalScale.x),this.applyTextureTransform(t,e.normalMap),i.normalTexture=t}if(e.aoMap){let t={index:await this.processTextureAsync(e.aoMap),texCoord:e.aoMap.channel};1!==e.aoMapIntensity&&(t.strength=e.aoMapIntensity),this.applyTextureTransform(t,e.aoMap),i.occlusionTexture=t}e.transparent?i.alphaMode="BLEND":e.alphaTest>0&&(i.alphaMode="MASK",i.alphaCutoff=e.alphaTest),e.side===r.$EB&&(i.doubleSided=!0),""!==e.name&&(i.name=e.name),this.serializeUserData(e,i),await this._invokeAllAsync(async function(t){t.writeMaterialAsync&&await t.writeMaterialAsync(e,i)});let s=n.materials.push(i)-1;return t.materials.set(e,s),s}async processMeshAsync(e){let t,n=this.cache,i=this.json,s=[e.geometry.uuid];if(Array.isArray(e.material))for(let t=0,n=e.material.length;t<n;t++)s.push(e.material[t].uuid);else s.push(e.material.uuid);let a=s.join(":");if(n.meshes.has(a))return n.meshes.get(a);let l=e.geometry;t=e.isLineSegments?1:e.isLineLoop?2:e.isLine?3:e.isPoints?0:e.material.wireframe?1:4;let c={},u={},h=[],f=[],p={uv:"TEXCOORD_0",uv1:"TEXCOORD_1",uv2:"TEXCOORD_2",uv3:"TEXCOORD_3",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},d=l.getAttribute("normal");void 0===d||this.isNormalizedNormalAttribute(d)||(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),l.setAttribute("normal",this.createNormalizedNormalAttribute(d)));let v=null;for(let e in l.attributes){if("morph"===e.slice(0,5))continue;let t=l.attributes[e];if(e=p[e]||e.toUpperCase(),/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(e)||(e="_"+e),n.attributes.has(this.getUID(t))){u[e]=n.attributes.get(this.getUID(t));continue}v=null;let i=t.array;"JOINTS_0"!==e||i instanceof Uint16Array||i instanceof Uint8Array?(i instanceof Uint32Array||i instanceof Int32Array)&&!e.startsWith("_")&&(console.warn(`GLTFExporter: Attribute "${e}" converted to type FLOAT.`),v=o.Utils.toFloat32BufferAttribute(t)):(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),v=new r.THS(new Uint16Array(i),t.itemSize,t.normalized));let s=this.processAccessor(v||t,l);null!==s&&(e.startsWith("_")||this.detectMeshQuantization(e,t),u[e]=s,n.attributes.set(this.getUID(t),s))}if(void 0!==d&&l.setAttribute("normal",d),0===Object.keys(u).length)return null;if(void 0!==e.morphTargetInfluences&&e.morphTargetInfluences.length>0){let t=[],r=[],i={};if(void 0!==e.morphTargetDictionary)for(let t in e.morphTargetDictionary)i[e.morphTargetDictionary[t]]=t;for(let o=0;o<e.morphTargetInfluences.length;++o){let s={},a=!1;for(let e in l.morphAttributes){if("position"!==e&&"normal"!==e){a||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),a=!0);continue}let t=l.morphAttributes[e][o],r=e.toUpperCase(),i=l.attributes[e];if(n.attributes.has(this.getUID(t,!0))){s[r]=n.attributes.get(this.getUID(t,!0));continue}let c=t.clone();if(!l.morphTargetsRelative)for(let e=0,n=t.count;e<n;e++)for(let n=0;n<t.itemSize;n++)0===n&&c.setX(e,t.getX(e)-i.getX(e)),1===n&&c.setY(e,t.getY(e)-i.getY(e)),2===n&&c.setZ(e,t.getZ(e)-i.getZ(e)),3===n&&c.setW(e,t.getW(e)-i.getW(e));s[r]=this.processAccessor(c,l),n.attributes.set(this.getUID(i,!0),s[r])}f.push(s),t.push(e.morphTargetInfluences[o]),void 0!==e.morphTargetDictionary&&r.push(i[o])}c.weights=t,r.length>0&&(c.extras={},c.extras.targetNames=r)}let y=Array.isArray(e.material);if(y&&0===l.groups.length)return null;let m=!1;if(y&&null===l.index){let e=[];for(let t=0,n=l.attributes.position.count;t<n;t++)e[t]=t;l.setIndex(e),m=!0}let b=y?e.material:[e.material],g=y?l.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let e=0,r=g.length;e<r;e++){let r={mode:t,attributes:u};if(this.serializeUserData(l,r),f.length>0&&(r.targets=f),null!==l.index){let t=this.getUID(l.index);(void 0!==g[e].start||void 0!==g[e].count)&&(t+=":"+g[e].start+":"+g[e].count),n.attributes.has(t)?r.indices=n.attributes.get(t):(r.indices=this.processAccessor(l.index,l,g[e].start,g[e].count),n.attributes.set(t,r.indices)),null===r.indices&&delete r.indices}let i=await this.processMaterialAsync(b[g[e].materialIndex]);null!==i&&(r.material=i),h.push(r)}!0===m&&l.setIndex(null),c.primitives=h,i.meshes||(i.meshes=[]),await this._invokeAllAsync(function(t){t.writeMesh&&t.writeMesh(e,c)});let w=i.meshes.push(c)-1;return n.meshes.set(a,w),w}detectMeshQuantization(e,t){let n;if(this.extensionsUsed[s])return;switch(t.array.constructor){case Int8Array:n="byte";break;case Uint8Array:n="unsigned byte";break;case Int16Array:n="short";break;case Uint16Array:n="unsigned short";break;default:return}t.normalized&&(n+=" normalized");let r=e.split("_",1)[0];i[r]&&i[r].includes(n)&&(this.extensionsUsed[s]=!0,this.extensionsRequired[s]=!0)}processCamera(e){let t=this.json;t.cameras||(t.cameras=[]);let n=e.isOrthographicCamera,i={type:n?"orthographic":"perspective"};return n?i.orthographic={xmag:2*e.right,ymag:2*e.top,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:i.perspective={aspectRatio:e.aspect,yfov:r.cj9.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},""!==e.name&&(i.name=e.type),t.cameras.push(i)-1}processAnimation(e,t){let n=this.json,i=this.nodeMap;n.animations||(n.animations=[]);let s=(e=o.Utils.mergeMorphTargetTracks(e.clone(),t)).tracks,a=[],c=[];for(let e=0;e<s.length;++e){let n,o=s[e],u=r.Nwf.parseTrackName(o.name),h=r.Nwf.findNode(t,u.nodeName),f=l[u.propertyName];if("bones"===u.objectName&&(h=!0===h.isSkinnedMesh?h.skeleton.getBoneByName(u.objectIndex):void 0),!h||!f){console.warn('THREE.GLTFExporter: Could not export animation track "%s".',o.name);continue}let p=o.values.length/o.times.length;f===l.morphTargetInfluences&&(p/=h.morphTargetInfluences.length),!0===o.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(n="CUBICSPLINE",p/=3):n=o.getInterpolation()===r.ljd?"STEP":"LINEAR",c.push({input:this.processAccessor(new r.THS(o.times,1)),output:this.processAccessor(new r.THS(o.values,p)),interpolation:n}),a.push({sampler:c.length-1,target:{node:i.get(h),path:f}})}let u={name:e.name||"clip_"+n.animations.length,samplers:c,channels:a};return this.serializeUserData(e,u),n.animations.push(u),n.animations.length-1}processSkin(e){let t=this.json,n=this.nodeMap,i=t.nodes[n.get(e)],o=e.skeleton;if(void 0===o)return null;let s=e.skeleton.bones[0];if(void 0===s)return null;let a=[],l=new Float32Array(16*o.bones.length),c=new r.kn4;for(let t=0;t<o.bones.length;++t)a.push(n.get(o.bones[t])),c.copy(o.boneInverses[t]),c.multiply(e.bindMatrix).toArray(l,16*t);return void 0===t.skins&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new r.THS(l,16)),joints:a,skeleton:n.get(s)}),i.skin=t.skins.length-1}async processNodeAsync(e){let t=this.json,n=this.options,r=this.nodeMap;t.nodes||(t.nodes=[]);let i={};if(n.trs){let t=e.quaternion.toArray(),n=e.position.toArray(),r=e.scale.toArray();u(t,[0,0,0,1])||(i.rotation=t),u(n,[0,0,0])||(i.translation=n),u(r,[1,1,1])||(i.scale=r)}else e.matrixAutoUpdate&&e.updateMatrix(),!1===u(e.matrix.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])&&(i.matrix=e.matrix.elements);if(""!==e.name&&(i.name=String(e.name)),this.serializeUserData(e,i),e.isMesh||e.isLine||e.isPoints){let t=await this.processMeshAsync(e);null!==t&&(i.mesh=t)}else e.isCamera&&(i.camera=this.processCamera(e));e.isSkinnedMesh&&this.skins.push(e);let o=t.nodes.push(i)-1;if(r.set(e,o),e.children.length>0){let t=[];for(let r=0,i=e.children.length;r<i;r++){let i=e.children[r];if(i.visible||!1===n.onlyVisible){let e=await this.processNodeAsync(i);null!==e&&t.push(e)}}t.length>0&&(i.children=t)}return await this._invokeAllAsync(function(t){t.writeNode&&t.writeNode(e,i)}),o}async processSceneAsync(e){let t=this.json,n=this.options;t.scenes||(t.scenes=[],t.scene=0);let r={};""!==e.name&&(r.name=e.name),t.scenes.push(r);let i=[];for(let t=0,r=e.children.length;t<r;t++){let r=e.children[t];if(r.visible||!1===n.onlyVisible){let e=await this.processNodeAsync(r);null!==e&&i.push(e)}}i.length>0&&(r.nodes=i),this.serializeUserData(e,r)}async processObjectsAsync(e){let t=new r.Z58;t.name="AuxScene";for(let n=0;n<e.length;n++)t.children.push(e[n]);await this.processSceneAsync(t)}async processInputAsync(e){let t=this.options;e=e instanceof Array?e:[e],await this._invokeAllAsync(function(t){t.beforeParse&&t.beforeParse(e)});let n=[];for(let t=0;t<e.length;t++)e[t]instanceof r.Z58?await this.processSceneAsync(e[t]):n.push(e[t]);n.length>0&&await this.processObjectsAsync(n);for(let e=0;e<this.skins.length;++e)this.processSkin(this.skins[e]);for(let n=0;n<t.animations.length;++n)this.processAnimation(t.animations[n],e[0]);await this._invokeAllAsync(function(t){t.afterParse&&t.afterParse(e)})}async _invokeAllAsync(e){for(let t=0,n=this.plugins.length;t<n;t++)await e(this.plugins[t])}}class v{constructor(e){this.writer=e,this.name="KHR_lights_punctual"}writeNode(e,t){if(!e.isLight)return;if(!e.isDirectionalLight&&!e.isPointLight&&!e.isSpotLight)return void console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e);let n=this.writer,r=n.json,i=n.extensionsUsed,o={};e.name&&(o.name=e.name),o.color=e.color.toArray(),o.intensity=e.intensity,e.isDirectionalLight?o.type="directional":e.isPointLight?(o.type="point",e.distance>0&&(o.range=e.distance)):e.isSpotLight&&(o.type="spot",e.distance>0&&(o.range=e.distance),o.spot={},o.spot.innerConeAngle=(1-e.penumbra)*e.angle,o.spot.outerConeAngle=e.angle),void 0!==e.decay&&2!==e.decay&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),e.target&&(e.target.parent!==e||0!==e.target.position.x||0!==e.target.position.y||-1!==e.target.position.z)&&console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),i[this.name]||(r.extensions=r.extensions||{},r.extensions[this.name]={lights:[]},i[this.name]=!0);let s=r.extensions[this.name].lights;s.push(o),t.extensions=t.extensions||{},t.extensions[this.name]={light:s.length-1}}}class y{constructor(e){this.writer=e,this.name="KHR_materials_unlit"}async writeMaterialAsync(e,t){if(!e.isMeshBasicMaterial)return;let n=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},n[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}}class m{constructor(e){this.writer=e,this.name="KHR_materials_clearcoat"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.clearcoat)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.clearcoatFactor=e.clearcoat,e.clearcoatMap){let t={index:await n.processTextureAsync(e.clearcoatMap),texCoord:e.clearcoatMap.channel};n.applyTextureTransform(t,e.clearcoatMap),i.clearcoatTexture=t}if(i.clearcoatRoughnessFactor=e.clearcoatRoughness,e.clearcoatRoughnessMap){let t={index:await n.processTextureAsync(e.clearcoatRoughnessMap),texCoord:e.clearcoatRoughnessMap.channel};n.applyTextureTransform(t,e.clearcoatRoughnessMap),i.clearcoatRoughnessTexture=t}if(e.clearcoatNormalMap){let t={index:await n.processTextureAsync(e.clearcoatNormalMap),texCoord:e.clearcoatNormalMap.channel};1!==e.clearcoatNormalScale.x&&(t.scale=e.clearcoatNormalScale.x),n.applyTextureTransform(t,e.clearcoatNormalMap),i.clearcoatNormalTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class b{constructor(e){this.writer=e,this.name="KHR_materials_dispersion"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.dispersion)return;let n=this.writer.extensionsUsed,r={};r.dispersion=e.dispersion,t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class g{constructor(e){this.writer=e,this.name="KHR_materials_iridescence"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.iridescence)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.iridescenceFactor=e.iridescence,e.iridescenceMap){let t={index:await n.processTextureAsync(e.iridescenceMap),texCoord:e.iridescenceMap.channel};n.applyTextureTransform(t,e.iridescenceMap),i.iridescenceTexture=t}if(i.iridescenceIor=e.iridescenceIOR,i.iridescenceThicknessMinimum=e.iridescenceThicknessRange[0],i.iridescenceThicknessMaximum=e.iridescenceThicknessRange[1],e.iridescenceThicknessMap){let t={index:await n.processTextureAsync(e.iridescenceThicknessMap),texCoord:e.iridescenceThicknessMap.channel};n.applyTextureTransform(t,e.iridescenceThicknessMap),i.iridescenceThicknessTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class w{constructor(e){this.writer=e,this.name="KHR_materials_transmission"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.transmissionFactor=e.transmission,e.transmissionMap){let t={index:await n.processTextureAsync(e.transmissionMap),texCoord:e.transmissionMap.channel};n.applyTextureTransform(t,e.transmissionMap),i.transmissionTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class k{constructor(e){this.writer=e,this.name="KHR_materials_volume"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.thicknessFactor=e.thickness,e.thicknessMap){let t={index:await n.processTextureAsync(e.thicknessMap),texCoord:e.thicknessMap.channel};n.applyTextureTransform(t,e.thicknessMap),i.thicknessTexture=t}e.attenuationDistance!==1/0&&(i.attenuationDistance=e.attenuationDistance),i.attenuationColor=e.attenuationColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class T{constructor(e){this.writer=e,this.name="KHR_materials_ior"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||1.5===e.ior)return;let n=this.writer.extensionsUsed,r={};r.ior=e.ior,t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class x{constructor(e){this.writer=e,this.name="KHR_materials_specular"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||1===e.specularIntensity&&e.specularColor.equals(c)&&!e.specularIntensityMap&&!e.specularColorMap)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.specularIntensityMap){let t={index:await n.processTextureAsync(e.specularIntensityMap),texCoord:e.specularIntensityMap.channel};n.applyTextureTransform(t,e.specularIntensityMap),i.specularTexture=t}if(e.specularColorMap){let t={index:await n.processTextureAsync(e.specularColorMap),texCoord:e.specularColorMap.channel};n.applyTextureTransform(t,e.specularColorMap),i.specularColorTexture=t}i.specularFactor=e.specularIntensity,i.specularColorFactor=e.specularColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class P{constructor(e){this.writer=e,this.name="KHR_materials_sheen"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0==e.sheen)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.sheenRoughnessMap){let t={index:await n.processTextureAsync(e.sheenRoughnessMap),texCoord:e.sheenRoughnessMap.channel};n.applyTextureTransform(t,e.sheenRoughnessMap),i.sheenRoughnessTexture=t}if(e.sheenColorMap){let t={index:await n.processTextureAsync(e.sheenColorMap),texCoord:e.sheenColorMap.channel};n.applyTextureTransform(t,e.sheenColorMap),i.sheenColorTexture=t}i.sheenRoughnessFactor=e.sheenRoughness,i.sheenColorFactor=e.sheenColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class S{constructor(e){this.writer=e,this.name="KHR_materials_anisotropy"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0==e.anisotropy)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.anisotropyMap){let t={index:await n.processTextureAsync(e.anisotropyMap)};n.applyTextureTransform(t,e.anisotropyMap),i.anisotropyTexture=t}i.anisotropyStrength=e.anisotropy,i.anisotropyRotation=e.anisotropyRotation,t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class O{constructor(e){this.writer=e,this.name="KHR_materials_emissive_strength"}async writeMaterialAsync(e,t){if(!e.isMeshStandardMaterial||1===e.emissiveIntensity)return;let n=this.writer.extensionsUsed,r={};r.emissiveStrength=e.emissiveIntensity,t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class R{constructor(e){this.writer=e,this.name="EXT_materials_bump"}async writeMaterialAsync(e,t){if(!e.isMeshStandardMaterial||1===e.bumpScale&&!e.bumpMap)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.bumpMap){let t={index:await n.processTextureAsync(e.bumpMap),texCoord:e.bumpMap.channel};n.applyTextureTransform(t,e.bumpMap),i.bumpTexture=t}i.bumpFactor=e.bumpScale,t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class E{constructor(e){this.writer=e,this.name="EXT_mesh_gpu_instancing"}writeNode(e,t){if(!e.isInstancedMesh)return;let n=this.writer,i=new Float32Array(3*e.count),o=new Float32Array(4*e.count),s=new Float32Array(3*e.count),a=new r.kn4,l=new r.Pq0,c=new r.PTz,u=new r.Pq0;for(let t=0;t<e.count;t++)e.getMatrixAt(t,a),a.decompose(l,c,u),l.toArray(i,3*t),c.toArray(o,4*t),u.toArray(s,3*t);let h={TRANSLATION:n.processAccessor(new r.THS(i,3)),ROTATION:n.processAccessor(new r.THS(o,4)),SCALE:n.processAccessor(new r.THS(s,3))};e.instanceColor&&(h._COLOR_0=n.processAccessor(e.instanceColor)),t.extensions=t.extensions||{},t.extensions[this.name]={attributes:h},n.extensionsUsed[this.name]=!0,n.extensionsRequired[this.name]=!0}}function A(e,t){if(t===r.RJ4)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(t!==r.rYR&&t!==r.O49)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),e;{let n=e.getIndex();if(null===n){let t=[],r=e.getAttribute("position");if(void 0===r)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<r.count;e++)t.push(e);e.setIndex(t),n=e.getIndex()}let i=n.count-2,o=[];if(t===r.rYR)for(let e=1;e<=i;e++)o.push(n.getX(0)),o.push(n.getX(e)),o.push(n.getX(e+1));else for(let e=0;e<i;e++)e%2==0?(o.push(n.getX(e)),o.push(n.getX(e+1)),o.push(n.getX(e+2))):(o.push(n.getX(e+2)),o.push(n.getX(e+1)),o.push(n.getX(e)));o.length/3!==i&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");let s=e.clone();return s.setIndex(o),s.clearGroups(),s}}o.Utils={insertKeyframe:function(e,t){let n,r=e.getValueSize(),i=new e.TimeBufferType(e.times.length+1),o=new e.ValueBufferType(e.values.length+r),s=e.createInterpolant(new e.ValueBufferType(r));if(0===e.times.length){i[0]=t;for(let e=0;e<r;e++)o[e]=0;n=0}else if(t<e.times[0]){if(.001>Math.abs(e.times[0]-t))return 0;i[0]=t,i.set(e.times,1),o.set(s.evaluate(t),0),o.set(e.values,r),n=0}else if(t>e.times[e.times.length-1]){if(.001>Math.abs(e.times[e.times.length-1]-t))return e.times.length-1;i[i.length-1]=t,i.set(e.times,0),o.set(e.values,0),o.set(s.evaluate(t),e.values.length),n=i.length-1}else for(let a=0;a<e.times.length;a++){if(.001>Math.abs(e.times[a]-t))return a;if(e.times[a]<t&&e.times[a+1]>t){i.set(e.times.slice(0,a+1),0),i[a+1]=t,i.set(e.times.slice(a+1),a+2),o.set(e.values.slice(0,(a+1)*r),0),o.set(s.evaluate(t),(a+1)*r),o.set(e.values.slice((a+1)*r),(a+2)*r),n=a+1;break}}return e.times=i,e.values=o,n},mergeMorphTargetTracks:function(e,t){let n=[],i={},o=e.tracks;for(let e=0;e<o.length;++e){let s,a=o[e],l=r.Nwf.parseTrackName(a.name),c=r.Nwf.findNode(t,l.nodeName);if("morphTargetInfluences"!==l.propertyName||void 0===l.propertyIndex){n.push(a);continue}if(a.createInterpolant!==a.InterpolantFactoryMethodDiscrete&&a.createInterpolant!==a.InterpolantFactoryMethodLinear){if(a.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),(a=a.clone()).setInterpolation(r.PJ3)}let u=c.morphTargetInfluences.length,h=c.morphTargetDictionary[l.propertyIndex];if(void 0===h)throw Error("THREE.GLTFExporter: Morph target name not found: "+l.propertyIndex);if(void 0===i[c.uuid]){let e=new(s=a.clone()).ValueBufferType(u*s.times.length);for(let t=0;t<s.times.length;t++)e[t*u+h]=s.values[t];s.name=(l.nodeName||"")+".morphTargetInfluences",s.values=e,i[c.uuid]=s,n.push(s);continue}let f=a.createInterpolant(new a.ValueBufferType(1));s=i[c.uuid];for(let e=0;e<s.times.length;e++)s.values[e*u+h]=f.evaluate(s.times[e]);for(let e=0;e<a.times.length;e++){let t=this.insertKeyframe(s,a.times[e]);s.values[t*u+h]=a.values[e]}}return e.tracks=n,e},toFloat32BufferAttribute:function(e){let t=new r.THS(new Float32Array(e.count*e.itemSize),e.itemSize,!1);if(!e.normalized&&!e.isInterleavedBufferAttribute)return t.array.set(e.array),t;for(let n=0,r=e.count;n<r;n++)for(let r=0;r<e.itemSize;r++)t.setComponent(n,r,e.getComponent(n,r));return t}};class M extends r.aHM{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(e){return new B(e)}),this.register(function(e){return new N(e)}),this.register(function(e){return new K(e)}),this.register(function(e){return new X(e)}),this.register(function(e){return new W(e)}),this.register(function(e){return new H(e)}),this.register(function(e){return new U(e)}),this.register(function(e){return new D(e)}),this.register(function(e){return new z(e)}),this.register(function(e){return new L(e)}),this.register(function(e){return new G(e)}),this.register(function(e){return new F(e)}),this.register(function(e){return new q(e)}),this.register(function(e){return new V(e)}),this.register(function(e){return new I(e)}),this.register(function(e){return new Y(e)}),this.register(function(e){return new J(e)})}load(e,t,n,i){let o,s=this;if(""!==this.resourcePath)o=this.resourcePath;else if(""!==this.path){let t=r.r6x.extractUrlBase(e);o=r.r6x.resolveURL(t,this.path)}else o=r.r6x.extractUrlBase(e);this.manager.itemStart(e);let a=function(t){i?i(t):console.error(t),s.manager.itemError(e),s.manager.itemEnd(e)},l=new r.Y9S(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials),l.load(e,function(n){try{s.parse(n,o,function(n){t(n),s.manager.itemEnd(e)},a)}catch(e){a(e)}},n,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return -1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return -1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,n,r){let i,o={},s={},a=new TextDecoder;if("string"==typeof e)i=JSON.parse(e);else if(e instanceof ArrayBuffer)if(a.decode(new Uint8Array(e,0,4))===Z){try{o[C.KHR_BINARY_GLTF]=new Q(e)}catch(e){r&&r(e);return}i=JSON.parse(o[C.KHR_BINARY_GLTF].content)}else i=JSON.parse(a.decode(e));else i=e;if(void 0===i.asset||i.asset.version[0]<2){r&&r(Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}let l=new eb(i,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){let t=this.pluginCallbacks[e](l);t.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),s[t.name]=t,o[t.name]=!0}if(i.extensionsUsed)for(let e=0;e<i.extensionsUsed.length;++e){let t=i.extensionsUsed[e],n=i.extensionsRequired||[];switch(t){case C.KHR_MATERIALS_UNLIT:o[t]=new j;break;case C.KHR_DRACO_MESH_COMPRESSION:o[t]=new $(i,this.dracoLoader);break;case C.KHR_TEXTURE_TRANSFORM:o[t]=new ee;break;case C.KHR_MESH_QUANTIZATION:o[t]=new et;break;default:n.indexOf(t)>=0&&void 0===s[t]&&console.warn('THREE.GLTFLoader: Unknown extension "'+t+'".')}}l.setExtensions(o),l.setPlugins(s),l.parse(n,r)}parseAsync(e,t){let n=this;return new Promise(function(r,i){n.parse(e,t,r,i)})}}function _(){let e={};return{get:function(t){return e[t]},add:function(t,n){e[t]=n},remove:function(t){delete e[t]},removeAll:function(){e={}}}}let C={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class I{constructor(e){this.parser=e,this.name=C.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){let e=this.parser,t=this.parser.json.nodes||[];for(let n=0,r=t.length;n<r;n++){let r=t[n];r.extensions&&r.extensions[this.name]&&void 0!==r.extensions[this.name].light&&e._addNodeRef(this.cache,r.extensions[this.name].light)}}_loadLight(e){let t,n=this.parser,i="light:"+e,o=n.cache.get(i);if(o)return o;let s=n.json,a=((s.extensions&&s.extensions[this.name]||{}).lights||[])[e],l=new r.Q1f(0xffffff);void 0!==a.color&&l.setRGB(a.color[0],a.color[1],a.color[2],r.Zr2);let c=void 0!==a.range?a.range:0;switch(a.type){case"directional":(t=new r.ZyN(l)).target.position.set(0,0,-1),t.add(t.target);break;case"point":(t=new r.HiM(l)).distance=c;break;case"spot":(t=new r.nCl(l)).distance=c,a.spot=a.spot||{},a.spot.innerConeAngle=void 0!==a.spot.innerConeAngle?a.spot.innerConeAngle:0,a.spot.outerConeAngle=void 0!==a.spot.outerConeAngle?a.spot.outerConeAngle:Math.PI/4,t.angle=a.spot.outerConeAngle,t.penumbra=1-a.spot.innerConeAngle/a.spot.outerConeAngle,t.target.position.set(0,0,-1),t.add(t.target);break;default:throw Error("THREE.GLTFLoader: Unexpected light type: "+a.type)}return t.position.set(0,0,0),ed(t,a),void 0!==a.intensity&&(t.intensity=a.intensity),t.name=n.createUniqueName(a.name||"light_"+e),o=Promise.resolve(t),n.cache.add(i,o),o}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){let t=this,n=this.parser,r=n.json.nodes[e],i=(r.extensions&&r.extensions[this.name]||{}).light;return void 0===i?null:this._loadLight(i).then(function(e){return n._getNodeRef(t.cache,i,e)})}}class j{constructor(){this.name=C.KHR_MATERIALS_UNLIT}getMaterialType(){return r.V9B}extendParams(e,t,n){let i=[];e.color=new r.Q1f(1,1,1),e.opacity=1;let o=t.pbrMetallicRoughness;if(o){if(Array.isArray(o.baseColorFactor)){let t=o.baseColorFactor;e.color.setRGB(t[0],t[1],t[2],r.Zr2),e.opacity=t[3]}void 0!==o.baseColorTexture&&i.push(n.assignTexture(e,"map",o.baseColorTexture,r.er$))}return Promise.all(i)}}class L{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){let n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=n.extensions[this.name].emissiveStrength;return void 0!==r&&(t.emissiveIntensity=r),Promise.resolve()}}class B{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let o=[],s=i.extensions[this.name];if(void 0!==s.clearcoatFactor&&(t.clearcoat=s.clearcoatFactor),void 0!==s.clearcoatTexture&&o.push(n.assignTexture(t,"clearcoatMap",s.clearcoatTexture)),void 0!==s.clearcoatRoughnessFactor&&(t.clearcoatRoughness=s.clearcoatRoughnessFactor),void 0!==s.clearcoatRoughnessTexture&&o.push(n.assignTexture(t,"clearcoatRoughnessMap",s.clearcoatRoughnessTexture)),void 0!==s.clearcoatNormalTexture&&(o.push(n.assignTexture(t,"clearcoatNormalMap",s.clearcoatNormalTexture)),void 0!==s.clearcoatNormalTexture.scale)){let e=s.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new r.I9Y(e,e)}return Promise.all(o)}}class N{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_DISPERSION}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=n.extensions[this.name];return t.dispersion=void 0!==r.dispersion?r.dispersion:0,Promise.resolve()}}class F{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],o=r.extensions[this.name];return void 0!==o.iridescenceFactor&&(t.iridescence=o.iridescenceFactor),void 0!==o.iridescenceTexture&&i.push(n.assignTexture(t,"iridescenceMap",o.iridescenceTexture)),void 0!==o.iridescenceIor&&(t.iridescenceIOR=o.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==o.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),void 0!==o.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),void 0!==o.iridescenceThicknessTexture&&i.push(n.assignTexture(t,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(i)}}class H{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_SHEEN}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let o=[];t.sheenColor=new r.Q1f(0,0,0),t.sheenRoughness=0,t.sheen=1;let s=i.extensions[this.name];if(void 0!==s.sheenColorFactor){let e=s.sheenColorFactor;t.sheenColor.setRGB(e[0],e[1],e[2],r.Zr2)}return void 0!==s.sheenRoughnessFactor&&(t.sheenRoughness=s.sheenRoughnessFactor),void 0!==s.sheenColorTexture&&o.push(n.assignTexture(t,"sheenColorMap",s.sheenColorTexture,r.er$)),void 0!==s.sheenRoughnessTexture&&o.push(n.assignTexture(t,"sheenRoughnessMap",s.sheenRoughnessTexture)),Promise.all(o)}}class U{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],o=r.extensions[this.name];return void 0!==o.transmissionFactor&&(t.transmission=o.transmissionFactor),void 0!==o.transmissionTexture&&i.push(n.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(i)}}class D{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_VOLUME}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let o=[],s=i.extensions[this.name];t.thickness=void 0!==s.thicknessFactor?s.thicknessFactor:0,void 0!==s.thicknessTexture&&o.push(n.assignTexture(t,"thicknessMap",s.thicknessTexture)),t.attenuationDistance=s.attenuationDistance||1/0;let a=s.attenuationColor||[1,1,1];return t.attenuationColor=new r.Q1f().setRGB(a[0],a[1],a[2],r.Zr2),Promise.all(o)}}class z{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_IOR}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=n.extensions[this.name];return t.ior=void 0!==r.ior?r.ior:1.5,Promise.resolve()}}class G{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_SPECULAR}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let o=[],s=i.extensions[this.name];t.specularIntensity=void 0!==s.specularFactor?s.specularFactor:1,void 0!==s.specularTexture&&o.push(n.assignTexture(t,"specularIntensityMap",s.specularTexture));let a=s.specularColorFactor||[1,1,1];return t.specularColor=new r.Q1f().setRGB(a[0],a[1],a[2],r.Zr2),void 0!==s.specularColorTexture&&o.push(n.assignTexture(t,"specularColorMap",s.specularColorTexture,r.er$)),Promise.all(o)}}class V{constructor(e){this.parser=e,this.name=C.EXT_MATERIALS_BUMP}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],o=r.extensions[this.name];return t.bumpScale=void 0!==o.bumpFactor?o.bumpFactor:1,void 0!==o.bumpTexture&&i.push(n.assignTexture(t,"bumpMap",o.bumpTexture)),Promise.all(i)}}class q{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],o=r.extensions[this.name];return void 0!==o.anisotropyStrength&&(t.anisotropy=o.anisotropyStrength),void 0!==o.anisotropyRotation&&(t.anisotropyRotation=o.anisotropyRotation),void 0!==o.anisotropyTexture&&i.push(n.assignTexture(t,"anisotropyMap",o.anisotropyTexture)),Promise.all(i)}}class K{constructor(e){this.parser=e,this.name=C.KHR_TEXTURE_BASISU}loadTexture(e){let t=this.parser,n=t.json,r=n.textures[e];if(!r.extensions||!r.extensions[this.name])return null;let i=r.extensions[this.name],o=t.options.ktx2Loader;if(!o)if(!(n.extensionsRequired&&n.extensionsRequired.indexOf(this.name)>=0))return null;else throw Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return t.loadTextureImage(e,i.source,o)}}class X{constructor(e){this.parser=e,this.name=C.EXT_TEXTURE_WEBP}loadTexture(e){let t=this.name,n=this.parser,r=n.json,i=r.textures[e];if(!i.extensions||!i.extensions[t])return null;let o=i.extensions[t],s=r.images[o.source],a=n.textureLoader;if(s.uri){let e=n.options.manager.getHandler(s.uri);null!==e&&(a=e)}return n.loadTextureImage(e,o.source,a)}}class W{constructor(e){this.parser=e,this.name=C.EXT_TEXTURE_AVIF}loadTexture(e){let t=this.name,n=this.parser,r=n.json,i=r.textures[e];if(!i.extensions||!i.extensions[t])return null;let o=i.extensions[t],s=r.images[o.source],a=n.textureLoader;if(s.uri){let e=n.options.manager.getHandler(s.uri);null!==e&&(a=e)}return n.loadTextureImage(e,o.source,a)}}class Y{constructor(e){this.name=C.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){let t=this.parser.json,n=t.bufferViews[e];if(!n.extensions||!n.extensions[this.name])return null;{let e=n.extensions[this.name],r=this.parser.getDependency("buffer",e.buffer),i=this.parser.options.meshoptDecoder;if(!i||!i.supported)if(!(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0))return null;else throw Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return r.then(function(t){let n=e.byteOffset||0,r=e.byteLength||0,o=e.count,s=e.byteStride,a=new Uint8Array(t,n,r);return i.decodeGltfBufferAsync?i.decodeGltfBufferAsync(o,s,a,e.mode,e.filter).then(function(e){return e.buffer}):i.ready.then(function(){let t=new ArrayBuffer(o*s);return i.decodeGltfBuffer(new Uint8Array(t),o,s,a,e.mode,e.filter),t})})}}}class J{constructor(e){this.name=C.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){let t=this.parser.json,n=t.nodes[e];if(!n.extensions||!n.extensions[this.name]||void 0===n.mesh)return null;for(let e of t.meshes[n.mesh].primitives)if(e.mode!==eo.TRIANGLES&&e.mode!==eo.TRIANGLE_STRIP&&e.mode!==eo.TRIANGLE_FAN&&void 0!==e.mode)return null;let i=n.extensions[this.name].attributes,o=[],s={};for(let e in i)o.push(this.parser.getDependency("accessor",i[e]).then(t=>(s[e]=t,s[e])));return o.length<1?null:(o.push(this.parser.createNodeMesh(e)),Promise.all(o).then(e=>{let t=e.pop(),n=t.isGroup?t.children:[t],i=e[0].count,o=[];for(let e of n){let t=new r.kn4,n=new r.Pq0,a=new r.PTz,l=new r.Pq0(1,1,1),c=new r.ZLX(e.geometry,e.material,i);for(let e=0;e<i;e++)s.TRANSLATION&&n.fromBufferAttribute(s.TRANSLATION,e),s.ROTATION&&a.fromBufferAttribute(s.ROTATION,e),s.SCALE&&l.fromBufferAttribute(s.SCALE,e),c.setMatrixAt(e,t.compose(n,a,l));for(let t in s)if("_COLOR_0"===t){let e=s[t];c.instanceColor=new r.uWO(e.array,e.itemSize,e.normalized)}else"TRANSLATION"!==t&&"ROTATION"!==t&&"SCALE"!==t&&e.geometry.setAttribute(t,s[t]);r.B69.prototype.copy.call(c,e),this.parser.assignFinalMaterial(c),o.push(c)}return t.isGroup?(t.clear(),t.add(...o),t):o[0]}))}}let Z="glTF";class Q{constructor(e){this.name=C.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12),n=new TextDecoder;if(this.header={magic:n.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Z)throw Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw Error("THREE.GLTFLoader: Legacy binary file detected.");const r=this.header.length-12,i=new DataView(e,12);let o=0;for(;o<r;){const t=i.getUint32(o,!0);o+=4;const r=i.getUint32(o,!0);if(o+=4,0x4e4f534a===r){const r=new Uint8Array(e,12+o,t);this.content=n.decode(r)}else if(5130562===r){const n=12+o;this.body=e.slice(n,n+t)}o+=t}if(null===this.content)throw Error("THREE.GLTFLoader: JSON content not found.")}}class ${constructor(e,t){if(!t)throw Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=C.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){let n=this.json,i=this.dracoLoader,o=e.extensions[this.name].bufferView,s=e.extensions[this.name].attributes,a={},l={},c={};for(let e in s)a[eu[e]||e.toLowerCase()]=s[e];for(let t in e.attributes){let r=eu[t]||t.toLowerCase();if(void 0!==s[t]){let i=n.accessors[e.attributes[t]],o=es[i.componentType];c[r]=o.name,l[r]=!0===i.normalized}}return t.getDependency("bufferView",o).then(function(e){return new Promise(function(t,n){i.decodeDracoFile(e,function(e){for(let t in e.attributes){let n=e.attributes[t],r=l[t];void 0!==r&&(n.normalized=r)}t(e)},a,c,r.Zr2,n)})})}}class ee{constructor(){this.name=C.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(void 0===t.texCoord||t.texCoord===e.channel)&&void 0===t.offset&&void 0===t.rotation&&void 0===t.scale||(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class et{constructor(){this.name=C.KHR_MESH_QUANTIZATION}}class en extends r.lGw{constructor(e,t,n,r){super(e,t,n,r)}copySampleValue_(e){let t=this.resultBuffer,n=this.sampleValues,r=this.valueSize,i=e*r*3+r;for(let e=0;e!==r;e++)t[e]=n[i+e];return t}interpolate_(e,t,n,r){let i=this.resultBuffer,o=this.sampleValues,s=this.valueSize,a=2*s,l=3*s,c=r-t,u=(n-t)/c,h=u*u,f=h*u,p=e*l,d=p-l,v=-2*f+3*h,y=f-h,m=1-v,b=y-h+u;for(let e=0;e!==s;e++){let t=o[d+e+s],n=o[d+e+a]*c,r=o[p+e+s],l=o[p+e]*c;i[e]=m*t+b*n+v*r+y*l}return i}}let er=new r.PTz;class ei extends en{interpolate_(e,t,n,r){let i=super.interpolate_(e,t,n,r);return er.fromArray(i).normalize().toArray(i),i}}let eo={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},es={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},ea={9728:r.hxR,9729:r.k6q,9984:r.pHI,9985:r.kRr,9986:r.Cfg,9987:r.$_I},el={33071:r.ghU,33648:r.kTW,10497:r.GJx},ec={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},eu={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},eh={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},ef={CUBICSPLINE:void 0,LINEAR:r.PJ3,STEP:r.ljd};function ep(e,t,n){for(let r in n.extensions)void 0===e[r]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[r]=n.extensions[r])}function ed(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function ev(e){let t="",n=Object.keys(e).sort();for(let r=0,i=n.length;r<i;r++)t+=n[r]+":"+e[n[r]]+";";return t}function ey(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}let em=new r.kn4;class eb{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new _,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let n=!1,i=-1,o=!1,s=-1;if("u">typeof navigator){const e=navigator.userAgent;n=!0===/^((?!chrome|android).)*safari/i.test(e);const t=e.match(/Version\/(\d+)/);i=n&&t?parseInt(t[1],10):-1,s=(o=e.indexOf("Firefox")>-1)?e.match(/Firefox\/([0-9]+)\./)[1]:-1}"u"<typeof createImageBitmap||n&&i<17||o&&s<98?this.textureLoader=new r.Tap(this.options.manager):this.textureLoader=new r.Kzg(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new r.Y9S(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){let n=this,r=this.json,i=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(e){return e._markDefs&&e._markDefs()}),Promise.all(this._invokeAll(function(e){return e.beforeRoot&&e.beforeRoot()})).then(function(){return Promise.all([n.getDependencies("scene"),n.getDependencies("animation"),n.getDependencies("camera")])}).then(function(t){let o={scene:t[0][r.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:r.asset,parser:n,userData:{}};return ep(i,o,r),ed(o,r),Promise.all(n._invokeAll(function(e){return e.afterRoot&&e.afterRoot(o)})).then(function(){for(let e of o.scenes)e.updateMatrixWorld();e(o)})}).catch(t)}_markDefs(){let e=this.json.nodes||[],t=this.json.skins||[],n=this.json.meshes||[];for(let n=0,r=t.length;n<r;n++){let r=t[n].joints;for(let t=0,n=r.length;t<n;t++)e[r[t]].isBone=!0}for(let t=0,r=e.length;t<r;t++){let r=e[t];void 0!==r.mesh&&(this._addNodeRef(this.meshCache,r.mesh),void 0!==r.skin&&(n[r.mesh].isSkinnedMesh=!0)),void 0!==r.camera&&this._addNodeRef(this.cameraCache,r.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,n){if(e.refs[t]<=1)return n;let r=n.clone(),i=(e,t)=>{let n=this.associations.get(e);for(let[r,o]of(null!=n&&this.associations.set(t,n),e.children.entries()))i(o,t.children[r])};return i(n,r),r.name+="_instance_"+e.uses[t]++,r}_invokeOne(e){let t=Object.values(this.plugins);t.push(this);for(let n=0;n<t.length;n++){let r=e(t[n]);if(r)return r}return null}_invokeAll(e){let t=Object.values(this.plugins);t.unshift(this);let n=[];for(let r=0;r<t.length;r++){let i=e(t[r]);i&&n.push(i)}return n}getDependency(e,t){let n=e+":"+t,r=this.cache.get(n);if(!r){switch(e){case"scene":r=this.loadScene(t);break;case"node":r=this._invokeOne(function(e){return e.loadNode&&e.loadNode(t)});break;case"mesh":r=this._invokeOne(function(e){return e.loadMesh&&e.loadMesh(t)});break;case"accessor":r=this.loadAccessor(t);break;case"bufferView":r=this._invokeOne(function(e){return e.loadBufferView&&e.loadBufferView(t)});break;case"buffer":r=this.loadBuffer(t);break;case"material":r=this._invokeOne(function(e){return e.loadMaterial&&e.loadMaterial(t)});break;case"texture":r=this._invokeOne(function(e){return e.loadTexture&&e.loadTexture(t)});break;case"skin":r=this.loadSkin(t);break;case"animation":r=this._invokeOne(function(e){return e.loadAnimation&&e.loadAnimation(t)});break;case"camera":r=this.loadCamera(t);break;default:if(!(r=this._invokeOne(function(n){return n!=this&&n.getDependency&&n.getDependency(e,t)})))throw Error("Unknown type: "+e)}this.cache.add(n,r)}return r}getDependencies(e){let t=this.cache.get(e);if(!t){let n=this;t=Promise.all((this.json[e+("mesh"===e?"es":"s")]||[]).map(function(t,r){return n.getDependency(e,r)})),this.cache.add(e,t)}return t}loadBuffer(e){let t=this.json.buffers[e],n=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[C.KHR_BINARY_GLTF].body);let i=this.options;return new Promise(function(e,o){n.load(r.r6x.resolveURL(t.uri,i.path),e,void 0,function(){o(Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){let t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(e){let n=t.byteLength||0,r=t.byteOffset||0;return e.slice(r,r+n)})}loadAccessor(e){let t=this,n=this.json,i=this.json.accessors[e];if(void 0===i.bufferView&&void 0===i.sparse){let e=ec[i.type],t=es[i.componentType],n=!0===i.normalized,o=new t(i.count*e);return Promise.resolve(new r.THS(o,e,n))}let o=[];return void 0!==i.bufferView?o.push(this.getDependency("bufferView",i.bufferView)):o.push(null),void 0!==i.sparse&&(o.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),o.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(o).then(function(e){let o,s,a=e[0],l=ec[i.type],c=es[i.componentType],u=c.BYTES_PER_ELEMENT,h=u*l,f=i.byteOffset||0,p=void 0!==i.bufferView?n.bufferViews[i.bufferView].byteStride:void 0,d=!0===i.normalized;if(p&&p!==h){let e=Math.floor(f/p),n="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+e+":"+i.count,h=t.cache.get(n);h||(o=new c(a,e*p,i.count*p/u),h=new r.eB$(o,p/u),t.cache.add(n,h)),s=new r.eHs(h,l,f%p/u,d)}else o=null===a?new c(i.count*l):new c(a,f,i.count*l),s=new r.THS(o,l,d);if(void 0!==i.sparse){let t=ec.SCALAR,n=es[i.sparse.indices.componentType],o=i.sparse.indices.byteOffset||0,u=i.sparse.values.byteOffset||0,h=new n(e[1],o,i.sparse.count*t),f=new c(e[2],u,i.sparse.count*l);null!==a&&(s=new r.THS(s.array.slice(),s.itemSize,s.normalized)),s.normalized=!1;for(let e=0,t=h.length;e<t;e++){let t=h[e];if(s.setX(t,f[e*l]),l>=2&&s.setY(t,f[e*l+1]),l>=3&&s.setZ(t,f[e*l+2]),l>=4&&s.setW(t,f[e*l+3]),l>=5)throw Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}s.normalized=d}return s})}loadTexture(e){let t=this.json,n=this.options,r=t.textures[e].source,i=t.images[r],o=this.textureLoader;if(i.uri){let e=n.manager.getHandler(i.uri);null!==e&&(o=e)}return this.loadTextureImage(e,r,o)}loadTextureImage(e,t,n){let i=this,o=this.json,s=o.textures[e],a=o.images[t],l=(a.uri||a.bufferView)+":"+s.sampler;if(this.textureCache[l])return this.textureCache[l];let c=this.loadImageSource(t,n).then(function(t){t.flipY=!1,t.name=s.name||a.name||"",""===t.name&&"string"==typeof a.uri&&!1===a.uri.startsWith("data:image/")&&(t.name=a.uri);let n=(o.samplers||{})[s.sampler]||{};return t.magFilter=ea[n.magFilter]||r.k6q,t.minFilter=ea[n.minFilter]||r.$_I,t.wrapS=el[n.wrapS]||r.GJx,t.wrapT=el[n.wrapT]||r.GJx,t.generateMipmaps=!t.isCompressedTexture&&t.minFilter!==r.hxR&&t.minFilter!==r.k6q,i.associations.set(t,{textures:e}),t}).catch(function(){return null});return this.textureCache[l]=c,c}loadImageSource(e,t){let n=this.json,i=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then(e=>e.clone());let o=n.images[e],s=self.URL||self.webkitURL,a=o.uri||"",l=!1;if(void 0!==o.bufferView)a=this.getDependency("bufferView",o.bufferView).then(function(e){l=!0;let t=new Blob([e],{type:o.mimeType});return a=s.createObjectURL(t)});else if(void 0===o.uri)throw Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");let c=Promise.resolve(a).then(function(e){return new Promise(function(n,o){let s=n;!0===t.isImageBitmapLoader&&(s=function(e){let t=new r.gPd(e);t.needsUpdate=!0,n(t)}),t.load(r.r6x.resolveURL(e,i.path),s,void 0,o)})}).then(function(e){var t;return!0===l&&s.revokeObjectURL(a),ed(e,o),e.userData.mimeType=o.mimeType||((t=o.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":t.search(/\.ktx2($|\?)/i)>0||0===t.search(/^data\:image\/ktx2/)?"image/ktx2":"image/png"),e}).catch(function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",a),e});return this.sourceCache[e]=c,c}assignTexture(e,t,n,r){let i=this;return this.getDependency("texture",n.index).then(function(o){if(!o)return null;if(void 0!==n.texCoord&&n.texCoord>0&&((o=o.clone()).channel=n.texCoord),i.extensions[C.KHR_TEXTURE_TRANSFORM]){let e=void 0!==n.extensions?n.extensions[C.KHR_TEXTURE_TRANSFORM]:void 0;if(e){let t=i.associations.get(o);o=i.extensions[C.KHR_TEXTURE_TRANSFORM].extendTexture(o,e),i.associations.set(o,t)}}return void 0!==r&&(o.colorSpace=r),e[t]=o,o})}assignFinalMaterial(e){let t=e.geometry,n=e.material,i=void 0===t.attributes.tangent,o=void 0!==t.attributes.color,s=void 0===t.attributes.normal;if(e.isPoints){let e="PointsMaterial:"+n.uuid,t=this.cache.get(e);t||(t=new r.BH$,r.imn.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,t.sizeAttenuation=!1,this.cache.add(e,t)),n=t}else if(e.isLine){let e="LineBasicMaterial:"+n.uuid,t=this.cache.get(e);t||(t=new r.mrM,r.imn.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,this.cache.add(e,t)),n=t}if(i||o||s){let e="ClonedMaterial:"+n.uuid+":";i&&(e+="derivative-tangents:"),o&&(e+="vertex-colors:"),s&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=n.clone(),o&&(t.vertexColors=!0),s&&(t.flatShading=!0),i&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(n))),n=t}e.material=n}getMaterialType(){return r._4j}loadMaterial(e){let t,n=this,i=this.json,o=this.extensions,s=i.materials[e],a={},l=s.extensions||{},c=[];if(l[C.KHR_MATERIALS_UNLIT]){let e=o[C.KHR_MATERIALS_UNLIT];t=e.getMaterialType(),c.push(e.extendParams(a,s,n))}else{let i=s.pbrMetallicRoughness||{};if(a.color=new r.Q1f(1,1,1),a.opacity=1,Array.isArray(i.baseColorFactor)){let e=i.baseColorFactor;a.color.setRGB(e[0],e[1],e[2],r.Zr2),a.opacity=e[3]}void 0!==i.baseColorTexture&&c.push(n.assignTexture(a,"map",i.baseColorTexture,r.er$)),a.metalness=void 0!==i.metallicFactor?i.metallicFactor:1,a.roughness=void 0!==i.roughnessFactor?i.roughnessFactor:1,void 0!==i.metallicRoughnessTexture&&(c.push(n.assignTexture(a,"metalnessMap",i.metallicRoughnessTexture)),c.push(n.assignTexture(a,"roughnessMap",i.metallicRoughnessTexture))),t=this._invokeOne(function(t){return t.getMaterialType&&t.getMaterialType(e)}),c.push(Promise.all(this._invokeAll(function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,a)})))}!0===s.doubleSided&&(a.side=r.$EB);let u=s.alphaMode||"OPAQUE";if("BLEND"===u?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,"MASK"===u&&(a.alphaTest=void 0!==s.alphaCutoff?s.alphaCutoff:.5)),void 0!==s.normalTexture&&t!==r.V9B&&(c.push(n.assignTexture(a,"normalMap",s.normalTexture)),a.normalScale=new r.I9Y(1,1),void 0!==s.normalTexture.scale)){let e=s.normalTexture.scale;a.normalScale.set(e,e)}if(void 0!==s.occlusionTexture&&t!==r.V9B&&(c.push(n.assignTexture(a,"aoMap",s.occlusionTexture)),void 0!==s.occlusionTexture.strength&&(a.aoMapIntensity=s.occlusionTexture.strength)),void 0!==s.emissiveFactor&&t!==r.V9B){let e=s.emissiveFactor;a.emissive=new r.Q1f().setRGB(e[0],e[1],e[2],r.Zr2)}return void 0!==s.emissiveTexture&&t!==r.V9B&&c.push(n.assignTexture(a,"emissiveMap",s.emissiveTexture,r.er$)),Promise.all(c).then(function(){let r=new t(a);return s.name&&(r.name=s.name),ed(r,s),n.associations.set(r,{materials:e}),s.extensions&&ep(o,r,s),r})}createUniqueName(e){let t=r.Nwf.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){let t=this,n=this.extensions,i=this.primitiveCache,o=[];for(let s=0,a=e.length;s<a;s++){let a=e[s],l=function(e){let t,n=e.extensions&&e.extensions[C.KHR_DRACO_MESH_COMPRESSION];if(t=n?"draco:"+n.bufferView+":"+n.indices+":"+ev(n.attributes):e.indices+":"+ev(e.attributes)+":"+e.mode,void 0!==e.targets)for(let n=0,r=e.targets.length;n<r;n++)t+=":"+ev(e.targets[n]);return t}(a),c=i[l];if(c)o.push(c.promise);else{let e;e=a.extensions&&a.extensions[C.KHR_DRACO_MESH_COMPRESSION]?function(e){return n[C.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then(function(n){return eg(n,e,t)})}(a):eg(new r.LoY,a,t),i[l]={primitive:a,promise:e},o.push(e)}}return Promise.all(o)}loadMesh(e){let t=this,n=this.json,i=this.extensions,o=n.meshes[e],s=o.primitives,a=[];for(let e=0,t=s.length;e<t;e++){var l;let t=void 0===s[e].material?(void 0===(l=this.cache).DefaultMaterial&&(l.DefaultMaterial=new r._4j({color:0xffffff,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:r.hB5})),l.DefaultMaterial):this.getDependency("material",s[e].material);a.push(t)}return a.push(t.loadGeometries(s)),Promise.all(a).then(function(n){let a=n.slice(0,n.length-1),l=n[n.length-1],c=[];for(let n=0,u=l.length;n<u;n++){let u,h=l[n],f=s[n],p=a[n];if(f.mode===eo.TRIANGLES||f.mode===eo.TRIANGLE_STRIP||f.mode===eo.TRIANGLE_FAN||void 0===f.mode)!0===(u=!0===o.isSkinnedMesh?new r.I46(h,p):new r.eaF(h,p)).isSkinnedMesh&&u.normalizeSkinWeights(),f.mode===eo.TRIANGLE_STRIP?u.geometry=A(u.geometry,r.O49):f.mode===eo.TRIANGLE_FAN&&(u.geometry=A(u.geometry,r.rYR));else if(f.mode===eo.LINES)u=new r.DXC(h,p);else if(f.mode===eo.LINE_STRIP)u=new r.N1A(h,p);else if(f.mode===eo.LINE_LOOP)u=new r.FCc(h,p);else if(f.mode===eo.POINTS)u=new r.ONl(h,p);else throw Error("THREE.GLTFLoader: Primitive mode unsupported: "+f.mode);Object.keys(u.geometry.morphAttributes).length>0&&function(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let n=0,r=t.weights.length;n<r;n++)e.morphTargetInfluences[n]=t.weights[n];if(t.extras&&Array.isArray(t.extras.targetNames)){let n=t.extras.targetNames;if(e.morphTargetInfluences.length===n.length){e.morphTargetDictionary={};for(let t=0,r=n.length;t<r;t++)e.morphTargetDictionary[n[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}(u,o),u.name=t.createUniqueName(o.name||"mesh_"+e),ed(u,o),f.extensions&&ep(i,u,f),t.assignFinalMaterial(u),c.push(u)}for(let n=0,r=c.length;n<r;n++)t.associations.set(c[n],{meshes:e,primitives:n});if(1===c.length)return o.extensions&&ep(i,c[0],o),c[0];let u=new r.YJl;o.extensions&&ep(i,u,o),t.associations.set(u,{meshes:e});for(let e=0,t=c.length;e<t;e++)u.add(c[e]);return u})}loadCamera(e){let t,n=this.json.cameras[e],i=n[n.type];return i?("perspective"===n.type?t=new r.ubm(r.cj9.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):"orthographic"===n.type&&(t=new r.qUd(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),n.name&&(t.name=this.createUniqueName(n.name)),ed(t,n),Promise.resolve(t)):void console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){let t=this.json.skins[e],n=[];for(let e=0,r=t.joints.length;e<r;e++)n.push(this._loadNodeShallow(t.joints[e]));return void 0!==t.inverseBindMatrices?n.push(this.getDependency("accessor",t.inverseBindMatrices)):n.push(null),Promise.all(n).then(function(e){let n=e.pop(),i=[],o=[];for(let s=0,a=e.length;s<a;s++){let a=e[s];if(a){i.push(a);let e=new r.kn4;null!==n&&e.fromArray(n.array,16*s),o.push(e)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[s])}return new r.EAD(i,o)})}loadAnimation(e){let t=this.json,n=this,i=t.animations[e],o=i.name?i.name:"animation_"+e,s=[],a=[],l=[],c=[],u=[];for(let e=0,t=i.channels.length;e<t;e++){let t=i.channels[e],n=i.samplers[t.sampler],r=t.target,o=r.node,h=void 0!==i.parameters?i.parameters[n.input]:n.input,f=void 0!==i.parameters?i.parameters[n.output]:n.output;void 0!==r.node&&(s.push(this.getDependency("node",o)),a.push(this.getDependency("accessor",h)),l.push(this.getDependency("accessor",f)),c.push(n),u.push(r))}return Promise.all([Promise.all(s),Promise.all(a),Promise.all(l),Promise.all(c),Promise.all(u)]).then(function(e){let t=e[0],s=e[1],a=e[2],l=e[3],c=e[4],u=[];for(let e=0,r=t.length;e<r;e++){let r=t[e],i=s[e],o=a[e],h=l[e],f=c[e];if(void 0===r)continue;r.updateMatrix&&r.updateMatrix();let p=n._createAnimationTracks(r,i,o,h,f);if(p)for(let e=0;e<p.length;e++)u.push(p[e])}let h=new r.tz3(o,void 0,u);return ed(h,i),h})}createNodeMesh(e){let t=this.json,n=this,r=t.nodes[e];return void 0===r.mesh?null:n.getDependency("mesh",r.mesh).then(function(e){let t=n._getNodeRef(n.meshCache,r.mesh,e);return void 0!==r.weights&&t.traverse(function(e){if(e.isMesh)for(let t=0,n=r.weights.length;t<n;t++)e.morphTargetInfluences[t]=r.weights[t]}),t})}loadNode(e){let t=this.json.nodes[e],n=this._loadNodeShallow(e),r=[],i=t.children||[];for(let e=0,t=i.length;e<t;e++)r.push(this.getDependency("node",i[e]));let o=void 0===t.skin?Promise.resolve(null):this.getDependency("skin",t.skin);return Promise.all([n,Promise.all(r),o]).then(function(e){let t=e[0],n=e[1],r=e[2];null!==r&&t.traverse(function(e){e.isSkinnedMesh&&e.bind(r,em)});for(let e=0,r=n.length;e<r;e++)t.add(n[e]);return t})}_loadNodeShallow(e){let t=this.json,n=this.extensions,i=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];let o=t.nodes[e],s=o.name?i.createUniqueName(o.name):"",a=[],l=i._invokeOne(function(t){return t.createNodeMesh&&t.createNodeMesh(e)});return l&&a.push(l),void 0!==o.camera&&a.push(i.getDependency("camera",o.camera).then(function(e){return i._getNodeRef(i.cameraCache,o.camera,e)})),i._invokeAll(function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)}).forEach(function(e){a.push(e)}),this.nodeCache[e]=Promise.all(a).then(function(t){let a;if((a=!0===o.isBone?new r.$Kf:t.length>1?new r.YJl:1===t.length?t[0]:new r.B69)!==t[0])for(let e=0,n=t.length;e<n;e++)a.add(t[e]);if(o.name&&(a.userData.name=o.name,a.name=s),ed(a,o),o.extensions&&ep(n,a,o),void 0!==o.matrix){let e=new r.kn4;e.fromArray(o.matrix),a.applyMatrix4(e)}else void 0!==o.translation&&a.position.fromArray(o.translation),void 0!==o.rotation&&a.quaternion.fromArray(o.rotation),void 0!==o.scale&&a.scale.fromArray(o.scale);if(i.associations.has(a)){if(void 0!==o.mesh&&i.meshCache.refs[o.mesh]>1){let e=i.associations.get(a);i.associations.set(a,{...e})}}else i.associations.set(a,{});return i.associations.get(a).nodes=e,a}),this.nodeCache[e]}loadScene(e){let t=this.extensions,n=this.json.scenes[e],i=this,o=new r.YJl;n.name&&(o.name=i.createUniqueName(n.name)),ed(o,n),n.extensions&&ep(t,o,n);let s=n.nodes||[],a=[];for(let e=0,t=s.length;e<t;e++)a.push(i.getDependency("node",s[e]));return Promise.all(a).then(function(e){for(let t=0,n=e.length;t<n;t++)o.add(e[t]);return i.associations=(e=>{let t=new Map;for(let[e,n]of i.associations)(e instanceof r.imn||e instanceof r.gPd)&&t.set(e,n);return e.traverse(e=>{let n=i.associations.get(e);null!=n&&t.set(e,n)}),t})(o),o})}_createAnimationTracks(e,t,n,i,o){let s,a=[],l=e.name?e.name:e.uuid,c=[];switch(eh[o.path]===eh.weights?e.traverse(function(e){e.morphTargetInfluences&&c.push(e.name?e.name:e.uuid)}):c.push(l),eh[o.path]){case eh.weights:s=r.Hit;break;case eh.rotation:s=r.MBL;break;case eh.translation:case eh.scale:s=r.RiT;break;default:s=1===n.itemSize?r.Hit:r.RiT}let u=void 0!==i.interpolation?ef[i.interpolation]:r.PJ3,h=this._getArrayFromAccessor(n);for(let e=0,n=c.length;e<n;e++){let n=new s(c[e]+"."+eh[o.path],t.array,h,u);"CUBICSPLINE"===i.interpolation&&this._createCubicSplineTrackInterpolant(n),a.push(n)}return a}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){let e=ey(t.constructor),n=new Float32Array(t.length);for(let r=0,i=t.length;r<i;r++)n[r]=t[r]*e;t=n}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof r.MBL?ei:en)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function eg(e,t,n){let i=t.attributes,o=[];for(let t in i){let r=eu[t]||t.toLowerCase();r in e.attributes||o.push(function(t,r){return n.getDependency("accessor",t).then(function(t){e.setAttribute(r,t)})}(i[t],r))}if(void 0!==t.indices&&!e.index){let r=n.getDependency("accessor",t.indices).then(function(t){e.setIndex(t)});o.push(r)}return r.ppV.workingColorSpace!==r.Zr2&&"COLOR_0"in i&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${r.ppV.workingColorSpace}" not supported.`),ed(e,t),!function(e,t,n){let i=t.attributes,o=new r.NRn;if(void 0===i.POSITION)return;{let e=n.json.accessors[i.POSITION],t=e.min,s=e.max;if(void 0===t||void 0===s)return console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(o.set(new r.Pq0(t[0],t[1],t[2]),new r.Pq0(s[0],s[1],s[2])),e.normalized){let t=ey(es[e.componentType]);o.min.multiplyScalar(t),o.max.multiplyScalar(t)}}let s=t.targets;if(void 0!==s){let e=new r.Pq0,t=new r.Pq0;for(let r=0,i=s.length;r<i;r++){let i=s[r];if(void 0!==i.POSITION){let r=n.json.accessors[i.POSITION],o=r.min,s=r.max;if(void 0!==o&&void 0!==s){if(t.setX(Math.max(Math.abs(o[0]),Math.abs(s[0]))),t.setY(Math.max(Math.abs(o[1]),Math.abs(s[1]))),t.setZ(Math.max(Math.abs(o[2]),Math.abs(s[2]))),r.normalized){let e=ey(es[r.componentType]);t.multiplyScalar(e)}e.max(t)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}o.expandByVector(e)}e.boundingBox=o;let a=new r.iyt;o.getCenter(a.center),a.radius=o.min.distanceTo(o.max)/2,e.boundingSphere=a}(e,t,n),Promise.all(o).then(function(){return void 0!==t.targets?function(e,t,n){let r=!1,i=!1,o=!1;for(let e=0,n=t.length;e<n;e++){let n=t[e];if(void 0!==n.POSITION&&(r=!0),void 0!==n.NORMAL&&(i=!0),void 0!==n.COLOR_0&&(o=!0),r&&i&&o)break}if(!r&&!i&&!o)return Promise.resolve(e);let s=[],a=[],l=[];for(let c=0,u=t.length;c<u;c++){let u=t[c];if(r){let t=void 0!==u.POSITION?n.getDependency("accessor",u.POSITION):e.attributes.position;s.push(t)}if(i){let t=void 0!==u.NORMAL?n.getDependency("accessor",u.NORMAL):e.attributes.normal;a.push(t)}if(o){let t=void 0!==u.COLOR_0?n.getDependency("accessor",u.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(s),Promise.all(a),Promise.all(l)]).then(function(t){let n=t[0],s=t[1],a=t[2];return r&&(e.morphAttributes.position=n),i&&(e.morphAttributes.normal=s),o&&(e.morphAttributes.color=a),e.morphTargetsRelative=!0,e})}(e,t.targets,n):e})}var ew=n("./src/model/physics/constants.ts"),ek=console.error;function eT(e){new o().parse(e,function(e){var t,n,r;console.log(e),t=e,n="scene.gltf",(r=document.createElement("a")).setAttribute("href","data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(t))),r.setAttribute("download",n),document.body.appendChild(r),r.click(),r.remove()},ek)}function ex(e,t){new M().load(e,function(n){n.scene.scale.set(ew.R/.5,ew.R/.5,ew.R/.5),n.scene.matrixAutoUpdate=!1,n.scene.updateMatrix(),n.scene.updateMatrixWorld(),n.scene.name=e,t(n)},function(t){return console.log(e+" "+t.loaded+" bytes loaded")},ek)}},"./src/utils/rack.ts"(e,t,n){n.d(t,{m:()=>h});var r=n("./src/model/ball.ts"),i=n("./src/utils/snookerconfig.ts"),o=n("./src/view/tablegeometry.ts"),s=n("./src/view/pocketgeometry.ts"),a=n("./node_modules/three/build/three.core.js"),l=n("./src/utils/utils.ts"),c=n("./src/model/physics/constants.ts");function u(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var h=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"jitter",value:function(e){return(0,l.ld)(e.clone().add(new a.Pq0(t.noise*(Math.random()-.5),t.noise*(Math.random()-.5),0)))}},{key:"cueBall",value:function(e,n){return new r.c(t.jitter(e),0xfaebd7,n)}},{key:"swapBallPositions",value:function(e,t){var n=e.pos.clone();e.pos.copy(t.pos),t.pos.copy(n)}},{key:"diamond",value:function(){var e=new a.Pq0(o.P.tableX/2,0,0),n=[],i=function(e,n,i){return new r.c(t.jitter(e),n,i)};return n.push(t.cueBall(t.spot)),n.push(i(e,t.BALL_COLORS[1],1)),e.add(t.diagonal),n.push(i(e,t.BALL_COLORS[2],2)),e.sub(t.across),n.push(i(e,t.BALL_COLORS[3],3)),e.add(t.diagonal),n.push(i(e,t.BALL_COLORS[4],4)),e.sub(t.across),n.push(i(e,t.BALL_COLORS[5],5)),e.addScaledVector(t.across,2),n.push(i(e,t.BALL_COLORS[6],6)),e.add(t.diagonal).sub(t.across),n.push(i(e,t.BALL_COLORS[7],7)),e.sub(t.across),n.push(i(e,t.BALL_COLORS[8],8)),e.add(t.diagonal),n.push(i(e,t.BALL_COLORS[9],9)),t.swapBallPositions(n[4],n[9]),n}},{key:"triangle",value:function(){var e=t.trianglePositions(),n=[];return n.push(t.cueBall(t.spot)),e.forEach(function(e,i){var o=i+1;n.push(new r.c(t.jitter(e),t.BALL_COLORS[o],o))}),t.swapBallPositions(n[4],n[9]),n}},{key:"trianglePositions",value:function(){var e=[],t=new a.Pq0(o.P.X/2,0,0);return e.push((0,l.t6)(t)),t.add(this.diagonal),e.push((0,l.t6)(t)),t.sub(this.across),e.push((0,l.t6)(t)),t.add(this.diagonal),e.push((0,l.t6)(t)),t.sub(this.across),e.push((0,l.t6)(t)),t.addScaledVector(this.across,2),e.push((0,l.t6)(t)),t.add(this.diagonal),e.push((0,l.t6)(t)),t.sub(this.across),e.push((0,l.t6)(t)),t.sub(this.across),e.push((0,l.t6)(t)),t.sub(this.across),e.push((0,l.t6)(t)),t.add(this.diagonal).sub(this.across),e.push((0,l.t6)(t)),t.add(this.across),e.push((0,l.t6)(t)),t.add(this.across),e.push((0,l.t6)(t)),t.add(this.across),e.push((0,l.t6)(t)),t.add(this.across),e.push((0,l.t6)(t)),e}},{key:"rerack",value:function(e,n){var i=t.trianglePositions(),o=i.shift();n.balls.filter(function(e){return e!==n.cueball}).filter(function(t){return t!==e}).forEach(function(e){e.pos.copy(t.jitter(i.shift())),e.state=r.U.Stationary}),n.overlapsAny(e.pos,e)&&e.pos.copy(o),n.overlapsAny(n.cueball.pos)&&n.cueball.pos.copy(t.spot)}},{key:"three",value:function(){var e=[],n=o.P.X/2,i=o.P.Y/4;return e.push(t.cueBall(t.jitter(new a.Pq0(-n,-i,0)))),e.push(new r.c(t.jitter(new a.Pq0(-n,0,0)),0xe0de36)),e.push(new r.c(t.jitter(new a.Pq0(n,0,0)),0xff0000)),e}},{key:"snooker",value:function(){var e=[],n=o.P.Y/4;e.push(t.cueBall(t.jitter(new a.Pq0(t.baulk,-(.5*n),0))));var l=t.snookerColourPositions();e.push(new r.c(t.jitter(l[0]),0xeede36)),e.push(new r.c(t.jitter(l[1]),824932)),e.push(new r.c(t.jitter(l[2]),0xbd723a)),e.push(new r.c(t.jitter(l[3]),558062)),e.push(new r.c(t.jitter(l[4]),0xffaacc)),e.push(new r.c(t.jitter(l[5]),65793));var u=Math.min(i.U.reds,15),h=t.trianglePositions().slice(0,15),f=s.f.pockets.pocketS.pocket.pos;return h.forEach(function(n,i){var o=new r.c(t.jitter(n.add(t.down)),0xee0000);i>=u&&(o.pos.copy(f),o.pos.setZ(-8.5*c.R),o.state=r.U.InPocket),e.push(o)}),e}},{key:"snookerColourPositions",value:function(){var e=o.P.X/2,n=o.P.X-2*o.P.X/11,r=[];return r.push(new a.Pq0(t.baulk,-t.sixth,0)),r.push(new a.Pq0(t.baulk,t.sixth,0)),r.push(new a.Pq0(t.baulk,0,0)),r.push(new a.Pq0(0,0,0)),r.push(new a.Pq0(e,0,0)),r.push(new a.Pq0(n,0,0)),r}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();u(h,"noise",.0233*c.R),u(h,"gap",2*c.R+2*h.noise),u(h,"up",new a.Pq0(0,0,-1)),u(h,"spot",new a.Pq0(-o.P.X/2,0,0)),u(h,"across",new a.Pq0(0,h.gap,0)),u(h,"down",new a.Pq0(h.gap,0,0)),u(h,"diagonal",h.across.clone().applyAxisAngle(h.up,Math.PI/3)),u(h,"BALL_COLORS",["#FFFFFF","#ffd900","#0000FF","#FF0000","#800080","#ff3300","#008000","#600000","#000000","#FFFF00","#0000FF","#FF0000","#800080","#FF8000","#008000","#600000"]),u(h,"sixth",2*o.P.Y/6),u(h,"baulk",-1.5*o.P.X*2/5)},"./src/utils/replay-encoder.ts"(e,t,n){n.d(t,{k:()=>i});var r=n("./node_modules/jsoncrush/JSONCrush.js"),i=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"fullyEncodeURI",value:function(e){return encodeURIComponent(e).replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/!/g,"%21").replace(/\*/g,"%2A")}},{key:"crush",value:function(e){return r.A.crush(e)}},{key:"createState",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5?arguments[5]:void 0,s={init:e,shots:t,start:n,now:Date.now(),score:r,wholeGame:i,v:1};return o&&(s.players=o),s}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/utils/respot.ts"(e,t,n){n.d(t,{k:()=>l});var r=n("./src/model/ball.ts"),i=n("./src/view/tablegeometry.ts"),o=n("./src/model/physics/constants.ts"),s=n("./src/utils/rack.ts"),a=n("./node_modules/three/build/three.core.js"),l=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"nineBall",value:function(e){var n=e.balls.find(function(e){return 9===e.id});if(n){var r=new a.Pq0(i.P.tableX/2,0,0);t.respotBehind(r,n,e)}}},{key:"respot",value:function(e,n){var i=s.m.snookerColourPositions();return i.push(i[e.id-1]),i.reverse(),i.some(function(t){return!n.overlapsAny(t,e)&&(e.pos.copy(t),e.state=r.U.Stationary,!0)})||t.respotBehind(i[0],e,n),e}},{key:"respotBehind",value:function(e,t,n){for(var s=e.clone();s.x<i.P.tableX&&n.overlapsAny(s,t);)s.x+=o.R/8;for(;s.x>-i.P.tableX&&n.overlapsAny(s,t);)s.x-=o.R/8;t.pos.copy(s),t.state=r.U.Stationary}},{key:"closest",value:function(e,t){var n=t.filter(function(e){return e.onTable()}).filter(function(t){return t!==e});if(0!==n.length){var r=function(t){return e.pos.distanceTo(t.pos)};return n.reduce(function(e,t){return r(e)<r(t)?e:t},n[0])}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/utils/snookerconfig.ts"(e,t,n){n.d(t,{U:()=>r});var r={reds:15}},"./src/utils/threecushionconfig.ts"(e,t,n){n.d(t,{Y:()=>r});var r={raceTo:7}},"./src/utils/utils.ts"(e,t,n){n.d(t,{Dz:()=>v,F8:()=>w,FP:()=>b,KM:()=>u,RZ:()=>T,gn:()=>k,hs:()=>a,ld:()=>m,n7:()=>g,oN:()=>x,rq:()=>d,t6:()=>l,up:()=>s,v_:()=>o,xb:()=>f});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/events/eventtype.ts"),o=new r.Pq0(0,0,0),s=new r.Pq0(0,0,1);function a(e){return!e.entries.some(function(e){return e.event.type===i.B.AIM})}function l(e){return new r.Pq0(e.x,e.y,e.z)}var c=new r.Pq0;function u(e){return c.copy(s).cross(e)}var h=new r.Pq0;function f(e){return h.copy(e).normalize()}var p=new r.Pq0;function d(e,t){return 0>=p.copy(e).add(t).dot(e)}function v(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new r.Pq0;return t.set(1,0,0).applyAxisAngle(s,e)}function y(e){return Math.sign(e)*Math.floor((Math.abs(e)+Number.EPSILON)*1e4)/1e4}function m(e){return e.x=y(e.x),e.y=y(e.y),e.z=y(e.z),e}function b(e,t){return Math.fround(Math.atan2(e,t))}function g(e,t){return Math.fround(Math.pow(e,t))}function w(e){return Math.fround(Math.sin(e))}function k(e){return Math.fround(Math.cos(e))}function T(e){return Math.fround(Math.sqrt(e))}function x(e){return Math.fround(Math.exp(e))}},"./src/view/assets.ts"(e,t,n){n.d(t,{s:()=>y});var r=n("./src/controller/rules/rulefactory.ts"),i=n("./src/utils/gltf.ts"),o=n("./node_modules/three/build/three.core.js");function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");s(this,"listener",void 0),s(this,"audioLoader",void 0),s(this,"ballcollision",void 0),s(this,"cue",void 0),s(this,"cushion",void 0),s(this,"pot",void 0),s(this,"success",void 0),s(this,"lastOutcomeTime",0),s(this,"loadAssets",void 0),this.loadAssets=e,e&&(this.listener=new o.Pf$,this.audioLoader=new o.Am1,this.ballcollision=new o.fP5(this.listener),this.load("sounds/ballcollision.ogg",this.ballcollision),this.cue=new o.fP5(this.listener),this.load("sounds/cue.ogg",this.cue),this.cushion=new o.fP5(this.listener),this.load("sounds/cushion.ogg",this.cushion),this.pot=new o.fP5(this.listener),this.load("sounds/pot.ogg",this.pot),this.success=new o.fP5(this.listener),this.load("sounds/success.ogg",this.success))}return e=[{key:"addCameraToListener",value:function(e){e.add(this.listener)}},{key:"load",value:function(e,t){this.audioLoader.load(e,function(e){t.setBuffer(e),t.setLoop(!1)},function(e){},function(e){})}},{key:"play",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(this.loadAssets){var r,i,s=o.UtX.getContext();if((null==s?void 0:s.state)==="suspended"){(null==(i=navigator)||null==(r=i.userActivation)?void 0:r.hasBeenActive)&&s.resume();return}e.setVolume(t),e.isPlaying&&e.stop(),e.play(o.cj9.randFloat(0,.01)),e.setDetune(n)}}},{key:"outcomeToSound",value:function(e){"Collision"===e.type&&this.play(this.ballcollision,e.incidentSpeed/80,5*e.incidentSpeed),"Pot"===e.type&&this.play(this.pot,e.incidentSpeed/10,-1e3+10*e.incidentSpeed),"Cushion"===e.type&&this.play(this.cushion,e.incidentSpeed/70),"Hit"===e.type&&this.play(this.cue,e.incidentSpeed/30)}},{key:"processOutcomes",value:function(e){var t=this;e.every(function(e){return!(e.timestamp>t.lastOutcomeTime)||(t.lastOutcomeTime=e.timestamp,t.outcomeToSound(e),!1)})}},{key:"playNotify",value:function(){this.play(this.pot,1)}},{key:"playSuccess",value:function(e){this.play(this.success,.1,100*e-2200)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),l=n("./src/view/tablegeometry.ts"),c=n("./src/view/pocketgeometry.ts"),u=n("./src/model/physics/constants.ts");function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var f=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");h(this,"logger",function(e){}),h(this,"cloth",new o.tXL({color:4478393,wireframe:!1,flatShading:!0,transparent:!1})),h(this,"cushion",new o.tXL({color:5531065,wireframe:!1,flatShading:!0,transparent:!1})),h(this,"pocket",new o.tXL({color:4478361,wireframe:!1,flatShading:!0,transparent:!0,opacity:.3}))}return e=[{key:"generateTable",value:function(e){var t=this,n=new o.YJl,r=new o.HiM(0xf0f0e8,22);if(r.position.set(0,0,50*u.R),n.add(r),this.addCushions(n,e),e){c.f.knuckles.forEach(function(e){return t.knuckleCylinder(e,n)}),c.f.pocketCenters.forEach(function(e){return t.knuckleCylinder(e,n,t.pocket)});var i=c.f.pockets.pocketNW.pocket,s=c.f.pockets.pocketNW.knuckleNE;this.logger("knuckle-pocket gap = "+(i.pos.distanceTo(s.pos)-i.radius-s.radius))}return n}},{key:"knuckleCylinder",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.cloth;this.cylinder(e.pos,e.radius,.75*u.R/.5,t,n).position.setZ(-(.25*u.R)/.5/2)}},{key:"cylinder",value:function(e,n,r,i,s){var a="".concat(n,"_").concat(r),l=t.cylinderCache.get(a);l||(l=new o.Ho_(n,n,r,16),t.cylinderCache.set(a,l));var c=new o.eaF(l,s);return c.position.copy(e),c.rotation.x=Math.PI/2,i.add(c),c}},{key:"addCushions",value:function(e,t){var n=10*u.R/.5;this.plane(new o.Pq0(0,0,-u.R-n/2),2*l.P.X,2*l.P.Y,n,e,this.cloth);var r=u.R/.5,i=.75*u.R/.5,s=-(.25*u.R)/.5/2,a=l.P.X,h=l.P.Y,f=Math.abs(c.f.pockets.pocketNW.knuckleNE.pos.x-c.f.pockets.pocketN.knuckleNW.pos.x),p=Math.abs(c.f.pockets.pocketNW.knuckleSW.pos.y-c.f.pockets.pocketSW.knuckleNW.pos.y);t||(f=2*l.P.Y,p=2*l.P.Y+4*u.R),this.plane(new o.Pq0(a+r/2,0,s),r,p,i,e),this.plane(new o.Pq0(-a-r/2,0,s),r,p,i,e),this.plane(new o.Pq0(-a/2,h+r/2,s),f,r,i,e),this.plane(new o.Pq0(-a/2,-h-r/2,s),f,r,i,e),this.plane(new o.Pq0(a/2,h+r/2,s),f,r,i,e),this.plane(new o.Pq0(a/2,-h-r/2,s),f,r,i,e)}},{key:"plane",value:function(e,n,r,i,s){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:this.cushion,l="".concat(n,"_").concat(r,"_").concat(i),c=t.boxCache.get(l);c||(c=new o.iNn(n,r,i),t.boxCache.set(l,c));var u=new o.eaF(c,a);u.receiveShadow=!0,u.position.copy(e),s.add(u)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();h(f,"mesh",void 0),h(f,"cylinderCache",new Map),h(f,"boxCache",new Map);var p=n("./src/view/cuemesh.ts");function d(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function v(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var y=function(){var e,t;function n(e){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");v(this,"ready",void 0),v(this,"rules",void 0),v(this,"background",void 0),v(this,"table",void 0),v(this,"cue",void 0),v(this,"sound",void 0),this.rules=r.V.create(e,null),this.rules.tableGeometry()}return e=[{key:"loadFromWeb",value:function(e){var t=this;this.ready=e,this.sound=new a(!0),(0,i.Ro)("models/background.gltf",function(e){t.background=e.scene,t.done()}),(0,i.Ro)(this.rules.asset(),function(e){t.table=e.scene,f.mesh=e.scene.children[0],t.done()}),(0,i.Ro)("models/cue.gltf",function(e){t.cue=e,p.l.mesh=e.scene.children[0],t.done()})}},{key:"createLocal",value:function(){this.sound=new a(!1),f.mesh=new f().generateTable(l.P.hasPockets),this.table=f.mesh}},{key:"done",value:function(){this.background&&this.table&&this.cue&&this.ready()}}],t=[{key:"localAssets",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=new n(e);return t.createLocal(),t}}],e&&d(n.prototype,e),t&&d(n,t),n}()},"./src/view/cameratop.ts"(e,t,n){n.d(t,{v:()=>a});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/view/tablegeometry.ts"),o=n("./src/model/physics/constants.ts");function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"viewPoint",value:function(e,n){var s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new r.Pq0;(n!==t.lastFov||t.zoomFactor!==t.lastZoom)&&(t.cachedDist=t.zoomFactor/(2*Math.tan(n*Math.PI/360)),t.lastFov=n,t.lastZoom=t.zoomFactor);var a=t.cachedDist;if(e>this.portrait){var l=e>t.aspectLimit?2.75*i.P.tableY:2.4*i.P.tableX/e;return s.set(0,-.01*o.R,a*l)}var c=e>1/t.aspectLimit?4.9*i.P.tableY:1.35*i.P.tableX/e;return s.set(-.01*o.R,0,a*c)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();s(a,"aspectLimit",1.78),s(a,"portrait",.95),s(a,"fov",20),s(a,"zoomFactor",1),s(a,"lastFov",void 0),s(a,"lastZoom",void 0),s(a,"cachedDist",void 0)},"./src/view/cue.ts"(e,t,n){n.d(t,{s:()=>f});var r=n("./src/view/tablegeometry.ts"),i=n("./src/utils/utils.ts"),o=n("./src/events/aimevent.ts"),s=n("./src/model/ball.ts"),a=n("./src/model/physics/physics.ts"),l=n("./src/view/cuemesh.ts"),c=n("./node_modules/three/build/three.core.js"),u=n("./src/model/physics/constants.ts");function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var f=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");h(this,"mesh",void 0),h(this,"helperMesh",void 0),h(this,"placerMesh",void 0),h(this,"offCenterLimit",.3),h(this,"maxPower",160*u.R),h(this,"t",0),h(this,"aimInputs",void 0),h(this,"aim",new o.w),h(this,"length",+r.P.tableX),h(this,"tempVec",new c.Pq0),h(this,"tempVec2",new c.Pq0),h(this,"tempVec3",new c.Pq0),h(this,"raycaster",new c.tBo),this.mesh=l.l.createCue(.05*u.R/.5,.15*u.R/.5,this.length),this.helperMesh=l.l.createHelper(),this.placerMesh=l.l.createPlacer()}return e=[{key:"rotateAim",value:function(e,t){this.aim.angle=this.aim.angle+e,this.mesh.rotation.z=this.aim.angle,this.helperMesh.rotation.z=this.aim.angle,this.aimInputs.showOverlap(),this.avoidCueTouchingOtherBall(t)}},{key:"adjustPower",value:function(e){this.aim.power=Math.min(this.maxPower,this.aim.power+e),this.updateAimInput()}},{key:"setPower",value:function(e){this.aim.power=e*this.maxPower}},{key:"hit",value:function(e){var t=this.aim;this.t=0,e.state=s.U.Sliding,e.vel.copy((0,i.Dz)(t.angle,this.tempVec).multiplyScalar(t.power)),e.rvel.copy((0,a.t6)(t.offset,e.vel))}},{key:"aimAtNext",value:function(e,t){if(t){var n=(0,i.xb)(this.tempVec.copy(t.pos).sub(e.pos));this.aim.angle=(0,i.FP)(n.y,n.x)}}},{key:"adjustSpin",value:function(e,t){var n=this.tempVec3.copy(this.aim.offset).add(e);this.setSpin(n,t)}},{key:"setSpin",value:function(e,t){e.length()>this.offCenterLimit&&e.normalize().multiplyScalar(this.offCenterLimit),this.aim.offset.copy(e),this.avoidCueTouchingOtherBall(t),this.updateAimInput()}},{key:"avoidCueTouchingOtherBall",value:function(e){for(var t=0;t++<20&&this.intersectsAnything(e);)this.aim.offset.y+=.1,this.aim.offset.length()>this.offCenterLimit&&this.aim.offset.normalize().multiplyScalar(this.offCenterLimit);t>1&&this.updateAimInput()}},{key:"updateAimInput",value:function(){var e,t,n;null==(e=this.aimInputs)||e.updateVisualState(this.aim.offset.x,this.aim.offset.y),null==(t=this.aimInputs)||t.updatePowerSlider(this.aim.power/this.maxPower),null==(n=this.aimInputs)||n.showOverlap()}},{key:"moveTo",value:function(e){this.aim.pos.copy(e),this.mesh.rotation.z=this.aim.angle,this.helperMesh.rotation.z=this.aim.angle;var t=this.spinOffset(),n=((0,i.F8)(this.t+Math.PI/2)-1)*2*u.R*(this.aim.power/this.maxPower),r=(0,i.Dz)(this.aim.angle,this.tempVec).multiplyScalar(n);this.mesh.position.copy(e).add(t).add(r),this.helperMesh.position.copy(e),this.placerMesh.position.copy(e),this.placerMesh.rotation.z=this.t}},{key:"update",value:function(e){this.t+=e,this.moveTo(this.aim.pos)}},{key:"placeBallMode",value:function(){this.mesh.visible=!1,this.placerMesh.visible=!0,this.aim.angle=0}},{key:"aimMode",value:function(){this.mesh.visible=!0,this.placerMesh.visible=!1}},{key:"spinOffset",value:function(){return(0,i.KM)((0,i.Dz)(this.aim.angle,this.tempVec2)).multiplyScalar(2*this.aim.offset.x*u.R).setZ(2*this.aim.offset.y*u.R)}},{key:"intersectsAnything",value:function(e){var t=this.spinOffset(),n=this.tempVec.copy(e.cueball.pos).add(t),r=(0,i.xb)((0,i.Dz)(this.aim.angle+Math.PI,this.tempVec2).setZ(.1));this.raycaster.set(n,r);var o=[],s=!0,a=!1,l=void 0;try{for(var c,u=e.balls[Symbol.iterator]();!(s=(c=u.next()).done);s=!0){var h=c.value;o.push(h.ballmesh.mesh)}}catch(e){a=!0,l=e}finally{try{s||null==u.return||u.return()}finally{if(a)throw l}}return e.mesh&&o.push(e.mesh),this.raycaster.intersectObjects(o,!0).length>0}},{key:"showHelper",value:function(e){this.helperMesh.visible=e}},{key:"toggleHelper",value:function(){this.showHelper(!this.helperMesh.visible)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/view/cuemesh.ts"(e,t,n){n.d(t,{l:()=>a});var r=n("./src/model/physics/constants.ts"),i=n("./src/utils/utils.ts"),o=n("./node_modules/three/build/three.core.js");function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"indicateValid",value:function(e){t.placermaterial.color.setHex(e?0xccffcc:0xff0000)}},{key:"createHelper",value:function(){var e=new o.Ho_(r.R,r.R,30*r.R/.5,12,1,!0),t=new o.eaF(e,this.helpermaterial);return t.geometry.applyMatrix4(new o.kn4().identity().makeRotationAxis(i.up,-Math.PI/2)).applyMatrix4(new o.kn4().identity().makeTranslation(15*r.R/.5,0,-(.01*r.R)/.5)),t.visible=!1,t.renderOrder=-1,t.material.depthTest=!1,t}},{key:"createPlacer",value:function(){var e=new o.Ho_(.01*r.R/.5,r.R,r.R,4),n=new o.eaF(e,t.placermaterial);return n.geometry.applyMatrix4(new o.kn4().identity().makeRotationAxis(new o.Pq0(1,0,0),-Math.PI/2)).applyMatrix4(new o.kn4().identity().makeTranslation(0,0,.7*r.R/.5)),n.visible=!1,n}},{key:"createCue",value:function(e,n,s){var a=new o.Ho_(e,n,s,11),l=new o.eaF(a,t.material);return l.castShadow=!1,l.geometry.applyMatrix4(new o.kn4().identity().makeRotationAxis(new o.Pq0(1,0,0),-.17)).applyMatrix4(new o.kn4().identity().makeRotationAxis(i.up,-Math.PI/2)).applyMatrix4(new o.kn4().identity().makeTranslation(-s/2-r.R,0,s/2*.16918234906699603+.25*r.R)),l}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();s(a,"mesh",void 0),s(a,"material",new o.tXL({color:8934775,wireframe:!1,flatShading:!1})),s(a,"placermaterial",new o.tXL({color:0xccffcc,wireframe:!1,flatShading:!1,transparent:!0,opacity:.5})),s(a,"helpermaterial",new o.BKk({uniforms:{lightDirection:{value:new o.Pq0(0,0,1)}},vertexShader:`
       varying vec2 vUv;
       varying vec3 vNormal;
       void main() {
         vNormal = normal;
         vUv = uv;
diff --git a/dist/multi.html b/dist/multi.html
index a0978eb..babc801 100644
--- a/dist/multi.html
+++ b/dist/multi.html
@@ -11,11 +11,14 @@
       name="description"
       content="Play multiplayer billiards online. Nineball, three cushion, 14-1, and snooker game modes with realistic physics simulation."
     />
     <meta name="robots" content="index,follow" />
     <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
-    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
+    <meta
+      name="viewport"
+      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
+    />
     <link
       rel="canonical"
       href="https://tailuge.github.io/billiards/dist/multi.html"
     />
     <meta
@@ -41,12 +44,11 @@
       content="Play multiplayer billiards online. Multiple game modes with realistic physics."
     />
   </head>

   <body>
-    <main>
-      <h1>tailuge/billiards multiplayer test page</h1>
+    <h1>tailuge/billiards multiplayer test page</h1>
     local assets (for dev)
     <br />
     single player
     <ul>
       <li><a href="/">single player nineball</a></li>
@@ -82,11 +84,10 @@
         <a class="addwss" href="./2p.html?ruletype=snooker"
           >two players snooker in single window</a
         >
       </li>
     </ul>
-    </main>
   </body>

   <script>
     const server = window.location.origin
     const wss = server.replace(/^http/, "ws") + "/ws"
diff --git a/dist/vendor.js b/dist/vendor.js
index 2bd56ee..c4676d1 100644
--- a/dist/vendor.js
+++ b/dist/vendor.js
@@ -1,11 +1,10 @@
-(()=>{var e,i,r,n,a={"./node_modules/cross-fetch/dist/browser-ponyfill.js"(e,i,r){var n="u">typeof globalThis&&globalThis||"u">typeof self&&self||void 0!==r.g&&r.g,a=function(){function e(){this.fetch=!1,this.DOMException=n.DOMException}return e.prototype=n,new e}();(function(e){var i=void 0!==a&&a||"u">typeof self&&self||void 0!==r.g&&r.g||{},n={searchParams:"URLSearchParams"in i,iterable:"Symbol"in i&&"iterator"in Symbol,blob:"FileReader"in i&&"Blob"in i&&function(){try{return new Blob,!0}catch(e){return!1}}(),formData:"FormData"in i,arrayBuffer:"ArrayBuffer"in i};if(n.arrayBuffer)var s=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],o=ArrayBuffer.isView||function(e){return e&&s.indexOf(Object.prototype.toString.call(e))>-1};function l(e){if("string"!=typeof e&&(e=String(e)),/[^a-z0-9\-#$%&'*+.^_`|~!]/i.test(e)||""===e)throw TypeError('Invalid character in header field name: "'+e+'"');return e.toLowerCase()}function c(e){return"string"!=typeof e&&(e=String(e)),e}function h(e){var i={next:function(){var i=e.shift();return{done:void 0===i,value:i}}};return n.iterable&&(i[Symbol.iterator]=function(){return i}),i}function u(e){this.map={},e instanceof u?e.forEach(function(e,i){this.append(i,e)},this):Array.isArray(e)?e.forEach(function(e){if(2!=e.length)throw TypeError("Headers constructor: expected name/value pair to be length 2, found"+e.length);this.append(e[0],e[1])},this):e&&Object.getOwnPropertyNames(e).forEach(function(i){this.append(i,e[i])},this)}function d(e){if(!e._noBody){if(e.bodyUsed)return Promise.reject(TypeError("Already read"));e.bodyUsed=!0}}function p(e){return new Promise(function(i,r){e.onload=function(){i(e.result)},e.onerror=function(){r(e.error)}})}function f(e){var i=new FileReader,r=p(i);return i.readAsArrayBuffer(e),r}function m(e){if(e.slice)return e.slice(0);var i=new Uint8Array(e.byteLength);return i.set(new Uint8Array(e)),i.buffer}function g(){return this.bodyUsed=!1,this._initBody=function(e){if(this.bodyUsed=this.bodyUsed,this._bodyInit=e,e)if("string"==typeof e)this._bodyText=e;else if(n.blob&&Blob.prototype.isPrototypeOf(e))this._bodyBlob=e;else if(n.formData&&FormData.prototype.isPrototypeOf(e))this._bodyFormData=e;else if(n.searchParams&&URLSearchParams.prototype.isPrototypeOf(e))this._bodyText=e.toString();else{var i;n.arrayBuffer&&n.blob&&(i=e)&&DataView.prototype.isPrototypeOf(i)?(this._bodyArrayBuffer=m(e.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):n.arrayBuffer&&(ArrayBuffer.prototype.isPrototypeOf(e)||o(e))?this._bodyArrayBuffer=m(e):this._bodyText=e=Object.prototype.toString.call(e)}else this._noBody=!0,this._bodyText="";!this.headers.get("content-type")&&("string"==typeof e?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):n.searchParams&&URLSearchParams.prototype.isPrototypeOf(e)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},n.blob&&(this.blob=function(){var e=d(this);if(e)return e;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(!this._bodyFormData)return Promise.resolve(new Blob([this._bodyText]));throw Error("could not read FormData body as blob")}),this.arrayBuffer=function(){if(this._bodyArrayBuffer){var e=d(this);return e||(ArrayBuffer.isView(this._bodyArrayBuffer)?Promise.resolve(this._bodyArrayBuffer.buffer.slice(this._bodyArrayBuffer.byteOffset,this._bodyArrayBuffer.byteOffset+this._bodyArrayBuffer.byteLength)):Promise.resolve(this._bodyArrayBuffer))}if(n.blob)return this.blob().then(f);throw Error("could not read as ArrayBuffer")},this.text=function(){var e,i,r,n,a,s=d(this);if(s)return s;if(this._bodyBlob)return e=this._bodyBlob,r=p(i=new FileReader),a=(n=/charset=([A-Za-z0-9_-]+)/.exec(e.type))?n[1]:"utf-8",i.readAsText(e,a),r;if(this._bodyArrayBuffer)return Promise.resolve(function(e){for(var i=new Uint8Array(e),r=Array(i.length),n=0;n<i.length;n++)r[n]=String.fromCharCode(i[n]);return r.join("")}(this._bodyArrayBuffer));if(!this._bodyFormData)return Promise.resolve(this._bodyText);throw Error("could not read FormData body as text")},n.formData&&(this.formData=function(){return this.text().then(y)}),this.json=function(){return this.text().then(JSON.parse)},this}u.prototype.append=function(e,i){e=l(e),i=c(i);var r=this.map[e];this.map[e]=r?r+", "+i:i},u.prototype.delete=function(e){delete this.map[l(e)]},u.prototype.get=function(e){return e=l(e),this.has(e)?this.map[e]:null},u.prototype.has=function(e){return this.map.hasOwnProperty(l(e))},u.prototype.set=function(e,i){this.map[l(e)]=c(i)},u.prototype.forEach=function(e,i){for(var r in this.map)this.map.hasOwnProperty(r)&&e.call(i,this.map[r],r,this)},u.prototype.keys=function(){var e=[];return this.forEach(function(i,r){e.push(r)}),h(e)},u.prototype.values=function(){var e=[];return this.forEach(function(i){e.push(i)}),h(e)},u.prototype.entries=function(){var e=[];return this.forEach(function(i,r){e.push([r,i])}),h(e)},n.iterable&&(u.prototype[Symbol.iterator]=u.prototype.entries);var v=["CONNECT","DELETE","GET","HEAD","OPTIONS","PATCH","POST","PUT","TRACE"];function _(e,r){if(!(this instanceof _))throw TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');var n,a,s=(r=r||{}).body;if(e instanceof _){if(e.bodyUsed)throw TypeError("Already read");this.url=e.url,this.credentials=e.credentials,r.headers||(this.headers=new u(e.headers)),this.method=e.method,this.mode=e.mode,this.signal=e.signal,s||null==e._bodyInit||(s=e._bodyInit,e.bodyUsed=!0)}else this.url=String(e);if(this.credentials=r.credentials||this.credentials||"same-origin",(r.headers||!this.headers)&&(this.headers=new u(r.headers)),this.method=(a=(n=r.method||this.method||"GET").toUpperCase(),v.indexOf(a)>-1?a:n),this.mode=r.mode||this.mode||null,this.signal=r.signal||this.signal||function(){if("AbortController"in i)return new AbortController().signal}(),this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&s)throw TypeError("Body not allowed for GET or HEAD requests");if(this._initBody(s),("GET"===this.method||"HEAD"===this.method)&&("no-store"===r.cache||"no-cache"===r.cache)){var o=/([?&])_=[^&]*/;o.test(this.url)?this.url=this.url.replace(o,"$1_="+new Date().getTime()):this.url+=(/\?/.test(this.url)?"&":"?")+"_="+new Date().getTime()}}function y(e){var i=new FormData;return e.trim().split("&").forEach(function(e){if(e){var r=e.split("="),n=r.shift().replace(/\+/g," "),a=r.join("=").replace(/\+/g," ");i.append(decodeURIComponent(n),decodeURIComponent(a))}}),i}function x(e,i){if(!(this instanceof x))throw TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');if(i||(i={}),this.type="default",this.status=void 0===i.status?200:i.status,this.status<200||this.status>599)throw RangeError("Failed to construct 'Response': The status provided (0) is outside the range [200, 599].");this.ok=this.status>=200&&this.status<300,this.statusText=void 0===i.statusText?"":""+i.statusText,this.headers=new u(i.headers),this.url=i.url||"",this._initBody(e)}_.prototype.clone=function(){return new _(this,{body:this._bodyInit})},g.call(_.prototype),g.call(x.prototype),x.prototype.clone=function(){return new x(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new u(this.headers),url:this.url})},x.error=function(){var e=new x(null,{status:200,statusText:""});return e.ok=!1,e.status=0,e.type="error",e};var M=[301,302,303,307,308];x.redirect=function(e,i){if(-1===M.indexOf(i))throw RangeError("Invalid status code");return new x(null,{status:i,headers:{location:e}})},e.DOMException=i.DOMException;try{new e.DOMException}catch(i){e.DOMException=function(e,i){this.message=e,this.name=i;var r=Error(e);this.stack=r.stack},e.DOMException.prototype=Object.create(Error.prototype),e.DOMException.prototype.constructor=e.DOMException}function S(r,a){return new Promise(function(s,o){var h=new _(r,a);if(h.signal&&h.signal.aborted)return o(new e.DOMException("Aborted","AbortError"));var d=new XMLHttpRequest;function p(){d.abort()}if(d.onload=function(){var e,i,r={statusText:d.statusText,headers:(e=d.getAllResponseHeaders()||"",i=new u,e.replace(/\r?\n[\t ]+/g," ").split(`\r`).map(function(e){return 0===e.indexOf(`
-`)?e.substr(1,e.length):e}).forEach(function(e){var r=e.split(":"),n=r.shift().trim();if(n){var a=r.join(":").trim();try{i.append(n,a)}catch(e){console.warn("Response "+e.message)}}}),i)};0===h.url.indexOf("file://")&&(d.status<200||d.status>599)?r.status=200:r.status=d.status,r.url="responseURL"in d?d.responseURL:r.headers.get("X-Request-URL");var n="response"in d?d.response:d.responseText;setTimeout(function(){s(new x(n,r))},0)},d.onerror=function(){setTimeout(function(){o(TypeError("Network request failed"))},0)},d.ontimeout=function(){setTimeout(function(){o(TypeError("Network request timed out"))},0)},d.onabort=function(){setTimeout(function(){o(new e.DOMException("Aborted","AbortError"))},0)},d.open(h.method,function(e){try{return""===e&&i.location.href?i.location.href:e}catch(i){return e}}(h.url),!0),"include"===h.credentials?d.withCredentials=!0:"omit"===h.credentials&&(d.withCredentials=!1),"responseType"in d&&(n.blob?d.responseType="blob":n.arrayBuffer&&(d.responseType="arraybuffer")),a&&"object"==typeof a.headers&&!(a.headers instanceof u||i.Headers&&a.headers instanceof i.Headers)){var f=[];Object.getOwnPropertyNames(a.headers).forEach(function(e){f.push(l(e)),d.setRequestHeader(e,c(a.headers[e]))}),h.headers.forEach(function(e,i){-1===f.indexOf(i)&&d.setRequestHeader(i,e)})}else h.headers.forEach(function(e,i){d.setRequestHeader(i,e)});h.signal&&(h.signal.addEventListener("abort",p),d.onreadystatechange=function(){4===d.readyState&&h.signal.removeEventListener("abort",p)}),d.send(void 0===h._bodyInit?null:h._bodyInit)})}S.polyfill=!0,i.fetch||(i.fetch=S,i.Headers=u,i.Request=_,i.Response=x),e.Headers=u,e.Request=_,e.Response=x,e.fetch=S})({}),a.fetch.ponyfill=!0,delete a.fetch.polyfill;var s=n.fetch?n:a;(i=s.fetch).default=s.fetch,i.fetch=s.fetch,i.Headers=s.Headers,i.Request=s.Request,i.Response=s.Response,e.exports=i},"./node_modules/interactjs/dist/interact.min.js"(e,i,r){e=r.nmd(e),e.exports=function(){"use strict";function i(e,i){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);i&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),r.push.apply(r,n)}return r}function r(e){for(var r=1;r<arguments.length;r++){var n=null!=arguments[r]?arguments[r]:{};r%2?i(Object(n),!0).forEach(function(i){var r,a,s;r=e,a=i,s=n[i],(a=f(a))in r?Object.defineProperty(r,a,{value:s,enumerable:!0,configurable:!0,writable:!0}):r[a]=s}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach(function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))})}return e}function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function a(e,i){if(!(e instanceof i))throw TypeError("Cannot call a class as a function")}function s(e,i){for(var r=0;r<i.length;r++){var n=i[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,f(n.key),n)}}function o(e,i,r){return i&&s(e.prototype,i),r&&s(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function l(e,i){if("function"!=typeof i&&null!==i)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(i&&i.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),i&&h(e,i)}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function h(e,i){return(h=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,i){return e.__proto__=i,e})(e,i)}function u(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function d(e){var i=function(){if("u"<typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var r,n=c(e);r=i?Reflect.construct(n,arguments,c(this).constructor):n.apply(this,arguments);if(r&&("object"==typeof r||"function"==typeof r))return r;if(void 0!==r)throw TypeError("Derived constructors may only return object or undefined");return u(this)}}function p(){return(p="u">typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,i,r){var n=function(e,i){for(;!Object.prototype.hasOwnProperty.call(e,i)&&null!==(e=c(e)););return e}(e,i);if(n){var a=Object.getOwnPropertyDescriptor(n,i);return a.get?a.get.call(arguments.length<3?e:r):a.value}}).apply(this,arguments)}function f(e){var i=function(e,i){if("object"!=typeof e||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,i||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===i?String:Number)(e)}(e,"string");return"symbol"==typeof i?i:i+""}var m,g,v,_=function(e){return!(!e||!e.Window)&&e instanceof e.Window},y=void 0,x=void 0;function M(e){y=e;var i=e.document.createTextNode("");i.ownerDocument!==e.document&&"function"==typeof e.wrap&&e.wrap(i)===i&&(e=e.wrap(e)),x=e}function S(e){return _(e)?e:(e.ownerDocument||e).defaultView||x.window}"u">typeof window&&window&&M(window);var b=function(e){return!!e&&"object"===n(e)},T=function(e){return"function"==typeof e},E=function(e){return e===x||_(e)},w=function(e){return b(e)&&11===e.nodeType},A=function(e){return"number"==typeof e},R=function(e){return"boolean"==typeof e},C=function(e){return"string"==typeof e},P=function(e){if(!e||"object"!==n(e))return!1;var i=S(e)||x;return/object|function/.test("u"<typeof Element?"undefined":n(Element))?e instanceof Element||e instanceof i.Element:1===e.nodeType&&"string"==typeof e.nodeName},I=function(e){return b(e)&&!!e.constructor&&/function Object\b/.test(e.constructor.toString())},L=function(e){return b(e)&&void 0!==e.length&&T(e.splice)};function D(e){var i=e.interaction;if("drag"===i.prepared.name){var r=i.prepared.axis;"x"===r?(i.coords.cur.page.y=i.coords.start.page.y,i.coords.cur.client.y=i.coords.start.client.y,i.coords.velocity.client.y=0,i.coords.velocity.page.y=0):"y"===r&&(i.coords.cur.page.x=i.coords.start.page.x,i.coords.cur.client.x=i.coords.start.client.x,i.coords.velocity.client.x=0,i.coords.velocity.page.x=0)}}function U(e){var i=e.iEvent,r=e.interaction;if("drag"===r.prepared.name){var n=r.prepared.axis;if("x"===n||"y"===n){var a="x"===n?"y":"x";i.page[a]=r.coords.start.page[a],i.client[a]=r.coords.start.client[a],i.delta[a]=0}}}var N={id:"actions/drag",install:function(e){var i=e.actions,r=e.Interactable,n=e.defaults;r.prototype.draggable=N.draggable,i.map.drag=N,i.methodDict.drag="draggable",n.actions.drag=N.defaults},listeners:{"interactions:before-action-move":D,"interactions:action-resume":D,"interactions:action-move":U,"auto-start:check":function(e){var i=e.interaction,r=e.interactable,n=e.buttons,a=r.options.drag;if(a&&a.enabled&&(!i.pointerIsDown||!/mouse|pointer/.test(i.pointerType)||0!=(n&r.options.drag.mouseButtons)))return e.action={name:"drag",axis:"start"===a.lockAxis?a.startAxis:a.lockAxis},!1}},draggable:function(e){return b(e)?(this.options.drag.enabled=!1!==e.enabled,this.setPerAction("drag",e),this.setOnEvents("drag",e),/^(xy|x|y|start)$/.test(e.lockAxis)&&(this.options.drag.lockAxis=e.lockAxis),/^(xy|x|y)$/.test(e.startAxis)&&(this.options.drag.startAxis=e.startAxis),this):R(e)?(this.options.drag.enabled=e,this):this.options.drag},beforeMove:D,move:U,defaults:{startAxis:"xy",lockAxis:"xy"},getCursor:function(){return"move"},filterEventType:function(e){return 0===e.search("drag")}},O={init:function(e){O.document=e.document,O.DocumentFragment=e.DocumentFragment||F,O.SVGElement=e.SVGElement||F,O.SVGSVGElement=e.SVGSVGElement||F,O.SVGElementInstance=e.SVGElementInstance||F,O.Element=e.Element||F,O.HTMLElement=e.HTMLElement||O.Element,O.Event=e.Event,O.Touch=e.Touch||F,O.PointerEvent=e.PointerEvent||e.MSPointerEvent},document:null,DocumentFragment:null,SVGElement:null,SVGSVGElement:null,SVGElementInstance:null,Element:null,HTMLElement:null,Event:null,Touch:null,PointerEvent:null};function F(){}var B={init:function(e){var i=O.Element,r=e.navigator||{};B.supportsTouch="ontouchstart"in e||T(e.DocumentTouch)&&O.document instanceof e.DocumentTouch,B.supportsPointerEvent=!1!==r.pointerEnabled&&!!O.PointerEvent,B.isIOS=/iP(hone|od|ad)/.test(r.platform),B.isIOS7=/iP(hone|od|ad)/.test(r.platform)&&/OS 7[^\d]/.test(r.appVersion),B.isIe9=/MSIE 9/.test(r.userAgent),B.isOperaMobile="Opera"===r.appName&&B.supportsTouch&&/Presto/.test(r.userAgent),B.prefixedMatchesSelector="matches"in i.prototype?"matches":"webkitMatchesSelector"in i.prototype?"webkitMatchesSelector":"mozMatchesSelector"in i.prototype?"mozMatchesSelector":"oMatchesSelector"in i.prototype?"oMatchesSelector":"msMatchesSelector",B.pEventTypes=B.supportsPointerEvent?O.PointerEvent===e.MSPointerEvent?{up:"MSPointerUp",down:"MSPointerDown",over:"mouseover",out:"mouseout",move:"MSPointerMove",cancel:"MSPointerCancel"}:{up:"pointerup",down:"pointerdown",over:"pointerover",out:"pointerout",move:"pointermove",cancel:"pointercancel"}:null,B.wheelEvent=O.document&&"onmousewheel"in O.document?"mousewheel":"wheel"},supportsTouch:null,supportsPointerEvent:null,isIOS7:null,isIOS:null,isIe9:null,isOperaMobile:null,prefixedMatchesSelector:null,pEventTypes:null,wheelEvent:null};function z(e,i){if(e.contains)return e.contains(i);for(;i;){if(i===e)return!0;i=i.parentNode}return!1}function k(e,i){for(;P(e);){if(H(e,i))return e;e=V(e)}return null}function V(e){var i=e.parentNode;if(w(i))for(;(i=i.host)&&w(i););return i}function H(e,i){return x!==y&&(i=i.replace(/\/deep\//g," ")),e[B.prefixedMatchesSelector](i)}var G=function(e){return e.parentNode||e.host};function W(e,i){for(var r,n=[],a=e;(r=G(a))&&a!==i&&r!==a.ownerDocument;)n.unshift(a),a=r;return n}function X(e,i,r){for(;P(e);){if(H(e,i))return!0;if((e=V(e))===r)return H(e,i)}return!1}function j(e){return e.correspondingUseElement||e}function q(e){var i=e instanceof O.SVGElement?e.getBoundingClientRect():e.getClientRects()[0];return i&&{left:i.left,right:i.right,top:i.top,bottom:i.bottom,width:i.width||i.right-i.left,height:i.height||i.bottom-i.top}}function Y(e){var i,r=q(e);if(!B.isIOS7&&r){var n={x:(i=(i=S(e))||x).scrollX||i.document.documentElement.scrollLeft,y:i.scrollY||i.document.documentElement.scrollTop};r.left+=n.x,r.right+=n.x,r.top+=n.y,r.bottom+=n.y}return r}function K(e){for(var i=[];e;)i.push(e),e=V(e);return i}function J(e){return!!C(e)&&(O.document.querySelector(e),!0)}function Z(e,i){for(var r in i)e[r]=i[r];return e}function Q(e,i,r){return"parent"===e?V(r):"self"===e?i.getRect(r):k(r,e)}function $(e,i,r,n){var a=e;return C(a)?a=Q(a,i,r):T(a)&&(a=a.apply(void 0,n)),P(a)&&(a=Y(a)),a}function ee(e){return e&&{x:"x"in e?e.x:e.left,y:"y"in e?e.y:e.top}}function et(e){return!e||"x"in e&&"y"in e||((e=Z({},e)).x=e.left||0,e.y=e.top||0,e.width=e.width||(e.right||0)-e.x,e.height=e.height||(e.bottom||0)-e.y),e}function ei(e,i,r){e.left&&(i.left+=r.x),e.right&&(i.right+=r.x),e.top&&(i.top+=r.y),e.bottom&&(i.bottom+=r.y),i.width=i.right-i.left,i.height=i.bottom-i.top}function er(e,i,r){var n=r&&e.options[r];return ee($(n&&n.origin||e.options.origin,e,i,[e&&i]))||{x:0,y:0}}function en(e,i){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(e){return!0},n=arguments.length>3?arguments[3]:void 0;if(n=n||{},C(e)&&-1!==e.search(" ")&&(e=ea(e)),L(e))return e.forEach(function(e){return en(e,i,r,n)}),n;if(b(e)&&(i=e,e=""),T(i)&&r(e))n[e]=n[e]||[],n[e].push(i);else if(L(i))for(var a=0,s=i;a<s.length;a++){var o=s[a];en(e,o,r,n)}else if(b(i))for(var l in i)en(ea(l).map(function(i){return"".concat(e).concat(i)}),i[l],r,n);return n}function ea(e){return e.trim().split(/ +/)}var es=function(e,i){return Math.sqrt(e*e+i*i)},eo=["webkit","moz"];function el(e,i){e.__set||(e.__set={});var r=function(r){if(eo.some(function(e){return 0===r.indexOf(e)}))return 1;"function"!=typeof e[r]&&"__set"!==r&&Object.defineProperty(e,r,{get:function(){return r in e.__set?e.__set[r]:e.__set[r]=i[r]},set:function(i){e.__set[r]=i},configurable:!0})};for(var n in i)r(n);return e}function ec(e,i){e.page=e.page||{},e.page.x=i.page.x,e.page.y=i.page.y,e.client=e.client||{},e.client.x=i.client.x,e.client.y=i.client.y,e.timeStamp=i.timeStamp}function eh(e){e.page.x=0,e.page.y=0,e.client.x=0,e.client.y=0}function eu(e){return e instanceof O.Event||e instanceof O.Touch}function ed(e,i,r){return e=e||"page",(r=r||{}).x=i[e+"X"],r.y=i[e+"Y"],r}function ep(e,i){return i=i||{x:0,y:0},B.isOperaMobile&&eu(e)?(ed("screen",e,i),i.x+=window.scrollX,i.y+=window.scrollY):ed("page",e,i),i}function ef(e){return A(e.pointerId)?e.pointerId:e.identifier}function em(e){var i=[];return L(e)?(i[0]=e[0],i[1]=e[1]):"touchend"===e.type?1===e.touches.length?(i[0]=e.touches[0],i[1]=e.changedTouches[0]):0===e.touches.length&&(i[0]=e.changedTouches[0],i[1]=e.changedTouches[1]):(i[0]=e.touches[0],i[1]=e.touches[1]),i}function eg(e){for(var i={pageX:0,pageY:0,clientX:0,clientY:0,screenX:0,screenY:0},r=0;r<e.length;r++){var n=e[r];for(var a in i)i[a]+=n[a]}for(var s in i)i[s]/=e.length;return i}function ev(e){if(!e.length)return null;var i=em(e),r=Math.min(i[0].pageX,i[1].pageX),n=Math.min(i[0].pageY,i[1].pageY),a=Math.max(i[0].pageX,i[1].pageX),s=Math.max(i[0].pageY,i[1].pageY);return{x:r,y:n,left:r,top:n,right:a,bottom:s,width:a-r,height:s-n}}function e_(e,i){var r=i+"X",n=i+"Y",a=em(e);return es(a[0][r]-a[1][r],a[0][n]-a[1][n])}function ey(e,i){var r=i+"X",n=i+"Y",a=em(e),s=a[1][r]-a[0][r];return 180*Math.atan2(a[1][n]-a[0][n],s)/Math.PI}function ex(e){return C(e.pointerType)?e.pointerType:A(e.pointerType)?[void 0,void 0,"touch","pen","mouse"][e.pointerType]:/touch/.test(e.type||"")||e instanceof O.Touch?"touch":"mouse"}function eM(e){var i=T(e.composedPath)?e.composedPath():e.path;return[j(i?i[0]:e.target),j(e.currentTarget)]}var eS=function(){function e(i){a(this,e),this.immediatePropagationStopped=!1,this.propagationStopped=!1,this._interaction=i}return o(e,[{key:"preventDefault",value:function(){}},{key:"stopPropagation",value:function(){this.propagationStopped=!0}},{key:"stopImmediatePropagation",value:function(){this.immediatePropagationStopped=this.propagationStopped=!0}}]),e}();Object.defineProperty(eS.prototype,"interaction",{get:function(){return this._interaction._proxy},set:function(){}});var eb=function(e,i){for(var r=0;r<i.length;r++){var n=i[r];e.push(n)}return e},eT=function(e){return eb([],e)},eE=function(e,i){for(var r=0;r<e.length;r++)if(i(e[r],r,e))return r;return -1},ew=function(e,i){return e[eE(e,i)]},eA=function(e){l(r,e);var i=d(r);function r(e,n,s){a(this,r),(o=i.call(this,n._interaction)).dropzone=void 0,o.dragEvent=void 0,o.relatedTarget=void 0,o.draggable=void 0,o.propagationStopped=!1,o.immediatePropagationStopped=!1;var o,l="dragleave"===s?e.prev:e.cur,c=l.element,h=l.dropzone;return o.type=s,o.target=c,o.currentTarget=c,o.dropzone=h,o.dragEvent=n,o.relatedTarget=n.target,o.draggable=n.interactable,o.timeStamp=n.timeStamp,o}return o(r,[{key:"reject",value:function(){var e=this,i=this._interaction.dropState;if("dropactivate"===this.type||this.dropzone&&i.cur.dropzone===this.dropzone&&i.cur.element===this.target)if(i.prev.dropzone=this.dropzone,i.prev.element=this.target,i.rejected=!0,i.events.enter=null,this.stopImmediatePropagation(),"dropactivate"===this.type){var n=eE(i.activeDrops,function(i){var r=i.dropzone,n=i.element;return r===e.dropzone&&n===e.target});i.activeDrops.splice(n,1);var a=new r(i,this.dragEvent,"dropdeactivate");a.dropzone=this.dropzone,a.target=this.target,this.dropzone.fire(a)}else this.dropzone.fire(new r(i,this.dragEvent,"dragleave"))}},{key:"preventDefault",value:function(){}},{key:"stopPropagation",value:function(){this.propagationStopped=!0}},{key:"stopImmediatePropagation",value:function(){this.immediatePropagationStopped=this.propagationStopped=!0}}]),r}(eS);function eR(e,i){for(var r=0,n=e.slice();r<n.length;r++){var a=n[r],s=a.dropzone,o=a.element;i.dropzone=s,i.target=o,s.fire(i),i.propagationStopped=i.immediatePropagationStopped=!1}}function eC(e,i){for(var r=function(e,i){for(var r=[],n=0,a=e.interactables.list;n<a.length;n++){var s=a[n];if(s.options.drop.enabled){var o=s.options.drop.accept;if(!(P(o)&&o!==i||C(o)&&!H(i,o)||T(o)&&!o({dropzone:s,draggableElement:i})))for(var l=0,c=s.getAllElements();l<c.length;l++){var h=c[l];h!==i&&r.push({dropzone:s,element:h,rect:s.getRect(h)})}}}return r}(e,i),n=0;n<r.length;n++){var a=r[n];a.rect=a.dropzone.getRect(a.element)}return r}function eP(e,i,r){for(var n=e.dropState,a=e.interactable,s=e.element,o=[],l=0,c=n.activeDrops;l<c.length;l++){var h=c[l],u=h.dropzone,d=h.element,p=h.rect,f=u.dropCheck(i,r,a,s,d,p);o.push(f?d:null)}var m=function(e){for(var i,r=[],n=0;n<e.length;n++){var a=e[n],s=e[i];if(a&&n!==i)if(s){var o=G(a),l=G(s);if(o!==a.ownerDocument)if(l!==a.ownerDocument)if(o!==l){r=r.length?r:W(s);var c=void 0;if(s instanceof O.HTMLElement&&a instanceof O.SVGElement&&!(a instanceof O.SVGSVGElement)){if(a===l)continue;c=a.ownerSVGElement}else c=a;for(var h=W(c,s.ownerDocument),u=0;h[u]&&h[u]===r[u];)u++;var d=[h[u-1],h[u],r[u]];if(d[0])for(var p=d[0].lastChild;p;){if(p===d[1]){i=n,r=h;break}if(p===d[2])break;p=p.previousSibling}}else(parseInt(S(a).getComputedStyle(a).zIndex,10)||0)>=(parseInt(S(s).getComputedStyle(s).zIndex,10)||0)&&(i=n);else i=n}else i=n}return i}(o);return n.activeDrops[m]||null}function eI(e,i,r){var n=e.dropState,a={enter:null,leave:null,activate:null,deactivate:null,move:null,drop:null};return"dragstart"===r.type&&(a.activate=new eA(n,r,"dropactivate"),a.activate.target=null,a.activate.dropzone=null),"dragend"===r.type&&(a.deactivate=new eA(n,r,"dropdeactivate"),a.deactivate.target=null,a.deactivate.dropzone=null),n.rejected||(n.cur.element!==n.prev.element&&(n.prev.dropzone&&(a.leave=new eA(n,r,"dragleave"),r.dragLeave=a.leave.target=n.prev.element,r.prevDropzone=a.leave.dropzone=n.prev.dropzone),n.cur.dropzone&&(a.enter=new eA(n,r,"dragenter"),r.dragEnter=n.cur.element,r.dropzone=n.cur.dropzone)),"dragend"===r.type&&n.cur.dropzone&&(a.drop=new eA(n,r,"drop"),r.dropzone=n.cur.dropzone,r.relatedTarget=n.cur.element),"dragmove"===r.type&&n.cur.dropzone&&(a.move=new eA(n,r,"dropmove"),r.dropzone=n.cur.dropzone)),a}function eL(e,i){var r=e.dropState,n=r.activeDrops,a=r.cur,s=r.prev;i.leave&&s.dropzone.fire(i.leave),i.enter&&a.dropzone.fire(i.enter),i.move&&a.dropzone.fire(i.move),i.drop&&a.dropzone.fire(i.drop),i.deactivate&&eR(n,i.deactivate),r.prev.dropzone=a.dropzone,r.prev.element=a.element}function eD(e,i){var r=e.interaction,n=e.iEvent,a=e.event;if("dragmove"===n.type||"dragend"===n.type){var s=r.dropState;i.dynamicDrop&&(s.activeDrops=eC(i,r.element));var o=eP(r,n,a);s.rejected=s.rejected&&!!o&&o.dropzone===s.cur.dropzone&&o.element===s.cur.element,s.cur.dropzone=o&&o.dropzone,s.cur.element=o&&o.element,s.events=eI(r,0,n)}}var eU={id:"actions/drop",install:function(e){var i=e.actions,r=e.interactStatic,n=e.Interactable,a=e.defaults;e.usePlugin(N),n.prototype.dropzone=function(e){return function(e,i){if(b(i)){if(e.options.drop.enabled=!1!==i.enabled,i.listeners){var r=en(i.listeners),n=Object.keys(r).reduce(function(e,i){return e[/^(enter|leave)/.test(i)?"drag".concat(i):/^(activate|deactivate|move)/.test(i)?"drop".concat(i):i]=r[i],e},{}),a=e.options.drop.listeners;a&&e.off(a),e.on(n),e.options.drop.listeners=n}return T(i.ondrop)&&e.on("drop",i.ondrop),T(i.ondropactivate)&&e.on("dropactivate",i.ondropactivate),T(i.ondropdeactivate)&&e.on("dropdeactivate",i.ondropdeactivate),T(i.ondragenter)&&e.on("dragenter",i.ondragenter),T(i.ondragleave)&&e.on("dragleave",i.ondragleave),T(i.ondropmove)&&e.on("dropmove",i.ondropmove),/^(pointer|center)$/.test(i.overlap)?e.options.drop.overlap=i.overlap:A(i.overlap)&&(e.options.drop.overlap=Math.max(Math.min(1,i.overlap),0)),"accept"in i&&(e.options.drop.accept=i.accept),"checker"in i&&(e.options.drop.checker=i.checker),e}return R(i)?(e.options.drop.enabled=i,e):e.options.drop}(this,e)},n.prototype.dropCheck=function(e,i,r,n,a,s){return function(e,i,r,n,a,s,o){var l=!1;if(!(o=o||e.getRect(s)))return!!e.options.drop.checker&&e.options.drop.checker(i,r,l,e,s,n,a);var c=e.options.drop.overlap;if("pointer"===c){var h=er(n,a,"drag"),u=ep(i);u.x+=h.x,u.y+=h.y;var d=u.x>o.left&&u.x<o.right,p=u.y>o.top&&u.y<o.bottom;l=d&&p}var f=n.getRect(a);if(f&&"center"===c){var m=f.left+f.width/2,g=f.top+f.height/2;l=m>=o.left&&m<=o.right&&g>=o.top&&g<=o.bottom}return f&&A(c)&&(l=Math.max(0,Math.min(o.right,f.right)-Math.max(o.left,f.left))*Math.max(0,Math.min(o.bottom,f.bottom)-Math.max(o.top,f.top))/(f.width*f.height)>=c),e.options.drop.checker&&(l=e.options.drop.checker(i,r,l,e,s,n,a)),l}(this,e,i,r,n,a,s)},r.dynamicDrop=function(i){return R(i)?(e.dynamicDrop=i,r):e.dynamicDrop},Z(i.phaselessTypes,{dragenter:!0,dragleave:!0,dropactivate:!0,dropdeactivate:!0,dropmove:!0,drop:!0}),i.methodDict.drop="dropzone",e.dynamicDrop=!1,a.actions.drop=eU.defaults},listeners:{"interactions:before-action-start":function(e){var i=e.interaction;"drag"===i.prepared.name&&(i.dropState={cur:{dropzone:null,element:null},prev:{dropzone:null,element:null},rejected:null,events:null,activeDrops:[]})},"interactions:after-action-start":function(e,i){var r=e.interaction,n=(e.event,e.iEvent);if("drag"===r.prepared.name){var a=r.dropState;a.activeDrops=[],a.events={},a.activeDrops=eC(i,r.element),a.events=eI(r,0,n),a.events.activate&&(eR(a.activeDrops,a.events.activate),i.fire("actions/drop:start",{interaction:r,dragEvent:n}))}},"interactions:action-move":eD,"interactions:after-action-move":function(e,i){var r=e.interaction,n=e.iEvent;if("drag"===r.prepared.name){var a=r.dropState;eL(r,a.events),i.fire("actions/drop:move",{interaction:r,dragEvent:n}),a.events={}}},"interactions:action-end":function(e,i){if("drag"===e.interaction.prepared.name){var r=e.interaction,n=e.iEvent;eD(e,i),eL(r,r.dropState.events),i.fire("actions/drop:end",{interaction:r,dragEvent:n})}},"interactions:stop":function(e){var i=e.interaction;if("drag"===i.prepared.name){var r=i.dropState;r&&(r.activeDrops=null,r.events=null,r.cur.dropzone=null,r.cur.element=null,r.prev.dropzone=null,r.prev.element=null,r.rejected=!1)}}},getActiveDrops:eC,getDrop:eP,getDropEvents:eI,fireDropEvents:eL,filterEventType:function(e){return 0===e.search("drag")||0===e.search("drop")},defaults:{enabled:!1,accept:null,overlap:"pointer"}};function eN(e){var i=e.interaction,r=e.iEvent,n=e.phase;if("gesture"===i.prepared.name){var a=i.pointers.map(function(e){return e.pointer}),s=i.interactable.options.deltaSource;if(r.touches=[a[0],a[1]],"start"===n)r.distance=e_(a,s),r.box=ev(a),r.scale=1,r.ds=0,r.angle=ey(a,s),r.da=0,i.gesture.startDistance=r.distance,i.gesture.startAngle=r.angle;else if("end"===n||i.pointers.length<2){var o=i.prevEvent;r.distance=o.distance,r.box=o.box,r.scale=o.scale,r.ds=0,r.angle=o.angle,r.da=0}else r.distance=e_(a,s),r.box=ev(a),r.scale=r.distance/i.gesture.startDistance,r.angle=ey(a,s),r.ds=r.scale-i.gesture.scale,r.da=r.angle-i.gesture.angle;i.gesture.distance=r.distance,i.gesture.angle=r.angle,A(r.scale)&&r.scale!==1/0&&!isNaN(r.scale)&&(i.gesture.scale=r.scale)}}var eO={id:"actions/gesture",before:["actions/drag","actions/resize"],install:function(e){var i=e.actions,r=e.Interactable,n=e.defaults;r.prototype.gesturable=function(e){return b(e)?(this.options.gesture.enabled=!1!==e.enabled,this.setPerAction("gesture",e),this.setOnEvents("gesture",e),this):R(e)?(this.options.gesture.enabled=e,this):this.options.gesture},i.map.gesture=eO,i.methodDict.gesture="gesturable",n.actions.gesture=eO.defaults},listeners:{"interactions:action-start":eN,"interactions:action-move":eN,"interactions:action-end":eN,"interactions:new":function(e){e.interaction.gesture={angle:0,distance:0,scale:1,startAngle:0,startDistance:0}},"auto-start:check":function(e){if(!(e.interaction.pointers.length<2)){var i=e.interactable.options.gesture;if(i&&i.enabled)return e.action={name:"gesture"},!1}}},defaults:{},getCursor:function(){return""},filterEventType:function(e){return 0===e.search("gesture")}};function eF(e){var i=e.iEvent,r=e.interaction;"resize"===r.prepared.name&&r.resizeAxes&&(r.interactable.options.resize.square?("y"===r.resizeAxes?i.delta.x=i.delta.y:i.delta.y=i.delta.x,i.axes="xy"):(i.axes=r.resizeAxes,"x"===r.resizeAxes?i.delta.y=0:"y"===r.resizeAxes&&(i.delta.x=0)))}var eB,ez,ek={id:"actions/resize",before:["actions/drag"],install:function(e){var i=e.actions,r=e.browser,n=e.Interactable,a=e.defaults;ek.cursors=r.isIe9?{x:"e-resize",y:"s-resize",xy:"se-resize",top:"n-resize",left:"w-resize",bottom:"s-resize",right:"e-resize",topleft:"se-resize",bottomright:"se-resize",topright:"ne-resize",bottomleft:"ne-resize"}:{x:"ew-resize",y:"ns-resize",xy:"nwse-resize",top:"ns-resize",left:"ew-resize",bottom:"ns-resize",right:"ew-resize",topleft:"nwse-resize",bottomright:"nwse-resize",topright:"nesw-resize",bottomleft:"nesw-resize"},ek.defaultMargin=r.supportsTouch||r.supportsPointerEvent?20:10,n.prototype.resizable=function(i){return b(i)?(this.options.resize.enabled=!1!==i.enabled,this.setPerAction("resize",i),this.setOnEvents("resize",i),C(i.axis)&&/^x$|^y$|^xy$/.test(i.axis)?this.options.resize.axis=i.axis:null===i.axis&&(this.options.resize.axis=e.defaults.actions.resize.axis),R(i.preserveAspectRatio)?this.options.resize.preserveAspectRatio=i.preserveAspectRatio:R(i.square)&&(this.options.resize.square=i.square),this):R(i)?(this.options.resize.enabled=i,this):this.options.resize},i.map.resize=ek,i.methodDict.resize="resizable",a.actions.resize=ek.defaults},listeners:{"interactions:new":function(e){e.interaction.resizeAxes="xy"},"interactions:action-start":function(e){!function(e){var i=e.iEvent,r=e.interaction;if("resize"===r.prepared.name&&r.prepared.edges){var n=r.rect;r._rects={start:Z({},n),corrected:Z({},n),previous:Z({},n),delta:{left:0,right:0,width:0,top:0,bottom:0,height:0}},i.edges=r.prepared.edges,i.rect=r._rects.corrected,i.deltaRect=r._rects.delta}}(e),eF(e)},"interactions:action-move":function(e){!function(e){var i=e.iEvent,r=e.interaction;if("resize"===r.prepared.name&&r.prepared.edges){var n=r.interactable.options.resize.invert,a=r.rect,s=r._rects,o=s.start,l=s.corrected,c=s.delta,h=s.previous;if(Z(h,l),"reposition"===n||"negate"===n){if(Z(l,a),"reposition"===n){if(l.top>l.bottom){var u=l.top;l.top=l.bottom,l.bottom=u}if(l.left>l.right){var d=l.left;l.left=l.right,l.right=d}}}else l.top=Math.min(a.top,o.bottom),l.bottom=Math.max(a.bottom,o.top),l.left=Math.min(a.left,o.right),l.right=Math.max(a.right,o.left);for(var p in l.width=l.right-l.left,l.height=l.bottom-l.top,l)c[p]=l[p]-h[p];i.edges=r.prepared.edges,i.rect=l,i.deltaRect=c}}(e),eF(e)},"interactions:action-end":function(e){var i=e.iEvent,r=e.interaction;"resize"===r.prepared.name&&r.prepared.edges&&(i.edges=r.prepared.edges,i.rect=r._rects.corrected,i.deltaRect=r._rects.delta)},"auto-start:check":function(e){var i=e.interaction,r=e.interactable,n=e.element,a=e.rect,s=e.buttons;if(a){var o=Z({},i.coords.cur.page),l=r.options.resize;if(l&&l.enabled&&(!i.pointerIsDown||!/mouse|pointer/.test(i.pointerType)||0!=(s&l.mouseButtons))){if(b(l.edges)){var c={left:!1,right:!1,top:!1,bottom:!1};for(var h in c)c[h]=function(e,i,r,n,a,s,o){if(!i)return!1;if(!0===i){var l=A(s.width)?s.width:s.right-s.left,c=A(s.height)?s.height:s.bottom-s.top;if(o=Math.min(o,Math.abs(("left"===e||"right"===e?l:c)/2)),l<0&&("left"===e?e="right":"right"===e&&(e="left")),c<0&&("top"===e?e="bottom":"bottom"===e&&(e="top")),"left"===e){var h=l>=0?s.left:s.right;return r.x<h+o}if("top"===e){var u=c>=0?s.top:s.bottom;return r.y<u+o}if("right"===e)return r.x>(l>=0?s.right:s.left)-o;if("bottom"===e)return r.y>(c>=0?s.bottom:s.top)-o}return!!P(n)&&(P(i)?i===n:X(n,i,a))}(h,l.edges[h],o,i._latestPointer.eventTarget,n,a,l.margin||ek.defaultMargin);c.left=c.left&&!c.right,c.top=c.top&&!c.bottom,(c.left||c.right||c.top||c.bottom)&&(e.action={name:"resize",edges:c})}else{var u="y"!==l.axis&&o.x>a.right-ek.defaultMargin,d="x"!==l.axis&&o.y>a.bottom-ek.defaultMargin;(u||d)&&(e.action={name:"resize",axes:(u?"x":"")+(d?"y":"")})}return!e.action&&void 0}}}},defaults:{square:!1,preserveAspectRatio:!1,axis:"xy",margin:NaN,edges:null,invert:"none"},cursors:null,getCursor:function(e){var i=e.edges,r=e.axis,n=e.name,a=ek.cursors,s=null;if(r)s=a[n+r];else if(i){for(var o="",l=0,c=["top","bottom","left","right"];l<c.length;l++){var h=c[l];i[h]&&(o+=h)}s=a[o]}return s},filterEventType:function(e){return 0===e.search("resize")},defaultMargin:null},eV=0,eH=function(e){return eB(e)},eG=function(e){return ez(e)},eW=function(e){if(eB=e.requestAnimationFrame,ez=e.cancelAnimationFrame,!eB)for(var i=["ms","moz","webkit","o"],r=0;r<i.length;r++){var n=i[r];eB=e["".concat(n,"RequestAnimationFrame")],ez=e["".concat(n,"CancelAnimationFrame")]||e["".concat(n,"CancelRequestAnimationFrame")]}eB=eB&&eB.bind(e),ez=ez&&ez.bind(e),eB||(eB=function(i){var r=Date.now(),n=Math.max(0,16-(r-eV)),a=e.setTimeout(function(){i(r+n)},n);return eV=r+n,a},ez=function(e){return clearTimeout(e)})},eX={defaults:{enabled:!1,margin:60,container:null,speed:300},now:Date.now,interaction:null,i:0,x:0,y:0,isScrolling:!1,prevTime:0,margin:0,speed:0,start:function(e){eX.isScrolling=!0,eG(eX.i),e.autoScroll=eX,eX.interaction=e,eX.prevTime=eX.now(),eX.i=eH(eX.scroll)},stop:function(){eX.isScrolling=!1,eX.interaction&&(eX.interaction.autoScroll=null),eG(eX.i)},scroll:function(){var e=eX.interaction,i=e.interactable,r=e.element,n=e.prepared.name,a=i.options[n].autoScroll,s=ej(a.container,i,r),o=eX.now(),l=(o-eX.prevTime)/1e3,c=a.speed*l;if(c>=1){var h={x:eX.x*c,y:eX.y*c};if(h.x||h.y){var u=eq(s);E(s)?s.scrollBy(h.x,h.y):s&&(s.scrollLeft+=h.x,s.scrollTop+=h.y);var d=eq(s),p={x:d.x-u.x,y:d.y-u.y};(p.x||p.y)&&i.fire({type:"autoscroll",target:r,interactable:i,delta:p,interaction:e,container:s})}eX.prevTime=o}eX.isScrolling&&(eG(eX.i),eX.i=eH(eX.scroll))},check:function(e,i){var r;return null==(r=e.options[i].autoScroll)?void 0:r.enabled},onInteractionMove:function(e){var i=e.interaction,r=e.pointer;if(i.interacting()&&eX.check(i.interactable,i.prepared.name))if(i.simulation)eX.x=eX.y=0;else{var n,a,s,o,l=i.interactable,c=i.element,h=i.prepared.name,u=l.options[h].autoScroll,d=ej(u.container,l,c);if(E(d))o=r.clientX<eX.margin,n=r.clientY<eX.margin,a=r.clientX>d.innerWidth-eX.margin,s=r.clientY>d.innerHeight-eX.margin;else{var p=q(d);o=r.clientX<p.left+eX.margin,n=r.clientY<p.top+eX.margin,a=r.clientX>p.right-eX.margin,s=r.clientY>p.bottom-eX.margin}eX.x=a?1:o?-1:0,eX.y=s?1:n?-1:0,eX.isScrolling||(eX.margin=u.margin,eX.speed=u.speed,eX.start(i))}}};function ej(e,i,r){return(C(e)?Q(e,i,r):e)||S(r)}function eq(e){return E(e)&&(e=window.document.body),{x:e.scrollLeft,y:e.scrollTop}}var eY={id:"auto-scroll",install:function(e){var i=e.defaults,r=e.actions;e.autoScroll=eX,eX.now=function(){return e.now()},r.phaselessTypes.autoscroll=!0,i.perAction.autoScroll=eX.defaults},listeners:{"interactions:new":function(e){e.interaction.autoScroll=null},"interactions:destroy":function(e){e.interaction.autoScroll=null,eX.stop(),eX.interaction&&(eX.interaction=null)},"interactions:stop":eX.stop,"interactions:action-move":function(e){return eX.onInteractionMove(e)}}};function eK(e,i){var r=!1;return function(){return r||(x.console.warn(i),r=!0),e.apply(this,arguments)}}function eJ(e,i){return e.name=i.name,e.axis=i.axis,e.edges=i.edges,e}function eZ(e){return R(e)?(this.options.styleCursor=e,this):null===e?(delete this.options.styleCursor,this):this.options.styleCursor}function eQ(e){return T(e)?(this.options.actionChecker=e,this):null===e?(delete this.options.actionChecker,this):this.options.actionChecker}var e$={id:"auto-start/interactableMethods",install:function(e){var i=e.Interactable;i.prototype.getAction=function(i,r,n,a){var s,o,l=(s=this.getRect(a),o={action:null,interactable:this,interaction:n,element:a,rect:s,buttons:r.buttons||({0:1,1:4,3:8,4:16})[r.button]},e.fire("auto-start:check",o),o.action);return this.options.actionChecker?this.options.actionChecker(i,r,l,this,a,n):l},i.prototype.ignoreFrom=eK(function(e){return this._backCompatOption("ignoreFrom",e)},"Interactable.ignoreFrom() has been deprecated. Use Interactble.draggable({ignoreFrom: newValue})."),i.prototype.allowFrom=eK(function(e){return this._backCompatOption("allowFrom",e)},"Interactable.allowFrom() has been deprecated. Use Interactble.draggable({allowFrom: newValue})."),i.prototype.actionChecker=eQ,i.prototype.styleCursor=eZ}};function e0(e,i,r,n,a){return i.testIgnoreAllow(i.options[e.name],r,n)&&i.options[e.name].enabled&&e2(i,r,e,a)?e:null}function e1(e,i,r,n,a){var s=[],o=[],l=n;function c(e){s.push(e),o.push(l)}for(;P(l);){s=[],o=[],a.interactables.forEachMatch(l,c);var h=function(e,i,r,n,a,s,o){for(var l=0,c=n.length;l<c;l++){var h=n[l],u=a[l],d=h.getAction(i,r,e,u);if(d){var p=e0(d,h,u,s,o);if(p)return{action:p,interactable:h,element:u}}}return{action:null,interactable:null,element:null}}(e,i,r,s,o,n,a);if(h.action&&!h.interactable.options[h.action.name].manualStart)return h;l=V(l)}return{action:null,interactable:null,element:null}}function e3(e,i,r){var n=i.action,a=i.interactable,s=i.element;n=n||{name:null},e.interactable=a,e.element=s,eJ(e.prepared,n),e.rect=a&&n.name?a.getRect(s):null,e6(e,r),r.fire("autoStart:prepared",{interaction:e})}function e2(e,i,r,n){var a=e.options,s=a[r.name].max,o=a[r.name].maxPerElement,l=n.autoStart.maxInteractions,c=0,h=0,u=0;if(!(s&&o&&l))return!1;for(var d=0,p=n.interactions.list;d<p.length;d++){var f=p[d],m=f.prepared.name;if(f.interacting()&&(++c>=l||f.interactable===e&&((h+=+(m===r.name))>=s||f.element===i&&(u++,m===r.name&&u>=o))))return!1}return l>0}function e4(e,i){return A(e)?(i.autoStart.maxInteractions=e,this):i.autoStart.maxInteractions}function e5(e,i,r){var n=r.autoStart.cursorElement;n&&n!==e&&(n.style.cursor=""),e.ownerDocument.documentElement.style.cursor=i,e.style.cursor=i,r.autoStart.cursorElement=i?e:null}function e6(e,i){var r=e.interactable,n=e.element,a=e.prepared;if("mouse"===e.pointerType&&r&&r.options.styleCursor){var s="";if(a.name){var o=r.options[a.name].cursorChecker;s=T(o)?o(a,r,n,e._interacting):i.actions.map[a.name].getCursor(a)}e5(e.element,s||"",i)}else i.autoStart.cursorElement&&e5(i.autoStart.cursorElement,"",i)}var e8={id:"auto-start/base",before:["actions"],install:function(e){var i=e.interactStatic,r=e.defaults;e.usePlugin(e$),r.base.actionChecker=null,r.base.styleCursor=!0,Z(r.perAction,{manualStart:!1,max:1/0,maxPerElement:1,allowFrom:null,ignoreFrom:null,mouseButtons:1}),i.maxInteractions=function(i){return e4(i,e)},e.autoStart={maxInteractions:1/0,withinInteractionLimit:e2,cursorElement:null}},listeners:{"interactions:down":function(e,i){var r=e.interaction,n=e.pointer,a=e.event,s=e.eventTarget;r.interacting()||e3(r,e1(r,n,a,s,i),i)},"interactions:move":function(e,i){var r,n,a,s;r=e.interaction,n=e.pointer,a=e.event,s=e.eventTarget,"mouse"!==r.pointerType||r.pointerIsDown||r.interacting()||e3(r,e1(r,n,a,s,i),i),function(e,i){var r=e.interaction;if(r.pointerIsDown&&!r.interacting()&&r.pointerWasMoved&&r.prepared.name){i.fire("autoStart:before-start",e);var n=r.interactable,a=r.prepared.name;a&&n&&(n.options[a].manualStart||!e2(n,r.element,r.prepared,i)?r.stop():(r.start(r.prepared,n,r.element),e6(r,i)))}}(e,i)},"interactions:stop":function(e,i){var r=e.interaction,n=r.interactable;n&&n.options.styleCursor&&e5(r.element,"",i)}},maxInteractions:e4,withinInteractionLimit:e2,validateAction:e0},e9={id:"auto-start/dragAxis",listeners:{"autoStart:before-start":function(e,i){var r=e.interaction,n=e.eventTarget,a=e.dx,s=e.dy;if("drag"===r.prepared.name){var o=Math.abs(a),l=Math.abs(s),c=r.interactable.options.drag,h=c.startAxis,u=o>l?"x":o<l?"y":"xy";if(r.prepared.axis="start"===c.lockAxis?u[0]:c.lockAxis,"xy"!==u&&"xy"!==h&&h!==u){r.prepared.name=null;for(var d=n,p=function(e){if(e!==r.interactable){var a=r.interactable.options.drag;if(!a.manualStart&&e.testIgnoreAllow(a,d,n)){var s=e.getAction(r.downPointer,r.downEvent,r,d);if(s&&"drag"===s.name&&function(e,i){if(!i)return!1;var r=i.options.drag.startAxis;return"xy"===e||"xy"===r||r===e}(u,e)&&e8.validateAction(s,e,d,n,i))return e}}};P(d);){var f=i.interactables.forEachMatch(d,p);if(f){r.prepared.name="drag",r.interactable=f,r.element=d;break}d=V(d)}}}}}};function e7(e){var i=e.prepared&&e.prepared.name;if(!i)return null;var r=e.interactable.options;return r[i].hold||r[i].delay}var te={id:"auto-start/hold",install:function(e){var i=e.defaults;e.usePlugin(e8),i.perAction.hold=0,i.perAction.delay=0},listeners:{"interactions:new":function(e){e.interaction.autoStartHoldTimer=null},"autoStart:prepared":function(e){var i=e.interaction,r=e7(i);r>0&&(i.autoStartHoldTimer=setTimeout(function(){i.start(i.prepared,i.interactable,i.element)},r))},"interactions:move":function(e){var i=e.interaction,r=e.duplicate;i.autoStartHoldTimer&&i.pointerWasMoved&&!r&&(clearTimeout(i.autoStartHoldTimer),i.autoStartHoldTimer=null)},"autoStart:before-start":function(e){var i=e.interaction;e7(i)>0&&(i.prepared.name=null)}},getHoldDuration:e7},tt=function(e){return/^(always|never|auto)$/.test(e)?(this.options.preventDefault=e,this):R(e)?(this.options.preventDefault=e?"always":"never",this):this.options.preventDefault};function ti(e){var i=e.interaction,r=e.event;i.interactable&&i.interactable.checkAndPreventDefault(r)}var tr={id:"core/interactablePreventDefault",install:function(e){var i=e.Interactable;i.prototype.preventDefault=tt,i.prototype.checkAndPreventDefault=function(i){return function(e,i,r){var n=e.options.preventDefault;if("never"!==n)if("always"!==n){if(i.events.supportsPassive&&/^touch(start|move)$/.test(r.type)){var a=S(r.target).document,s=i.getDocOptions(a);if(!s||!s.events||!1!==s.events.passive)return}/^(mouse|pointer|touch)*(down|start)/i.test(r.type)||P(r.target)&&H(r.target,"input,select,textarea,[contenteditable=true],[contenteditable=true] *")||r.preventDefault()}else r.preventDefault()}(this,e,i)},e.interactions.docEvents.push({type:"dragstart",listener:function(i){for(var r=0,n=e.interactions.list;r<n.length;r++){var a=n[r];if(a.element&&(a.element===i.target||z(a.element,i.target)))return void a.interactable.checkAndPreventDefault(i)}}})},listeners:["down","move","up","cancel"].reduce(function(e,i){return e["interactions:".concat(i)]=ti,e},{})};function tn(e,i){if(i.phaselessTypes[e])return!0;for(var r in i.map)if(0===e.indexOf(r)&&e.substr(r.length)in i.phases)return!0;return!1}function ta(e){var i={};for(var r in e){var n=e[r];I(n)?i[r]=ta(n):L(n)?i[r]=eT(n):i[r]=n}return i}var ts=function(){function e(i){a(this,e),this.states=[],this.startOffset={left:0,right:0,top:0,bottom:0},this.startDelta=void 0,this.result=void 0,this.endResult=void 0,this.startEdges=void 0,this.edges=void 0,this.interaction=void 0,this.interaction=i,this.result=to(),this.edges={left:!1,right:!1,top:!1,bottom:!1}}return o(e,[{key:"start",value:function(e,i){var r,n,a,s=e.phase,o=this.interaction,l=(n=(r=o.interactable.options[o.prepared.name]).modifiers)&&n.length?n:["snap","snapSize","snapEdges","restrict","restrictEdges","restrictSize"].map(function(e){var i=r[e];return i&&i.enabled&&{options:i,methods:i._methods}}).filter(function(e){return!!e});this.prepareStates(l),this.startEdges=Z({},o.edges),this.edges=Z({},this.startEdges),this.startOffset=(a=o.rect)?{left:i.x-a.left,top:i.y-a.top,right:a.right-i.x,bottom:a.bottom-i.y}:{left:0,top:0,right:0,bottom:0},this.startDelta={x:0,y:0};var c=this.fillArg({phase:s,pageCoords:i,preEnd:!1});return this.result=to(),this.startAll(c),this.result=this.setAll(c)}},{key:"fillArg",value:function(e){var i=this.interaction;return e.interaction=i,e.interactable=i.interactable,e.element=i.element,e.rect||(e.rect=i.rect),e.edges||(e.edges=this.startEdges),e.startOffset=this.startOffset,e}},{key:"startAll",value:function(e){for(var i=0,r=this.states;i<r.length;i++){var n=r[i];n.methods.start&&(e.state=n,n.methods.start(e))}}},{key:"setAll",value:function(e){var i=e.phase,r=e.preEnd,n=e.skipModifiers,a=e.rect,s=e.edges;e.coords=Z({},e.pageCoords),e.rect=Z({},a),e.edges=Z({},s);for(var o=n?this.states.slice(n):this.states,l=to(e.coords,e.rect),c=0;c<o.length;c++){var h,u=o[c],d=u.options,p=Z({},e.coords),f=null;null!=(h=u.methods)&&h.set&&this.shouldDo(d,r,i)&&(e.state=u,f=u.methods.set(e),ei(e.edges,e.rect,{x:e.coords.x-p.x,y:e.coords.y-p.y})),l.eventProps.push(f)}Z(this.edges,e.edges),l.delta.x=e.coords.x-e.pageCoords.x,l.delta.y=e.coords.y-e.pageCoords.y,l.rectDelta.left=e.rect.left-a.left,l.rectDelta.right=e.rect.right-a.right,l.rectDelta.top=e.rect.top-a.top,l.rectDelta.bottom=e.rect.bottom-a.bottom;var m=this.result.coords,g=this.result.rect;if(m&&g){var v=l.rect.left!==g.left||l.rect.right!==g.right||l.rect.top!==g.top||l.rect.bottom!==g.bottom;l.changed=v||m.x!==l.coords.x||m.y!==l.coords.y}return l}},{key:"applyToInteraction",value:function(e){var i=this.interaction,r=e.phase,n=i.coords.cur,a=i.coords.start,s=this.result,o=this.startDelta,l=s.delta;"start"===r&&Z(this.startDelta,s.delta);for(var c=0,h=[[a,o],[n,l]];c<h.length;c++){var u=h[c],d=u[0],p=u[1];d.page.x+=p.x,d.page.y+=p.y,d.client.x+=p.x,d.client.y+=p.y}var f=this.result.rectDelta,m=e.rect||i.rect;m.left+=f.left,m.right+=f.right,m.top+=f.top,m.bottom+=f.bottom,m.width=m.right-m.left,m.height=m.bottom-m.top}},{key:"setAndApply",value:function(e){var i=this.interaction,r=e.phase,n=e.preEnd,a=e.skipModifiers,s=this.setAll(this.fillArg({preEnd:n,phase:r,pageCoords:e.modifiedCoords||i.coords.cur.page}));if(this.result=s,!s.changed&&(!a||a<this.states.length)&&i.interacting())return!1;if(e.modifiedCoords){var o=i.coords.cur.page,l={x:e.modifiedCoords.x-o.x,y:e.modifiedCoords.y-o.y};s.coords.x+=l.x,s.coords.y+=l.y,s.delta.x+=l.x,s.delta.y+=l.y}this.applyToInteraction(e)}},{key:"beforeEnd",value:function(e){var i=e.interaction,r=e.event,n=this.states;if(n&&n.length){for(var a=!1,s=0;s<n.length;s++){var o=n[s];e.state=o;var l=o.options,c=o.methods,h=c.beforeEnd&&c.beforeEnd(e);if(h)return this.endResult=h,!1;a=a||!a&&this.shouldDo(l,!0,e.phase,!0)}a&&i.move({event:r,preEnd:!0})}}},{key:"stop",value:function(e){var i=e.interaction;if(this.states&&this.states.length){var r=Z({states:this.states,interactable:i.interactable,element:i.element,rect:null},e);this.fillArg(r);for(var n=0,a=this.states;n<a.length;n++){var s=a[n];r.state=s,s.methods.stop&&s.methods.stop(r)}this.states=null,this.endResult=null}}},{key:"prepareStates",value:function(e){this.states=[];for(var i=0;i<e.length;i++){var r=e[i],n=r.options,a=r.methods,s=r.name;this.states.push({options:n,methods:a,index:i,name:s})}return this.states}},{key:"restoreInteractionCoords",value:function(e){var i=e.interaction,r=i.coords,n=i.rect,a=i.modification;if(a.result){for(var s=a.startDelta,o=a.result,l=o.delta,c=o.rectDelta,h=0,u=[[r.start,s],[r.cur,l]];h<u.length;h++){var d=u[h],p=d[0],f=d[1];p.page.x-=f.x,p.page.y-=f.y,p.client.x-=f.x,p.client.y-=f.y}n.left-=c.left,n.right-=c.right,n.top-=c.top,n.bottom-=c.bottom}}},{key:"shouldDo",value:function(e,i,r,n){return!(!e||!1===e.enabled||n&&!e.endOnly||e.endOnly&&!i||"start"===r&&!e.setStart)}},{key:"copyFrom",value:function(e){this.startOffset=e.startOffset,this.startDelta=e.startDelta,this.startEdges=e.startEdges,this.edges=e.edges,this.states=e.states.map(function(e){return ta(e)}),this.result=to(Z({},e.result.coords),Z({},e.result.rect))}},{key:"destroy",value:function(){for(var e in this)this[e]=null}}]),e}();function to(e,i){return{rect:i,coords:e,delta:{x:0,y:0},rectDelta:{left:0,right:0,top:0,bottom:0},eventProps:[],changed:!0}}function tl(e,i){var r=e.defaults,n={start:e.start,set:e.set,beforeEnd:e.beforeEnd,stop:e.stop},a=function(e){var a=e||{};for(var s in a.enabled=!1!==a.enabled,r)s in a||(a[s]=r[s]);var o={options:a,methods:n,name:i,enable:function(){return a.enabled=!0,o},disable:function(){return a.enabled=!1,o}};return o};return i&&"string"==typeof i&&(a._defaults=r,a._methods=n),a}function tc(e){var i=e.iEvent,r=e.interaction.modification.result;r&&(i.modifiers=r.eventProps)}var th={id:"modifiers/base",before:["actions"],install:function(e){e.defaults.perAction.modifiers=[]},listeners:{"interactions:new":function(e){var i=e.interaction;i.modification=new ts(i)},"interactions:before-action-start":function(e){var i=e.interaction,r=e.interaction.modification;r.start(e,i.coords.start.page),i.edges=r.edges,r.applyToInteraction(e)},"interactions:before-action-move":function(e){var i=e.interaction,r=i.modification,n=r.setAndApply(e);return i.edges=r.edges,n},"interactions:before-action-end":function(e){var i=e.interaction,r=i.modification,n=r.beforeEnd(e);return i.edges=r.startEdges,n},"interactions:action-start":tc,"interactions:action-move":tc,"interactions:action-end":tc,"interactions:after-action-start":function(e){return e.interaction.modification.restoreInteractionCoords(e)},"interactions:after-action-move":function(e){return e.interaction.modification.restoreInteractionCoords(e)},"interactions:stop":function(e){return e.interaction.modification.stop(e)}}},tu={base:{preventDefault:"auto",deltaSource:"page"},perAction:{enabled:!1,origin:{x:0,y:0}},actions:{}},td=function(e){l(r,e);var i=d(r);function r(e,n,s,o,l,c,h){a(this,r),(d=i.call(this,e)).relatedTarget=null,d.screenX=void 0,d.screenY=void 0,d.button=void 0,d.buttons=void 0,d.ctrlKey=void 0,d.shiftKey=void 0,d.altKey=void 0,d.metaKey=void 0,d.page=void 0,d.client=void 0,d.delta=void 0,d.rect=void 0,d.x0=void 0,d.y0=void 0,d.t0=void 0,d.dt=void 0,d.duration=void 0,d.clientX0=void 0,d.clientY0=void 0,d.velocity=void 0,d.speed=void 0,d.swipe=void 0,d.axes=void 0,d.preEnd=void 0,l=l||e.element;var d,p=e.interactable,f=(p&&p.options||tu).deltaSource,m=er(p,l,s),g="start"===o,v="end"===o,_=g?u(d):e.prevEvent,y=g?e.coords.start:v?{page:_.page,client:_.client,timeStamp:e.coords.cur.timeStamp}:e.coords.cur;return d.page=Z({},y.page),d.client=Z({},y.client),d.rect=Z({},e.rect),d.timeStamp=y.timeStamp,v||(d.page.x-=m.x,d.page.y-=m.y,d.client.x-=m.x,d.client.y-=m.y),d.ctrlKey=n.ctrlKey,d.altKey=n.altKey,d.shiftKey=n.shiftKey,d.metaKey=n.metaKey,d.button=n.button,d.buttons=n.buttons,d.target=l,d.currentTarget=l,d.preEnd=c,d.type=h||s+(o||""),d.interactable=p,d.t0=g?e.pointers[e.pointers.length-1].downTime:_.t0,d.x0=e.coords.start.page.x-m.x,d.y0=e.coords.start.page.y-m.y,d.clientX0=e.coords.start.client.x-m.x,d.clientY0=e.coords.start.client.y-m.y,d.delta=g||v?{x:0,y:0}:{x:d[f].x-_[f].x,y:d[f].y-_[f].y},d.dt=e.coords.delta.timeStamp,d.duration=d.timeStamp-d.t0,d.velocity=Z({},e.coords.velocity[f]),d.speed=es(d.velocity.x,d.velocity.y),d.swipe=v||"inertiastart"===o?d.getSwipe():null,d}return o(r,[{key:"getSwipe",value:function(){var e=this._interaction;if(e.prevEvent.speed<600||this.timeStamp-e.prevEvent.timeStamp>150)return null;var i=180*Math.atan2(e.prevEvent.velocityY,e.prevEvent.velocityX)/Math.PI;i<0&&(i+=360);var r=112.5<=i&&i<247.5,n=202.5<=i&&i<337.5;return{up:n,down:!n&&22.5<=i&&i<157.5,left:r,right:!r&&(292.5<=i||i<67.5),angle:i,speed:e.prevEvent.speed,velocity:{x:e.prevEvent.velocityX,y:e.prevEvent.velocityY}}}},{key:"preventDefault",value:function(){}},{key:"stopImmediatePropagation",value:function(){this.immediatePropagationStopped=this.propagationStopped=!0}},{key:"stopPropagation",value:function(){this.propagationStopped=!0}}]),r}(eS);Object.defineProperties(td.prototype,{pageX:{get:function(){return this.page.x},set:function(e){this.page.x=e}},pageY:{get:function(){return this.page.y},set:function(e){this.page.y=e}},clientX:{get:function(){return this.client.x},set:function(e){this.client.x=e}},clientY:{get:function(){return this.client.y},set:function(e){this.client.y=e}},dx:{get:function(){return this.delta.x},set:function(e){this.delta.x=e}},dy:{get:function(){return this.delta.y},set:function(e){this.delta.y=e}},velocityX:{get:function(){return this.velocity.x},set:function(e){this.velocity.x=e}},velocityY:{get:function(){return this.velocity.y},set:function(e){this.velocity.y=e}}});var tp=o(function e(i,r,n,s,o){a(this,e),this.id=void 0,this.pointer=void 0,this.event=void 0,this.downTime=void 0,this.downTarget=void 0,this.id=i,this.pointer=r,this.event=n,this.downTime=s,this.downTarget=o}),tf=((m={}).interactable="",m.element="",m.prepared="",m.pointerIsDown="",m.pointerWasMoved="",m._proxy="",m),tm=((g={}).start="",g.move="",g.end="",g.stop="",g.interacting="",g),tg=0,tv=function(){function e(i){var r=this,n=i.pointerType,s=i.scopeFire;a(this,e),this.interactable=null,this.element=null,this.rect=null,this._rects=void 0,this.edges=null,this._scopeFire=void 0,this.prepared={name:null,axis:null,edges:null},this.pointerType=void 0,this.pointers=[],this.downEvent=null,this.downPointer={},this._latestPointer={pointer:null,event:null,eventTarget:null},this.prevEvent=null,this.pointerIsDown=!1,this.pointerWasMoved=!1,this._interacting=!1,this._ending=!1,this._stopped=!0,this._proxy=void 0,this.simulation=null,this.doMove=eK(function(e){this.move(e)},"The interaction.doMove() method has been renamed to interaction.move()"),this.coords={start:{page:{x:0,y:0},client:{x:0,y:0},timeStamp:0},prev:{page:{x:0,y:0},client:{x:0,y:0},timeStamp:0},cur:{page:{x:0,y:0},client:{x:0,y:0},timeStamp:0},delta:{page:{x:0,y:0},client:{x:0,y:0},timeStamp:0},velocity:{page:{x:0,y:0},client:{x:0,y:0},timeStamp:0}},this._id=tg++,this._scopeFire=s,this.pointerType=n;var o=this;this._proxy={};var l=function(e){Object.defineProperty(r._proxy,e,{get:function(){return o[e]}})};for(var c in tf)l(c);var h=function(e){Object.defineProperty(r._proxy,e,{value:function(){return o[e].apply(o,arguments)}})};for(var u in tm)h(u);this._scopeFire("interactions:new",{interaction:this})}return o(e,[{key:"pointerMoveTolerance",get:function(){return 1}},{key:"pointerDown",value:function(e,i,r){var n=this.updatePointer(e,i,r,!0),a=this.pointers[n];this._scopeFire("interactions:down",{pointer:e,event:i,eventTarget:r,pointerIndex:n,pointerInfo:a,type:"down",interaction:this})}},{key:"start",value:function(e,i,r){return!(this.interacting()||!this.pointerIsDown||this.pointers.length<("gesture"===e.name?2:1)||!i.options[e.name].enabled)&&(eJ(this.prepared,e),this.interactable=i,this.element=r,this.rect=i.getRect(r),this.edges=this.prepared.edges?Z({},this.prepared.edges):{left:!0,right:!0,top:!0,bottom:!0},this._stopped=!1,this._interacting=this._doPhase({interaction:this,event:this.downEvent,phase:"start"})&&!this._stopped,this._interacting)}},{key:"pointerMove",value:function(e,i,r){this.simulation||this.modification&&this.modification.endResult||this.updatePointer(e,i,r,!1);var n,a,s=this.coords.cur.page.x===this.coords.prev.page.x&&this.coords.cur.page.y===this.coords.prev.page.y&&this.coords.cur.client.x===this.coords.prev.client.x&&this.coords.cur.client.y===this.coords.prev.client.y;this.pointerIsDown&&!this.pointerWasMoved&&(n=this.coords.cur.client.x-this.coords.start.client.x,a=this.coords.cur.client.y-this.coords.start.client.y,this.pointerWasMoved=es(n,a)>this.pointerMoveTolerance);var o,l,c,h=this.getPointerIndex(e),u={pointer:e,pointerIndex:h,pointerInfo:this.pointers[h],event:i,type:"move",eventTarget:r,dx:n,dy:a,duplicate:s,interaction:this};s||(o=this.coords.velocity,c=Math.max((l=this.coords.delta).timeStamp/1e3,.001),o.page.x=l.page.x/c,o.page.y=l.page.y/c,o.client.x=l.client.x/c,o.client.y=l.client.y/c,o.timeStamp=c),this._scopeFire("interactions:move",u),s||this.simulation||(this.interacting()&&(u.type=null,this.move(u)),this.pointerWasMoved&&ec(this.coords.prev,this.coords.cur))}},{key:"move",value:function(e){e&&e.event||eh(this.coords.delta),(e=Z({pointer:this._latestPointer.pointer,event:this._latestPointer.event,eventTarget:this._latestPointer.eventTarget,interaction:this},e||{})).phase="move",this._doPhase(e)}},{key:"pointerUp",value:function(e,i,r,n){var a=this.getPointerIndex(e);-1===a&&(a=this.updatePointer(e,i,r,!1));var s=/cancel$/i.test(i.type)?"cancel":"up";this._scopeFire("interactions:".concat(s),{pointer:e,pointerIndex:a,pointerInfo:this.pointers[a],event:i,eventTarget:r,type:s,curEventTarget:n,interaction:this}),this.simulation||this.end(i),this.removePointer(e,i)}},{key:"documentBlur",value:function(e){this.end(e),this._scopeFire("interactions:blur",{event:e,type:"blur",interaction:this})}},{key:"end",value:function(e){var i;this._ending=!0,e=e||this._latestPointer.event,this.interacting()&&(i=this._doPhase({event:e,interaction:this,phase:"end"})),this._ending=!1,!0===i&&this.stop()}},{key:"currentAction",value:function(){return this._interacting?this.prepared.name:null}},{key:"interacting",value:function(){return this._interacting}},{key:"stop",value:function(){this._scopeFire("interactions:stop",{interaction:this}),this.interactable=this.element=null,this._interacting=!1,this._stopped=!0,this.prepared.name=this.prevEvent=null}},{key:"getPointerIndex",value:function(e){var i=ef(e);return"mouse"===this.pointerType||"pen"===this.pointerType?this.pointers.length-1:eE(this.pointers,function(e){return e.id===i})}},{key:"getPointerInfo",value:function(e){return this.pointers[this.getPointerIndex(e)]}},{key:"updatePointer",value:function(e,i,r,n){var a,s,o,l,c,h,u,d,p=ef(e),f=this.getPointerIndex(e),m=this.pointers[f];return n=!1!==n&&(n||/(down|start)$/i.test(i.type)),m?m.pointer=e:(m=new tp(p,e,i,null,null),f=this.pointers.length,this.pointers.push(m)),a=this.coords.cur,s=this.pointers.map(function(e){return e.pointer}),o=this._now(),ep(l=s.length>1?eg(s):s[0],a.page),c=(c=a.client)||{},B.isOperaMobile&&eu(l)?ed("screen",l,c):ed("client",l,c),a.timeStamp=o,h=this.coords.delta,u=this.coords.prev,d=this.coords.cur,h.page.x=d.page.x-u.page.x,h.page.y=d.page.y-u.page.y,h.client.x=d.client.x-u.client.x,h.client.y=d.client.y-u.client.y,h.timeStamp=d.timeStamp-u.timeStamp,n&&(this.pointerIsDown=!0,m.downTime=this.coords.cur.timeStamp,m.downTarget=r,el(this.downPointer,e),this.interacting()||(ec(this.coords.start,this.coords.cur),ec(this.coords.prev,this.coords.cur),this.downEvent=i,this.pointerWasMoved=!1)),this._updateLatestPointer(e,i,r),this._scopeFire("interactions:update-pointer",{pointer:e,event:i,eventTarget:r,down:n,pointerInfo:m,pointerIndex:f,interaction:this}),f}},{key:"removePointer",value:function(e,i){var r=this.getPointerIndex(e);if(-1!==r){var n=this.pointers[r];this._scopeFire("interactions:remove-pointer",{pointer:e,event:i,eventTarget:null,pointerIndex:r,pointerInfo:n,interaction:this}),this.pointers.splice(r,1),this.pointerIsDown=!1}}},{key:"_updateLatestPointer",value:function(e,i,r){this._latestPointer.pointer=e,this._latestPointer.event=i,this._latestPointer.eventTarget=r}},{key:"destroy",value:function(){this._latestPointer.pointer=null,this._latestPointer.event=null,this._latestPointer.eventTarget=null}},{key:"_createPreparedEvent",value:function(e,i,r,n){return new td(this,e,this.prepared.name,i,this.element,r,n)}},{key:"_fireEvent",value:function(e){var i;null==(i=this.interactable)||i.fire(e),(!this.prevEvent||e.timeStamp>=this.prevEvent.timeStamp)&&(this.prevEvent=e)}},{key:"_doPhase",value:function(e){var i=e.event,r=e.phase,n=e.preEnd,a=e.type,s=this.rect;if(s&&"move"===r&&(ei(this.edges,s,this.coords.delta[this.interactable.options.deltaSource]),s.width=s.right-s.left,s.height=s.bottom-s.top),!1===this._scopeFire("interactions:before-action-".concat(r),e))return!1;var o=e.iEvent=this._createPreparedEvent(i,r,n,a);return this._scopeFire("interactions:action-".concat(r),e),"start"===r&&(this.prevEvent=o),this._fireEvent(o),this._scopeFire("interactions:after-action-".concat(r),e),!0}},{key:"_now",value:function(){return Date.now()}}]),e}();function t_(e){ty(e.interaction)}function ty(e){if(!e.offset.pending.x&&!e.offset.pending.y)return!1;var i=e.offset.pending;return tM(e.coords.cur,i),tM(e.coords.delta,i),ei(e.edges,e.rect,i),i.x=0,i.y=0,!0}function tx(e){var i=e.x,r=e.y;this.offset.pending.x+=i,this.offset.pending.y+=r,this.offset.total.x+=i,this.offset.total.y+=r}function tM(e,i){var r=e.page,n=e.client,a=i.x,s=i.y;r.x+=a,r.y+=s,n.x+=a,n.y+=s}tm.offsetBy="";var tS={id:"offset",before:["modifiers","pointer-events","actions","inertia"],install:function(e){e.Interaction.prototype.offsetBy=tx},listeners:{"interactions:new":function(e){e.interaction.offset={total:{x:0,y:0},pending:{x:0,y:0}}},"interactions:update-pointer":function(e){var i;(i=e.interaction).pointerIsDown&&(tM(i.coords.cur,i.offset.total),i.offset.pending.x=0,i.offset.pending.y=0)},"interactions:before-action-start":t_,"interactions:before-action-move":t_,"interactions:before-action-end":function(e){var i=e.interaction;if(ty(i))return i.move({offset:!0}),i.end(),!1},"interactions:stop":function(e){var i=e.interaction;i.offset.total.x=0,i.offset.total.y=0,i.offset.pending.x=0,i.offset.pending.y=0}}},tb=function(){function e(i){a(this,e),this.active=!1,this.isModified=!1,this.smoothEnd=!1,this.allowResume=!1,this.modification=void 0,this.modifierCount=0,this.modifierArg=void 0,this.startCoords=void 0,this.t0=0,this.v0=0,this.te=0,this.targetOffset=void 0,this.modifiedOffset=void 0,this.currentOffset=void 0,this.lambda_v0=0,this.one_ve_v0=0,this.timeout=void 0,this.interaction=void 0,this.interaction=i}return o(e,[{key:"start",value:function(e){var i=this.interaction,r=tT(i);if(!r||!r.enabled)return!1;var n=i.coords.velocity.client,a=es(n.x,n.y),s=this.modification||(this.modification=new ts(i));if(s.copyFrom(i.modification),this.t0=i._now(),this.allowResume=r.allowResume,this.v0=a,this.currentOffset={x:0,y:0},this.startCoords=i.coords.cur.page,this.modifierArg=s.fillArg({pageCoords:this.startCoords,preEnd:!0,phase:"inertiastart"}),this.t0-i.coords.cur.timeStamp<50&&a>r.minSpeed&&a>r.endSpeed)this.startInertia();else{if(s.result=s.setAll(this.modifierArg),!s.result.changed)return!1;this.startSmoothEnd()}return i.modification.result.rect=null,i.offsetBy(this.targetOffset),i._doPhase({interaction:i,event:e,phase:"inertiastart"}),i.offsetBy({x:-this.targetOffset.x,y:-this.targetOffset.y}),i.modification.result.rect=null,this.active=!0,i.simulation=this,!0}},{key:"startInertia",value:function(){var e=this,i=this.interaction.coords.velocity.client,r=tT(this.interaction),n=r.resistance,a=-Math.log(r.endSpeed/this.v0)/n;this.targetOffset={x:(i.x-a)/n,y:(i.y-a)/n},this.te=a,this.lambda_v0=n/this.v0,this.one_ve_v0=1-r.endSpeed/this.v0;var s=this.modification,o=this.modifierArg;o.pageCoords={x:this.startCoords.x+this.targetOffset.x,y:this.startCoords.y+this.targetOffset.y},s.result=s.setAll(o),s.result.changed&&(this.isModified=!0,this.modifiedOffset={x:this.targetOffset.x+s.result.delta.x,y:this.targetOffset.y+s.result.delta.y}),this.onNextFrame(function(){return e.inertiaTick()})}},{key:"startSmoothEnd",value:function(){var e=this;this.smoothEnd=!0,this.isModified=!0,this.targetOffset={x:this.modification.result.delta.x,y:this.modification.result.delta.y},this.onNextFrame(function(){return e.smoothEndTick()})}},{key:"onNextFrame",value:function(e){var i=this;this.timeout=eH(function(){i.active&&e()})}},{key:"inertiaTick",value:function(){var e,i,r,n,a=this,s=this.interaction,o=tT(s).resistance,l=(s._now()-this.t0)/1e3;if(l<this.te){var c,h=1-(Math.exp(-o*l)-this.lambda_v0)/this.one_ve_v0;this.isModified?(e=this.targetOffset.x,i=this.targetOffset.y,r=this.modifiedOffset.x,n=this.modifiedOffset.y,c={x:tE(h,0,e,r),y:tE(h,0,i,n)}):c={x:this.targetOffset.x*h,y:this.targetOffset.y*h};var u={x:c.x-this.currentOffset.x,y:c.y-this.currentOffset.y};this.currentOffset.x+=u.x,this.currentOffset.y+=u.y,s.offsetBy(u),s.move(),this.onNextFrame(function(){return a.inertiaTick()})}else s.offsetBy({x:this.modifiedOffset.x-this.currentOffset.x,y:this.modifiedOffset.y-this.currentOffset.y}),this.end()}},{key:"smoothEndTick",value:function(){var e=this,i=this.interaction,r=i._now()-this.t0,n=tT(i).smoothEndDuration;if(r<n){var a,s,o,l,c={x:(a=r,s=this.targetOffset.x,-s*(a/=n)*(a-2)+0),y:(o=r,l=this.targetOffset.y,-l*(o/=n)*(o-2)+0)},h={x:c.x-this.currentOffset.x,y:c.y-this.currentOffset.y};this.currentOffset.x+=h.x,this.currentOffset.y+=h.y,i.offsetBy(h),i.move({skipModifiers:this.modifierCount}),this.onNextFrame(function(){return e.smoothEndTick()})}else i.offsetBy({x:this.targetOffset.x-this.currentOffset.x,y:this.targetOffset.y-this.currentOffset.y}),this.end()}},{key:"resume",value:function(e){var i=e.pointer,r=e.event,n=e.eventTarget,a=this.interaction;a.offsetBy({x:-this.currentOffset.x,y:-this.currentOffset.y}),a.updatePointer(i,r,n,!0),a._doPhase({interaction:a,event:r,phase:"resume"}),ec(a.coords.prev,a.coords.cur),this.stop()}},{key:"end",value:function(){this.interaction.move(),this.interaction.end(),this.stop()}},{key:"stop",value:function(){this.active=this.smoothEnd=!1,this.interaction.simulation=null,eG(this.timeout)}}]),e}();function tT(e){var i=e.interactable,r=e.prepared;return i&&i.options&&r.name&&i.options[r.name].inertia}function tE(e,i,r,n){var a=1-e;return a*a*i+2*a*e*r+e*e*n}function tw(e,i){for(var r=0;r<i.length;r++){var n=i[r];if(e.immediatePropagationStopped)break;n(e)}}var tA=function(){function e(i){a(this,e),this.options=void 0,this.types={},this.propagationStopped=!1,this.immediatePropagationStopped=!1,this.global=void 0,this.options=Z({},i||{})}return o(e,[{key:"fire",value:function(e){var i,r=this.global;(i=this.types[e.type])&&tw(e,i),!e.propagationStopped&&r&&(i=r[e.type])&&tw(e,i)}},{key:"on",value:function(e,i){var r=en(e,i);for(e in r)this.types[e]=eb(this.types[e]||[],r[e])}},{key:"off",value:function(e,i){var r=en(e,i);for(e in r){var n=this.types[e];if(n&&n.length)for(var a=0,s=r[e];a<s.length;a++){var o=s[a],l=n.indexOf(o);-1!==l&&n.splice(l,1)}}}},{key:"getRect",value:function(e){return null}}]),e}(),tR=function(){function e(i){a(this,e),this.currentTarget=void 0,this.originalEvent=void 0,this.type=void 0,this.originalEvent=i,el(this,i)}return o(e,[{key:"preventOriginalDefault",value:function(){this.originalEvent.preventDefault()}},{key:"stopPropagation",value:function(){this.originalEvent.stopPropagation()}},{key:"stopImmediatePropagation",value:function(){this.originalEvent.stopImmediatePropagation()}}]),e}();function tC(e){return b(e)?{capture:!!e.capture,passive:!!e.passive}:{capture:!!e,passive:!1}}function tP(e,i){return e===i||("boolean"==typeof e?!!i.capture===e&&!1==!!i.passive:!!e.capture==!!i.capture&&!!e.passive==!!i.passive)}var tI={id:"events",install:function(e){var i,r=[],n={},a=[],s={add:o,remove:l,addDelegate:function(e,i,r,s,l){var u=tC(l);if(!n[r]){n[r]=[];for(var d=0;d<a.length;d++){var p=a[d];o(p,r,c),o(p,r,h,!0)}}var f=n[r],m=ew(f,function(r){return r.selector===e&&r.context===i});m||(m={selector:e,context:i,listeners:[]},f.push(m)),m.listeners.push({func:s,options:u})},removeDelegate:function(e,i,r,a,s){var o,u=tC(s),d=n[r],p=!1;if(d)for(o=d.length-1;o>=0;o--){var f=d[o];if(f.selector===e&&f.context===i){for(var m=f.listeners,g=m.length-1;g>=0;g--){var v=m[g];if(v.func===a&&tP(v.options,u)){m.splice(g,1),m.length||(d.splice(o,1),l(i,r,c),l(i,r,h,!0)),p=!0;break}}if(p)break}}},delegateListener:c,delegateUseCapture:h,delegatedEvents:n,documents:a,targets:r,supportsOptions:!1,supportsPassive:!1};function o(e,i,n,a){if(e.addEventListener){var o=tC(a),l=ew(r,function(i){return i.eventTarget===e});l||(l={eventTarget:e,events:{}},r.push(l)),l.events[i]||(l.events[i]=[]),ew(l.events[i],function(e){return e.func===n&&tP(e.options,o)})||(e.addEventListener(i,n,s.supportsOptions?o:o.capture),l.events[i].push({func:n,options:o}))}}function l(e,i,n,a){if(e.addEventListener&&e.removeEventListener){var o=eE(r,function(i){return i.eventTarget===e}),c=r[o];if(c&&c.events)if("all"!==i){var h=!1,u=c.events[i];if(u){if("all"===n){for(var d=u.length-1;d>=0;d--){var p=u[d];l(e,i,p.func,p.options)}return}for(var f=tC(a),m=0;m<u.length;m++){var g=u[m];if(g.func===n&&tP(g.options,f)){e.removeEventListener(i,n,s.supportsOptions?f:f.capture),u.splice(m,1),0===u.length&&(delete c.events[i],h=!0);break}}}h&&!Object.keys(c.events).length&&r.splice(o,1)}else for(i in c.events)c.events.hasOwnProperty(i)&&l(e,i,"all")}}function c(e,i){for(var r=tC(i),a=new tR(e),s=n[e.type],o=eM(e)[0],l=o;P(l);){for(var c=0;c<s.length;c++){var h=s[c],u=h.selector,d=h.context;if(H(l,u)&&z(d,o)&&z(d,l)){var p=h.listeners;a.currentTarget=l;for(var f=0;f<p.length;f++){var m=p[f];tP(m.options,r)&&m.func(a)}}}l=V(l)}}function h(e){return c(e,!0)}return null==(i=e.document)||i.createElement("div").addEventListener("test",null,{get capture(){return s.supportsOptions=!0},get passive(){return s.supportsPassive=!0}}),e.events=s,s}},tL={methodOrder:["simulationResume","mouseOrPen","hasPointer","idle"],search:function(e){for(var i=0,r=tL.methodOrder;i<r.length;i++){var n=tL[r[i]](e);if(n)return n}return null},simulationResume:function(e){var i=e.pointerType,r=e.eventType,n=e.eventTarget,a=e.scope;if(!/down|start/i.test(r))return null;for(var s=0,o=a.interactions.list;s<o.length;s++){var l=o[s],c=n;if(l.simulation&&l.simulation.allowResume&&l.pointerType===i)for(;c;){if(c===l.element)return l;c=V(c)}}return null},mouseOrPen:function(e){var i,r=e.pointerId,n=e.pointerType,a=e.eventType,s=e.scope;if("mouse"!==n&&"pen"!==n)return null;for(var o=0,l=s.interactions.list;o<l.length;o++){var c=l[o];if(c.pointerType===n){if(c.simulation&&!tD(c,r))continue;if(c.interacting())return c;i||(i=c)}}if(i)return i;for(var h=0,u=s.interactions.list;h<u.length;h++){var d=u[h];if(!(d.pointerType!==n||/down/i.test(a)&&d.simulation))return d}return null},hasPointer:function(e){for(var i=e.pointerId,r=0,n=e.scope.interactions.list;r<n.length;r++){var a=n[r];if(tD(a,i))return a}return null},idle:function(e){for(var i=e.pointerType,r=0,n=e.scope.interactions.list;r<n.length;r++){var a=n[r];if(1===a.pointers.length){var s=a.interactable;if(s&&(!s.options.gesture||!s.options.gesture.enabled))continue}else if(a.pointers.length>=2)continue;if(!a.interacting()&&i===a.pointerType)return a}return null}};function tD(e,i){return e.pointers.some(function(e){return e.id===i})}var tU=["pointerDown","pointerMove","pointerUp","updatePointer","removePointer","windowBlur"];function tN(e,i){return function(r){var n=i.interactions.list,a=ex(r),s=eM(r),o=s[0],l=s[1],c=[];if(/^touch/.test(r.type)){i.prevTouchTime=i.now();for(var h=0,u=r.changedTouches;h<u.length;h++){var d=u[h],p={pointer:d,pointerId:ef(d),pointerType:a,eventType:r.type,eventTarget:o,curEventTarget:l,scope:i},f=tO(p);c.push([p.pointer,p.eventTarget,p.curEventTarget,f])}}else{var m=!1;if(!B.supportsPointerEvent&&/mouse/.test(r.type)){for(var g=0;g<n.length&&!m;g++)m="mouse"!==n[g].pointerType&&n[g].pointerIsDown;m=m||i.now()-i.prevTouchTime<500||0===r.timeStamp}if(!m){var v={pointer:r,pointerId:ef(r),pointerType:a,eventType:r.type,curEventTarget:l,eventTarget:o,scope:i},_=tO(v);c.push([v.pointer,v.eventTarget,v.curEventTarget,_])}}for(var y=0;y<c.length;y++){var x=c[y],M=x[0],S=x[1],b=x[2];x[3][e](M,r,S,b)}}}function tO(e){var i=e.pointerType,r=e.scope,n={interaction:tL.search(e),searchDetails:e};return r.fire("interactions:find",n),n.interaction||r.interactions.new({pointerType:i})}function tF(e,i){var r=e.doc,n=e.scope,a=e.options,s=n.interactions.docEvents,o=n.events,l=o[i];for(var c in n.browser.isIOS&&!a.events&&(a.events={passive:!1}),o.delegatedEvents)l(r,c,o.delegateListener),l(r,c,o.delegateUseCapture,!0);for(var h=a&&a.events,u=0;u<s.length;u++){var d=s[u];l(r,d.type,d.listener,h)}}var tB={id:"core/interactions",install:function(e){for(var i={},r=0;r<tU.length;r++){var n=tU[r];i[n]=tN(n,e)}var s,c=B.pEventTypes;function h(){for(var i=0,r=e.interactions.list;i<r.length;i++){var n=r[i];if(n.pointerIsDown&&"touch"===n.pointerType&&!n._interacting)for(var a=0,s=n.pointers;a<s.length;a++)!function(){var i=s[a];e.documents.some(function(e){return z(e.doc,i.downTarget)})||n.removePointer(i.pointer,i.event)}()}}(s=O.PointerEvent?[{type:c.down,listener:h},{type:c.down,listener:i.pointerDown},{type:c.move,listener:i.pointerMove},{type:c.up,listener:i.pointerUp},{type:c.cancel,listener:i.pointerUp}]:[{type:"mousedown",listener:i.pointerDown},{type:"mousemove",listener:i.pointerMove},{type:"mouseup",listener:i.pointerUp},{type:"touchstart",listener:h},{type:"touchstart",listener:i.pointerDown},{type:"touchmove",listener:i.pointerMove},{type:"touchend",listener:i.pointerUp},{type:"touchcancel",listener:i.pointerUp}]).push({type:"blur",listener:function(i){for(var r=0,n=e.interactions.list;r<n.length;r++)n[r].documentBlur(i)}}),e.prevTouchTime=0,e.Interaction=function(i){l(n,i);var r=d(n);function n(){return a(this,n),r.apply(this,arguments)}return o(n,[{key:"pointerMoveTolerance",get:function(){return e.interactions.pointerMoveTolerance},set:function(i){e.interactions.pointerMoveTolerance=i}},{key:"_now",value:function(){return e.now()}}]),n}(tv),e.interactions={list:[],new:function(i){i.scopeFire=function(i,r){return e.fire(i,r)};var r=new e.Interaction(i);return e.interactions.list.push(r),r},listeners:i,docEvents:s,pointerMoveTolerance:1},e.usePlugin(tr)},listeners:{"scope:add-document":function(e){return tF(e,"add")},"scope:remove-document":function(e){return tF(e,"remove")},"interactable:unset":function(e,i){for(var r=e.interactable,n=i.interactions.list.length-1;n>=0;n--){var a=i.interactions.list[n];a.interactable===r&&(a.stop(),i.fire("interactions:destroy",{interaction:a}),a.destroy(),i.interactions.list.length>2&&i.interactions.list.splice(n,1))}}},onDocSignal:tF,doOnInteractions:tN,methodNames:tU},tz=((v=tz||{})[v.On=0]="On",v[v.Off=1]="Off",v),tk=function(){function e(i,r,n,s){a(this,e),this.target=void 0,this.options=void 0,this._actions=void 0,this.events=new tA,this._context=void 0,this._win=void 0,this._doc=void 0,this._scopeEvents=void 0,this._actions=r.actions,this.target=i,this._context=r.context||n,this._win=S(J(i)?this._context:i),this._doc=this._win.document,this._scopeEvents=s,this.set(r)}return o(e,[{key:"_defaults",get:function(){return{base:{},perAction:{},actions:{}}}},{key:"setOnEvents",value:function(e,i){return T(i.onstart)&&this.on("".concat(e,"start"),i.onstart),T(i.onmove)&&this.on("".concat(e,"move"),i.onmove),T(i.onend)&&this.on("".concat(e,"end"),i.onend),T(i.oninertiastart)&&this.on("".concat(e,"inertiastart"),i.oninertiastart),this}},{key:"updatePerActionListeners",value:function(e,i,r){var n,a=this,s=null==(n=this._actions.map[e])?void 0:n.filterEventType,o=function(e){return(null==s||s(e))&&tn(e,a._actions)};(L(i)||b(i))&&this._onOff(tz.Off,e,i,void 0,o),(L(r)||b(r))&&this._onOff(tz.On,e,r,void 0,o)}},{key:"setPerAction",value:function(e,i){var r=this._defaults;for(var n in i){var a=this.options[e],s=i[n];"listeners"===n&&this.updatePerActionListeners(e,a.listeners,s),L(s)?a[n]=eT(s):I(s)?(a[n]=Z(a[n]||{},ta(s)),b(r.perAction[n])&&"enabled"in r.perAction[n]&&(a[n].enabled=!1!==s.enabled)):R(s)&&b(r.perAction[n])?a[n].enabled=s:a[n]=s}}},{key:"getRect",value:function(e){return e=e||(P(this.target)?this.target:null),C(this.target)&&(e=e||this._context.querySelector(this.target)),Y(e)}},{key:"rectChecker",value:function(e){var i=this;return T(e)?(this.getRect=function(r){var n=Z({},e.apply(i,r));return"width"in n||(n.width=n.right-n.left,n.height=n.bottom-n.top),n},this):null===e?(delete this.getRect,this):this.getRect}},{key:"_backCompatOption",value:function(e,i){if(J(i)||b(i)){for(var r in this.options[e]=i,this._actions.map)this.options[r][e]=i;return this}return this.options[e]}},{key:"origin",value:function(e){return this._backCompatOption("origin",e)}},{key:"deltaSource",value:function(e){return"page"===e||"client"===e?(this.options.deltaSource=e,this):this.options.deltaSource}},{key:"getAllElements",value:function(){var e=this.target;return C(e)?Array.from(this._context.querySelectorAll(e)):T(e)&&e.getAllElements?e.getAllElements():P(e)?[e]:[]}},{key:"context",value:function(){return this._context}},{key:"inContext",value:function(e){return this._context===e.ownerDocument||z(this._context,e)}},{key:"testIgnoreAllow",value:function(e,i,r){return!this.testIgnore(e.ignoreFrom,i,r)&&this.testAllow(e.allowFrom,i,r)}},{key:"testAllow",value:function(e,i,r){return!e||!!P(r)&&(C(e)?X(r,e,i):!!P(e)&&z(e,r))}},{key:"testIgnore",value:function(e,i,r){return!(!e||!P(r))&&(C(e)?X(r,e,i):!!P(e)&&z(e,r))}},{key:"fire",value:function(e){return this.events.fire(e),this}},{key:"_onOff",value:function(e,i,r,n,a){b(i)&&!L(i)&&(n=r,r=null);var s=en(i,r,a);for(var o in s){"wheel"===o&&(o=B.wheelEvent);for(var l=0,c=s[o];l<c.length;l++){var h=c[l];tn(o,this._actions)?this.events[e===tz.On?"on":"off"](o,h):C(this.target)?this._scopeEvents[e===tz.On?"addDelegate":"removeDelegate"](this.target,this._context,o,h,n):this._scopeEvents[e===tz.On?"add":"remove"](this.target,o,h,n)}}return this}},{key:"on",value:function(e,i,r){return this._onOff(tz.On,e,i,r)}},{key:"off",value:function(e,i,r){return this._onOff(tz.Off,e,i,r)}},{key:"set",value:function(e){var i=this._defaults;for(var r in b(e)||(e={}),this.options=ta(i.base),this._actions.methodDict){var n=this._actions.methodDict[r];this.options[r]={},this.setPerAction(r,Z(Z({},i.perAction),i.actions[r])),this[n](e[r])}for(var a in e)"getRect"!==a?T(this[a])&&this[a](e[a]):this.rectChecker(e.getRect);return this}},{key:"unset",value:function(){if(C(this.target))for(var e in this._scopeEvents.delegatedEvents)for(var i=this._scopeEvents.delegatedEvents[e],r=i.length-1;r>=0;r--){var n=i[r],a=n.selector,s=n.context,o=n.listeners;a===this.target&&s===this._context&&i.splice(r,1);for(var l=o.length-1;l>=0;l--)this._scopeEvents.removeDelegate(this.target,this._context,e,o[l][0],o[l][1])}else this._scopeEvents.remove(this.target,"all")}}]),e}(),tV=function(){function e(i){var r=this;a(this,e),this.list=[],this.selectorMap={},this.scope=void 0,this.scope=i,i.addListeners({"interactable:unset":function(e){var i=e.interactable,n=i.target,a=C(n)?r.selectorMap[n]:n[r.scope.id],s=eE(a,function(e){return e===i});a.splice(s,1)}})}return o(e,[{key:"new",value:function(e,i){i=Z(i||{},{actions:this.scope.actions});var r=new this.scope.Interactable(e,i,this.scope.document,this.scope.events);return this.scope.addDocument(r._doc),this.list.push(r),C(e)?(this.selectorMap[e]||(this.selectorMap[e]=[]),this.selectorMap[e].push(r)):(r.target[this.scope.id]||Object.defineProperty(e,this.scope.id,{value:[],configurable:!0}),e[this.scope.id].push(r)),this.scope.fire("interactable:new",{target:e,options:i,interactable:r,win:this.scope._win}),r}},{key:"getExisting",value:function(e,i){var r=i&&i.context||this.scope.document,n=C(e),a=n?this.selectorMap[e]:e[this.scope.id];if(a)return ew(a,function(i){return i._context===r&&(n||i.inContext(e))})}},{key:"forEachMatch",value:function(e,i){for(var r=0,n=this.list;r<n.length;r++){var a=n[r],s=void 0;if((C(a.target)?P(e)&&H(e,a.target):e===a.target)&&a.inContext(e)&&(s=i(a)),void 0!==s)return s}}}]),e}();function tH(e){return e&&e.replace(/\/.*$/,"")}var tG=new(function(){function e(){var i,r,n=this;a(this,e),this.id="__interact_scope_".concat(Math.floor(100*Math.random())),this.isInitialized=!1,this.listenerMaps=[],this.browser=B,this.defaults=ta(tu),this.Eventable=tA,this.actions={map:{},phases:{start:!0,move:!0,end:!0},methodDict:{},phaselessTypes:{}},this.interactStatic=(i=this,(r=function e(r,n){var a=i.interactables.getExisting(r,n);return a||((a=i.interactables.new(r,n)).events.global=e.globalEvents),a}).getPointerAverage=eg,r.getTouchBBox=ev,r.getTouchDistance=e_,r.getTouchAngle=ey,r.getElementRect=Y,r.getElementClientRect=q,r.matchesSelector=H,r.closest=k,r.globalEvents={},r.version="1.10.27",r.scope=i,r.use=function(e,i){return this.scope.usePlugin(e,i),this},r.isSet=function(e,i){return!!this.scope.interactables.get(e,i&&i.context)},r.on=eK(function(e,i,r){if(C(e)&&-1!==e.search(" ")&&(e=e.trim().split(/ +/)),L(e)){for(var n=0,a=e;n<a.length;n++){var s=a[n];this.on(s,i,r)}return this}if(b(e)){for(var o in e)this.on(o,e[o],i);return this}return tn(e,this.scope.actions)?this.globalEvents[e]?this.globalEvents[e].push(i):this.globalEvents[e]=[i]:this.scope.events.add(this.scope.document,e,i,{options:r}),this},"The interact.on() method is being deprecated"),r.off=eK(function(e,i,r){if(C(e)&&-1!==e.search(" ")&&(e=e.trim().split(/ +/)),L(e)){for(var n,a=0,s=e;a<s.length;a++){var o=s[a];this.off(o,i,r)}return this}if(b(e)){for(var l in e)this.off(l,e[l],i);return this}return tn(e,this.scope.actions)?e in this.globalEvents&&-1!==(n=this.globalEvents[e].indexOf(i))&&this.globalEvents[e].splice(n,1):this.scope.events.remove(this.scope.document,e,i,r),this},"The interact.off() method is being deprecated"),r.debug=function(){return this.scope},r.supportsTouch=function(){return B.supportsTouch},r.supportsPointerEvent=function(){return B.supportsPointerEvent},r.stop=function(){for(var e=0,i=this.scope.interactions.list;e<i.length;e++)i[e].stop();return this},r.pointerMoveTolerance=function(e){return A(e)?(this.scope.interactions.pointerMoveTolerance=e,this):this.scope.interactions.pointerMoveTolerance},r.addDocument=function(e,i){this.scope.addDocument(e,i)},r.removeDocument=function(e){this.scope.removeDocument(e)},r),this.InteractEvent=td,this.Interactable=void 0,this.interactables=new tV(this),this._win=void 0,this.document=void 0,this.window=void 0,this.documents=[],this._plugins={list:[],map:{}},this.onWindowUnload=function(e){return n.removeDocument(e.target)};var s=this;this.Interactable=function(e){l(r,e);var i=d(r);function r(){return a(this,r),i.apply(this,arguments)}return o(r,[{key:"_defaults",get:function(){return s.defaults}},{key:"set",value:function(e){return p(c(r.prototype),"set",this).call(this,e),s.fire("interactable:set",{options:e,interactable:this}),this}},{key:"unset",value:function(){p(c(r.prototype),"unset",this).call(this);var e=s.interactables.list.indexOf(this);e<0||(s.interactables.list.splice(e,1),s.fire("interactable:unset",{interactable:this}))}}]),r}(tk)}return o(e,[{key:"addListeners",value:function(e,i){this.listenerMaps.push({id:i,map:e})}},{key:"fire",value:function(e,i){for(var r=0,n=this.listenerMaps;r<n.length;r++){var a=n[r].map[e];if(a&&!1===a(i,this,e))return!1}}},{key:"init",value:function(e){return this.isInitialized||(this.isInitialized=!0,E(e)&&M(e),O.init(e),B.init(e),eW(e),this.window=e,this.document=e.document,this.usePlugin(tB),this.usePlugin(tI)),this}},{key:"pluginIsInstalled",value:function(e){var i=e.id;return i?!!this._plugins.map[i]:-1!==this._plugins.list.indexOf(e)}},{key:"usePlugin",value:function(e,i){if(!this.isInitialized||this.pluginIsInstalled(e))return this;if(e.id&&(this._plugins.map[e.id]=e),this._plugins.list.push(e),e.install&&e.install(this,i),e.listeners&&e.before){for(var r=0,n=this.listenerMaps.length,a=e.before.reduce(function(e,i){return e[i]=!0,e[tH(i)]=!0,e},{});r<n;r++){var s=this.listenerMaps[r].id;if(s&&(a[s]||a[tH(s)]))break}this.listenerMaps.splice(r,0,{id:e.id,map:e.listeners})}else e.listeners&&this.listenerMaps.push({id:e.id,map:e.listeners});return this}},{key:"addDocument",value:function(e,i){if(-1!==this.getDocIndex(e))return!1;var r=S(e);i=i?Z({},i):{},this.documents.push({doc:e,options:i}),this.events.documents.push(e),e!==this.document&&this.events.add(r,"unload",this.onWindowUnload),this.fire("scope:add-document",{doc:e,window:r,scope:this,options:i})}},{key:"removeDocument",value:function(e){var i=this.getDocIndex(e),r=S(e),n=this.documents[i].options;this.events.remove(r,"unload",this.onWindowUnload),this.documents.splice(i,1),this.events.documents.splice(i,1),this.fire("scope:remove-document",{doc:e,window:r,scope:this,options:n})}},{key:"getDocIndex",value:function(e){for(var i=0;i<this.documents.length;i++)if(this.documents[i].doc===e)return i;return -1}},{key:"getDocOptions",value:function(e){var i=this.getDocIndex(e);return -1===i?null:this.documents[i].options}},{key:"now",value:function(){return(this.window.Date||Date).now()}}]),e}()),tW=tG.interactStatic,tX="u">typeof globalThis?globalThis:window;tG.init(tX);var tj=Object.freeze({__proto__:null,edgeTarget:function(){},elements:function(){},grid:function(e){var i=[["x","y"],["left","top"],["right","bottom"],["width","height"]].filter(function(i){var r=i[0],n=i[1];return r in e||n in e}),r=function(r,n){for(var a=e.range,s=e.limits,o=void 0===s?{left:-1/0,right:1/0,top:-1/0,bottom:1/0}:s,l=e.offset,c=void 0===l?{x:0,y:0}:l,h={range:a,grid:e,x:null,y:null},u=0;u<i.length;u++){var d=i[u],p=d[0],f=d[1],m=Math.round((r-c.x)/e[p]),g=Math.round((n-c.y)/e[f]);h[p]=Math.max(o.left,Math.min(o.right,m*e[p]+c.x)),h[f]=Math.max(o.top,Math.min(o.bottom,g*e[f]+c.y))}return h};return r.grid=e,r.coordFields=i,r}}),tq={id:"snappers",install:function(e){var i=e.interactStatic;i.snappers=Z(i.snappers||{},tj),i.createSnapGrid=i.snappers.grid}};function tY(e,i,r){var n=e.startCoords,a=e.edgeSign;i?r.y=n.y+(r.x-n.x)*a.y:r.x=n.x+(r.y-n.y)*a.x}function tK(e,i,r,n){var a=e.startRect,s=e.startCoords,o=e.ratio,l=e.edgeSign;if(i){var c=n.width/o;r.y=s.y+(c-a.height)*l.y}else{var h=n.height*o;r.x=s.x+(h-a.width)*l.x}}var tJ=tl({start:function(e){var i=e.state,n=e.rect,a=e.edges,s=e.pageCoords,o=i.options,l=o.ratio,c=o.enabled,h=i.options,u=h.equalDelta,d=h.modifiers;"preserve"===l&&(l=n.width/n.height),i.startCoords=Z({},s),i.startRect=Z({},n),i.ratio=l,i.equalDelta=u;var p=i.linkedEdges={top:a.top||a.left&&!a.bottom,left:a.left||a.top&&!a.right,bottom:a.bottom||a.right&&!a.top,right:a.right||a.bottom&&!a.left};if(i.xIsPrimaryAxis=!(!a.left&&!a.right),i.equalDelta){var f=(p.left?1:-1)*(p.top?1:-1);i.edgeSign={x:f,y:f}}else i.edgeSign={x:p.left?-1:1,y:p.top?-1:1};if(!1!==c&&Z(a,p),null!=d&&d.length){var m=new ts(e.interaction);m.copyFrom(e.interaction.modification),m.prepareStates(d),i.subModification=m,m.startAll(r({},e))}},set:function(e){var i=e.state,n=e.rect,a=e.coords,s=i.linkedEdges,o=Z({},a),l=i.equalDelta?tY:tK;if(Z(e.edges,s),l(i,i.xIsPrimaryAxis,a,n),!i.subModification)return null;var c=Z({},n);ei(s,c,{x:a.x-o.x,y:a.y-o.y});var h=i.subModification.setAll(r(r({},e),{},{rect:c,edges:s,pageCoords:a,prevCoords:a,prevRect:c})),u=h.delta;return h.changed&&(l(i,Math.abs(u.x)>Math.abs(u.y),h.coords,h.rect),Z(a,h.coords)),h.eventProps},defaults:{ratio:"preserve",equalDelta:!1,modifiers:[],enabled:!1}},"aspectRatio"),tZ=function(){};function tQ(e,i,r){return T(e)?$(e,i.interactable,i.element,[r.x,r.y,i]):$(e,i.interactable,i.element)}tZ._defaults={};var t$={start:function(e){var i=e.rect,r=e.startOffset,n=e.state,a=e.interaction,s=e.pageCoords,o=n.options,l=o.elementRect,c=Z({left:0,top:0,right:0,bottom:0},o.offset||{});if(i&&l){var h=tQ(o.restriction,a,s);if(h){var u=h.right-h.left-i.width,d=h.bottom-h.top-i.height;u<0&&(c.left+=u,c.right+=u),d<0&&(c.top+=d,c.bottom+=d)}c.left+=r.left-i.width*l.left,c.top+=r.top-i.height*l.top,c.right+=r.right-i.width*(1-l.right),c.bottom+=r.bottom-i.height*(1-l.bottom)}n.offset=c},set:function(e){var i=e.coords,r=e.interaction,n=e.state,a=n.options,s=n.offset,o=tQ(a.restriction,r,i);if(o){var l,c=(!(l=o)||"left"in l&&"top"in l||((l=Z({},l)).left=l.x||0,l.top=l.y||0,l.right=l.right||l.left+l.width,l.bottom=l.bottom||l.top+l.height),l);i.x=Math.max(Math.min(c.right-s.right,i.x),c.left+s.left),i.y=Math.max(Math.min(c.bottom-s.bottom,i.y),c.top+s.top)}},defaults:{restriction:null,elementRect:null,offset:null,endOnly:!1,enabled:!1}},t0=tl(t$,"restrict"),t1={top:1/0,left:1/0,bottom:-1/0,right:-1/0},t3={top:-1/0,left:-1/0,bottom:1/0,right:1/0};function t2(e,i){for(var r=0,n=["top","left","bottom","right"];r<n.length;r++){var a=n[r];a in e||(e[a]=i[a])}return e}var t4={noInner:t1,noOuter:t3,start:function(e){var i,r=e.interaction,n=e.startOffset,a=e.state,s=a.options;s&&(i=ee(tQ(s.offset,r,r.coords.start.page))),a.offset={top:(i=i||{x:0,y:0}).y+n.top,left:i.x+n.left,bottom:i.y-n.bottom,right:i.x-n.right}},set:function(e){var i=e.coords,r=e.edges,n=e.interaction,a=e.state,s=a.offset,o=a.options;if(r){var l=Z({},i),c=tQ(o.inner,n,l)||{},h=tQ(o.outer,n,l)||{};t2(c,t1),t2(h,t3),r.top?i.y=Math.min(Math.max(h.top+s.top,l.y),c.top+s.top):r.bottom&&(i.y=Math.max(Math.min(h.bottom+s.bottom,l.y),c.bottom+s.bottom)),r.left?i.x=Math.min(Math.max(h.left+s.left,l.x),c.left+s.left):r.right&&(i.x=Math.max(Math.min(h.right+s.right,l.x),c.right+s.right))}},defaults:{inner:null,outer:null,offset:null,endOnly:!1,enabled:!1}},t5=tl(t4,"restrictEdges"),t6=Z({get elementRect(){return{top:0,left:0,bottom:1,right:1}},set elementRect(t){}},t$.defaults),t8=tl({start:t$.start,set:t$.set,defaults:t6},"restrictRect"),t9={width:-1/0,height:-1/0},t7={width:1/0,height:1/0},ie=tl({start:function(e){return t4.start(e)},set:function(e){var i=e.interaction,r=e.state,n=e.rect,a=e.edges,s=r.options;if(a){var o=et(tQ(s.min,i,e.coords))||t9,l=et(tQ(s.max,i,e.coords))||t7;r.options={endOnly:s.endOnly,inner:Z({},t4.noInner),outer:Z({},t4.noOuter)},a.top?(r.options.inner.top=n.bottom-o.height,r.options.outer.top=n.bottom-l.height):a.bottom&&(r.options.inner.bottom=n.top+o.height,r.options.outer.bottom=n.top+l.height),a.left?(r.options.inner.left=n.right-o.width,r.options.outer.left=n.right-l.width):a.right&&(r.options.inner.right=n.left+o.width,r.options.outer.right=n.left+l.width),t4.set(e),r.options=s}},defaults:{min:null,max:null,endOnly:!1,enabled:!1}},"restrictSize"),it={start:function(e){var i,r,n=e.interaction,a=e.interactable,s=e.element,o=e.rect,l=e.state,c=e.startOffset,h=l.options,u=h.offsetWithOrigin?(i=e.interaction.element,ee($(e.state.options.origin,null,null,[i]))||er(e.interactable,i,e.interaction.prepared.name)):{x:0,y:0};if("startCoords"===h.offset)r={x:n.coords.start.page.x,y:n.coords.start.page.y};else{var d=$(h.offset,a,s,[n]);(r=ee(d)||{x:0,y:0}).x+=u.x,r.y+=u.y}var p=h.relativePoints;l.offsets=o&&p&&p.length?p.map(function(e,i){return{index:i,relativePoint:e,x:c.left-o.width*e.x+r.x,y:c.top-o.height*e.y+r.y}}):[{index:0,relativePoint:null,x:r.x,y:r.y}]},set:function(e){var i=e.interaction,r=e.coords,n=e.state,a=n.options,s=n.offsets,o=er(i.interactable,i.element,i.prepared.name),l=Z({},r),c=[];a.offsetWithOrigin||(l.x-=o.x,l.y-=o.y);for(var h=0;h<s.length;h++)for(var u=s[h],d=l.x-u.x,p=l.y-u.y,f=0,m=a.targets.length;f<m;f++){var g=a.targets[f],v=void 0;(v=T(g)?g(d,p,i._proxy,u,f):g)&&c.push({x:(A(v.x)?v.x:d)+u.x,y:(A(v.y)?v.y:p)+u.y,range:A(v.range)?v.range:a.range,source:g,index:f,offset:u})}for(var _={target:null,inRange:!1,distance:0,range:0,delta:{x:0,y:0}},y=0;y<c.length;y++){var x=c[y],M=x.range,S=x.x-l.x,b=x.y-l.y,E=es(S,b),w=E<=M;M===1/0&&_.inRange&&_.range!==1/0&&(w=!1),(!_.target||(w?_.inRange&&M!==1/0?E/M<_.distance/_.range:M===1/0&&_.range!==1/0||E<_.distance:!_.inRange&&E<_.distance))&&(_.target=x,_.distance=E,_.range=M,_.inRange=w,_.delta.x=S,_.delta.y=b)}return _.inRange&&(r.x=_.target.x,r.y=_.target.y),n.closest=_,_},defaults:{range:1/0,targets:null,offset:null,offsetWithOrigin:!0,origin:null,relativePoints:null,endOnly:!1,enabled:!1}},ii=tl(it,"snap"),ir={start:function(e){var i=e.state,r=e.edges,n=i.options;if(!r)return null;e.state={options:{targets:null,relativePoints:[{x:+!r.left,y:+!r.top}],offset:n.offset||"self",origin:{x:0,y:0},range:n.range}},i.targetFields=i.targetFields||[["width","height"],["x","y"]],it.start(e),i.offsets=e.state.offsets,e.state=i},set:function(e){var i=e.interaction,r=e.state,n=e.coords,a=r.options,s=r.offsets,o={x:n.x-s[0].x,y:n.y-s[0].y};r.options=Z({},a),r.options.targets=[];for(var l=0,c=a.targets||[];l<c.length;l++){var h=c[l],u=void 0;if(u=T(h)?h(o.x,o.y,i):h){for(var d=0,p=r.targetFields;d<p.length;d++){var f=p[d],m=f[0],g=f[1];if(m in u||g in u){u.x=u[m],u.y=u[g];break}}r.options.targets.push(u)}}var v=it.set(e);return r.options=a,v},defaults:{range:1/0,targets:null,offset:null,endOnly:!1,enabled:!1}},ia=tl(ir,"snapSize"),is={aspectRatio:tJ,restrictEdges:t5,restrict:t0,restrictRect:t8,restrictSize:ie,snapEdges:tl({start:function(e){var i=e.edges;return i?(e.state.targetFields=e.state.targetFields||[[i.left?"left":"right",i.top?"top":"bottom"]],ir.start(e)):null},set:ir.set,defaults:Z(ta(ir.defaults),{targets:void 0,range:void 0,offset:{x:0,y:0}})},"snapEdges"),snap:ii,snapSize:ia,spring:tZ,avoid:tZ,transform:tZ,rubberband:tZ},io=function(e){l(r,e);var i=d(r);function r(e,n,s,o,l,c){var h;if(a(this,r),el(u(h=i.call(this,l)),s),s!==n&&el(u(h),n),h.timeStamp=c,h.originalEvent=s,h.type=e,h.pointerId=ef(n),h.pointerType=ex(n),h.target=o,h.currentTarget=null,"tap"===e){var d=l.getPointerIndex(n);h.dt=h.timeStamp-l.pointers[d].downTime;var p=h.timeStamp-l.tapTime;h.double=!!l.prevTap&&"doubletap"!==l.prevTap.type&&l.prevTap.target===h.target&&p<500}else"doubletap"===e&&(h.dt=n.timeStamp-l.tapTime,h.double=!0);return h}return o(r,[{key:"_subtractOrigin",value:function(e){var i=e.x,r=e.y;return this.pageX-=i,this.pageY-=r,this.clientX-=i,this.clientY-=r,this}},{key:"_addOrigin",value:function(e){var i=e.x,r=e.y;return this.pageX+=i,this.pageY+=r,this.clientX+=i,this.clientY+=r,this}},{key:"preventDefault",value:function(){this.originalEvent.preventDefault()}}]),r}(eS),il={id:"pointer-events/base",before:["inertia","modifiers","auto-start","actions"],install:function(e){e.pointerEvents=il,e.defaults.actions.pointerEvents=il.defaults,Z(e.actions.phaselessTypes,il.types)},listeners:{"interactions:new":function(e){var i=e.interaction;i.prevTap=null,i.tapTime=0},"interactions:update-pointer":function(e){var i=e.down,r=e.pointerInfo;(i||!r.hold)&&(r.hold={duration:1/0,timeout:null})},"interactions:move":function(e,i){var r=e.interaction,n=e.pointer,a=e.event,s=e.eventTarget;e.duplicate||r.pointerIsDown&&!r.pointerWasMoved||(r.pointerIsDown&&iu(e),ic({interaction:r,pointer:n,event:a,eventTarget:s,type:"move"},i))},"interactions:down":function(e,i){!function(e,i){for(var r=e.interaction,n=e.pointer,a=e.event,s=e.eventTarget,o=e.pointerIndex,l=r.pointers[o].hold,c=K(s),h={interaction:r,pointer:n,event:a,eventTarget:s,type:"hold",targets:[],path:c,node:null},u=0;u<c.length;u++)h.node=c[u],i.fire("pointerEvents:collect-targets",h);if(h.targets.length){for(var d=1/0,p=0,f=h.targets;p<f.length;p++){var m=f[p].eventable.options.holdDuration;m<d&&(d=m)}l.duration=d,l.timeout=setTimeout(function(){ic({interaction:r,eventTarget:s,pointer:n,event:a,type:"hold"},i)},d)}}(e,i),ic(e,i)},"interactions:up":function(e,i){var r,n,a,s;iu(e),ic(e,i),r=e.interaction,n=e.pointer,a=e.event,s=e.eventTarget,r.pointerWasMoved||ic({interaction:r,eventTarget:s,pointer:n,event:a,type:"tap"},i)},"interactions:cancel":function(e,i){iu(e),ic(e,i)}},PointerEvent:io,fire:ic,collectEventTargets:ih,defaults:{holdDuration:600,ignoreFrom:null,allowFrom:null,origin:{x:0,y:0}},types:{down:!0,move:!0,up:!0,cancel:!0,tap:!0,doubletap:!0,hold:!0}};function ic(e,i){var r=e.interaction,n=e.pointer,a=e.event,s=e.eventTarget,o=e.type,l=e.targets,c=void 0===l?ih(e,i):l,h=new io(o,n,a,s,r,i.now());i.fire("pointerEvents:new",{pointerEvent:h});for(var u=0;u<c.length;u++){var d=c[u];for(var p in d.props||{})h[p]=d.props[p];var f=er(d.eventable,d.node);if(h._subtractOrigin(f),h.eventable=d.eventable,h.currentTarget=d.node,d.eventable.fire(h),h._addOrigin(f),h.immediatePropagationStopped||h.propagationStopped&&u+1<c.length&&c[u+1].node!==h.currentTarget)break}if(i.fire("pointerEvents:fired",{interaction:r,pointer:n,event:a,eventTarget:s,targets:c,type:o,pointerEvent:h}),"tap"===o){var m=h.double?ic({interaction:r,pointer:n,event:a,eventTarget:s,type:"doubletap"},i):h;r.prevTap=m,r.tapTime=m.timeStamp}return h}function ih(e,i){var r=e.interaction,n=e.pointer,a=e.event,s=e.eventTarget,o=e.type,l=r.getPointerIndex(n),c=r.pointers[l];if("tap"===o&&(r.pointerWasMoved||!c||c.downTarget!==s))return[];for(var h=K(s),u={interaction:r,pointer:n,event:a,eventTarget:s,type:o,path:h,targets:[],node:null},d=0;d<h.length;d++)u.node=h[d],i.fire("pointerEvents:collect-targets",u);return"hold"===o&&(u.targets=u.targets.filter(function(e){var i,n;return e.eventable.options.holdDuration===(null==(i=r.pointers[l])||null==(n=i.hold)?void 0:n.duration)})),u.targets}function iu(e){var i=e.interaction,r=e.pointerIndex,n=i.pointers[r].hold;n&&n.timeout&&(clearTimeout(n.timeout),n.timeout=null)}var id=Object.freeze({__proto__:null,default:il});function ip(e){var i=e.interaction;i.holdIntervalHandle&&(clearInterval(i.holdIntervalHandle),i.holdIntervalHandle=null)}var im={id:"pointer-events/holdRepeat",install:function(e){e.usePlugin(il);var i=e.pointerEvents;i.defaults.holdRepeatInterval=0,i.types.holdrepeat=e.actions.phaselessTypes.holdrepeat=!0},listeners:["move","up","cancel","endall"].reduce(function(e,i){return e["pointerEvents:".concat(i)]=ip,e},{"pointerEvents:new":function(e){var i=e.pointerEvent;"hold"===i.type&&(i.count=(i.count||0)+1)},"pointerEvents:fired":function(e,i){var r=e.interaction,n=e.pointerEvent,a=e.eventTarget,s=e.targets;if("hold"===n.type&&s.length){var o=s[0].eventable.options.holdRepeatInterval;o<=0||(r.holdIntervalHandle=setTimeout(function(){i.pointerEvents.fire({interaction:r,eventTarget:a,type:"hold",pointer:n,event:n},i)},o))}}})},ig={id:"pointer-events/interactableTargets",install:function(e){var i=e.Interactable;i.prototype.pointerEvents=function(e){return Z(this.events.options,e),this};var r=i.prototype._backCompatOption;i.prototype._backCompatOption=function(e,i){var n=r.call(this,e,i);return n===this&&(this.events.options[e]=i),n}},listeners:{"pointerEvents:collect-targets":function(e,i){var r=e.targets,n=e.node,a=e.type,s=e.eventTarget;i.interactables.forEachMatch(n,function(e){var i=e.events,o=i.options;i.types[a]&&i.types[a].length&&e.testIgnoreAllow(o,n,s)&&r.push({node:n,eventable:i,props:{interactable:e}})})},"interactable:new":function(e){var i=e.interactable;i.events.getRect=function(e){return i.getRect(e)}},"interactable:set":function(e,i){var r=e.interactable,n=e.options;Z(r.events.options,i.pointerEvents.defaults),Z(r.events.options,n.pointerEvents||{})}}};if(tW.use(tr),tW.use(tS),tW.use({id:"pointer-events",install:function(e){e.usePlugin(id),e.usePlugin(im),e.usePlugin(ig)}}),tW.use({id:"inertia",before:["modifiers","actions"],install:function(e){var i=e.defaults;e.usePlugin(tS),e.usePlugin(th),e.actions.phases.inertiastart=!0,e.actions.phases.resume=!0,i.perAction.inertia={enabled:!1,resistance:10,minSpeed:100,endSpeed:10,allowResume:!0,smoothEndDuration:300}},listeners:{"interactions:new":function(e){var i=e.interaction;i.inertia=new tb(i)},"interactions:before-action-end":function(e){var i=e.interaction,r=e.event;return(!i._interacting||i.simulation||!i.inertia.start(r))&&null},"interactions:down":function(e){var i=e.interaction,r=e.eventTarget,n=i.inertia;if(n.active)for(var a=r;P(a);){if(a===i.element){n.resume(e);break}a=V(a)}},"interactions:stop":function(e){var i=e.interaction.inertia;i.active&&i.stop()},"interactions:before-action-resume":function(e){var i=e.interaction.modification;i.stop(e),i.start(e,e.interaction.coords.cur.page),i.applyToInteraction(e)},"interactions:before-action-inertiastart":function(e){return e.interaction.modification.setAndApply(e)},"interactions:action-resume":tc,"interactions:action-inertiastart":tc,"interactions:after-action-inertiastart":function(e){return e.interaction.modification.restoreInteractionCoords(e)},"interactions:after-action-resume":function(e){return e.interaction.modification.restoreInteractionCoords(e)}}}),tW.use({id:"modifiers",install:function(e){var i=e.interactStatic;for(var r in e.usePlugin(th),e.usePlugin(tq),i.modifiers=is,is){var n=is[r],a=n._defaults;a._methods=n._methods,e.defaults.perAction[r]=a}}}),tW.use({id:"auto-start",install:function(e){e.usePlugin(e8),e.usePlugin(te),e.usePlugin(e9)}}),tW.use({id:"actions",install:function(e){e.usePlugin(eO),e.usePlugin(ek),e.usePlugin(N),e.usePlugin(eU)}}),tW.use(eY),tW.use({id:"reflow",install:function(e){var i=e.Interactable;e.actions.phases.reflow=!0,i.prototype.reflow=function(i){return function(e,i,r){for(var n=e.getAllElements(),a=r.window.Promise,s=a?[]:null,o=0;o<n.length&&!function(){var l=n[o],c=e.getRect(l);if(!c)return 1;var h,u=ew(r.interactions.list,function(r){return r.interacting()&&r.interactable===e&&r.element===l&&r.prepared.name===i.name});if(u)u.move(),s&&(h=u._reflowPromise||new a(function(e){u._reflowResolve=e}));else{var d,p,f,m,g=et(c),v={coords:{page:{x:g.x,y:g.y},client:{x:g.x,y:g.y},timeStamp:r.now()},get page(){return this.coords.page},get client(){return this.coords.client},get timeStamp(){return this.coords.timeStamp},get pageX(){return this.coords.page.x},get pageY(){return this.coords.page.y},get clientX(){return this.coords.client.x},get clientY(){return this.coords.client.y},get pointerId(){return this.coords.pointerId},get target(){return this.coords.target},get type(){return this.coords.type},get pointerType(){return this.coords.pointerType},get buttons(){return this.coords.buttons},preventDefault:function(){}};p={interaction:d=r.interactions.new({pointerType:"reflow"}),event:v,pointer:v,eventTarget:l,phase:"reflow"},d.interactable=e,d.element=l,d.prevEvent=v,d.updatePointer(v,v,l,!0),eh(d.coords.delta),eJ(d.prepared,i),d._doPhase(p),m=(f=r.window.Promise)?new f(function(e){d._reflowResolve=e}):void 0,d._reflowPromise=m,d.start(i,e,l),d._interacting?(d.move(p),d.end(v)):(d.stop(),d._reflowResolve()),d.removePointer(v,v),h=m}s&&s.push(h)}();o++);return s&&a.all(s).then(function(){return e})}(this,i,e)}},listeners:{"interactions:stop":function(e,i){var r,n=e.interaction;"reflow"===n.pointerType&&(n._reflowResolve&&n._reflowResolve(),r=i.interactions.list,r.splice(r.indexOf(n),1))}}}),tW.default=tW,"object"===n(e)&&e)try{e.exports=tW}catch(e){}return tW.default=tW,tW}()},"./node_modules/jsoncrush/JSONCrush.js"(e,i,r){"use strict";r.d(i,{A:()=>n});let n={crush:(e,i=50)=>{let r=[];for(let e=127;--e;)(e>=48&&e<=57||e>=65&&e<=90||e>=97&&e<=122||"-_.!~*'()".includes(String.fromCharCode(e)))&&r.push(String.fromCharCode(e));for(let e=32;e<255;++e){let i=String.fromCharCode(e);"\\"==i||r.includes(i)||r.unshift(i)}let n=((e,r)=>{let n=r.length,a="",s=e=>encodeURI(encodeURIComponent(e)).replace(/%../g,"i").length,o=e=>{let i=e.charCodeAt(0),r=e.charCodeAt(e.length-1);return i>=56320&&i<=57343||r>=55296&&r<=56319},l={};for(let r=2;r<i;r++)for(let i=0;i<e.length-r;++i){let n=e.substr(i,r);if(l[n]||o(n))continue;let a=1;for(let s=e.indexOf(n,i+r);s>=0;++a)s=e.indexOf(n,s+r);a>1&&(l[n]=a)}for(;;){let i;for(;n--&&e.includes(r[n]););if(n<0)break;let o=r[n],c=0,h=s(o);for(let e in l){let r=l[e],n=(r-1)*s(e)-(r+1)*h;a.length||(n-=s("\x01")),n<=0?delete l[e]:n>c&&(i=e,c=n)}if(!i)break;e=e.split(i).join(o)+o+i,a=o+a;let u={};for(let r in l){let n=r.split(i).join(o),a=0;for(let i=e.indexOf(n);i>=0;++a)i=e.indexOf(n,i+n.length);a>1&&(u[n]=a)}l=u}return{a:e,b:a}})(e=a(e=e.replace(RegExp("\x01","g"),"")),r),s=n.a;return n.b.length&&(s+="\x01"+n.b),s+="_"},uncrush:e=>{let i=(e=e.substring(0,e.length-1)).split("\x01"),r=i[0];if(i.length>1)for(let e of i[1]){let i=r.split(e);r=i.join(i.pop())}return a(r,0)}},a=(e,i=1)=>{let r=[['"',"'"],["':","!"],[",'","~"],["}",")","\\","\\"],["{","(","\\","\\"]],n=(e,i)=>{let r=RegExp(`${(i[2]?i[2]:"")+i[0]}|${(i[3]?i[3]:"")+i[1]}`,"g");return e.replace(r,e=>e===i[0]?i[1]:i[0])};if(i)for(let i=0;i<r.length;++i)e=n(e,r[i]);else for(let i=r.length;i--;)e=n(e,r[i]);return e}},"./node_modules/three/build/three.core.js"(e,i,r){"use strict";let n,a,s,o,l,c,h,u;r.d(i,{$EB:()=>M,$Kf:()=>nz,$Yl:()=>X,$_I:()=>eA,$ei:()=>L,$p8:()=>sb,A$4:()=>rj,AQS:()=>tX,Am1:()=>sR,B69:()=>r_,BH$:()=>au,BKk:()=>np,BVL:()=>e9,BXX:()=>e0,B_h:()=>tr,CSG:()=>aY,CVz:()=>e5,CWW:()=>tS,Cfg:()=>eT,D$Q:()=>aW,DXC:()=>ac,Dmk:()=>ez,E0M:()=>s4,EAD:()=>nG,EZo:()=>T,EdD:()=>w,FCc:()=>ah,FFZ:()=>tH,FV:()=>ec,FXf:()=>C,Fn:()=>tg,FvD:()=>a_,GJx:()=>ey,GOR:()=>ay,GWd:()=>eG,GYF:()=>nk,Gc6:()=>aM,Gwm:()=>$,H23:()=>tv,HIg:()=>eH,HO_:()=>tM,HXV:()=>e2,HgN:()=>ig,HiM:()=>sy,Hit:()=>a6,Ho_:()=>aT,I46:()=>nB,I9Y:()=>ii,IE4:()=>eZ,IUQ:()=>ib,Iit:()=>nl,Jnc:()=>m,K52:()=>ee,KDk:()=>e8,KLL:()=>tU,KRh:()=>er,Kef:()=>ty,Kwu:()=>E,Kzg:()=>sw,LAk:()=>eu,LiQ:()=>O,LlO:()=>nh,LoY:()=>r3,MBL:()=>a9,MW4:()=>rq,Mjd:()=>eo,N1A:()=>aa,NRn:()=>iR,NTi:()=>b,Nex:()=>s5,Nt7:()=>k,Nwf:()=>sW,Nz6:()=>eQ,O49:()=>tw,O9p:()=>rt,ONl:()=>ag,OUM:()=>eR,Om:()=>e_,OtU:()=>te,OuU:()=>B,PJ3:()=>tT,PPD:()=>n6,PTz:()=>ir,Pf$:()=>sO,Pq0:()=>ia,Q1f:()=>rF,QP0:()=>g,Qev:()=>t0,Qrf:()=>ts,R3r:()=>nT,R8M:()=>tJ,RJ4:()=>tE,RQf:()=>eU,RiT:()=>se,Riy:()=>e6,Rm2:()=>tK,RrE:()=>W,RyA:()=>_,S$4:()=>tm,THS:()=>rX,Tap:()=>sh,TdN:()=>tW,TiK:()=>tB,TkQ:()=>eK,U3G:()=>Q,UtX:()=>sA,V3x:()=>eB,V9B:()=>rV,VCu:()=>ax,VT0:()=>ej,Vb5:()=>f,VxR:()=>tD,W9U:()=>t_,WBB:()=>aH,WNZ:()=>p,Wdf:()=>tG,Wew:()=>eO,Wk7:()=>v,XG_:()=>tx,XIg:()=>S,XrR:()=>en,Y9S:()=>so,YJl:()=>nS,Yuy:()=>eL,Z58:()=>nE,ZLX:()=>nQ,ZQM:()=>eq,Zcv:()=>n3,Zr2:()=>tL,ZyN:()=>sS,_4j:()=>aX,_QJ:()=>tc,_Ut:()=>nc,a55:()=>t4,a5J:()=>tl,aEY:()=>H,aHM:()=>sn,aJ8:()=>ed,aVO:()=>aK,amv:()=>tN,b4q:()=>nx,bC7:()=>td,bCz:()=>A,bI3:()=>tR,bdM:()=>aG,bkx:()=>eD,brA:()=>J,bw0:()=>et,c90:()=>eJ,cHt:()=>eI,cZY:()=>s3,caT:()=>ei,cj9:()=>it,czI:()=>tn,dYF:()=>iA,dcC:()=>eX,dwI:()=>il,e0p:()=>j,eB$:()=>nw,eHc:()=>Y,eHs:()=>nR,eaF:()=>nn,eoi:()=>tz,er$:()=>tI,f4X:()=>N,fBL:()=>eP,fP5:()=>sF,g7M:()=>eh,gJ2:()=>eF,gO9:()=>R,gPd:()=>iS,gWB:()=>tV,gZr:()=>e7,ghU:()=>ex,hB5:()=>y,hdd:()=>z,hgQ:()=>G,hsX:()=>x,hxR:()=>eS,hy7:()=>ef,iNn:()=>ns,ie2:()=>F,imn:()=>rk,ix0:()=>eN,iyt:()=>ij,jR7:()=>e$,jSS:()=>tt,jej:()=>t$,jf0:()=>tP,jzd:()=>tk,k6Q:()=>e1,k6q:()=>eE,kLi:()=>i_,kO0:()=>tF,kRr:()=>ew,kTW:()=>eM,kTp:()=>e3,kn4:()=>i1,kyO:()=>es,lGu:()=>K,lGw:()=>a$,lPF:()=>tq,ljd:()=>tb,lxW:()=>no,lyL:()=>tu,mcG:()=>tQ,mrM:()=>n8,nCl:()=>sv,nNL:()=>el,nST:()=>P,nWS:()=>iE,nZQ:()=>sC,o6l:()=>nM,ojh:()=>D,ojs:()=>tf,ov9:()=>q,pBf:()=>e4,pHI:()=>eb,paN:()=>eY,ppV:()=>id,psI:()=>to,qUd:()=>sx,qa3:()=>ti,qad:()=>U,qq$:()=>tj,qtW:()=>rY,r6x:()=>sT,rFo:()=>iw,rSH:()=>ta,rYR:()=>tA,rjZ:()=>aS,sPf:()=>d,tBo:()=>sj,tJf:()=>eC,tXL:()=>aq,tcD:()=>ab,tz3:()=>st,uB5:()=>th,uSd:()=>aj,uV5:()=>ev,uWO:()=>nW,ubm:()=>n_,vim:()=>tO,vyJ:()=>tC,wfO:()=>eg,wn6:()=>V,wrO:()=>eV,xFO:()=>em,xSv:()=>Z,y3Z:()=>tp,yT7:()=>ek,y_p:()=>ea,z3S:()=>tZ,zdS:()=>eW,zgK:()=>ri,znC:()=>I});let d="182",p=0,f=1,m=2,g=1,v=2,_=3,y=0,x=1,M=2,S=0,b=1,T=2,E=3,w=4,A=5,R=100,C=101,P=102,I=103,L=104,D=200,U=201,N=202,O=203,F=204,B=205,z=206,k=207,V=208,H=209,G=210,W=211,X=212,j=213,q=214,Y=0,K=1,J=2,Z=3,Q=4,$=5,ee=6,et=7,ei=0,er=1,en=2,ea=0,es=1,eo=2,el=3,ec=4,eh=5,eu=6,ed=7,ep="attached",ef=301,em=302,eg=303,ev=304,e_=306,ey=1e3,ex=1001,eM=1002,eS=1003,eb=1004,eT=1005,eE=1006,ew=1007,eA=1008,eR=1009,eC=1010,eP=1011,eI=1012,eL=1013,eD=1014,eU=1015,eN=1016,eO=1017,eF=1018,eB=1020,ez=35902,ek=35899,eV=1021,eH=1022,eG=1023,eW=1026,eX=1027,ej=1028,eq=1029,eY=1030,eK=1031,eJ=1033,eZ=33776,eQ=33777,e$=33778,e0=33779,e1=35840,e3=35841,e2=35842,e4=35843,e5=36196,e6=37492,e8=37496,e9=37488,e7=37489,te=37490,tt=37491,ti=37808,tr=37809,tn=37810,ta=37811,ts=37812,to=37813,tl=37814,tc=37815,th=37816,tu=37817,td=37818,tp=37819,tf=37820,tm=37821,tg=36492,tv=36494,t_=36495,ty=36283,tx=36284,tM=36285,tS=36286,tb=2300,tT=2301,tE=0,tw=1,tA=2,tR=0,tC=1,tP="",tI="srgb",tL="srgb-linear",tD="linear",tU="srgb",tN=512,tO=513,tF=514,tB=515,tz=516,tk=517,tV=518,tH=519,tG="300 es",tW=2e3;function tX(e){for(let i=e.length-1;i>=0;--i)if(e[i]>=65535)return!0;return!1}function tj(e){return document.createElementNS("http://www.w3.org/1999/xhtml",e)}function tq(){let e=tj("canvas");return e.style.display="block",e}Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array;let tY={};function tK(...e){console.log("THREE."+e.shift(),...e)}function tJ(...e){console.warn("THREE."+e.shift(),...e)}function tZ(...e){console.error("THREE."+e.shift(),...e)}function tQ(...e){let i=e.join(" ");i in tY||(tY[i]=!0,tJ(...e))}function t$(e,i,r){return new Promise(function(n,a){setTimeout(function s(){switch(e.clientWaitSync(i,e.SYNC_FLUSH_COMMANDS_BIT,0)){case e.WAIT_FAILED:a();break;case e.TIMEOUT_EXPIRED:setTimeout(s,r);break;default:n()}},r)})}class t0{addEventListener(e,i){void 0===this._listeners&&(this._listeners={});let r=this._listeners;void 0===r[e]&&(r[e]=[]),-1===r[e].indexOf(i)&&r[e].push(i)}hasEventListener(e,i){let r=this._listeners;return void 0!==r&&void 0!==r[e]&&-1!==r[e].indexOf(i)}removeEventListener(e,i){let r=this._listeners;if(void 0===r)return;let n=r[e];if(void 0!==n){let e=n.indexOf(i);-1!==e&&n.splice(e,1)}}dispatchEvent(e){let i=this._listeners;if(void 0===i)return;let r=i[e.type];if(void 0!==r){e.target=this;let i=r.slice(0);for(let r=0,n=i.length;r<n;r++)i[r].call(this,e);e.target=null}}}let t1=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"],t3=1234567,t2=Math.PI/180,t4=180/Math.PI;function t5(){let e=0xffffffff*Math.random()|0,i=0xffffffff*Math.random()|0,r=0xffffffff*Math.random()|0,n=0xffffffff*Math.random()|0;return(t1[255&e]+t1[e>>8&255]+t1[e>>16&255]+t1[e>>24&255]+"-"+t1[255&i]+t1[i>>8&255]+"-"+t1[i>>16&15|64]+t1[i>>24&255]+"-"+t1[63&r|128]+t1[r>>8&255]+"-"+t1[r>>16&255]+t1[r>>24&255]+t1[255&n]+t1[n>>8&255]+t1[n>>16&255]+t1[n>>24&255]).toLowerCase()}function t6(e,i,r){return Math.max(i,Math.min(r,e))}function t8(e,i){return(e%i+i)%i}function t9(e,i,r){return(1-r)*e+r*i}function t7(e,i){switch(i.constructor){case Float32Array:return e;case Uint32Array:return e/0xffffffff;case Uint16Array:return e/65535;case Uint8Array:return e/255;case Int32Array:return Math.max(e/0x7fffffff,-1);case Int16Array:return Math.max(e/32767,-1);case Int8Array:return Math.max(e/127,-1);default:throw Error("Invalid component type.")}}function ie(e,i){switch(i.constructor){case Float32Array:return e;case Uint32Array:return Math.round(0xffffffff*e);case Uint16Array:return Math.round(65535*e);case Uint8Array:return Math.round(255*e);case Int32Array:return Math.round(0x7fffffff*e);case Int16Array:return Math.round(32767*e);case Int8Array:return Math.round(127*e);default:throw Error("Invalid component type.")}}let it={DEG2RAD:t2,RAD2DEG:t4,generateUUID:t5,clamp:t6,euclideanModulo:t8,mapLinear:function(e,i,r,n,a){return n+(e-i)*(a-n)/(r-i)},inverseLerp:function(e,i,r){return e!==i?(r-e)/(i-e):0},lerp:t9,damp:function(e,i,r,n){return t9(e,i,1-Math.exp(-r*n))},pingpong:function(e,i=1){return i-Math.abs(t8(e,2*i)-i)},smoothstep:function(e,i,r){return e<=i?0:e>=r?1:(e=(e-i)/(r-i))*e*(3-2*e)},smootherstep:function(e,i,r){return e<=i?0:e>=r?1:(e=(e-i)/(r-i))*e*e*(e*(6*e-15)+10)},randInt:function(e,i){return e+Math.floor(Math.random()*(i-e+1))},randFloat:function(e,i){return e+Math.random()*(i-e)},randFloatSpread:function(e){return e*(.5-Math.random())},seededRandom:function(e){void 0!==e&&(t3=e);let i=t3+=0x6d2b79f5;return i=Math.imul(i^i>>>15,1|i),(((i^=i+Math.imul(i^i>>>7,61|i))^i>>>14)>>>0)/0x100000000},degToRad:function(e){return e*t2},radToDeg:function(e){return e*t4},isPowerOfTwo:function(e){return(e&e-1)==0&&0!==e},ceilPowerOfTwo:function(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))},floorPowerOfTwo:function(e){return Math.pow(2,Math.floor(Math.log(e)/Math.LN2))},setQuaternionFromProperEuler:function(e,i,r,n,a){let s=Math.cos,o=Math.sin,l=s(r/2),c=o(r/2),h=s((i+n)/2),u=o((i+n)/2),d=s((i-n)/2),p=o((i-n)/2),f=s((n-i)/2),m=o((n-i)/2);switch(a){case"XYX":e.set(l*u,c*d,c*p,l*h);break;case"YZY":e.set(c*p,l*u,c*d,l*h);break;case"ZXZ":e.set(c*d,c*p,l*u,l*h);break;case"XZX":e.set(l*u,c*m,c*f,l*h);break;case"YXY":e.set(c*f,l*u,c*m,l*h);break;case"ZYZ":e.set(c*m,c*f,l*u,l*h);break;default:tJ("MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+a)}},normalize:ie,denormalize:t7};class ii{constructor(e=0,i=0){ii.prototype.isVector2=!0,this.x=e,this.y=i}get width(){return this.x}set width(e){this.x=e}get height(){return this.y}set height(e){this.y=e}set(e,i){return this.x=e,this.y=i,this}setScalar(e){return this.x=e,this.y=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setComponent(e,i){switch(e){case 0:this.x=i;break;case 1:this.y=i;break;default:throw Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}add(e){return this.x+=e.x,this.y+=e.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addVectors(e,i){return this.x=e.x+i.x,this.y=e.y+i.y,this}addScaledVector(e,i){return this.x+=e.x*i,this.y+=e.y*i,this}sub(e){return this.x-=e.x,this.y-=e.y,this}subScalar(e){return this.x-=e,this.y-=e,this}subVectors(e,i){return this.x=e.x-i.x,this.y=e.y-i.y,this}multiply(e){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e){return this.x*=e,this.y*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this}divideScalar(e){return this.multiplyScalar(1/e)}applyMatrix3(e){let i=this.x,r=this.y,n=e.elements;return this.x=n[0]*i+n[3]*r+n[6],this.y=n[1]*i+n[4]*r+n[7],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}clamp(e,i){return this.x=t6(this.x,e.x,i.x),this.y=t6(this.y,e.y,i.y),this}clampScalar(e,i){return this.x=t6(this.x,e,i),this.y=t6(this.y,e,i),this}clampLength(e,i){let r=this.length();return this.divideScalar(r||1).multiplyScalar(t6(r,e,i))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(e){let i=Math.sqrt(this.lengthSq()*e.lengthSq());return 0===i?Math.PI/2:Math.acos(t6(this.dot(e)/i,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){let i=this.x-e.x,r=this.y-e.y;return i*i+r*r}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,i){return this.x+=(e.x-this.x)*i,this.y+=(e.y-this.y)*i,this}lerpVectors(e,i,r){return this.x=e.x+(i.x-e.x)*r,this.y=e.y+(i.y-e.y)*r,this}equals(e){return e.x===this.x&&e.y===this.y}fromArray(e,i=0){return this.x=e[i],this.y=e[i+1],this}toArray(e=[],i=0){return e[i]=this.x,e[i+1]=this.y,e}fromBufferAttribute(e,i){return this.x=e.getX(i),this.y=e.getY(i),this}rotateAround(e,i){let r=Math.cos(i),n=Math.sin(i),a=this.x-e.x,s=this.y-e.y;return this.x=a*r-s*n+e.x,this.y=a*n+s*r+e.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class ir{constructor(e=0,i=0,r=0,n=1){this.isQuaternion=!0,this._x=e,this._y=i,this._z=r,this._w=n}static slerpFlat(e,i,r,n,a,s,o){let l=r[n+0],c=r[n+1],h=r[n+2],u=r[n+3],d=a[s+0],p=a[s+1],f=a[s+2],m=a[s+3];if(o<=0){e[i+0]=l,e[i+1]=c,e[i+2]=h,e[i+3]=u;return}if(o>=1){e[i+0]=d,e[i+1]=p,e[i+2]=f,e[i+3]=m;return}if(u!==m||l!==d||c!==p||h!==f){let e=l*d+c*p+h*f+u*m;e<0&&(d=-d,p=-p,f=-f,m=-m,e=-e);let i=1-o;if(e<.9995){let r=Math.acos(e),n=Math.sin(r);l=l*(i=Math.sin(i*r)/n)+d*(o=Math.sin(o*r)/n),c=c*i+p*o,h=h*i+f*o,u=u*i+m*o}else{let e=1/Math.sqrt((l=l*i+d*o)*l+(c=c*i+p*o)*c+(h=h*i+f*o)*h+(u=u*i+m*o)*u);l*=e,c*=e,h*=e,u*=e}}e[i]=l,e[i+1]=c,e[i+2]=h,e[i+3]=u}static multiplyQuaternionsFlat(e,i,r,n,a,s){let o=r[n],l=r[n+1],c=r[n+2],h=r[n+3],u=a[s],d=a[s+1],p=a[s+2],f=a[s+3];return e[i]=o*f+h*u+l*p-c*d,e[i+1]=l*f+h*d+c*u-o*p,e[i+2]=c*f+h*p+o*d-l*u,e[i+3]=h*f-o*u-l*d-c*p,e}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get w(){return this._w}set w(e){this._w=e,this._onChangeCallback()}set(e,i,r,n){return this._x=e,this._y=i,this._z=r,this._w=n,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onChangeCallback(),this}setFromEuler(e,i=!0){let r=e._x,n=e._y,a=e._z,s=e._order,o=Math.cos,l=Math.sin,c=o(r/2),h=o(n/2),u=o(a/2),d=l(r/2),p=l(n/2),f=l(a/2);switch(s){case"XYZ":this._x=d*h*u+c*p*f,this._y=c*p*u-d*h*f,this._z=c*h*f+d*p*u,this._w=c*h*u-d*p*f;break;case"YXZ":this._x=d*h*u+c*p*f,this._y=c*p*u-d*h*f,this._z=c*h*f-d*p*u,this._w=c*h*u+d*p*f;break;case"ZXY":this._x=d*h*u-c*p*f,this._y=c*p*u+d*h*f,this._z=c*h*f+d*p*u,this._w=c*h*u-d*p*f;break;case"ZYX":this._x=d*h*u-c*p*f,this._y=c*p*u+d*h*f,this._z=c*h*f-d*p*u,this._w=c*h*u+d*p*f;break;case"YZX":this._x=d*h*u+c*p*f,this._y=c*p*u+d*h*f,this._z=c*h*f-d*p*u,this._w=c*h*u-d*p*f;break;case"XZY":this._x=d*h*u-c*p*f,this._y=c*p*u-d*h*f,this._z=c*h*f+d*p*u,this._w=c*h*u+d*p*f;break;default:tJ("Quaternion: .setFromEuler() encountered an unknown order: "+s)}return!0===i&&this._onChangeCallback(),this}setFromAxisAngle(e,i){let r=i/2,n=Math.sin(r);return this._x=e.x*n,this._y=e.y*n,this._z=e.z*n,this._w=Math.cos(r),this._onChangeCallback(),this}setFromRotationMatrix(e){let i=e.elements,r=i[0],n=i[4],a=i[8],s=i[1],o=i[5],l=i[9],c=i[2],h=i[6],u=i[10],d=r+o+u;if(d>0){let e=.5/Math.sqrt(d+1);this._w=.25/e,this._x=(h-l)*e,this._y=(a-c)*e,this._z=(s-n)*e}else if(r>o&&r>u){let e=2*Math.sqrt(1+r-o-u);this._w=(h-l)/e,this._x=.25*e,this._y=(n+s)/e,this._z=(a+c)/e}else if(o>u){let e=2*Math.sqrt(1+o-r-u);this._w=(a-c)/e,this._x=(n+s)/e,this._y=.25*e,this._z=(l+h)/e}else{let e=2*Math.sqrt(1+u-r-o);this._w=(s-n)/e,this._x=(a+c)/e,this._y=(l+h)/e,this._z=.25*e}return this._onChangeCallback(),this}setFromUnitVectors(e,i){let r=e.dot(i)+1;return r<1e-8?(r=0,Math.abs(e.x)>Math.abs(e.z)?(this._x=-e.y,this._y=e.x,this._z=0):(this._x=0,this._y=-e.z,this._z=e.y)):(this._x=e.y*i.z-e.z*i.y,this._y=e.z*i.x-e.x*i.z,this._z=e.x*i.y-e.y*i.x),this._w=r,this.normalize()}angleTo(e){return 2*Math.acos(Math.abs(t6(this.dot(e),-1,1)))}rotateTowards(e,i){let r=this.angleTo(e);if(0===r)return this;let n=Math.min(1,i/r);return this.slerp(e,n),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this._onChangeCallback(),this}multiply(e){return this.multiplyQuaternions(this,e)}premultiply(e){return this.multiplyQuaternions(e,this)}multiplyQuaternions(e,i){let r=e._x,n=e._y,a=e._z,s=e._w,o=i._x,l=i._y,c=i._z,h=i._w;return this._x=r*h+s*o+n*c-a*l,this._y=n*h+s*l+a*o-r*c,this._z=a*h+s*c+r*l-n*o,this._w=s*h-r*o-n*l-a*c,this._onChangeCallback(),this}slerp(e,i){if(i<=0)return this;if(i>=1)return this.copy(e);let r=e._x,n=e._y,a=e._z,s=e._w,o=this.dot(e);o<0&&(r=-r,n=-n,a=-a,s=-s,o=-o);let l=1-i;if(o<.9995){let e=Math.acos(o),c=Math.sin(e);l=Math.sin(l*e)/c,i=Math.sin(i*e)/c,this._x=this._x*l+r*i,this._y=this._y*l+n*i,this._z=this._z*l+a*i,this._w=this._w*l+s*i,this._onChangeCallback()}else this._x=this._x*l+r*i,this._y=this._y*l+n*i,this._z=this._z*l+a*i,this._w=this._w*l+s*i,this.normalize();return this}slerpQuaternions(e,i,r){return this.copy(e).slerp(i,r)}random(){let e=2*Math.PI*Math.random(),i=2*Math.PI*Math.random(),r=Math.random(),n=Math.sqrt(1-r),a=Math.sqrt(r);return this.set(n*Math.sin(e),n*Math.cos(e),a*Math.sin(i),a*Math.cos(i))}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w}fromArray(e,i=0){return this._x=e[i],this._y=e[i+1],this._z=e[i+2],this._w=e[i+3],this._onChangeCallback(),this}toArray(e=[],i=0){return e[i]=this._x,e[i+1]=this._y,e[i+2]=this._z,e[i+3]=this._w,e}fromBufferAttribute(e,i){return this._x=e.getX(i),this._y=e.getY(i),this._z=e.getZ(i),this._w=e.getW(i),this._onChangeCallback(),this}toJSON(){return this.toArray()}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class ia{constructor(e=0,i=0,r=0){ia.prototype.isVector3=!0,this.x=e,this.y=i,this.z=r}set(e,i,r){return void 0===r&&(r=this.z),this.x=e,this.y=i,this.z=r,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,i){switch(e){case 0:this.x=i;break;case 1:this.y=i;break;case 2:this.z=i;break;default:throw Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,i){return this.x=e.x+i.x,this.y=e.y+i.y,this.z=e.z+i.z,this}addScaledVector(e,i){return this.x+=e.x*i,this.y+=e.y*i,this.z+=e.z*i,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,i){return this.x=e.x-i.x,this.y=e.y-i.y,this.z=e.z-i.z,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,i){return this.x=e.x*i.x,this.y=e.y*i.y,this.z=e.z*i.z,this}applyEuler(e){return this.applyQuaternion(io.setFromEuler(e))}applyAxisAngle(e,i){return this.applyQuaternion(io.setFromAxisAngle(e,i))}applyMatrix3(e){let i=this.x,r=this.y,n=this.z,a=e.elements;return this.x=a[0]*i+a[3]*r+a[6]*n,this.y=a[1]*i+a[4]*r+a[7]*n,this.z=a[2]*i+a[5]*r+a[8]*n,this}applyNormalMatrix(e){return this.applyMatrix3(e).normalize()}applyMatrix4(e){let i=this.x,r=this.y,n=this.z,a=e.elements,s=1/(a[3]*i+a[7]*r+a[11]*n+a[15]);return this.x=(a[0]*i+a[4]*r+a[8]*n+a[12])*s,this.y=(a[1]*i+a[5]*r+a[9]*n+a[13])*s,this.z=(a[2]*i+a[6]*r+a[10]*n+a[14])*s,this}applyQuaternion(e){let i=this.x,r=this.y,n=this.z,a=e.x,s=e.y,o=e.z,l=e.w,c=2*(s*n-o*r),h=2*(o*i-a*n),u=2*(a*r-s*i);return this.x=i+l*c+s*u-o*h,this.y=r+l*h+o*c-a*u,this.z=n+l*u+a*h-s*c,this}project(e){return this.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix)}unproject(e){return this.applyMatrix4(e.projectionMatrixInverse).applyMatrix4(e.matrixWorld)}transformDirection(e){let i=this.x,r=this.y,n=this.z,a=e.elements;return this.x=a[0]*i+a[4]*r+a[8]*n,this.y=a[1]*i+a[5]*r+a[9]*n,this.z=a[2]*i+a[6]*r+a[10]*n,this.normalize()}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}clamp(e,i){return this.x=t6(this.x,e.x,i.x),this.y=t6(this.y,e.y,i.y),this.z=t6(this.z,e.z,i.z),this}clampScalar(e,i){return this.x=t6(this.x,e,i),this.y=t6(this.y,e,i),this.z=t6(this.z,e,i),this}clampLength(e,i){let r=this.length();return this.divideScalar(r||1).multiplyScalar(t6(r,e,i))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,i){return this.x+=(e.x-this.x)*i,this.y+=(e.y-this.y)*i,this.z+=(e.z-this.z)*i,this}lerpVectors(e,i,r){return this.x=e.x+(i.x-e.x)*r,this.y=e.y+(i.y-e.y)*r,this.z=e.z+(i.z-e.z)*r,this}cross(e){return this.crossVectors(this,e)}crossVectors(e,i){let r=e.x,n=e.y,a=e.z,s=i.x,o=i.y,l=i.z;return this.x=n*l-a*o,this.y=a*s-r*l,this.z=r*o-n*s,this}projectOnVector(e){let i=e.lengthSq();if(0===i)return this.set(0,0,0);let r=e.dot(this)/i;return this.copy(e).multiplyScalar(r)}projectOnPlane(e){return is.copy(this).projectOnVector(e),this.sub(is)}reflect(e){return this.sub(is.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){let i=Math.sqrt(this.lengthSq()*e.lengthSq());return 0===i?Math.PI/2:Math.acos(t6(this.dot(e)/i,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){let i=this.x-e.x,r=this.y-e.y,n=this.z-e.z;return i*i+r*r+n*n}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)}setFromSpherical(e){return this.setFromSphericalCoords(e.radius,e.phi,e.theta)}setFromSphericalCoords(e,i,r){let n=Math.sin(i)*e;return this.x=n*Math.sin(r),this.y=Math.cos(i)*e,this.z=n*Math.cos(r),this}setFromCylindrical(e){return this.setFromCylindricalCoords(e.radius,e.theta,e.y)}setFromCylindricalCoords(e,i,r){return this.x=e*Math.sin(i),this.y=r,this.z=e*Math.cos(i),this}setFromMatrixPosition(e){let i=e.elements;return this.x=i[12],this.y=i[13],this.z=i[14],this}setFromMatrixScale(e){let i=this.setFromMatrixColumn(e,0).length(),r=this.setFromMatrixColumn(e,1).length(),n=this.setFromMatrixColumn(e,2).length();return this.x=i,this.y=r,this.z=n,this}setFromMatrixColumn(e,i){return this.fromArray(e.elements,4*i)}setFromMatrix3Column(e,i){return this.fromArray(e.elements,3*i)}setFromEuler(e){return this.x=e._x,this.y=e._y,this.z=e._z,this}setFromColor(e){return this.x=e.r,this.y=e.g,this.z=e.b,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,i=0){return this.x=e[i],this.y=e[i+1],this.z=e[i+2],this}toArray(e=[],i=0){return e[i]=this.x,e[i+1]=this.y,e[i+2]=this.z,e}fromBufferAttribute(e,i){return this.x=e.getX(i),this.y=e.getY(i),this.z=e.getZ(i),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){let e=Math.random()*Math.PI*2,i=2*Math.random()-1,r=Math.sqrt(1-i*i);return this.x=r*Math.cos(e),this.y=i,this.z=r*Math.sin(e),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}let is=new ia,io=new ir;class il{constructor(e,i,r,n,a,s,o,l,c){il.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],void 0!==e&&this.set(e,i,r,n,a,s,o,l,c)}set(e,i,r,n,a,s,o,l,c){let h=this.elements;return h[0]=e,h[1]=n,h[2]=o,h[3]=i,h[4]=a,h[5]=l,h[6]=r,h[7]=s,h[8]=c,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(e){let i=this.elements,r=e.elements;return i[0]=r[0],i[1]=r[1],i[2]=r[2],i[3]=r[3],i[4]=r[4],i[5]=r[5],i[6]=r[6],i[7]=r[7],i[8]=r[8],this}extractBasis(e,i,r){return e.setFromMatrix3Column(this,0),i.setFromMatrix3Column(this,1),r.setFromMatrix3Column(this,2),this}setFromMatrix4(e){let i=e.elements;return this.set(i[0],i[4],i[8],i[1],i[5],i[9],i[2],i[6],i[10]),this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,i){let r=e.elements,n=i.elements,a=this.elements,s=r[0],o=r[3],l=r[6],c=r[1],h=r[4],u=r[7],d=r[2],p=r[5],f=r[8],m=n[0],g=n[3],v=n[6],_=n[1],y=n[4],x=n[7],M=n[2],S=n[5],b=n[8];return a[0]=s*m+o*_+l*M,a[3]=s*g+o*y+l*S,a[6]=s*v+o*x+l*b,a[1]=c*m+h*_+u*M,a[4]=c*g+h*y+u*S,a[7]=c*v+h*x+u*b,a[2]=d*m+p*_+f*M,a[5]=d*g+p*y+f*S,a[8]=d*v+p*x+f*b,this}multiplyScalar(e){let i=this.elements;return i[0]*=e,i[3]*=e,i[6]*=e,i[1]*=e,i[4]*=e,i[7]*=e,i[2]*=e,i[5]*=e,i[8]*=e,this}determinant(){let e=this.elements,i=e[0],r=e[1],n=e[2],a=e[3],s=e[4],o=e[5],l=e[6],c=e[7],h=e[8];return i*s*h-i*o*c-r*a*h+r*o*l+n*a*c-n*s*l}invert(){let e=this.elements,i=e[0],r=e[1],n=e[2],a=e[3],s=e[4],o=e[5],l=e[6],c=e[7],h=e[8],u=h*s-o*c,d=o*l-h*a,p=c*a-s*l,f=i*u+r*d+n*p;if(0===f)return this.set(0,0,0,0,0,0,0,0,0);let m=1/f;return e[0]=u*m,e[1]=(n*c-h*r)*m,e[2]=(o*r-n*s)*m,e[3]=d*m,e[4]=(h*i-n*l)*m,e[5]=(n*a-o*i)*m,e[6]=p*m,e[7]=(r*l-c*i)*m,e[8]=(s*i-r*a)*m,this}transpose(){let e,i=this.elements;return e=i[1],i[1]=i[3],i[3]=e,e=i[2],i[2]=i[6],i[6]=e,e=i[5],i[5]=i[7],i[7]=e,this}getNormalMatrix(e){return this.setFromMatrix4(e).invert().transpose()}transposeIntoArray(e){let i=this.elements;return e[0]=i[0],e[1]=i[3],e[2]=i[6],e[3]=i[1],e[4]=i[4],e[5]=i[7],e[6]=i[2],e[7]=i[5],e[8]=i[8],this}setUvTransform(e,i,r,n,a,s,o){let l=Math.cos(a),c=Math.sin(a);return this.set(r*l,r*c,-r*(l*s+c*o)+s+e,-n*c,n*l,-n*(-c*s+l*o)+o+i,0,0,1),this}scale(e,i){return this.premultiply(ic.makeScale(e,i)),this}rotate(e){return this.premultiply(ic.makeRotation(-e)),this}translate(e,i){return this.premultiply(ic.makeTranslation(e,i)),this}makeTranslation(e,i){return e.isVector2?this.set(1,0,e.x,0,1,e.y,0,0,1):this.set(1,0,e,0,1,i,0,0,1),this}makeRotation(e){let i=Math.cos(e),r=Math.sin(e);return this.set(i,-r,0,r,i,0,0,0,1),this}makeScale(e,i){return this.set(e,0,0,0,i,0,0,0,1),this}equals(e){let i=this.elements,r=e.elements;for(let e=0;e<9;e++)if(i[e]!==r[e])return!1;return!0}fromArray(e,i=0){for(let r=0;r<9;r++)this.elements[r]=e[r+i];return this}toArray(e=[],i=0){let r=this.elements;return e[i]=r[0],e[i+1]=r[1],e[i+2]=r[2],e[i+3]=r[3],e[i+4]=r[4],e[i+5]=r[5],e[i+6]=r[6],e[i+7]=r[7],e[i+8]=r[8],e}clone(){return new this.constructor().fromArray(this.elements)}}let ic=new il,ih=new il().set(.4123908,.3575843,.1804808,.212639,.7151687,.0721923,.0193308,.1191948,.9505322),iu=new il().set(3.2409699,-1.5373832,-.4986108,-.9692436,1.8759675,.0415551,.0556301,-.203977,1.0569715),id=(c=[.64,.33,.3,.6,.15,.06],h=[.2126,.7152,.0722],u=[.3127,.329],(l={enabled:!0,workingColorSpace:tL,spaces:{},convert:function(e,i,r){return!1!==this.enabled&&i!==r&&i&&r&&(this.spaces[i].transfer===tU&&(e.r=ip(e.r),e.g=ip(e.g),e.b=ip(e.b)),this.spaces[i].primaries!==this.spaces[r].primaries&&(e.applyMatrix3(this.spaces[i].toXYZ),e.applyMatrix3(this.spaces[r].fromXYZ)),this.spaces[r].transfer===tU&&(e.r=im(e.r),e.g=im(e.g),e.b=im(e.b))),e},workingToColorSpace:function(e,i){return this.convert(e,this.workingColorSpace,i)},colorSpaceToWorking:function(e,i){return this.convert(e,i,this.workingColorSpace)},getPrimaries:function(e){return this.spaces[e].primaries},getTransfer:function(e){return e===tP?tD:this.spaces[e].transfer},getToneMappingMode:function(e){return this.spaces[e].outputColorSpaceConfig.toneMappingMode||"standard"},getLuminanceCoefficients:function(e,i=this.workingColorSpace){return e.fromArray(this.spaces[i].luminanceCoefficients)},define:function(e){Object.assign(this.spaces,e)},_getMatrix:function(e,i,r){return e.copy(this.spaces[i].toXYZ).multiply(this.spaces[r].fromXYZ)},_getDrawingBufferColorSpace:function(e){return this.spaces[e].outputColorSpaceConfig.drawingBufferColorSpace},_getUnpackColorSpace:function(e=this.workingColorSpace){return this.spaces[e].workingColorSpaceConfig.unpackColorSpace},fromWorkingColorSpace:function(e,i){return tQ("ColorManagement: .fromWorkingColorSpace() has been renamed to .workingToColorSpace()."),l.workingToColorSpace(e,i)},toWorkingColorSpace:function(e,i){return tQ("ColorManagement: .toWorkingColorSpace() has been renamed to .colorSpaceToWorking()."),l.colorSpaceToWorking(e,i)}}).define({[tL]:{primaries:c,whitePoint:u,transfer:tD,toXYZ:ih,fromXYZ:iu,luminanceCoefficients:h,workingColorSpaceConfig:{unpackColorSpace:tI},outputColorSpaceConfig:{drawingBufferColorSpace:tI}},[tI]:{primaries:c,whitePoint:u,transfer:tU,toXYZ:ih,fromXYZ:iu,luminanceCoefficients:h,outputColorSpaceConfig:{drawingBufferColorSpace:tI}}}),l);function ip(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}function im(e){return e<.0031308?12.92*e:1.055*Math.pow(e,.41666)-.055}class ig{static getDataURL(e,i="image/png"){let r;if(/^data:/i.test(e.src)||"u"<typeof HTMLCanvasElement)return e.src;if(e instanceof HTMLCanvasElement)r=e;else{void 0===n&&(n=tj("canvas")),n.width=e.width,n.height=e.height;let i=n.getContext("2d");e instanceof ImageData?i.putImageData(e,0,0):i.drawImage(e,0,0,e.width,e.height),r=n}return r.toDataURL(i)}static sRGBToLinear(e){if("u">typeof HTMLImageElement&&e instanceof HTMLImageElement||"u">typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"u">typeof ImageBitmap&&e instanceof ImageBitmap){let i=tj("canvas");i.width=e.width,i.height=e.height;let r=i.getContext("2d");r.drawImage(e,0,0,e.width,e.height);let n=r.getImageData(0,0,e.width,e.height),a=n.data;for(let e=0;e<a.length;e++)a[e]=255*ip(a[e]/255);return r.putImageData(n,0,0),i}if(!e.data)return tJ("ImageUtils.sRGBToLinear(): Unsupported image type. No color space conversion applied."),e;{let i=e.data.slice(0);for(let e=0;e<i.length;e++)i instanceof Uint8Array||i instanceof Uint8ClampedArray?i[e]=Math.floor(255*ip(i[e]/255)):i[e]=ip(i[e]);return{data:i,width:e.width,height:e.height}}}}let iv=0;class i_{constructor(e=null){this.isSource=!0,Object.defineProperty(this,"id",{value:iv++}),this.uuid=t5(),this.data=e,this.dataReady=!0,this.version=0}getSize(e){let i=this.data;return"u">typeof HTMLVideoElement&&i instanceof HTMLVideoElement?e.set(i.videoWidth,i.videoHeight,0):"u">typeof VideoFrame&&i instanceof VideoFrame?e.set(i.displayHeight,i.displayWidth,0):null!==i?e.set(i.width,i.height,i.depth||0):e.set(0,0,0),e}set needsUpdate(e){!0===e&&this.version++}toJSON(e){let i=void 0===e||"string"==typeof e;if(!i&&void 0!==e.images[this.uuid])return e.images[this.uuid];let r={uuid:this.uuid,url:""},n=this.data;if(null!==n){let e;if(Array.isArray(n)){e=[];for(let i=0,r=n.length;i<r;i++)n[i].isDataTexture?e.push(iy(n[i].image)):e.push(iy(n[i]))}else e=iy(n);r.url=e}return i||(e.images[this.uuid]=r),r}}function iy(e){return"u">typeof HTMLImageElement&&e instanceof HTMLImageElement||"u">typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"u">typeof ImageBitmap&&e instanceof ImageBitmap?ig.getDataURL(e):e.data?{data:Array.from(e.data),width:e.width,height:e.height,type:e.data.constructor.name}:(tJ("Texture: Unable to serialize Texture."),{})}let ix=0,iM=new ia;class iS extends t0{constructor(e=iS.DEFAULT_IMAGE,i=iS.DEFAULT_MAPPING,r=ex,n=ex,a=eE,s=eA,o=eG,l=eR,c=iS.DEFAULT_ANISOTROPY,h=tP){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:ix++}),this.uuid=t5(),this.name="",this.source=new i_(e),this.mipmaps=[],this.mapping=i,this.channel=0,this.wrapS=r,this.wrapT=n,this.magFilter=a,this.minFilter=s,this.anisotropy=c,this.format=o,this.internalFormat=null,this.type=l,this.offset=new ii(0,0),this.repeat=new ii(1,1),this.center=new ii(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new il,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.colorSpace=h,this.userData={},this.updateRanges=[],this.version=0,this.onUpdate=null,this.renderTarget=null,this.isRenderTargetTexture=!1,this.isArrayTexture=!!e&&!!e.depth&&e.depth>1,this.pmremVersion=0}get width(){return this.source.getSize(iM).x}get height(){return this.source.getSize(iM).y}get depth(){return this.source.getSize(iM).z}get image(){return this.source.data}set image(e=null){this.source.data=e}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}addUpdateRange(e,i){this.updateRanges.push({start:e,count:i})}clearUpdateRanges(){this.updateRanges.length=0}clone(){return new this.constructor().copy(this)}copy(e){return this.name=e.name,this.source=e.source,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.channel=e.channel,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.internalFormat=e.internalFormat,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.center.copy(e.center),this.rotation=e.rotation,this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrix.copy(e.matrix),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.colorSpace=e.colorSpace,this.renderTarget=e.renderTarget,this.isRenderTargetTexture=e.isRenderTargetTexture,this.isArrayTexture=e.isArrayTexture,this.userData=JSON.parse(JSON.stringify(e.userData)),this.needsUpdate=!0,this}setValues(e){for(let i in e){let r=e[i];if(void 0===r){tJ(`Texture.setValues(): parameter '${i}' has value of undefined.`);continue}let n=this[i];if(void 0===n){tJ(`Texture.setValues(): property '${i}' does not exist.`);continue}n&&r&&n.isVector2&&r.isVector2||n&&r&&n.isVector3&&r.isVector3||n&&r&&n.isMatrix3&&r.isMatrix3?n.copy(r):this[i]=r}}toJSON(e){let i=void 0===e||"string"==typeof e;if(!i&&void 0!==e.textures[this.uuid])return e.textures[this.uuid];let r={metadata:{version:4.7,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(e).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(r.userData=this.userData),i||(e.textures[this.uuid]=r),r}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(e){if(300!==this.mapping)return e;if(e.applyMatrix3(this.matrix),e.x<0||e.x>1)switch(this.wrapS){case ey:e.x=e.x-Math.floor(e.x);break;case ex:e.x=e.x<0?0:1;break;case eM:1===Math.abs(Math.floor(e.x)%2)?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x)}if(e.y<0||e.y>1)switch(this.wrapT){case ey:e.y=e.y-Math.floor(e.y);break;case ex:e.y=e.y<0?0:1;break;case eM:1===Math.abs(Math.floor(e.y)%2)?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y)}return this.flipY&&(e.y=1-e.y),e}set needsUpdate(e){!0===e&&(this.version++,this.source.needsUpdate=!0)}set needsPMREMUpdate(e){!0===e&&this.pmremVersion++}}iS.DEFAULT_IMAGE=null,iS.DEFAULT_MAPPING=300,iS.DEFAULT_ANISOTROPY=1;class ib{constructor(e=0,i=0,r=0,n=1){ib.prototype.isVector4=!0,this.x=e,this.y=i,this.z=r,this.w=n}get width(){return this.z}set width(e){this.z=e}get height(){return this.w}set height(e){this.w=e}set(e,i,r,n){return this.x=e,this.y=i,this.z=r,this.w=n,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this.w=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setW(e){return this.w=e,this}setComponent(e,i){switch(e){case 0:this.x=i;break;case 1:this.y=i;break;case 2:this.z=i;break;case 3:this.w=i;break;default:throw Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addVectors(e,i){return this.x=e.x+i.x,this.y=e.y+i.y,this.z=e.z+i.z,this.w=e.w+i.w,this}addScaledVector(e,i){return this.x+=e.x*i,this.y+=e.y*i,this.z+=e.z*i,this.w+=e.w*i,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}subVectors(e,i){return this.x=e.x-i.x,this.y=e.y-i.y,this.z=e.z-i.z,this.w=e.w-i.w,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}applyMatrix4(e){let i=this.x,r=this.y,n=this.z,a=this.w,s=e.elements;return this.x=s[0]*i+s[4]*r+s[8]*n+s[12]*a,this.y=s[1]*i+s[5]*r+s[9]*n+s[13]*a,this.z=s[2]*i+s[6]*r+s[10]*n+s[14]*a,this.w=s[3]*i+s[7]*r+s[11]*n+s[15]*a,this}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this}divideScalar(e){return this.multiplyScalar(1/e)}setAxisAngleFromQuaternion(e){this.w=2*Math.acos(e.w);let i=Math.sqrt(1-e.w*e.w);return i<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/i,this.y=e.y/i,this.z=e.z/i),this}setAxisAngleFromRotationMatrix(e){let i,r,n,a,s=e.elements,o=s[0],l=s[4],c=s[8],h=s[1],u=s[5],d=s[9],p=s[2],f=s[6],m=s[10];if(.01>Math.abs(l-h)&&.01>Math.abs(c-p)&&.01>Math.abs(d-f)){if(.1>Math.abs(l+h)&&.1>Math.abs(c+p)&&.1>Math.abs(d+f)&&.1>Math.abs(o+u+m-3))return this.set(1,0,0,0),this;i=Math.PI;let e=(o+1)/2,s=(u+1)/2,g=(m+1)/2,v=(l+h)/4,_=(c+p)/4,y=(d+f)/4;return e>s&&e>g?e<.01?(r=0,n=.707106781,a=.707106781):(n=v/(r=Math.sqrt(e)),a=_/r):s>g?s<.01?(r=.707106781,n=0,a=.707106781):(r=v/(n=Math.sqrt(s)),a=y/n):g<.01?(r=.707106781,n=.707106781,a=0):(r=_/(a=Math.sqrt(g)),n=y/a),this.set(r,n,a,i),this}let g=Math.sqrt((f-d)*(f-d)+(c-p)*(c-p)+(h-l)*(h-l));return .001>Math.abs(g)&&(g=1),this.x=(f-d)/g,this.y=(c-p)/g,this.z=(h-l)/g,this.w=Math.acos((o+u+m-1)/2),this}setFromMatrixPosition(e){let i=e.elements;return this.x=i[12],this.y=i[13],this.z=i[14],this.w=i[15],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this}clamp(e,i){return this.x=t6(this.x,e.x,i.x),this.y=t6(this.y,e.y,i.y),this.z=t6(this.z,e.z,i.z),this.w=t6(this.w,e.w,i.w),this}clampScalar(e,i){return this.x=t6(this.x,e,i),this.y=t6(this.y,e,i),this.z=t6(this.z,e,i),this.w=t6(this.w,e,i),this}clampLength(e,i){let r=this.length();return this.divideScalar(r||1).multiplyScalar(t6(r,e,i))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this.w=Math.trunc(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,i){return this.x+=(e.x-this.x)*i,this.y+=(e.y-this.y)*i,this.z+=(e.z-this.z)*i,this.w+=(e.w-this.w)*i,this}lerpVectors(e,i,r){return this.x=e.x+(i.x-e.x)*r,this.y=e.y+(i.y-e.y)*r,this.z=e.z+(i.z-e.z)*r,this.w=e.w+(i.w-e.w)*r,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,i=0){return this.x=e[i],this.y=e[i+1],this.z=e[i+2],this.w=e[i+3],this}toArray(e=[],i=0){return e[i]=this.x,e[i+1]=this.y,e[i+2]=this.z,e[i+3]=this.w,e}fromBufferAttribute(e,i){return this.x=e.getX(i),this.y=e.getY(i),this.z=e.getZ(i),this.w=e.getW(i),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}class iT extends t0{constructor(e=1,i=1,r={}){super(),r=Object.assign({generateMipmaps:!1,internalFormat:null,minFilter:eE,depthBuffer:!0,stencilBuffer:!1,resolveDepthBuffer:!0,resolveStencilBuffer:!0,depthTexture:null,samples:0,count:1,depth:1,multiview:!1},r),this.isRenderTarget=!0,this.width=e,this.height=i,this.depth=r.depth,this.scissor=new ib(0,0,e,i),this.scissorTest=!1,this.viewport=new ib(0,0,e,i);const n=new iS({width:e,height:i,depth:r.depth});this.textures=[];const a=r.count;for(let e=0;e<a;e++)this.textures[e]=n.clone(),this.textures[e].isRenderTargetTexture=!0,this.textures[e].renderTarget=this;this._setTextureOptions(r),this.depthBuffer=r.depthBuffer,this.stencilBuffer=r.stencilBuffer,this.resolveDepthBuffer=r.resolveDepthBuffer,this.resolveStencilBuffer=r.resolveStencilBuffer,this._depthTexture=null,this.depthTexture=r.depthTexture,this.samples=r.samples,this.multiview=r.multiview}_setTextureOptions(e={}){let i={minFilter:eE,generateMipmaps:!1,flipY:!1,internalFormat:null};void 0!==e.mapping&&(i.mapping=e.mapping),void 0!==e.wrapS&&(i.wrapS=e.wrapS),void 0!==e.wrapT&&(i.wrapT=e.wrapT),void 0!==e.wrapR&&(i.wrapR=e.wrapR),void 0!==e.magFilter&&(i.magFilter=e.magFilter),void 0!==e.minFilter&&(i.minFilter=e.minFilter),void 0!==e.format&&(i.format=e.format),void 0!==e.type&&(i.type=e.type),void 0!==e.anisotropy&&(i.anisotropy=e.anisotropy),void 0!==e.colorSpace&&(i.colorSpace=e.colorSpace),void 0!==e.flipY&&(i.flipY=e.flipY),void 0!==e.generateMipmaps&&(i.generateMipmaps=e.generateMipmaps),void 0!==e.internalFormat&&(i.internalFormat=e.internalFormat);for(let e=0;e<this.textures.length;e++)this.textures[e].setValues(i)}get texture(){return this.textures[0]}set texture(e){this.textures[0]=e}set depthTexture(e){null!==this._depthTexture&&(this._depthTexture.renderTarget=null),null!==e&&(e.renderTarget=this),this._depthTexture=e}get depthTexture(){return this._depthTexture}setSize(e,i,r=1){if(this.width!==e||this.height!==i||this.depth!==r){this.width=e,this.height=i,this.depth=r;for(let n=0,a=this.textures.length;n<a;n++)this.textures[n].image.width=e,this.textures[n].image.height=i,this.textures[n].image.depth=r,!0!==this.textures[n].isData3DTexture&&(this.textures[n].isArrayTexture=this.textures[n].image.depth>1);this.dispose()}this.viewport.set(0,0,e,i),this.scissor.set(0,0,e,i)}clone(){return new this.constructor().copy(this)}copy(e){this.width=e.width,this.height=e.height,this.depth=e.depth,this.scissor.copy(e.scissor),this.scissorTest=e.scissorTest,this.viewport.copy(e.viewport),this.textures.length=0;for(let i=0,r=e.textures.length;i<r;i++){this.textures[i]=e.textures[i].clone(),this.textures[i].isRenderTargetTexture=!0,this.textures[i].renderTarget=this;let r=Object.assign({},e.textures[i].image);this.textures[i].source=new i_(r)}return this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,this.resolveDepthBuffer=e.resolveDepthBuffer,this.resolveStencilBuffer=e.resolveStencilBuffer,null!==e.depthTexture&&(this.depthTexture=e.depthTexture.clone()),this.samples=e.samples,this}dispose(){this.dispatchEvent({type:"dispose"})}}class iE extends iT{constructor(e=1,i=1,r={}){super(e,i,r),this.isWebGLRenderTarget=!0}}class iw extends iS{constructor(e=null,i=1,r=1,n=1){super(null),this.isDataArrayTexture=!0,this.image={data:e,width:i,height:r,depth:n},this.magFilter=eS,this.minFilter=eS,this.wrapR=ex,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.layerUpdates=new Set}addLayerUpdate(e){this.layerUpdates.add(e)}clearLayerUpdates(){this.layerUpdates.clear()}}class iA extends iS{constructor(e=null,i=1,r=1,n=1){super(null),this.isData3DTexture=!0,this.image={data:e,width:i,height:r,depth:n},this.magFilter=eS,this.minFilter=eS,this.wrapR=ex,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class iR{constructor(e=new ia(Infinity,Infinity,Infinity),i=new ia(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=e,this.max=i}set(e,i){return this.min.copy(e),this.max.copy(i),this}setFromArray(e){this.makeEmpty();for(let i=0,r=e.length;i<r;i+=3)this.expandByPoint(iP.fromArray(e,i));return this}setFromBufferAttribute(e){this.makeEmpty();for(let i=0,r=e.count;i<r;i++)this.expandByPoint(iP.fromBufferAttribute(e,i));return this}setFromPoints(e){this.makeEmpty();for(let i=0,r=e.length;i<r;i++)this.expandByPoint(e[i]);return this}setFromCenterAndSize(e,i){let r=iP.copy(i).multiplyScalar(.5);return this.min.copy(e).sub(r),this.max.copy(e).add(r),this}setFromObject(e,i=!1){return this.makeEmpty(),this.expandByObject(e,i)}clone(){return new this.constructor().copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=Infinity,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(e){return this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}expandByObject(e,i=!1){e.updateWorldMatrix(!1,!1);let r=e.geometry;if(void 0!==r){let n=r.getAttribute("position");if(!0===i&&void 0!==n&&!0!==e.isInstancedMesh)for(let i=0,r=n.count;i<r;i++)!0===e.isMesh?e.getVertexPosition(i,iP):iP.fromBufferAttribute(n,i),iP.applyMatrix4(e.matrixWorld),this.expandByPoint(iP);else void 0!==e.boundingBox?(null===e.boundingBox&&e.computeBoundingBox(),iI.copy(e.boundingBox)):(null===r.boundingBox&&r.computeBoundingBox(),iI.copy(r.boundingBox)),iI.applyMatrix4(e.matrixWorld),this.union(iI)}let n=e.children;for(let e=0,r=n.length;e<r;e++)this.expandByObject(n[e],i);return this}containsPoint(e){return e.x>=this.min.x&&e.x<=this.max.x&&e.y>=this.min.y&&e.y<=this.max.y&&e.z>=this.min.z&&e.z<=this.max.z}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z}getParameter(e,i){return i.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(e){return e.max.x>=this.min.x&&e.min.x<=this.max.x&&e.max.y>=this.min.y&&e.min.y<=this.max.y&&e.max.z>=this.min.z&&e.min.z<=this.max.z}intersectsSphere(e){return this.clampPoint(e.center,iP),iP.distanceToSquared(e.center)<=e.radius*e.radius}intersectsPlane(e){let i,r;return e.normal.x>0?(i=e.normal.x*this.min.x,r=e.normal.x*this.max.x):(i=e.normal.x*this.max.x,r=e.normal.x*this.min.x),e.normal.y>0?(i+=e.normal.y*this.min.y,r+=e.normal.y*this.max.y):(i+=e.normal.y*this.max.y,r+=e.normal.y*this.min.y),e.normal.z>0?(i+=e.normal.z*this.min.z,r+=e.normal.z*this.max.z):(i+=e.normal.z*this.max.z,r+=e.normal.z*this.min.z),i<=-e.constant&&r>=-e.constant}intersectsTriangle(e){if(this.isEmpty())return!1;this.getCenter(iB),iz.subVectors(this.max,iB),iL.subVectors(e.a,iB),iD.subVectors(e.b,iB),iU.subVectors(e.c,iB),iN.subVectors(iD,iL),iO.subVectors(iU,iD),iF.subVectors(iL,iU);let i=[0,-iN.z,iN.y,0,-iO.z,iO.y,0,-iF.z,iF.y,iN.z,0,-iN.x,iO.z,0,-iO.x,iF.z,0,-iF.x,-iN.y,iN.x,0,-iO.y,iO.x,0,-iF.y,iF.x,0];return!!iH(i,iL,iD,iU,iz)&&!!iH(i=[1,0,0,0,1,0,0,0,1],iL,iD,iU,iz)&&(ik.crossVectors(iN,iO),iH(i=[ik.x,ik.y,ik.z],iL,iD,iU,iz))}clampPoint(e,i){return i.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return this.clampPoint(e,iP).distanceTo(e)}getBoundingSphere(e){return this.isEmpty()?e.makeEmpty():(this.getCenter(e.center),e.radius=.5*this.getSize(iP).length()),e}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}applyMatrix4(e){return this.isEmpty()||(iC[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),iC[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),iC[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),iC[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),iC[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),iC[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),iC[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),iC[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(iC)),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}toJSON(){return{min:this.min.toArray(),max:this.max.toArray()}}fromJSON(e){return this.min.fromArray(e.min),this.max.fromArray(e.max),this}}let iC=[new ia,new ia,new ia,new ia,new ia,new ia,new ia,new ia],iP=new ia,iI=new iR,iL=new ia,iD=new ia,iU=new ia,iN=new ia,iO=new ia,iF=new ia,iB=new ia,iz=new ia,ik=new ia,iV=new ia;function iH(e,i,r,n,a){for(let s=0,o=e.length-3;s<=o;s+=3){iV.fromArray(e,s);let o=a.x*Math.abs(iV.x)+a.y*Math.abs(iV.y)+a.z*Math.abs(iV.z),l=i.dot(iV),c=r.dot(iV),h=n.dot(iV);if(Math.max(-Math.max(l,c,h),Math.min(l,c,h))>o)return!1}return!0}let iG=new iR,iW=new ia,iX=new ia;class ij{constructor(e=new ia,i=-1){this.isSphere=!0,this.center=e,this.radius=i}set(e,i){return this.center.copy(e),this.radius=i,this}setFromPoints(e,i){let r=this.center;void 0!==i?r.copy(i):iG.setFromPoints(e).getCenter(r);let n=0;for(let i=0,a=e.length;i<a;i++)n=Math.max(n,r.distanceToSquared(e[i]));return this.radius=Math.sqrt(n),this}copy(e){return this.center.copy(e.center),this.radius=e.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(e){return e.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(e){return e.distanceTo(this.center)-this.radius}intersectsSphere(e){let i=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=i*i}intersectsBox(e){return e.intersectsSphere(this)}intersectsPlane(e){return Math.abs(e.distanceToPoint(this.center))<=this.radius}clampPoint(e,i){let r=this.center.distanceToSquared(e);return i.copy(e),r>this.radius*this.radius&&(i.sub(this.center).normalize(),i.multiplyScalar(this.radius).add(this.center)),i}getBoundingBox(e){return this.isEmpty()?e.makeEmpty():(e.set(this.center,this.center),e.expandByScalar(this.radius)),e}applyMatrix4(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this}translate(e){return this.center.add(e),this}expandByPoint(e){if(this.isEmpty())return this.center.copy(e),this.radius=0,this;iW.subVectors(e,this.center);let i=iW.lengthSq();if(i>this.radius*this.radius){let e=Math.sqrt(i),r=(e-this.radius)*.5;this.center.addScaledVector(iW,r/e),this.radius+=r}return this}union(e){return e.isEmpty()||(this.isEmpty()?this.copy(e):!0===this.center.equals(e.center)?this.radius=Math.max(this.radius,e.radius):(iX.subVectors(e.center,this.center).setLength(e.radius),this.expandByPoint(iW.copy(e.center).add(iX)),this.expandByPoint(iW.copy(e.center).sub(iX)))),this}equals(e){return e.center.equals(this.center)&&e.radius===this.radius}clone(){return new this.constructor().copy(this)}toJSON(){return{radius:this.radius,center:this.center.toArray()}}fromJSON(e){return this.radius=e.radius,this.center.fromArray(e.center),this}}let iq=new ia,iY=new ia,iK=new ia,iJ=new ia,iZ=new ia,iQ=new ia,i$=new ia;class i0{constructor(e=new ia,i=new ia(0,0,-1)){this.origin=e,this.direction=i}set(e,i){return this.origin.copy(e),this.direction.copy(i),this}copy(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this}at(e,i){return i.copy(this.origin).addScaledVector(this.direction,e)}lookAt(e){return this.direction.copy(e).sub(this.origin).normalize(),this}recast(e){return this.origin.copy(this.at(e,iq)),this}closestPointToPoint(e,i){i.subVectors(e,this.origin);let r=i.dot(this.direction);return r<0?i.copy(this.origin):i.copy(this.origin).addScaledVector(this.direction,r)}distanceToPoint(e){return Math.sqrt(this.distanceSqToPoint(e))}distanceSqToPoint(e){let i=iq.subVectors(e,this.origin).dot(this.direction);return i<0?this.origin.distanceToSquared(e):(iq.copy(this.origin).addScaledVector(this.direction,i),iq.distanceToSquared(e))}distanceSqToSegment(e,i,r,n){let a,s,o,l;iY.copy(e).add(i).multiplyScalar(.5),iK.copy(i).sub(e).normalize(),iJ.copy(this.origin).sub(iY);let c=.5*e.distanceTo(i),h=-this.direction.dot(iK),u=iJ.dot(this.direction),d=-iJ.dot(iK),p=iJ.lengthSq(),f=Math.abs(1-h*h);if(f>0)if(a=h*d-u,s=h*u-d,l=c*f,a>=0)if(s>=-l)if(s<=l){let e=1/f;a*=e,s*=e,o=a*(a+h*s+2*u)+s*(h*a+s+2*d)+p}else o=-(a=Math.max(0,-(h*(s=c)+u)))*a+s*(s+2*d)+p;else o=-(a=Math.max(0,-(h*(s=-c)+u)))*a+s*(s+2*d)+p;else s<=-l?(s=(a=Math.max(0,-(-h*c+u)))>0?-c:Math.min(Math.max(-c,-d),c),o=-a*a+s*(s+2*d)+p):s<=l?(a=0,o=(s=Math.min(Math.max(-c,-d),c))*(s+2*d)+p):(s=(a=Math.max(0,-(h*c+u)))>0?c:Math.min(Math.max(-c,-d),c),o=-a*a+s*(s+2*d)+p);else s=h>0?-c:c,o=-(a=Math.max(0,-(h*s+u)))*a+s*(s+2*d)+p;return r&&r.copy(this.origin).addScaledVector(this.direction,a),n&&n.copy(iY).addScaledVector(iK,s),o}intersectSphere(e,i){iq.subVectors(e.center,this.origin);let r=iq.dot(this.direction),n=iq.dot(iq)-r*r,a=e.radius*e.radius;if(n>a)return null;let s=Math.sqrt(a-n),o=r-s,l=r+s;return l<0?null:o<0?this.at(l,i):this.at(o,i)}intersectsSphere(e){return!(e.radius<0)&&this.distanceSqToPoint(e.center)<=e.radius*e.radius}distanceToPlane(e){let i=e.normal.dot(this.direction);if(0===i)return 0===e.distanceToPoint(this.origin)?0:null;let r=-(this.origin.dot(e.normal)+e.constant)/i;return r>=0?r:null}intersectPlane(e,i){let r=this.distanceToPlane(e);return null===r?null:this.at(r,i)}intersectsPlane(e){let i=e.distanceToPoint(this.origin);return!!(0===i||e.normal.dot(this.direction)*i<0)}intersectBox(e,i){let r,n,a,s,o,l,c=1/this.direction.x,h=1/this.direction.y,u=1/this.direction.z,d=this.origin;return(c>=0?(r=(e.min.x-d.x)*c,n=(e.max.x-d.x)*c):(r=(e.max.x-d.x)*c,n=(e.min.x-d.x)*c),h>=0?(a=(e.min.y-d.y)*h,s=(e.max.y-d.y)*h):(a=(e.max.y-d.y)*h,s=(e.min.y-d.y)*h),r>s||a>n||((a>r||isNaN(r))&&(r=a),(s<n||isNaN(n))&&(n=s),u>=0?(o=(e.min.z-d.z)*u,l=(e.max.z-d.z)*u):(o=(e.max.z-d.z)*u,l=(e.min.z-d.z)*u),r>l||o>n||((o>r||r!=r)&&(r=o),(l<n||n!=n)&&(n=l),n<0)))?null:this.at(r>=0?r:n,i)}intersectsBox(e){return null!==this.intersectBox(e,iq)}intersectTriangle(e,i,r,n,a){let s;iZ.subVectors(i,e),iQ.subVectors(r,e),i$.crossVectors(iZ,iQ);let o=this.direction.dot(i$);if(o>0){if(n)return null;s=1}else{if(!(o<0))return null;s=-1,o=-o}iJ.subVectors(this.origin,e);let l=s*this.direction.dot(iQ.crossVectors(iJ,iQ));if(l<0)return null;let c=s*this.direction.dot(iZ.cross(iJ));if(c<0||l+c>o)return null;let h=-s*iJ.dot(i$);return h<0?null:this.at(h/o,a)}applyMatrix4(e){return this.origin.applyMatrix4(e),this.direction.transformDirection(e),this}equals(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}clone(){return new this.constructor().copy(this)}}class i1{constructor(e,i,r,n,a,s,o,l,c,h,u,d,p,f,m,g){i1.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==e&&this.set(e,i,r,n,a,s,o,l,c,h,u,d,p,f,m,g)}set(e,i,r,n,a,s,o,l,c,h,u,d,p,f,m,g){let v=this.elements;return v[0]=e,v[4]=i,v[8]=r,v[12]=n,v[1]=a,v[5]=s,v[9]=o,v[13]=l,v[2]=c,v[6]=h,v[10]=u,v[14]=d,v[3]=p,v[7]=f,v[11]=m,v[15]=g,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return new i1().fromArray(this.elements)}copy(e){let i=this.elements,r=e.elements;return i[0]=r[0],i[1]=r[1],i[2]=r[2],i[3]=r[3],i[4]=r[4],i[5]=r[5],i[6]=r[6],i[7]=r[7],i[8]=r[8],i[9]=r[9],i[10]=r[10],i[11]=r[11],i[12]=r[12],i[13]=r[13],i[14]=r[14],i[15]=r[15],this}copyPosition(e){let i=this.elements,r=e.elements;return i[12]=r[12],i[13]=r[13],i[14]=r[14],this}setFromMatrix3(e){let i=e.elements;return this.set(i[0],i[3],i[6],0,i[1],i[4],i[7],0,i[2],i[5],i[8],0,0,0,0,1),this}extractBasis(e,i,r){return 0===this.determinant()?(e.set(1,0,0),i.set(0,1,0),r.set(0,0,1)):(e.setFromMatrixColumn(this,0),i.setFromMatrixColumn(this,1),r.setFromMatrixColumn(this,2)),this}makeBasis(e,i,r){return this.set(e.x,i.x,r.x,0,e.y,i.y,r.y,0,e.z,i.z,r.z,0,0,0,0,1),this}extractRotation(e){if(0===e.determinant())return this.identity();let i=this.elements,r=e.elements,n=1/i3.setFromMatrixColumn(e,0).length(),a=1/i3.setFromMatrixColumn(e,1).length(),s=1/i3.setFromMatrixColumn(e,2).length();return i[0]=r[0]*n,i[1]=r[1]*n,i[2]=r[2]*n,i[3]=0,i[4]=r[4]*a,i[5]=r[5]*a,i[6]=r[6]*a,i[7]=0,i[8]=r[8]*s,i[9]=r[9]*s,i[10]=r[10]*s,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,this}makeRotationFromEuler(e){let i=this.elements,r=e.x,n=e.y,a=e.z,s=Math.cos(r),o=Math.sin(r),l=Math.cos(n),c=Math.sin(n),h=Math.cos(a),u=Math.sin(a);if("XYZ"===e.order){let e=s*h,r=s*u,n=o*h,a=o*u;i[0]=l*h,i[4]=-l*u,i[8]=c,i[1]=r+n*c,i[5]=e-a*c,i[9]=-o*l,i[2]=a-e*c,i[6]=n+r*c,i[10]=s*l}else if("YXZ"===e.order){let e=l*h,r=l*u,n=c*h,a=c*u;i[0]=e+a*o,i[4]=n*o-r,i[8]=s*c,i[1]=s*u,i[5]=s*h,i[9]=-o,i[2]=r*o-n,i[6]=a+e*o,i[10]=s*l}else if("ZXY"===e.order){let e=l*h,r=l*u,n=c*h,a=c*u;i[0]=e-a*o,i[4]=-s*u,i[8]=n+r*o,i[1]=r+n*o,i[5]=s*h,i[9]=a-e*o,i[2]=-s*c,i[6]=o,i[10]=s*l}else if("ZYX"===e.order){let e=s*h,r=s*u,n=o*h,a=o*u;i[0]=l*h,i[4]=n*c-r,i[8]=e*c+a,i[1]=l*u,i[5]=a*c+e,i[9]=r*c-n,i[2]=-c,i[6]=o*l,i[10]=s*l}else if("YZX"===e.order){let e=s*l,r=s*c,n=o*l,a=o*c;i[0]=l*h,i[4]=a-e*u,i[8]=n*u+r,i[1]=u,i[5]=s*h,i[9]=-o*h,i[2]=-c*h,i[6]=r*u+n,i[10]=e-a*u}else if("XZY"===e.order){let e=s*l,r=s*c,n=o*l,a=o*c;i[0]=l*h,i[4]=-u,i[8]=c*h,i[1]=e*u+a,i[5]=s*h,i[9]=r*u-n,i[2]=n*u-r,i[6]=o*h,i[10]=a*u+e}return i[3]=0,i[7]=0,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,this}makeRotationFromQuaternion(e){return this.compose(i4,e,i5)}lookAt(e,i,r){let n=this.elements;return i9.subVectors(e,i),0===i9.lengthSq()&&(i9.z=1),i9.normalize(),i6.crossVectors(r,i9),0===i6.lengthSq()&&(1===Math.abs(r.z)?i9.x+=1e-4:i9.z+=1e-4,i9.normalize(),i6.crossVectors(r,i9)),i6.normalize(),i8.crossVectors(i9,i6),n[0]=i6.x,n[4]=i8.x,n[8]=i9.x,n[1]=i6.y,n[5]=i8.y,n[9]=i9.y,n[2]=i6.z,n[6]=i8.z,n[10]=i9.z,this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,i){let r=e.elements,n=i.elements,a=this.elements,s=r[0],o=r[4],l=r[8],c=r[12],h=r[1],u=r[5],d=r[9],p=r[13],f=r[2],m=r[6],g=r[10],v=r[14],_=r[3],y=r[7],x=r[11],M=r[15],S=n[0],b=n[4],T=n[8],E=n[12],w=n[1],A=n[5],R=n[9],C=n[13],P=n[2],I=n[6],L=n[10],D=n[14],U=n[3],N=n[7],O=n[11],F=n[15];return a[0]=s*S+o*w+l*P+c*U,a[4]=s*b+o*A+l*I+c*N,a[8]=s*T+o*R+l*L+c*O,a[12]=s*E+o*C+l*D+c*F,a[1]=h*S+u*w+d*P+p*U,a[5]=h*b+u*A+d*I+p*N,a[9]=h*T+u*R+d*L+p*O,a[13]=h*E+u*C+d*D+p*F,a[2]=f*S+m*w+g*P+v*U,a[6]=f*b+m*A+g*I+v*N,a[10]=f*T+m*R+g*L+v*O,a[14]=f*E+m*C+g*D+v*F,a[3]=_*S+y*w+x*P+M*U,a[7]=_*b+y*A+x*I+M*N,a[11]=_*T+y*R+x*L+M*O,a[15]=_*E+y*C+x*D+M*F,this}multiplyScalar(e){let i=this.elements;return i[0]*=e,i[4]*=e,i[8]*=e,i[12]*=e,i[1]*=e,i[5]*=e,i[9]*=e,i[13]*=e,i[2]*=e,i[6]*=e,i[10]*=e,i[14]*=e,i[3]*=e,i[7]*=e,i[11]*=e,i[15]*=e,this}determinant(){let e=this.elements,i=e[0],r=e[4],n=e[8],a=e[12],s=e[1],o=e[5],l=e[9],c=e[13],h=e[2],u=e[6],d=e[10],p=e[14],f=e[3],m=e[7],g=e[11],v=e[15],_=l*p-c*d,y=o*p-c*u,x=o*d-l*u,M=s*p-c*h,S=s*d-l*h,b=s*u-o*h;return i*(m*_-g*y+v*x)-r*(f*_-g*M+v*S)+n*(f*y-m*M+v*b)-a*(f*x-m*S+g*b)}transpose(){let e,i=this.elements;return e=i[1],i[1]=i[4],i[4]=e,e=i[2],i[2]=i[8],i[8]=e,e=i[6],i[6]=i[9],i[9]=e,e=i[3],i[3]=i[12],i[12]=e,e=i[7],i[7]=i[13],i[13]=e,e=i[11],i[11]=i[14],i[14]=e,this}setPosition(e,i,r){let n=this.elements;return e.isVector3?(n[12]=e.x,n[13]=e.y,n[14]=e.z):(n[12]=e,n[13]=i,n[14]=r),this}invert(){let e=this.elements,i=e[0],r=e[1],n=e[2],a=e[3],s=e[4],o=e[5],l=e[6],c=e[7],h=e[8],u=e[9],d=e[10],p=e[11],f=e[12],m=e[13],g=e[14],v=e[15],_=u*g*c-m*d*c+m*l*p-o*g*p-u*l*v+o*d*v,y=f*d*c-h*g*c-f*l*p+s*g*p+h*l*v-s*d*v,x=h*m*c-f*u*c+f*o*p-s*m*p-h*o*v+s*u*v,M=f*u*l-h*m*l-f*o*d+s*m*d+h*o*g-s*u*g,S=i*_+r*y+n*x+a*M;if(0===S)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);let b=1/S;return e[0]=_*b,e[1]=(m*d*a-u*g*a-m*n*p+r*g*p+u*n*v-r*d*v)*b,e[2]=(o*g*a-m*l*a+m*n*c-r*g*c-o*n*v+r*l*v)*b,e[3]=(u*l*a-o*d*a-u*n*c+r*d*c+o*n*p-r*l*p)*b,e[4]=y*b,e[5]=(h*g*a-f*d*a+f*n*p-i*g*p-h*n*v+i*d*v)*b,e[6]=(f*l*a-s*g*a-f*n*c+i*g*c+s*n*v-i*l*v)*b,e[7]=(s*d*a-h*l*a+h*n*c-i*d*c-s*n*p+i*l*p)*b,e[8]=x*b,e[9]=(f*u*a-h*m*a-f*r*p+i*m*p+h*r*v-i*u*v)*b,e[10]=(s*m*a-f*o*a+f*r*c-i*m*c-s*r*v+i*o*v)*b,e[11]=(h*o*a-s*u*a-h*r*c+i*u*c+s*r*p-i*o*p)*b,e[12]=M*b,e[13]=(h*m*n-f*u*n+f*r*d-i*m*d-h*r*g+i*u*g)*b,e[14]=(f*o*n-s*m*n-f*r*l+i*m*l+s*r*g-i*o*g)*b,e[15]=(s*u*n-h*o*n+h*r*l-i*u*l-s*r*d+i*o*d)*b,this}scale(e){let i=this.elements,r=e.x,n=e.y,a=e.z;return i[0]*=r,i[4]*=n,i[8]*=a,i[1]*=r,i[5]*=n,i[9]*=a,i[2]*=r,i[6]*=n,i[10]*=a,i[3]*=r,i[7]*=n,i[11]*=a,this}getMaxScaleOnAxis(){let e=this.elements;return Math.sqrt(Math.max(e[0]*e[0]+e[1]*e[1]+e[2]*e[2],e[4]*e[4]+e[5]*e[5]+e[6]*e[6],e[8]*e[8]+e[9]*e[9]+e[10]*e[10]))}makeTranslation(e,i,r){return e.isVector3?this.set(1,0,0,e.x,0,1,0,e.y,0,0,1,e.z,0,0,0,1):this.set(1,0,0,e,0,1,0,i,0,0,1,r,0,0,0,1),this}makeRotationX(e){let i=Math.cos(e),r=Math.sin(e);return this.set(1,0,0,0,0,i,-r,0,0,r,i,0,0,0,0,1),this}makeRotationY(e){let i=Math.cos(e),r=Math.sin(e);return this.set(i,0,r,0,0,1,0,0,-r,0,i,0,0,0,0,1),this}makeRotationZ(e){let i=Math.cos(e),r=Math.sin(e);return this.set(i,-r,0,0,r,i,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,i){let r=Math.cos(i),n=Math.sin(i),a=1-r,s=e.x,o=e.y,l=e.z,c=a*s,h=a*o;return this.set(c*s+r,c*o-n*l,c*l+n*o,0,c*o+n*l,h*o+r,h*l-n*s,0,c*l-n*o,h*l+n*s,a*l*l+r,0,0,0,0,1),this}makeScale(e,i,r){return this.set(e,0,0,0,0,i,0,0,0,0,r,0,0,0,0,1),this}makeShear(e,i,r,n,a,s){return this.set(1,r,a,0,e,1,s,0,i,n,1,0,0,0,0,1),this}compose(e,i,r){let n=this.elements,a=i._x,s=i._y,o=i._z,l=i._w,c=a+a,h=s+s,u=o+o,d=a*c,p=a*h,f=a*u,m=s*h,g=s*u,v=o*u,_=l*c,y=l*h,x=l*u,M=r.x,S=r.y,b=r.z;return n[0]=(1-(m+v))*M,n[1]=(p+x)*M,n[2]=(f-y)*M,n[3]=0,n[4]=(p-x)*S,n[5]=(1-(d+v))*S,n[6]=(g+_)*S,n[7]=0,n[8]=(f+y)*b,n[9]=(g-_)*b,n[10]=(1-(d+m))*b,n[11]=0,n[12]=e.x,n[13]=e.y,n[14]=e.z,n[15]=1,this}decompose(e,i,r){let n=this.elements;if(e.x=n[12],e.y=n[13],e.z=n[14],0===this.determinant())return r.set(1,1,1),i.identity(),this;let a=i3.set(n[0],n[1],n[2]).length(),s=i3.set(n[4],n[5],n[6]).length(),o=i3.set(n[8],n[9],n[10]).length();0>this.determinant()&&(a=-a),i2.copy(this);let l=1/a,c=1/s,h=1/o;return i2.elements[0]*=l,i2.elements[1]*=l,i2.elements[2]*=l,i2.elements[4]*=c,i2.elements[5]*=c,i2.elements[6]*=c,i2.elements[8]*=h,i2.elements[9]*=h,i2.elements[10]*=h,i.setFromRotationMatrix(i2),r.x=a,r.y=s,r.z=o,this}makePerspective(e,i,r,n,a,s,o=tW,l=!1){let c,h,u=this.elements;if(l)c=a/(s-a),h=s*a/(s-a);else if(o===tW)c=-(s+a)/(s-a),h=-2*s*a/(s-a);else if(2001===o)c=-s/(s-a),h=-s*a/(s-a);else throw Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+o);return u[0]=2*a/(i-e),u[4]=0,u[8]=(i+e)/(i-e),u[12]=0,u[1]=0,u[5]=2*a/(r-n),u[9]=(r+n)/(r-n),u[13]=0,u[2]=0,u[6]=0,u[10]=c,u[14]=h,u[3]=0,u[7]=0,u[11]=-1,u[15]=0,this}makeOrthographic(e,i,r,n,a,s,o=tW,l=!1){let c,h,u=this.elements;if(l)c=1/(s-a),h=s/(s-a);else if(o===tW)c=-2/(s-a),h=-(s+a)/(s-a);else if(2001===o)c=-1/(s-a),h=-a/(s-a);else throw Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+o);return u[0]=2/(i-e),u[4]=0,u[8]=0,u[12]=-(i+e)/(i-e),u[1]=0,u[5]=2/(r-n),u[9]=0,u[13]=-(r+n)/(r-n),u[2]=0,u[6]=0,u[10]=c,u[14]=h,u[3]=0,u[7]=0,u[11]=0,u[15]=1,this}equals(e){let i=this.elements,r=e.elements;for(let e=0;e<16;e++)if(i[e]!==r[e])return!1;return!0}fromArray(e,i=0){for(let r=0;r<16;r++)this.elements[r]=e[r+i];return this}toArray(e=[],i=0){let r=this.elements;return e[i]=r[0],e[i+1]=r[1],e[i+2]=r[2],e[i+3]=r[3],e[i+4]=r[4],e[i+5]=r[5],e[i+6]=r[6],e[i+7]=r[7],e[i+8]=r[8],e[i+9]=r[9],e[i+10]=r[10],e[i+11]=r[11],e[i+12]=r[12],e[i+13]=r[13],e[i+14]=r[14],e[i+15]=r[15],e}}let i3=new ia,i2=new i1,i4=new ia(0,0,0),i5=new ia(1,1,1),i6=new ia,i8=new ia,i9=new ia,i7=new i1,re=new ir;class rt{constructor(e=0,i=0,r=0,n=rt.DEFAULT_ORDER){this.isEuler=!0,this._x=e,this._y=i,this._z=r,this._order=n}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get order(){return this._order}set order(e){this._order=e,this._onChangeCallback()}set(e,i,r,n=this._order){return this._x=e,this._y=i,this._z=r,this._order=n,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this._onChangeCallback(),this}setFromRotationMatrix(e,i=this._order,r=!0){let n=e.elements,a=n[0],s=n[4],o=n[8],l=n[1],c=n[5],h=n[9],u=n[2],d=n[6],p=n[10];switch(i){case"XYZ":this._y=Math.asin(t6(o,-1,1)),.9999999>Math.abs(o)?(this._x=Math.atan2(-h,p),this._z=Math.atan2(-s,a)):(this._x=Math.atan2(d,c),this._z=0);break;case"YXZ":this._x=Math.asin(-t6(h,-1,1)),.9999999>Math.abs(h)?(this._y=Math.atan2(o,p),this._z=Math.atan2(l,c)):(this._y=Math.atan2(-u,a),this._z=0);break;case"ZXY":this._x=Math.asin(t6(d,-1,1)),.9999999>Math.abs(d)?(this._y=Math.atan2(-u,p),this._z=Math.atan2(-s,c)):(this._y=0,this._z=Math.atan2(l,a));break;case"ZYX":this._y=Math.asin(-t6(u,-1,1)),.9999999>Math.abs(u)?(this._x=Math.atan2(d,p),this._z=Math.atan2(l,a)):(this._x=0,this._z=Math.atan2(-s,c));break;case"YZX":this._z=Math.asin(t6(l,-1,1)),.9999999>Math.abs(l)?(this._x=Math.atan2(-h,c),this._y=Math.atan2(-u,a)):(this._x=0,this._y=Math.atan2(o,p));break;case"XZY":this._z=Math.asin(-t6(s,-1,1)),.9999999>Math.abs(s)?(this._x=Math.atan2(d,c),this._y=Math.atan2(o,a)):(this._x=Math.atan2(-h,p),this._y=0);break;default:tJ("Euler: .setFromRotationMatrix() encountered an unknown order: "+i)}return this._order=i,!0===r&&this._onChangeCallback(),this}setFromQuaternion(e,i,r){return i7.makeRotationFromQuaternion(e),this.setFromRotationMatrix(i7,i,r)}setFromVector3(e,i=this._order){return this.set(e.x,e.y,e.z,i)}reorder(e){return re.setFromEuler(this),this.setFromQuaternion(re,e)}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order}fromArray(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this._onChangeCallback(),this}toArray(e=[],i=0){return e[i]=this._x,e[i+1]=this._y,e[i+2]=this._z,e[i+3]=this._order,e}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}rt.DEFAULT_ORDER="XYZ";class ri{constructor(){this.mask=1}set(e){this.mask=1<<e>>>0}enable(e){this.mask|=1<<e}enableAll(){this.mask=-1}toggle(e){this.mask^=1<<e}disable(e){this.mask&=~(1<<e)}disableAll(){this.mask=0}test(e){return(this.mask&e.mask)!=0}isEnabled(e){return(this.mask&1<<e)!=0}}let rr=0,rn=new ia,ra=new ir,rs=new i1,ro=new ia,rl=new ia,rc=new ia,rh=new ir,ru=new ia(1,0,0),rd=new ia(0,1,0),rp=new ia(0,0,1),rf={type:"added"},rm={type:"removed"},rg={type:"childadded",child:null},rv={type:"childremoved",child:null};class r_ extends t0{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:rr++}),this.uuid=t5(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=r_.DEFAULT_UP.clone();const e=new ia,i=new rt,r=new ir,n=new ia(1,1,1);i._onChange(function(){r.setFromEuler(i,!1)}),r._onChange(function(){i.setFromQuaternion(r,void 0,!1)}),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:e},rotation:{configurable:!0,enumerable:!0,value:i},quaternion:{configurable:!0,enumerable:!0,value:r},scale:{configurable:!0,enumerable:!0,value:n},modelViewMatrix:{value:new i1},normalMatrix:{value:new il}}),this.matrix=new i1,this.matrixWorld=new i1,this.matrixAutoUpdate=r_.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=r_.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new ri,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.customDepthMaterial=void 0,this.customDistanceMaterial=void 0,this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(e){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(e),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(e){return this.quaternion.premultiply(e),this}setRotationFromAxisAngle(e,i){this.quaternion.setFromAxisAngle(e,i)}setRotationFromEuler(e){this.quaternion.setFromEuler(e,!0)}setRotationFromMatrix(e){this.quaternion.setFromRotationMatrix(e)}setRotationFromQuaternion(e){this.quaternion.copy(e)}rotateOnAxis(e,i){return ra.setFromAxisAngle(e,i),this.quaternion.multiply(ra),this}rotateOnWorldAxis(e,i){return ra.setFromAxisAngle(e,i),this.quaternion.premultiply(ra),this}rotateX(e){return this.rotateOnAxis(ru,e)}rotateY(e){return this.rotateOnAxis(rd,e)}rotateZ(e){return this.rotateOnAxis(rp,e)}translateOnAxis(e,i){return rn.copy(e).applyQuaternion(this.quaternion),this.position.add(rn.multiplyScalar(i)),this}translateX(e){return this.translateOnAxis(ru,e)}translateY(e){return this.translateOnAxis(rd,e)}translateZ(e){return this.translateOnAxis(rp,e)}localToWorld(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(this.matrixWorld)}worldToLocal(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(rs.copy(this.matrixWorld).invert())}lookAt(e,i,r){e.isVector3?ro.copy(e):ro.set(e,i,r);let n=this.parent;this.updateWorldMatrix(!0,!1),rl.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?rs.lookAt(rl,ro,this.up):rs.lookAt(ro,rl,this.up),this.quaternion.setFromRotationMatrix(rs),n&&(rs.extractRotation(n.matrixWorld),ra.setFromRotationMatrix(rs),this.quaternion.premultiply(ra.invert()))}add(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return e===this?tZ("Object3D.add: object can't be added as a child of itself.",e):e&&e.isObject3D?(e.removeFromParent(),e.parent=this,this.children.push(e),e.dispatchEvent(rf),rg.child=e,this.dispatchEvent(rg),rg.child=null):tZ("Object3D.add: object not an instance of THREE.Object3D.",e),this}remove(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.remove(arguments[e]);return this}let i=this.children.indexOf(e);return -1!==i&&(e.parent=null,this.children.splice(i,1),e.dispatchEvent(rm),rv.child=e,this.dispatchEvent(rv),rv.child=null),this}removeFromParent(){let e=this.parent;return null!==e&&e.remove(this),this}clear(){return this.remove(...this.children)}attach(e){return this.updateWorldMatrix(!0,!1),rs.copy(this.matrixWorld).invert(),null!==e.parent&&(e.parent.updateWorldMatrix(!0,!1),rs.multiply(e.parent.matrixWorld)),e.applyMatrix4(rs),e.removeFromParent(),e.parent=this,this.children.push(e),e.updateWorldMatrix(!1,!0),e.dispatchEvent(rf),rg.child=e,this.dispatchEvent(rg),rg.child=null,this}getObjectById(e){return this.getObjectByProperty("id",e)}getObjectByName(e){return this.getObjectByProperty("name",e)}getObjectByProperty(e,i){if(this[e]===i)return this;for(let r=0,n=this.children.length;r<n;r++){let n=this.children[r].getObjectByProperty(e,i);if(void 0!==n)return n}}getObjectsByProperty(e,i,r=[]){this[e]===i&&r.push(this);let n=this.children;for(let a=0,s=n.length;a<s;a++)n[a].getObjectsByProperty(e,i,r);return r}getWorldPosition(e){return this.updateWorldMatrix(!0,!1),e.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(rl,e,rc),e}getWorldScale(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(rl,rh,e),e}getWorldDirection(e){this.updateWorldMatrix(!0,!1);let i=this.matrixWorld.elements;return e.set(i[8],i[9],i[10]).normalize()}raycast(){}traverse(e){e(this);let i=this.children;for(let r=0,n=i.length;r<n;r++)i[r].traverse(e)}traverseVisible(e){if(!1===this.visible)return;e(this);let i=this.children;for(let r=0,n=i.length;r<n;r++)i[r].traverseVisible(e)}traverseAncestors(e){let i=this.parent;null!==i&&(e(i),i.traverseAncestors(e))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),this.matrixWorldNeedsUpdate=!1,e=!0);let i=this.children;for(let r=0,n=i.length;r<n;r++)i[r].updateMatrixWorld(e)}updateWorldMatrix(e,i){let r=this.parent;if(!0===e&&null!==r&&r.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),!0===i){let e=this.children;for(let i=0,r=e.length;i<r;i++)e[i].updateWorldMatrix(!1,!0)}}toJSON(e){let i=void 0===e||"string"==typeof e,r={};i&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},r.metadata={version:4.7,type:"Object",generator:"Object3D.toJSON"});let n={};function a(i,r){return void 0===i[r.uuid]&&(i[r.uuid]=r.toJSON(e)),r.uuid}if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),!0===this.castShadow&&(n.castShadow=!0),!0===this.receiveShadow&&(n.receiveShadow=!0),!1===this.visible&&(n.visible=!1),!1===this.frustumCulled&&(n.frustumCulled=!1),0!==this.renderOrder&&(n.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(n.userData=this.userData),n.layers=this.layers.mask,n.matrix=this.matrix.toArray(),n.up=this.up.toArray(),!1===this.matrixAutoUpdate&&(n.matrixAutoUpdate=!1),this.isInstancedMesh&&(n.type="InstancedMesh",n.count=this.count,n.instanceMatrix=this.instanceMatrix.toJSON(),null!==this.instanceColor&&(n.instanceColor=this.instanceColor.toJSON())),this.isBatchedMesh&&(n.type="BatchedMesh",n.perObjectFrustumCulled=this.perObjectFrustumCulled,n.sortObjects=this.sortObjects,n.drawRanges=this._drawRanges,n.reservedRanges=this._reservedRanges,n.geometryInfo=this._geometryInfo.map(e=>({...e,boundingBox:e.boundingBox?e.boundingBox.toJSON():void 0,boundingSphere:e.boundingSphere?e.boundingSphere.toJSON():void 0})),n.instanceInfo=this._instanceInfo.map(e=>({...e})),n.availableInstanceIds=this._availableInstanceIds.slice(),n.availableGeometryIds=this._availableGeometryIds.slice(),n.nextIndexStart=this._nextIndexStart,n.nextVertexStart=this._nextVertexStart,n.geometryCount=this._geometryCount,n.maxInstanceCount=this._maxInstanceCount,n.maxVertexCount=this._maxVertexCount,n.maxIndexCount=this._maxIndexCount,n.geometryInitialized=this._geometryInitialized,n.matricesTexture=this._matricesTexture.toJSON(e),n.indirectTexture=this._indirectTexture.toJSON(e),null!==this._colorsTexture&&(n.colorsTexture=this._colorsTexture.toJSON(e)),null!==this.boundingSphere&&(n.boundingSphere=this.boundingSphere.toJSON()),null!==this.boundingBox&&(n.boundingBox=this.boundingBox.toJSON())),this.isScene)this.background&&(this.background.isColor?n.background=this.background.toJSON():this.background.isTexture&&(n.background=this.background.toJSON(e).uuid)),this.environment&&this.environment.isTexture&&!0!==this.environment.isRenderTargetTexture&&(n.environment=this.environment.toJSON(e).uuid);else if(this.isMesh||this.isLine||this.isPoints){n.geometry=a(e.geometries,this.geometry);let i=this.geometry.parameters;if(void 0!==i&&void 0!==i.shapes){let r=i.shapes;if(Array.isArray(r))for(let i=0,n=r.length;i<n;i++){let n=r[i];a(e.shapes,n)}else a(e.shapes,r)}}if(this.isSkinnedMesh&&(n.bindMode=this.bindMode,n.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(a(e.skeletons,this.skeleton),n.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){let i=[];for(let r=0,n=this.material.length;r<n;r++)i.push(a(e.materials,this.material[r]));n.material=i}else n.material=a(e.materials,this.material);if(this.children.length>0){n.children=[];for(let i=0;i<this.children.length;i++)n.children.push(this.children[i].toJSON(e).object)}if(this.animations.length>0){n.animations=[];for(let i=0;i<this.animations.length;i++){let r=this.animations[i];n.animations.push(a(e.animations,r))}}if(i){let i=s(e.geometries),n=s(e.materials),a=s(e.textures),o=s(e.images),l=s(e.shapes),c=s(e.skeletons),h=s(e.animations),u=s(e.nodes);i.length>0&&(r.geometries=i),n.length>0&&(r.materials=n),a.length>0&&(r.textures=a),o.length>0&&(r.images=o),l.length>0&&(r.shapes=l),c.length>0&&(r.skeletons=c),h.length>0&&(r.animations=h),u.length>0&&(r.nodes=u)}return r.object=n,r;function s(e){let i=[];for(let r in e){let n=e[r];delete n.metadata,i.push(n)}return i}}clone(e){return new this.constructor().copy(this,e)}copy(e,i=!0){if(this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.rotation.order=e.rotation.order,this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldAutoUpdate=e.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.animations=e.animations.slice(),this.userData=JSON.parse(JSON.stringify(e.userData)),!0===i)for(let i=0;i<e.children.length;i++){let r=e.children[i];this.add(r.clone())}return this}}r_.DEFAULT_UP=new ia(0,1,0),r_.DEFAULT_MATRIX_AUTO_UPDATE=!0,r_.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;let ry=new ia,rx=new ia,rM=new ia,rS=new ia,rb=new ia,rT=new ia,rE=new ia,rw=new ia,rA=new ia,rR=new ia,rC=new ib,rP=new ib,rI=new ib;class rL{constructor(e=new ia,i=new ia,r=new ia){this.a=e,this.b=i,this.c=r}static getNormal(e,i,r,n){n.subVectors(r,i),ry.subVectors(e,i),n.cross(ry);let a=n.lengthSq();return a>0?n.multiplyScalar(1/Math.sqrt(a)):n.set(0,0,0)}static getBarycoord(e,i,r,n,a){ry.subVectors(n,i),rx.subVectors(r,i),rM.subVectors(e,i);let s=ry.dot(ry),o=ry.dot(rx),l=ry.dot(rM),c=rx.dot(rx),h=rx.dot(rM),u=s*c-o*o;if(0===u)return a.set(0,0,0),null;let d=1/u,p=(c*l-o*h)*d,f=(s*h-o*l)*d;return a.set(1-p-f,f,p)}static containsPoint(e,i,r,n){return null!==this.getBarycoord(e,i,r,n,rS)&&rS.x>=0&&rS.y>=0&&rS.x+rS.y<=1}static getInterpolation(e,i,r,n,a,s,o,l){return null===this.getBarycoord(e,i,r,n,rS)?(l.x=0,l.y=0,"z"in l&&(l.z=0),"w"in l&&(l.w=0),null):(l.setScalar(0),l.addScaledVector(a,rS.x),l.addScaledVector(s,rS.y),l.addScaledVector(o,rS.z),l)}static getInterpolatedAttribute(e,i,r,n,a,s){return rC.setScalar(0),rP.setScalar(0),rI.setScalar(0),rC.fromBufferAttribute(e,i),rP.fromBufferAttribute(e,r),rI.fromBufferAttribute(e,n),s.setScalar(0),s.addScaledVector(rC,a.x),s.addScaledVector(rP,a.y),s.addScaledVector(rI,a.z),s}static isFrontFacing(e,i,r,n){return ry.subVectors(r,i),rx.subVectors(e,i),0>ry.cross(rx).dot(n)}set(e,i,r){return this.a.copy(e),this.b.copy(i),this.c.copy(r),this}setFromPointsAndIndices(e,i,r,n){return this.a.copy(e[i]),this.b.copy(e[r]),this.c.copy(e[n]),this}setFromAttributeAndIndices(e,i,r,n){return this.a.fromBufferAttribute(e,i),this.b.fromBufferAttribute(e,r),this.c.fromBufferAttribute(e,n),this}clone(){return new this.constructor().copy(this)}copy(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this}getArea(){return ry.subVectors(this.c,this.b),rx.subVectors(this.a,this.b),.5*ry.cross(rx).length()}getMidpoint(e){return e.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(e){return rL.getNormal(this.a,this.b,this.c,e)}getPlane(e){return e.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(e,i){return rL.getBarycoord(e,this.a,this.b,this.c,i)}getInterpolation(e,i,r,n,a){return rL.getInterpolation(e,this.a,this.b,this.c,i,r,n,a)}containsPoint(e){return rL.containsPoint(e,this.a,this.b,this.c)}isFrontFacing(e){return rL.isFrontFacing(this.a,this.b,this.c,e)}intersectsBox(e){return e.intersectsTriangle(this)}closestPointToPoint(e,i){let r,n,a=this.a,s=this.b,o=this.c;rb.subVectors(s,a),rT.subVectors(o,a),rw.subVectors(e,a);let l=rb.dot(rw),c=rT.dot(rw);if(l<=0&&c<=0)return i.copy(a);rA.subVectors(e,s);let h=rb.dot(rA),u=rT.dot(rA);if(h>=0&&u<=h)return i.copy(s);let d=l*u-h*c;if(d<=0&&l>=0&&h<=0)return r=l/(l-h),i.copy(a).addScaledVector(rb,r);rR.subVectors(e,o);let p=rb.dot(rR),f=rT.dot(rR);if(f>=0&&p<=f)return i.copy(o);let m=p*c-l*f;if(m<=0&&c>=0&&f<=0)return n=c/(c-f),i.copy(a).addScaledVector(rT,n);let g=h*f-p*u;if(g<=0&&u-h>=0&&p-f>=0)return rE.subVectors(o,s),n=(u-h)/(u-h+(p-f)),i.copy(s).addScaledVector(rE,n);let v=1/(g+m+d);return r=m*v,n=d*v,i.copy(a).addScaledVector(rb,r).addScaledVector(rT,n)}equals(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}}let rD={aliceblue:0xf0f8ff,antiquewhite:0xfaebd7,aqua:65535,aquamarine:8388564,azure:0xf0ffff,beige:0xf5f5dc,bisque:0xffe4c4,black:0,blanchedalmond:0xffebcd,blue:255,blueviolet:9055202,brown:0xa52a2a,burlywood:0xdeb887,cadetblue:6266528,chartreuse:8388352,chocolate:0xd2691e,coral:0xff7f50,cornflowerblue:6591981,cornsilk:0xfff8dc,crimson:0xdc143c,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:0xb8860b,darkgray:0xa9a9a9,darkgreen:25600,darkgrey:0xa9a9a9,darkkhaki:0xbdb76b,darkmagenta:9109643,darkolivegreen:5597999,darkorange:0xff8c00,darkorchid:0x9932cc,darkred:9109504,darksalmon:0xe9967a,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:0xff1493,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:0xb22222,floralwhite:0xfffaf0,forestgreen:2263842,fuchsia:0xff00ff,gainsboro:0xdcdcdc,ghostwhite:0xf8f8ff,gold:0xffd700,goldenrod:0xdaa520,gray:8421504,green:32768,greenyellow:0xadff2f,grey:8421504,honeydew:0xf0fff0,hotpink:0xff69b4,indianred:0xcd5c5c,indigo:4915330,ivory:0xfffff0,khaki:0xf0e68c,lavender:0xe6e6fa,lavenderblush:0xfff0f5,lawngreen:8190976,lemonchiffon:0xfffacd,lightblue:0xadd8e6,lightcoral:0xf08080,lightcyan:0xe0ffff,lightgoldenrodyellow:0xfafad2,lightgray:0xd3d3d3,lightgreen:9498256,lightgrey:0xd3d3d3,lightpink:0xffb6c1,lightsalmon:0xffa07a,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:0xb0c4de,lightyellow:0xffffe0,lime:65280,limegreen:3329330,linen:0xfaf0e6,magenta:0xff00ff,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:0xba55d3,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:0xc71585,midnightblue:1644912,mintcream:0xf5fffa,mistyrose:0xffe4e1,moccasin:0xffe4b5,navajowhite:0xffdead,navy:128,oldlace:0xfdf5e6,olive:8421376,olivedrab:7048739,orange:0xffa500,orangered:0xff4500,orchid:0xda70d6,palegoldenrod:0xeee8aa,palegreen:0x98fb98,paleturquoise:0xafeeee,palevioletred:0xdb7093,papayawhip:0xffefd5,peachpuff:0xffdab9,peru:0xcd853f,pink:0xffc0cb,plum:0xdda0dd,powderblue:0xb0e0e6,purple:8388736,rebeccapurple:6697881,red:0xff0000,rosybrown:0xbc8f8f,royalblue:4286945,saddlebrown:9127187,salmon:0xfa8072,sandybrown:0xf4a460,seagreen:3050327,seashell:0xfff5ee,sienna:0xa0522d,silver:0xc0c0c0,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:0xfffafa,springgreen:65407,steelblue:4620980,tan:0xd2b48c,teal:32896,thistle:0xd8bfd8,tomato:0xff6347,turquoise:4251856,violet:0xee82ee,wheat:0xf5deb3,white:0xffffff,whitesmoke:0xf5f5f5,yellow:0xffff00,yellowgreen:0x9acd32},rU={h:0,s:0,l:0},rN={h:0,s:0,l:0};function rO(e,i,r){return(r<0&&(r+=1),r>1&&(r-=1),r<1/6)?e+(i-e)*6*r:r<.5?i:r<2/3?e+(i-e)*6*(2/3-r):e}class rF{constructor(e,i,r){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(e,i,r)}set(e,i,r){return void 0===i&&void 0===r?e&&e.isColor?this.copy(e):"number"==typeof e?this.setHex(e):"string"==typeof e&&this.setStyle(e):this.setRGB(e,i,r),this}setScalar(e){return this.r=e,this.g=e,this.b=e,this}setHex(e,i=tI){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,id.colorSpaceToWorking(this,i),this}setRGB(e,i,r,n=id.workingColorSpace){return this.r=e,this.g=i,this.b=r,id.colorSpaceToWorking(this,n),this}setHSL(e,i,r,n=id.workingColorSpace){if(e=t8(e,1),i=t6(i,0,1),r=t6(r,0,1),0===i)this.r=this.g=this.b=r;else{let n=r<=.5?r*(1+i):r+i-r*i,a=2*r-n;this.r=rO(a,n,e+1/3),this.g=rO(a,n,e),this.b=rO(a,n,e-1/3)}return id.colorSpaceToWorking(this,n),this}setStyle(e,i=tI){let r;function n(i){void 0!==i&&1>parseFloat(i)&&tJ("Color: Alpha component of "+e+" will be ignored.")}if(r=/^(\w+)\(([^\)]*)\)/.exec(e)){let a,s=r[1],o=r[2];switch(s){case"rgb":case"rgba":if(a=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(o))return n(a[4]),this.setRGB(Math.min(255,parseInt(a[1],10))/255,Math.min(255,parseInt(a[2],10))/255,Math.min(255,parseInt(a[3],10))/255,i);if(a=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(o))return n(a[4]),this.setRGB(Math.min(100,parseInt(a[1],10))/100,Math.min(100,parseInt(a[2],10))/100,Math.min(100,parseInt(a[3],10))/100,i);break;case"hsl":case"hsla":if(a=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(o))return n(a[4]),this.setHSL(parseFloat(a[1])/360,parseFloat(a[2])/100,parseFloat(a[3])/100,i);break;default:tJ("Color: Unknown color model "+e)}}else if(r=/^\#([A-Fa-f\d]+)$/.exec(e)){let n=r[1],a=n.length;if(3===a)return this.setRGB(parseInt(n.charAt(0),16)/15,parseInt(n.charAt(1),16)/15,parseInt(n.charAt(2),16)/15,i);if(6===a)return this.setHex(parseInt(n,16),i);tJ("Color: Invalid hex color "+e)}else if(e&&e.length>0)return this.setColorName(e,i);return this}setColorName(e,i=tI){let r=rD[e.toLowerCase()];return void 0!==r?this.setHex(r,i):tJ("Color: Unknown color "+e),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copySRGBToLinear(e){return this.r=ip(e.r),this.g=ip(e.g),this.b=ip(e.b),this}copyLinearToSRGB(e){return this.r=im(e.r),this.g=im(e.g),this.b=im(e.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(e=tI){return id.workingToColorSpace(rB.copy(this),e),65536*Math.round(t6(255*rB.r,0,255))+256*Math.round(t6(255*rB.g,0,255))+Math.round(t6(255*rB.b,0,255))}getHexString(e=tI){return("000000"+this.getHex(e).toString(16)).slice(-6)}getHSL(e,i=id.workingColorSpace){let r,n;id.workingToColorSpace(rB.copy(this),i);let a=rB.r,s=rB.g,o=rB.b,l=Math.max(a,s,o),c=Math.min(a,s,o),h=(c+l)/2;if(c===l)r=0,n=0;else{let e=l-c;switch(n=h<=.5?e/(l+c):e/(2-l-c),l){case a:r=(s-o)/e+6*(s<o);break;case s:r=(o-a)/e+2;break;case o:r=(a-s)/e+4}r/=6}return e.h=r,e.s=n,e.l=h,e}getRGB(e,i=id.workingColorSpace){return id.workingToColorSpace(rB.copy(this),i),e.r=rB.r,e.g=rB.g,e.b=rB.b,e}getStyle(e=tI){id.workingToColorSpace(rB.copy(this),e);let i=rB.r,r=rB.g,n=rB.b;return e!==tI?`color(${e} ${i.toFixed(3)} ${r.toFixed(3)} ${n.toFixed(3)})`:`rgb(${Math.round(255*i)},${Math.round(255*r)},${Math.round(255*n)})`}offsetHSL(e,i,r){return this.getHSL(rU),this.setHSL(rU.h+e,rU.s+i,rU.l+r)}add(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addColors(e,i){return this.r=e.r+i.r,this.g=e.g+i.g,this.b=e.b+i.b,this}addScalar(e){return this.r+=e,this.g+=e,this.b+=e,this}sub(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this}multiply(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}lerp(e,i){return this.r+=(e.r-this.r)*i,this.g+=(e.g-this.g)*i,this.b+=(e.b-this.b)*i,this}lerpColors(e,i,r){return this.r=e.r+(i.r-e.r)*r,this.g=e.g+(i.g-e.g)*r,this.b=e.b+(i.b-e.b)*r,this}lerpHSL(e,i){this.getHSL(rU),e.getHSL(rN);let r=t9(rU.h,rN.h,i),n=t9(rU.s,rN.s,i),a=t9(rU.l,rN.l,i);return this.setHSL(r,n,a),this}setFromVector3(e){return this.r=e.x,this.g=e.y,this.b=e.z,this}applyMatrix3(e){let i=this.r,r=this.g,n=this.b,a=e.elements;return this.r=a[0]*i+a[3]*r+a[6]*n,this.g=a[1]*i+a[4]*r+a[7]*n,this.b=a[2]*i+a[5]*r+a[8]*n,this}equals(e){return e.r===this.r&&e.g===this.g&&e.b===this.b}fromArray(e,i=0){return this.r=e[i],this.g=e[i+1],this.b=e[i+2],this}toArray(e=[],i=0){return e[i]=this.r,e[i+1]=this.g,e[i+2]=this.b,e}fromBufferAttribute(e,i){return this.r=e.getX(i),this.g=e.getY(i),this.b=e.getZ(i),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}let rB=new rF;rF.NAMES=rD;let rz=0;class rk extends t0{constructor(){super(),this.isMaterial=!0,Object.defineProperty(this,"id",{value:rz++}),this.uuid=t5(),this.name="",this.type="Material",this.blending=b,this.side=y,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.alphaHash=!1,this.blendSrc=F,this.blendDst=B,this.blendEquation=R,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.blendColor=new rF(0,0,0),this.blendAlpha=0,this.depthFunc=Z,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=519,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=7680,this.stencilZFail=7680,this.stencilZPass=7680,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.forceSinglePass=!1,this.allowOverride=!0,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(e){this._alphaTest>0!=e>0&&this.version++,this._alphaTest=e}onBeforeRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(e){if(void 0!==e)for(let i in e){let r=e[i];if(void 0===r){tJ(`Material: parameter '${i}' has value of undefined.`);continue}let n=this[i];if(void 0===n){tJ(`Material: '${i}' is not a property of THREE.${this.type}.`);continue}n&&n.isColor?n.set(r):n&&n.isVector3&&r&&r.isVector3?n.copy(r):this[i]=r}}toJSON(e){let i=void 0===e||"string"==typeof e;i&&(e={textures:{},images:{}});let r={metadata:{version:4.7,type:"Material",generator:"Material.toJSON"}};function n(e){let i=[];for(let r in e){let n=e[r];delete n.metadata,i.push(n)}return i}if(r.uuid=this.uuid,r.type=this.type,""!==this.name&&(r.name=this.name),this.color&&this.color.isColor&&(r.color=this.color.getHex()),void 0!==this.roughness&&(r.roughness=this.roughness),void 0!==this.metalness&&(r.metalness=this.metalness),void 0!==this.sheen&&(r.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(r.sheenColor=this.sheenColor.getHex()),void 0!==this.sheenRoughness&&(r.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(r.emissive=this.emissive.getHex()),void 0!==this.emissiveIntensity&&1!==this.emissiveIntensity&&(r.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(r.specular=this.specular.getHex()),void 0!==this.specularIntensity&&(r.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(r.specularColor=this.specularColor.getHex()),void 0!==this.shininess&&(r.shininess=this.shininess),void 0!==this.clearcoat&&(r.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(r.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(r.clearcoatMap=this.clearcoatMap.toJSON(e).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(r.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(e).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(r.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(e).uuid,r.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),this.sheenColorMap&&this.sheenColorMap.isTexture&&(r.sheenColorMap=this.sheenColorMap.toJSON(e).uuid),this.sheenRoughnessMap&&this.sheenRoughnessMap.isTexture&&(r.sheenRoughnessMap=this.sheenRoughnessMap.toJSON(e).uuid),void 0!==this.dispersion&&(r.dispersion=this.dispersion),void 0!==this.iridescence&&(r.iridescence=this.iridescence),void 0!==this.iridescenceIOR&&(r.iridescenceIOR=this.iridescenceIOR),void 0!==this.iridescenceThicknessRange&&(r.iridescenceThicknessRange=this.iridescenceThicknessRange),this.iridescenceMap&&this.iridescenceMap.isTexture&&(r.iridescenceMap=this.iridescenceMap.toJSON(e).uuid),this.iridescenceThicknessMap&&this.iridescenceThicknessMap.isTexture&&(r.iridescenceThicknessMap=this.iridescenceThicknessMap.toJSON(e).uuid),void 0!==this.anisotropy&&(r.anisotropy=this.anisotropy),void 0!==this.anisotropyRotation&&(r.anisotropyRotation=this.anisotropyRotation),this.anisotropyMap&&this.anisotropyMap.isTexture&&(r.anisotropyMap=this.anisotropyMap.toJSON(e).uuid),this.map&&this.map.isTexture&&(r.map=this.map.toJSON(e).uuid),this.matcap&&this.matcap.isTexture&&(r.matcap=this.matcap.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(r.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(r.lightMap=this.lightMap.toJSON(e).uuid,r.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(r.aoMap=this.aoMap.toJSON(e).uuid,r.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(r.bumpMap=this.bumpMap.toJSON(e).uuid,r.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(r.normalMap=this.normalMap.toJSON(e).uuid,r.normalMapType=this.normalMapType,r.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(r.displacementMap=this.displacementMap.toJSON(e).uuid,r.displacementScale=this.displacementScale,r.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(r.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(r.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(r.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(r.specularMap=this.specularMap.toJSON(e).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(r.specularIntensityMap=this.specularIntensityMap.toJSON(e).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(r.specularColorMap=this.specularColorMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(r.envMap=this.envMap.toJSON(e).uuid,void 0!==this.combine&&(r.combine=this.combine)),void 0!==this.envMapRotation&&(r.envMapRotation=this.envMapRotation.toArray()),void 0!==this.envMapIntensity&&(r.envMapIntensity=this.envMapIntensity),void 0!==this.reflectivity&&(r.reflectivity=this.reflectivity),void 0!==this.refractionRatio&&(r.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(r.gradientMap=this.gradientMap.toJSON(e).uuid),void 0!==this.transmission&&(r.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(r.transmissionMap=this.transmissionMap.toJSON(e).uuid),void 0!==this.thickness&&(r.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(r.thicknessMap=this.thicknessMap.toJSON(e).uuid),void 0!==this.attenuationDistance&&this.attenuationDistance!==1/0&&(r.attenuationDistance=this.attenuationDistance),void 0!==this.attenuationColor&&(r.attenuationColor=this.attenuationColor.getHex()),void 0!==this.size&&(r.size=this.size),null!==this.shadowSide&&(r.shadowSide=this.shadowSide),void 0!==this.sizeAttenuation&&(r.sizeAttenuation=this.sizeAttenuation),this.blending!==b&&(r.blending=this.blending),this.side!==y&&(r.side=this.side),!0===this.vertexColors&&(r.vertexColors=!0),this.opacity<1&&(r.opacity=this.opacity),!0===this.transparent&&(r.transparent=!0),this.blendSrc!==F&&(r.blendSrc=this.blendSrc),this.blendDst!==B&&(r.blendDst=this.blendDst),this.blendEquation!==R&&(r.blendEquation=this.blendEquation),null!==this.blendSrcAlpha&&(r.blendSrcAlpha=this.blendSrcAlpha),null!==this.blendDstAlpha&&(r.blendDstAlpha=this.blendDstAlpha),null!==this.blendEquationAlpha&&(r.blendEquationAlpha=this.blendEquationAlpha),this.blendColor&&this.blendColor.isColor&&(r.blendColor=this.blendColor.getHex()),0!==this.blendAlpha&&(r.blendAlpha=this.blendAlpha),this.depthFunc!==Z&&(r.depthFunc=this.depthFunc),!1===this.depthTest&&(r.depthTest=this.depthTest),!1===this.depthWrite&&(r.depthWrite=this.depthWrite),!1===this.colorWrite&&(r.colorWrite=this.colorWrite),255!==this.stencilWriteMask&&(r.stencilWriteMask=this.stencilWriteMask),519!==this.stencilFunc&&(r.stencilFunc=this.stencilFunc),0!==this.stencilRef&&(r.stencilRef=this.stencilRef),255!==this.stencilFuncMask&&(r.stencilFuncMask=this.stencilFuncMask),7680!==this.stencilFail&&(r.stencilFail=this.stencilFail),7680!==this.stencilZFail&&(r.stencilZFail=this.stencilZFail),7680!==this.stencilZPass&&(r.stencilZPass=this.stencilZPass),!0===this.stencilWrite&&(r.stencilWrite=this.stencilWrite),void 0!==this.rotation&&0!==this.rotation&&(r.rotation=this.rotation),!0===this.polygonOffset&&(r.polygonOffset=!0),0!==this.polygonOffsetFactor&&(r.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(r.polygonOffsetUnits=this.polygonOffsetUnits),void 0!==this.linewidth&&1!==this.linewidth&&(r.linewidth=this.linewidth),void 0!==this.dashSize&&(r.dashSize=this.dashSize),void 0!==this.gapSize&&(r.gapSize=this.gapSize),void 0!==this.scale&&(r.scale=this.scale),!0===this.dithering&&(r.dithering=!0),this.alphaTest>0&&(r.alphaTest=this.alphaTest),!0===this.alphaHash&&(r.alphaHash=!0),!0===this.alphaToCoverage&&(r.alphaToCoverage=!0),!0===this.premultipliedAlpha&&(r.premultipliedAlpha=!0),!0===this.forceSinglePass&&(r.forceSinglePass=!0),!1===this.allowOverride&&(r.allowOverride=!1),!0===this.wireframe&&(r.wireframe=!0),this.wireframeLinewidth>1&&(r.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(r.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(r.wireframeLinejoin=this.wireframeLinejoin),!0===this.flatShading&&(r.flatShading=!0),!1===this.visible&&(r.visible=!1),!1===this.toneMapped&&(r.toneMapped=!1),!1===this.fog&&(r.fog=!1),Object.keys(this.userData).length>0&&(r.userData=this.userData),i){let i=n(e.textures),a=n(e.images);i.length>0&&(r.textures=i),a.length>0&&(r.images=a)}return r}clone(){return new this.constructor().copy(this)}copy(e){this.name=e.name,this.blending=e.blending,this.side=e.side,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.blendColor.copy(e.blendColor),this.blendAlpha=e.blendAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.stencilWriteMask=e.stencilWriteMask,this.stencilFunc=e.stencilFunc,this.stencilRef=e.stencilRef,this.stencilFuncMask=e.stencilFuncMask,this.stencilFail=e.stencilFail,this.stencilZFail=e.stencilZFail,this.stencilZPass=e.stencilZPass,this.stencilWrite=e.stencilWrite;let i=e.clippingPlanes,r=null;if(null!==i){let e=i.length;r=Array(e);for(let n=0;n!==e;++n)r[n]=i[n].clone()}return this.clippingPlanes=r,this.clipIntersection=e.clipIntersection,this.clipShadows=e.clipShadows,this.shadowSide=e.shadowSide,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.alphaHash=e.alphaHash,this.alphaToCoverage=e.alphaToCoverage,this.premultipliedAlpha=e.premultipliedAlpha,this.forceSinglePass=e.forceSinglePass,this.allowOverride=e.allowOverride,this.visible=e.visible,this.toneMapped=e.toneMapped,this.userData=JSON.parse(JSON.stringify(e.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(e){!0===e&&this.version++}}class rV extends rk{constructor(e){super(),this.isMeshBasicMaterial=!0,this.type="MeshBasicMaterial",this.color=new rF(0xffffff),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new rt,this.combine=ei,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.fog=e.fog,this}}let rH=new ia,rG=new ii,rW=0;class rX{constructor(e,i,r=!1){if(Array.isArray(e))throw TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,Object.defineProperty(this,"id",{value:rW++}),this.name="",this.array=e,this.itemSize=i,this.count=void 0!==e?e.length/i:0,this.normalized=r,this.usage=35044,this.updateRanges=[],this.gpuType=eU,this.version=0}onUploadCallback(){}set needsUpdate(e){!0===e&&this.version++}setUsage(e){return this.usage=e,this}addUpdateRange(e,i){this.updateRanges.push({start:e,count:i})}clearUpdateRanges(){this.updateRanges.length=0}copy(e){return this.name=e.name,this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.usage=e.usage,this.gpuType=e.gpuType,this}copyAt(e,i,r){e*=this.itemSize,r*=i.itemSize;for(let n=0,a=this.itemSize;n<a;n++)this.array[e+n]=i.array[r+n];return this}copyArray(e){return this.array.set(e),this}applyMatrix3(e){if(2===this.itemSize)for(let i=0,r=this.count;i<r;i++)rG.fromBufferAttribute(this,i),rG.applyMatrix3(e),this.setXY(i,rG.x,rG.y);else if(3===this.itemSize)for(let i=0,r=this.count;i<r;i++)rH.fromBufferAttribute(this,i),rH.applyMatrix3(e),this.setXYZ(i,rH.x,rH.y,rH.z);return this}applyMatrix4(e){for(let i=0,r=this.count;i<r;i++)rH.fromBufferAttribute(this,i),rH.applyMatrix4(e),this.setXYZ(i,rH.x,rH.y,rH.z);return this}applyNormalMatrix(e){for(let i=0,r=this.count;i<r;i++)rH.fromBufferAttribute(this,i),rH.applyNormalMatrix(e),this.setXYZ(i,rH.x,rH.y,rH.z);return this}transformDirection(e){for(let i=0,r=this.count;i<r;i++)rH.fromBufferAttribute(this,i),rH.transformDirection(e),this.setXYZ(i,rH.x,rH.y,rH.z);return this}set(e,i=0){return this.array.set(e,i),this}getComponent(e,i){let r=this.array[e*this.itemSize+i];return this.normalized&&(r=t7(r,this.array)),r}setComponent(e,i,r){return this.normalized&&(r=ie(r,this.array)),this.array[e*this.itemSize+i]=r,this}getX(e){let i=this.array[e*this.itemSize];return this.normalized&&(i=t7(i,this.array)),i}setX(e,i){return this.normalized&&(i=ie(i,this.array)),this.array[e*this.itemSize]=i,this}getY(e){let i=this.array[e*this.itemSize+1];return this.normalized&&(i=t7(i,this.array)),i}setY(e,i){return this.normalized&&(i=ie(i,this.array)),this.array[e*this.itemSize+1]=i,this}getZ(e){let i=this.array[e*this.itemSize+2];return this.normalized&&(i=t7(i,this.array)),i}setZ(e,i){return this.normalized&&(i=ie(i,this.array)),this.array[e*this.itemSize+2]=i,this}getW(e){let i=this.array[e*this.itemSize+3];return this.normalized&&(i=t7(i,this.array)),i}setW(e,i){return this.normalized&&(i=ie(i,this.array)),this.array[e*this.itemSize+3]=i,this}setXY(e,i,r){return e*=this.itemSize,this.normalized&&(i=ie(i,this.array),r=ie(r,this.array)),this.array[e+0]=i,this.array[e+1]=r,this}setXYZ(e,i,r,n){return e*=this.itemSize,this.normalized&&(i=ie(i,this.array),r=ie(r,this.array),n=ie(n,this.array)),this.array[e+0]=i,this.array[e+1]=r,this.array[e+2]=n,this}setXYZW(e,i,r,n,a){return e*=this.itemSize,this.normalized&&(i=ie(i,this.array),r=ie(r,this.array),n=ie(n,this.array),a=ie(a,this.array)),this.array[e+0]=i,this.array[e+1]=r,this.array[e+2]=n,this.array[e+3]=a,this}onUpload(e){return this.onUploadCallback=e,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){let e={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return""!==this.name&&(e.name=this.name),35044!==this.usage&&(e.usage=this.usage),e}}class rj extends rX{constructor(e,i,r){super(new Uint16Array(e),i,r)}}class rq extends rX{constructor(e,i,r){super(new Uint32Array(e),i,r)}}class rY extends rX{constructor(e,i,r){super(new Float32Array(e),i,r)}}let rK=0,rJ=new i1,rZ=new r_,rQ=new ia,r$=new iR,r0=new iR,r1=new ia;class r3 extends t0{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:rK++}),this.uuid=t5(),this.name="",this.type="BufferGeometry",this.index=null,this.indirect=null,this.indirectOffset=0,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(e){return Array.isArray(e)?this.index=new(tX(e)?rq:rj)(e,1):this.index=e,this}setIndirect(e,i=0){return this.indirect=e,this.indirectOffset=i,this}getIndirect(){return this.indirect}getAttribute(e){return this.attributes[e]}setAttribute(e,i){return this.attributes[e]=i,this}deleteAttribute(e){return delete this.attributes[e],this}hasAttribute(e){return void 0!==this.attributes[e]}addGroup(e,i,r=0){this.groups.push({start:e,count:i,materialIndex:r})}clearGroups(){this.groups=[]}setDrawRange(e,i){this.drawRange.start=e,this.drawRange.count=i}applyMatrix4(e){let i=this.attributes.position;void 0!==i&&(i.applyMatrix4(e),i.needsUpdate=!0);let r=this.attributes.normal;if(void 0!==r){let i=new il().getNormalMatrix(e);r.applyNormalMatrix(i),r.needsUpdate=!0}let n=this.attributes.tangent;return void 0!==n&&(n.transformDirection(e),n.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}applyQuaternion(e){return rJ.makeRotationFromQuaternion(e),this.applyMatrix4(rJ),this}rotateX(e){return rJ.makeRotationX(e),this.applyMatrix4(rJ),this}rotateY(e){return rJ.makeRotationY(e),this.applyMatrix4(rJ),this}rotateZ(e){return rJ.makeRotationZ(e),this.applyMatrix4(rJ),this}translate(e,i,r){return rJ.makeTranslation(e,i,r),this.applyMatrix4(rJ),this}scale(e,i,r){return rJ.makeScale(e,i,r),this.applyMatrix4(rJ),this}lookAt(e){return rZ.lookAt(e),rZ.updateMatrix(),this.applyMatrix4(rZ.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(rQ).negate(),this.translate(rQ.x,rQ.y,rQ.z),this}setFromPoints(e){let i=this.getAttribute("position");if(void 0===i){let i=[];for(let r=0,n=e.length;r<n;r++){let n=e[r];i.push(n.x,n.y,n.z||0)}this.setAttribute("position",new rY(i,3))}else{let r=Math.min(e.length,i.count);for(let n=0;n<r;n++){let r=e[n];i.setXYZ(n,r.x,r.y,r.z||0)}e.length>i.count&&tJ("BufferGeometry: Buffer size too small for points data. Use .dispose() and create a new geometry."),i.needsUpdate=!0}return this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new iR);let e=this.attributes.position,i=this.morphAttributes.position;if(e&&e.isGLBufferAttribute){tZ("BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box.",this),this.boundingBox.set(new ia(-1/0,-1/0,-1/0),new ia(Infinity,Infinity,Infinity));return}if(void 0!==e){if(this.boundingBox.setFromBufferAttribute(e),i)for(let e=0,r=i.length;e<r;e++){let r=i[e];r$.setFromBufferAttribute(r),this.morphTargetsRelative?(r1.addVectors(this.boundingBox.min,r$.min),this.boundingBox.expandByPoint(r1),r1.addVectors(this.boundingBox.max,r$.max),this.boundingBox.expandByPoint(r1)):(this.boundingBox.expandByPoint(r$.min),this.boundingBox.expandByPoint(r$.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&tZ('BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new ij);let e=this.attributes.position,i=this.morphAttributes.position;if(e&&e.isGLBufferAttribute){tZ("BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere.",this),this.boundingSphere.set(new ia,1/0);return}if(e){let r=this.boundingSphere.center;if(r$.setFromBufferAttribute(e),i)for(let e=0,r=i.length;e<r;e++){let r=i[e];r0.setFromBufferAttribute(r),this.morphTargetsRelative?(r1.addVectors(r$.min,r0.min),r$.expandByPoint(r1),r1.addVectors(r$.max,r0.max),r$.expandByPoint(r1)):(r$.expandByPoint(r0.min),r$.expandByPoint(r0.max))}r$.getCenter(r);let n=0;for(let i=0,a=e.count;i<a;i++)r1.fromBufferAttribute(e,i),n=Math.max(n,r.distanceToSquared(r1));if(i)for(let a=0,s=i.length;a<s;a++){let s=i[a],o=this.morphTargetsRelative;for(let i=0,a=s.count;i<a;i++)r1.fromBufferAttribute(s,i),o&&(rQ.fromBufferAttribute(e,i),r1.add(rQ)),n=Math.max(n,r.distanceToSquared(r1))}this.boundingSphere.radius=Math.sqrt(n),isNaN(this.boundingSphere.radius)&&tZ('BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}computeTangents(){let e=this.index,i=this.attributes;if(null===e||void 0===i.position||void 0===i.normal||void 0===i.uv)return void tZ("BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");let r=i.position,n=i.normal,a=i.uv;!1===this.hasAttribute("tangent")&&this.setAttribute("tangent",new rX(new Float32Array(4*r.count),4));let s=this.getAttribute("tangent"),o=[],l=[];for(let e=0;e<r.count;e++)o[e]=new ia,l[e]=new ia;let c=new ia,h=new ia,u=new ia,d=new ii,p=new ii,f=new ii,m=new ia,g=new ia,v=this.groups;0===v.length&&(v=[{start:0,count:e.count}]);for(let i=0,n=v.length;i<n;++i){let n=v[i],s=n.start,_=n.count;for(let i=s,n=s+_;i<n;i+=3)!function(e,i,n){c.fromBufferAttribute(r,e),h.fromBufferAttribute(r,i),u.fromBufferAttribute(r,n),d.fromBufferAttribute(a,e),p.fromBufferAttribute(a,i),f.fromBufferAttribute(a,n),h.sub(c),u.sub(c),p.sub(d),f.sub(d);let s=1/(p.x*f.y-f.x*p.y);isFinite(s)&&(m.copy(h).multiplyScalar(f.y).addScaledVector(u,-p.y).multiplyScalar(s),g.copy(u).multiplyScalar(p.x).addScaledVector(h,-f.x).multiplyScalar(s),o[e].add(m),o[i].add(m),o[n].add(m),l[e].add(g),l[i].add(g),l[n].add(g))}(e.getX(i+0),e.getX(i+1),e.getX(i+2))}let _=new ia,y=new ia,x=new ia,M=new ia;function S(e){x.fromBufferAttribute(n,e),M.copy(x);let i=o[e];_.copy(i),_.sub(x.multiplyScalar(x.dot(i))).normalize(),y.crossVectors(M,i);let r=y.dot(l[e]);s.setXYZW(e,_.x,_.y,_.z,r<0?-1:1)}for(let i=0,r=v.length;i<r;++i){let r=v[i],n=r.start,a=r.count;for(let i=n,r=n+a;i<r;i+=3)S(e.getX(i+0)),S(e.getX(i+1)),S(e.getX(i+2))}}computeVertexNormals(){let e=this.index,i=this.getAttribute("position");if(void 0!==i){let r=this.getAttribute("normal");if(void 0===r)r=new rX(new Float32Array(3*i.count),3),this.setAttribute("normal",r);else for(let e=0,i=r.count;e<i;e++)r.setXYZ(e,0,0,0);let n=new ia,a=new ia,s=new ia,o=new ia,l=new ia,c=new ia,h=new ia,u=new ia;if(e)for(let d=0,p=e.count;d<p;d+=3){let p=e.getX(d+0),f=e.getX(d+1),m=e.getX(d+2);n.fromBufferAttribute(i,p),a.fromBufferAttribute(i,f),s.fromBufferAttribute(i,m),h.subVectors(s,a),u.subVectors(n,a),h.cross(u),o.fromBufferAttribute(r,p),l.fromBufferAttribute(r,f),c.fromBufferAttribute(r,m),o.add(h),l.add(h),c.add(h),r.setXYZ(p,o.x,o.y,o.z),r.setXYZ(f,l.x,l.y,l.z),r.setXYZ(m,c.x,c.y,c.z)}else for(let e=0,o=i.count;e<o;e+=3)n.fromBufferAttribute(i,e+0),a.fromBufferAttribute(i,e+1),s.fromBufferAttribute(i,e+2),h.subVectors(s,a),u.subVectors(n,a),h.cross(u),r.setXYZ(e+0,h.x,h.y,h.z),r.setXYZ(e+1,h.x,h.y,h.z),r.setXYZ(e+2,h.x,h.y,h.z);this.normalizeNormals(),r.needsUpdate=!0}}normalizeNormals(){let e=this.attributes.normal;for(let i=0,r=e.count;i<r;i++)r1.fromBufferAttribute(e,i),r1.normalize(),e.setXYZ(i,r1.x,r1.y,r1.z)}toNonIndexed(){function e(e,i){let r=e.array,n=e.itemSize,a=e.normalized,s=new r.constructor(i.length*n),o=0,l=0;for(let a=0,c=i.length;a<c;a++){o=e.isInterleavedBufferAttribute?i[a]*e.data.stride+e.offset:i[a]*n;for(let e=0;e<n;e++)s[l++]=r[o++]}return new rX(s,n,a)}if(null===this.index)return tJ("BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;let i=new r3,r=this.index.array,n=this.attributes;for(let a in n){let s=e(n[a],r);i.setAttribute(a,s)}let a=this.morphAttributes;for(let n in a){let s=[],o=a[n];for(let i=0,n=o.length;i<n;i++){let n=e(o[i],r);s.push(n)}i.morphAttributes[n]=s}i.morphTargetsRelative=this.morphTargetsRelative;let s=this.groups;for(let e=0,r=s.length;e<r;e++){let r=s[e];i.addGroup(r.start,r.count,r.materialIndex)}return i}toJSON(){let e={metadata:{version:4.7,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),Object.keys(this.userData).length>0&&(e.userData=this.userData),void 0!==this.parameters){let i=this.parameters;for(let r in i)void 0!==i[r]&&(e[r]=i[r]);return e}e.data={attributes:{}};let i=this.index;null!==i&&(e.data.index={type:i.array.constructor.name,array:Array.prototype.slice.call(i.array)});let r=this.attributes;for(let i in r){let n=r[i];e.data.attributes[i]=n.toJSON(e.data)}let n={},a=!1;for(let i in this.morphAttributes){let r=this.morphAttributes[i],s=[];for(let i=0,n=r.length;i<n;i++){let n=r[i];s.push(n.toJSON(e.data))}s.length>0&&(n[i]=s,a=!0)}a&&(e.data.morphAttributes=n,e.data.morphTargetsRelative=this.morphTargetsRelative);let s=this.groups;s.length>0&&(e.data.groups=JSON.parse(JSON.stringify(s)));let o=this.boundingSphere;return null!==o&&(e.data.boundingSphere=o.toJSON()),e}clone(){return new this.constructor().copy(this)}copy(e){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;let i={};this.name=e.name;let r=e.index;null!==r&&this.setIndex(r.clone());let n=e.attributes;for(let e in n){let r=n[e];this.setAttribute(e,r.clone(i))}let a=e.morphAttributes;for(let e in a){let r=[],n=a[e];for(let e=0,a=n.length;e<a;e++)r.push(n[e].clone(i));this.morphAttributes[e]=r}this.morphTargetsRelative=e.morphTargetsRelative;let s=e.groups;for(let e=0,i=s.length;e<i;e++){let i=s[e];this.addGroup(i.start,i.count,i.materialIndex)}let o=e.boundingBox;null!==o&&(this.boundingBox=o.clone());let l=e.boundingSphere;return null!==l&&(this.boundingSphere=l.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this.userData=e.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}let r2=new i1,r4=new i0,r5=new ij,r6=new ia,r8=new ia,r9=new ia,r7=new ia,ne=new ia,nt=new ia,ni=new ia,nr=new ia;class nn extends r_{constructor(e=new r3,i=new rV){super(),this.isMesh=!0,this.type="Mesh",this.geometry=e,this.material=i,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.count=1,this.updateMorphTargets()}copy(e,i){return super.copy(e,i),void 0!==e.morphTargetInfluences&&(this.morphTargetInfluences=e.morphTargetInfluences.slice()),void 0!==e.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},e.morphTargetDictionary)),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}updateMorphTargets(){let e=this.geometry.morphAttributes,i=Object.keys(e);if(i.length>0){let r=e[i[0]];if(void 0!==r){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,i=r.length;e<i;e++){let i=r[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=e}}}}getVertexPosition(e,i){let r=this.geometry,n=r.attributes.position,a=r.morphAttributes.position,s=r.morphTargetsRelative;i.fromBufferAttribute(n,e);let o=this.morphTargetInfluences;if(a&&o){nt.set(0,0,0);for(let r=0,n=a.length;r<n;r++){let n=o[r],l=a[r];0!==n&&(ne.fromBufferAttribute(l,e),s?nt.addScaledVector(ne,n):nt.addScaledVector(ne.sub(i),n))}i.add(nt)}return i}raycast(e,i){let r=this.geometry,n=this.material,a=this.matrixWorld;void 0===n||(null===r.boundingSphere&&r.computeBoundingSphere(),r5.copy(r.boundingSphere),r5.applyMatrix4(a),r4.copy(e.ray).recast(e.near),!1===r5.containsPoint(r4.origin)&&(null===r4.intersectSphere(r5,r6)||r4.origin.distanceToSquared(r6)>(e.far-e.near)**2)||(r2.copy(a).invert(),r4.copy(e.ray).applyMatrix4(r2),(null===r.boundingBox||!1!==r4.intersectsBox(r.boundingBox))&&this._computeIntersections(e,i,r4)))}_computeIntersections(e,i,r){let n,a=this.geometry,s=this.material,o=a.index,l=a.attributes.position,c=a.attributes.uv,h=a.attributes.uv1,u=a.attributes.normal,d=a.groups,p=a.drawRange;if(null!==o)if(Array.isArray(s))for(let a=0,l=d.length;a<l;a++){let l=d[a],f=s[l.materialIndex],m=Math.max(l.start,p.start),g=Math.min(o.count,Math.min(l.start+l.count,p.start+p.count));for(let a=m;a<g;a+=3)(n=na(this,f,e,r,c,h,u,o.getX(a),o.getX(a+1),o.getX(a+2)))&&(n.faceIndex=Math.floor(a/3),n.face.materialIndex=l.materialIndex,i.push(n))}else{let a=Math.max(0,p.start),l=Math.min(o.count,p.start+p.count);for(let d=a;d<l;d+=3)(n=na(this,s,e,r,c,h,u,o.getX(d),o.getX(d+1),o.getX(d+2)))&&(n.faceIndex=Math.floor(d/3),i.push(n))}else if(void 0!==l)if(Array.isArray(s))for(let a=0,o=d.length;a<o;a++){let o=d[a],f=s[o.materialIndex],m=Math.max(o.start,p.start),g=Math.min(l.count,Math.min(o.start+o.count,p.start+p.count));for(let a=m;a<g;a+=3)(n=na(this,f,e,r,c,h,u,a,a+1,a+2))&&(n.faceIndex=Math.floor(a/3),n.face.materialIndex=o.materialIndex,i.push(n))}else{let a=Math.max(0,p.start),o=Math.min(l.count,p.start+p.count);for(let l=a;l<o;l+=3)(n=na(this,s,e,r,c,h,u,l,l+1,l+2))&&(n.faceIndex=Math.floor(l/3),i.push(n))}}}function na(e,i,r,n,a,s,o,l,c,h){e.getVertexPosition(l,r8),e.getVertexPosition(c,r9),e.getVertexPosition(h,r7);let u=function(e,i,r,n,a,s,o,l){if(null===(i.side===x?n.intersectTriangle(o,s,a,!0,l):n.intersectTriangle(a,s,o,i.side===y,l)))return null;nr.copy(l),nr.applyMatrix4(e.matrixWorld);let c=r.ray.origin.distanceTo(nr);return c<r.near||c>r.far?null:{distance:c,point:nr.clone(),object:e}}(e,i,r,n,r8,r9,r7,ni);if(u){let e=new ia;rL.getBarycoord(ni,r8,r9,r7,e),a&&(u.uv=rL.getInterpolatedAttribute(a,l,c,h,e,new ii)),s&&(u.uv1=rL.getInterpolatedAttribute(s,l,c,h,e,new ii)),o&&(u.normal=rL.getInterpolatedAttribute(o,l,c,h,e,new ia),u.normal.dot(n.direction)>0&&u.normal.multiplyScalar(-1));let i={a:l,b:c,c:h,normal:new ia,materialIndex:0};rL.getNormal(r8,r9,r7,i.normal),u.face=i,u.barycoord=e}return u}class ns extends r3{constructor(e=1,i=1,r=1,n=1,a=1,s=1){super(),this.type="BoxGeometry",this.parameters={width:e,height:i,depth:r,widthSegments:n,heightSegments:a,depthSegments:s};const o=this;n=Math.floor(n),a=Math.floor(a);const l=[],c=[],h=[],u=[];let d=0,p=0;function f(e,i,r,n,a,s,f,m,g,v,_){let y=s/g,x=f/v,M=s/2,S=f/2,b=m/2,T=g+1,E=v+1,w=0,A=0,R=new ia;for(let s=0;s<E;s++){let o=s*x-S;for(let l=0;l<T;l++){let d=l*y-M;R[e]=d*n,R[i]=o*a,R[r]=b,c.push(R.x,R.y,R.z),R[e]=0,R[i]=0,R[r]=m>0?1:-1,h.push(R.x,R.y,R.z),u.push(l/g),u.push(1-s/v),w+=1}}for(let e=0;e<v;e++)for(let i=0;i<g;i++){let r=d+i+T*e,n=d+i+T*(e+1),a=d+(i+1)+T*(e+1),s=d+(i+1)+T*e;l.push(r,n,s),l.push(n,a,s),A+=6}o.addGroup(p,A,_),p+=A,d+=w}f("z","y","x",-1,-1,r,i,e,s=Math.floor(s),a,0),f("z","y","x",1,-1,r,i,-e,s,a,1),f("x","z","y",1,1,e,r,i,n,s,2),f("x","z","y",1,-1,e,r,-i,n,s,3),f("x","y","z",1,-1,e,i,r,n,a,4),f("x","y","z",-1,-1,e,i,-r,n,a,5),this.setIndex(l),this.setAttribute("position",new rY(c,3)),this.setAttribute("normal",new rY(h,3)),this.setAttribute("uv",new rY(u,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new ns(e.width,e.height,e.depth,e.widthSegments,e.heightSegments,e.depthSegments)}}function no(e){let i={};for(let r in e)for(let n in i[r]={},e[r]){let a=e[r][n];a&&(a.isColor||a.isMatrix3||a.isMatrix4||a.isVector2||a.isVector3||a.isVector4||a.isTexture||a.isQuaternion)?a.isRenderTargetTexture?(tJ("UniformsUtils: Textures of render targets cannot be cloned via cloneUniforms() or mergeUniforms()."),i[r][n]=null):i[r][n]=a.clone():Array.isArray(a)?i[r][n]=a.slice():i[r][n]=a}return i}function nl(e){let i={};for(let r=0;r<e.length;r++){let n=no(e[r]);for(let e in n)i[e]=n[e]}return i}function nc(e){let i=e.getRenderTarget();return null===i?e.outputColorSpace:!0===i.isXRRenderTarget?i.texture.colorSpace:id.workingColorSpace}let nh={clone:no,merge:nl};var nu=`void main() {
+(()=>{var e,i,r,n,a={"./node_modules/interactjs/dist/interact.min.js"(e,i,r){e=r.nmd(e),e.exports=function(){"use strict";function i(e,i){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);i&&(n=n.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),r.push.apply(r,n)}return r}function r(e){for(var r=1;r<arguments.length;r++){var n=null!=arguments[r]?arguments[r]:{};r%2?i(Object(n),!0).forEach(function(i){var r,a,s;r=e,a=i,s=n[i],(a=f(a))in r?Object.defineProperty(r,a,{value:s,enumerable:!0,configurable:!0,writable:!0}):r[a]=s}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach(function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))})}return e}function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function a(e,i){if(!(e instanceof i))throw TypeError("Cannot call a class as a function")}function s(e,i){for(var r=0;r<i.length;r++){var n=i[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,f(n.key),n)}}function o(e,i,r){return i&&s(e.prototype,i),r&&s(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function l(e,i){if("function"!=typeof i&&null!==i)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(i&&i.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),i&&h(e,i)}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function h(e,i){return(h=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,i){return e.__proto__=i,e})(e,i)}function u(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function d(e){var i=function(){if("u"<typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var r,n=c(e);r=i?Reflect.construct(n,arguments,c(this).constructor):n.apply(this,arguments);if(r&&("object"==typeof r||"function"==typeof r))return r;if(void 0!==r)throw TypeError("Derived constructors may only return object or undefined");return u(this)}}function p(){return(p="u">typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,i,r){var n=function(e,i){for(;!Object.prototype.hasOwnProperty.call(e,i)&&null!==(e=c(e)););return e}(e,i);if(n){var a=Object.getOwnPropertyDescriptor(n,i);return a.get?a.get.call(arguments.length<3?e:r):a.value}}).apply(this,arguments)}function f(e){var i=function(e,i){if("object"!=typeof e||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,i||"default");if("object"!=typeof n)return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===i?String:Number)(e)}(e,"string");return"symbol"==typeof i?i:i+""}var m,g,v,_=function(e){return!(!e||!e.Window)&&e instanceof e.Window},x=void 0,y=void 0;function M(e){x=e;var i=e.document.createTextNode("");i.ownerDocument!==e.document&&"function"==typeof e.wrap&&e.wrap(i)===i&&(e=e.wrap(e)),y=e}function S(e){return _(e)?e:(e.ownerDocument||e).defaultView||y.window}"u">typeof window&&window&&M(window);var b=function(e){return!!e&&"object"===n(e)},T=function(e){return"function"==typeof e},E=function(e){return e===y||_(e)},w=function(e){return b(e)&&11===e.nodeType},A=function(e){return"number"==typeof e},R=function(e){return"boolean"==typeof e},C=function(e){return"string"==typeof e},P=function(e){if(!e||"object"!==n(e))return!1;var i=S(e)||y;return/object|function/.test("u"<typeof Element?"undefined":n(Element))?e instanceof Element||e instanceof i.Element:1===e.nodeType&&"string"==typeof e.nodeName},I=function(e){return b(e)&&!!e.constructor&&/function Object\b/.test(e.constructor.toString())},L=function(e){return b(e)&&void 0!==e.length&&T(e.splice)};function D(e){var i=e.interaction;if("drag"===i.prepared.name){var r=i.prepared.axis;"x"===r?(i.coords.cur.page.y=i.coords.start.page.y,i.coords.cur.client.y=i.coords.start.client.y,i.coords.velocity.client.y=0,i.coords.velocity.page.y=0):"y"===r&&(i.coords.cur.page.x=i.coords.start.page.x,i.coords.cur.client.x=i.coords.start.client.x,i.coords.velocity.client.x=0,i.coords.velocity.page.x=0)}}function U(e){var i=e.iEvent,r=e.interaction;if("drag"===r.prepared.name){var n=r.prepared.axis;if("x"===n||"y"===n){var a="x"===n?"y":"x";i.page[a]=r.coords.start.page[a],i.client[a]=r.coords.start.client[a],i.delta[a]=0}}}var N={id:"actions/drag",install:function(e){var i=e.actions,r=e.Interactable,n=e.defaults;r.prototype.draggable=N.draggable,i.map.drag=N,i.methodDict.drag="draggable",n.actions.drag=N.defaults},listeners:{"interactions:before-action-move":D,"interactions:action-resume":D,"interactions:action-move":U,"auto-start:check":function(e){var i=e.interaction,r=e.interactable,n=e.buttons,a=r.options.drag;if(a&&a.enabled&&(!i.pointerIsDown||!/mouse|pointer/.test(i.pointerType)||0!=(n&r.options.drag.mouseButtons)))return e.action={name:"drag",axis:"start"===a.lockAxis?a.startAxis:a.lockAxis},!1}},draggable:function(e){return b(e)?(this.options.drag.enabled=!1!==e.enabled,this.setPerAction("drag",e),this.setOnEvents("drag",e),/^(xy|x|y|start)$/.test(e.lockAxis)&&(this.options.drag.lockAxis=e.lockAxis),/^(xy|x|y)$/.test(e.startAxis)&&(this.options.drag.startAxis=e.startAxis),this):R(e)?(this.options.drag.enabled=e,this):this.options.drag},beforeMove:D,move:U,defaults:{startAxis:"xy",lockAxis:"xy"},getCursor:function(){return"move"},filterEventType:function(e){return 0===e.search("drag")}},O={init:function(e){O.document=e.document,O.DocumentFragment=e.DocumentFragment||F,O.SVGElement=e.SVGElement||F,O.SVGSVGElement=e.SVGSVGElement||F,O.SVGElementInstance=e.SVGElementInstance||F,O.Element=e.Element||F,O.HTMLElement=e.HTMLElement||O.Element,O.Event=e.Event,O.Touch=e.Touch||F,O.PointerEvent=e.PointerEvent||e.MSPointerEvent},document:null,DocumentFragment:null,SVGElement:null,SVGSVGElement:null,SVGElementInstance:null,Element:null,HTMLElement:null,Event:null,Touch:null,PointerEvent:null};function F(){}var B={init:function(e){var i=O.Element,r=e.navigator||{};B.supportsTouch="ontouchstart"in e||T(e.DocumentTouch)&&O.document instanceof e.DocumentTouch,B.supportsPointerEvent=!1!==r.pointerEnabled&&!!O.PointerEvent,B.isIOS=/iP(hone|od|ad)/.test(r.platform),B.isIOS7=/iP(hone|od|ad)/.test(r.platform)&&/OS 7[^\d]/.test(r.appVersion),B.isIe9=/MSIE 9/.test(r.userAgent),B.isOperaMobile="Opera"===r.appName&&B.supportsTouch&&/Presto/.test(r.userAgent),B.prefixedMatchesSelector="matches"in i.prototype?"matches":"webkitMatchesSelector"in i.prototype?"webkitMatchesSelector":"mozMatchesSelector"in i.prototype?"mozMatchesSelector":"oMatchesSelector"in i.prototype?"oMatchesSelector":"msMatchesSelector",B.pEventTypes=B.supportsPointerEvent?O.PointerEvent===e.MSPointerEvent?{up:"MSPointerUp",down:"MSPointerDown",over:"mouseover",out:"mouseout",move:"MSPointerMove",cancel:"MSPointerCancel"}:{up:"pointerup",down:"pointerdown",over:"pointerover",out:"pointerout",move:"pointermove",cancel:"pointercancel"}:null,B.wheelEvent=O.document&&"onmousewheel"in O.document?"mousewheel":"wheel"},supportsTouch:null,supportsPointerEvent:null,isIOS7:null,isIOS:null,isIe9:null,isOperaMobile:null,prefixedMatchesSelector:null,pEventTypes:null,wheelEvent:null};function z(e,i){if(e.contains)return e.contains(i);for(;i;){if(i===e)return!0;i=i.parentNode}return!1}function k(e,i){for(;P(e);){if(H(e,i))return e;e=V(e)}return null}function V(e){var i=e.parentNode;if(w(i))for(;(i=i.host)&&w(i););return i}function H(e,i){return y!==x&&(i=i.replace(/\/deep\//g," ")),e[B.prefixedMatchesSelector](i)}var G=function(e){return e.parentNode||e.host};function W(e,i){for(var r,n=[],a=e;(r=G(a))&&a!==i&&r!==a.ownerDocument;)n.unshift(a),a=r;return n}function X(e,i,r){for(;P(e);){if(H(e,i))return!0;if((e=V(e))===r)return H(e,i)}return!1}function j(e){return e.correspondingUseElement||e}function q(e){var i=e instanceof O.SVGElement?e.getBoundingClientRect():e.getClientRects()[0];return i&&{left:i.left,right:i.right,top:i.top,bottom:i.bottom,width:i.width||i.right-i.left,height:i.height||i.bottom-i.top}}function Y(e){var i,r=q(e);if(!B.isIOS7&&r){var n={x:(i=(i=S(e))||y).scrollX||i.document.documentElement.scrollLeft,y:i.scrollY||i.document.documentElement.scrollTop};r.left+=n.x,r.right+=n.x,r.top+=n.y,r.bottom+=n.y}return r}function K(e){for(var i=[];e;)i.push(e),e=V(e);return i}function J(e){return!!C(e)&&(O.document.querySelector(e),!0)}function Z(e,i){for(var r in i)e[r]=i[r];return e}function Q(e,i,r){return"parent"===e?V(r):"self"===e?i.getRect(r):k(r,e)}function $(e,i,r,n){var a=e;return C(a)?a=Q(a,i,r):T(a)&&(a=a.apply(void 0,n)),P(a)&&(a=Y(a)),a}function ee(e){return e&&{x:"x"in e?e.x:e.left,y:"y"in e?e.y:e.top}}function et(e){return!e||"x"in e&&"y"in e||((e=Z({},e)).x=e.left||0,e.y=e.top||0,e.width=e.width||(e.right||0)-e.x,e.height=e.height||(e.bottom||0)-e.y),e}function ei(e,i,r){e.left&&(i.left+=r.x),e.right&&(i.right+=r.x),e.top&&(i.top+=r.y),e.bottom&&(i.bottom+=r.y),i.width=i.right-i.left,i.height=i.bottom-i.top}function er(e,i,r){var n=r&&e.options[r];return ee($(n&&n.origin||e.options.origin,e,i,[e&&i]))||{x:0,y:0}}function en(e,i){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(e){return!0},n=arguments.length>3?arguments[3]:void 0;if(n=n||{},C(e)&&-1!==e.search(" ")&&(e=ea(e)),L(e))return e.forEach(function(e){return en(e,i,r,n)}),n;if(b(e)&&(i=e,e=""),T(i)&&r(e))n[e]=n[e]||[],n[e].push(i);else if(L(i))for(var a=0,s=i;a<s.length;a++){var o=s[a];en(e,o,r,n)}else if(b(i))for(var l in i)en(ea(l).map(function(i){return"".concat(e).concat(i)}),i[l],r,n);return n}function ea(e){return e.trim().split(/ +/)}var es=function(e,i){return Math.sqrt(e*e+i*i)},eo=["webkit","moz"];function el(e,i){e.__set||(e.__set={});var r=function(r){if(eo.some(function(e){return 0===r.indexOf(e)}))return 1;"function"!=typeof e[r]&&"__set"!==r&&Object.defineProperty(e,r,{get:function(){return r in e.__set?e.__set[r]:e.__set[r]=i[r]},set:function(i){e.__set[r]=i},configurable:!0})};for(var n in i)r(n);return e}function ec(e,i){e.page=e.page||{},e.page.x=i.page.x,e.page.y=i.page.y,e.client=e.client||{},e.client.x=i.client.x,e.client.y=i.client.y,e.timeStamp=i.timeStamp}function eh(e){e.page.x=0,e.page.y=0,e.client.x=0,e.client.y=0}function eu(e){return e instanceof O.Event||e instanceof O.Touch}function ed(e,i,r){return e=e||"page",(r=r||{}).x=i[e+"X"],r.y=i[e+"Y"],r}function ep(e,i){return i=i||{x:0,y:0},B.isOperaMobile&&eu(e)?(ed("screen",e,i),i.x+=window.scrollX,i.y+=window.scrollY):ed("page",e,i),i}function ef(e){return A(e.pointerId)?e.pointerId:e.identifier}function em(e){var i=[];return L(e)?(i[0]=e[0],i[1]=e[1]):"touchend"===e.type?1===e.touches.length?(i[0]=e.touches[0],i[1]=e.changedTouches[0]):0===e.touches.length&&(i[0]=e.changedTouches[0],i[1]=e.changedTouches[1]):(i[0]=e.touches[0],i[1]=e.touches[1]),i}function eg(e){for(var i={pageX:0,pageY:0,clientX:0,clientY:0,screenX:0,screenY:0},r=0;r<e.length;r++){var n=e[r];for(var a in i)i[a]+=n[a]}for(var s in i)i[s]/=e.length;return i}function ev(e){if(!e.length)return null;var i=em(e),r=Math.min(i[0].pageX,i[1].pageX),n=Math.min(i[0].pageY,i[1].pageY),a=Math.max(i[0].pageX,i[1].pageX),s=Math.max(i[0].pageY,i[1].pageY);return{x:r,y:n,left:r,top:n,right:a,bottom:s,width:a-r,height:s-n}}function e_(e,i){var r=i+"X",n=i+"Y",a=em(e);return es(a[0][r]-a[1][r],a[0][n]-a[1][n])}function ex(e,i){var r=i+"X",n=i+"Y",a=em(e),s=a[1][r]-a[0][r];return 180*Math.atan2(a[1][n]-a[0][n],s)/Math.PI}function ey(e){return C(e.pointerType)?e.pointerType:A(e.pointerType)?[void 0,void 0,"touch","pen","mouse"][e.pointerType]:/touch/.test(e.type||"")||e instanceof O.Touch?"touch":"mouse"}function eM(e){var i=T(e.composedPath)?e.composedPath():e.path;return[j(i?i[0]:e.target),j(e.currentTarget)]}var eS=function(){function e(i){a(this,e),this.immediatePropagationStopped=!1,this.propagationStopped=!1,this._interaction=i}return o(e,[{key:"preventDefault",value:function(){}},{key:"stopPropagation",value:function(){this.propagationStopped=!0}},{key:"stopImmediatePropagation",value:function(){this.immediatePropagationStopped=this.propagationStopped=!0}}]),e}();Object.defineProperty(eS.prototype,"interaction",{get:function(){return this._interaction._proxy},set:function(){}});var eb=function(e,i){for(var r=0;r<i.length;r++){var n=i[r];e.push(n)}return e},eT=function(e){return eb([],e)},eE=function(e,i){for(var r=0;r<e.length;r++)if(i(e[r],r,e))return r;return -1},ew=function(e,i){return e[eE(e,i)]},eA=function(e){l(r,e);var i=d(r);function r(e,n,s){a(this,r),(o=i.call(this,n._interaction)).dropzone=void 0,o.dragEvent=void 0,o.relatedTarget=void 0,o.draggable=void 0,o.propagationStopped=!1,o.immediatePropagationStopped=!1;var o,l="dragleave"===s?e.prev:e.cur,c=l.element,h=l.dropzone;return o.type=s,o.target=c,o.currentTarget=c,o.dropzone=h,o.dragEvent=n,o.relatedTarget=n.target,o.draggable=n.interactable,o.timeStamp=n.timeStamp,o}return o(r,[{key:"reject",value:function(){var e=this,i=this._interaction.dropState;if("dropactivate"===this.type||this.dropzone&&i.cur.dropzone===this.dropzone&&i.cur.element===this.target)if(i.prev.dropzone=this.dropzone,i.prev.element=this.target,i.rejected=!0,i.events.enter=null,this.stopImmediatePropagation(),"dropactivate"===this.type){var n=eE(i.activeDrops,function(i){var r=i.dropzone,n=i.element;return r===e.dropzone&&n===e.target});i.activeDrops.splice(n,1);var a=new r(i,this.dragEvent,"dropdeactivate");a.dropzone=this.dropzone,a.target=this.target,this.dropzone.fire(a)}else this.dropzone.fire(new r(i,this.dragEvent,"dragleave"))}},{key:"preventDefault",value:function(){}},{key:"stopPropagation",value:function(){this.propagationStopped=!0}},{key:"stopImmediatePropagation",value:function(){this.immediatePropagationStopped=this.propagationStopped=!0}}]),r}(eS);function eR(e,i){for(var r=0,n=e.slice();r<n.length;r++){var a=n[r],s=a.dropzone,o=a.element;i.dropzone=s,i.target=o,s.fire(i),i.propagationStopped=i.immediatePropagationStopped=!1}}function eC(e,i){for(var r=function(e,i){for(var r=[],n=0,a=e.interactables.list;n<a.length;n++){var s=a[n];if(s.options.drop.enabled){var o=s.options.drop.accept;if(!(P(o)&&o!==i||C(o)&&!H(i,o)||T(o)&&!o({dropzone:s,draggableElement:i})))for(var l=0,c=s.getAllElements();l<c.length;l++){var h=c[l];h!==i&&r.push({dropzone:s,element:h,rect:s.getRect(h)})}}}return r}(e,i),n=0;n<r.length;n++){var a=r[n];a.rect=a.dropzone.getRect(a.element)}return r}function eP(e,i,r){for(var n=e.dropState,a=e.interactable,s=e.element,o=[],l=0,c=n.activeDrops;l<c.length;l++){var h=c[l],u=h.dropzone,d=h.element,p=h.rect,f=u.dropCheck(i,r,a,s,d,p);o.push(f?d:null)}var m=function(e){for(var i,r=[],n=0;n<e.length;n++){var a=e[n],s=e[i];if(a&&n!==i)if(s){var o=G(a),l=G(s);if(o!==a.ownerDocument)if(l!==a.ownerDocument)if(o!==l){r=r.length?r:W(s);var c=void 0;if(s instanceof O.HTMLElement&&a instanceof O.SVGElement&&!(a instanceof O.SVGSVGElement)){if(a===l)continue;c=a.ownerSVGElement}else c=a;for(var h=W(c,s.ownerDocument),u=0;h[u]&&h[u]===r[u];)u++;var d=[h[u-1],h[u],r[u]];if(d[0])for(var p=d[0].lastChild;p;){if(p===d[1]){i=n,r=h;break}if(p===d[2])break;p=p.previousSibling}}else(parseInt(S(a).getComputedStyle(a).zIndex,10)||0)>=(parseInt(S(s).getComputedStyle(s).zIndex,10)||0)&&(i=n);else i=n}else i=n}return i}(o);return n.activeDrops[m]||null}function eI(e,i,r){var n=e.dropState,a={enter:null,leave:null,activate:null,deactivate:null,move:null,drop:null};return"dragstart"===r.type&&(a.activate=new eA(n,r,"dropactivate"),a.activate.target=null,a.activate.dropzone=null),"dragend"===r.type&&(a.deactivate=new eA(n,r,"dropdeactivate"),a.deactivate.target=null,a.deactivate.dropzone=null),n.rejected||(n.cur.element!==n.prev.element&&(n.prev.dropzone&&(a.leave=new eA(n,r,"dragleave"),r.dragLeave=a.leave.target=n.prev.element,r.prevDropzone=a.leave.dropzone=n.prev.dropzone),n.cur.dropzone&&(a.enter=new eA(n,r,"dragenter"),r.dragEnter=n.cur.element,r.dropzone=n.cur.dropzone)),"dragend"===r.type&&n.cur.dropzone&&(a.drop=new eA(n,r,"drop"),r.dropzone=n.cur.dropzone,r.relatedTarget=n.cur.element),"dragmove"===r.type&&n.cur.dropzone&&(a.move=new eA(n,r,"dropmove"),r.dropzone=n.cur.dropzone)),a}function eL(e,i){var r=e.dropState,n=r.activeDrops,a=r.cur,s=r.prev;i.leave&&s.dropzone.fire(i.leave),i.enter&&a.dropzone.fire(i.enter),i.move&&a.dropzone.fire(i.move),i.drop&&a.dropzone.fire(i.drop),i.deactivate&&eR(n,i.deactivate),r.prev.dropzone=a.dropzone,r.prev.element=a.element}function eD(e,i){var r=e.interaction,n=e.iEvent,a=e.event;if("dragmove"===n.type||"dragend"===n.type){var s=r.dropState;i.dynamicDrop&&(s.activeDrops=eC(i,r.element));var o=eP(r,n,a);s.rejected=s.rejected&&!!o&&o.dropzone===s.cur.dropzone&&o.element===s.cur.element,s.cur.dropzone=o&&o.dropzone,s.cur.element=o&&o.element,s.events=eI(r,0,n)}}var eU={id:"actions/drop",install:function(e){var i=e.actions,r=e.interactStatic,n=e.Interactable,a=e.defaults;e.usePlugin(N),n.prototype.dropzone=function(e){return function(e,i){if(b(i)){if(e.options.drop.enabled=!1!==i.enabled,i.listeners){var r=en(i.listeners),n=Object.keys(r).reduce(function(e,i){return e[/^(enter|leave)/.test(i)?"drag".concat(i):/^(activate|deactivate|move)/.test(i)?"drop".concat(i):i]=r[i],e},{}),a=e.options.drop.listeners;a&&e.off(a),e.on(n),e.options.drop.listeners=n}return T(i.ondrop)&&e.on("drop",i.ondrop),T(i.ondropactivate)&&e.on("dropactivate",i.ondropactivate),T(i.ondropdeactivate)&&e.on("dropdeactivate",i.ondropdeactivate),T(i.ondragenter)&&e.on("dragenter",i.ondragenter),T(i.ondragleave)&&e.on("dragleave",i.ondragleave),T(i.ondropmove)&&e.on("dropmove",i.ondropmove),/^(pointer|center)$/.test(i.overlap)?e.options.drop.overlap=i.overlap:A(i.overlap)&&(e.options.drop.overlap=Math.max(Math.min(1,i.overlap),0)),"accept"in i&&(e.options.drop.accept=i.accept),"checker"in i&&(e.options.drop.checker=i.checker),e}return R(i)?(e.options.drop.enabled=i,e):e.options.drop}(this,e)},n.prototype.dropCheck=function(e,i,r,n,a,s){return function(e,i,r,n,a,s,o){var l=!1;if(!(o=o||e.getRect(s)))return!!e.options.drop.checker&&e.options.drop.checker(i,r,l,e,s,n,a);var c=e.options.drop.overlap;if("pointer"===c){var h=er(n,a,"drag"),u=ep(i);u.x+=h.x,u.y+=h.y;var d=u.x>o.left&&u.x<o.right,p=u.y>o.top&&u.y<o.bottom;l=d&&p}var f=n.getRect(a);if(f&&"center"===c){var m=f.left+f.width/2,g=f.top+f.height/2;l=m>=o.left&&m<=o.right&&g>=o.top&&g<=o.bottom}return f&&A(c)&&(l=Math.max(0,Math.min(o.right,f.right)-Math.max(o.left,f.left))*Math.max(0,Math.min(o.bottom,f.bottom)-Math.max(o.top,f.top))/(f.width*f.height)>=c),e.options.drop.checker&&(l=e.options.drop.checker(i,r,l,e,s,n,a)),l}(this,e,i,r,n,a,s)},r.dynamicDrop=function(i){return R(i)?(e.dynamicDrop=i,r):e.dynamicDrop},Z(i.phaselessTypes,{dragenter:!0,dragleave:!0,dropactivate:!0,dropdeactivate:!0,dropmove:!0,drop:!0}),i.methodDict.drop="dropzone",e.dynamicDrop=!1,a.actions.drop=eU.defaults},listeners:{"interactions:before-action-start":function(e){var i=e.interaction;"drag"===i.prepared.name&&(i.dropState={cur:{dropzone:null,element:null},prev:{dropzone:null,element:null},rejected:null,events:null,activeDrops:[]})},"interactions:after-action-start":function(e,i){var r=e.interaction,n=(e.event,e.iEvent);if("drag"===r.prepared.name){var a=r.dropState;a.activeDrops=[],a.events={},a.activeDrops=eC(i,r.element),a.events=eI(r,0,n),a.events.activate&&(eR(a.activeDrops,a.events.activate),i.fire("actions/drop:start",{interaction:r,dragEvent:n}))}},"interactions:action-move":eD,"interactions:after-action-move":function(e,i){var r=e.interaction,n=e.iEvent;if("drag"===r.prepared.name){var a=r.dropState;eL(r,a.events),i.fire("actions/drop:move",{interaction:r,dragEvent:n}),a.events={}}},"interactions:action-end":function(e,i){if("drag"===e.interaction.prepared.name){var r=e.interaction,n=e.iEvent;eD(e,i),eL(r,r.dropState.events),i.fire("actions/drop:end",{interaction:r,dragEvent:n})}},"interactions:stop":function(e){var i=e.interaction;if("drag"===i.prepared.name){var r=i.dropState;r&&(r.activeDrops=null,r.events=null,r.cur.dropzone=null,r.cur.element=null,r.prev.dropzone=null,r.prev.element=null,r.rejected=!1)}}},getActiveDrops:eC,getDrop:eP,getDropEvents:eI,fireDropEvents:eL,filterEventType:function(e){return 0===e.search("drag")||0===e.search("drop")},defaults:{enabled:!1,accept:null,overlap:"pointer"}};function eN(e){var i=e.interaction,r=e.iEvent,n=e.phase;if("gesture"===i.prepared.name){var a=i.pointers.map(function(e){return e.pointer}),s=i.interactable.options.deltaSource;if(r.touches=[a[0],a[1]],"start"===n)r.distance=e_(a,s),r.box=ev(a),r.scale=1,r.ds=0,r.angle=ex(a,s),r.da=0,i.gesture.startDistance=r.distance,i.gesture.startAngle=r.angle;else if("end"===n||i.pointers.length<2){var o=i.prevEvent;r.distance=o.distance,r.box=o.box,r.scale=o.scale,r.ds=0,r.angle=o.angle,r.da=0}else r.distance=e_(a,s),r.box=ev(a),r.scale=r.distance/i.gesture.startDistance,r.angle=ex(a,s),r.ds=r.scale-i.gesture.scale,r.da=r.angle-i.gesture.angle;i.gesture.distance=r.distance,i.gesture.angle=r.angle,A(r.scale)&&r.scale!==1/0&&!isNaN(r.scale)&&(i.gesture.scale=r.scale)}}var eO={id:"actions/gesture",before:["actions/drag","actions/resize"],install:function(e){var i=e.actions,r=e.Interactable,n=e.defaults;r.prototype.gesturable=function(e){return b(e)?(this.options.gesture.enabled=!1!==e.enabled,this.setPerAction("gesture",e),this.setOnEvents("gesture",e),this):R(e)?(this.options.gesture.enabled=e,this):this.options.gesture},i.map.gesture=eO,i.methodDict.gesture="gesturable",n.actions.gesture=eO.defaults},listeners:{"interactions:action-start":eN,"interactions:action-move":eN,"interactions:action-end":eN,"interactions:new":function(e){e.interaction.gesture={angle:0,distance:0,scale:1,startAngle:0,startDistance:0}},"auto-start:check":function(e){if(!(e.interaction.pointers.length<2)){var i=e.interactable.options.gesture;if(i&&i.enabled)return e.action={name:"gesture"},!1}}},defaults:{},getCursor:function(){return""},filterEventType:function(e){return 0===e.search("gesture")}};function eF(e){var i=e.iEvent,r=e.interaction;"resize"===r.prepared.name&&r.resizeAxes&&(r.interactable.options.resize.square?("y"===r.resizeAxes?i.delta.x=i.delta.y:i.delta.y=i.delta.x,i.axes="xy"):(i.axes=r.resizeAxes,"x"===r.resizeAxes?i.delta.y=0:"y"===r.resizeAxes&&(i.delta.x=0)))}var eB,ez,ek={id:"actions/resize",before:["actions/drag"],install:function(e){var i=e.actions,r=e.browser,n=e.Interactable,a=e.defaults;ek.cursors=r.isIe9?{x:"e-resize",y:"s-resize",xy:"se-resize",top:"n-resize",left:"w-resize",bottom:"s-resize",right:"e-resize",topleft:"se-resize",bottomright:"se-resize",topright:"ne-resize",bottomleft:"ne-resize"}:{x:"ew-resize",y:"ns-resize",xy:"nwse-resize",top:"ns-resize",left:"ew-resize",bottom:"ns-resize",right:"ew-resize",topleft:"nwse-resize",bottomright:"nwse-resize",topright:"nesw-resize",bottomleft:"nesw-resize"},ek.defaultMargin=r.supportsTouch||r.supportsPointerEvent?20:10,n.prototype.resizable=function(i){return b(i)?(this.options.resize.enabled=!1!==i.enabled,this.setPerAction("resize",i),this.setOnEvents("resize",i),C(i.axis)&&/^x$|^y$|^xy$/.test(i.axis)?this.options.resize.axis=i.axis:null===i.axis&&(this.options.resize.axis=e.defaults.actions.resize.axis),R(i.preserveAspectRatio)?this.options.resize.preserveAspectRatio=i.preserveAspectRatio:R(i.square)&&(this.options.resize.square=i.square),this):R(i)?(this.options.resize.enabled=i,this):this.options.resize},i.map.resize=ek,i.methodDict.resize="resizable",a.actions.resize=ek.defaults},listeners:{"interactions:new":function(e){e.interaction.resizeAxes="xy"},"interactions:action-start":function(e){!function(e){var i=e.iEvent,r=e.interaction;if("resize"===r.prepared.name&&r.prepared.edges){var n=r.rect;r._rects={start:Z({},n),corrected:Z({},n),previous:Z({},n),delta:{left:0,right:0,width:0,top:0,bottom:0,height:0}},i.edges=r.prepared.edges,i.rect=r._rects.corrected,i.deltaRect=r._rects.delta}}(e),eF(e)},"interactions:action-move":function(e){!function(e){var i=e.iEvent,r=e.interaction;if("resize"===r.prepared.name&&r.prepared.edges){var n=r.interactable.options.resize.invert,a=r.rect,s=r._rects,o=s.start,l=s.corrected,c=s.delta,h=s.previous;if(Z(h,l),"reposition"===n||"negate"===n){if(Z(l,a),"reposition"===n){if(l.top>l.bottom){var u=l.top;l.top=l.bottom,l.bottom=u}if(l.left>l.right){var d=l.left;l.left=l.right,l.right=d}}}else l.top=Math.min(a.top,o.bottom),l.bottom=Math.max(a.bottom,o.top),l.left=Math.min(a.left,o.right),l.right=Math.max(a.right,o.left);for(var p in l.width=l.right-l.left,l.height=l.bottom-l.top,l)c[p]=l[p]-h[p];i.edges=r.prepared.edges,i.rect=l,i.deltaRect=c}}(e),eF(e)},"interactions:action-end":function(e){var i=e.iEvent,r=e.interaction;"resize"===r.prepared.name&&r.prepared.edges&&(i.edges=r.prepared.edges,i.rect=r._rects.corrected,i.deltaRect=r._rects.delta)},"auto-start:check":function(e){var i=e.interaction,r=e.interactable,n=e.element,a=e.rect,s=e.buttons;if(a){var o=Z({},i.coords.cur.page),l=r.options.resize;if(l&&l.enabled&&(!i.pointerIsDown||!/mouse|pointer/.test(i.pointerType)||0!=(s&l.mouseButtons))){if(b(l.edges)){var c={left:!1,right:!1,top:!1,bottom:!1};for(var h in c)c[h]=function(e,i,r,n,a,s,o){if(!i)return!1;if(!0===i){var l=A(s.width)?s.width:s.right-s.left,c=A(s.height)?s.height:s.bottom-s.top;if(o=Math.min(o,Math.abs(("left"===e||"right"===e?l:c)/2)),l<0&&("left"===e?e="right":"right"===e&&(e="left")),c<0&&("top"===e?e="bottom":"bottom"===e&&(e="top")),"left"===e){var h=l>=0?s.left:s.right;return r.x<h+o}if("top"===e){var u=c>=0?s.top:s.bottom;return r.y<u+o}if("right"===e)return r.x>(l>=0?s.right:s.left)-o;if("bottom"===e)return r.y>(c>=0?s.bottom:s.top)-o}return!!P(n)&&(P(i)?i===n:X(n,i,a))}(h,l.edges[h],o,i._latestPointer.eventTarget,n,a,l.margin||ek.defaultMargin);c.left=c.left&&!c.right,c.top=c.top&&!c.bottom,(c.left||c.right||c.top||c.bottom)&&(e.action={name:"resize",edges:c})}else{var u="y"!==l.axis&&o.x>a.right-ek.defaultMargin,d="x"!==l.axis&&o.y>a.bottom-ek.defaultMargin;(u||d)&&(e.action={name:"resize",axes:(u?"x":"")+(d?"y":"")})}return!e.action&&void 0}}}},defaults:{square:!1,preserveAspectRatio:!1,axis:"xy",margin:NaN,edges:null,invert:"none"},cursors:null,getCursor:function(e){var i=e.edges,r=e.axis,n=e.name,a=ek.cursors,s=null;if(r)s=a[n+r];else if(i){for(var o="",l=0,c=["top","bottom","left","right"];l<c.length;l++){var h=c[l];i[h]&&(o+=h)}s=a[o]}return s},filterEventType:function(e){return 0===e.search("resize")},defaultMargin:null},eV=0,eH=function(e){return eB(e)},eG=function(e){return ez(e)},eW=function(e){if(eB=e.requestAnimationFrame,ez=e.cancelAnimationFrame,!eB)for(var i=["ms","moz","webkit","o"],r=0;r<i.length;r++){var n=i[r];eB=e["".concat(n,"RequestAnimationFrame")],ez=e["".concat(n,"CancelAnimationFrame")]||e["".concat(n,"CancelRequestAnimationFrame")]}eB=eB&&eB.bind(e),ez=ez&&ez.bind(e),eB||(eB=function(i){var r=Date.now(),n=Math.max(0,16-(r-eV)),a=e.setTimeout(function(){i(r+n)},n);return eV=r+n,a},ez=function(e){return clearTimeout(e)})},eX={defaults:{enabled:!1,margin:60,container:null,speed:300},now:Date.now,interaction:null,i:0,x:0,y:0,isScrolling:!1,prevTime:0,margin:0,speed:0,start:function(e){eX.isScrolling=!0,eG(eX.i),e.autoScroll=eX,eX.interaction=e,eX.prevTime=eX.now(),eX.i=eH(eX.scroll)},stop:function(){eX.isScrolling=!1,eX.interaction&&(eX.interaction.autoScroll=null),eG(eX.i)},scroll:function(){var e=eX.interaction,i=e.interactable,r=e.element,n=e.prepared.name,a=i.options[n].autoScroll,s=ej(a.container,i,r),o=eX.now(),l=(o-eX.prevTime)/1e3,c=a.speed*l;if(c>=1){var h={x:eX.x*c,y:eX.y*c};if(h.x||h.y){var u=eq(s);E(s)?s.scrollBy(h.x,h.y):s&&(s.scrollLeft+=h.x,s.scrollTop+=h.y);var d=eq(s),p={x:d.x-u.x,y:d.y-u.y};(p.x||p.y)&&i.fire({type:"autoscroll",target:r,interactable:i,delta:p,interaction:e,container:s})}eX.prevTime=o}eX.isScrolling&&(eG(eX.i),eX.i=eH(eX.scroll))},check:function(e,i){var r;return null==(r=e.options[i].autoScroll)?void 0:r.enabled},onInteractionMove:function(e){var i=e.interaction,r=e.pointer;if(i.interacting()&&eX.check(i.interactable,i.prepared.name))if(i.simulation)eX.x=eX.y=0;else{var n,a,s,o,l=i.interactable,c=i.element,h=i.prepared.name,u=l.options[h].autoScroll,d=ej(u.container,l,c);if(E(d))o=r.clientX<eX.margin,n=r.clientY<eX.margin,a=r.clientX>d.innerWidth-eX.margin,s=r.clientY>d.innerHeight-eX.margin;else{var p=q(d);o=r.clientX<p.left+eX.margin,n=r.clientY<p.top+eX.margin,a=r.clientX>p.right-eX.margin,s=r.clientY>p.bottom-eX.margin}eX.x=a?1:o?-1:0,eX.y=s?1:n?-1:0,eX.isScrolling||(eX.margin=u.margin,eX.speed=u.speed,eX.start(i))}}};function ej(e,i,r){return(C(e)?Q(e,i,r):e)||S(r)}function eq(e){return E(e)&&(e=window.document.body),{x:e.scrollLeft,y:e.scrollTop}}var eY={id:"auto-scroll",install:function(e){var i=e.defaults,r=e.actions;e.autoScroll=eX,eX.now=function(){return e.now()},r.phaselessTypes.autoscroll=!0,i.perAction.autoScroll=eX.defaults},listeners:{"interactions:new":function(e){e.interaction.autoScroll=null},"interactions:destroy":function(e){e.interaction.autoScroll=null,eX.stop(),eX.interaction&&(eX.interaction=null)},"interactions:stop":eX.stop,"interactions:action-move":function(e){return eX.onInteractionMove(e)}}};function eK(e,i){var r=!1;return function(){return r||(y.console.warn(i),r=!0),e.apply(this,arguments)}}function eJ(e,i){return e.name=i.name,e.axis=i.axis,e.edges=i.edges,e}function eZ(e){return R(e)?(this.options.styleCursor=e,this):null===e?(delete this.options.styleCursor,this):this.options.styleCursor}function eQ(e){return T(e)?(this.options.actionChecker=e,this):null===e?(delete this.options.actionChecker,this):this.options.actionChecker}var e$={id:"auto-start/interactableMethods",install:function(e){var i=e.Interactable;i.prototype.getAction=function(i,r,n,a){var s,o,l=(s=this.getRect(a),o={action:null,interactable:this,interaction:n,element:a,rect:s,buttons:r.buttons||({0:1,1:4,3:8,4:16})[r.button]},e.fire("auto-start:check",o),o.action);return this.options.actionChecker?this.options.actionChecker(i,r,l,this,a,n):l},i.prototype.ignoreFrom=eK(function(e){return this._backCompatOption("ignoreFrom",e)},"Interactable.ignoreFrom() has been deprecated. Use Interactble.draggable({ignoreFrom: newValue})."),i.prototype.allowFrom=eK(function(e){return this._backCompatOption("allowFrom",e)},"Interactable.allowFrom() has been deprecated. Use Interactble.draggable({allowFrom: newValue})."),i.prototype.actionChecker=eQ,i.prototype.styleCursor=eZ}};function e0(e,i,r,n,a){return i.testIgnoreAllow(i.options[e.name],r,n)&&i.options[e.name].enabled&&e2(i,r,e,a)?e:null}function e1(e,i,r,n,a){var s=[],o=[],l=n;function c(e){s.push(e),o.push(l)}for(;P(l);){s=[],o=[],a.interactables.forEachMatch(l,c);var h=function(e,i,r,n,a,s,o){for(var l=0,c=n.length;l<c;l++){var h=n[l],u=a[l],d=h.getAction(i,r,e,u);if(d){var p=e0(d,h,u,s,o);if(p)return{action:p,interactable:h,element:u}}}return{action:null,interactable:null,element:null}}(e,i,r,s,o,n,a);if(h.action&&!h.interactable.options[h.action.name].manualStart)return h;l=V(l)}return{action:null,interactable:null,element:null}}function e3(e,i,r){var n=i.action,a=i.interactable,s=i.element;n=n||{name:null},e.interactable=a,e.element=s,eJ(e.prepared,n),e.rect=a&&n.name?a.getRect(s):null,e6(e,r),r.fire("autoStart:prepared",{interaction:e})}function e2(e,i,r,n){var a=e.options,s=a[r.name].max,o=a[r.name].maxPerElement,l=n.autoStart.maxInteractions,c=0,h=0,u=0;if(!(s&&o&&l))return!1;for(var d=0,p=n.interactions.list;d<p.length;d++){var f=p[d],m=f.prepared.name;if(f.interacting()&&(++c>=l||f.interactable===e&&((h+=+(m===r.name))>=s||f.element===i&&(u++,m===r.name&&u>=o))))return!1}return l>0}function e4(e,i){return A(e)?(i.autoStart.maxInteractions=e,this):i.autoStart.maxInteractions}function e5(e,i,r){var n=r.autoStart.cursorElement;n&&n!==e&&(n.style.cursor=""),e.ownerDocument.documentElement.style.cursor=i,e.style.cursor=i,r.autoStart.cursorElement=i?e:null}function e6(e,i){var r=e.interactable,n=e.element,a=e.prepared;if("mouse"===e.pointerType&&r&&r.options.styleCursor){var s="";if(a.name){var o=r.options[a.name].cursorChecker;s=T(o)?o(a,r,n,e._interacting):i.actions.map[a.name].getCursor(a)}e5(e.element,s||"",i)}else i.autoStart.cursorElement&&e5(i.autoStart.cursorElement,"",i)}var e8={id:"auto-start/base",before:["actions"],install:function(e){var i=e.interactStatic,r=e.defaults;e.usePlugin(e$),r.base.actionChecker=null,r.base.styleCursor=!0,Z(r.perAction,{manualStart:!1,max:1/0,maxPerElement:1,allowFrom:null,ignoreFrom:null,mouseButtons:1}),i.maxInteractions=function(i){return e4(i,e)},e.autoStart={maxInteractions:1/0,withinInteractionLimit:e2,cursorElement:null}},listeners:{"interactions:down":function(e,i){var r=e.interaction,n=e.pointer,a=e.event,s=e.eventTarget;r.interacting()||e3(r,e1(r,n,a,s,i),i)},"interactions:move":function(e,i){var r,n,a,s;r=e.interaction,n=e.pointer,a=e.event,s=e.eventTarget,"mouse"!==r.pointerType||r.pointerIsDown||r.interacting()||e3(r,e1(r,n,a,s,i),i),function(e,i){var r=e.interaction;if(r.pointerIsDown&&!r.interacting()&&r.pointerWasMoved&&r.prepared.name){i.fire("autoStart:before-start",e);var n=r.interactable,a=r.prepared.name;a&&n&&(n.options[a].manualStart||!e2(n,r.element,r.prepared,i)?r.stop():(r.start(r.prepared,n,r.element),e6(r,i)))}}(e,i)},"interactions:stop":function(e,i){var r=e.interaction,n=r.interactable;n&&n.options.styleCursor&&e5(r.element,"",i)}},maxInteractions:e4,withinInteractionLimit:e2,validateAction:e0},e9={id:"auto-start/dragAxis",listeners:{"autoStart:before-start":function(e,i){var r=e.interaction,n=e.eventTarget,a=e.dx,s=e.dy;if("drag"===r.prepared.name){var o=Math.abs(a),l=Math.abs(s),c=r.interactable.options.drag,h=c.startAxis,u=o>l?"x":o<l?"y":"xy";if(r.prepared.axis="start"===c.lockAxis?u[0]:c.lockAxis,"xy"!==u&&"xy"!==h&&h!==u){r.prepared.name=null;for(var d=n,p=function(e){if(e!==r.interactable){var a=r.interactable.options.drag;if(!a.manualStart&&e.testIgnoreAllow(a,d,n)){var s=e.getAction(r.downPointer,r.downEvent,r,d);if(s&&"drag"===s.name&&function(e,i){if(!i)return!1;var r=i.options.drag.startAxis;return"xy"===e||"xy"===r||r===e}(u,e)&&e8.validateAction(s,e,d,n,i))return e}}};P(d);){var f=i.interactables.forEachMatch(d,p);if(f){r.prepared.name="drag",r.interactable=f,r.element=d;break}d=V(d)}}}}}};function e7(e){var i=e.prepared&&e.prepared.name;if(!i)return null;var r=e.interactable.options;return r[i].hold||r[i].delay}var te={id:"auto-start/hold",install:function(e){var i=e.defaults;e.usePlugin(e8),i.perAction.hold=0,i.perAction.delay=0},listeners:{"interactions:new":function(e){e.interaction.autoStartHoldTimer=null},"autoStart:prepared":function(e){var i=e.interaction,r=e7(i);r>0&&(i.autoStartHoldTimer=setTimeout(function(){i.start(i.prepared,i.interactable,i.element)},r))},"interactions:move":function(e){var i=e.interaction,r=e.duplicate;i.autoStartHoldTimer&&i.pointerWasMoved&&!r&&(clearTimeout(i.autoStartHoldTimer),i.autoStartHoldTimer=null)},"autoStart:before-start":function(e){var i=e.interaction;e7(i)>0&&(i.prepared.name=null)}},getHoldDuration:e7},tt=function(e){return/^(always|never|auto)$/.test(e)?(this.options.preventDefault=e,this):R(e)?(this.options.preventDefault=e?"always":"never",this):this.options.preventDefault};function ti(e){var i=e.interaction,r=e.event;i.interactable&&i.interactable.checkAndPreventDefault(r)}var tr={id:"core/interactablePreventDefault",install:function(e){var i=e.Interactable;i.prototype.preventDefault=tt,i.prototype.checkAndPreventDefault=function(i){return function(e,i,r){var n=e.options.preventDefault;if("never"!==n)if("always"!==n){if(i.events.supportsPassive&&/^touch(start|move)$/.test(r.type)){var a=S(r.target).document,s=i.getDocOptions(a);if(!s||!s.events||!1!==s.events.passive)return}/^(mouse|pointer|touch)*(down|start)/i.test(r.type)||P(r.target)&&H(r.target,"input,select,textarea,[contenteditable=true],[contenteditable=true] *")||r.preventDefault()}else r.preventDefault()}(this,e,i)},e.interactions.docEvents.push({type:"dragstart",listener:function(i){for(var r=0,n=e.interactions.list;r<n.length;r++){var a=n[r];if(a.element&&(a.element===i.target||z(a.element,i.target)))return void a.interactable.checkAndPreventDefault(i)}}})},listeners:["down","move","up","cancel"].reduce(function(e,i){return e["interactions:".concat(i)]=ti,e},{})};function tn(e,i){if(i.phaselessTypes[e])return!0;for(var r in i.map)if(0===e.indexOf(r)&&e.substr(r.length)in i.phases)return!0;return!1}function ta(e){var i={};for(var r in e){var n=e[r];I(n)?i[r]=ta(n):L(n)?i[r]=eT(n):i[r]=n}return i}var ts=function(){function e(i){a(this,e),this.states=[],this.startOffset={left:0,right:0,top:0,bottom:0},this.startDelta=void 0,this.result=void 0,this.endResult=void 0,this.startEdges=void 0,this.edges=void 0,this.interaction=void 0,this.interaction=i,this.result=to(),this.edges={left:!1,right:!1,top:!1,bottom:!1}}return o(e,[{key:"start",value:function(e,i){var r,n,a,s=e.phase,o=this.interaction,l=(n=(r=o.interactable.options[o.prepared.name]).modifiers)&&n.length?n:["snap","snapSize","snapEdges","restrict","restrictEdges","restrictSize"].map(function(e){var i=r[e];return i&&i.enabled&&{options:i,methods:i._methods}}).filter(function(e){return!!e});this.prepareStates(l),this.startEdges=Z({},o.edges),this.edges=Z({},this.startEdges),this.startOffset=(a=o.rect)?{left:i.x-a.left,top:i.y-a.top,right:a.right-i.x,bottom:a.bottom-i.y}:{left:0,top:0,right:0,bottom:0},this.startDelta={x:0,y:0};var c=this.fillArg({phase:s,pageCoords:i,preEnd:!1});return this.result=to(),this.startAll(c),this.result=this.setAll(c)}},{key:"fillArg",value:function(e){var i=this.interaction;return e.interaction=i,e.interactable=i.interactable,e.element=i.element,e.rect||(e.rect=i.rect),e.edges||(e.edges=this.startEdges),e.startOffset=this.startOffset,e}},{key:"startAll",value:function(e){for(var i=0,r=this.states;i<r.length;i++){var n=r[i];n.methods.start&&(e.state=n,n.methods.start(e))}}},{key:"setAll",value:function(e){var i=e.phase,r=e.preEnd,n=e.skipModifiers,a=e.rect,s=e.edges;e.coords=Z({},e.pageCoords),e.rect=Z({},a),e.edges=Z({},s);for(var o=n?this.states.slice(n):this.states,l=to(e.coords,e.rect),c=0;c<o.length;c++){var h,u=o[c],d=u.options,p=Z({},e.coords),f=null;null!=(h=u.methods)&&h.set&&this.shouldDo(d,r,i)&&(e.state=u,f=u.methods.set(e),ei(e.edges,e.rect,{x:e.coords.x-p.x,y:e.coords.y-p.y})),l.eventProps.push(f)}Z(this.edges,e.edges),l.delta.x=e.coords.x-e.pageCoords.x,l.delta.y=e.coords.y-e.pageCoords.y,l.rectDelta.left=e.rect.left-a.left,l.rectDelta.right=e.rect.right-a.right,l.rectDelta.top=e.rect.top-a.top,l.rectDelta.bottom=e.rect.bottom-a.bottom;var m=this.result.coords,g=this.result.rect;if(m&&g){var v=l.rect.left!==g.left||l.rect.right!==g.right||l.rect.top!==g.top||l.rect.bottom!==g.bottom;l.changed=v||m.x!==l.coords.x||m.y!==l.coords.y}return l}},{key:"applyToInteraction",value:function(e){var i=this.interaction,r=e.phase,n=i.coords.cur,a=i.coords.start,s=this.result,o=this.startDelta,l=s.delta;"start"===r&&Z(this.startDelta,s.delta);for(var c=0,h=[[a,o],[n,l]];c<h.length;c++){var u=h[c],d=u[0],p=u[1];d.page.x+=p.x,d.page.y+=p.y,d.client.x+=p.x,d.client.y+=p.y}var f=this.result.rectDelta,m=e.rect||i.rect;m.left+=f.left,m.right+=f.right,m.top+=f.top,m.bottom+=f.bottom,m.width=m.right-m.left,m.height=m.bottom-m.top}},{key:"setAndApply",value:function(e){var i=this.interaction,r=e.phase,n=e.preEnd,a=e.skipModifiers,s=this.setAll(this.fillArg({preEnd:n,phase:r,pageCoords:e.modifiedCoords||i.coords.cur.page}));if(this.result=s,!s.changed&&(!a||a<this.states.length)&&i.interacting())return!1;if(e.modifiedCoords){var o=i.coords.cur.page,l={x:e.modifiedCoords.x-o.x,y:e.modifiedCoords.y-o.y};s.coords.x+=l.x,s.coords.y+=l.y,s.delta.x+=l.x,s.delta.y+=l.y}this.applyToInteraction(e)}},{key:"beforeEnd",value:function(e){var i=e.interaction,r=e.event,n=this.states;if(n&&n.length){for(var a=!1,s=0;s<n.length;s++){var o=n[s];e.state=o;var l=o.options,c=o.methods,h=c.beforeEnd&&c.beforeEnd(e);if(h)return this.endResult=h,!1;a=a||!a&&this.shouldDo(l,!0,e.phase,!0)}a&&i.move({event:r,preEnd:!0})}}},{key:"stop",value:function(e){var i=e.interaction;if(this.states&&this.states.length){var r=Z({states:this.states,interactable:i.interactable,element:i.element,rect:null},e);this.fillArg(r);for(var n=0,a=this.states;n<a.length;n++){var s=a[n];r.state=s,s.methods.stop&&s.methods.stop(r)}this.states=null,this.endResult=null}}},{key:"prepareStates",value:function(e){this.states=[];for(var i=0;i<e.length;i++){var r=e[i],n=r.options,a=r.methods,s=r.name;this.states.push({options:n,methods:a,index:i,name:s})}return this.states}},{key:"restoreInteractionCoords",value:function(e){var i=e.interaction,r=i.coords,n=i.rect,a=i.modification;if(a.result){for(var s=a.startDelta,o=a.result,l=o.delta,c=o.rectDelta,h=0,u=[[r.start,s],[r.cur,l]];h<u.length;h++){var d=u[h],p=d[0],f=d[1];p.page.x-=f.x,p.page.y-=f.y,p.client.x-=f.x,p.client.y-=f.y}n.left-=c.left,n.right-=c.right,n.top-=c.top,n.bottom-=c.bottom}}},{key:"shouldDo",value:function(e,i,r,n){return!(!e||!1===e.enabled||n&&!e.endOnly||e.endOnly&&!i||"start"===r&&!e.setStart)}},{key:"copyFrom",value:function(e){this.startOffset=e.startOffset,this.startDelta=e.startDelta,this.startEdges=e.startEdges,this.edges=e.edges,this.states=e.states.map(function(e){return ta(e)}),this.result=to(Z({},e.result.coords),Z({},e.result.rect))}},{key:"destroy",value:function(){for(var e in this)this[e]=null}}]),e}();function to(e,i){return{rect:i,coords:e,delta:{x:0,y:0},rectDelta:{left:0,right:0,top:0,bottom:0},eventProps:[],changed:!0}}function tl(e,i){var r=e.defaults,n={start:e.start,set:e.set,beforeEnd:e.beforeEnd,stop:e.stop},a=function(e){var a=e||{};for(var s in a.enabled=!1!==a.enabled,r)s in a||(a[s]=r[s]);var o={options:a,methods:n,name:i,enable:function(){return a.enabled=!0,o},disable:function(){return a.enabled=!1,o}};return o};return i&&"string"==typeof i&&(a._defaults=r,a._methods=n),a}function tc(e){var i=e.iEvent,r=e.interaction.modification.result;r&&(i.modifiers=r.eventProps)}var th={id:"modifiers/base",before:["actions"],install:function(e){e.defaults.perAction.modifiers=[]},listeners:{"interactions:new":function(e){var i=e.interaction;i.modification=new ts(i)},"interactions:before-action-start":function(e){var i=e.interaction,r=e.interaction.modification;r.start(e,i.coords.start.page),i.edges=r.edges,r.applyToInteraction(e)},"interactions:before-action-move":function(e){var i=e.interaction,r=i.modification,n=r.setAndApply(e);return i.edges=r.edges,n},"interactions:before-action-end":function(e){var i=e.interaction,r=i.modification,n=r.beforeEnd(e);return i.edges=r.startEdges,n},"interactions:action-start":tc,"interactions:action-move":tc,"interactions:action-end":tc,"interactions:after-action-start":function(e){return e.interaction.modification.restoreInteractionCoords(e)},"interactions:after-action-move":function(e){return e.interaction.modification.restoreInteractionCoords(e)},"interactions:stop":function(e){return e.interaction.modification.stop(e)}}},tu={base:{preventDefault:"auto",deltaSource:"page"},perAction:{enabled:!1,origin:{x:0,y:0}},actions:{}},td=function(e){l(r,e);var i=d(r);function r(e,n,s,o,l,c,h){a(this,r),(d=i.call(this,e)).relatedTarget=null,d.screenX=void 0,d.screenY=void 0,d.button=void 0,d.buttons=void 0,d.ctrlKey=void 0,d.shiftKey=void 0,d.altKey=void 0,d.metaKey=void 0,d.page=void 0,d.client=void 0,d.delta=void 0,d.rect=void 0,d.x0=void 0,d.y0=void 0,d.t0=void 0,d.dt=void 0,d.duration=void 0,d.clientX0=void 0,d.clientY0=void 0,d.velocity=void 0,d.speed=void 0,d.swipe=void 0,d.axes=void 0,d.preEnd=void 0,l=l||e.element;var d,p=e.interactable,f=(p&&p.options||tu).deltaSource,m=er(p,l,s),g="start"===o,v="end"===o,_=g?u(d):e.prevEvent,x=g?e.coords.start:v?{page:_.page,client:_.client,timeStamp:e.coords.cur.timeStamp}:e.coords.cur;return d.page=Z({},x.page),d.client=Z({},x.client),d.rect=Z({},e.rect),d.timeStamp=x.timeStamp,v||(d.page.x-=m.x,d.page.y-=m.y,d.client.x-=m.x,d.client.y-=m.y),d.ctrlKey=n.ctrlKey,d.altKey=n.altKey,d.shiftKey=n.shiftKey,d.metaKey=n.metaKey,d.button=n.button,d.buttons=n.buttons,d.target=l,d.currentTarget=l,d.preEnd=c,d.type=h||s+(o||""),d.interactable=p,d.t0=g?e.pointers[e.pointers.length-1].downTime:_.t0,d.x0=e.coords.start.page.x-m.x,d.y0=e.coords.start.page.y-m.y,d.clientX0=e.coords.start.client.x-m.x,d.clientY0=e.coords.start.client.y-m.y,d.delta=g||v?{x:0,y:0}:{x:d[f].x-_[f].x,y:d[f].y-_[f].y},d.dt=e.coords.delta.timeStamp,d.duration=d.timeStamp-d.t0,d.velocity=Z({},e.coords.velocity[f]),d.speed=es(d.velocity.x,d.velocity.y),d.swipe=v||"inertiastart"===o?d.getSwipe():null,d}return o(r,[{key:"getSwipe",value:function(){var e=this._interaction;if(e.prevEvent.speed<600||this.timeStamp-e.prevEvent.timeStamp>150)return null;var i=180*Math.atan2(e.prevEvent.velocityY,e.prevEvent.velocityX)/Math.PI;i<0&&(i+=360);var r=112.5<=i&&i<247.5,n=202.5<=i&&i<337.5;return{up:n,down:!n&&22.5<=i&&i<157.5,left:r,right:!r&&(292.5<=i||i<67.5),angle:i,speed:e.prevEvent.speed,velocity:{x:e.prevEvent.velocityX,y:e.prevEvent.velocityY}}}},{key:"preventDefault",value:function(){}},{key:"stopImmediatePropagation",value:function(){this.immediatePropagationStopped=this.propagationStopped=!0}},{key:"stopPropagation",value:function(){this.propagationStopped=!0}}]),r}(eS);Object.defineProperties(td.prototype,{pageX:{get:function(){return this.page.x},set:function(e){this.page.x=e}},pageY:{get:function(){return this.page.y},set:function(e){this.page.y=e}},clientX:{get:function(){return this.client.x},set:function(e){this.client.x=e}},clientY:{get:function(){return this.client.y},set:function(e){this.client.y=e}},dx:{get:function(){return this.delta.x},set:function(e){this.delta.x=e}},dy:{get:function(){return this.delta.y},set:function(e){this.delta.y=e}},velocityX:{get:function(){return this.velocity.x},set:function(e){this.velocity.x=e}},velocityY:{get:function(){return this.velocity.y},set:function(e){this.velocity.y=e}}});var tp=o(function e(i,r,n,s,o){a(this,e),this.id=void 0,this.pointer=void 0,this.event=void 0,this.downTime=void 0,this.downTarget=void 0,this.id=i,this.pointer=r,this.event=n,this.downTime=s,this.downTarget=o}),tf=((m={}).interactable="",m.element="",m.prepared="",m.pointerIsDown="",m.pointerWasMoved="",m._proxy="",m),tm=((g={}).start="",g.move="",g.end="",g.stop="",g.interacting="",g),tg=0,tv=function(){function e(i){var r=this,n=i.pointerType,s=i.scopeFire;a(this,e),this.interactable=null,this.element=null,this.rect=null,this._rects=void 0,this.edges=null,this._scopeFire=void 0,this.prepared={name:null,axis:null,edges:null},this.pointerType=void 0,this.pointers=[],this.downEvent=null,this.downPointer={},this._latestPointer={pointer:null,event:null,eventTarget:null},this.prevEvent=null,this.pointerIsDown=!1,this.pointerWasMoved=!1,this._interacting=!1,this._ending=!1,this._stopped=!0,this._proxy=void 0,this.simulation=null,this.doMove=eK(function(e){this.move(e)},"The interaction.doMove() method has been renamed to interaction.move()"),this.coords={start:{page:{x:0,y:0},client:{x:0,y:0},timeStamp:0},prev:{page:{x:0,y:0},client:{x:0,y:0},timeStamp:0},cur:{page:{x:0,y:0},client:{x:0,y:0},timeStamp:0},delta:{page:{x:0,y:0},client:{x:0,y:0},timeStamp:0},velocity:{page:{x:0,y:0},client:{x:0,y:0},timeStamp:0}},this._id=tg++,this._scopeFire=s,this.pointerType=n;var o=this;this._proxy={};var l=function(e){Object.defineProperty(r._proxy,e,{get:function(){return o[e]}})};for(var c in tf)l(c);var h=function(e){Object.defineProperty(r._proxy,e,{value:function(){return o[e].apply(o,arguments)}})};for(var u in tm)h(u);this._scopeFire("interactions:new",{interaction:this})}return o(e,[{key:"pointerMoveTolerance",get:function(){return 1}},{key:"pointerDown",value:function(e,i,r){var n=this.updatePointer(e,i,r,!0),a=this.pointers[n];this._scopeFire("interactions:down",{pointer:e,event:i,eventTarget:r,pointerIndex:n,pointerInfo:a,type:"down",interaction:this})}},{key:"start",value:function(e,i,r){return!(this.interacting()||!this.pointerIsDown||this.pointers.length<("gesture"===e.name?2:1)||!i.options[e.name].enabled)&&(eJ(this.prepared,e),this.interactable=i,this.element=r,this.rect=i.getRect(r),this.edges=this.prepared.edges?Z({},this.prepared.edges):{left:!0,right:!0,top:!0,bottom:!0},this._stopped=!1,this._interacting=this._doPhase({interaction:this,event:this.downEvent,phase:"start"})&&!this._stopped,this._interacting)}},{key:"pointerMove",value:function(e,i,r){this.simulation||this.modification&&this.modification.endResult||this.updatePointer(e,i,r,!1);var n,a,s=this.coords.cur.page.x===this.coords.prev.page.x&&this.coords.cur.page.y===this.coords.prev.page.y&&this.coords.cur.client.x===this.coords.prev.client.x&&this.coords.cur.client.y===this.coords.prev.client.y;this.pointerIsDown&&!this.pointerWasMoved&&(n=this.coords.cur.client.x-this.coords.start.client.x,a=this.coords.cur.client.y-this.coords.start.client.y,this.pointerWasMoved=es(n,a)>this.pointerMoveTolerance);var o,l,c,h=this.getPointerIndex(e),u={pointer:e,pointerIndex:h,pointerInfo:this.pointers[h],event:i,type:"move",eventTarget:r,dx:n,dy:a,duplicate:s,interaction:this};s||(o=this.coords.velocity,c=Math.max((l=this.coords.delta).timeStamp/1e3,.001),o.page.x=l.page.x/c,o.page.y=l.page.y/c,o.client.x=l.client.x/c,o.client.y=l.client.y/c,o.timeStamp=c),this._scopeFire("interactions:move",u),s||this.simulation||(this.interacting()&&(u.type=null,this.move(u)),this.pointerWasMoved&&ec(this.coords.prev,this.coords.cur))}},{key:"move",value:function(e){e&&e.event||eh(this.coords.delta),(e=Z({pointer:this._latestPointer.pointer,event:this._latestPointer.event,eventTarget:this._latestPointer.eventTarget,interaction:this},e||{})).phase="move",this._doPhase(e)}},{key:"pointerUp",value:function(e,i,r,n){var a=this.getPointerIndex(e);-1===a&&(a=this.updatePointer(e,i,r,!1));var s=/cancel$/i.test(i.type)?"cancel":"up";this._scopeFire("interactions:".concat(s),{pointer:e,pointerIndex:a,pointerInfo:this.pointers[a],event:i,eventTarget:r,type:s,curEventTarget:n,interaction:this}),this.simulation||this.end(i),this.removePointer(e,i)}},{key:"documentBlur",value:function(e){this.end(e),this._scopeFire("interactions:blur",{event:e,type:"blur",interaction:this})}},{key:"end",value:function(e){var i;this._ending=!0,e=e||this._latestPointer.event,this.interacting()&&(i=this._doPhase({event:e,interaction:this,phase:"end"})),this._ending=!1,!0===i&&this.stop()}},{key:"currentAction",value:function(){return this._interacting?this.prepared.name:null}},{key:"interacting",value:function(){return this._interacting}},{key:"stop",value:function(){this._scopeFire("interactions:stop",{interaction:this}),this.interactable=this.element=null,this._interacting=!1,this._stopped=!0,this.prepared.name=this.prevEvent=null}},{key:"getPointerIndex",value:function(e){var i=ef(e);return"mouse"===this.pointerType||"pen"===this.pointerType?this.pointers.length-1:eE(this.pointers,function(e){return e.id===i})}},{key:"getPointerInfo",value:function(e){return this.pointers[this.getPointerIndex(e)]}},{key:"updatePointer",value:function(e,i,r,n){var a,s,o,l,c,h,u,d,p=ef(e),f=this.getPointerIndex(e),m=this.pointers[f];return n=!1!==n&&(n||/(down|start)$/i.test(i.type)),m?m.pointer=e:(m=new tp(p,e,i,null,null),f=this.pointers.length,this.pointers.push(m)),a=this.coords.cur,s=this.pointers.map(function(e){return e.pointer}),o=this._now(),ep(l=s.length>1?eg(s):s[0],a.page),c=(c=a.client)||{},B.isOperaMobile&&eu(l)?ed("screen",l,c):ed("client",l,c),a.timeStamp=o,h=this.coords.delta,u=this.coords.prev,d=this.coords.cur,h.page.x=d.page.x-u.page.x,h.page.y=d.page.y-u.page.y,h.client.x=d.client.x-u.client.x,h.client.y=d.client.y-u.client.y,h.timeStamp=d.timeStamp-u.timeStamp,n&&(this.pointerIsDown=!0,m.downTime=this.coords.cur.timeStamp,m.downTarget=r,el(this.downPointer,e),this.interacting()||(ec(this.coords.start,this.coords.cur),ec(this.coords.prev,this.coords.cur),this.downEvent=i,this.pointerWasMoved=!1)),this._updateLatestPointer(e,i,r),this._scopeFire("interactions:update-pointer",{pointer:e,event:i,eventTarget:r,down:n,pointerInfo:m,pointerIndex:f,interaction:this}),f}},{key:"removePointer",value:function(e,i){var r=this.getPointerIndex(e);if(-1!==r){var n=this.pointers[r];this._scopeFire("interactions:remove-pointer",{pointer:e,event:i,eventTarget:null,pointerIndex:r,pointerInfo:n,interaction:this}),this.pointers.splice(r,1),this.pointerIsDown=!1}}},{key:"_updateLatestPointer",value:function(e,i,r){this._latestPointer.pointer=e,this._latestPointer.event=i,this._latestPointer.eventTarget=r}},{key:"destroy",value:function(){this._latestPointer.pointer=null,this._latestPointer.event=null,this._latestPointer.eventTarget=null}},{key:"_createPreparedEvent",value:function(e,i,r,n){return new td(this,e,this.prepared.name,i,this.element,r,n)}},{key:"_fireEvent",value:function(e){var i;null==(i=this.interactable)||i.fire(e),(!this.prevEvent||e.timeStamp>=this.prevEvent.timeStamp)&&(this.prevEvent=e)}},{key:"_doPhase",value:function(e){var i=e.event,r=e.phase,n=e.preEnd,a=e.type,s=this.rect;if(s&&"move"===r&&(ei(this.edges,s,this.coords.delta[this.interactable.options.deltaSource]),s.width=s.right-s.left,s.height=s.bottom-s.top),!1===this._scopeFire("interactions:before-action-".concat(r),e))return!1;var o=e.iEvent=this._createPreparedEvent(i,r,n,a);return this._scopeFire("interactions:action-".concat(r),e),"start"===r&&(this.prevEvent=o),this._fireEvent(o),this._scopeFire("interactions:after-action-".concat(r),e),!0}},{key:"_now",value:function(){return Date.now()}}]),e}();function t_(e){tx(e.interaction)}function tx(e){if(!e.offset.pending.x&&!e.offset.pending.y)return!1;var i=e.offset.pending;return tM(e.coords.cur,i),tM(e.coords.delta,i),ei(e.edges,e.rect,i),i.x=0,i.y=0,!0}function ty(e){var i=e.x,r=e.y;this.offset.pending.x+=i,this.offset.pending.y+=r,this.offset.total.x+=i,this.offset.total.y+=r}function tM(e,i){var r=e.page,n=e.client,a=i.x,s=i.y;r.x+=a,r.y+=s,n.x+=a,n.y+=s}tm.offsetBy="";var tS={id:"offset",before:["modifiers","pointer-events","actions","inertia"],install:function(e){e.Interaction.prototype.offsetBy=ty},listeners:{"interactions:new":function(e){e.interaction.offset={total:{x:0,y:0},pending:{x:0,y:0}}},"interactions:update-pointer":function(e){var i;(i=e.interaction).pointerIsDown&&(tM(i.coords.cur,i.offset.total),i.offset.pending.x=0,i.offset.pending.y=0)},"interactions:before-action-start":t_,"interactions:before-action-move":t_,"interactions:before-action-end":function(e){var i=e.interaction;if(tx(i))return i.move({offset:!0}),i.end(),!1},"interactions:stop":function(e){var i=e.interaction;i.offset.total.x=0,i.offset.total.y=0,i.offset.pending.x=0,i.offset.pending.y=0}}},tb=function(){function e(i){a(this,e),this.active=!1,this.isModified=!1,this.smoothEnd=!1,this.allowResume=!1,this.modification=void 0,this.modifierCount=0,this.modifierArg=void 0,this.startCoords=void 0,this.t0=0,this.v0=0,this.te=0,this.targetOffset=void 0,this.modifiedOffset=void 0,this.currentOffset=void 0,this.lambda_v0=0,this.one_ve_v0=0,this.timeout=void 0,this.interaction=void 0,this.interaction=i}return o(e,[{key:"start",value:function(e){var i=this.interaction,r=tT(i);if(!r||!r.enabled)return!1;var n=i.coords.velocity.client,a=es(n.x,n.y),s=this.modification||(this.modification=new ts(i));if(s.copyFrom(i.modification),this.t0=i._now(),this.allowResume=r.allowResume,this.v0=a,this.currentOffset={x:0,y:0},this.startCoords=i.coords.cur.page,this.modifierArg=s.fillArg({pageCoords:this.startCoords,preEnd:!0,phase:"inertiastart"}),this.t0-i.coords.cur.timeStamp<50&&a>r.minSpeed&&a>r.endSpeed)this.startInertia();else{if(s.result=s.setAll(this.modifierArg),!s.result.changed)return!1;this.startSmoothEnd()}return i.modification.result.rect=null,i.offsetBy(this.targetOffset),i._doPhase({interaction:i,event:e,phase:"inertiastart"}),i.offsetBy({x:-this.targetOffset.x,y:-this.targetOffset.y}),i.modification.result.rect=null,this.active=!0,i.simulation=this,!0}},{key:"startInertia",value:function(){var e=this,i=this.interaction.coords.velocity.client,r=tT(this.interaction),n=r.resistance,a=-Math.log(r.endSpeed/this.v0)/n;this.targetOffset={x:(i.x-a)/n,y:(i.y-a)/n},this.te=a,this.lambda_v0=n/this.v0,this.one_ve_v0=1-r.endSpeed/this.v0;var s=this.modification,o=this.modifierArg;o.pageCoords={x:this.startCoords.x+this.targetOffset.x,y:this.startCoords.y+this.targetOffset.y},s.result=s.setAll(o),s.result.changed&&(this.isModified=!0,this.modifiedOffset={x:this.targetOffset.x+s.result.delta.x,y:this.targetOffset.y+s.result.delta.y}),this.onNextFrame(function(){return e.inertiaTick()})}},{key:"startSmoothEnd",value:function(){var e=this;this.smoothEnd=!0,this.isModified=!0,this.targetOffset={x:this.modification.result.delta.x,y:this.modification.result.delta.y},this.onNextFrame(function(){return e.smoothEndTick()})}},{key:"onNextFrame",value:function(e){var i=this;this.timeout=eH(function(){i.active&&e()})}},{key:"inertiaTick",value:function(){var e,i,r,n,a=this,s=this.interaction,o=tT(s).resistance,l=(s._now()-this.t0)/1e3;if(l<this.te){var c,h=1-(Math.exp(-o*l)-this.lambda_v0)/this.one_ve_v0;this.isModified?(e=this.targetOffset.x,i=this.targetOffset.y,r=this.modifiedOffset.x,n=this.modifiedOffset.y,c={x:tE(h,0,e,r),y:tE(h,0,i,n)}):c={x:this.targetOffset.x*h,y:this.targetOffset.y*h};var u={x:c.x-this.currentOffset.x,y:c.y-this.currentOffset.y};this.currentOffset.x+=u.x,this.currentOffset.y+=u.y,s.offsetBy(u),s.move(),this.onNextFrame(function(){return a.inertiaTick()})}else s.offsetBy({x:this.modifiedOffset.x-this.currentOffset.x,y:this.modifiedOffset.y-this.currentOffset.y}),this.end()}},{key:"smoothEndTick",value:function(){var e=this,i=this.interaction,r=i._now()-this.t0,n=tT(i).smoothEndDuration;if(r<n){var a,s,o,l,c={x:(a=r,s=this.targetOffset.x,-s*(a/=n)*(a-2)+0),y:(o=r,l=this.targetOffset.y,-l*(o/=n)*(o-2)+0)},h={x:c.x-this.currentOffset.x,y:c.y-this.currentOffset.y};this.currentOffset.x+=h.x,this.currentOffset.y+=h.y,i.offsetBy(h),i.move({skipModifiers:this.modifierCount}),this.onNextFrame(function(){return e.smoothEndTick()})}else i.offsetBy({x:this.targetOffset.x-this.currentOffset.x,y:this.targetOffset.y-this.currentOffset.y}),this.end()}},{key:"resume",value:function(e){var i=e.pointer,r=e.event,n=e.eventTarget,a=this.interaction;a.offsetBy({x:-this.currentOffset.x,y:-this.currentOffset.y}),a.updatePointer(i,r,n,!0),a._doPhase({interaction:a,event:r,phase:"resume"}),ec(a.coords.prev,a.coords.cur),this.stop()}},{key:"end",value:function(){this.interaction.move(),this.interaction.end(),this.stop()}},{key:"stop",value:function(){this.active=this.smoothEnd=!1,this.interaction.simulation=null,eG(this.timeout)}}]),e}();function tT(e){var i=e.interactable,r=e.prepared;return i&&i.options&&r.name&&i.options[r.name].inertia}function tE(e,i,r,n){var a=1-e;return a*a*i+2*a*e*r+e*e*n}function tw(e,i){for(var r=0;r<i.length;r++){var n=i[r];if(e.immediatePropagationStopped)break;n(e)}}var tA=function(){function e(i){a(this,e),this.options=void 0,this.types={},this.propagationStopped=!1,this.immediatePropagationStopped=!1,this.global=void 0,this.options=Z({},i||{})}return o(e,[{key:"fire",value:function(e){var i,r=this.global;(i=this.types[e.type])&&tw(e,i),!e.propagationStopped&&r&&(i=r[e.type])&&tw(e,i)}},{key:"on",value:function(e,i){var r=en(e,i);for(e in r)this.types[e]=eb(this.types[e]||[],r[e])}},{key:"off",value:function(e,i){var r=en(e,i);for(e in r){var n=this.types[e];if(n&&n.length)for(var a=0,s=r[e];a<s.length;a++){var o=s[a],l=n.indexOf(o);-1!==l&&n.splice(l,1)}}}},{key:"getRect",value:function(e){return null}}]),e}(),tR=function(){function e(i){a(this,e),this.currentTarget=void 0,this.originalEvent=void 0,this.type=void 0,this.originalEvent=i,el(this,i)}return o(e,[{key:"preventOriginalDefault",value:function(){this.originalEvent.preventDefault()}},{key:"stopPropagation",value:function(){this.originalEvent.stopPropagation()}},{key:"stopImmediatePropagation",value:function(){this.originalEvent.stopImmediatePropagation()}}]),e}();function tC(e){return b(e)?{capture:!!e.capture,passive:!!e.passive}:{capture:!!e,passive:!1}}function tP(e,i){return e===i||("boolean"==typeof e?!!i.capture===e&&!1==!!i.passive:!!e.capture==!!i.capture&&!!e.passive==!!i.passive)}var tI={id:"events",install:function(e){var i,r=[],n={},a=[],s={add:o,remove:l,addDelegate:function(e,i,r,s,l){var u=tC(l);if(!n[r]){n[r]=[];for(var d=0;d<a.length;d++){var p=a[d];o(p,r,c),o(p,r,h,!0)}}var f=n[r],m=ew(f,function(r){return r.selector===e&&r.context===i});m||(m={selector:e,context:i,listeners:[]},f.push(m)),m.listeners.push({func:s,options:u})},removeDelegate:function(e,i,r,a,s){var o,u=tC(s),d=n[r],p=!1;if(d)for(o=d.length-1;o>=0;o--){var f=d[o];if(f.selector===e&&f.context===i){for(var m=f.listeners,g=m.length-1;g>=0;g--){var v=m[g];if(v.func===a&&tP(v.options,u)){m.splice(g,1),m.length||(d.splice(o,1),l(i,r,c),l(i,r,h,!0)),p=!0;break}}if(p)break}}},delegateListener:c,delegateUseCapture:h,delegatedEvents:n,documents:a,targets:r,supportsOptions:!1,supportsPassive:!1};function o(e,i,n,a){if(e.addEventListener){var o=tC(a),l=ew(r,function(i){return i.eventTarget===e});l||(l={eventTarget:e,events:{}},r.push(l)),l.events[i]||(l.events[i]=[]),ew(l.events[i],function(e){return e.func===n&&tP(e.options,o)})||(e.addEventListener(i,n,s.supportsOptions?o:o.capture),l.events[i].push({func:n,options:o}))}}function l(e,i,n,a){if(e.addEventListener&&e.removeEventListener){var o=eE(r,function(i){return i.eventTarget===e}),c=r[o];if(c&&c.events)if("all"!==i){var h=!1,u=c.events[i];if(u){if("all"===n){for(var d=u.length-1;d>=0;d--){var p=u[d];l(e,i,p.func,p.options)}return}for(var f=tC(a),m=0;m<u.length;m++){var g=u[m];if(g.func===n&&tP(g.options,f)){e.removeEventListener(i,n,s.supportsOptions?f:f.capture),u.splice(m,1),0===u.length&&(delete c.events[i],h=!0);break}}}h&&!Object.keys(c.events).length&&r.splice(o,1)}else for(i in c.events)c.events.hasOwnProperty(i)&&l(e,i,"all")}}function c(e,i){for(var r=tC(i),a=new tR(e),s=n[e.type],o=eM(e)[0],l=o;P(l);){for(var c=0;c<s.length;c++){var h=s[c],u=h.selector,d=h.context;if(H(l,u)&&z(d,o)&&z(d,l)){var p=h.listeners;a.currentTarget=l;for(var f=0;f<p.length;f++){var m=p[f];tP(m.options,r)&&m.func(a)}}}l=V(l)}}function h(e){return c(e,!0)}return null==(i=e.document)||i.createElement("div").addEventListener("test",null,{get capture(){return s.supportsOptions=!0},get passive(){return s.supportsPassive=!0}}),e.events=s,s}},tL={methodOrder:["simulationResume","mouseOrPen","hasPointer","idle"],search:function(e){for(var i=0,r=tL.methodOrder;i<r.length;i++){var n=tL[r[i]](e);if(n)return n}return null},simulationResume:function(e){var i=e.pointerType,r=e.eventType,n=e.eventTarget,a=e.scope;if(!/down|start/i.test(r))return null;for(var s=0,o=a.interactions.list;s<o.length;s++){var l=o[s],c=n;if(l.simulation&&l.simulation.allowResume&&l.pointerType===i)for(;c;){if(c===l.element)return l;c=V(c)}}return null},mouseOrPen:function(e){var i,r=e.pointerId,n=e.pointerType,a=e.eventType,s=e.scope;if("mouse"!==n&&"pen"!==n)return null;for(var o=0,l=s.interactions.list;o<l.length;o++){var c=l[o];if(c.pointerType===n){if(c.simulation&&!tD(c,r))continue;if(c.interacting())return c;i||(i=c)}}if(i)return i;for(var h=0,u=s.interactions.list;h<u.length;h++){var d=u[h];if(!(d.pointerType!==n||/down/i.test(a)&&d.simulation))return d}return null},hasPointer:function(e){for(var i=e.pointerId,r=0,n=e.scope.interactions.list;r<n.length;r++){var a=n[r];if(tD(a,i))return a}return null},idle:function(e){for(var i=e.pointerType,r=0,n=e.scope.interactions.list;r<n.length;r++){var a=n[r];if(1===a.pointers.length){var s=a.interactable;if(s&&(!s.options.gesture||!s.options.gesture.enabled))continue}else if(a.pointers.length>=2)continue;if(!a.interacting()&&i===a.pointerType)return a}return null}};function tD(e,i){return e.pointers.some(function(e){return e.id===i})}var tU=["pointerDown","pointerMove","pointerUp","updatePointer","removePointer","windowBlur"];function tN(e,i){return function(r){var n=i.interactions.list,a=ey(r),s=eM(r),o=s[0],l=s[1],c=[];if(/^touch/.test(r.type)){i.prevTouchTime=i.now();for(var h=0,u=r.changedTouches;h<u.length;h++){var d=u[h],p={pointer:d,pointerId:ef(d),pointerType:a,eventType:r.type,eventTarget:o,curEventTarget:l,scope:i},f=tO(p);c.push([p.pointer,p.eventTarget,p.curEventTarget,f])}}else{var m=!1;if(!B.supportsPointerEvent&&/mouse/.test(r.type)){for(var g=0;g<n.length&&!m;g++)m="mouse"!==n[g].pointerType&&n[g].pointerIsDown;m=m||i.now()-i.prevTouchTime<500||0===r.timeStamp}if(!m){var v={pointer:r,pointerId:ef(r),pointerType:a,eventType:r.type,curEventTarget:l,eventTarget:o,scope:i},_=tO(v);c.push([v.pointer,v.eventTarget,v.curEventTarget,_])}}for(var x=0;x<c.length;x++){var y=c[x],M=y[0],S=y[1],b=y[2];y[3][e](M,r,S,b)}}}function tO(e){var i=e.pointerType,r=e.scope,n={interaction:tL.search(e),searchDetails:e};return r.fire("interactions:find",n),n.interaction||r.interactions.new({pointerType:i})}function tF(e,i){var r=e.doc,n=e.scope,a=e.options,s=n.interactions.docEvents,o=n.events,l=o[i];for(var c in n.browser.isIOS&&!a.events&&(a.events={passive:!1}),o.delegatedEvents)l(r,c,o.delegateListener),l(r,c,o.delegateUseCapture,!0);for(var h=a&&a.events,u=0;u<s.length;u++){var d=s[u];l(r,d.type,d.listener,h)}}var tB={id:"core/interactions",install:function(e){for(var i={},r=0;r<tU.length;r++){var n=tU[r];i[n]=tN(n,e)}var s,c=B.pEventTypes;function h(){for(var i=0,r=e.interactions.list;i<r.length;i++){var n=r[i];if(n.pointerIsDown&&"touch"===n.pointerType&&!n._interacting)for(var a=0,s=n.pointers;a<s.length;a++)!function(){var i=s[a];e.documents.some(function(e){return z(e.doc,i.downTarget)})||n.removePointer(i.pointer,i.event)}()}}(s=O.PointerEvent?[{type:c.down,listener:h},{type:c.down,listener:i.pointerDown},{type:c.move,listener:i.pointerMove},{type:c.up,listener:i.pointerUp},{type:c.cancel,listener:i.pointerUp}]:[{type:"mousedown",listener:i.pointerDown},{type:"mousemove",listener:i.pointerMove},{type:"mouseup",listener:i.pointerUp},{type:"touchstart",listener:h},{type:"touchstart",listener:i.pointerDown},{type:"touchmove",listener:i.pointerMove},{type:"touchend",listener:i.pointerUp},{type:"touchcancel",listener:i.pointerUp}]).push({type:"blur",listener:function(i){for(var r=0,n=e.interactions.list;r<n.length;r++)n[r].documentBlur(i)}}),e.prevTouchTime=0,e.Interaction=function(i){l(n,i);var r=d(n);function n(){return a(this,n),r.apply(this,arguments)}return o(n,[{key:"pointerMoveTolerance",get:function(){return e.interactions.pointerMoveTolerance},set:function(i){e.interactions.pointerMoveTolerance=i}},{key:"_now",value:function(){return e.now()}}]),n}(tv),e.interactions={list:[],new:function(i){i.scopeFire=function(i,r){return e.fire(i,r)};var r=new e.Interaction(i);return e.interactions.list.push(r),r},listeners:i,docEvents:s,pointerMoveTolerance:1},e.usePlugin(tr)},listeners:{"scope:add-document":function(e){return tF(e,"add")},"scope:remove-document":function(e){return tF(e,"remove")},"interactable:unset":function(e,i){for(var r=e.interactable,n=i.interactions.list.length-1;n>=0;n--){var a=i.interactions.list[n];a.interactable===r&&(a.stop(),i.fire("interactions:destroy",{interaction:a}),a.destroy(),i.interactions.list.length>2&&i.interactions.list.splice(n,1))}}},onDocSignal:tF,doOnInteractions:tN,methodNames:tU},tz=((v=tz||{})[v.On=0]="On",v[v.Off=1]="Off",v),tk=function(){function e(i,r,n,s){a(this,e),this.target=void 0,this.options=void 0,this._actions=void 0,this.events=new tA,this._context=void 0,this._win=void 0,this._doc=void 0,this._scopeEvents=void 0,this._actions=r.actions,this.target=i,this._context=r.context||n,this._win=S(J(i)?this._context:i),this._doc=this._win.document,this._scopeEvents=s,this.set(r)}return o(e,[{key:"_defaults",get:function(){return{base:{},perAction:{},actions:{}}}},{key:"setOnEvents",value:function(e,i){return T(i.onstart)&&this.on("".concat(e,"start"),i.onstart),T(i.onmove)&&this.on("".concat(e,"move"),i.onmove),T(i.onend)&&this.on("".concat(e,"end"),i.onend),T(i.oninertiastart)&&this.on("".concat(e,"inertiastart"),i.oninertiastart),this}},{key:"updatePerActionListeners",value:function(e,i,r){var n,a=this,s=null==(n=this._actions.map[e])?void 0:n.filterEventType,o=function(e){return(null==s||s(e))&&tn(e,a._actions)};(L(i)||b(i))&&this._onOff(tz.Off,e,i,void 0,o),(L(r)||b(r))&&this._onOff(tz.On,e,r,void 0,o)}},{key:"setPerAction",value:function(e,i){var r=this._defaults;for(var n in i){var a=this.options[e],s=i[n];"listeners"===n&&this.updatePerActionListeners(e,a.listeners,s),L(s)?a[n]=eT(s):I(s)?(a[n]=Z(a[n]||{},ta(s)),b(r.perAction[n])&&"enabled"in r.perAction[n]&&(a[n].enabled=!1!==s.enabled)):R(s)&&b(r.perAction[n])?a[n].enabled=s:a[n]=s}}},{key:"getRect",value:function(e){return e=e||(P(this.target)?this.target:null),C(this.target)&&(e=e||this._context.querySelector(this.target)),Y(e)}},{key:"rectChecker",value:function(e){var i=this;return T(e)?(this.getRect=function(r){var n=Z({},e.apply(i,r));return"width"in n||(n.width=n.right-n.left,n.height=n.bottom-n.top),n},this):null===e?(delete this.getRect,this):this.getRect}},{key:"_backCompatOption",value:function(e,i){if(J(i)||b(i)){for(var r in this.options[e]=i,this._actions.map)this.options[r][e]=i;return this}return this.options[e]}},{key:"origin",value:function(e){return this._backCompatOption("origin",e)}},{key:"deltaSource",value:function(e){return"page"===e||"client"===e?(this.options.deltaSource=e,this):this.options.deltaSource}},{key:"getAllElements",value:function(){var e=this.target;return C(e)?Array.from(this._context.querySelectorAll(e)):T(e)&&e.getAllElements?e.getAllElements():P(e)?[e]:[]}},{key:"context",value:function(){return this._context}},{key:"inContext",value:function(e){return this._context===e.ownerDocument||z(this._context,e)}},{key:"testIgnoreAllow",value:function(e,i,r){return!this.testIgnore(e.ignoreFrom,i,r)&&this.testAllow(e.allowFrom,i,r)}},{key:"testAllow",value:function(e,i,r){return!e||!!P(r)&&(C(e)?X(r,e,i):!!P(e)&&z(e,r))}},{key:"testIgnore",value:function(e,i,r){return!(!e||!P(r))&&(C(e)?X(r,e,i):!!P(e)&&z(e,r))}},{key:"fire",value:function(e){return this.events.fire(e),this}},{key:"_onOff",value:function(e,i,r,n,a){b(i)&&!L(i)&&(n=r,r=null);var s=en(i,r,a);for(var o in s){"wheel"===o&&(o=B.wheelEvent);for(var l=0,c=s[o];l<c.length;l++){var h=c[l];tn(o,this._actions)?this.events[e===tz.On?"on":"off"](o,h):C(this.target)?this._scopeEvents[e===tz.On?"addDelegate":"removeDelegate"](this.target,this._context,o,h,n):this._scopeEvents[e===tz.On?"add":"remove"](this.target,o,h,n)}}return this}},{key:"on",value:function(e,i,r){return this._onOff(tz.On,e,i,r)}},{key:"off",value:function(e,i,r){return this._onOff(tz.Off,e,i,r)}},{key:"set",value:function(e){var i=this._defaults;for(var r in b(e)||(e={}),this.options=ta(i.base),this._actions.methodDict){var n=this._actions.methodDict[r];this.options[r]={},this.setPerAction(r,Z(Z({},i.perAction),i.actions[r])),this[n](e[r])}for(var a in e)"getRect"!==a?T(this[a])&&this[a](e[a]):this.rectChecker(e.getRect);return this}},{key:"unset",value:function(){if(C(this.target))for(var e in this._scopeEvents.delegatedEvents)for(var i=this._scopeEvents.delegatedEvents[e],r=i.length-1;r>=0;r--){var n=i[r],a=n.selector,s=n.context,o=n.listeners;a===this.target&&s===this._context&&i.splice(r,1);for(var l=o.length-1;l>=0;l--)this._scopeEvents.removeDelegate(this.target,this._context,e,o[l][0],o[l][1])}else this._scopeEvents.remove(this.target,"all")}}]),e}(),tV=function(){function e(i){var r=this;a(this,e),this.list=[],this.selectorMap={},this.scope=void 0,this.scope=i,i.addListeners({"interactable:unset":function(e){var i=e.interactable,n=i.target,a=C(n)?r.selectorMap[n]:n[r.scope.id],s=eE(a,function(e){return e===i});a.splice(s,1)}})}return o(e,[{key:"new",value:function(e,i){i=Z(i||{},{actions:this.scope.actions});var r=new this.scope.Interactable(e,i,this.scope.document,this.scope.events);return this.scope.addDocument(r._doc),this.list.push(r),C(e)?(this.selectorMap[e]||(this.selectorMap[e]=[]),this.selectorMap[e].push(r)):(r.target[this.scope.id]||Object.defineProperty(e,this.scope.id,{value:[],configurable:!0}),e[this.scope.id].push(r)),this.scope.fire("interactable:new",{target:e,options:i,interactable:r,win:this.scope._win}),r}},{key:"getExisting",value:function(e,i){var r=i&&i.context||this.scope.document,n=C(e),a=n?this.selectorMap[e]:e[this.scope.id];if(a)return ew(a,function(i){return i._context===r&&(n||i.inContext(e))})}},{key:"forEachMatch",value:function(e,i){for(var r=0,n=this.list;r<n.length;r++){var a=n[r],s=void 0;if((C(a.target)?P(e)&&H(e,a.target):e===a.target)&&a.inContext(e)&&(s=i(a)),void 0!==s)return s}}}]),e}();function tH(e){return e&&e.replace(/\/.*$/,"")}var tG=new(function(){function e(){var i,r,n=this;a(this,e),this.id="__interact_scope_".concat(Math.floor(100*Math.random())),this.isInitialized=!1,this.listenerMaps=[],this.browser=B,this.defaults=ta(tu),this.Eventable=tA,this.actions={map:{},phases:{start:!0,move:!0,end:!0},methodDict:{},phaselessTypes:{}},this.interactStatic=(i=this,(r=function e(r,n){var a=i.interactables.getExisting(r,n);return a||((a=i.interactables.new(r,n)).events.global=e.globalEvents),a}).getPointerAverage=eg,r.getTouchBBox=ev,r.getTouchDistance=e_,r.getTouchAngle=ex,r.getElementRect=Y,r.getElementClientRect=q,r.matchesSelector=H,r.closest=k,r.globalEvents={},r.version="1.10.27",r.scope=i,r.use=function(e,i){return this.scope.usePlugin(e,i),this},r.isSet=function(e,i){return!!this.scope.interactables.get(e,i&&i.context)},r.on=eK(function(e,i,r){if(C(e)&&-1!==e.search(" ")&&(e=e.trim().split(/ +/)),L(e)){for(var n=0,a=e;n<a.length;n++){var s=a[n];this.on(s,i,r)}return this}if(b(e)){for(var o in e)this.on(o,e[o],i);return this}return tn(e,this.scope.actions)?this.globalEvents[e]?this.globalEvents[e].push(i):this.globalEvents[e]=[i]:this.scope.events.add(this.scope.document,e,i,{options:r}),this},"The interact.on() method is being deprecated"),r.off=eK(function(e,i,r){if(C(e)&&-1!==e.search(" ")&&(e=e.trim().split(/ +/)),L(e)){for(var n,a=0,s=e;a<s.length;a++){var o=s[a];this.off(o,i,r)}return this}if(b(e)){for(var l in e)this.off(l,e[l],i);return this}return tn(e,this.scope.actions)?e in this.globalEvents&&-1!==(n=this.globalEvents[e].indexOf(i))&&this.globalEvents[e].splice(n,1):this.scope.events.remove(this.scope.document,e,i,r),this},"The interact.off() method is being deprecated"),r.debug=function(){return this.scope},r.supportsTouch=function(){return B.supportsTouch},r.supportsPointerEvent=function(){return B.supportsPointerEvent},r.stop=function(){for(var e=0,i=this.scope.interactions.list;e<i.length;e++)i[e].stop();return this},r.pointerMoveTolerance=function(e){return A(e)?(this.scope.interactions.pointerMoveTolerance=e,this):this.scope.interactions.pointerMoveTolerance},r.addDocument=function(e,i){this.scope.addDocument(e,i)},r.removeDocument=function(e){this.scope.removeDocument(e)},r),this.InteractEvent=td,this.Interactable=void 0,this.interactables=new tV(this),this._win=void 0,this.document=void 0,this.window=void 0,this.documents=[],this._plugins={list:[],map:{}},this.onWindowUnload=function(e){return n.removeDocument(e.target)};var s=this;this.Interactable=function(e){l(r,e);var i=d(r);function r(){return a(this,r),i.apply(this,arguments)}return o(r,[{key:"_defaults",get:function(){return s.defaults}},{key:"set",value:function(e){return p(c(r.prototype),"set",this).call(this,e),s.fire("interactable:set",{options:e,interactable:this}),this}},{key:"unset",value:function(){p(c(r.prototype),"unset",this).call(this);var e=s.interactables.list.indexOf(this);e<0||(s.interactables.list.splice(e,1),s.fire("interactable:unset",{interactable:this}))}}]),r}(tk)}return o(e,[{key:"addListeners",value:function(e,i){this.listenerMaps.push({id:i,map:e})}},{key:"fire",value:function(e,i){for(var r=0,n=this.listenerMaps;r<n.length;r++){var a=n[r].map[e];if(a&&!1===a(i,this,e))return!1}}},{key:"init",value:function(e){return this.isInitialized||(this.isInitialized=!0,E(e)&&M(e),O.init(e),B.init(e),eW(e),this.window=e,this.document=e.document,this.usePlugin(tB),this.usePlugin(tI)),this}},{key:"pluginIsInstalled",value:function(e){var i=e.id;return i?!!this._plugins.map[i]:-1!==this._plugins.list.indexOf(e)}},{key:"usePlugin",value:function(e,i){if(!this.isInitialized||this.pluginIsInstalled(e))return this;if(e.id&&(this._plugins.map[e.id]=e),this._plugins.list.push(e),e.install&&e.install(this,i),e.listeners&&e.before){for(var r=0,n=this.listenerMaps.length,a=e.before.reduce(function(e,i){return e[i]=!0,e[tH(i)]=!0,e},{});r<n;r++){var s=this.listenerMaps[r].id;if(s&&(a[s]||a[tH(s)]))break}this.listenerMaps.splice(r,0,{id:e.id,map:e.listeners})}else e.listeners&&this.listenerMaps.push({id:e.id,map:e.listeners});return this}},{key:"addDocument",value:function(e,i){if(-1!==this.getDocIndex(e))return!1;var r=S(e);i=i?Z({},i):{},this.documents.push({doc:e,options:i}),this.events.documents.push(e),e!==this.document&&this.events.add(r,"unload",this.onWindowUnload),this.fire("scope:add-document",{doc:e,window:r,scope:this,options:i})}},{key:"removeDocument",value:function(e){var i=this.getDocIndex(e),r=S(e),n=this.documents[i].options;this.events.remove(r,"unload",this.onWindowUnload),this.documents.splice(i,1),this.events.documents.splice(i,1),this.fire("scope:remove-document",{doc:e,window:r,scope:this,options:n})}},{key:"getDocIndex",value:function(e){for(var i=0;i<this.documents.length;i++)if(this.documents[i].doc===e)return i;return -1}},{key:"getDocOptions",value:function(e){var i=this.getDocIndex(e);return -1===i?null:this.documents[i].options}},{key:"now",value:function(){return(this.window.Date||Date).now()}}]),e}()),tW=tG.interactStatic,tX="u">typeof globalThis?globalThis:window;tG.init(tX);var tj=Object.freeze({__proto__:null,edgeTarget:function(){},elements:function(){},grid:function(e){var i=[["x","y"],["left","top"],["right","bottom"],["width","height"]].filter(function(i){var r=i[0],n=i[1];return r in e||n in e}),r=function(r,n){for(var a=e.range,s=e.limits,o=void 0===s?{left:-1/0,right:1/0,top:-1/0,bottom:1/0}:s,l=e.offset,c=void 0===l?{x:0,y:0}:l,h={range:a,grid:e,x:null,y:null},u=0;u<i.length;u++){var d=i[u],p=d[0],f=d[1],m=Math.round((r-c.x)/e[p]),g=Math.round((n-c.y)/e[f]);h[p]=Math.max(o.left,Math.min(o.right,m*e[p]+c.x)),h[f]=Math.max(o.top,Math.min(o.bottom,g*e[f]+c.y))}return h};return r.grid=e,r.coordFields=i,r}}),tq={id:"snappers",install:function(e){var i=e.interactStatic;i.snappers=Z(i.snappers||{},tj),i.createSnapGrid=i.snappers.grid}};function tY(e,i,r){var n=e.startCoords,a=e.edgeSign;i?r.y=n.y+(r.x-n.x)*a.y:r.x=n.x+(r.y-n.y)*a.x}function tK(e,i,r,n){var a=e.startRect,s=e.startCoords,o=e.ratio,l=e.edgeSign;if(i){var c=n.width/o;r.y=s.y+(c-a.height)*l.y}else{var h=n.height*o;r.x=s.x+(h-a.width)*l.x}}var tJ=tl({start:function(e){var i=e.state,n=e.rect,a=e.edges,s=e.pageCoords,o=i.options,l=o.ratio,c=o.enabled,h=i.options,u=h.equalDelta,d=h.modifiers;"preserve"===l&&(l=n.width/n.height),i.startCoords=Z({},s),i.startRect=Z({},n),i.ratio=l,i.equalDelta=u;var p=i.linkedEdges={top:a.top||a.left&&!a.bottom,left:a.left||a.top&&!a.right,bottom:a.bottom||a.right&&!a.top,right:a.right||a.bottom&&!a.left};if(i.xIsPrimaryAxis=!(!a.left&&!a.right),i.equalDelta){var f=(p.left?1:-1)*(p.top?1:-1);i.edgeSign={x:f,y:f}}else i.edgeSign={x:p.left?-1:1,y:p.top?-1:1};if(!1!==c&&Z(a,p),null!=d&&d.length){var m=new ts(e.interaction);m.copyFrom(e.interaction.modification),m.prepareStates(d),i.subModification=m,m.startAll(r({},e))}},set:function(e){var i=e.state,n=e.rect,a=e.coords,s=i.linkedEdges,o=Z({},a),l=i.equalDelta?tY:tK;if(Z(e.edges,s),l(i,i.xIsPrimaryAxis,a,n),!i.subModification)return null;var c=Z({},n);ei(s,c,{x:a.x-o.x,y:a.y-o.y});var h=i.subModification.setAll(r(r({},e),{},{rect:c,edges:s,pageCoords:a,prevCoords:a,prevRect:c})),u=h.delta;return h.changed&&(l(i,Math.abs(u.x)>Math.abs(u.y),h.coords,h.rect),Z(a,h.coords)),h.eventProps},defaults:{ratio:"preserve",equalDelta:!1,modifiers:[],enabled:!1}},"aspectRatio"),tZ=function(){};function tQ(e,i,r){return T(e)?$(e,i.interactable,i.element,[r.x,r.y,i]):$(e,i.interactable,i.element)}tZ._defaults={};var t$={start:function(e){var i=e.rect,r=e.startOffset,n=e.state,a=e.interaction,s=e.pageCoords,o=n.options,l=o.elementRect,c=Z({left:0,top:0,right:0,bottom:0},o.offset||{});if(i&&l){var h=tQ(o.restriction,a,s);if(h){var u=h.right-h.left-i.width,d=h.bottom-h.top-i.height;u<0&&(c.left+=u,c.right+=u),d<0&&(c.top+=d,c.bottom+=d)}c.left+=r.left-i.width*l.left,c.top+=r.top-i.height*l.top,c.right+=r.right-i.width*(1-l.right),c.bottom+=r.bottom-i.height*(1-l.bottom)}n.offset=c},set:function(e){var i=e.coords,r=e.interaction,n=e.state,a=n.options,s=n.offset,o=tQ(a.restriction,r,i);if(o){var l,c=(!(l=o)||"left"in l&&"top"in l||((l=Z({},l)).left=l.x||0,l.top=l.y||0,l.right=l.right||l.left+l.width,l.bottom=l.bottom||l.top+l.height),l);i.x=Math.max(Math.min(c.right-s.right,i.x),c.left+s.left),i.y=Math.max(Math.min(c.bottom-s.bottom,i.y),c.top+s.top)}},defaults:{restriction:null,elementRect:null,offset:null,endOnly:!1,enabled:!1}},t0=tl(t$,"restrict"),t1={top:1/0,left:1/0,bottom:-1/0,right:-1/0},t3={top:-1/0,left:-1/0,bottom:1/0,right:1/0};function t2(e,i){for(var r=0,n=["top","left","bottom","right"];r<n.length;r++){var a=n[r];a in e||(e[a]=i[a])}return e}var t4={noInner:t1,noOuter:t3,start:function(e){var i,r=e.interaction,n=e.startOffset,a=e.state,s=a.options;s&&(i=ee(tQ(s.offset,r,r.coords.start.page))),a.offset={top:(i=i||{x:0,y:0}).y+n.top,left:i.x+n.left,bottom:i.y-n.bottom,right:i.x-n.right}},set:function(e){var i=e.coords,r=e.edges,n=e.interaction,a=e.state,s=a.offset,o=a.options;if(r){var l=Z({},i),c=tQ(o.inner,n,l)||{},h=tQ(o.outer,n,l)||{};t2(c,t1),t2(h,t3),r.top?i.y=Math.min(Math.max(h.top+s.top,l.y),c.top+s.top):r.bottom&&(i.y=Math.max(Math.min(h.bottom+s.bottom,l.y),c.bottom+s.bottom)),r.left?i.x=Math.min(Math.max(h.left+s.left,l.x),c.left+s.left):r.right&&(i.x=Math.max(Math.min(h.right+s.right,l.x),c.right+s.right))}},defaults:{inner:null,outer:null,offset:null,endOnly:!1,enabled:!1}},t5=tl(t4,"restrictEdges"),t6=Z({get elementRect(){return{top:0,left:0,bottom:1,right:1}},set elementRect(t){}},t$.defaults),t8=tl({start:t$.start,set:t$.set,defaults:t6},"restrictRect"),t9={width:-1/0,height:-1/0},t7={width:1/0,height:1/0},ie=tl({start:function(e){return t4.start(e)},set:function(e){var i=e.interaction,r=e.state,n=e.rect,a=e.edges,s=r.options;if(a){var o=et(tQ(s.min,i,e.coords))||t9,l=et(tQ(s.max,i,e.coords))||t7;r.options={endOnly:s.endOnly,inner:Z({},t4.noInner),outer:Z({},t4.noOuter)},a.top?(r.options.inner.top=n.bottom-o.height,r.options.outer.top=n.bottom-l.height):a.bottom&&(r.options.inner.bottom=n.top+o.height,r.options.outer.bottom=n.top+l.height),a.left?(r.options.inner.left=n.right-o.width,r.options.outer.left=n.right-l.width):a.right&&(r.options.inner.right=n.left+o.width,r.options.outer.right=n.left+l.width),t4.set(e),r.options=s}},defaults:{min:null,max:null,endOnly:!1,enabled:!1}},"restrictSize"),it={start:function(e){var i,r,n=e.interaction,a=e.interactable,s=e.element,o=e.rect,l=e.state,c=e.startOffset,h=l.options,u=h.offsetWithOrigin?(i=e.interaction.element,ee($(e.state.options.origin,null,null,[i]))||er(e.interactable,i,e.interaction.prepared.name)):{x:0,y:0};if("startCoords"===h.offset)r={x:n.coords.start.page.x,y:n.coords.start.page.y};else{var d=$(h.offset,a,s,[n]);(r=ee(d)||{x:0,y:0}).x+=u.x,r.y+=u.y}var p=h.relativePoints;l.offsets=o&&p&&p.length?p.map(function(e,i){return{index:i,relativePoint:e,x:c.left-o.width*e.x+r.x,y:c.top-o.height*e.y+r.y}}):[{index:0,relativePoint:null,x:r.x,y:r.y}]},set:function(e){var i=e.interaction,r=e.coords,n=e.state,a=n.options,s=n.offsets,o=er(i.interactable,i.element,i.prepared.name),l=Z({},r),c=[];a.offsetWithOrigin||(l.x-=o.x,l.y-=o.y);for(var h=0;h<s.length;h++)for(var u=s[h],d=l.x-u.x,p=l.y-u.y,f=0,m=a.targets.length;f<m;f++){var g=a.targets[f],v=void 0;(v=T(g)?g(d,p,i._proxy,u,f):g)&&c.push({x:(A(v.x)?v.x:d)+u.x,y:(A(v.y)?v.y:p)+u.y,range:A(v.range)?v.range:a.range,source:g,index:f,offset:u})}for(var _={target:null,inRange:!1,distance:0,range:0,delta:{x:0,y:0}},x=0;x<c.length;x++){var y=c[x],M=y.range,S=y.x-l.x,b=y.y-l.y,E=es(S,b),w=E<=M;M===1/0&&_.inRange&&_.range!==1/0&&(w=!1),(!_.target||(w?_.inRange&&M!==1/0?E/M<_.distance/_.range:M===1/0&&_.range!==1/0||E<_.distance:!_.inRange&&E<_.distance))&&(_.target=y,_.distance=E,_.range=M,_.inRange=w,_.delta.x=S,_.delta.y=b)}return _.inRange&&(r.x=_.target.x,r.y=_.target.y),n.closest=_,_},defaults:{range:1/0,targets:null,offset:null,offsetWithOrigin:!0,origin:null,relativePoints:null,endOnly:!1,enabled:!1}},ii=tl(it,"snap"),ir={start:function(e){var i=e.state,r=e.edges,n=i.options;if(!r)return null;e.state={options:{targets:null,relativePoints:[{x:+!r.left,y:+!r.top}],offset:n.offset||"self",origin:{x:0,y:0},range:n.range}},i.targetFields=i.targetFields||[["width","height"],["x","y"]],it.start(e),i.offsets=e.state.offsets,e.state=i},set:function(e){var i=e.interaction,r=e.state,n=e.coords,a=r.options,s=r.offsets,o={x:n.x-s[0].x,y:n.y-s[0].y};r.options=Z({},a),r.options.targets=[];for(var l=0,c=a.targets||[];l<c.length;l++){var h=c[l],u=void 0;if(u=T(h)?h(o.x,o.y,i):h){for(var d=0,p=r.targetFields;d<p.length;d++){var f=p[d],m=f[0],g=f[1];if(m in u||g in u){u.x=u[m],u.y=u[g];break}}r.options.targets.push(u)}}var v=it.set(e);return r.options=a,v},defaults:{range:1/0,targets:null,offset:null,endOnly:!1,enabled:!1}},ia=tl(ir,"snapSize"),is={aspectRatio:tJ,restrictEdges:t5,restrict:t0,restrictRect:t8,restrictSize:ie,snapEdges:tl({start:function(e){var i=e.edges;return i?(e.state.targetFields=e.state.targetFields||[[i.left?"left":"right",i.top?"top":"bottom"]],ir.start(e)):null},set:ir.set,defaults:Z(ta(ir.defaults),{targets:void 0,range:void 0,offset:{x:0,y:0}})},"snapEdges"),snap:ii,snapSize:ia,spring:tZ,avoid:tZ,transform:tZ,rubberband:tZ},io=function(e){l(r,e);var i=d(r);function r(e,n,s,o,l,c){var h;if(a(this,r),el(u(h=i.call(this,l)),s),s!==n&&el(u(h),n),h.timeStamp=c,h.originalEvent=s,h.type=e,h.pointerId=ef(n),h.pointerType=ey(n),h.target=o,h.currentTarget=null,"tap"===e){var d=l.getPointerIndex(n);h.dt=h.timeStamp-l.pointers[d].downTime;var p=h.timeStamp-l.tapTime;h.double=!!l.prevTap&&"doubletap"!==l.prevTap.type&&l.prevTap.target===h.target&&p<500}else"doubletap"===e&&(h.dt=n.timeStamp-l.tapTime,h.double=!0);return h}return o(r,[{key:"_subtractOrigin",value:function(e){var i=e.x,r=e.y;return this.pageX-=i,this.pageY-=r,this.clientX-=i,this.clientY-=r,this}},{key:"_addOrigin",value:function(e){var i=e.x,r=e.y;return this.pageX+=i,this.pageY+=r,this.clientX+=i,this.clientY+=r,this}},{key:"preventDefault",value:function(){this.originalEvent.preventDefault()}}]),r}(eS),il={id:"pointer-events/base",before:["inertia","modifiers","auto-start","actions"],install:function(e){e.pointerEvents=il,e.defaults.actions.pointerEvents=il.defaults,Z(e.actions.phaselessTypes,il.types)},listeners:{"interactions:new":function(e){var i=e.interaction;i.prevTap=null,i.tapTime=0},"interactions:update-pointer":function(e){var i=e.down,r=e.pointerInfo;(i||!r.hold)&&(r.hold={duration:1/0,timeout:null})},"interactions:move":function(e,i){var r=e.interaction,n=e.pointer,a=e.event,s=e.eventTarget;e.duplicate||r.pointerIsDown&&!r.pointerWasMoved||(r.pointerIsDown&&iu(e),ic({interaction:r,pointer:n,event:a,eventTarget:s,type:"move"},i))},"interactions:down":function(e,i){!function(e,i){for(var r=e.interaction,n=e.pointer,a=e.event,s=e.eventTarget,o=e.pointerIndex,l=r.pointers[o].hold,c=K(s),h={interaction:r,pointer:n,event:a,eventTarget:s,type:"hold",targets:[],path:c,node:null},u=0;u<c.length;u++)h.node=c[u],i.fire("pointerEvents:collect-targets",h);if(h.targets.length){for(var d=1/0,p=0,f=h.targets;p<f.length;p++){var m=f[p].eventable.options.holdDuration;m<d&&(d=m)}l.duration=d,l.timeout=setTimeout(function(){ic({interaction:r,eventTarget:s,pointer:n,event:a,type:"hold"},i)},d)}}(e,i),ic(e,i)},"interactions:up":function(e,i){var r,n,a,s;iu(e),ic(e,i),r=e.interaction,n=e.pointer,a=e.event,s=e.eventTarget,r.pointerWasMoved||ic({interaction:r,eventTarget:s,pointer:n,event:a,type:"tap"},i)},"interactions:cancel":function(e,i){iu(e),ic(e,i)}},PointerEvent:io,fire:ic,collectEventTargets:ih,defaults:{holdDuration:600,ignoreFrom:null,allowFrom:null,origin:{x:0,y:0}},types:{down:!0,move:!0,up:!0,cancel:!0,tap:!0,doubletap:!0,hold:!0}};function ic(e,i){var r=e.interaction,n=e.pointer,a=e.event,s=e.eventTarget,o=e.type,l=e.targets,c=void 0===l?ih(e,i):l,h=new io(o,n,a,s,r,i.now());i.fire("pointerEvents:new",{pointerEvent:h});for(var u=0;u<c.length;u++){var d=c[u];for(var p in d.props||{})h[p]=d.props[p];var f=er(d.eventable,d.node);if(h._subtractOrigin(f),h.eventable=d.eventable,h.currentTarget=d.node,d.eventable.fire(h),h._addOrigin(f),h.immediatePropagationStopped||h.propagationStopped&&u+1<c.length&&c[u+1].node!==h.currentTarget)break}if(i.fire("pointerEvents:fired",{interaction:r,pointer:n,event:a,eventTarget:s,targets:c,type:o,pointerEvent:h}),"tap"===o){var m=h.double?ic({interaction:r,pointer:n,event:a,eventTarget:s,type:"doubletap"},i):h;r.prevTap=m,r.tapTime=m.timeStamp}return h}function ih(e,i){var r=e.interaction,n=e.pointer,a=e.event,s=e.eventTarget,o=e.type,l=r.getPointerIndex(n),c=r.pointers[l];if("tap"===o&&(r.pointerWasMoved||!c||c.downTarget!==s))return[];for(var h=K(s),u={interaction:r,pointer:n,event:a,eventTarget:s,type:o,path:h,targets:[],node:null},d=0;d<h.length;d++)u.node=h[d],i.fire("pointerEvents:collect-targets",u);return"hold"===o&&(u.targets=u.targets.filter(function(e){var i,n;return e.eventable.options.holdDuration===(null==(i=r.pointers[l])||null==(n=i.hold)?void 0:n.duration)})),u.targets}function iu(e){var i=e.interaction,r=e.pointerIndex,n=i.pointers[r].hold;n&&n.timeout&&(clearTimeout(n.timeout),n.timeout=null)}var id=Object.freeze({__proto__:null,default:il});function ip(e){var i=e.interaction;i.holdIntervalHandle&&(clearInterval(i.holdIntervalHandle),i.holdIntervalHandle=null)}var im={id:"pointer-events/holdRepeat",install:function(e){e.usePlugin(il);var i=e.pointerEvents;i.defaults.holdRepeatInterval=0,i.types.holdrepeat=e.actions.phaselessTypes.holdrepeat=!0},listeners:["move","up","cancel","endall"].reduce(function(e,i){return e["pointerEvents:".concat(i)]=ip,e},{"pointerEvents:new":function(e){var i=e.pointerEvent;"hold"===i.type&&(i.count=(i.count||0)+1)},"pointerEvents:fired":function(e,i){var r=e.interaction,n=e.pointerEvent,a=e.eventTarget,s=e.targets;if("hold"===n.type&&s.length){var o=s[0].eventable.options.holdRepeatInterval;o<=0||(r.holdIntervalHandle=setTimeout(function(){i.pointerEvents.fire({interaction:r,eventTarget:a,type:"hold",pointer:n,event:n},i)},o))}}})},ig={id:"pointer-events/interactableTargets",install:function(e){var i=e.Interactable;i.prototype.pointerEvents=function(e){return Z(this.events.options,e),this};var r=i.prototype._backCompatOption;i.prototype._backCompatOption=function(e,i){var n=r.call(this,e,i);return n===this&&(this.events.options[e]=i),n}},listeners:{"pointerEvents:collect-targets":function(e,i){var r=e.targets,n=e.node,a=e.type,s=e.eventTarget;i.interactables.forEachMatch(n,function(e){var i=e.events,o=i.options;i.types[a]&&i.types[a].length&&e.testIgnoreAllow(o,n,s)&&r.push({node:n,eventable:i,props:{interactable:e}})})},"interactable:new":function(e){var i=e.interactable;i.events.getRect=function(e){return i.getRect(e)}},"interactable:set":function(e,i){var r=e.interactable,n=e.options;Z(r.events.options,i.pointerEvents.defaults),Z(r.events.options,n.pointerEvents||{})}}};if(tW.use(tr),tW.use(tS),tW.use({id:"pointer-events",install:function(e){e.usePlugin(id),e.usePlugin(im),e.usePlugin(ig)}}),tW.use({id:"inertia",before:["modifiers","actions"],install:function(e){var i=e.defaults;e.usePlugin(tS),e.usePlugin(th),e.actions.phases.inertiastart=!0,e.actions.phases.resume=!0,i.perAction.inertia={enabled:!1,resistance:10,minSpeed:100,endSpeed:10,allowResume:!0,smoothEndDuration:300}},listeners:{"interactions:new":function(e){var i=e.interaction;i.inertia=new tb(i)},"interactions:before-action-end":function(e){var i=e.interaction,r=e.event;return(!i._interacting||i.simulation||!i.inertia.start(r))&&null},"interactions:down":function(e){var i=e.interaction,r=e.eventTarget,n=i.inertia;if(n.active)for(var a=r;P(a);){if(a===i.element){n.resume(e);break}a=V(a)}},"interactions:stop":function(e){var i=e.interaction.inertia;i.active&&i.stop()},"interactions:before-action-resume":function(e){var i=e.interaction.modification;i.stop(e),i.start(e,e.interaction.coords.cur.page),i.applyToInteraction(e)},"interactions:before-action-inertiastart":function(e){return e.interaction.modification.setAndApply(e)},"interactions:action-resume":tc,"interactions:action-inertiastart":tc,"interactions:after-action-inertiastart":function(e){return e.interaction.modification.restoreInteractionCoords(e)},"interactions:after-action-resume":function(e){return e.interaction.modification.restoreInteractionCoords(e)}}}),tW.use({id:"modifiers",install:function(e){var i=e.interactStatic;for(var r in e.usePlugin(th),e.usePlugin(tq),i.modifiers=is,is){var n=is[r],a=n._defaults;a._methods=n._methods,e.defaults.perAction[r]=a}}}),tW.use({id:"auto-start",install:function(e){e.usePlugin(e8),e.usePlugin(te),e.usePlugin(e9)}}),tW.use({id:"actions",install:function(e){e.usePlugin(eO),e.usePlugin(ek),e.usePlugin(N),e.usePlugin(eU)}}),tW.use(eY),tW.use({id:"reflow",install:function(e){var i=e.Interactable;e.actions.phases.reflow=!0,i.prototype.reflow=function(i){return function(e,i,r){for(var n=e.getAllElements(),a=r.window.Promise,s=a?[]:null,o=0;o<n.length&&!function(){var l=n[o],c=e.getRect(l);if(!c)return 1;var h,u=ew(r.interactions.list,function(r){return r.interacting()&&r.interactable===e&&r.element===l&&r.prepared.name===i.name});if(u)u.move(),s&&(h=u._reflowPromise||new a(function(e){u._reflowResolve=e}));else{var d,p,f,m,g=et(c),v={coords:{page:{x:g.x,y:g.y},client:{x:g.x,y:g.y},timeStamp:r.now()},get page(){return this.coords.page},get client(){return this.coords.client},get timeStamp(){return this.coords.timeStamp},get pageX(){return this.coords.page.x},get pageY(){return this.coords.page.y},get clientX(){return this.coords.client.x},get clientY(){return this.coords.client.y},get pointerId(){return this.coords.pointerId},get target(){return this.coords.target},get type(){return this.coords.type},get pointerType(){return this.coords.pointerType},get buttons(){return this.coords.buttons},preventDefault:function(){}};p={interaction:d=r.interactions.new({pointerType:"reflow"}),event:v,pointer:v,eventTarget:l,phase:"reflow"},d.interactable=e,d.element=l,d.prevEvent=v,d.updatePointer(v,v,l,!0),eh(d.coords.delta),eJ(d.prepared,i),d._doPhase(p),m=(f=r.window.Promise)?new f(function(e){d._reflowResolve=e}):void 0,d._reflowPromise=m,d.start(i,e,l),d._interacting?(d.move(p),d.end(v)):(d.stop(),d._reflowResolve()),d.removePointer(v,v),h=m}s&&s.push(h)}();o++);return s&&a.all(s).then(function(){return e})}(this,i,e)}},listeners:{"interactions:stop":function(e,i){var r,n=e.interaction;"reflow"===n.pointerType&&(n._reflowResolve&&n._reflowResolve(),r=i.interactions.list,r.splice(r.indexOf(n),1))}}}),tW.default=tW,"object"===n(e)&&e)try{e.exports=tW}catch(e){}return tW.default=tW,tW}()},"./node_modules/jsoncrush/JSONCrush.js"(e,i,r){"use strict";r.d(i,{A:()=>n});let n={crush:(e,i=50)=>{let r=[];for(let e=127;--e;)(e>=48&&e<=57||e>=65&&e<=90||e>=97&&e<=122||"-_.!~*'()".includes(String.fromCharCode(e)))&&r.push(String.fromCharCode(e));for(let e=32;e<255;++e){let i=String.fromCharCode(e);"\\"==i||r.includes(i)||r.unshift(i)}let n=((e,r)=>{let n=r.length,a="",s=e=>encodeURI(encodeURIComponent(e)).replace(/%../g,"i").length,o=e=>{let i=e.charCodeAt(0),r=e.charCodeAt(e.length-1);return i>=56320&&i<=57343||r>=55296&&r<=56319},l={};for(let r=2;r<i;r++)for(let i=0;i<e.length-r;++i){let n=e.substr(i,r);if(l[n]||o(n))continue;let a=1;for(let s=e.indexOf(n,i+r);s>=0;++a)s=e.indexOf(n,s+r);a>1&&(l[n]=a)}for(;;){let i;for(;n--&&e.includes(r[n]););if(n<0)break;let o=r[n],c=0,h=s(o);for(let e in l){let r=l[e],n=(r-1)*s(e)-(r+1)*h;a.length||(n-=s("\x01")),n<=0?delete l[e]:n>c&&(i=e,c=n)}if(!i)break;e=e.split(i).join(o)+o+i,a=o+a;let u={};for(let r in l){let n=r.split(i).join(o),a=0;for(let i=e.indexOf(n);i>=0;++a)i=e.indexOf(n,i+n.length);a>1&&(u[n]=a)}l=u}return{a:e,b:a}})(e=a(e=e.replace(RegExp("\x01","g"),"")),r),s=n.a;return n.b.length&&(s+="\x01"+n.b),s+="_"},uncrush:e=>{let i=(e=e.substring(0,e.length-1)).split("\x01"),r=i[0];if(i.length>1)for(let e of i[1]){let i=r.split(e);r=i.join(i.pop())}return a(r,0)}},a=(e,i=1)=>{let r=[['"',"'"],["':","!"],[",'","~"],["}",")","\\","\\"],["{","(","\\","\\"]],n=(e,i)=>{let r=RegExp(`${(i[2]?i[2]:"")+i[0]}|${(i[3]?i[3]:"")+i[1]}`,"g");return e.replace(r,e=>e===i[0]?i[1]:i[0])};if(i)for(let i=0;i<r.length;++i)e=n(e,r[i]);else for(let i=r.length;i--;)e=n(e,r[i]);return e}},"./node_modules/three/build/three.core.js"(e,i,r){"use strict";let n,a,s,o,l,c,h,u;r.d(i,{$EB:()=>M,$Kf:()=>nz,$Yl:()=>X,$_I:()=>eA,$ei:()=>L,$p8:()=>sb,A$4:()=>rj,AQS:()=>tX,Am1:()=>sR,B69:()=>r_,BH$:()=>au,BKk:()=>np,BVL:()=>e9,BXX:()=>e0,B_h:()=>tr,CSG:()=>aY,CVz:()=>e5,CWW:()=>tS,Cfg:()=>eT,D$Q:()=>aW,DXC:()=>ac,Dmk:()=>ez,E0M:()=>s4,EAD:()=>nG,EZo:()=>T,EdD:()=>w,FCc:()=>ah,FFZ:()=>tH,FV:()=>ec,FXf:()=>C,Fn:()=>tg,FvD:()=>a_,GJx:()=>ex,GOR:()=>ax,GWd:()=>eG,GYF:()=>nk,Gc6:()=>aM,Gwm:()=>$,H23:()=>tv,HIg:()=>eH,HO_:()=>tM,HXV:()=>e2,HgN:()=>ig,HiM:()=>sx,Hit:()=>a6,Ho_:()=>aT,I46:()=>nB,I9Y:()=>ii,IE4:()=>eZ,IUQ:()=>ib,Iit:()=>nl,Jnc:()=>m,K52:()=>ee,KDk:()=>e8,KLL:()=>tU,KRh:()=>er,Kef:()=>tx,Kwu:()=>E,Kzg:()=>sw,LAk:()=>eu,LiQ:()=>O,LlO:()=>nh,LoY:()=>r3,MBL:()=>a9,MW4:()=>rq,Mjd:()=>eo,N1A:()=>aa,NRn:()=>iR,NTi:()=>b,Nex:()=>s5,Nt7:()=>k,Nwf:()=>sW,Nz6:()=>eQ,O49:()=>tw,O9p:()=>rt,ONl:()=>ag,OUM:()=>eR,Om:()=>e_,OtU:()=>te,OuU:()=>B,PJ3:()=>tT,PPD:()=>n6,PTz:()=>ir,Pf$:()=>sO,Pq0:()=>ia,Q1f:()=>rF,QP0:()=>g,Qev:()=>t0,Qrf:()=>ts,R3r:()=>nT,R8M:()=>tJ,RJ4:()=>tE,RQf:()=>eU,RiT:()=>se,Riy:()=>e6,Rm2:()=>tK,RrE:()=>W,RyA:()=>_,S$4:()=>tm,THS:()=>rX,Tap:()=>sh,TdN:()=>tW,TiK:()=>tB,TkQ:()=>eK,U3G:()=>Q,UtX:()=>sA,V3x:()=>eB,V9B:()=>rV,VCu:()=>ay,VT0:()=>ej,Vb5:()=>f,VxR:()=>tD,W9U:()=>t_,WBB:()=>aH,WNZ:()=>p,Wdf:()=>tG,Wew:()=>eO,Wk7:()=>v,XG_:()=>ty,XIg:()=>S,XrR:()=>en,Y9S:()=>so,YJl:()=>nS,Yuy:()=>eL,Z58:()=>nE,ZLX:()=>nQ,ZQM:()=>eq,Zcv:()=>n3,Zr2:()=>tL,ZyN:()=>sS,_4j:()=>aX,_QJ:()=>tc,_Ut:()=>nc,a55:()=>t4,a5J:()=>tl,aEY:()=>H,aHM:()=>sn,aJ8:()=>ed,aVO:()=>aK,amv:()=>tN,b4q:()=>ny,bC7:()=>td,bCz:()=>A,bI3:()=>tR,bdM:()=>aG,bkx:()=>eD,brA:()=>J,bw0:()=>et,c90:()=>eJ,cHt:()=>eI,cZY:()=>s3,caT:()=>ei,cj9:()=>it,czI:()=>tn,dYF:()=>iA,dcC:()=>eX,dwI:()=>il,e0p:()=>j,eB$:()=>nw,eHc:()=>Y,eHs:()=>nR,eaF:()=>nn,eoi:()=>tz,er$:()=>tI,f4X:()=>N,fBL:()=>eP,fP5:()=>sF,g7M:()=>eh,gJ2:()=>eF,gO9:()=>R,gPd:()=>iS,gWB:()=>tV,gZr:()=>e7,ghU:()=>ey,hB5:()=>x,hdd:()=>z,hgQ:()=>G,hsX:()=>y,hxR:()=>eS,hy7:()=>ef,iNn:()=>ns,ie2:()=>F,imn:()=>rk,ix0:()=>eN,iyt:()=>ij,jR7:()=>e$,jSS:()=>tt,jej:()=>t$,jf0:()=>tP,jzd:()=>tk,k6Q:()=>e1,k6q:()=>eE,kLi:()=>i_,kO0:()=>tF,kRr:()=>ew,kTW:()=>eM,kTp:()=>e3,kn4:()=>i1,kyO:()=>es,lGu:()=>K,lGw:()=>a$,lPF:()=>tq,ljd:()=>tb,lxW:()=>no,lyL:()=>tu,mcG:()=>tQ,mrM:()=>n8,nCl:()=>sv,nNL:()=>el,nST:()=>P,nWS:()=>iE,nZQ:()=>sC,o6l:()=>nM,ojh:()=>D,ojs:()=>tf,ov9:()=>q,pBf:()=>e4,pHI:()=>eb,paN:()=>eY,ppV:()=>id,psI:()=>to,qUd:()=>sy,qa3:()=>ti,qad:()=>U,qq$:()=>tj,qtW:()=>rY,r6x:()=>sT,rFo:()=>iw,rSH:()=>ta,rYR:()=>tA,rjZ:()=>aS,sPf:()=>d,tBo:()=>sj,tJf:()=>eC,tXL:()=>aq,tcD:()=>ab,tz3:()=>st,uB5:()=>th,uSd:()=>aj,uV5:()=>ev,uWO:()=>nW,ubm:()=>n_,vim:()=>tO,vyJ:()=>tC,wfO:()=>eg,wn6:()=>V,wrO:()=>eV,xFO:()=>em,xSv:()=>Z,y3Z:()=>tp,yT7:()=>ek,y_p:()=>ea,z3S:()=>tZ,zdS:()=>eW,zgK:()=>ri,znC:()=>I});let d="182",p=0,f=1,m=2,g=1,v=2,_=3,x=0,y=1,M=2,S=0,b=1,T=2,E=3,w=4,A=5,R=100,C=101,P=102,I=103,L=104,D=200,U=201,N=202,O=203,F=204,B=205,z=206,k=207,V=208,H=209,G=210,W=211,X=212,j=213,q=214,Y=0,K=1,J=2,Z=3,Q=4,$=5,ee=6,et=7,ei=0,er=1,en=2,ea=0,es=1,eo=2,el=3,ec=4,eh=5,eu=6,ed=7,ep="attached",ef=301,em=302,eg=303,ev=304,e_=306,ex=1e3,ey=1001,eM=1002,eS=1003,eb=1004,eT=1005,eE=1006,ew=1007,eA=1008,eR=1009,eC=1010,eP=1011,eI=1012,eL=1013,eD=1014,eU=1015,eN=1016,eO=1017,eF=1018,eB=1020,ez=35902,ek=35899,eV=1021,eH=1022,eG=1023,eW=1026,eX=1027,ej=1028,eq=1029,eY=1030,eK=1031,eJ=1033,eZ=33776,eQ=33777,e$=33778,e0=33779,e1=35840,e3=35841,e2=35842,e4=35843,e5=36196,e6=37492,e8=37496,e9=37488,e7=37489,te=37490,tt=37491,ti=37808,tr=37809,tn=37810,ta=37811,ts=37812,to=37813,tl=37814,tc=37815,th=37816,tu=37817,td=37818,tp=37819,tf=37820,tm=37821,tg=36492,tv=36494,t_=36495,tx=36283,ty=36284,tM=36285,tS=36286,tb=2300,tT=2301,tE=0,tw=1,tA=2,tR=0,tC=1,tP="",tI="srgb",tL="srgb-linear",tD="linear",tU="srgb",tN=512,tO=513,tF=514,tB=515,tz=516,tk=517,tV=518,tH=519,tG="300 es",tW=2e3;function tX(e){for(let i=e.length-1;i>=0;--i)if(e[i]>=65535)return!0;return!1}function tj(e){return document.createElementNS("http://www.w3.org/1999/xhtml",e)}function tq(){let e=tj("canvas");return e.style.display="block",e}Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array;let tY={};function tK(...e){console.log("THREE."+e.shift(),...e)}function tJ(...e){console.warn("THREE."+e.shift(),...e)}function tZ(...e){console.error("THREE."+e.shift(),...e)}function tQ(...e){let i=e.join(" ");i in tY||(tY[i]=!0,tJ(...e))}function t$(e,i,r){return new Promise(function(n,a){setTimeout(function s(){switch(e.clientWaitSync(i,e.SYNC_FLUSH_COMMANDS_BIT,0)){case e.WAIT_FAILED:a();break;case e.TIMEOUT_EXPIRED:setTimeout(s,r);break;default:n()}},r)})}class t0{addEventListener(e,i){void 0===this._listeners&&(this._listeners={});let r=this._listeners;void 0===r[e]&&(r[e]=[]),-1===r[e].indexOf(i)&&r[e].push(i)}hasEventListener(e,i){let r=this._listeners;return void 0!==r&&void 0!==r[e]&&-1!==r[e].indexOf(i)}removeEventListener(e,i){let r=this._listeners;if(void 0===r)return;let n=r[e];if(void 0!==n){let e=n.indexOf(i);-1!==e&&n.splice(e,1)}}dispatchEvent(e){let i=this._listeners;if(void 0===i)return;let r=i[e.type];if(void 0!==r){e.target=this;let i=r.slice(0);for(let r=0,n=i.length;r<n;r++)i[r].call(this,e);e.target=null}}}let t1=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"],t3=1234567,t2=Math.PI/180,t4=180/Math.PI;function t5(){let e=0xffffffff*Math.random()|0,i=0xffffffff*Math.random()|0,r=0xffffffff*Math.random()|0,n=0xffffffff*Math.random()|0;return(t1[255&e]+t1[e>>8&255]+t1[e>>16&255]+t1[e>>24&255]+"-"+t1[255&i]+t1[i>>8&255]+"-"+t1[i>>16&15|64]+t1[i>>24&255]+"-"+t1[63&r|128]+t1[r>>8&255]+"-"+t1[r>>16&255]+t1[r>>24&255]+t1[255&n]+t1[n>>8&255]+t1[n>>16&255]+t1[n>>24&255]).toLowerCase()}function t6(e,i,r){return Math.max(i,Math.min(r,e))}function t8(e,i){return(e%i+i)%i}function t9(e,i,r){return(1-r)*e+r*i}function t7(e,i){switch(i.constructor){case Float32Array:return e;case Uint32Array:return e/0xffffffff;case Uint16Array:return e/65535;case Uint8Array:return e/255;case Int32Array:return Math.max(e/0x7fffffff,-1);case Int16Array:return Math.max(e/32767,-1);case Int8Array:return Math.max(e/127,-1);default:throw Error("Invalid component type.")}}function ie(e,i){switch(i.constructor){case Float32Array:return e;case Uint32Array:return Math.round(0xffffffff*e);case Uint16Array:return Math.round(65535*e);case Uint8Array:return Math.round(255*e);case Int32Array:return Math.round(0x7fffffff*e);case Int16Array:return Math.round(32767*e);case Int8Array:return Math.round(127*e);default:throw Error("Invalid component type.")}}let it={DEG2RAD:t2,RAD2DEG:t4,generateUUID:t5,clamp:t6,euclideanModulo:t8,mapLinear:function(e,i,r,n,a){return n+(e-i)*(a-n)/(r-i)},inverseLerp:function(e,i,r){return e!==i?(r-e)/(i-e):0},lerp:t9,damp:function(e,i,r,n){return t9(e,i,1-Math.exp(-r*n))},pingpong:function(e,i=1){return i-Math.abs(t8(e,2*i)-i)},smoothstep:function(e,i,r){return e<=i?0:e>=r?1:(e=(e-i)/(r-i))*e*(3-2*e)},smootherstep:function(e,i,r){return e<=i?0:e>=r?1:(e=(e-i)/(r-i))*e*e*(e*(6*e-15)+10)},randInt:function(e,i){return e+Math.floor(Math.random()*(i-e+1))},randFloat:function(e,i){return e+Math.random()*(i-e)},randFloatSpread:function(e){return e*(.5-Math.random())},seededRandom:function(e){void 0!==e&&(t3=e);let i=t3+=0x6d2b79f5;return i=Math.imul(i^i>>>15,1|i),(((i^=i+Math.imul(i^i>>>7,61|i))^i>>>14)>>>0)/0x100000000},degToRad:function(e){return e*t2},radToDeg:function(e){return e*t4},isPowerOfTwo:function(e){return(e&e-1)==0&&0!==e},ceilPowerOfTwo:function(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))},floorPowerOfTwo:function(e){return Math.pow(2,Math.floor(Math.log(e)/Math.LN2))},setQuaternionFromProperEuler:function(e,i,r,n,a){let s=Math.cos,o=Math.sin,l=s(r/2),c=o(r/2),h=s((i+n)/2),u=o((i+n)/2),d=s((i-n)/2),p=o((i-n)/2),f=s((n-i)/2),m=o((n-i)/2);switch(a){case"XYX":e.set(l*u,c*d,c*p,l*h);break;case"YZY":e.set(c*p,l*u,c*d,l*h);break;case"ZXZ":e.set(c*d,c*p,l*u,l*h);break;case"XZX":e.set(l*u,c*m,c*f,l*h);break;case"YXY":e.set(c*f,l*u,c*m,l*h);break;case"ZYZ":e.set(c*m,c*f,l*u,l*h);break;default:tJ("MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+a)}},normalize:ie,denormalize:t7};class ii{constructor(e=0,i=0){ii.prototype.isVector2=!0,this.x=e,this.y=i}get width(){return this.x}set width(e){this.x=e}get height(){return this.y}set height(e){this.y=e}set(e,i){return this.x=e,this.y=i,this}setScalar(e){return this.x=e,this.y=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setComponent(e,i){switch(e){case 0:this.x=i;break;case 1:this.y=i;break;default:throw Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}add(e){return this.x+=e.x,this.y+=e.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addVectors(e,i){return this.x=e.x+i.x,this.y=e.y+i.y,this}addScaledVector(e,i){return this.x+=e.x*i,this.y+=e.y*i,this}sub(e){return this.x-=e.x,this.y-=e.y,this}subScalar(e){return this.x-=e,this.y-=e,this}subVectors(e,i){return this.x=e.x-i.x,this.y=e.y-i.y,this}multiply(e){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e){return this.x*=e,this.y*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this}divideScalar(e){return this.multiplyScalar(1/e)}applyMatrix3(e){let i=this.x,r=this.y,n=e.elements;return this.x=n[0]*i+n[3]*r+n[6],this.y=n[1]*i+n[4]*r+n[7],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}clamp(e,i){return this.x=t6(this.x,e.x,i.x),this.y=t6(this.y,e.y,i.y),this}clampScalar(e,i){return this.x=t6(this.x,e,i),this.y=t6(this.y,e,i),this}clampLength(e,i){let r=this.length();return this.divideScalar(r||1).multiplyScalar(t6(r,e,i))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(e){let i=Math.sqrt(this.lengthSq()*e.lengthSq());return 0===i?Math.PI/2:Math.acos(t6(this.dot(e)/i,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){let i=this.x-e.x,r=this.y-e.y;return i*i+r*r}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,i){return this.x+=(e.x-this.x)*i,this.y+=(e.y-this.y)*i,this}lerpVectors(e,i,r){return this.x=e.x+(i.x-e.x)*r,this.y=e.y+(i.y-e.y)*r,this}equals(e){return e.x===this.x&&e.y===this.y}fromArray(e,i=0){return this.x=e[i],this.y=e[i+1],this}toArray(e=[],i=0){return e[i]=this.x,e[i+1]=this.y,e}fromBufferAttribute(e,i){return this.x=e.getX(i),this.y=e.getY(i),this}rotateAround(e,i){let r=Math.cos(i),n=Math.sin(i),a=this.x-e.x,s=this.y-e.y;return this.x=a*r-s*n+e.x,this.y=a*n+s*r+e.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class ir{constructor(e=0,i=0,r=0,n=1){this.isQuaternion=!0,this._x=e,this._y=i,this._z=r,this._w=n}static slerpFlat(e,i,r,n,a,s,o){let l=r[n+0],c=r[n+1],h=r[n+2],u=r[n+3],d=a[s+0],p=a[s+1],f=a[s+2],m=a[s+3];if(o<=0){e[i+0]=l,e[i+1]=c,e[i+2]=h,e[i+3]=u;return}if(o>=1){e[i+0]=d,e[i+1]=p,e[i+2]=f,e[i+3]=m;return}if(u!==m||l!==d||c!==p||h!==f){let e=l*d+c*p+h*f+u*m;e<0&&(d=-d,p=-p,f=-f,m=-m,e=-e);let i=1-o;if(e<.9995){let r=Math.acos(e),n=Math.sin(r);l=l*(i=Math.sin(i*r)/n)+d*(o=Math.sin(o*r)/n),c=c*i+p*o,h=h*i+f*o,u=u*i+m*o}else{let e=1/Math.sqrt((l=l*i+d*o)*l+(c=c*i+p*o)*c+(h=h*i+f*o)*h+(u=u*i+m*o)*u);l*=e,c*=e,h*=e,u*=e}}e[i]=l,e[i+1]=c,e[i+2]=h,e[i+3]=u}static multiplyQuaternionsFlat(e,i,r,n,a,s){let o=r[n],l=r[n+1],c=r[n+2],h=r[n+3],u=a[s],d=a[s+1],p=a[s+2],f=a[s+3];return e[i]=o*f+h*u+l*p-c*d,e[i+1]=l*f+h*d+c*u-o*p,e[i+2]=c*f+h*p+o*d-l*u,e[i+3]=h*f-o*u-l*d-c*p,e}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get w(){return this._w}set w(e){this._w=e,this._onChangeCallback()}set(e,i,r,n){return this._x=e,this._y=i,this._z=r,this._w=n,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onChangeCallback(),this}setFromEuler(e,i=!0){let r=e._x,n=e._y,a=e._z,s=e._order,o=Math.cos,l=Math.sin,c=o(r/2),h=o(n/2),u=o(a/2),d=l(r/2),p=l(n/2),f=l(a/2);switch(s){case"XYZ":this._x=d*h*u+c*p*f,this._y=c*p*u-d*h*f,this._z=c*h*f+d*p*u,this._w=c*h*u-d*p*f;break;case"YXZ":this._x=d*h*u+c*p*f,this._y=c*p*u-d*h*f,this._z=c*h*f-d*p*u,this._w=c*h*u+d*p*f;break;case"ZXY":this._x=d*h*u-c*p*f,this._y=c*p*u+d*h*f,this._z=c*h*f+d*p*u,this._w=c*h*u-d*p*f;break;case"ZYX":this._x=d*h*u-c*p*f,this._y=c*p*u+d*h*f,this._z=c*h*f-d*p*u,this._w=c*h*u+d*p*f;break;case"YZX":this._x=d*h*u+c*p*f,this._y=c*p*u+d*h*f,this._z=c*h*f-d*p*u,this._w=c*h*u-d*p*f;break;case"XZY":this._x=d*h*u-c*p*f,this._y=c*p*u-d*h*f,this._z=c*h*f+d*p*u,this._w=c*h*u+d*p*f;break;default:tJ("Quaternion: .setFromEuler() encountered an unknown order: "+s)}return!0===i&&this._onChangeCallback(),this}setFromAxisAngle(e,i){let r=i/2,n=Math.sin(r);return this._x=e.x*n,this._y=e.y*n,this._z=e.z*n,this._w=Math.cos(r),this._onChangeCallback(),this}setFromRotationMatrix(e){let i=e.elements,r=i[0],n=i[4],a=i[8],s=i[1],o=i[5],l=i[9],c=i[2],h=i[6],u=i[10],d=r+o+u;if(d>0){let e=.5/Math.sqrt(d+1);this._w=.25/e,this._x=(h-l)*e,this._y=(a-c)*e,this._z=(s-n)*e}else if(r>o&&r>u){let e=2*Math.sqrt(1+r-o-u);this._w=(h-l)/e,this._x=.25*e,this._y=(n+s)/e,this._z=(a+c)/e}else if(o>u){let e=2*Math.sqrt(1+o-r-u);this._w=(a-c)/e,this._x=(n+s)/e,this._y=.25*e,this._z=(l+h)/e}else{let e=2*Math.sqrt(1+u-r-o);this._w=(s-n)/e,this._x=(a+c)/e,this._y=(l+h)/e,this._z=.25*e}return this._onChangeCallback(),this}setFromUnitVectors(e,i){let r=e.dot(i)+1;return r<1e-8?(r=0,Math.abs(e.x)>Math.abs(e.z)?(this._x=-e.y,this._y=e.x,this._z=0):(this._x=0,this._y=-e.z,this._z=e.y)):(this._x=e.y*i.z-e.z*i.y,this._y=e.z*i.x-e.x*i.z,this._z=e.x*i.y-e.y*i.x),this._w=r,this.normalize()}angleTo(e){return 2*Math.acos(Math.abs(t6(this.dot(e),-1,1)))}rotateTowards(e,i){let r=this.angleTo(e);if(0===r)return this;let n=Math.min(1,i/r);return this.slerp(e,n),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this._onChangeCallback(),this}multiply(e){return this.multiplyQuaternions(this,e)}premultiply(e){return this.multiplyQuaternions(e,this)}multiplyQuaternions(e,i){let r=e._x,n=e._y,a=e._z,s=e._w,o=i._x,l=i._y,c=i._z,h=i._w;return this._x=r*h+s*o+n*c-a*l,this._y=n*h+s*l+a*o-r*c,this._z=a*h+s*c+r*l-n*o,this._w=s*h-r*o-n*l-a*c,this._onChangeCallback(),this}slerp(e,i){if(i<=0)return this;if(i>=1)return this.copy(e);let r=e._x,n=e._y,a=e._z,s=e._w,o=this.dot(e);o<0&&(r=-r,n=-n,a=-a,s=-s,o=-o);let l=1-i;if(o<.9995){let e=Math.acos(o),c=Math.sin(e);l=Math.sin(l*e)/c,i=Math.sin(i*e)/c,this._x=this._x*l+r*i,this._y=this._y*l+n*i,this._z=this._z*l+a*i,this._w=this._w*l+s*i,this._onChangeCallback()}else this._x=this._x*l+r*i,this._y=this._y*l+n*i,this._z=this._z*l+a*i,this._w=this._w*l+s*i,this.normalize();return this}slerpQuaternions(e,i,r){return this.copy(e).slerp(i,r)}random(){let e=2*Math.PI*Math.random(),i=2*Math.PI*Math.random(),r=Math.random(),n=Math.sqrt(1-r),a=Math.sqrt(r);return this.set(n*Math.sin(e),n*Math.cos(e),a*Math.sin(i),a*Math.cos(i))}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w}fromArray(e,i=0){return this._x=e[i],this._y=e[i+1],this._z=e[i+2],this._w=e[i+3],this._onChangeCallback(),this}toArray(e=[],i=0){return e[i]=this._x,e[i+1]=this._y,e[i+2]=this._z,e[i+3]=this._w,e}fromBufferAttribute(e,i){return this._x=e.getX(i),this._y=e.getY(i),this._z=e.getZ(i),this._w=e.getW(i),this._onChangeCallback(),this}toJSON(){return this.toArray()}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class ia{constructor(e=0,i=0,r=0){ia.prototype.isVector3=!0,this.x=e,this.y=i,this.z=r}set(e,i,r){return void 0===r&&(r=this.z),this.x=e,this.y=i,this.z=r,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,i){switch(e){case 0:this.x=i;break;case 1:this.y=i;break;case 2:this.z=i;break;default:throw Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,i){return this.x=e.x+i.x,this.y=e.y+i.y,this.z=e.z+i.z,this}addScaledVector(e,i){return this.x+=e.x*i,this.y+=e.y*i,this.z+=e.z*i,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,i){return this.x=e.x-i.x,this.y=e.y-i.y,this.z=e.z-i.z,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,i){return this.x=e.x*i.x,this.y=e.y*i.y,this.z=e.z*i.z,this}applyEuler(e){return this.applyQuaternion(io.setFromEuler(e))}applyAxisAngle(e,i){return this.applyQuaternion(io.setFromAxisAngle(e,i))}applyMatrix3(e){let i=this.x,r=this.y,n=this.z,a=e.elements;return this.x=a[0]*i+a[3]*r+a[6]*n,this.y=a[1]*i+a[4]*r+a[7]*n,this.z=a[2]*i+a[5]*r+a[8]*n,this}applyNormalMatrix(e){return this.applyMatrix3(e).normalize()}applyMatrix4(e){let i=this.x,r=this.y,n=this.z,a=e.elements,s=1/(a[3]*i+a[7]*r+a[11]*n+a[15]);return this.x=(a[0]*i+a[4]*r+a[8]*n+a[12])*s,this.y=(a[1]*i+a[5]*r+a[9]*n+a[13])*s,this.z=(a[2]*i+a[6]*r+a[10]*n+a[14])*s,this}applyQuaternion(e){let i=this.x,r=this.y,n=this.z,a=e.x,s=e.y,o=e.z,l=e.w,c=2*(s*n-o*r),h=2*(o*i-a*n),u=2*(a*r-s*i);return this.x=i+l*c+s*u-o*h,this.y=r+l*h+o*c-a*u,this.z=n+l*u+a*h-s*c,this}project(e){return this.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix)}unproject(e){return this.applyMatrix4(e.projectionMatrixInverse).applyMatrix4(e.matrixWorld)}transformDirection(e){let i=this.x,r=this.y,n=this.z,a=e.elements;return this.x=a[0]*i+a[4]*r+a[8]*n,this.y=a[1]*i+a[5]*r+a[9]*n,this.z=a[2]*i+a[6]*r+a[10]*n,this.normalize()}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}clamp(e,i){return this.x=t6(this.x,e.x,i.x),this.y=t6(this.y,e.y,i.y),this.z=t6(this.z,e.z,i.z),this}clampScalar(e,i){return this.x=t6(this.x,e,i),this.y=t6(this.y,e,i),this.z=t6(this.z,e,i),this}clampLength(e,i){let r=this.length();return this.divideScalar(r||1).multiplyScalar(t6(r,e,i))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,i){return this.x+=(e.x-this.x)*i,this.y+=(e.y-this.y)*i,this.z+=(e.z-this.z)*i,this}lerpVectors(e,i,r){return this.x=e.x+(i.x-e.x)*r,this.y=e.y+(i.y-e.y)*r,this.z=e.z+(i.z-e.z)*r,this}cross(e){return this.crossVectors(this,e)}crossVectors(e,i){let r=e.x,n=e.y,a=e.z,s=i.x,o=i.y,l=i.z;return this.x=n*l-a*o,this.y=a*s-r*l,this.z=r*o-n*s,this}projectOnVector(e){let i=e.lengthSq();if(0===i)return this.set(0,0,0);let r=e.dot(this)/i;return this.copy(e).multiplyScalar(r)}projectOnPlane(e){return is.copy(this).projectOnVector(e),this.sub(is)}reflect(e){return this.sub(is.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){let i=Math.sqrt(this.lengthSq()*e.lengthSq());return 0===i?Math.PI/2:Math.acos(t6(this.dot(e)/i,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){let i=this.x-e.x,r=this.y-e.y,n=this.z-e.z;return i*i+r*r+n*n}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)}setFromSpherical(e){return this.setFromSphericalCoords(e.radius,e.phi,e.theta)}setFromSphericalCoords(e,i,r){let n=Math.sin(i)*e;return this.x=n*Math.sin(r),this.y=Math.cos(i)*e,this.z=n*Math.cos(r),this}setFromCylindrical(e){return this.setFromCylindricalCoords(e.radius,e.theta,e.y)}setFromCylindricalCoords(e,i,r){return this.x=e*Math.sin(i),this.y=r,this.z=e*Math.cos(i),this}setFromMatrixPosition(e){let i=e.elements;return this.x=i[12],this.y=i[13],this.z=i[14],this}setFromMatrixScale(e){let i=this.setFromMatrixColumn(e,0).length(),r=this.setFromMatrixColumn(e,1).length(),n=this.setFromMatrixColumn(e,2).length();return this.x=i,this.y=r,this.z=n,this}setFromMatrixColumn(e,i){return this.fromArray(e.elements,4*i)}setFromMatrix3Column(e,i){return this.fromArray(e.elements,3*i)}setFromEuler(e){return this.x=e._x,this.y=e._y,this.z=e._z,this}setFromColor(e){return this.x=e.r,this.y=e.g,this.z=e.b,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,i=0){return this.x=e[i],this.y=e[i+1],this.z=e[i+2],this}toArray(e=[],i=0){return e[i]=this.x,e[i+1]=this.y,e[i+2]=this.z,e}fromBufferAttribute(e,i){return this.x=e.getX(i),this.y=e.getY(i),this.z=e.getZ(i),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){let e=Math.random()*Math.PI*2,i=2*Math.random()-1,r=Math.sqrt(1-i*i);return this.x=r*Math.cos(e),this.y=i,this.z=r*Math.sin(e),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}let is=new ia,io=new ir;class il{constructor(e,i,r,n,a,s,o,l,c){il.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],void 0!==e&&this.set(e,i,r,n,a,s,o,l,c)}set(e,i,r,n,a,s,o,l,c){let h=this.elements;return h[0]=e,h[1]=n,h[2]=o,h[3]=i,h[4]=a,h[5]=l,h[6]=r,h[7]=s,h[8]=c,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(e){let i=this.elements,r=e.elements;return i[0]=r[0],i[1]=r[1],i[2]=r[2],i[3]=r[3],i[4]=r[4],i[5]=r[5],i[6]=r[6],i[7]=r[7],i[8]=r[8],this}extractBasis(e,i,r){return e.setFromMatrix3Column(this,0),i.setFromMatrix3Column(this,1),r.setFromMatrix3Column(this,2),this}setFromMatrix4(e){let i=e.elements;return this.set(i[0],i[4],i[8],i[1],i[5],i[9],i[2],i[6],i[10]),this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,i){let r=e.elements,n=i.elements,a=this.elements,s=r[0],o=r[3],l=r[6],c=r[1],h=r[4],u=r[7],d=r[2],p=r[5],f=r[8],m=n[0],g=n[3],v=n[6],_=n[1],x=n[4],y=n[7],M=n[2],S=n[5],b=n[8];return a[0]=s*m+o*_+l*M,a[3]=s*g+o*x+l*S,a[6]=s*v+o*y+l*b,a[1]=c*m+h*_+u*M,a[4]=c*g+h*x+u*S,a[7]=c*v+h*y+u*b,a[2]=d*m+p*_+f*M,a[5]=d*g+p*x+f*S,a[8]=d*v+p*y+f*b,this}multiplyScalar(e){let i=this.elements;return i[0]*=e,i[3]*=e,i[6]*=e,i[1]*=e,i[4]*=e,i[7]*=e,i[2]*=e,i[5]*=e,i[8]*=e,this}determinant(){let e=this.elements,i=e[0],r=e[1],n=e[2],a=e[3],s=e[4],o=e[5],l=e[6],c=e[7],h=e[8];return i*s*h-i*o*c-r*a*h+r*o*l+n*a*c-n*s*l}invert(){let e=this.elements,i=e[0],r=e[1],n=e[2],a=e[3],s=e[4],o=e[5],l=e[6],c=e[7],h=e[8],u=h*s-o*c,d=o*l-h*a,p=c*a-s*l,f=i*u+r*d+n*p;if(0===f)return this.set(0,0,0,0,0,0,0,0,0);let m=1/f;return e[0]=u*m,e[1]=(n*c-h*r)*m,e[2]=(o*r-n*s)*m,e[3]=d*m,e[4]=(h*i-n*l)*m,e[5]=(n*a-o*i)*m,e[6]=p*m,e[7]=(r*l-c*i)*m,e[8]=(s*i-r*a)*m,this}transpose(){let e,i=this.elements;return e=i[1],i[1]=i[3],i[3]=e,e=i[2],i[2]=i[6],i[6]=e,e=i[5],i[5]=i[7],i[7]=e,this}getNormalMatrix(e){return this.setFromMatrix4(e).invert().transpose()}transposeIntoArray(e){let i=this.elements;return e[0]=i[0],e[1]=i[3],e[2]=i[6],e[3]=i[1],e[4]=i[4],e[5]=i[7],e[6]=i[2],e[7]=i[5],e[8]=i[8],this}setUvTransform(e,i,r,n,a,s,o){let l=Math.cos(a),c=Math.sin(a);return this.set(r*l,r*c,-r*(l*s+c*o)+s+e,-n*c,n*l,-n*(-c*s+l*o)+o+i,0,0,1),this}scale(e,i){return this.premultiply(ic.makeScale(e,i)),this}rotate(e){return this.premultiply(ic.makeRotation(-e)),this}translate(e,i){return this.premultiply(ic.makeTranslation(e,i)),this}makeTranslation(e,i){return e.isVector2?this.set(1,0,e.x,0,1,e.y,0,0,1):this.set(1,0,e,0,1,i,0,0,1),this}makeRotation(e){let i=Math.cos(e),r=Math.sin(e);return this.set(i,-r,0,r,i,0,0,0,1),this}makeScale(e,i){return this.set(e,0,0,0,i,0,0,0,1),this}equals(e){let i=this.elements,r=e.elements;for(let e=0;e<9;e++)if(i[e]!==r[e])return!1;return!0}fromArray(e,i=0){for(let r=0;r<9;r++)this.elements[r]=e[r+i];return this}toArray(e=[],i=0){let r=this.elements;return e[i]=r[0],e[i+1]=r[1],e[i+2]=r[2],e[i+3]=r[3],e[i+4]=r[4],e[i+5]=r[5],e[i+6]=r[6],e[i+7]=r[7],e[i+8]=r[8],e}clone(){return new this.constructor().fromArray(this.elements)}}let ic=new il,ih=new il().set(.4123908,.3575843,.1804808,.212639,.7151687,.0721923,.0193308,.1191948,.9505322),iu=new il().set(3.2409699,-1.5373832,-.4986108,-.9692436,1.8759675,.0415551,.0556301,-.203977,1.0569715),id=(c=[.64,.33,.3,.6,.15,.06],h=[.2126,.7152,.0722],u=[.3127,.329],(l={enabled:!0,workingColorSpace:tL,spaces:{},convert:function(e,i,r){return!1!==this.enabled&&i!==r&&i&&r&&(this.spaces[i].transfer===tU&&(e.r=ip(e.r),e.g=ip(e.g),e.b=ip(e.b)),this.spaces[i].primaries!==this.spaces[r].primaries&&(e.applyMatrix3(this.spaces[i].toXYZ),e.applyMatrix3(this.spaces[r].fromXYZ)),this.spaces[r].transfer===tU&&(e.r=im(e.r),e.g=im(e.g),e.b=im(e.b))),e},workingToColorSpace:function(e,i){return this.convert(e,this.workingColorSpace,i)},colorSpaceToWorking:function(e,i){return this.convert(e,i,this.workingColorSpace)},getPrimaries:function(e){return this.spaces[e].primaries},getTransfer:function(e){return e===tP?tD:this.spaces[e].transfer},getToneMappingMode:function(e){return this.spaces[e].outputColorSpaceConfig.toneMappingMode||"standard"},getLuminanceCoefficients:function(e,i=this.workingColorSpace){return e.fromArray(this.spaces[i].luminanceCoefficients)},define:function(e){Object.assign(this.spaces,e)},_getMatrix:function(e,i,r){return e.copy(this.spaces[i].toXYZ).multiply(this.spaces[r].fromXYZ)},_getDrawingBufferColorSpace:function(e){return this.spaces[e].outputColorSpaceConfig.drawingBufferColorSpace},_getUnpackColorSpace:function(e=this.workingColorSpace){return this.spaces[e].workingColorSpaceConfig.unpackColorSpace},fromWorkingColorSpace:function(e,i){return tQ("ColorManagement: .fromWorkingColorSpace() has been renamed to .workingToColorSpace()."),l.workingToColorSpace(e,i)},toWorkingColorSpace:function(e,i){return tQ("ColorManagement: .toWorkingColorSpace() has been renamed to .colorSpaceToWorking()."),l.colorSpaceToWorking(e,i)}}).define({[tL]:{primaries:c,whitePoint:u,transfer:tD,toXYZ:ih,fromXYZ:iu,luminanceCoefficients:h,workingColorSpaceConfig:{unpackColorSpace:tI},outputColorSpaceConfig:{drawingBufferColorSpace:tI}},[tI]:{primaries:c,whitePoint:u,transfer:tU,toXYZ:ih,fromXYZ:iu,luminanceCoefficients:h,outputColorSpaceConfig:{drawingBufferColorSpace:tI}}}),l);function ip(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}function im(e){return e<.0031308?12.92*e:1.055*Math.pow(e,.41666)-.055}class ig{static getDataURL(e,i="image/png"){let r;if(/^data:/i.test(e.src)||"u"<typeof HTMLCanvasElement)return e.src;if(e instanceof HTMLCanvasElement)r=e;else{void 0===n&&(n=tj("canvas")),n.width=e.width,n.height=e.height;let i=n.getContext("2d");e instanceof ImageData?i.putImageData(e,0,0):i.drawImage(e,0,0,e.width,e.height),r=n}return r.toDataURL(i)}static sRGBToLinear(e){if("u">typeof HTMLImageElement&&e instanceof HTMLImageElement||"u">typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"u">typeof ImageBitmap&&e instanceof ImageBitmap){let i=tj("canvas");i.width=e.width,i.height=e.height;let r=i.getContext("2d");r.drawImage(e,0,0,e.width,e.height);let n=r.getImageData(0,0,e.width,e.height),a=n.data;for(let e=0;e<a.length;e++)a[e]=255*ip(a[e]/255);return r.putImageData(n,0,0),i}if(!e.data)return tJ("ImageUtils.sRGBToLinear(): Unsupported image type. No color space conversion applied."),e;{let i=e.data.slice(0);for(let e=0;e<i.length;e++)i instanceof Uint8Array||i instanceof Uint8ClampedArray?i[e]=Math.floor(255*ip(i[e]/255)):i[e]=ip(i[e]);return{data:i,width:e.width,height:e.height}}}}let iv=0;class i_{constructor(e=null){this.isSource=!0,Object.defineProperty(this,"id",{value:iv++}),this.uuid=t5(),this.data=e,this.dataReady=!0,this.version=0}getSize(e){let i=this.data;return"u">typeof HTMLVideoElement&&i instanceof HTMLVideoElement?e.set(i.videoWidth,i.videoHeight,0):"u">typeof VideoFrame&&i instanceof VideoFrame?e.set(i.displayHeight,i.displayWidth,0):null!==i?e.set(i.width,i.height,i.depth||0):e.set(0,0,0),e}set needsUpdate(e){!0===e&&this.version++}toJSON(e){let i=void 0===e||"string"==typeof e;if(!i&&void 0!==e.images[this.uuid])return e.images[this.uuid];let r={uuid:this.uuid,url:""},n=this.data;if(null!==n){let e;if(Array.isArray(n)){e=[];for(let i=0,r=n.length;i<r;i++)n[i].isDataTexture?e.push(ix(n[i].image)):e.push(ix(n[i]))}else e=ix(n);r.url=e}return i||(e.images[this.uuid]=r),r}}function ix(e){return"u">typeof HTMLImageElement&&e instanceof HTMLImageElement||"u">typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"u">typeof ImageBitmap&&e instanceof ImageBitmap?ig.getDataURL(e):e.data?{data:Array.from(e.data),width:e.width,height:e.height,type:e.data.constructor.name}:(tJ("Texture: Unable to serialize Texture."),{})}let iy=0,iM=new ia;class iS extends t0{constructor(e=iS.DEFAULT_IMAGE,i=iS.DEFAULT_MAPPING,r=ey,n=ey,a=eE,s=eA,o=eG,l=eR,c=iS.DEFAULT_ANISOTROPY,h=tP){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:iy++}),this.uuid=t5(),this.name="",this.source=new i_(e),this.mipmaps=[],this.mapping=i,this.channel=0,this.wrapS=r,this.wrapT=n,this.magFilter=a,this.minFilter=s,this.anisotropy=c,this.format=o,this.internalFormat=null,this.type=l,this.offset=new ii(0,0),this.repeat=new ii(1,1),this.center=new ii(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new il,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.colorSpace=h,this.userData={},this.updateRanges=[],this.version=0,this.onUpdate=null,this.renderTarget=null,this.isRenderTargetTexture=!1,this.isArrayTexture=!!e&&!!e.depth&&e.depth>1,this.pmremVersion=0}get width(){return this.source.getSize(iM).x}get height(){return this.source.getSize(iM).y}get depth(){return this.source.getSize(iM).z}get image(){return this.source.data}set image(e=null){this.source.data=e}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}addUpdateRange(e,i){this.updateRanges.push({start:e,count:i})}clearUpdateRanges(){this.updateRanges.length=0}clone(){return new this.constructor().copy(this)}copy(e){return this.name=e.name,this.source=e.source,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.channel=e.channel,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.internalFormat=e.internalFormat,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.center.copy(e.center),this.rotation=e.rotation,this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrix.copy(e.matrix),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.colorSpace=e.colorSpace,this.renderTarget=e.renderTarget,this.isRenderTargetTexture=e.isRenderTargetTexture,this.isArrayTexture=e.isArrayTexture,this.userData=JSON.parse(JSON.stringify(e.userData)),this.needsUpdate=!0,this}setValues(e){for(let i in e){let r=e[i];if(void 0===r){tJ(`Texture.setValues(): parameter '${i}' has value of undefined.`);continue}let n=this[i];if(void 0===n){tJ(`Texture.setValues(): property '${i}' does not exist.`);continue}n&&r&&n.isVector2&&r.isVector2||n&&r&&n.isVector3&&r.isVector3||n&&r&&n.isMatrix3&&r.isMatrix3?n.copy(r):this[i]=r}}toJSON(e){let i=void 0===e||"string"==typeof e;if(!i&&void 0!==e.textures[this.uuid])return e.textures[this.uuid];let r={metadata:{version:4.7,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(e).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(r.userData=this.userData),i||(e.textures[this.uuid]=r),r}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(e){if(300!==this.mapping)return e;if(e.applyMatrix3(this.matrix),e.x<0||e.x>1)switch(this.wrapS){case ex:e.x=e.x-Math.floor(e.x);break;case ey:e.x=e.x<0?0:1;break;case eM:1===Math.abs(Math.floor(e.x)%2)?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x)}if(e.y<0||e.y>1)switch(this.wrapT){case ex:e.y=e.y-Math.floor(e.y);break;case ey:e.y=e.y<0?0:1;break;case eM:1===Math.abs(Math.floor(e.y)%2)?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y)}return this.flipY&&(e.y=1-e.y),e}set needsUpdate(e){!0===e&&(this.version++,this.source.needsUpdate=!0)}set needsPMREMUpdate(e){!0===e&&this.pmremVersion++}}iS.DEFAULT_IMAGE=null,iS.DEFAULT_MAPPING=300,iS.DEFAULT_ANISOTROPY=1;class ib{constructor(e=0,i=0,r=0,n=1){ib.prototype.isVector4=!0,this.x=e,this.y=i,this.z=r,this.w=n}get width(){return this.z}set width(e){this.z=e}get height(){return this.w}set height(e){this.w=e}set(e,i,r,n){return this.x=e,this.y=i,this.z=r,this.w=n,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this.w=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setW(e){return this.w=e,this}setComponent(e,i){switch(e){case 0:this.x=i;break;case 1:this.y=i;break;case 2:this.z=i;break;case 3:this.w=i;break;default:throw Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addVectors(e,i){return this.x=e.x+i.x,this.y=e.y+i.y,this.z=e.z+i.z,this.w=e.w+i.w,this}addScaledVector(e,i){return this.x+=e.x*i,this.y+=e.y*i,this.z+=e.z*i,this.w+=e.w*i,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}subVectors(e,i){return this.x=e.x-i.x,this.y=e.y-i.y,this.z=e.z-i.z,this.w=e.w-i.w,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}applyMatrix4(e){let i=this.x,r=this.y,n=this.z,a=this.w,s=e.elements;return this.x=s[0]*i+s[4]*r+s[8]*n+s[12]*a,this.y=s[1]*i+s[5]*r+s[9]*n+s[13]*a,this.z=s[2]*i+s[6]*r+s[10]*n+s[14]*a,this.w=s[3]*i+s[7]*r+s[11]*n+s[15]*a,this}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this}divideScalar(e){return this.multiplyScalar(1/e)}setAxisAngleFromQuaternion(e){this.w=2*Math.acos(e.w);let i=Math.sqrt(1-e.w*e.w);return i<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/i,this.y=e.y/i,this.z=e.z/i),this}setAxisAngleFromRotationMatrix(e){let i,r,n,a,s=e.elements,o=s[0],l=s[4],c=s[8],h=s[1],u=s[5],d=s[9],p=s[2],f=s[6],m=s[10];if(.01>Math.abs(l-h)&&.01>Math.abs(c-p)&&.01>Math.abs(d-f)){if(.1>Math.abs(l+h)&&.1>Math.abs(c+p)&&.1>Math.abs(d+f)&&.1>Math.abs(o+u+m-3))return this.set(1,0,0,0),this;i=Math.PI;let e=(o+1)/2,s=(u+1)/2,g=(m+1)/2,v=(l+h)/4,_=(c+p)/4,x=(d+f)/4;return e>s&&e>g?e<.01?(r=0,n=.707106781,a=.707106781):(n=v/(r=Math.sqrt(e)),a=_/r):s>g?s<.01?(r=.707106781,n=0,a=.707106781):(r=v/(n=Math.sqrt(s)),a=x/n):g<.01?(r=.707106781,n=.707106781,a=0):(r=_/(a=Math.sqrt(g)),n=x/a),this.set(r,n,a,i),this}let g=Math.sqrt((f-d)*(f-d)+(c-p)*(c-p)+(h-l)*(h-l));return .001>Math.abs(g)&&(g=1),this.x=(f-d)/g,this.y=(c-p)/g,this.z=(h-l)/g,this.w=Math.acos((o+u+m-1)/2),this}setFromMatrixPosition(e){let i=e.elements;return this.x=i[12],this.y=i[13],this.z=i[14],this.w=i[15],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this}clamp(e,i){return this.x=t6(this.x,e.x,i.x),this.y=t6(this.y,e.y,i.y),this.z=t6(this.z,e.z,i.z),this.w=t6(this.w,e.w,i.w),this}clampScalar(e,i){return this.x=t6(this.x,e,i),this.y=t6(this.y,e,i),this.z=t6(this.z,e,i),this.w=t6(this.w,e,i),this}clampLength(e,i){let r=this.length();return this.divideScalar(r||1).multiplyScalar(t6(r,e,i))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this.w=Math.trunc(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,i){return this.x+=(e.x-this.x)*i,this.y+=(e.y-this.y)*i,this.z+=(e.z-this.z)*i,this.w+=(e.w-this.w)*i,this}lerpVectors(e,i,r){return this.x=e.x+(i.x-e.x)*r,this.y=e.y+(i.y-e.y)*r,this.z=e.z+(i.z-e.z)*r,this.w=e.w+(i.w-e.w)*r,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,i=0){return this.x=e[i],this.y=e[i+1],this.z=e[i+2],this.w=e[i+3],this}toArray(e=[],i=0){return e[i]=this.x,e[i+1]=this.y,e[i+2]=this.z,e[i+3]=this.w,e}fromBufferAttribute(e,i){return this.x=e.getX(i),this.y=e.getY(i),this.z=e.getZ(i),this.w=e.getW(i),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}class iT extends t0{constructor(e=1,i=1,r={}){super(),r=Object.assign({generateMipmaps:!1,internalFormat:null,minFilter:eE,depthBuffer:!0,stencilBuffer:!1,resolveDepthBuffer:!0,resolveStencilBuffer:!0,depthTexture:null,samples:0,count:1,depth:1,multiview:!1},r),this.isRenderTarget=!0,this.width=e,this.height=i,this.depth=r.depth,this.scissor=new ib(0,0,e,i),this.scissorTest=!1,this.viewport=new ib(0,0,e,i);const n=new iS({width:e,height:i,depth:r.depth});this.textures=[];const a=r.count;for(let e=0;e<a;e++)this.textures[e]=n.clone(),this.textures[e].isRenderTargetTexture=!0,this.textures[e].renderTarget=this;this._setTextureOptions(r),this.depthBuffer=r.depthBuffer,this.stencilBuffer=r.stencilBuffer,this.resolveDepthBuffer=r.resolveDepthBuffer,this.resolveStencilBuffer=r.resolveStencilBuffer,this._depthTexture=null,this.depthTexture=r.depthTexture,this.samples=r.samples,this.multiview=r.multiview}_setTextureOptions(e={}){let i={minFilter:eE,generateMipmaps:!1,flipY:!1,internalFormat:null};void 0!==e.mapping&&(i.mapping=e.mapping),void 0!==e.wrapS&&(i.wrapS=e.wrapS),void 0!==e.wrapT&&(i.wrapT=e.wrapT),void 0!==e.wrapR&&(i.wrapR=e.wrapR),void 0!==e.magFilter&&(i.magFilter=e.magFilter),void 0!==e.minFilter&&(i.minFilter=e.minFilter),void 0!==e.format&&(i.format=e.format),void 0!==e.type&&(i.type=e.type),void 0!==e.anisotropy&&(i.anisotropy=e.anisotropy),void 0!==e.colorSpace&&(i.colorSpace=e.colorSpace),void 0!==e.flipY&&(i.flipY=e.flipY),void 0!==e.generateMipmaps&&(i.generateMipmaps=e.generateMipmaps),void 0!==e.internalFormat&&(i.internalFormat=e.internalFormat);for(let e=0;e<this.textures.length;e++)this.textures[e].setValues(i)}get texture(){return this.textures[0]}set texture(e){this.textures[0]=e}set depthTexture(e){null!==this._depthTexture&&(this._depthTexture.renderTarget=null),null!==e&&(e.renderTarget=this),this._depthTexture=e}get depthTexture(){return this._depthTexture}setSize(e,i,r=1){if(this.width!==e||this.height!==i||this.depth!==r){this.width=e,this.height=i,this.depth=r;for(let n=0,a=this.textures.length;n<a;n++)this.textures[n].image.width=e,this.textures[n].image.height=i,this.textures[n].image.depth=r,!0!==this.textures[n].isData3DTexture&&(this.textures[n].isArrayTexture=this.textures[n].image.depth>1);this.dispose()}this.viewport.set(0,0,e,i),this.scissor.set(0,0,e,i)}clone(){return new this.constructor().copy(this)}copy(e){this.width=e.width,this.height=e.height,this.depth=e.depth,this.scissor.copy(e.scissor),this.scissorTest=e.scissorTest,this.viewport.copy(e.viewport),this.textures.length=0;for(let i=0,r=e.textures.length;i<r;i++){this.textures[i]=e.textures[i].clone(),this.textures[i].isRenderTargetTexture=!0,this.textures[i].renderTarget=this;let r=Object.assign({},e.textures[i].image);this.textures[i].source=new i_(r)}return this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,this.resolveDepthBuffer=e.resolveDepthBuffer,this.resolveStencilBuffer=e.resolveStencilBuffer,null!==e.depthTexture&&(this.depthTexture=e.depthTexture.clone()),this.samples=e.samples,this}dispose(){this.dispatchEvent({type:"dispose"})}}class iE extends iT{constructor(e=1,i=1,r={}){super(e,i,r),this.isWebGLRenderTarget=!0}}class iw extends iS{constructor(e=null,i=1,r=1,n=1){super(null),this.isDataArrayTexture=!0,this.image={data:e,width:i,height:r,depth:n},this.magFilter=eS,this.minFilter=eS,this.wrapR=ey,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.layerUpdates=new Set}addLayerUpdate(e){this.layerUpdates.add(e)}clearLayerUpdates(){this.layerUpdates.clear()}}class iA extends iS{constructor(e=null,i=1,r=1,n=1){super(null),this.isData3DTexture=!0,this.image={data:e,width:i,height:r,depth:n},this.magFilter=eS,this.minFilter=eS,this.wrapR=ey,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class iR{constructor(e=new ia(Infinity,Infinity,Infinity),i=new ia(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=e,this.max=i}set(e,i){return this.min.copy(e),this.max.copy(i),this}setFromArray(e){this.makeEmpty();for(let i=0,r=e.length;i<r;i+=3)this.expandByPoint(iP.fromArray(e,i));return this}setFromBufferAttribute(e){this.makeEmpty();for(let i=0,r=e.count;i<r;i++)this.expandByPoint(iP.fromBufferAttribute(e,i));return this}setFromPoints(e){this.makeEmpty();for(let i=0,r=e.length;i<r;i++)this.expandByPoint(e[i]);return this}setFromCenterAndSize(e,i){let r=iP.copy(i).multiplyScalar(.5);return this.min.copy(e).sub(r),this.max.copy(e).add(r),this}setFromObject(e,i=!1){return this.makeEmpty(),this.expandByObject(e,i)}clone(){return new this.constructor().copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=Infinity,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(e){return this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}expandByObject(e,i=!1){e.updateWorldMatrix(!1,!1);let r=e.geometry;if(void 0!==r){let n=r.getAttribute("position");if(!0===i&&void 0!==n&&!0!==e.isInstancedMesh)for(let i=0,r=n.count;i<r;i++)!0===e.isMesh?e.getVertexPosition(i,iP):iP.fromBufferAttribute(n,i),iP.applyMatrix4(e.matrixWorld),this.expandByPoint(iP);else void 0!==e.boundingBox?(null===e.boundingBox&&e.computeBoundingBox(),iI.copy(e.boundingBox)):(null===r.boundingBox&&r.computeBoundingBox(),iI.copy(r.boundingBox)),iI.applyMatrix4(e.matrixWorld),this.union(iI)}let n=e.children;for(let e=0,r=n.length;e<r;e++)this.expandByObject(n[e],i);return this}containsPoint(e){return e.x>=this.min.x&&e.x<=this.max.x&&e.y>=this.min.y&&e.y<=this.max.y&&e.z>=this.min.z&&e.z<=this.max.z}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z}getParameter(e,i){return i.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(e){return e.max.x>=this.min.x&&e.min.x<=this.max.x&&e.max.y>=this.min.y&&e.min.y<=this.max.y&&e.max.z>=this.min.z&&e.min.z<=this.max.z}intersectsSphere(e){return this.clampPoint(e.center,iP),iP.distanceToSquared(e.center)<=e.radius*e.radius}intersectsPlane(e){let i,r;return e.normal.x>0?(i=e.normal.x*this.min.x,r=e.normal.x*this.max.x):(i=e.normal.x*this.max.x,r=e.normal.x*this.min.x),e.normal.y>0?(i+=e.normal.y*this.min.y,r+=e.normal.y*this.max.y):(i+=e.normal.y*this.max.y,r+=e.normal.y*this.min.y),e.normal.z>0?(i+=e.normal.z*this.min.z,r+=e.normal.z*this.max.z):(i+=e.normal.z*this.max.z,r+=e.normal.z*this.min.z),i<=-e.constant&&r>=-e.constant}intersectsTriangle(e){if(this.isEmpty())return!1;this.getCenter(iB),iz.subVectors(this.max,iB),iL.subVectors(e.a,iB),iD.subVectors(e.b,iB),iU.subVectors(e.c,iB),iN.subVectors(iD,iL),iO.subVectors(iU,iD),iF.subVectors(iL,iU);let i=[0,-iN.z,iN.y,0,-iO.z,iO.y,0,-iF.z,iF.y,iN.z,0,-iN.x,iO.z,0,-iO.x,iF.z,0,-iF.x,-iN.y,iN.x,0,-iO.y,iO.x,0,-iF.y,iF.x,0];return!!iH(i,iL,iD,iU,iz)&&!!iH(i=[1,0,0,0,1,0,0,0,1],iL,iD,iU,iz)&&(ik.crossVectors(iN,iO),iH(i=[ik.x,ik.y,ik.z],iL,iD,iU,iz))}clampPoint(e,i){return i.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return this.clampPoint(e,iP).distanceTo(e)}getBoundingSphere(e){return this.isEmpty()?e.makeEmpty():(this.getCenter(e.center),e.radius=.5*this.getSize(iP).length()),e}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}applyMatrix4(e){return this.isEmpty()||(iC[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),iC[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),iC[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),iC[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),iC[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),iC[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),iC[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),iC[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(iC)),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}toJSON(){return{min:this.min.toArray(),max:this.max.toArray()}}fromJSON(e){return this.min.fromArray(e.min),this.max.fromArray(e.max),this}}let iC=[new ia,new ia,new ia,new ia,new ia,new ia,new ia,new ia],iP=new ia,iI=new iR,iL=new ia,iD=new ia,iU=new ia,iN=new ia,iO=new ia,iF=new ia,iB=new ia,iz=new ia,ik=new ia,iV=new ia;function iH(e,i,r,n,a){for(let s=0,o=e.length-3;s<=o;s+=3){iV.fromArray(e,s);let o=a.x*Math.abs(iV.x)+a.y*Math.abs(iV.y)+a.z*Math.abs(iV.z),l=i.dot(iV),c=r.dot(iV),h=n.dot(iV);if(Math.max(-Math.max(l,c,h),Math.min(l,c,h))>o)return!1}return!0}let iG=new iR,iW=new ia,iX=new ia;class ij{constructor(e=new ia,i=-1){this.isSphere=!0,this.center=e,this.radius=i}set(e,i){return this.center.copy(e),this.radius=i,this}setFromPoints(e,i){let r=this.center;void 0!==i?r.copy(i):iG.setFromPoints(e).getCenter(r);let n=0;for(let i=0,a=e.length;i<a;i++)n=Math.max(n,r.distanceToSquared(e[i]));return this.radius=Math.sqrt(n),this}copy(e){return this.center.copy(e.center),this.radius=e.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(e){return e.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(e){return e.distanceTo(this.center)-this.radius}intersectsSphere(e){let i=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=i*i}intersectsBox(e){return e.intersectsSphere(this)}intersectsPlane(e){return Math.abs(e.distanceToPoint(this.center))<=this.radius}clampPoint(e,i){let r=this.center.distanceToSquared(e);return i.copy(e),r>this.radius*this.radius&&(i.sub(this.center).normalize(),i.multiplyScalar(this.radius).add(this.center)),i}getBoundingBox(e){return this.isEmpty()?e.makeEmpty():(e.set(this.center,this.center),e.expandByScalar(this.radius)),e}applyMatrix4(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this}translate(e){return this.center.add(e),this}expandByPoint(e){if(this.isEmpty())return this.center.copy(e),this.radius=0,this;iW.subVectors(e,this.center);let i=iW.lengthSq();if(i>this.radius*this.radius){let e=Math.sqrt(i),r=(e-this.radius)*.5;this.center.addScaledVector(iW,r/e),this.radius+=r}return this}union(e){return e.isEmpty()||(this.isEmpty()?this.copy(e):!0===this.center.equals(e.center)?this.radius=Math.max(this.radius,e.radius):(iX.subVectors(e.center,this.center).setLength(e.radius),this.expandByPoint(iW.copy(e.center).add(iX)),this.expandByPoint(iW.copy(e.center).sub(iX)))),this}equals(e){return e.center.equals(this.center)&&e.radius===this.radius}clone(){return new this.constructor().copy(this)}toJSON(){return{radius:this.radius,center:this.center.toArray()}}fromJSON(e){return this.radius=e.radius,this.center.fromArray(e.center),this}}let iq=new ia,iY=new ia,iK=new ia,iJ=new ia,iZ=new ia,iQ=new ia,i$=new ia;class i0{constructor(e=new ia,i=new ia(0,0,-1)){this.origin=e,this.direction=i}set(e,i){return this.origin.copy(e),this.direction.copy(i),this}copy(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this}at(e,i){return i.copy(this.origin).addScaledVector(this.direction,e)}lookAt(e){return this.direction.copy(e).sub(this.origin).normalize(),this}recast(e){return this.origin.copy(this.at(e,iq)),this}closestPointToPoint(e,i){i.subVectors(e,this.origin);let r=i.dot(this.direction);return r<0?i.copy(this.origin):i.copy(this.origin).addScaledVector(this.direction,r)}distanceToPoint(e){return Math.sqrt(this.distanceSqToPoint(e))}distanceSqToPoint(e){let i=iq.subVectors(e,this.origin).dot(this.direction);return i<0?this.origin.distanceToSquared(e):(iq.copy(this.origin).addScaledVector(this.direction,i),iq.distanceToSquared(e))}distanceSqToSegment(e,i,r,n){let a,s,o,l;iY.copy(e).add(i).multiplyScalar(.5),iK.copy(i).sub(e).normalize(),iJ.copy(this.origin).sub(iY);let c=.5*e.distanceTo(i),h=-this.direction.dot(iK),u=iJ.dot(this.direction),d=-iJ.dot(iK),p=iJ.lengthSq(),f=Math.abs(1-h*h);if(f>0)if(a=h*d-u,s=h*u-d,l=c*f,a>=0)if(s>=-l)if(s<=l){let e=1/f;a*=e,s*=e,o=a*(a+h*s+2*u)+s*(h*a+s+2*d)+p}else o=-(a=Math.max(0,-(h*(s=c)+u)))*a+s*(s+2*d)+p;else o=-(a=Math.max(0,-(h*(s=-c)+u)))*a+s*(s+2*d)+p;else s<=-l?(s=(a=Math.max(0,-(-h*c+u)))>0?-c:Math.min(Math.max(-c,-d),c),o=-a*a+s*(s+2*d)+p):s<=l?(a=0,o=(s=Math.min(Math.max(-c,-d),c))*(s+2*d)+p):(s=(a=Math.max(0,-(h*c+u)))>0?c:Math.min(Math.max(-c,-d),c),o=-a*a+s*(s+2*d)+p);else s=h>0?-c:c,o=-(a=Math.max(0,-(h*s+u)))*a+s*(s+2*d)+p;return r&&r.copy(this.origin).addScaledVector(this.direction,a),n&&n.copy(iY).addScaledVector(iK,s),o}intersectSphere(e,i){iq.subVectors(e.center,this.origin);let r=iq.dot(this.direction),n=iq.dot(iq)-r*r,a=e.radius*e.radius;if(n>a)return null;let s=Math.sqrt(a-n),o=r-s,l=r+s;return l<0?null:o<0?this.at(l,i):this.at(o,i)}intersectsSphere(e){return!(e.radius<0)&&this.distanceSqToPoint(e.center)<=e.radius*e.radius}distanceToPlane(e){let i=e.normal.dot(this.direction);if(0===i)return 0===e.distanceToPoint(this.origin)?0:null;let r=-(this.origin.dot(e.normal)+e.constant)/i;return r>=0?r:null}intersectPlane(e,i){let r=this.distanceToPlane(e);return null===r?null:this.at(r,i)}intersectsPlane(e){let i=e.distanceToPoint(this.origin);return!!(0===i||e.normal.dot(this.direction)*i<0)}intersectBox(e,i){let r,n,a,s,o,l,c=1/this.direction.x,h=1/this.direction.y,u=1/this.direction.z,d=this.origin;return(c>=0?(r=(e.min.x-d.x)*c,n=(e.max.x-d.x)*c):(r=(e.max.x-d.x)*c,n=(e.min.x-d.x)*c),h>=0?(a=(e.min.y-d.y)*h,s=(e.max.y-d.y)*h):(a=(e.max.y-d.y)*h,s=(e.min.y-d.y)*h),r>s||a>n||((a>r||isNaN(r))&&(r=a),(s<n||isNaN(n))&&(n=s),u>=0?(o=(e.min.z-d.z)*u,l=(e.max.z-d.z)*u):(o=(e.max.z-d.z)*u,l=(e.min.z-d.z)*u),r>l||o>n||((o>r||r!=r)&&(r=o),(l<n||n!=n)&&(n=l),n<0)))?null:this.at(r>=0?r:n,i)}intersectsBox(e){return null!==this.intersectBox(e,iq)}intersectTriangle(e,i,r,n,a){let s;iZ.subVectors(i,e),iQ.subVectors(r,e),i$.crossVectors(iZ,iQ);let o=this.direction.dot(i$);if(o>0){if(n)return null;s=1}else{if(!(o<0))return null;s=-1,o=-o}iJ.subVectors(this.origin,e);let l=s*this.direction.dot(iQ.crossVectors(iJ,iQ));if(l<0)return null;let c=s*this.direction.dot(iZ.cross(iJ));if(c<0||l+c>o)return null;let h=-s*iJ.dot(i$);return h<0?null:this.at(h/o,a)}applyMatrix4(e){return this.origin.applyMatrix4(e),this.direction.transformDirection(e),this}equals(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}clone(){return new this.constructor().copy(this)}}class i1{constructor(e,i,r,n,a,s,o,l,c,h,u,d,p,f,m,g){i1.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==e&&this.set(e,i,r,n,a,s,o,l,c,h,u,d,p,f,m,g)}set(e,i,r,n,a,s,o,l,c,h,u,d,p,f,m,g){let v=this.elements;return v[0]=e,v[4]=i,v[8]=r,v[12]=n,v[1]=a,v[5]=s,v[9]=o,v[13]=l,v[2]=c,v[6]=h,v[10]=u,v[14]=d,v[3]=p,v[7]=f,v[11]=m,v[15]=g,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return new i1().fromArray(this.elements)}copy(e){let i=this.elements,r=e.elements;return i[0]=r[0],i[1]=r[1],i[2]=r[2],i[3]=r[3],i[4]=r[4],i[5]=r[5],i[6]=r[6],i[7]=r[7],i[8]=r[8],i[9]=r[9],i[10]=r[10],i[11]=r[11],i[12]=r[12],i[13]=r[13],i[14]=r[14],i[15]=r[15],this}copyPosition(e){let i=this.elements,r=e.elements;return i[12]=r[12],i[13]=r[13],i[14]=r[14],this}setFromMatrix3(e){let i=e.elements;return this.set(i[0],i[3],i[6],0,i[1],i[4],i[7],0,i[2],i[5],i[8],0,0,0,0,1),this}extractBasis(e,i,r){return 0===this.determinant()?(e.set(1,0,0),i.set(0,1,0),r.set(0,0,1)):(e.setFromMatrixColumn(this,0),i.setFromMatrixColumn(this,1),r.setFromMatrixColumn(this,2)),this}makeBasis(e,i,r){return this.set(e.x,i.x,r.x,0,e.y,i.y,r.y,0,e.z,i.z,r.z,0,0,0,0,1),this}extractRotation(e){if(0===e.determinant())return this.identity();let i=this.elements,r=e.elements,n=1/i3.setFromMatrixColumn(e,0).length(),a=1/i3.setFromMatrixColumn(e,1).length(),s=1/i3.setFromMatrixColumn(e,2).length();return i[0]=r[0]*n,i[1]=r[1]*n,i[2]=r[2]*n,i[3]=0,i[4]=r[4]*a,i[5]=r[5]*a,i[6]=r[6]*a,i[7]=0,i[8]=r[8]*s,i[9]=r[9]*s,i[10]=r[10]*s,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,this}makeRotationFromEuler(e){let i=this.elements,r=e.x,n=e.y,a=e.z,s=Math.cos(r),o=Math.sin(r),l=Math.cos(n),c=Math.sin(n),h=Math.cos(a),u=Math.sin(a);if("XYZ"===e.order){let e=s*h,r=s*u,n=o*h,a=o*u;i[0]=l*h,i[4]=-l*u,i[8]=c,i[1]=r+n*c,i[5]=e-a*c,i[9]=-o*l,i[2]=a-e*c,i[6]=n+r*c,i[10]=s*l}else if("YXZ"===e.order){let e=l*h,r=l*u,n=c*h,a=c*u;i[0]=e+a*o,i[4]=n*o-r,i[8]=s*c,i[1]=s*u,i[5]=s*h,i[9]=-o,i[2]=r*o-n,i[6]=a+e*o,i[10]=s*l}else if("ZXY"===e.order){let e=l*h,r=l*u,n=c*h,a=c*u;i[0]=e-a*o,i[4]=-s*u,i[8]=n+r*o,i[1]=r+n*o,i[5]=s*h,i[9]=a-e*o,i[2]=-s*c,i[6]=o,i[10]=s*l}else if("ZYX"===e.order){let e=s*h,r=s*u,n=o*h,a=o*u;i[0]=l*h,i[4]=n*c-r,i[8]=e*c+a,i[1]=l*u,i[5]=a*c+e,i[9]=r*c-n,i[2]=-c,i[6]=o*l,i[10]=s*l}else if("YZX"===e.order){let e=s*l,r=s*c,n=o*l,a=o*c;i[0]=l*h,i[4]=a-e*u,i[8]=n*u+r,i[1]=u,i[5]=s*h,i[9]=-o*h,i[2]=-c*h,i[6]=r*u+n,i[10]=e-a*u}else if("XZY"===e.order){let e=s*l,r=s*c,n=o*l,a=o*c;i[0]=l*h,i[4]=-u,i[8]=c*h,i[1]=e*u+a,i[5]=s*h,i[9]=r*u-n,i[2]=n*u-r,i[6]=o*h,i[10]=a*u+e}return i[3]=0,i[7]=0,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,this}makeRotationFromQuaternion(e){return this.compose(i4,e,i5)}lookAt(e,i,r){let n=this.elements;return i9.subVectors(e,i),0===i9.lengthSq()&&(i9.z=1),i9.normalize(),i6.crossVectors(r,i9),0===i6.lengthSq()&&(1===Math.abs(r.z)?i9.x+=1e-4:i9.z+=1e-4,i9.normalize(),i6.crossVectors(r,i9)),i6.normalize(),i8.crossVectors(i9,i6),n[0]=i6.x,n[4]=i8.x,n[8]=i9.x,n[1]=i6.y,n[5]=i8.y,n[9]=i9.y,n[2]=i6.z,n[6]=i8.z,n[10]=i9.z,this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,i){let r=e.elements,n=i.elements,a=this.elements,s=r[0],o=r[4],l=r[8],c=r[12],h=r[1],u=r[5],d=r[9],p=r[13],f=r[2],m=r[6],g=r[10],v=r[14],_=r[3],x=r[7],y=r[11],M=r[15],S=n[0],b=n[4],T=n[8],E=n[12],w=n[1],A=n[5],R=n[9],C=n[13],P=n[2],I=n[6],L=n[10],D=n[14],U=n[3],N=n[7],O=n[11],F=n[15];return a[0]=s*S+o*w+l*P+c*U,a[4]=s*b+o*A+l*I+c*N,a[8]=s*T+o*R+l*L+c*O,a[12]=s*E+o*C+l*D+c*F,a[1]=h*S+u*w+d*P+p*U,a[5]=h*b+u*A+d*I+p*N,a[9]=h*T+u*R+d*L+p*O,a[13]=h*E+u*C+d*D+p*F,a[2]=f*S+m*w+g*P+v*U,a[6]=f*b+m*A+g*I+v*N,a[10]=f*T+m*R+g*L+v*O,a[14]=f*E+m*C+g*D+v*F,a[3]=_*S+x*w+y*P+M*U,a[7]=_*b+x*A+y*I+M*N,a[11]=_*T+x*R+y*L+M*O,a[15]=_*E+x*C+y*D+M*F,this}multiplyScalar(e){let i=this.elements;return i[0]*=e,i[4]*=e,i[8]*=e,i[12]*=e,i[1]*=e,i[5]*=e,i[9]*=e,i[13]*=e,i[2]*=e,i[6]*=e,i[10]*=e,i[14]*=e,i[3]*=e,i[7]*=e,i[11]*=e,i[15]*=e,this}determinant(){let e=this.elements,i=e[0],r=e[4],n=e[8],a=e[12],s=e[1],o=e[5],l=e[9],c=e[13],h=e[2],u=e[6],d=e[10],p=e[14],f=e[3],m=e[7],g=e[11],v=e[15],_=l*p-c*d,x=o*p-c*u,y=o*d-l*u,M=s*p-c*h,S=s*d-l*h,b=s*u-o*h;return i*(m*_-g*x+v*y)-r*(f*_-g*M+v*S)+n*(f*x-m*M+v*b)-a*(f*y-m*S+g*b)}transpose(){let e,i=this.elements;return e=i[1],i[1]=i[4],i[4]=e,e=i[2],i[2]=i[8],i[8]=e,e=i[6],i[6]=i[9],i[9]=e,e=i[3],i[3]=i[12],i[12]=e,e=i[7],i[7]=i[13],i[13]=e,e=i[11],i[11]=i[14],i[14]=e,this}setPosition(e,i,r){let n=this.elements;return e.isVector3?(n[12]=e.x,n[13]=e.y,n[14]=e.z):(n[12]=e,n[13]=i,n[14]=r),this}invert(){let e=this.elements,i=e[0],r=e[1],n=e[2],a=e[3],s=e[4],o=e[5],l=e[6],c=e[7],h=e[8],u=e[9],d=e[10],p=e[11],f=e[12],m=e[13],g=e[14],v=e[15],_=u*g*c-m*d*c+m*l*p-o*g*p-u*l*v+o*d*v,x=f*d*c-h*g*c-f*l*p+s*g*p+h*l*v-s*d*v,y=h*m*c-f*u*c+f*o*p-s*m*p-h*o*v+s*u*v,M=f*u*l-h*m*l-f*o*d+s*m*d+h*o*g-s*u*g,S=i*_+r*x+n*y+a*M;if(0===S)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);let b=1/S;return e[0]=_*b,e[1]=(m*d*a-u*g*a-m*n*p+r*g*p+u*n*v-r*d*v)*b,e[2]=(o*g*a-m*l*a+m*n*c-r*g*c-o*n*v+r*l*v)*b,e[3]=(u*l*a-o*d*a-u*n*c+r*d*c+o*n*p-r*l*p)*b,e[4]=x*b,e[5]=(h*g*a-f*d*a+f*n*p-i*g*p-h*n*v+i*d*v)*b,e[6]=(f*l*a-s*g*a-f*n*c+i*g*c+s*n*v-i*l*v)*b,e[7]=(s*d*a-h*l*a+h*n*c-i*d*c-s*n*p+i*l*p)*b,e[8]=y*b,e[9]=(f*u*a-h*m*a-f*r*p+i*m*p+h*r*v-i*u*v)*b,e[10]=(s*m*a-f*o*a+f*r*c-i*m*c-s*r*v+i*o*v)*b,e[11]=(h*o*a-s*u*a-h*r*c+i*u*c+s*r*p-i*o*p)*b,e[12]=M*b,e[13]=(h*m*n-f*u*n+f*r*d-i*m*d-h*r*g+i*u*g)*b,e[14]=(f*o*n-s*m*n-f*r*l+i*m*l+s*r*g-i*o*g)*b,e[15]=(s*u*n-h*o*n+h*r*l-i*u*l-s*r*d+i*o*d)*b,this}scale(e){let i=this.elements,r=e.x,n=e.y,a=e.z;return i[0]*=r,i[4]*=n,i[8]*=a,i[1]*=r,i[5]*=n,i[9]*=a,i[2]*=r,i[6]*=n,i[10]*=a,i[3]*=r,i[7]*=n,i[11]*=a,this}getMaxScaleOnAxis(){let e=this.elements;return Math.sqrt(Math.max(e[0]*e[0]+e[1]*e[1]+e[2]*e[2],e[4]*e[4]+e[5]*e[5]+e[6]*e[6],e[8]*e[8]+e[9]*e[9]+e[10]*e[10]))}makeTranslation(e,i,r){return e.isVector3?this.set(1,0,0,e.x,0,1,0,e.y,0,0,1,e.z,0,0,0,1):this.set(1,0,0,e,0,1,0,i,0,0,1,r,0,0,0,1),this}makeRotationX(e){let i=Math.cos(e),r=Math.sin(e);return this.set(1,0,0,0,0,i,-r,0,0,r,i,0,0,0,0,1),this}makeRotationY(e){let i=Math.cos(e),r=Math.sin(e);return this.set(i,0,r,0,0,1,0,0,-r,0,i,0,0,0,0,1),this}makeRotationZ(e){let i=Math.cos(e),r=Math.sin(e);return this.set(i,-r,0,0,r,i,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,i){let r=Math.cos(i),n=Math.sin(i),a=1-r,s=e.x,o=e.y,l=e.z,c=a*s,h=a*o;return this.set(c*s+r,c*o-n*l,c*l+n*o,0,c*o+n*l,h*o+r,h*l-n*s,0,c*l-n*o,h*l+n*s,a*l*l+r,0,0,0,0,1),this}makeScale(e,i,r){return this.set(e,0,0,0,0,i,0,0,0,0,r,0,0,0,0,1),this}makeShear(e,i,r,n,a,s){return this.set(1,r,a,0,e,1,s,0,i,n,1,0,0,0,0,1),this}compose(e,i,r){let n=this.elements,a=i._x,s=i._y,o=i._z,l=i._w,c=a+a,h=s+s,u=o+o,d=a*c,p=a*h,f=a*u,m=s*h,g=s*u,v=o*u,_=l*c,x=l*h,y=l*u,M=r.x,S=r.y,b=r.z;return n[0]=(1-(m+v))*M,n[1]=(p+y)*M,n[2]=(f-x)*M,n[3]=0,n[4]=(p-y)*S,n[5]=(1-(d+v))*S,n[6]=(g+_)*S,n[7]=0,n[8]=(f+x)*b,n[9]=(g-_)*b,n[10]=(1-(d+m))*b,n[11]=0,n[12]=e.x,n[13]=e.y,n[14]=e.z,n[15]=1,this}decompose(e,i,r){let n=this.elements;if(e.x=n[12],e.y=n[13],e.z=n[14],0===this.determinant())return r.set(1,1,1),i.identity(),this;let a=i3.set(n[0],n[1],n[2]).length(),s=i3.set(n[4],n[5],n[6]).length(),o=i3.set(n[8],n[9],n[10]).length();0>this.determinant()&&(a=-a),i2.copy(this);let l=1/a,c=1/s,h=1/o;return i2.elements[0]*=l,i2.elements[1]*=l,i2.elements[2]*=l,i2.elements[4]*=c,i2.elements[5]*=c,i2.elements[6]*=c,i2.elements[8]*=h,i2.elements[9]*=h,i2.elements[10]*=h,i.setFromRotationMatrix(i2),r.x=a,r.y=s,r.z=o,this}makePerspective(e,i,r,n,a,s,o=tW,l=!1){let c,h,u=this.elements;if(l)c=a/(s-a),h=s*a/(s-a);else if(o===tW)c=-(s+a)/(s-a),h=-2*s*a/(s-a);else if(2001===o)c=-s/(s-a),h=-s*a/(s-a);else throw Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+o);return u[0]=2*a/(i-e),u[4]=0,u[8]=(i+e)/(i-e),u[12]=0,u[1]=0,u[5]=2*a/(r-n),u[9]=(r+n)/(r-n),u[13]=0,u[2]=0,u[6]=0,u[10]=c,u[14]=h,u[3]=0,u[7]=0,u[11]=-1,u[15]=0,this}makeOrthographic(e,i,r,n,a,s,o=tW,l=!1){let c,h,u=this.elements;if(l)c=1/(s-a),h=s/(s-a);else if(o===tW)c=-2/(s-a),h=-(s+a)/(s-a);else if(2001===o)c=-1/(s-a),h=-a/(s-a);else throw Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+o);return u[0]=2/(i-e),u[4]=0,u[8]=0,u[12]=-(i+e)/(i-e),u[1]=0,u[5]=2/(r-n),u[9]=0,u[13]=-(r+n)/(r-n),u[2]=0,u[6]=0,u[10]=c,u[14]=h,u[3]=0,u[7]=0,u[11]=0,u[15]=1,this}equals(e){let i=this.elements,r=e.elements;for(let e=0;e<16;e++)if(i[e]!==r[e])return!1;return!0}fromArray(e,i=0){for(let r=0;r<16;r++)this.elements[r]=e[r+i];return this}toArray(e=[],i=0){let r=this.elements;return e[i]=r[0],e[i+1]=r[1],e[i+2]=r[2],e[i+3]=r[3],e[i+4]=r[4],e[i+5]=r[5],e[i+6]=r[6],e[i+7]=r[7],e[i+8]=r[8],e[i+9]=r[9],e[i+10]=r[10],e[i+11]=r[11],e[i+12]=r[12],e[i+13]=r[13],e[i+14]=r[14],e[i+15]=r[15],e}}let i3=new ia,i2=new i1,i4=new ia(0,0,0),i5=new ia(1,1,1),i6=new ia,i8=new ia,i9=new ia,i7=new i1,re=new ir;class rt{constructor(e=0,i=0,r=0,n=rt.DEFAULT_ORDER){this.isEuler=!0,this._x=e,this._y=i,this._z=r,this._order=n}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get order(){return this._order}set order(e){this._order=e,this._onChangeCallback()}set(e,i,r,n=this._order){return this._x=e,this._y=i,this._z=r,this._order=n,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this._onChangeCallback(),this}setFromRotationMatrix(e,i=this._order,r=!0){let n=e.elements,a=n[0],s=n[4],o=n[8],l=n[1],c=n[5],h=n[9],u=n[2],d=n[6],p=n[10];switch(i){case"XYZ":this._y=Math.asin(t6(o,-1,1)),.9999999>Math.abs(o)?(this._x=Math.atan2(-h,p),this._z=Math.atan2(-s,a)):(this._x=Math.atan2(d,c),this._z=0);break;case"YXZ":this._x=Math.asin(-t6(h,-1,1)),.9999999>Math.abs(h)?(this._y=Math.atan2(o,p),this._z=Math.atan2(l,c)):(this._y=Math.atan2(-u,a),this._z=0);break;case"ZXY":this._x=Math.asin(t6(d,-1,1)),.9999999>Math.abs(d)?(this._y=Math.atan2(-u,p),this._z=Math.atan2(-s,c)):(this._y=0,this._z=Math.atan2(l,a));break;case"ZYX":this._y=Math.asin(-t6(u,-1,1)),.9999999>Math.abs(u)?(this._x=Math.atan2(d,p),this._z=Math.atan2(l,a)):(this._x=0,this._z=Math.atan2(-s,c));break;case"YZX":this._z=Math.asin(t6(l,-1,1)),.9999999>Math.abs(l)?(this._x=Math.atan2(-h,c),this._y=Math.atan2(-u,a)):(this._x=0,this._y=Math.atan2(o,p));break;case"XZY":this._z=Math.asin(-t6(s,-1,1)),.9999999>Math.abs(s)?(this._x=Math.atan2(d,c),this._y=Math.atan2(o,a)):(this._x=Math.atan2(-h,p),this._y=0);break;default:tJ("Euler: .setFromRotationMatrix() encountered an unknown order: "+i)}return this._order=i,!0===r&&this._onChangeCallback(),this}setFromQuaternion(e,i,r){return i7.makeRotationFromQuaternion(e),this.setFromRotationMatrix(i7,i,r)}setFromVector3(e,i=this._order){return this.set(e.x,e.y,e.z,i)}reorder(e){return re.setFromEuler(this),this.setFromQuaternion(re,e)}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order}fromArray(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this._onChangeCallback(),this}toArray(e=[],i=0){return e[i]=this._x,e[i+1]=this._y,e[i+2]=this._z,e[i+3]=this._order,e}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}rt.DEFAULT_ORDER="XYZ";class ri{constructor(){this.mask=1}set(e){this.mask=1<<e>>>0}enable(e){this.mask|=1<<e}enableAll(){this.mask=-1}toggle(e){this.mask^=1<<e}disable(e){this.mask&=~(1<<e)}disableAll(){this.mask=0}test(e){return(this.mask&e.mask)!=0}isEnabled(e){return(this.mask&1<<e)!=0}}let rr=0,rn=new ia,ra=new ir,rs=new i1,ro=new ia,rl=new ia,rc=new ia,rh=new ir,ru=new ia(1,0,0),rd=new ia(0,1,0),rp=new ia(0,0,1),rf={type:"added"},rm={type:"removed"},rg={type:"childadded",child:null},rv={type:"childremoved",child:null};class r_ extends t0{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:rr++}),this.uuid=t5(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=r_.DEFAULT_UP.clone();const e=new ia,i=new rt,r=new ir,n=new ia(1,1,1);i._onChange(function(){r.setFromEuler(i,!1)}),r._onChange(function(){i.setFromQuaternion(r,void 0,!1)}),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:e},rotation:{configurable:!0,enumerable:!0,value:i},quaternion:{configurable:!0,enumerable:!0,value:r},scale:{configurable:!0,enumerable:!0,value:n},modelViewMatrix:{value:new i1},normalMatrix:{value:new il}}),this.matrix=new i1,this.matrixWorld=new i1,this.matrixAutoUpdate=r_.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=r_.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new ri,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.customDepthMaterial=void 0,this.customDistanceMaterial=void 0,this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(e){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(e),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(e){return this.quaternion.premultiply(e),this}setRotationFromAxisAngle(e,i){this.quaternion.setFromAxisAngle(e,i)}setRotationFromEuler(e){this.quaternion.setFromEuler(e,!0)}setRotationFromMatrix(e){this.quaternion.setFromRotationMatrix(e)}setRotationFromQuaternion(e){this.quaternion.copy(e)}rotateOnAxis(e,i){return ra.setFromAxisAngle(e,i),this.quaternion.multiply(ra),this}rotateOnWorldAxis(e,i){return ra.setFromAxisAngle(e,i),this.quaternion.premultiply(ra),this}rotateX(e){return this.rotateOnAxis(ru,e)}rotateY(e){return this.rotateOnAxis(rd,e)}rotateZ(e){return this.rotateOnAxis(rp,e)}translateOnAxis(e,i){return rn.copy(e).applyQuaternion(this.quaternion),this.position.add(rn.multiplyScalar(i)),this}translateX(e){return this.translateOnAxis(ru,e)}translateY(e){return this.translateOnAxis(rd,e)}translateZ(e){return this.translateOnAxis(rp,e)}localToWorld(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(this.matrixWorld)}worldToLocal(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(rs.copy(this.matrixWorld).invert())}lookAt(e,i,r){e.isVector3?ro.copy(e):ro.set(e,i,r);let n=this.parent;this.updateWorldMatrix(!0,!1),rl.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?rs.lookAt(rl,ro,this.up):rs.lookAt(ro,rl,this.up),this.quaternion.setFromRotationMatrix(rs),n&&(rs.extractRotation(n.matrixWorld),ra.setFromRotationMatrix(rs),this.quaternion.premultiply(ra.invert()))}add(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return e===this?tZ("Object3D.add: object can't be added as a child of itself.",e):e&&e.isObject3D?(e.removeFromParent(),e.parent=this,this.children.push(e),e.dispatchEvent(rf),rg.child=e,this.dispatchEvent(rg),rg.child=null):tZ("Object3D.add: object not an instance of THREE.Object3D.",e),this}remove(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.remove(arguments[e]);return this}let i=this.children.indexOf(e);return -1!==i&&(e.parent=null,this.children.splice(i,1),e.dispatchEvent(rm),rv.child=e,this.dispatchEvent(rv),rv.child=null),this}removeFromParent(){let e=this.parent;return null!==e&&e.remove(this),this}clear(){return this.remove(...this.children)}attach(e){return this.updateWorldMatrix(!0,!1),rs.copy(this.matrixWorld).invert(),null!==e.parent&&(e.parent.updateWorldMatrix(!0,!1),rs.multiply(e.parent.matrixWorld)),e.applyMatrix4(rs),e.removeFromParent(),e.parent=this,this.children.push(e),e.updateWorldMatrix(!1,!0),e.dispatchEvent(rf),rg.child=e,this.dispatchEvent(rg),rg.child=null,this}getObjectById(e){return this.getObjectByProperty("id",e)}getObjectByName(e){return this.getObjectByProperty("name",e)}getObjectByProperty(e,i){if(this[e]===i)return this;for(let r=0,n=this.children.length;r<n;r++){let n=this.children[r].getObjectByProperty(e,i);if(void 0!==n)return n}}getObjectsByProperty(e,i,r=[]){this[e]===i&&r.push(this);let n=this.children;for(let a=0,s=n.length;a<s;a++)n[a].getObjectsByProperty(e,i,r);return r}getWorldPosition(e){return this.updateWorldMatrix(!0,!1),e.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(rl,e,rc),e}getWorldScale(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(rl,rh,e),e}getWorldDirection(e){this.updateWorldMatrix(!0,!1);let i=this.matrixWorld.elements;return e.set(i[8],i[9],i[10]).normalize()}raycast(){}traverse(e){e(this);let i=this.children;for(let r=0,n=i.length;r<n;r++)i[r].traverse(e)}traverseVisible(e){if(!1===this.visible)return;e(this);let i=this.children;for(let r=0,n=i.length;r<n;r++)i[r].traverseVisible(e)}traverseAncestors(e){let i=this.parent;null!==i&&(e(i),i.traverseAncestors(e))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),this.matrixWorldNeedsUpdate=!1,e=!0);let i=this.children;for(let r=0,n=i.length;r<n;r++)i[r].updateMatrixWorld(e)}updateWorldMatrix(e,i){let r=this.parent;if(!0===e&&null!==r&&r.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),!0===i){let e=this.children;for(let i=0,r=e.length;i<r;i++)e[i].updateWorldMatrix(!1,!0)}}toJSON(e){let i=void 0===e||"string"==typeof e,r={};i&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},r.metadata={version:4.7,type:"Object",generator:"Object3D.toJSON"});let n={};function a(i,r){return void 0===i[r.uuid]&&(i[r.uuid]=r.toJSON(e)),r.uuid}if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),!0===this.castShadow&&(n.castShadow=!0),!0===this.receiveShadow&&(n.receiveShadow=!0),!1===this.visible&&(n.visible=!1),!1===this.frustumCulled&&(n.frustumCulled=!1),0!==this.renderOrder&&(n.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(n.userData=this.userData),n.layers=this.layers.mask,n.matrix=this.matrix.toArray(),n.up=this.up.toArray(),!1===this.matrixAutoUpdate&&(n.matrixAutoUpdate=!1),this.isInstancedMesh&&(n.type="InstancedMesh",n.count=this.count,n.instanceMatrix=this.instanceMatrix.toJSON(),null!==this.instanceColor&&(n.instanceColor=this.instanceColor.toJSON())),this.isBatchedMesh&&(n.type="BatchedMesh",n.perObjectFrustumCulled=this.perObjectFrustumCulled,n.sortObjects=this.sortObjects,n.drawRanges=this._drawRanges,n.reservedRanges=this._reservedRanges,n.geometryInfo=this._geometryInfo.map(e=>({...e,boundingBox:e.boundingBox?e.boundingBox.toJSON():void 0,boundingSphere:e.boundingSphere?e.boundingSphere.toJSON():void 0})),n.instanceInfo=this._instanceInfo.map(e=>({...e})),n.availableInstanceIds=this._availableInstanceIds.slice(),n.availableGeometryIds=this._availableGeometryIds.slice(),n.nextIndexStart=this._nextIndexStart,n.nextVertexStart=this._nextVertexStart,n.geometryCount=this._geometryCount,n.maxInstanceCount=this._maxInstanceCount,n.maxVertexCount=this._maxVertexCount,n.maxIndexCount=this._maxIndexCount,n.geometryInitialized=this._geometryInitialized,n.matricesTexture=this._matricesTexture.toJSON(e),n.indirectTexture=this._indirectTexture.toJSON(e),null!==this._colorsTexture&&(n.colorsTexture=this._colorsTexture.toJSON(e)),null!==this.boundingSphere&&(n.boundingSphere=this.boundingSphere.toJSON()),null!==this.boundingBox&&(n.boundingBox=this.boundingBox.toJSON())),this.isScene)this.background&&(this.background.isColor?n.background=this.background.toJSON():this.background.isTexture&&(n.background=this.background.toJSON(e).uuid)),this.environment&&this.environment.isTexture&&!0!==this.environment.isRenderTargetTexture&&(n.environment=this.environment.toJSON(e).uuid);else if(this.isMesh||this.isLine||this.isPoints){n.geometry=a(e.geometries,this.geometry);let i=this.geometry.parameters;if(void 0!==i&&void 0!==i.shapes){let r=i.shapes;if(Array.isArray(r))for(let i=0,n=r.length;i<n;i++){let n=r[i];a(e.shapes,n)}else a(e.shapes,r)}}if(this.isSkinnedMesh&&(n.bindMode=this.bindMode,n.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(a(e.skeletons,this.skeleton),n.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){let i=[];for(let r=0,n=this.material.length;r<n;r++)i.push(a(e.materials,this.material[r]));n.material=i}else n.material=a(e.materials,this.material);if(this.children.length>0){n.children=[];for(let i=0;i<this.children.length;i++)n.children.push(this.children[i].toJSON(e).object)}if(this.animations.length>0){n.animations=[];for(let i=0;i<this.animations.length;i++){let r=this.animations[i];n.animations.push(a(e.animations,r))}}if(i){let i=s(e.geometries),n=s(e.materials),a=s(e.textures),o=s(e.images),l=s(e.shapes),c=s(e.skeletons),h=s(e.animations),u=s(e.nodes);i.length>0&&(r.geometries=i),n.length>0&&(r.materials=n),a.length>0&&(r.textures=a),o.length>0&&(r.images=o),l.length>0&&(r.shapes=l),c.length>0&&(r.skeletons=c),h.length>0&&(r.animations=h),u.length>0&&(r.nodes=u)}return r.object=n,r;function s(e){let i=[];for(let r in e){let n=e[r];delete n.metadata,i.push(n)}return i}}clone(e){return new this.constructor().copy(this,e)}copy(e,i=!0){if(this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.rotation.order=e.rotation.order,this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldAutoUpdate=e.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.animations=e.animations.slice(),this.userData=JSON.parse(JSON.stringify(e.userData)),!0===i)for(let i=0;i<e.children.length;i++){let r=e.children[i];this.add(r.clone())}return this}}r_.DEFAULT_UP=new ia(0,1,0),r_.DEFAULT_MATRIX_AUTO_UPDATE=!0,r_.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;let rx=new ia,ry=new ia,rM=new ia,rS=new ia,rb=new ia,rT=new ia,rE=new ia,rw=new ia,rA=new ia,rR=new ia,rC=new ib,rP=new ib,rI=new ib;class rL{constructor(e=new ia,i=new ia,r=new ia){this.a=e,this.b=i,this.c=r}static getNormal(e,i,r,n){n.subVectors(r,i),rx.subVectors(e,i),n.cross(rx);let a=n.lengthSq();return a>0?n.multiplyScalar(1/Math.sqrt(a)):n.set(0,0,0)}static getBarycoord(e,i,r,n,a){rx.subVectors(n,i),ry.subVectors(r,i),rM.subVectors(e,i);let s=rx.dot(rx),o=rx.dot(ry),l=rx.dot(rM),c=ry.dot(ry),h=ry.dot(rM),u=s*c-o*o;if(0===u)return a.set(0,0,0),null;let d=1/u,p=(c*l-o*h)*d,f=(s*h-o*l)*d;return a.set(1-p-f,f,p)}static containsPoint(e,i,r,n){return null!==this.getBarycoord(e,i,r,n,rS)&&rS.x>=0&&rS.y>=0&&rS.x+rS.y<=1}static getInterpolation(e,i,r,n,a,s,o,l){return null===this.getBarycoord(e,i,r,n,rS)?(l.x=0,l.y=0,"z"in l&&(l.z=0),"w"in l&&(l.w=0),null):(l.setScalar(0),l.addScaledVector(a,rS.x),l.addScaledVector(s,rS.y),l.addScaledVector(o,rS.z),l)}static getInterpolatedAttribute(e,i,r,n,a,s){return rC.setScalar(0),rP.setScalar(0),rI.setScalar(0),rC.fromBufferAttribute(e,i),rP.fromBufferAttribute(e,r),rI.fromBufferAttribute(e,n),s.setScalar(0),s.addScaledVector(rC,a.x),s.addScaledVector(rP,a.y),s.addScaledVector(rI,a.z),s}static isFrontFacing(e,i,r,n){return rx.subVectors(r,i),ry.subVectors(e,i),0>rx.cross(ry).dot(n)}set(e,i,r){return this.a.copy(e),this.b.copy(i),this.c.copy(r),this}setFromPointsAndIndices(e,i,r,n){return this.a.copy(e[i]),this.b.copy(e[r]),this.c.copy(e[n]),this}setFromAttributeAndIndices(e,i,r,n){return this.a.fromBufferAttribute(e,i),this.b.fromBufferAttribute(e,r),this.c.fromBufferAttribute(e,n),this}clone(){return new this.constructor().copy(this)}copy(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this}getArea(){return rx.subVectors(this.c,this.b),ry.subVectors(this.a,this.b),.5*rx.cross(ry).length()}getMidpoint(e){return e.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(e){return rL.getNormal(this.a,this.b,this.c,e)}getPlane(e){return e.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(e,i){return rL.getBarycoord(e,this.a,this.b,this.c,i)}getInterpolation(e,i,r,n,a){return rL.getInterpolation(e,this.a,this.b,this.c,i,r,n,a)}containsPoint(e){return rL.containsPoint(e,this.a,this.b,this.c)}isFrontFacing(e){return rL.isFrontFacing(this.a,this.b,this.c,e)}intersectsBox(e){return e.intersectsTriangle(this)}closestPointToPoint(e,i){let r,n,a=this.a,s=this.b,o=this.c;rb.subVectors(s,a),rT.subVectors(o,a),rw.subVectors(e,a);let l=rb.dot(rw),c=rT.dot(rw);if(l<=0&&c<=0)return i.copy(a);rA.subVectors(e,s);let h=rb.dot(rA),u=rT.dot(rA);if(h>=0&&u<=h)return i.copy(s);let d=l*u-h*c;if(d<=0&&l>=0&&h<=0)return r=l/(l-h),i.copy(a).addScaledVector(rb,r);rR.subVectors(e,o);let p=rb.dot(rR),f=rT.dot(rR);if(f>=0&&p<=f)return i.copy(o);let m=p*c-l*f;if(m<=0&&c>=0&&f<=0)return n=c/(c-f),i.copy(a).addScaledVector(rT,n);let g=h*f-p*u;if(g<=0&&u-h>=0&&p-f>=0)return rE.subVectors(o,s),n=(u-h)/(u-h+(p-f)),i.copy(s).addScaledVector(rE,n);let v=1/(g+m+d);return r=m*v,n=d*v,i.copy(a).addScaledVector(rb,r).addScaledVector(rT,n)}equals(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}}let rD={aliceblue:0xf0f8ff,antiquewhite:0xfaebd7,aqua:65535,aquamarine:8388564,azure:0xf0ffff,beige:0xf5f5dc,bisque:0xffe4c4,black:0,blanchedalmond:0xffebcd,blue:255,blueviolet:9055202,brown:0xa52a2a,burlywood:0xdeb887,cadetblue:6266528,chartreuse:8388352,chocolate:0xd2691e,coral:0xff7f50,cornflowerblue:6591981,cornsilk:0xfff8dc,crimson:0xdc143c,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:0xb8860b,darkgray:0xa9a9a9,darkgreen:25600,darkgrey:0xa9a9a9,darkkhaki:0xbdb76b,darkmagenta:9109643,darkolivegreen:5597999,darkorange:0xff8c00,darkorchid:0x9932cc,darkred:9109504,darksalmon:0xe9967a,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:0xff1493,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:0xb22222,floralwhite:0xfffaf0,forestgreen:2263842,fuchsia:0xff00ff,gainsboro:0xdcdcdc,ghostwhite:0xf8f8ff,gold:0xffd700,goldenrod:0xdaa520,gray:8421504,green:32768,greenyellow:0xadff2f,grey:8421504,honeydew:0xf0fff0,hotpink:0xff69b4,indianred:0xcd5c5c,indigo:4915330,ivory:0xfffff0,khaki:0xf0e68c,lavender:0xe6e6fa,lavenderblush:0xfff0f5,lawngreen:8190976,lemonchiffon:0xfffacd,lightblue:0xadd8e6,lightcoral:0xf08080,lightcyan:0xe0ffff,lightgoldenrodyellow:0xfafad2,lightgray:0xd3d3d3,lightgreen:9498256,lightgrey:0xd3d3d3,lightpink:0xffb6c1,lightsalmon:0xffa07a,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:0xb0c4de,lightyellow:0xffffe0,lime:65280,limegreen:3329330,linen:0xfaf0e6,magenta:0xff00ff,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:0xba55d3,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:0xc71585,midnightblue:1644912,mintcream:0xf5fffa,mistyrose:0xffe4e1,moccasin:0xffe4b5,navajowhite:0xffdead,navy:128,oldlace:0xfdf5e6,olive:8421376,olivedrab:7048739,orange:0xffa500,orangered:0xff4500,orchid:0xda70d6,palegoldenrod:0xeee8aa,palegreen:0x98fb98,paleturquoise:0xafeeee,palevioletred:0xdb7093,papayawhip:0xffefd5,peachpuff:0xffdab9,peru:0xcd853f,pink:0xffc0cb,plum:0xdda0dd,powderblue:0xb0e0e6,purple:8388736,rebeccapurple:6697881,red:0xff0000,rosybrown:0xbc8f8f,royalblue:4286945,saddlebrown:9127187,salmon:0xfa8072,sandybrown:0xf4a460,seagreen:3050327,seashell:0xfff5ee,sienna:0xa0522d,silver:0xc0c0c0,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:0xfffafa,springgreen:65407,steelblue:4620980,tan:0xd2b48c,teal:32896,thistle:0xd8bfd8,tomato:0xff6347,turquoise:4251856,violet:0xee82ee,wheat:0xf5deb3,white:0xffffff,whitesmoke:0xf5f5f5,yellow:0xffff00,yellowgreen:0x9acd32},rU={h:0,s:0,l:0},rN={h:0,s:0,l:0};function rO(e,i,r){return(r<0&&(r+=1),r>1&&(r-=1),r<1/6)?e+(i-e)*6*r:r<.5?i:r<2/3?e+(i-e)*6*(2/3-r):e}class rF{constructor(e,i,r){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(e,i,r)}set(e,i,r){return void 0===i&&void 0===r?e&&e.isColor?this.copy(e):"number"==typeof e?this.setHex(e):"string"==typeof e&&this.setStyle(e):this.setRGB(e,i,r),this}setScalar(e){return this.r=e,this.g=e,this.b=e,this}setHex(e,i=tI){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,id.colorSpaceToWorking(this,i),this}setRGB(e,i,r,n=id.workingColorSpace){return this.r=e,this.g=i,this.b=r,id.colorSpaceToWorking(this,n),this}setHSL(e,i,r,n=id.workingColorSpace){if(e=t8(e,1),i=t6(i,0,1),r=t6(r,0,1),0===i)this.r=this.g=this.b=r;else{let n=r<=.5?r*(1+i):r+i-r*i,a=2*r-n;this.r=rO(a,n,e+1/3),this.g=rO(a,n,e),this.b=rO(a,n,e-1/3)}return id.colorSpaceToWorking(this,n),this}setStyle(e,i=tI){let r;function n(i){void 0!==i&&1>parseFloat(i)&&tJ("Color: Alpha component of "+e+" will be ignored.")}if(r=/^(\w+)\(([^\)]*)\)/.exec(e)){let a,s=r[1],o=r[2];switch(s){case"rgb":case"rgba":if(a=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(o))return n(a[4]),this.setRGB(Math.min(255,parseInt(a[1],10))/255,Math.min(255,parseInt(a[2],10))/255,Math.min(255,parseInt(a[3],10))/255,i);if(a=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(o))return n(a[4]),this.setRGB(Math.min(100,parseInt(a[1],10))/100,Math.min(100,parseInt(a[2],10))/100,Math.min(100,parseInt(a[3],10))/100,i);break;case"hsl":case"hsla":if(a=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(o))return n(a[4]),this.setHSL(parseFloat(a[1])/360,parseFloat(a[2])/100,parseFloat(a[3])/100,i);break;default:tJ("Color: Unknown color model "+e)}}else if(r=/^\#([A-Fa-f\d]+)$/.exec(e)){let n=r[1],a=n.length;if(3===a)return this.setRGB(parseInt(n.charAt(0),16)/15,parseInt(n.charAt(1),16)/15,parseInt(n.charAt(2),16)/15,i);if(6===a)return this.setHex(parseInt(n,16),i);tJ("Color: Invalid hex color "+e)}else if(e&&e.length>0)return this.setColorName(e,i);return this}setColorName(e,i=tI){let r=rD[e.toLowerCase()];return void 0!==r?this.setHex(r,i):tJ("Color: Unknown color "+e),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copySRGBToLinear(e){return this.r=ip(e.r),this.g=ip(e.g),this.b=ip(e.b),this}copyLinearToSRGB(e){return this.r=im(e.r),this.g=im(e.g),this.b=im(e.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(e=tI){return id.workingToColorSpace(rB.copy(this),e),65536*Math.round(t6(255*rB.r,0,255))+256*Math.round(t6(255*rB.g,0,255))+Math.round(t6(255*rB.b,0,255))}getHexString(e=tI){return("000000"+this.getHex(e).toString(16)).slice(-6)}getHSL(e,i=id.workingColorSpace){let r,n;id.workingToColorSpace(rB.copy(this),i);let a=rB.r,s=rB.g,o=rB.b,l=Math.max(a,s,o),c=Math.min(a,s,o),h=(c+l)/2;if(c===l)r=0,n=0;else{let e=l-c;switch(n=h<=.5?e/(l+c):e/(2-l-c),l){case a:r=(s-o)/e+6*(s<o);break;case s:r=(o-a)/e+2;break;case o:r=(a-s)/e+4}r/=6}return e.h=r,e.s=n,e.l=h,e}getRGB(e,i=id.workingColorSpace){return id.workingToColorSpace(rB.copy(this),i),e.r=rB.r,e.g=rB.g,e.b=rB.b,e}getStyle(e=tI){id.workingToColorSpace(rB.copy(this),e);let i=rB.r,r=rB.g,n=rB.b;return e!==tI?`color(${e} ${i.toFixed(3)} ${r.toFixed(3)} ${n.toFixed(3)})`:`rgb(${Math.round(255*i)},${Math.round(255*r)},${Math.round(255*n)})`}offsetHSL(e,i,r){return this.getHSL(rU),this.setHSL(rU.h+e,rU.s+i,rU.l+r)}add(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addColors(e,i){return this.r=e.r+i.r,this.g=e.g+i.g,this.b=e.b+i.b,this}addScalar(e){return this.r+=e,this.g+=e,this.b+=e,this}sub(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this}multiply(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}lerp(e,i){return this.r+=(e.r-this.r)*i,this.g+=(e.g-this.g)*i,this.b+=(e.b-this.b)*i,this}lerpColors(e,i,r){return this.r=e.r+(i.r-e.r)*r,this.g=e.g+(i.g-e.g)*r,this.b=e.b+(i.b-e.b)*r,this}lerpHSL(e,i){this.getHSL(rU),e.getHSL(rN);let r=t9(rU.h,rN.h,i),n=t9(rU.s,rN.s,i),a=t9(rU.l,rN.l,i);return this.setHSL(r,n,a),this}setFromVector3(e){return this.r=e.x,this.g=e.y,this.b=e.z,this}applyMatrix3(e){let i=this.r,r=this.g,n=this.b,a=e.elements;return this.r=a[0]*i+a[3]*r+a[6]*n,this.g=a[1]*i+a[4]*r+a[7]*n,this.b=a[2]*i+a[5]*r+a[8]*n,this}equals(e){return e.r===this.r&&e.g===this.g&&e.b===this.b}fromArray(e,i=0){return this.r=e[i],this.g=e[i+1],this.b=e[i+2],this}toArray(e=[],i=0){return e[i]=this.r,e[i+1]=this.g,e[i+2]=this.b,e}fromBufferAttribute(e,i){return this.r=e.getX(i),this.g=e.getY(i),this.b=e.getZ(i),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}let rB=new rF;rF.NAMES=rD;let rz=0;class rk extends t0{constructor(){super(),this.isMaterial=!0,Object.defineProperty(this,"id",{value:rz++}),this.uuid=t5(),this.name="",this.type="Material",this.blending=b,this.side=x,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.alphaHash=!1,this.blendSrc=F,this.blendDst=B,this.blendEquation=R,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.blendColor=new rF(0,0,0),this.blendAlpha=0,this.depthFunc=Z,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=519,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=7680,this.stencilZFail=7680,this.stencilZPass=7680,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.forceSinglePass=!1,this.allowOverride=!0,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(e){this._alphaTest>0!=e>0&&this.version++,this._alphaTest=e}onBeforeRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(e){if(void 0!==e)for(let i in e){let r=e[i];if(void 0===r){tJ(`Material: parameter '${i}' has value of undefined.`);continue}let n=this[i];if(void 0===n){tJ(`Material: '${i}' is not a property of THREE.${this.type}.`);continue}n&&n.isColor?n.set(r):n&&n.isVector3&&r&&r.isVector3?n.copy(r):this[i]=r}}toJSON(e){let i=void 0===e||"string"==typeof e;i&&(e={textures:{},images:{}});let r={metadata:{version:4.7,type:"Material",generator:"Material.toJSON"}};function n(e){let i=[];for(let r in e){let n=e[r];delete n.metadata,i.push(n)}return i}if(r.uuid=this.uuid,r.type=this.type,""!==this.name&&(r.name=this.name),this.color&&this.color.isColor&&(r.color=this.color.getHex()),void 0!==this.roughness&&(r.roughness=this.roughness),void 0!==this.metalness&&(r.metalness=this.metalness),void 0!==this.sheen&&(r.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(r.sheenColor=this.sheenColor.getHex()),void 0!==this.sheenRoughness&&(r.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(r.emissive=this.emissive.getHex()),void 0!==this.emissiveIntensity&&1!==this.emissiveIntensity&&(r.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(r.specular=this.specular.getHex()),void 0!==this.specularIntensity&&(r.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(r.specularColor=this.specularColor.getHex()),void 0!==this.shininess&&(r.shininess=this.shininess),void 0!==this.clearcoat&&(r.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(r.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(r.clearcoatMap=this.clearcoatMap.toJSON(e).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(r.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(e).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(r.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(e).uuid,r.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),this.sheenColorMap&&this.sheenColorMap.isTexture&&(r.sheenColorMap=this.sheenColorMap.toJSON(e).uuid),this.sheenRoughnessMap&&this.sheenRoughnessMap.isTexture&&(r.sheenRoughnessMap=this.sheenRoughnessMap.toJSON(e).uuid),void 0!==this.dispersion&&(r.dispersion=this.dispersion),void 0!==this.iridescence&&(r.iridescence=this.iridescence),void 0!==this.iridescenceIOR&&(r.iridescenceIOR=this.iridescenceIOR),void 0!==this.iridescenceThicknessRange&&(r.iridescenceThicknessRange=this.iridescenceThicknessRange),this.iridescenceMap&&this.iridescenceMap.isTexture&&(r.iridescenceMap=this.iridescenceMap.toJSON(e).uuid),this.iridescenceThicknessMap&&this.iridescenceThicknessMap.isTexture&&(r.iridescenceThicknessMap=this.iridescenceThicknessMap.toJSON(e).uuid),void 0!==this.anisotropy&&(r.anisotropy=this.anisotropy),void 0!==this.anisotropyRotation&&(r.anisotropyRotation=this.anisotropyRotation),this.anisotropyMap&&this.anisotropyMap.isTexture&&(r.anisotropyMap=this.anisotropyMap.toJSON(e).uuid),this.map&&this.map.isTexture&&(r.map=this.map.toJSON(e).uuid),this.matcap&&this.matcap.isTexture&&(r.matcap=this.matcap.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(r.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(r.lightMap=this.lightMap.toJSON(e).uuid,r.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(r.aoMap=this.aoMap.toJSON(e).uuid,r.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(r.bumpMap=this.bumpMap.toJSON(e).uuid,r.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(r.normalMap=this.normalMap.toJSON(e).uuid,r.normalMapType=this.normalMapType,r.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(r.displacementMap=this.displacementMap.toJSON(e).uuid,r.displacementScale=this.displacementScale,r.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(r.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(r.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(r.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(r.specularMap=this.specularMap.toJSON(e).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(r.specularIntensityMap=this.specularIntensityMap.toJSON(e).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(r.specularColorMap=this.specularColorMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(r.envMap=this.envMap.toJSON(e).uuid,void 0!==this.combine&&(r.combine=this.combine)),void 0!==this.envMapRotation&&(r.envMapRotation=this.envMapRotation.toArray()),void 0!==this.envMapIntensity&&(r.envMapIntensity=this.envMapIntensity),void 0!==this.reflectivity&&(r.reflectivity=this.reflectivity),void 0!==this.refractionRatio&&(r.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(r.gradientMap=this.gradientMap.toJSON(e).uuid),void 0!==this.transmission&&(r.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(r.transmissionMap=this.transmissionMap.toJSON(e).uuid),void 0!==this.thickness&&(r.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(r.thicknessMap=this.thicknessMap.toJSON(e).uuid),void 0!==this.attenuationDistance&&this.attenuationDistance!==1/0&&(r.attenuationDistance=this.attenuationDistance),void 0!==this.attenuationColor&&(r.attenuationColor=this.attenuationColor.getHex()),void 0!==this.size&&(r.size=this.size),null!==this.shadowSide&&(r.shadowSide=this.shadowSide),void 0!==this.sizeAttenuation&&(r.sizeAttenuation=this.sizeAttenuation),this.blending!==b&&(r.blending=this.blending),this.side!==x&&(r.side=this.side),!0===this.vertexColors&&(r.vertexColors=!0),this.opacity<1&&(r.opacity=this.opacity),!0===this.transparent&&(r.transparent=!0),this.blendSrc!==F&&(r.blendSrc=this.blendSrc),this.blendDst!==B&&(r.blendDst=this.blendDst),this.blendEquation!==R&&(r.blendEquation=this.blendEquation),null!==this.blendSrcAlpha&&(r.blendSrcAlpha=this.blendSrcAlpha),null!==this.blendDstAlpha&&(r.blendDstAlpha=this.blendDstAlpha),null!==this.blendEquationAlpha&&(r.blendEquationAlpha=this.blendEquationAlpha),this.blendColor&&this.blendColor.isColor&&(r.blendColor=this.blendColor.getHex()),0!==this.blendAlpha&&(r.blendAlpha=this.blendAlpha),this.depthFunc!==Z&&(r.depthFunc=this.depthFunc),!1===this.depthTest&&(r.depthTest=this.depthTest),!1===this.depthWrite&&(r.depthWrite=this.depthWrite),!1===this.colorWrite&&(r.colorWrite=this.colorWrite),255!==this.stencilWriteMask&&(r.stencilWriteMask=this.stencilWriteMask),519!==this.stencilFunc&&(r.stencilFunc=this.stencilFunc),0!==this.stencilRef&&(r.stencilRef=this.stencilRef),255!==this.stencilFuncMask&&(r.stencilFuncMask=this.stencilFuncMask),7680!==this.stencilFail&&(r.stencilFail=this.stencilFail),7680!==this.stencilZFail&&(r.stencilZFail=this.stencilZFail),7680!==this.stencilZPass&&(r.stencilZPass=this.stencilZPass),!0===this.stencilWrite&&(r.stencilWrite=this.stencilWrite),void 0!==this.rotation&&0!==this.rotation&&(r.rotation=this.rotation),!0===this.polygonOffset&&(r.polygonOffset=!0),0!==this.polygonOffsetFactor&&(r.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(r.polygonOffsetUnits=this.polygonOffsetUnits),void 0!==this.linewidth&&1!==this.linewidth&&(r.linewidth=this.linewidth),void 0!==this.dashSize&&(r.dashSize=this.dashSize),void 0!==this.gapSize&&(r.gapSize=this.gapSize),void 0!==this.scale&&(r.scale=this.scale),!0===this.dithering&&(r.dithering=!0),this.alphaTest>0&&(r.alphaTest=this.alphaTest),!0===this.alphaHash&&(r.alphaHash=!0),!0===this.alphaToCoverage&&(r.alphaToCoverage=!0),!0===this.premultipliedAlpha&&(r.premultipliedAlpha=!0),!0===this.forceSinglePass&&(r.forceSinglePass=!0),!1===this.allowOverride&&(r.allowOverride=!1),!0===this.wireframe&&(r.wireframe=!0),this.wireframeLinewidth>1&&(r.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(r.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(r.wireframeLinejoin=this.wireframeLinejoin),!0===this.flatShading&&(r.flatShading=!0),!1===this.visible&&(r.visible=!1),!1===this.toneMapped&&(r.toneMapped=!1),!1===this.fog&&(r.fog=!1),Object.keys(this.userData).length>0&&(r.userData=this.userData),i){let i=n(e.textures),a=n(e.images);i.length>0&&(r.textures=i),a.length>0&&(r.images=a)}return r}clone(){return new this.constructor().copy(this)}copy(e){this.name=e.name,this.blending=e.blending,this.side=e.side,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.blendColor.copy(e.blendColor),this.blendAlpha=e.blendAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.stencilWriteMask=e.stencilWriteMask,this.stencilFunc=e.stencilFunc,this.stencilRef=e.stencilRef,this.stencilFuncMask=e.stencilFuncMask,this.stencilFail=e.stencilFail,this.stencilZFail=e.stencilZFail,this.stencilZPass=e.stencilZPass,this.stencilWrite=e.stencilWrite;let i=e.clippingPlanes,r=null;if(null!==i){let e=i.length;r=Array(e);for(let n=0;n!==e;++n)r[n]=i[n].clone()}return this.clippingPlanes=r,this.clipIntersection=e.clipIntersection,this.clipShadows=e.clipShadows,this.shadowSide=e.shadowSide,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.alphaHash=e.alphaHash,this.alphaToCoverage=e.alphaToCoverage,this.premultipliedAlpha=e.premultipliedAlpha,this.forceSinglePass=e.forceSinglePass,this.allowOverride=e.allowOverride,this.visible=e.visible,this.toneMapped=e.toneMapped,this.userData=JSON.parse(JSON.stringify(e.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(e){!0===e&&this.version++}}class rV extends rk{constructor(e){super(),this.isMeshBasicMaterial=!0,this.type="MeshBasicMaterial",this.color=new rF(0xffffff),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new rt,this.combine=ei,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.fog=e.fog,this}}let rH=new ia,rG=new ii,rW=0;class rX{constructor(e,i,r=!1){if(Array.isArray(e))throw TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,Object.defineProperty(this,"id",{value:rW++}),this.name="",this.array=e,this.itemSize=i,this.count=void 0!==e?e.length/i:0,this.normalized=r,this.usage=35044,this.updateRanges=[],this.gpuType=eU,this.version=0}onUploadCallback(){}set needsUpdate(e){!0===e&&this.version++}setUsage(e){return this.usage=e,this}addUpdateRange(e,i){this.updateRanges.push({start:e,count:i})}clearUpdateRanges(){this.updateRanges.length=0}copy(e){return this.name=e.name,this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.usage=e.usage,this.gpuType=e.gpuType,this}copyAt(e,i,r){e*=this.itemSize,r*=i.itemSize;for(let n=0,a=this.itemSize;n<a;n++)this.array[e+n]=i.array[r+n];return this}copyArray(e){return this.array.set(e),this}applyMatrix3(e){if(2===this.itemSize)for(let i=0,r=this.count;i<r;i++)rG.fromBufferAttribute(this,i),rG.applyMatrix3(e),this.setXY(i,rG.x,rG.y);else if(3===this.itemSize)for(let i=0,r=this.count;i<r;i++)rH.fromBufferAttribute(this,i),rH.applyMatrix3(e),this.setXYZ(i,rH.x,rH.y,rH.z);return this}applyMatrix4(e){for(let i=0,r=this.count;i<r;i++)rH.fromBufferAttribute(this,i),rH.applyMatrix4(e),this.setXYZ(i,rH.x,rH.y,rH.z);return this}applyNormalMatrix(e){for(let i=0,r=this.count;i<r;i++)rH.fromBufferAttribute(this,i),rH.applyNormalMatrix(e),this.setXYZ(i,rH.x,rH.y,rH.z);return this}transformDirection(e){for(let i=0,r=this.count;i<r;i++)rH.fromBufferAttribute(this,i),rH.transformDirection(e),this.setXYZ(i,rH.x,rH.y,rH.z);return this}set(e,i=0){return this.array.set(e,i),this}getComponent(e,i){let r=this.array[e*this.itemSize+i];return this.normalized&&(r=t7(r,this.array)),r}setComponent(e,i,r){return this.normalized&&(r=ie(r,this.array)),this.array[e*this.itemSize+i]=r,this}getX(e){let i=this.array[e*this.itemSize];return this.normalized&&(i=t7(i,this.array)),i}setX(e,i){return this.normalized&&(i=ie(i,this.array)),this.array[e*this.itemSize]=i,this}getY(e){let i=this.array[e*this.itemSize+1];return this.normalized&&(i=t7(i,this.array)),i}setY(e,i){return this.normalized&&(i=ie(i,this.array)),this.array[e*this.itemSize+1]=i,this}getZ(e){let i=this.array[e*this.itemSize+2];return this.normalized&&(i=t7(i,this.array)),i}setZ(e,i){return this.normalized&&(i=ie(i,this.array)),this.array[e*this.itemSize+2]=i,this}getW(e){let i=this.array[e*this.itemSize+3];return this.normalized&&(i=t7(i,this.array)),i}setW(e,i){return this.normalized&&(i=ie(i,this.array)),this.array[e*this.itemSize+3]=i,this}setXY(e,i,r){return e*=this.itemSize,this.normalized&&(i=ie(i,this.array),r=ie(r,this.array)),this.array[e+0]=i,this.array[e+1]=r,this}setXYZ(e,i,r,n){return e*=this.itemSize,this.normalized&&(i=ie(i,this.array),r=ie(r,this.array),n=ie(n,this.array)),this.array[e+0]=i,this.array[e+1]=r,this.array[e+2]=n,this}setXYZW(e,i,r,n,a){return e*=this.itemSize,this.normalized&&(i=ie(i,this.array),r=ie(r,this.array),n=ie(n,this.array),a=ie(a,this.array)),this.array[e+0]=i,this.array[e+1]=r,this.array[e+2]=n,this.array[e+3]=a,this}onUpload(e){return this.onUploadCallback=e,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){let e={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return""!==this.name&&(e.name=this.name),35044!==this.usage&&(e.usage=this.usage),e}}class rj extends rX{constructor(e,i,r){super(new Uint16Array(e),i,r)}}class rq extends rX{constructor(e,i,r){super(new Uint32Array(e),i,r)}}class rY extends rX{constructor(e,i,r){super(new Float32Array(e),i,r)}}let rK=0,rJ=new i1,rZ=new r_,rQ=new ia,r$=new iR,r0=new iR,r1=new ia;class r3 extends t0{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:rK++}),this.uuid=t5(),this.name="",this.type="BufferGeometry",this.index=null,this.indirect=null,this.indirectOffset=0,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(e){return Array.isArray(e)?this.index=new(tX(e)?rq:rj)(e,1):this.index=e,this}setIndirect(e,i=0){return this.indirect=e,this.indirectOffset=i,this}getIndirect(){return this.indirect}getAttribute(e){return this.attributes[e]}setAttribute(e,i){return this.attributes[e]=i,this}deleteAttribute(e){return delete this.attributes[e],this}hasAttribute(e){return void 0!==this.attributes[e]}addGroup(e,i,r=0){this.groups.push({start:e,count:i,materialIndex:r})}clearGroups(){this.groups=[]}setDrawRange(e,i){this.drawRange.start=e,this.drawRange.count=i}applyMatrix4(e){let i=this.attributes.position;void 0!==i&&(i.applyMatrix4(e),i.needsUpdate=!0);let r=this.attributes.normal;if(void 0!==r){let i=new il().getNormalMatrix(e);r.applyNormalMatrix(i),r.needsUpdate=!0}let n=this.attributes.tangent;return void 0!==n&&(n.transformDirection(e),n.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}applyQuaternion(e){return rJ.makeRotationFromQuaternion(e),this.applyMatrix4(rJ),this}rotateX(e){return rJ.makeRotationX(e),this.applyMatrix4(rJ),this}rotateY(e){return rJ.makeRotationY(e),this.applyMatrix4(rJ),this}rotateZ(e){return rJ.makeRotationZ(e),this.applyMatrix4(rJ),this}translate(e,i,r){return rJ.makeTranslation(e,i,r),this.applyMatrix4(rJ),this}scale(e,i,r){return rJ.makeScale(e,i,r),this.applyMatrix4(rJ),this}lookAt(e){return rZ.lookAt(e),rZ.updateMatrix(),this.applyMatrix4(rZ.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(rQ).negate(),this.translate(rQ.x,rQ.y,rQ.z),this}setFromPoints(e){let i=this.getAttribute("position");if(void 0===i){let i=[];for(let r=0,n=e.length;r<n;r++){let n=e[r];i.push(n.x,n.y,n.z||0)}this.setAttribute("position",new rY(i,3))}else{let r=Math.min(e.length,i.count);for(let n=0;n<r;n++){let r=e[n];i.setXYZ(n,r.x,r.y,r.z||0)}e.length>i.count&&tJ("BufferGeometry: Buffer size too small for points data. Use .dispose() and create a new geometry."),i.needsUpdate=!0}return this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new iR);let e=this.attributes.position,i=this.morphAttributes.position;if(e&&e.isGLBufferAttribute){tZ("BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box.",this),this.boundingBox.set(new ia(-1/0,-1/0,-1/0),new ia(Infinity,Infinity,Infinity));return}if(void 0!==e){if(this.boundingBox.setFromBufferAttribute(e),i)for(let e=0,r=i.length;e<r;e++){let r=i[e];r$.setFromBufferAttribute(r),this.morphTargetsRelative?(r1.addVectors(this.boundingBox.min,r$.min),this.boundingBox.expandByPoint(r1),r1.addVectors(this.boundingBox.max,r$.max),this.boundingBox.expandByPoint(r1)):(this.boundingBox.expandByPoint(r$.min),this.boundingBox.expandByPoint(r$.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&tZ('BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new ij);let e=this.attributes.position,i=this.morphAttributes.position;if(e&&e.isGLBufferAttribute){tZ("BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere.",this),this.boundingSphere.set(new ia,1/0);return}if(e){let r=this.boundingSphere.center;if(r$.setFromBufferAttribute(e),i)for(let e=0,r=i.length;e<r;e++){let r=i[e];r0.setFromBufferAttribute(r),this.morphTargetsRelative?(r1.addVectors(r$.min,r0.min),r$.expandByPoint(r1),r1.addVectors(r$.max,r0.max),r$.expandByPoint(r1)):(r$.expandByPoint(r0.min),r$.expandByPoint(r0.max))}r$.getCenter(r);let n=0;for(let i=0,a=e.count;i<a;i++)r1.fromBufferAttribute(e,i),n=Math.max(n,r.distanceToSquared(r1));if(i)for(let a=0,s=i.length;a<s;a++){let s=i[a],o=this.morphTargetsRelative;for(let i=0,a=s.count;i<a;i++)r1.fromBufferAttribute(s,i),o&&(rQ.fromBufferAttribute(e,i),r1.add(rQ)),n=Math.max(n,r.distanceToSquared(r1))}this.boundingSphere.radius=Math.sqrt(n),isNaN(this.boundingSphere.radius)&&tZ('BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}computeTangents(){let e=this.index,i=this.attributes;if(null===e||void 0===i.position||void 0===i.normal||void 0===i.uv)return void tZ("BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");let r=i.position,n=i.normal,a=i.uv;!1===this.hasAttribute("tangent")&&this.setAttribute("tangent",new rX(new Float32Array(4*r.count),4));let s=this.getAttribute("tangent"),o=[],l=[];for(let e=0;e<r.count;e++)o[e]=new ia,l[e]=new ia;let c=new ia,h=new ia,u=new ia,d=new ii,p=new ii,f=new ii,m=new ia,g=new ia,v=this.groups;0===v.length&&(v=[{start:0,count:e.count}]);for(let i=0,n=v.length;i<n;++i){let n=v[i],s=n.start,_=n.count;for(let i=s,n=s+_;i<n;i+=3)!function(e,i,n){c.fromBufferAttribute(r,e),h.fromBufferAttribute(r,i),u.fromBufferAttribute(r,n),d.fromBufferAttribute(a,e),p.fromBufferAttribute(a,i),f.fromBufferAttribute(a,n),h.sub(c),u.sub(c),p.sub(d),f.sub(d);let s=1/(p.x*f.y-f.x*p.y);isFinite(s)&&(m.copy(h).multiplyScalar(f.y).addScaledVector(u,-p.y).multiplyScalar(s),g.copy(u).multiplyScalar(p.x).addScaledVector(h,-f.x).multiplyScalar(s),o[e].add(m),o[i].add(m),o[n].add(m),l[e].add(g),l[i].add(g),l[n].add(g))}(e.getX(i+0),e.getX(i+1),e.getX(i+2))}let _=new ia,x=new ia,y=new ia,M=new ia;function S(e){y.fromBufferAttribute(n,e),M.copy(y);let i=o[e];_.copy(i),_.sub(y.multiplyScalar(y.dot(i))).normalize(),x.crossVectors(M,i);let r=x.dot(l[e]);s.setXYZW(e,_.x,_.y,_.z,r<0?-1:1)}for(let i=0,r=v.length;i<r;++i){let r=v[i],n=r.start,a=r.count;for(let i=n,r=n+a;i<r;i+=3)S(e.getX(i+0)),S(e.getX(i+1)),S(e.getX(i+2))}}computeVertexNormals(){let e=this.index,i=this.getAttribute("position");if(void 0!==i){let r=this.getAttribute("normal");if(void 0===r)r=new rX(new Float32Array(3*i.count),3),this.setAttribute("normal",r);else for(let e=0,i=r.count;e<i;e++)r.setXYZ(e,0,0,0);let n=new ia,a=new ia,s=new ia,o=new ia,l=new ia,c=new ia,h=new ia,u=new ia;if(e)for(let d=0,p=e.count;d<p;d+=3){let p=e.getX(d+0),f=e.getX(d+1),m=e.getX(d+2);n.fromBufferAttribute(i,p),a.fromBufferAttribute(i,f),s.fromBufferAttribute(i,m),h.subVectors(s,a),u.subVectors(n,a),h.cross(u),o.fromBufferAttribute(r,p),l.fromBufferAttribute(r,f),c.fromBufferAttribute(r,m),o.add(h),l.add(h),c.add(h),r.setXYZ(p,o.x,o.y,o.z),r.setXYZ(f,l.x,l.y,l.z),r.setXYZ(m,c.x,c.y,c.z)}else for(let e=0,o=i.count;e<o;e+=3)n.fromBufferAttribute(i,e+0),a.fromBufferAttribute(i,e+1),s.fromBufferAttribute(i,e+2),h.subVectors(s,a),u.subVectors(n,a),h.cross(u),r.setXYZ(e+0,h.x,h.y,h.z),r.setXYZ(e+1,h.x,h.y,h.z),r.setXYZ(e+2,h.x,h.y,h.z);this.normalizeNormals(),r.needsUpdate=!0}}normalizeNormals(){let e=this.attributes.normal;for(let i=0,r=e.count;i<r;i++)r1.fromBufferAttribute(e,i),r1.normalize(),e.setXYZ(i,r1.x,r1.y,r1.z)}toNonIndexed(){function e(e,i){let r=e.array,n=e.itemSize,a=e.normalized,s=new r.constructor(i.length*n),o=0,l=0;for(let a=0,c=i.length;a<c;a++){o=e.isInterleavedBufferAttribute?i[a]*e.data.stride+e.offset:i[a]*n;for(let e=0;e<n;e++)s[l++]=r[o++]}return new rX(s,n,a)}if(null===this.index)return tJ("BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;let i=new r3,r=this.index.array,n=this.attributes;for(let a in n){let s=e(n[a],r);i.setAttribute(a,s)}let a=this.morphAttributes;for(let n in a){let s=[],o=a[n];for(let i=0,n=o.length;i<n;i++){let n=e(o[i],r);s.push(n)}i.morphAttributes[n]=s}i.morphTargetsRelative=this.morphTargetsRelative;let s=this.groups;for(let e=0,r=s.length;e<r;e++){let r=s[e];i.addGroup(r.start,r.count,r.materialIndex)}return i}toJSON(){let e={metadata:{version:4.7,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),Object.keys(this.userData).length>0&&(e.userData=this.userData),void 0!==this.parameters){let i=this.parameters;for(let r in i)void 0!==i[r]&&(e[r]=i[r]);return e}e.data={attributes:{}};let i=this.index;null!==i&&(e.data.index={type:i.array.constructor.name,array:Array.prototype.slice.call(i.array)});let r=this.attributes;for(let i in r){let n=r[i];e.data.attributes[i]=n.toJSON(e.data)}let n={},a=!1;for(let i in this.morphAttributes){let r=this.morphAttributes[i],s=[];for(let i=0,n=r.length;i<n;i++){let n=r[i];s.push(n.toJSON(e.data))}s.length>0&&(n[i]=s,a=!0)}a&&(e.data.morphAttributes=n,e.data.morphTargetsRelative=this.morphTargetsRelative);let s=this.groups;s.length>0&&(e.data.groups=JSON.parse(JSON.stringify(s)));let o=this.boundingSphere;return null!==o&&(e.data.boundingSphere=o.toJSON()),e}clone(){return new this.constructor().copy(this)}copy(e){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;let i={};this.name=e.name;let r=e.index;null!==r&&this.setIndex(r.clone());let n=e.attributes;for(let e in n){let r=n[e];this.setAttribute(e,r.clone(i))}let a=e.morphAttributes;for(let e in a){let r=[],n=a[e];for(let e=0,a=n.length;e<a;e++)r.push(n[e].clone(i));this.morphAttributes[e]=r}this.morphTargetsRelative=e.morphTargetsRelative;let s=e.groups;for(let e=0,i=s.length;e<i;e++){let i=s[e];this.addGroup(i.start,i.count,i.materialIndex)}let o=e.boundingBox;null!==o&&(this.boundingBox=o.clone());let l=e.boundingSphere;return null!==l&&(this.boundingSphere=l.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this.userData=e.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}let r2=new i1,r4=new i0,r5=new ij,r6=new ia,r8=new ia,r9=new ia,r7=new ia,ne=new ia,nt=new ia,ni=new ia,nr=new ia;class nn extends r_{constructor(e=new r3,i=new rV){super(),this.isMesh=!0,this.type="Mesh",this.geometry=e,this.material=i,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.count=1,this.updateMorphTargets()}copy(e,i){return super.copy(e,i),void 0!==e.morphTargetInfluences&&(this.morphTargetInfluences=e.morphTargetInfluences.slice()),void 0!==e.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},e.morphTargetDictionary)),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}updateMorphTargets(){let e=this.geometry.morphAttributes,i=Object.keys(e);if(i.length>0){let r=e[i[0]];if(void 0!==r){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,i=r.length;e<i;e++){let i=r[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=e}}}}getVertexPosition(e,i){let r=this.geometry,n=r.attributes.position,a=r.morphAttributes.position,s=r.morphTargetsRelative;i.fromBufferAttribute(n,e);let o=this.morphTargetInfluences;if(a&&o){nt.set(0,0,0);for(let r=0,n=a.length;r<n;r++){let n=o[r],l=a[r];0!==n&&(ne.fromBufferAttribute(l,e),s?nt.addScaledVector(ne,n):nt.addScaledVector(ne.sub(i),n))}i.add(nt)}return i}raycast(e,i){let r=this.geometry,n=this.material,a=this.matrixWorld;void 0===n||(null===r.boundingSphere&&r.computeBoundingSphere(),r5.copy(r.boundingSphere),r5.applyMatrix4(a),r4.copy(e.ray).recast(e.near),!1===r5.containsPoint(r4.origin)&&(null===r4.intersectSphere(r5,r6)||r4.origin.distanceToSquared(r6)>(e.far-e.near)**2)||(r2.copy(a).invert(),r4.copy(e.ray).applyMatrix4(r2),(null===r.boundingBox||!1!==r4.intersectsBox(r.boundingBox))&&this._computeIntersections(e,i,r4)))}_computeIntersections(e,i,r){let n,a=this.geometry,s=this.material,o=a.index,l=a.attributes.position,c=a.attributes.uv,h=a.attributes.uv1,u=a.attributes.normal,d=a.groups,p=a.drawRange;if(null!==o)if(Array.isArray(s))for(let a=0,l=d.length;a<l;a++){let l=d[a],f=s[l.materialIndex],m=Math.max(l.start,p.start),g=Math.min(o.count,Math.min(l.start+l.count,p.start+p.count));for(let a=m;a<g;a+=3)(n=na(this,f,e,r,c,h,u,o.getX(a),o.getX(a+1),o.getX(a+2)))&&(n.faceIndex=Math.floor(a/3),n.face.materialIndex=l.materialIndex,i.push(n))}else{let a=Math.max(0,p.start),l=Math.min(o.count,p.start+p.count);for(let d=a;d<l;d+=3)(n=na(this,s,e,r,c,h,u,o.getX(d),o.getX(d+1),o.getX(d+2)))&&(n.faceIndex=Math.floor(d/3),i.push(n))}else if(void 0!==l)if(Array.isArray(s))for(let a=0,o=d.length;a<o;a++){let o=d[a],f=s[o.materialIndex],m=Math.max(o.start,p.start),g=Math.min(l.count,Math.min(o.start+o.count,p.start+p.count));for(let a=m;a<g;a+=3)(n=na(this,f,e,r,c,h,u,a,a+1,a+2))&&(n.faceIndex=Math.floor(a/3),n.face.materialIndex=o.materialIndex,i.push(n))}else{let a=Math.max(0,p.start),o=Math.min(l.count,p.start+p.count);for(let l=a;l<o;l+=3)(n=na(this,s,e,r,c,h,u,l,l+1,l+2))&&(n.faceIndex=Math.floor(l/3),i.push(n))}}}function na(e,i,r,n,a,s,o,l,c,h){e.getVertexPosition(l,r8),e.getVertexPosition(c,r9),e.getVertexPosition(h,r7);let u=function(e,i,r,n,a,s,o,l){if(null===(i.side===y?n.intersectTriangle(o,s,a,!0,l):n.intersectTriangle(a,s,o,i.side===x,l)))return null;nr.copy(l),nr.applyMatrix4(e.matrixWorld);let c=r.ray.origin.distanceTo(nr);return c<r.near||c>r.far?null:{distance:c,point:nr.clone(),object:e}}(e,i,r,n,r8,r9,r7,ni);if(u){let e=new ia;rL.getBarycoord(ni,r8,r9,r7,e),a&&(u.uv=rL.getInterpolatedAttribute(a,l,c,h,e,new ii)),s&&(u.uv1=rL.getInterpolatedAttribute(s,l,c,h,e,new ii)),o&&(u.normal=rL.getInterpolatedAttribute(o,l,c,h,e,new ia),u.normal.dot(n.direction)>0&&u.normal.multiplyScalar(-1));let i={a:l,b:c,c:h,normal:new ia,materialIndex:0};rL.getNormal(r8,r9,r7,i.normal),u.face=i,u.barycoord=e}return u}class ns extends r3{constructor(e=1,i=1,r=1,n=1,a=1,s=1){super(),this.type="BoxGeometry",this.parameters={width:e,height:i,depth:r,widthSegments:n,heightSegments:a,depthSegments:s};const o=this;n=Math.floor(n),a=Math.floor(a);const l=[],c=[],h=[],u=[];let d=0,p=0;function f(e,i,r,n,a,s,f,m,g,v,_){let x=s/g,y=f/v,M=s/2,S=f/2,b=m/2,T=g+1,E=v+1,w=0,A=0,R=new ia;for(let s=0;s<E;s++){let o=s*y-S;for(let l=0;l<T;l++){let d=l*x-M;R[e]=d*n,R[i]=o*a,R[r]=b,c.push(R.x,R.y,R.z),R[e]=0,R[i]=0,R[r]=m>0?1:-1,h.push(R.x,R.y,R.z),u.push(l/g),u.push(1-s/v),w+=1}}for(let e=0;e<v;e++)for(let i=0;i<g;i++){let r=d+i+T*e,n=d+i+T*(e+1),a=d+(i+1)+T*(e+1),s=d+(i+1)+T*e;l.push(r,n,s),l.push(n,a,s),A+=6}o.addGroup(p,A,_),p+=A,d+=w}f("z","y","x",-1,-1,r,i,e,s=Math.floor(s),a,0),f("z","y","x",1,-1,r,i,-e,s,a,1),f("x","z","y",1,1,e,r,i,n,s,2),f("x","z","y",1,-1,e,r,-i,n,s,3),f("x","y","z",1,-1,e,i,r,n,a,4),f("x","y","z",-1,-1,e,i,-r,n,a,5),this.setIndex(l),this.setAttribute("position",new rY(c,3)),this.setAttribute("normal",new rY(h,3)),this.setAttribute("uv",new rY(u,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new ns(e.width,e.height,e.depth,e.widthSegments,e.heightSegments,e.depthSegments)}}function no(e){let i={};for(let r in e)for(let n in i[r]={},e[r]){let a=e[r][n];a&&(a.isColor||a.isMatrix3||a.isMatrix4||a.isVector2||a.isVector3||a.isVector4||a.isTexture||a.isQuaternion)?a.isRenderTargetTexture?(tJ("UniformsUtils: Textures of render targets cannot be cloned via cloneUniforms() or mergeUniforms()."),i[r][n]=null):i[r][n]=a.clone():Array.isArray(a)?i[r][n]=a.slice():i[r][n]=a}return i}function nl(e){let i={};for(let r=0;r<e.length;r++){let n=no(e[r]);for(let e in n)i[e]=n[e]}return i}function nc(e){let i=e.getRenderTarget();return null===i?e.outputColorSpace:!0===i.isXRRenderTarget?i.texture.colorSpace:id.workingColorSpace}let nh={clone:no,merge:nl};var nu=`void main() {
	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
 }`,nd=`void main() {
	gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );
-}`;class np extends rk{constructor(e){super(),this.isShaderMaterial=!0,this.type="ShaderMaterial",this.defines={},this.uniforms={},this.uniformsGroups=[],this.vertexShader=nu,this.fragmentShader=nd,this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.forceSinglePass=!0,this.extensions={clipCullDistance:!1,multiDraw:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv1:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,void 0!==e&&this.setValues(e)}copy(e){return super.copy(e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=no(e.uniforms),this.uniformsGroups=function(e){let i=[];for(let r=0;r<e.length;r++)i.push(e[r].clone());return i}(e.uniformsGroups),this.defines=Object.assign({},e.defines),this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.fog=e.fog,this.lights=e.lights,this.clipping=e.clipping,this.extensions=Object.assign({},e.extensions),this.glslVersion=e.glslVersion,this.defaultAttributeValues=Object.assign({},e.defaultAttributeValues),this.index0AttributeName=e.index0AttributeName,this.uniformsNeedUpdate=e.uniformsNeedUpdate,this}toJSON(e){let i=super.toJSON(e);for(let r in i.glslVersion=this.glslVersion,i.uniforms={},this.uniforms){let n=this.uniforms[r].value;n&&n.isTexture?i.uniforms[r]={type:"t",value:n.toJSON(e).uuid}:n&&n.isColor?i.uniforms[r]={type:"c",value:n.getHex()}:n&&n.isVector2?i.uniforms[r]={type:"v2",value:n.toArray()}:n&&n.isVector3?i.uniforms[r]={type:"v3",value:n.toArray()}:n&&n.isVector4?i.uniforms[r]={type:"v4",value:n.toArray()}:n&&n.isMatrix3?i.uniforms[r]={type:"m3",value:n.toArray()}:n&&n.isMatrix4?i.uniforms[r]={type:"m4",value:n.toArray()}:i.uniforms[r]={value:n}}Object.keys(this.defines).length>0&&(i.defines=this.defines),i.vertexShader=this.vertexShader,i.fragmentShader=this.fragmentShader,i.lights=this.lights,i.clipping=this.clipping;let r={};for(let e in this.extensions)!0===this.extensions[e]&&(r[e]=!0);return Object.keys(r).length>0&&(i.extensions=r),i}}class nf extends r_{constructor(){super(),this.isCamera=!0,this.type="Camera",this.matrixWorldInverse=new i1,this.projectionMatrix=new i1,this.projectionMatrixInverse=new i1,this.coordinateSystem=tW,this._reversedDepth=!1}get reversedDepth(){return this._reversedDepth}copy(e,i){return super.copy(e,i),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this.projectionMatrixInverse.copy(e.projectionMatrixInverse),this.coordinateSystem=e.coordinateSystem,this}getWorldDirection(e){return super.getWorldDirection(e).negate()}updateMatrixWorld(e){super.updateMatrixWorld(e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(e,i){super.updateWorldMatrix(e,i),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return new this.constructor().copy(this)}}let nm=new ia,ng=new ii,nv=new ii;class n_ extends nf{constructor(e=50,i=1,r=.1,n=2e3){super(),this.isPerspectiveCamera=!0,this.type="PerspectiveCamera",this.fov=e,this.zoom=1,this.near=r,this.far=n,this.focus=10,this.aspect=i,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(e,i){return super.copy(e,i),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=null===e.view?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this}setFocalLength(e){let i=.5*this.getFilmHeight()/e;this.fov=2*t4*Math.atan(i),this.updateProjectionMatrix()}getFocalLength(){let e=Math.tan(.5*t2*this.fov);return .5*this.getFilmHeight()/e}getEffectiveFOV(){return 2*t4*Math.atan(Math.tan(.5*t2*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}getViewBounds(e,i,r){nm.set(-1,-1,.5).applyMatrix4(this.projectionMatrixInverse),i.set(nm.x,nm.y).multiplyScalar(-e/nm.z),nm.set(1,1,.5).applyMatrix4(this.projectionMatrixInverse),r.set(nm.x,nm.y).multiplyScalar(-e/nm.z)}getViewSize(e,i){return this.getViewBounds(e,ng,nv),i.subVectors(nv,ng)}setViewOffset(e,i,r,n,a,s){this.aspect=e/i,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=i,this.view.offsetX=r,this.view.offsetY=n,this.view.width=a,this.view.height=s,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){let e=this.near,i=e*Math.tan(.5*t2*this.fov)/this.zoom,r=2*i,n=this.aspect*r,a=-.5*n,s=this.view;if(null!==this.view&&this.view.enabled){let e=s.fullWidth,o=s.fullHeight;a+=s.offsetX*n/e,i-=s.offsetY*r/o,n*=s.width/e,r*=s.height/o}let o=this.filmOffset;0!==o&&(a+=e*o/this.getFilmWidth()),this.projectionMatrix.makePerspective(a,a+n,i,i-r,e,this.far,this.coordinateSystem,this.reversedDepth),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){let i=super.toJSON(e);return i.object.fov=this.fov,i.object.zoom=this.zoom,i.object.near=this.near,i.object.far=this.far,i.object.focus=this.focus,i.object.aspect=this.aspect,null!==this.view&&(i.object.view=Object.assign({},this.view)),i.object.filmGauge=this.filmGauge,i.object.filmOffset=this.filmOffset,i}}class ny extends r_{constructor(e,i,r){super(),this.type="CubeCamera",this.renderTarget=r,this.coordinateSystem=null,this.activeMipmapLevel=0;const n=new n_(-90,1,e,i);n.layers=this.layers,this.add(n);const a=new n_(-90,1,e,i);a.layers=this.layers,this.add(a);const s=new n_(-90,1,e,i);s.layers=this.layers,this.add(s);const o=new n_(-90,1,e,i);o.layers=this.layers,this.add(o);const l=new n_(-90,1,e,i);l.layers=this.layers,this.add(l);const c=new n_(-90,1,e,i);c.layers=this.layers,this.add(c)}updateCoordinateSystem(){let e=this.coordinateSystem,i=this.children.concat(),[r,n,a,s,o,l]=i;for(let e of i)this.remove(e);if(e===tW)r.up.set(0,1,0),r.lookAt(1,0,0),n.up.set(0,1,0),n.lookAt(-1,0,0),a.up.set(0,0,-1),a.lookAt(0,1,0),s.up.set(0,0,1),s.lookAt(0,-1,0),o.up.set(0,1,0),o.lookAt(0,0,1),l.up.set(0,1,0),l.lookAt(0,0,-1);else if(2001===e)r.up.set(0,-1,0),r.lookAt(-1,0,0),n.up.set(0,-1,0),n.lookAt(1,0,0),a.up.set(0,0,1),a.lookAt(0,1,0),s.up.set(0,0,-1),s.lookAt(0,-1,0),o.up.set(0,-1,0),o.lookAt(0,0,1),l.up.set(0,-1,0),l.lookAt(0,0,-1);else throw Error("THREE.CubeCamera.updateCoordinateSystem(): Invalid coordinate system: "+e);for(let e of i)this.add(e),e.updateMatrixWorld()}update(e,i){null===this.parent&&this.updateMatrixWorld();let{renderTarget:r,activeMipmapLevel:n}=this;this.coordinateSystem!==e.coordinateSystem&&(this.coordinateSystem=e.coordinateSystem,this.updateCoordinateSystem());let[a,s,o,l,c,h]=this.children,u=e.getRenderTarget(),d=e.getActiveCubeFace(),p=e.getActiveMipmapLevel(),f=e.xr.enabled;e.xr.enabled=!1;let m=r.texture.generateMipmaps;r.texture.generateMipmaps=!1,e.setRenderTarget(r,0,n),e.render(i,a),e.setRenderTarget(r,1,n),e.render(i,s),e.setRenderTarget(r,2,n),e.render(i,o),e.setRenderTarget(r,3,n),e.render(i,l),e.setRenderTarget(r,4,n),e.render(i,c),r.texture.generateMipmaps=m,e.setRenderTarget(r,5,n),e.render(i,h),e.setRenderTarget(u,d,p),e.xr.enabled=f,r.texture.needsPMREMUpdate=!0}}class nx extends iS{constructor(e=[],i=ef,r,n,a,s,o,l,c,h){super(e,i,r,n,a,s,o,l,c,h),this.isCubeTexture=!0,this.flipY=!1}get images(){return this.image}set images(e){this.image=e}}class nM extends iE{constructor(e=1,i={}){super(e,e,i),this.isWebGLCubeRenderTarget=!0;const r={width:e,height:e,depth:1};this.texture=new nx([r,r,r,r,r,r]),this._setTextureOptions(i),this.texture.isRenderTargetTexture=!0}fromEquirectangularTexture(e,i){this.texture.type=i.type,this.texture.colorSpace=i.colorSpace,this.texture.generateMipmaps=i.generateMipmaps,this.texture.minFilter=i.minFilter,this.texture.magFilter=i.magFilter;let r={uniforms:{tEquirect:{value:null}},vertexShader:`
+}`;class np extends rk{constructor(e){super(),this.isShaderMaterial=!0,this.type="ShaderMaterial",this.defines={},this.uniforms={},this.uniformsGroups=[],this.vertexShader=nu,this.fragmentShader=nd,this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.forceSinglePass=!0,this.extensions={clipCullDistance:!1,multiDraw:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv1:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,void 0!==e&&this.setValues(e)}copy(e){return super.copy(e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=no(e.uniforms),this.uniformsGroups=function(e){let i=[];for(let r=0;r<e.length;r++)i.push(e[r].clone());return i}(e.uniformsGroups),this.defines=Object.assign({},e.defines),this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.fog=e.fog,this.lights=e.lights,this.clipping=e.clipping,this.extensions=Object.assign({},e.extensions),this.glslVersion=e.glslVersion,this.defaultAttributeValues=Object.assign({},e.defaultAttributeValues),this.index0AttributeName=e.index0AttributeName,this.uniformsNeedUpdate=e.uniformsNeedUpdate,this}toJSON(e){let i=super.toJSON(e);for(let r in i.glslVersion=this.glslVersion,i.uniforms={},this.uniforms){let n=this.uniforms[r].value;n&&n.isTexture?i.uniforms[r]={type:"t",value:n.toJSON(e).uuid}:n&&n.isColor?i.uniforms[r]={type:"c",value:n.getHex()}:n&&n.isVector2?i.uniforms[r]={type:"v2",value:n.toArray()}:n&&n.isVector3?i.uniforms[r]={type:"v3",value:n.toArray()}:n&&n.isVector4?i.uniforms[r]={type:"v4",value:n.toArray()}:n&&n.isMatrix3?i.uniforms[r]={type:"m3",value:n.toArray()}:n&&n.isMatrix4?i.uniforms[r]={type:"m4",value:n.toArray()}:i.uniforms[r]={value:n}}Object.keys(this.defines).length>0&&(i.defines=this.defines),i.vertexShader=this.vertexShader,i.fragmentShader=this.fragmentShader,i.lights=this.lights,i.clipping=this.clipping;let r={};for(let e in this.extensions)!0===this.extensions[e]&&(r[e]=!0);return Object.keys(r).length>0&&(i.extensions=r),i}}class nf extends r_{constructor(){super(),this.isCamera=!0,this.type="Camera",this.matrixWorldInverse=new i1,this.projectionMatrix=new i1,this.projectionMatrixInverse=new i1,this.coordinateSystem=tW,this._reversedDepth=!1}get reversedDepth(){return this._reversedDepth}copy(e,i){return super.copy(e,i),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this.projectionMatrixInverse.copy(e.projectionMatrixInverse),this.coordinateSystem=e.coordinateSystem,this}getWorldDirection(e){return super.getWorldDirection(e).negate()}updateMatrixWorld(e){super.updateMatrixWorld(e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(e,i){super.updateWorldMatrix(e,i),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return new this.constructor().copy(this)}}let nm=new ia,ng=new ii,nv=new ii;class n_ extends nf{constructor(e=50,i=1,r=.1,n=2e3){super(),this.isPerspectiveCamera=!0,this.type="PerspectiveCamera",this.fov=e,this.zoom=1,this.near=r,this.far=n,this.focus=10,this.aspect=i,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(e,i){return super.copy(e,i),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=null===e.view?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this}setFocalLength(e){let i=.5*this.getFilmHeight()/e;this.fov=2*t4*Math.atan(i),this.updateProjectionMatrix()}getFocalLength(){let e=Math.tan(.5*t2*this.fov);return .5*this.getFilmHeight()/e}getEffectiveFOV(){return 2*t4*Math.atan(Math.tan(.5*t2*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}getViewBounds(e,i,r){nm.set(-1,-1,.5).applyMatrix4(this.projectionMatrixInverse),i.set(nm.x,nm.y).multiplyScalar(-e/nm.z),nm.set(1,1,.5).applyMatrix4(this.projectionMatrixInverse),r.set(nm.x,nm.y).multiplyScalar(-e/nm.z)}getViewSize(e,i){return this.getViewBounds(e,ng,nv),i.subVectors(nv,ng)}setViewOffset(e,i,r,n,a,s){this.aspect=e/i,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=i,this.view.offsetX=r,this.view.offsetY=n,this.view.width=a,this.view.height=s,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){let e=this.near,i=e*Math.tan(.5*t2*this.fov)/this.zoom,r=2*i,n=this.aspect*r,a=-.5*n,s=this.view;if(null!==this.view&&this.view.enabled){let e=s.fullWidth,o=s.fullHeight;a+=s.offsetX*n/e,i-=s.offsetY*r/o,n*=s.width/e,r*=s.height/o}let o=this.filmOffset;0!==o&&(a+=e*o/this.getFilmWidth()),this.projectionMatrix.makePerspective(a,a+n,i,i-r,e,this.far,this.coordinateSystem,this.reversedDepth),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){let i=super.toJSON(e);return i.object.fov=this.fov,i.object.zoom=this.zoom,i.object.near=this.near,i.object.far=this.far,i.object.focus=this.focus,i.object.aspect=this.aspect,null!==this.view&&(i.object.view=Object.assign({},this.view)),i.object.filmGauge=this.filmGauge,i.object.filmOffset=this.filmOffset,i}}class nx extends r_{constructor(e,i,r){super(),this.type="CubeCamera",this.renderTarget=r,this.coordinateSystem=null,this.activeMipmapLevel=0;const n=new n_(-90,1,e,i);n.layers=this.layers,this.add(n);const a=new n_(-90,1,e,i);a.layers=this.layers,this.add(a);const s=new n_(-90,1,e,i);s.layers=this.layers,this.add(s);const o=new n_(-90,1,e,i);o.layers=this.layers,this.add(o);const l=new n_(-90,1,e,i);l.layers=this.layers,this.add(l);const c=new n_(-90,1,e,i);c.layers=this.layers,this.add(c)}updateCoordinateSystem(){let e=this.coordinateSystem,i=this.children.concat(),[r,n,a,s,o,l]=i;for(let e of i)this.remove(e);if(e===tW)r.up.set(0,1,0),r.lookAt(1,0,0),n.up.set(0,1,0),n.lookAt(-1,0,0),a.up.set(0,0,-1),a.lookAt(0,1,0),s.up.set(0,0,1),s.lookAt(0,-1,0),o.up.set(0,1,0),o.lookAt(0,0,1),l.up.set(0,1,0),l.lookAt(0,0,-1);else if(2001===e)r.up.set(0,-1,0),r.lookAt(-1,0,0),n.up.set(0,-1,0),n.lookAt(1,0,0),a.up.set(0,0,1),a.lookAt(0,1,0),s.up.set(0,0,-1),s.lookAt(0,-1,0),o.up.set(0,-1,0),o.lookAt(0,0,1),l.up.set(0,-1,0),l.lookAt(0,0,-1);else throw Error("THREE.CubeCamera.updateCoordinateSystem(): Invalid coordinate system: "+e);for(let e of i)this.add(e),e.updateMatrixWorld()}update(e,i){null===this.parent&&this.updateMatrixWorld();let{renderTarget:r,activeMipmapLevel:n}=this;this.coordinateSystem!==e.coordinateSystem&&(this.coordinateSystem=e.coordinateSystem,this.updateCoordinateSystem());let[a,s,o,l,c,h]=this.children,u=e.getRenderTarget(),d=e.getActiveCubeFace(),p=e.getActiveMipmapLevel(),f=e.xr.enabled;e.xr.enabled=!1;let m=r.texture.generateMipmaps;r.texture.generateMipmaps=!1,e.setRenderTarget(r,0,n),e.render(i,a),e.setRenderTarget(r,1,n),e.render(i,s),e.setRenderTarget(r,2,n),e.render(i,o),e.setRenderTarget(r,3,n),e.render(i,l),e.setRenderTarget(r,4,n),e.render(i,c),r.texture.generateMipmaps=m,e.setRenderTarget(r,5,n),e.render(i,h),e.setRenderTarget(u,d,p),e.xr.enabled=f,r.texture.needsPMREMUpdate=!0}}class ny extends iS{constructor(e=[],i=ef,r,n,a,s,o,l,c,h){super(e,i,r,n,a,s,o,l,c,h),this.isCubeTexture=!0,this.flipY=!1}get images(){return this.image}set images(e){this.image=e}}class nM extends iE{constructor(e=1,i={}){super(e,e,i),this.isWebGLCubeRenderTarget=!0;const r={width:e,height:e,depth:1};this.texture=new ny([r,r,r,r,r,r]),this._setTextureOptions(i),this.texture.isRenderTargetTexture=!0}fromEquirectangularTexture(e,i){this.texture.type=i.type,this.texture.colorSpace=i.colorSpace,this.texture.generateMipmaps=i.generateMipmaps,this.texture.minFilter=i.minFilter,this.texture.magFilter=i.magFilter;let r={uniforms:{tEquirect:{value:null}},vertexShader:`

				varying vec3 vWorldDirection;

				vec3 transformDirection( in vec3 dir, in mat4 matrix ) {

@@ -36,11 +35,11 @@
					vec2 sampleUV = equirectUv( direction );

					gl_FragColor = texture2D( tEquirect, sampleUV );

				}
-			`},n=new ns(5,5,5),a=new np({name:"CubemapFromEquirect",uniforms:no(r.uniforms),vertexShader:r.vertexShader,fragmentShader:r.fragmentShader,side:x,blending:S});a.uniforms.tEquirect.value=i;let s=new nn(n,a),o=i.minFilter;return i.minFilter===eA&&(i.minFilter=eE),new ny(1,10,this).update(e,s),i.minFilter=o,s.geometry.dispose(),s.material.dispose(),this}clear(e,i=!0,r=!0,n=!0){let a=e.getRenderTarget();for(let a=0;a<6;a++)e.setRenderTarget(this,a),e.clear(i,r,n);e.setRenderTarget(a)}}class nS extends r_{constructor(){super(),this.isGroup=!0,this.type="Group"}}let nb={type:"move"};class nT{constructor(){this._targetRay=null,this._grip=null,this._hand=null}getHandSpace(){return null===this._hand&&(this._hand=new nS,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand}getTargetRaySpace(){return null===this._targetRay&&(this._targetRay=new nS,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1,this._targetRay.hasLinearVelocity=!1,this._targetRay.linearVelocity=new ia,this._targetRay.hasAngularVelocity=!1,this._targetRay.angularVelocity=new ia),this._targetRay}getGripSpace(){return null===this._grip&&(this._grip=new nS,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1,this._grip.hasLinearVelocity=!1,this._grip.linearVelocity=new ia,this._grip.hasAngularVelocity=!1,this._grip.angularVelocity=new ia),this._grip}dispatchEvent(e){return null!==this._targetRay&&this._targetRay.dispatchEvent(e),null!==this._grip&&this._grip.dispatchEvent(e),null!==this._hand&&this._hand.dispatchEvent(e),this}connect(e){if(e&&e.hand){let i=this._hand;if(i)for(let r of e.hand.values())this._getHandJoint(i,r)}return this.dispatchEvent({type:"connected",data:e}),this}disconnect(e){return this.dispatchEvent({type:"disconnected",data:e}),null!==this._targetRay&&(this._targetRay.visible=!1),null!==this._grip&&(this._grip.visible=!1),null!==this._hand&&(this._hand.visible=!1),this}update(e,i,r){let n=null,a=null,s=null,o=this._targetRay,l=this._grip,c=this._hand;if(e&&"visible-blurred"!==i.session.visibilityState){if(c&&e.hand){for(let n of(s=!0,e.hand.values())){let e=i.getJointPose(n,r),a=this._getHandJoint(c,n);null!==e&&(a.matrix.fromArray(e.transform.matrix),a.matrix.decompose(a.position,a.rotation,a.scale),a.matrixWorldNeedsUpdate=!0,a.jointRadius=e.radius),a.visible=null!==e}let n=c.joints["index-finger-tip"],a=c.joints["thumb-tip"],o=n.position.distanceTo(a.position);c.inputState.pinching&&o>.025?(c.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:e.handedness,target:this})):!c.inputState.pinching&&o<=.015&&(c.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:e.handedness,target:this}))}else null!==l&&e.gripSpace&&null!==(a=i.getPose(e.gripSpace,r))&&(l.matrix.fromArray(a.transform.matrix),l.matrix.decompose(l.position,l.rotation,l.scale),l.matrixWorldNeedsUpdate=!0,a.linearVelocity?(l.hasLinearVelocity=!0,l.linearVelocity.copy(a.linearVelocity)):l.hasLinearVelocity=!1,a.angularVelocity?(l.hasAngularVelocity=!0,l.angularVelocity.copy(a.angularVelocity)):l.hasAngularVelocity=!1);null!==o&&(null===(n=i.getPose(e.targetRaySpace,r))&&null!==a&&(n=a),null!==n&&(o.matrix.fromArray(n.transform.matrix),o.matrix.decompose(o.position,o.rotation,o.scale),o.matrixWorldNeedsUpdate=!0,n.linearVelocity?(o.hasLinearVelocity=!0,o.linearVelocity.copy(n.linearVelocity)):o.hasLinearVelocity=!1,n.angularVelocity?(o.hasAngularVelocity=!0,o.angularVelocity.copy(n.angularVelocity)):o.hasAngularVelocity=!1,this.dispatchEvent(nb)))}return null!==o&&(o.visible=null!==n),null!==l&&(l.visible=null!==a),null!==c&&(c.visible=null!==s),this}_getHandJoint(e,i){if(void 0===e.joints[i.jointName]){let r=new nS;r.matrixAutoUpdate=!1,r.visible=!1,e.joints[i.jointName]=r,e.add(r)}return e.joints[i.jointName]}}class nE extends r_{constructor(){super(),this.isScene=!0,this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.backgroundBlurriness=0,this.backgroundIntensity=1,this.backgroundRotation=new rt,this.environmentIntensity=1,this.environmentRotation=new rt,this.overrideMaterial=null,"u">typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(e,i){return super.copy(e,i),null!==e.background&&(this.background=e.background.clone()),null!==e.environment&&(this.environment=e.environment.clone()),null!==e.fog&&(this.fog=e.fog.clone()),this.backgroundBlurriness=e.backgroundBlurriness,this.backgroundIntensity=e.backgroundIntensity,this.backgroundRotation.copy(e.backgroundRotation),this.environmentIntensity=e.environmentIntensity,this.environmentRotation.copy(e.environmentRotation),null!==e.overrideMaterial&&(this.overrideMaterial=e.overrideMaterial.clone()),this.matrixAutoUpdate=e.matrixAutoUpdate,this}toJSON(e){let i=super.toJSON(e);return null!==this.fog&&(i.object.fog=this.fog.toJSON()),this.backgroundBlurriness>0&&(i.object.backgroundBlurriness=this.backgroundBlurriness),1!==this.backgroundIntensity&&(i.object.backgroundIntensity=this.backgroundIntensity),i.object.backgroundRotation=this.backgroundRotation.toArray(),1!==this.environmentIntensity&&(i.object.environmentIntensity=this.environmentIntensity),i.object.environmentRotation=this.environmentRotation.toArray(),i}}class nw{constructor(e,i){this.isInterleavedBuffer=!0,this.array=e,this.stride=i,this.count=void 0!==e?e.length/i:0,this.usage=35044,this.updateRanges=[],this.version=0,this.uuid=t5()}onUploadCallback(){}set needsUpdate(e){!0===e&&this.version++}setUsage(e){return this.usage=e,this}addUpdateRange(e,i){this.updateRanges.push({start:e,count:i})}clearUpdateRanges(){this.updateRanges.length=0}copy(e){return this.array=new e.array.constructor(e.array),this.count=e.count,this.stride=e.stride,this.usage=e.usage,this}copyAt(e,i,r){e*=this.stride,r*=i.stride;for(let n=0,a=this.stride;n<a;n++)this.array[e+n]=i.array[r+n];return this}set(e,i=0){return this.array.set(e,i),this}clone(e){void 0===e.arrayBuffers&&(e.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=t5()),void 0===e.arrayBuffers[this.array.buffer._uuid]&&(e.arrayBuffers[this.array.buffer._uuid]=this.array.slice(0).buffer);let i=new this.array.constructor(e.arrayBuffers[this.array.buffer._uuid]),r=new this.constructor(i,this.stride);return r.setUsage(this.usage),r}onUpload(e){return this.onUploadCallback=e,this}toJSON(e){return void 0===e.arrayBuffers&&(e.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=t5()),void 0===e.arrayBuffers[this.array.buffer._uuid]&&(e.arrayBuffers[this.array.buffer._uuid]=Array.from(new Uint32Array(this.array.buffer))),{uuid:this.uuid,buffer:this.array.buffer._uuid,type:this.array.constructor.name,stride:this.stride}}}let nA=new ia;class nR{constructor(e,i,r,n=!1){this.isInterleavedBufferAttribute=!0,this.name="",this.data=e,this.itemSize=i,this.offset=r,this.normalized=n}get count(){return this.data.count}get array(){return this.data.array}set needsUpdate(e){this.data.needsUpdate=e}applyMatrix4(e){for(let i=0,r=this.data.count;i<r;i++)nA.fromBufferAttribute(this,i),nA.applyMatrix4(e),this.setXYZ(i,nA.x,nA.y,nA.z);return this}applyNormalMatrix(e){for(let i=0,r=this.count;i<r;i++)nA.fromBufferAttribute(this,i),nA.applyNormalMatrix(e),this.setXYZ(i,nA.x,nA.y,nA.z);return this}transformDirection(e){for(let i=0,r=this.count;i<r;i++)nA.fromBufferAttribute(this,i),nA.transformDirection(e),this.setXYZ(i,nA.x,nA.y,nA.z);return this}getComponent(e,i){let r=this.array[e*this.data.stride+this.offset+i];return this.normalized&&(r=t7(r,this.array)),r}setComponent(e,i,r){return this.normalized&&(r=ie(r,this.array)),this.data.array[e*this.data.stride+this.offset+i]=r,this}setX(e,i){return this.normalized&&(i=ie(i,this.array)),this.data.array[e*this.data.stride+this.offset]=i,this}setY(e,i){return this.normalized&&(i=ie(i,this.array)),this.data.array[e*this.data.stride+this.offset+1]=i,this}setZ(e,i){return this.normalized&&(i=ie(i,this.array)),this.data.array[e*this.data.stride+this.offset+2]=i,this}setW(e,i){return this.normalized&&(i=ie(i,this.array)),this.data.array[e*this.data.stride+this.offset+3]=i,this}getX(e){let i=this.data.array[e*this.data.stride+this.offset];return this.normalized&&(i=t7(i,this.array)),i}getY(e){let i=this.data.array[e*this.data.stride+this.offset+1];return this.normalized&&(i=t7(i,this.array)),i}getZ(e){let i=this.data.array[e*this.data.stride+this.offset+2];return this.normalized&&(i=t7(i,this.array)),i}getW(e){let i=this.data.array[e*this.data.stride+this.offset+3];return this.normalized&&(i=t7(i,this.array)),i}setXY(e,i,r){return e=e*this.data.stride+this.offset,this.normalized&&(i=ie(i,this.array),r=ie(r,this.array)),this.data.array[e+0]=i,this.data.array[e+1]=r,this}setXYZ(e,i,r,n){return e=e*this.data.stride+this.offset,this.normalized&&(i=ie(i,this.array),r=ie(r,this.array),n=ie(n,this.array)),this.data.array[e+0]=i,this.data.array[e+1]=r,this.data.array[e+2]=n,this}setXYZW(e,i,r,n,a){return e=e*this.data.stride+this.offset,this.normalized&&(i=ie(i,this.array),r=ie(r,this.array),n=ie(n,this.array),a=ie(a,this.array)),this.data.array[e+0]=i,this.data.array[e+1]=r,this.data.array[e+2]=n,this.data.array[e+3]=a,this}clone(e){if(void 0!==e)return void 0===e.interleavedBuffers&&(e.interleavedBuffers={}),void 0===e.interleavedBuffers[this.data.uuid]&&(e.interleavedBuffers[this.data.uuid]=this.data.clone(e)),new nR(e.interleavedBuffers[this.data.uuid],this.itemSize,this.offset,this.normalized);{tK("InterleavedBufferAttribute.clone(): Cloning an interleaved buffer attribute will de-interleave buffer data.");let e=[];for(let i=0;i<this.count;i++){let r=i*this.data.stride+this.offset;for(let i=0;i<this.itemSize;i++)e.push(this.data.array[r+i])}return new rX(new this.array.constructor(e),this.itemSize,this.normalized)}}toJSON(e){if(void 0!==e)return void 0===e.interleavedBuffers&&(e.interleavedBuffers={}),void 0===e.interleavedBuffers[this.data.uuid]&&(e.interleavedBuffers[this.data.uuid]=this.data.toJSON(e)),{isInterleavedBufferAttribute:!0,itemSize:this.itemSize,data:this.data.uuid,offset:this.offset,normalized:this.normalized};{tK("InterleavedBufferAttribute.toJSON(): Serializing an interleaved buffer attribute will de-interleave buffer data.");let e=[];for(let i=0;i<this.count;i++){let r=i*this.data.stride+this.offset;for(let i=0;i<this.itemSize;i++)e.push(this.data.array[r+i])}return{itemSize:this.itemSize,type:this.array.constructor.name,array:e,normalized:this.normalized}}}}let nC=new ia,nP=new ib,nI=new ib,nL=new ia,nD=new i1,nU=new ia,nN=new ij,nO=new i1,nF=new i0;class nB extends nn{constructor(e,i){super(e,i),this.isSkinnedMesh=!0,this.type="SkinnedMesh",this.bindMode=ep,this.bindMatrix=new i1,this.bindMatrixInverse=new i1,this.boundingBox=null,this.boundingSphere=null}computeBoundingBox(){let e=this.geometry;null===this.boundingBox&&(this.boundingBox=new iR),this.boundingBox.makeEmpty();let i=e.getAttribute("position");for(let e=0;e<i.count;e++)this.getVertexPosition(e,nU),this.boundingBox.expandByPoint(nU)}computeBoundingSphere(){let e=this.geometry;null===this.boundingSphere&&(this.boundingSphere=new ij),this.boundingSphere.makeEmpty();let i=e.getAttribute("position");for(let e=0;e<i.count;e++)this.getVertexPosition(e,nU),this.boundingSphere.expandByPoint(nU)}copy(e,i){return super.copy(e,i),this.bindMode=e.bindMode,this.bindMatrix.copy(e.bindMatrix),this.bindMatrixInverse.copy(e.bindMatrixInverse),this.skeleton=e.skeleton,null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this}raycast(e,i){let r=this.material,n=this.matrixWorld;void 0===r||(null===this.boundingSphere&&this.computeBoundingSphere(),nN.copy(this.boundingSphere),nN.applyMatrix4(n),!1===e.ray.intersectsSphere(nN)||(nO.copy(n).invert(),nF.copy(e.ray).applyMatrix4(nO),(null===this.boundingBox||!1!==nF.intersectsBox(this.boundingBox))&&this._computeIntersections(e,i,nF)))}getVertexPosition(e,i){return super.getVertexPosition(e,i),this.applyBoneTransform(e,i),i}bind(e,i){this.skeleton=e,void 0===i&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),i=this.matrixWorld),this.bindMatrix.copy(i),this.bindMatrixInverse.copy(i).invert()}pose(){this.skeleton.pose()}normalizeSkinWeights(){let e=new ib,i=this.geometry.attributes.skinWeight;for(let r=0,n=i.count;r<n;r++){e.fromBufferAttribute(i,r);let n=1/e.manhattanLength();n!==1/0?e.multiplyScalar(n):e.set(1,0,0,0),i.setXYZW(r,e.x,e.y,e.z,e.w)}}updateMatrixWorld(e){super.updateMatrixWorld(e),this.bindMode===ep?this.bindMatrixInverse.copy(this.matrixWorld).invert():"detached"===this.bindMode?this.bindMatrixInverse.copy(this.bindMatrix).invert():tJ("SkinnedMesh: Unrecognized bindMode: "+this.bindMode)}applyBoneTransform(e,i){let r=this.skeleton,n=this.geometry;nP.fromBufferAttribute(n.attributes.skinIndex,e),nI.fromBufferAttribute(n.attributes.skinWeight,e),nC.copy(i).applyMatrix4(this.bindMatrix),i.set(0,0,0);for(let e=0;e<4;e++){let n=nI.getComponent(e);if(0!==n){let a=nP.getComponent(e);nD.multiplyMatrices(r.bones[a].matrixWorld,r.boneInverses[a]),i.addScaledVector(nL.copy(nC).applyMatrix4(nD),n)}}return i.applyMatrix4(this.bindMatrixInverse)}}class nz extends r_{constructor(){super(),this.isBone=!0,this.type="Bone"}}class nk extends iS{constructor(e=null,i=1,r=1,n,a,s,o,l,c=eS,h=eS,u,d){super(null,s,o,l,c,h,n,a,u,d),this.isDataTexture=!0,this.image={data:e,width:i,height:r},this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}let nV=new i1,nH=new i1;class nG{constructor(e=[],i=[]){this.uuid=t5(),this.bones=e.slice(0),this.boneInverses=i,this.boneMatrices=null,this.previousBoneMatrices=null,this.boneTexture=null,this.init()}init(){let e=this.bones,i=this.boneInverses;if(this.boneMatrices=new Float32Array(16*e.length),0===i.length)this.calculateInverses();else if(e.length!==i.length){tJ("Skeleton: Number of inverse bone matrices does not match amount of bones."),this.boneInverses=[];for(let e=0,i=this.bones.length;e<i;e++)this.boneInverses.push(new i1)}}calculateInverses(){this.boneInverses.length=0;for(let e=0,i=this.bones.length;e<i;e++){let i=new i1;this.bones[e]&&i.copy(this.bones[e].matrixWorld).invert(),this.boneInverses.push(i)}}pose(){for(let e=0,i=this.bones.length;e<i;e++){let i=this.bones[e];i&&i.matrixWorld.copy(this.boneInverses[e]).invert()}for(let e=0,i=this.bones.length;e<i;e++){let i=this.bones[e];i&&(i.parent&&i.parent.isBone?(i.matrix.copy(i.parent.matrixWorld).invert(),i.matrix.multiply(i.matrixWorld)):i.matrix.copy(i.matrixWorld),i.matrix.decompose(i.position,i.quaternion,i.scale))}}update(){let e=this.bones,i=this.boneInverses,r=this.boneMatrices,n=this.boneTexture;for(let n=0,a=e.length;n<a;n++){let a=e[n]?e[n].matrixWorld:nH;nV.multiplyMatrices(a,i[n]),nV.toArray(r,16*n)}null!==n&&(n.needsUpdate=!0)}clone(){return new nG(this.bones,this.boneInverses)}computeBoneTexture(){let e=Math.sqrt(4*this.bones.length),i=new Float32Array((e=Math.max(e=4*Math.ceil(e/4),4))*e*4);i.set(this.boneMatrices);let r=new nk(i,e,e,eG,eU);return r.needsUpdate=!0,this.boneMatrices=i,this.boneTexture=r,this}getBoneByName(e){for(let i=0,r=this.bones.length;i<r;i++){let r=this.bones[i];if(r.name===e)return r}}dispose(){null!==this.boneTexture&&(this.boneTexture.dispose(),this.boneTexture=null)}fromJSON(e,i){this.uuid=e.uuid;for(let r=0,n=e.bones.length;r<n;r++){let n=e.bones[r],a=i[n];void 0===a&&(tJ("Skeleton: No bone found with UUID:",n),a=new nz),this.bones.push(a),this.boneInverses.push(new i1().fromArray(e.boneInverses[r]))}return this.init(),this}toJSON(){let e={metadata:{version:4.7,type:"Skeleton",generator:"Skeleton.toJSON"},bones:[],boneInverses:[]};e.uuid=this.uuid;let i=this.bones,r=this.boneInverses;for(let n=0,a=i.length;n<a;n++){let a=i[n];e.bones.push(a.uuid);let s=r[n];e.boneInverses.push(s.toArray())}return e}}class nW extends rX{constructor(e,i,r,n=1){super(e,i,r),this.isInstancedBufferAttribute=!0,this.meshPerAttribute=n}copy(e){return super.copy(e),this.meshPerAttribute=e.meshPerAttribute,this}toJSON(){let e=super.toJSON();return e.meshPerAttribute=this.meshPerAttribute,e.isInstancedBufferAttribute=!0,e}}let nX=new i1,nj=new i1,nq=[],nY=new iR,nK=new i1,nJ=new nn,nZ=new ij;class nQ extends nn{constructor(e,i,r){super(e,i),this.isInstancedMesh=!0,this.instanceMatrix=new nW(new Float32Array(16*r),16),this.instanceColor=null,this.morphTexture=null,this.count=r,this.boundingBox=null,this.boundingSphere=null;for(let e=0;e<r;e++)this.setMatrixAt(e,nK)}computeBoundingBox(){let e=this.geometry,i=this.count;null===this.boundingBox&&(this.boundingBox=new iR),null===e.boundingBox&&e.computeBoundingBox(),this.boundingBox.makeEmpty();for(let r=0;r<i;r++)this.getMatrixAt(r,nX),nY.copy(e.boundingBox).applyMatrix4(nX),this.boundingBox.union(nY)}computeBoundingSphere(){let e=this.geometry,i=this.count;null===this.boundingSphere&&(this.boundingSphere=new ij),null===e.boundingSphere&&e.computeBoundingSphere(),this.boundingSphere.makeEmpty();for(let r=0;r<i;r++)this.getMatrixAt(r,nX),nZ.copy(e.boundingSphere).applyMatrix4(nX),this.boundingSphere.union(nZ)}copy(e,i){return super.copy(e,i),this.instanceMatrix.copy(e.instanceMatrix),null!==e.morphTexture&&(this.morphTexture=e.morphTexture.clone()),null!==e.instanceColor&&(this.instanceColor=e.instanceColor.clone()),this.count=e.count,null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this}getColorAt(e,i){i.fromArray(this.instanceColor.array,3*e)}getMatrixAt(e,i){i.fromArray(this.instanceMatrix.array,16*e)}getMorphAt(e,i){let r=i.morphTargetInfluences,n=this.morphTexture.source.data.data,a=e*(r.length+1)+1;for(let e=0;e<r.length;e++)r[e]=n[a+e]}raycast(e,i){let r=this.matrixWorld,n=this.count;if((nJ.geometry=this.geometry,nJ.material=this.material,void 0!==nJ.material)&&(null===this.boundingSphere&&this.computeBoundingSphere(),nZ.copy(this.boundingSphere),nZ.applyMatrix4(r),!1!==e.ray.intersectsSphere(nZ)))for(let a=0;a<n;a++){this.getMatrixAt(a,nX),nj.multiplyMatrices(r,nX),nJ.matrixWorld=nj,nJ.raycast(e,nq);for(let e=0,r=nq.length;e<r;e++){let r=nq[e];r.instanceId=a,r.object=this,i.push(r)}nq.length=0}}setColorAt(e,i){null===this.instanceColor&&(this.instanceColor=new nW(new Float32Array(3*this.instanceMatrix.count).fill(1),3)),i.toArray(this.instanceColor.array,3*e)}setMatrixAt(e,i){i.toArray(this.instanceMatrix.array,16*e)}setMorphAt(e,i){let r=i.morphTargetInfluences,n=r.length+1;null===this.morphTexture&&(this.morphTexture=new nk(new Float32Array(n*this.count),n,this.count,ej,eU));let a=this.morphTexture.source.data.data,s=0;for(let e=0;e<r.length;e++)s+=r[e];let o=this.geometry.morphTargetsRelative?1:1-s,l=n*e;a[l]=o,a.set(r,l+1)}updateMorphTargets(){}dispose(){this.dispatchEvent({type:"dispose"}),null!==this.morphTexture&&(this.morphTexture.dispose(),this.morphTexture=null)}}let n$=new ia,n0=new ia,n1=new il;class n3{constructor(e=new ia(1,0,0),i=0){this.isPlane=!0,this.normal=e,this.constant=i}set(e,i){return this.normal.copy(e),this.constant=i,this}setComponents(e,i,r,n){return this.normal.set(e,i,r),this.constant=n,this}setFromNormalAndCoplanarPoint(e,i){return this.normal.copy(e),this.constant=-i.dot(this.normal),this}setFromCoplanarPoints(e,i,r){let n=n$.subVectors(r,i).cross(n0.subVectors(e,i)).normalize();return this.setFromNormalAndCoplanarPoint(n,e),this}copy(e){return this.normal.copy(e.normal),this.constant=e.constant,this}normalize(){let e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(e){return this.normal.dot(e)+this.constant}distanceToSphere(e){return this.distanceToPoint(e.center)-e.radius}projectPoint(e,i){return i.copy(e).addScaledVector(this.normal,-this.distanceToPoint(e))}intersectLine(e,i){let r=e.delta(n$),n=this.normal.dot(r);if(0===n)return 0===this.distanceToPoint(e.start)?i.copy(e.start):null;let a=-(e.start.dot(this.normal)+this.constant)/n;return a<0||a>1?null:i.copy(e.start).addScaledVector(r,a)}intersectsLine(e){let i=this.distanceToPoint(e.start),r=this.distanceToPoint(e.end);return i<0&&r>0||r<0&&i>0}intersectsBox(e){return e.intersectsPlane(this)}intersectsSphere(e){return e.intersectsPlane(this)}coplanarPoint(e){return e.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(e,i){let r=i||n1.getNormalMatrix(e),n=this.coplanarPoint(n$).applyMatrix4(e),a=this.normal.applyMatrix3(r).normalize();return this.constant=-n.dot(a),this}translate(e){return this.constant-=e.dot(this.normal),this}equals(e){return e.normal.equals(this.normal)&&e.constant===this.constant}clone(){return new this.constructor().copy(this)}}let n2=new ij,n4=new ii(.5,.5),n5=new ia;class n6{constructor(e=new n3,i=new n3,r=new n3,n=new n3,a=new n3,s=new n3){this.planes=[e,i,r,n,a,s]}set(e,i,r,n,a,s){let o=this.planes;return o[0].copy(e),o[1].copy(i),o[2].copy(r),o[3].copy(n),o[4].copy(a),o[5].copy(s),this}copy(e){let i=this.planes;for(let r=0;r<6;r++)i[r].copy(e.planes[r]);return this}setFromProjectionMatrix(e,i=tW,r=!1){let n=this.planes,a=e.elements,s=a[0],o=a[1],l=a[2],c=a[3],h=a[4],u=a[5],d=a[6],p=a[7],f=a[8],m=a[9],g=a[10],v=a[11],_=a[12],y=a[13],x=a[14],M=a[15];if(n[0].setComponents(c-s,p-h,v-f,M-_).normalize(),n[1].setComponents(c+s,p+h,v+f,M+_).normalize(),n[2].setComponents(c+o,p+u,v+m,M+y).normalize(),n[3].setComponents(c-o,p-u,v-m,M-y).normalize(),r)n[4].setComponents(l,d,g,x).normalize(),n[5].setComponents(c-l,p-d,v-g,M-x).normalize();else if(n[4].setComponents(c-l,p-d,v-g,M-x).normalize(),i===tW)n[5].setComponents(c+l,p+d,v+g,M+x).normalize();else if(2001===i)n[5].setComponents(l,d,g,x).normalize();else throw Error("THREE.Frustum.setFromProjectionMatrix(): Invalid coordinate system: "+i);return this}intersectsObject(e){if(void 0!==e.boundingSphere)null===e.boundingSphere&&e.computeBoundingSphere(),n2.copy(e.boundingSphere).applyMatrix4(e.matrixWorld);else{let i=e.geometry;null===i.boundingSphere&&i.computeBoundingSphere(),n2.copy(i.boundingSphere).applyMatrix4(e.matrixWorld)}return this.intersectsSphere(n2)}intersectsSprite(e){return n2.center.set(0,0,0),n2.radius=.7071067811865476+n4.distanceTo(e.center),n2.applyMatrix4(e.matrixWorld),this.intersectsSphere(n2)}intersectsSphere(e){let i=this.planes,r=e.center,n=-e.radius;for(let e=0;e<6;e++)if(i[e].distanceToPoint(r)<n)return!1;return!0}intersectsBox(e){let i=this.planes;for(let r=0;r<6;r++){let n=i[r];if(n5.x=n.normal.x>0?e.max.x:e.min.x,n5.y=n.normal.y>0?e.max.y:e.min.y,n5.z=n.normal.z>0?e.max.z:e.min.z,0>n.distanceToPoint(n5))return!1}return!0}containsPoint(e){let i=this.planes;for(let r=0;r<6;r++)if(0>i[r].distanceToPoint(e))return!1;return!0}clone(){return new this.constructor().copy(this)}}class n8 extends rk{constructor(e){super(),this.isLineBasicMaterial=!0,this.type="LineBasicMaterial",this.color=new rF(0xffffff),this.map=null,this.linewidth=1,this.linecap="round",this.linejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this.fog=e.fog,this}}let n9=new ia,n7=new ia,ae=new i1,at=new i0,ai=new ij,ar=new ia,an=new ia;class aa extends r_{constructor(e=new r3,i=new n8){super(),this.isLine=!0,this.type="Line",this.geometry=e,this.material=i,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.updateMorphTargets()}copy(e,i){return super.copy(e,i),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}computeLineDistances(){let e=this.geometry;if(null===e.index){let i=e.attributes.position,r=[0];for(let e=1,n=i.count;e<n;e++)n9.fromBufferAttribute(i,e-1),n7.fromBufferAttribute(i,e),r[e]=r[e-1],r[e]+=n9.distanceTo(n7);e.setAttribute("lineDistance",new rY(r,1))}else tJ("Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}raycast(e,i){let r=this.geometry,n=this.matrixWorld,a=e.params.Line.threshold,s=r.drawRange;if(null===r.boundingSphere&&r.computeBoundingSphere(),ai.copy(r.boundingSphere),ai.applyMatrix4(n),ai.radius+=a,!1===e.ray.intersectsSphere(ai))return;ae.copy(n).invert(),at.copy(e.ray).applyMatrix4(ae);let o=a/((this.scale.x+this.scale.y+this.scale.z)/3),l=o*o,c=this.isLineSegments?2:1,h=r.index,u=r.attributes.position;if(null!==h){let r=Math.max(0,s.start),n=Math.min(h.count,s.start+s.count);for(let a=r,s=n-1;a<s;a+=c){let r=as(this,e,at,l,h.getX(a),h.getX(a+1),a);r&&i.push(r)}if(this.isLineLoop){let a=as(this,e,at,l,h.getX(n-1),h.getX(r),n-1);a&&i.push(a)}}else{let r=Math.max(0,s.start),n=Math.min(u.count,s.start+s.count);for(let a=r,s=n-1;a<s;a+=c){let r=as(this,e,at,l,a,a+1,a);r&&i.push(r)}if(this.isLineLoop){let a=as(this,e,at,l,n-1,r,n-1);a&&i.push(a)}}}updateMorphTargets(){let e=this.geometry.morphAttributes,i=Object.keys(e);if(i.length>0){let r=e[i[0]];if(void 0!==r){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,i=r.length;e<i;e++){let i=r[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=e}}}}}function as(e,i,r,n,a,s,o){let l=e.geometry.attributes.position;if(n9.fromBufferAttribute(l,a),n7.fromBufferAttribute(l,s),r.distanceSqToSegment(n9,n7,ar,an)>n)return;ar.applyMatrix4(e.matrixWorld);let c=i.ray.origin.distanceTo(ar);if(!(c<i.near)&&!(c>i.far))return{distance:c,point:an.clone().applyMatrix4(e.matrixWorld),index:o,face:null,faceIndex:null,barycoord:null,object:e}}let ao=new ia,al=new ia;class ac extends aa{constructor(e,i){super(e,i),this.isLineSegments=!0,this.type="LineSegments"}computeLineDistances(){let e=this.geometry;if(null===e.index){let i=e.attributes.position,r=[];for(let e=0,n=i.count;e<n;e+=2)ao.fromBufferAttribute(i,e),al.fromBufferAttribute(i,e+1),r[e]=0===e?0:r[e-1],r[e+1]=r[e]+ao.distanceTo(al);e.setAttribute("lineDistance",new rY(r,1))}else tJ("LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}}class ah extends aa{constructor(e,i){super(e,i),this.isLineLoop=!0,this.type="LineLoop"}}class au extends rk{constructor(e){super(),this.isPointsMaterial=!0,this.type="PointsMaterial",this.color=new rF(0xffffff),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this.fog=e.fog,this}}let ad=new i1,ap=new i0,af=new ij,am=new ia;class ag extends r_{constructor(e=new r3,i=new au){super(),this.isPoints=!0,this.type="Points",this.geometry=e,this.material=i,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.updateMorphTargets()}copy(e,i){return super.copy(e,i),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}raycast(e,i){let r=this.geometry,n=this.matrixWorld,a=e.params.Points.threshold,s=r.drawRange;if(null===r.boundingSphere&&r.computeBoundingSphere(),af.copy(r.boundingSphere),af.applyMatrix4(n),af.radius+=a,!1===e.ray.intersectsSphere(af))return;ad.copy(n).invert(),ap.copy(e.ray).applyMatrix4(ad);let o=a/((this.scale.x+this.scale.y+this.scale.z)/3),l=o*o,c=r.index,h=r.attributes.position;if(null!==c){let r=Math.max(0,s.start),a=Math.min(c.count,s.start+s.count);for(let s=r;s<a;s++){let r=c.getX(s);am.fromBufferAttribute(h,r),av(am,r,l,n,e,i,this)}}else{let r=Math.max(0,s.start),a=Math.min(h.count,s.start+s.count);for(let s=r;s<a;s++)am.fromBufferAttribute(h,s),av(am,s,l,n,e,i,this)}}updateMorphTargets(){let e=this.geometry.morphAttributes,i=Object.keys(e);if(i.length>0){let r=e[i[0]];if(void 0!==r){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,i=r.length;e<i;e++){let i=r[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=e}}}}}function av(e,i,r,n,a,s,o){let l=ap.distanceSqToPoint(e);if(l<r){let r=new ia;ap.closestPointToPoint(e,r),r.applyMatrix4(n);let c=a.ray.origin.distanceTo(r);if(c<a.near||c>a.far)return;s.push({distance:c,distanceToRay:Math.sqrt(l),point:r,index:i,face:null,faceIndex:null,barycoord:null,object:o})}}class a_ extends iS{constructor(e,i,r,n,a,s,o,l,c,h,u,d){super(null,s,o,l,c,h,n,a,u,d),this.isCompressedTexture=!0,this.image={width:i,height:r},this.mipmaps=e,this.flipY=!1,this.generateMipmaps=!1}}class ay extends iS{constructor(e,i,r,n,a,s,o,l,c){super(e,i,r,n,a,s,o,l,c),this.isCanvasTexture=!0,this.needsUpdate=!0}}class ax extends iS{constructor(e,i,r=eD,n,a,s,o=eS,l=eS,c,h=eW,u=1){if(h!==eW&&h!==eX)throw Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");super({width:e,height:i,depth:u},n,a,s,o,l,h,r,c),this.isDepthTexture=!0,this.flipY=!1,this.generateMipmaps=!1,this.compareFunction=null}copy(e){return super.copy(e),this.source=new i_(Object.assign({},e.image)),this.compareFunction=e.compareFunction,this}toJSON(e){let i=super.toJSON(e);return null!==this.compareFunction&&(i.compareFunction=this.compareFunction),i}}class aM extends ax{constructor(e,i=eD,r=ef,n,a,s=eS,o=eS,l,c=eW){const h={width:e,height:e,depth:1};super(e,e,i,r,n,a,s,o,l,c),this.image=[h,h,h,h,h,h],this.isCubeDepthTexture=!0,this.isCubeTexture=!0}get images(){return this.image}set images(e){this.image=e}}class aS extends iS{constructor(e=null){super(),this.sourceTexture=e,this.isExternalTexture=!0}copy(e){return super.copy(e),this.sourceTexture=e.sourceTexture,this}}class ab extends r3{constructor(e=1,i=32,r=0,n=2*Math.PI){super(),this.type="CircleGeometry",this.parameters={radius:e,segments:i,thetaStart:r,thetaLength:n},i=Math.max(3,i);const a=[],s=[],o=[],l=[],c=new ia,h=new ii;s.push(0,0,0),o.push(0,0,1),l.push(.5,.5);for(let a=0,u=3;a<=i;a++,u+=3){const d=r+a/i*n;c.x=e*Math.cos(d),c.y=e*Math.sin(d),s.push(c.x,c.y,c.z),o.push(0,0,1),h.x=(s[u]/e+1)/2,h.y=(s[u+1]/e+1)/2,l.push(h.x,h.y)}for(let e=1;e<=i;e++)a.push(e,e+1,0);this.setIndex(a),this.setAttribute("position",new rY(s,3)),this.setAttribute("normal",new rY(o,3)),this.setAttribute("uv",new rY(l,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new ab(e.radius,e.segments,e.thetaStart,e.thetaLength)}}class aT extends r3{constructor(e=1,i=1,r=1,n=32,a=1,s=!1,o=0,l=2*Math.PI){super(),this.type="CylinderGeometry",this.parameters={radiusTop:e,radiusBottom:i,height:r,radialSegments:n,heightSegments:a,openEnded:s,thetaStart:o,thetaLength:l};const c=this;n=Math.floor(n),a=Math.floor(a);const h=[],u=[],d=[],p=[];let f=0;const m=[],g=r/2;let v=0;function _(r){let a=f,s=new ii,m=new ia,_=0,y=!0===r?e:i,x=!0===r?1:-1;for(let e=1;e<=n;e++)u.push(0,g*x,0),d.push(0,x,0),p.push(.5,.5),f++;let M=f;for(let e=0;e<=n;e++){let i=e/n*l+o,r=Math.cos(i),a=Math.sin(i);m.x=y*a,m.y=g*x,m.z=y*r,u.push(m.x,m.y,m.z),d.push(0,x,0),s.x=.5*r+.5,s.y=.5*a*x+.5,p.push(s.x,s.y),f++}for(let e=0;e<n;e++){let i=a+e,n=M+e;!0===r?h.push(n,n+1,i):h.push(n+1,n,i),_+=3}c.addGroup(v,_,!0===r?1:2),v+=_}(function(){let s=new ia,_=new ia,y=0,x=(i-e)/r;for(let c=0;c<=a;c++){let h=[],v=c/a,y=v*(i-e)+e;for(let e=0;e<=n;e++){let i=e/n,a=i*l+o,c=Math.sin(a),m=Math.cos(a);_.x=y*c,_.y=-v*r+g,_.z=y*m,u.push(_.x,_.y,_.z),s.set(c,x,m).normalize(),d.push(s.x,s.y,s.z),p.push(i,1-v),h.push(f++)}m.push(h)}for(let r=0;r<n;r++)for(let n=0;n<a;n++){let s=m[n][r],o=m[n+1][r],l=m[n+1][r+1],c=m[n][r+1];(e>0||0!==n)&&(h.push(s,o,c),y+=3),(i>0||n!==a-1)&&(h.push(o,l,c),y+=3)}c.addGroup(v,y,0),v+=y})(),!1===s&&(e>0&&_(!0),i>0&&_(!1)),this.setIndex(h),this.setAttribute("position",new rY(u,3)),this.setAttribute("normal",new rY(d,3)),this.setAttribute("uv",new rY(p,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new aT(e.radiusTop,e.radiusBottom,e.height,e.radialSegments,e.heightSegments,e.openEnded,e.thetaStart,e.thetaLength)}}class aE extends aT{constructor(e=1,i=1,r=32,n=1,a=!1,s=0,o=2*Math.PI){super(0,e,i,r,n,a,s,o),this.type="ConeGeometry",this.parameters={radius:e,height:i,radialSegments:r,heightSegments:n,openEnded:a,thetaStart:s,thetaLength:o}}static fromJSON(e){return new aE(e.radius,e.height,e.radialSegments,e.heightSegments,e.openEnded,e.thetaStart,e.thetaLength)}}class aw extends r3{constructor(e=[],i=[],r=1,n=0){super(),this.type="PolyhedronGeometry",this.parameters={vertices:e,indices:i,radius:r,detail:n};const a=[],s=[];function o(e){a.push(e.x,e.y,e.z)}function l(i,r){let n=3*i;r.x=e[n+0],r.y=e[n+1],r.z=e[n+2]}function c(e,i,r,n){n<0&&1===e.x&&(s[i]=e.x-1),0===r.x&&0===r.z&&(s[i]=n/2/Math.PI+.5)}function h(e){return Math.atan2(e.z,-e.x)}(function(e){let r=new ia,n=new ia,a=new ia;for(let s=0;s<i.length;s+=3)l(i[s+0],r),l(i[s+1],n),l(i[s+2],a),function(e,i,r,n){let a=n+1,s=[];for(let n=0;n<=a;n++){s[n]=[];let o=e.clone().lerp(r,n/a),l=i.clone().lerp(r,n/a),c=a-n;for(let e=0;e<=c;e++)0===e&&n===a?s[n][e]=o:s[n][e]=o.clone().lerp(l,e/c)}for(let e=0;e<a;e++)for(let i=0;i<2*(a-e)-1;i++){let r=Math.floor(i/2);i%2==0?(o(s[e][r+1]),o(s[e+1][r]),o(s[e][r])):(o(s[e][r+1]),o(s[e+1][r+1]),o(s[e+1][r]))}}(r,n,a,e)})(n),function(e){let i=new ia;for(let r=0;r<a.length;r+=3)i.x=a[r+0],i.y=a[r+1],i.z=a[r+2],i.normalize().multiplyScalar(e),a[r+0]=i.x,a[r+1]=i.y,a[r+2]=i.z}(r),function(){let e=new ia;for(let r=0;r<a.length;r+=3){var i;e.x=a[r+0],e.y=a[r+1],e.z=a[r+2];let n=h(e)/2/Math.PI+.5,o=Math.atan2(-(i=e).y,Math.sqrt(i.x*i.x+i.z*i.z))/Math.PI+.5;s.push(n,1-o)}(function(){let e=new ia,i=new ia,r=new ia,n=new ia,o=new ii,l=new ii,u=new ii;for(let d=0,p=0;d<a.length;d+=9,p+=6){e.set(a[d+0],a[d+1],a[d+2]),i.set(a[d+3],a[d+4],a[d+5]),r.set(a[d+6],a[d+7],a[d+8]),o.set(s[p+0],s[p+1]),l.set(s[p+2],s[p+3]),u.set(s[p+4],s[p+5]),n.copy(e).add(i).add(r).divideScalar(3);let f=h(n);c(o,p+0,e,f),c(l,p+2,i,f),c(u,p+4,r,f)}})(),function(){for(let e=0;e<s.length;e+=6){let i=s[e+0],r=s[e+2],n=s[e+4],a=Math.max(i,r,n),o=Math.min(i,r,n);a>.9&&o<.1&&(i<.2&&(s[e+0]+=1),r<.2&&(s[e+2]+=1),n<.2&&(s[e+4]+=1))}}()}(),this.setAttribute("position",new rY(a,3)),this.setAttribute("normal",new rY(a.slice(),3)),this.setAttribute("uv",new rY(s,2)),0===n?this.computeVertexNormals():this.normalizeNormals()}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new aw(e.vertices,e.indices,e.radius,e.detail)}}class aA{constructor(){this.type="Curve",this.arcLengthDivisions=200,this.needsUpdate=!1,this.cacheArcLengths=null}getPoint(){tJ("Curve: .getPoint() not implemented.")}getPointAt(e,i){let r=this.getUtoTmapping(e);return this.getPoint(r,i)}getPoints(e=5){let i=[];for(let r=0;r<=e;r++)i.push(this.getPoint(r/e));return i}getSpacedPoints(e=5){let i=[];for(let r=0;r<=e;r++)i.push(this.getPointAt(r/e));return i}getLength(){let e=this.getLengths();return e[e.length-1]}getLengths(e=this.arcLengthDivisions){if(this.cacheArcLengths&&this.cacheArcLengths.length===e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;let i=[],r,n=this.getPoint(0),a=0;i.push(0);for(let s=1;s<=e;s++)i.push(a+=(r=this.getPoint(s/e)).distanceTo(n)),n=r;return this.cacheArcLengths=i,i}updateArcLengths(){this.needsUpdate=!0,this.getLengths()}getUtoTmapping(e,i=null){let r,n=this.getLengths(),a=0,s=n.length;r=i||e*n[s-1];let o=0,l=s-1,c;for(;o<=l;)if((c=n[a=Math.floor(o+(l-o)/2)]-r)<0)o=a+1;else if(c>0)l=a-1;else{l=a;break}if(n[a=l]===r)return a/(s-1);let h=n[a],u=n[a+1];return(a+(r-h)/(u-h))/(s-1)}getTangent(e,i){let r=e-1e-4,n=e+1e-4;r<0&&(r=0),n>1&&(n=1);let a=this.getPoint(r),s=this.getPoint(n),o=i||(a.isVector2?new ii:new ia);return o.copy(s).sub(a).normalize(),o}getTangentAt(e,i){let r=this.getUtoTmapping(e);return this.getTangent(r,i)}computeFrenetFrames(e,i=!1){let r=new ia,n=[],a=[],s=[],o=new ia,l=new i1;for(let i=0;i<=e;i++){let r=i/e;n[i]=this.getTangentAt(r,new ia)}a[0]=new ia,s[0]=new ia;let c=Number.MAX_VALUE,h=Math.abs(n[0].x),u=Math.abs(n[0].y),d=Math.abs(n[0].z);h<=c&&(c=h,r.set(1,0,0)),u<=c&&(c=u,r.set(0,1,0)),d<=c&&r.set(0,0,1),o.crossVectors(n[0],r).normalize(),a[0].crossVectors(n[0],o),s[0].crossVectors(n[0],a[0]);for(let i=1;i<=e;i++){if(a[i]=a[i-1].clone(),s[i]=s[i-1].clone(),o.crossVectors(n[i-1],n[i]),o.length()>Number.EPSILON){o.normalize();let e=Math.acos(t6(n[i-1].dot(n[i]),-1,1));a[i].applyMatrix4(l.makeRotationAxis(o,e))}s[i].crossVectors(n[i],a[i])}if(!0===i){let i=Math.acos(t6(a[0].dot(a[e]),-1,1));i/=e,n[0].dot(o.crossVectors(a[0],a[e]))>0&&(i=-i);for(let r=1;r<=e;r++)a[r].applyMatrix4(l.makeRotationAxis(n[r],i*r)),s[r].crossVectors(n[r],a[r])}return{tangents:n,normals:a,binormals:s}}clone(){return new this.constructor().copy(this)}copy(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}toJSON(){let e={metadata:{version:4.7,type:"Curve",generator:"Curve.toJSON"}};return e.arcLengthDivisions=this.arcLengthDivisions,e.type=this.type,e}fromJSON(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}}class aR extends aA{constructor(e=0,i=0,r=1,n=1,a=0,s=2*Math.PI,o=!1,l=0){super(),this.isEllipseCurve=!0,this.type="EllipseCurve",this.aX=e,this.aY=i,this.xRadius=r,this.yRadius=n,this.aStartAngle=a,this.aEndAngle=s,this.aClockwise=o,this.aRotation=l}getPoint(e,i=new ii){let r=2*Math.PI,n=this.aEndAngle-this.aStartAngle,a=Math.abs(n)<Number.EPSILON;for(;n<0;)n+=r;for(;n>r;)n-=r;n<Number.EPSILON&&(n=a?0:r),!0!==this.aClockwise||a||(n===r?n=-r:n-=r);let s=this.aStartAngle+e*n,o=this.aX+this.xRadius*Math.cos(s),l=this.aY+this.yRadius*Math.sin(s);if(0!==this.aRotation){let e=Math.cos(this.aRotation),i=Math.sin(this.aRotation),r=o-this.aX,n=l-this.aY;o=r*e-n*i+this.aX,l=r*i+n*e+this.aY}return i.set(o,l)}copy(e){return super.copy(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}toJSON(){let e=super.toJSON();return e.aX=this.aX,e.aY=this.aY,e.xRadius=this.xRadius,e.yRadius=this.yRadius,e.aStartAngle=this.aStartAngle,e.aEndAngle=this.aEndAngle,e.aClockwise=this.aClockwise,e.aRotation=this.aRotation,e}fromJSON(e){return super.fromJSON(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}}function aC(){let e=0,i=0,r=0,n=0;function a(a,s,o,l){e=a,i=o,r=-3*a+3*s-2*o-l,n=2*a-2*s+o+l}return{initCatmullRom:function(e,i,r,n,s){a(i,r,s*(r-e),s*(n-i))},initNonuniformCatmullRom:function(e,i,r,n,s,o,l){let c=(i-e)/s-(r-e)/(s+o)+(r-i)/o,h=(r-i)/o-(n-i)/(o+l)+(n-r)/l;a(i,r,c*=o,h*=o)},calc:function(a){let s=a*a;return e+i*a+r*s+s*a*n}}}let aP=new ia,aI=new aC,aL=new aC,aD=new aC;function aU(e,i,r,n,a){let s=(n-i)*.5,o=(a-r)*.5,l=e*e;return e*l*(2*r-2*n+s+o)+(-3*r+3*n-2*s-o)*l+s*e+r}function aN(e,i,r,n){let a;return(a=1-e)*a*i+2*(1-e)*e*r+e*e*n}function aO(e,i,r,n,a){let s,o;return(s=1-e)*s*s*i+3*(o=1-e)*o*e*r+3*(1-e)*e*e*n+e*e*e*a}class aF extends aA{constructor(e=new ii,i=new ii,r=new ii,n=new ii){super(),this.isCubicBezierCurve=!0,this.type="CubicBezierCurve",this.v0=e,this.v1=i,this.v2=r,this.v3=n}getPoint(e,i=new ii){let r=this.v0,n=this.v1,a=this.v2,s=this.v3;return i.set(aO(e,r.x,n.x,a.x,s.x),aO(e,r.y,n.y,a.y,s.y)),i}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this}toJSON(){let e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e.v3=this.v3.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this}}class aB extends aA{constructor(e=new ii,i=new ii){super(),this.isLineCurve=!0,this.type="LineCurve",this.v1=e,this.v2=i}getPoint(e,i=new ii){return 1===e?i.copy(this.v2):(i.copy(this.v2).sub(this.v1),i.multiplyScalar(e).add(this.v1)),i}getPointAt(e,i){return this.getPoint(e,i)}getTangent(e,i=new ii){return i.subVectors(this.v2,this.v1).normalize()}getTangentAt(e,i){return this.getTangent(e,i)}copy(e){return super.copy(e),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){let e=super.toJSON();return e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class az extends aA{constructor(e=new ii,i=new ii,r=new ii){super(),this.isQuadraticBezierCurve=!0,this.type="QuadraticBezierCurve",this.v0=e,this.v1=i,this.v2=r}getPoint(e,i=new ii){let r=this.v0,n=this.v1,a=this.v2;return i.set(aN(e,r.x,n.x,a.x),aN(e,r.y,n.y,a.y)),i}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){let e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class ak extends aA{constructor(e=new ia,i=new ia,r=new ia){super(),this.isQuadraticBezierCurve3=!0,this.type="QuadraticBezierCurve3",this.v0=e,this.v1=i,this.v2=r}getPoint(e,i=new ia){let r=this.v0,n=this.v1,a=this.v2;return i.set(aN(e,r.x,n.x,a.x),aN(e,r.y,n.y,a.y),aN(e,r.z,n.z,a.z)),i}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){let e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class aV extends aA{constructor(e=[]){super(),this.isSplineCurve=!0,this.type="SplineCurve",this.points=e}getPoint(e,i=new ii){let r=this.points,n=(r.length-1)*e,a=Math.floor(n),s=n-a,o=r[0===a?a:a-1],l=r[a],c=r[a>r.length-2?r.length-1:a+1],h=r[a>r.length-3?r.length-1:a+2];return i.set(aU(s,o.x,l.x,c.x,h.x),aU(s,o.y,l.y,c.y,h.y)),i}copy(e){super.copy(e),this.points=[];for(let i=0,r=e.points.length;i<r;i++){let r=e.points[i];this.points.push(r.clone())}return this}toJSON(){let e=super.toJSON();e.points=[];for(let i=0,r=this.points.length;i<r;i++){let r=this.points[i];e.points.push(r.toArray())}return e}fromJSON(e){super.fromJSON(e),this.points=[];for(let i=0,r=e.points.length;i<r;i++){let r=e.points[i];this.points.push(new ii().fromArray(r))}return this}}class aH extends aw{constructor(e=1,i=0){const r=(1+Math.sqrt(5))/2;super([-1,r,0,1,r,0,-1,-r,0,1,-r,0,0,-1,r,0,1,r,0,-1,-r,0,1,-r,r,0,-1,r,0,1,-r,0,-1,-r,0,1],[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],e,i),this.type="IcosahedronGeometry",this.parameters={radius:e,detail:i}}static fromJSON(e){return new aH(e.radius,e.detail)}}class aG extends r3{constructor(e=1,i=1,r=1,n=1){super(),this.type="PlaneGeometry",this.parameters={width:e,height:i,widthSegments:r,heightSegments:n};const a=e/2,s=i/2,o=Math.floor(r),l=Math.floor(n),c=o+1,h=l+1,u=e/o,d=i/l,p=[],f=[],m=[],g=[];for(let e=0;e<h;e++){const i=e*d-s;for(let r=0;r<c;r++){const n=r*u-a;f.push(n,-i,0),m.push(0,0,1),g.push(r/o),g.push(1-e/l)}}for(let e=0;e<l;e++)for(let i=0;i<o;i++){const r=i+c*e,n=i+c*(e+1),a=i+1+c*(e+1),s=i+1+c*e;p.push(r,n,s),p.push(n,a,s)}this.setIndex(p),this.setAttribute("position",new rY(f,3)),this.setAttribute("normal",new rY(m,3)),this.setAttribute("uv",new rY(g,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new aG(e.width,e.height,e.widthSegments,e.heightSegments)}}class aW extends np{constructor(e){super(e),this.isRawShaderMaterial=!0,this.type="RawShaderMaterial"}}class aX extends rk{constructor(e){super(),this.isMeshStandardMaterial=!0,this.type="MeshStandardMaterial",this.defines={STANDARD:""},this.color=new rF(0xffffff),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new rF(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=tR,this.normalScale=new ii(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new rt,this.envMapIntensity=1,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.defines={STANDARD:""},this.color.copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.envMapIntensity=e.envMapIntensity,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class aj extends aX{constructor(e){super(),this.isMeshPhysicalMaterial=!0,this.defines={STANDARD:"",PHYSICAL:""},this.type="MeshPhysicalMaterial",this.anisotropyRotation=0,this.anisotropyMap=null,this.clearcoatMap=null,this.clearcoatRoughness=0,this.clearcoatRoughnessMap=null,this.clearcoatNormalScale=new ii(1,1),this.clearcoatNormalMap=null,this.ior=1.5,Object.defineProperty(this,"reflectivity",{get:function(){return t6(2.5*(this.ior-1)/(this.ior+1),0,1)},set:function(e){this.ior=(1+.4*e)/(1-.4*e)}}),this.iridescenceMap=null,this.iridescenceIOR=1.3,this.iridescenceThicknessRange=[100,400],this.iridescenceThicknessMap=null,this.sheenColor=new rF(0),this.sheenColorMap=null,this.sheenRoughness=1,this.sheenRoughnessMap=null,this.transmissionMap=null,this.thickness=0,this.thicknessMap=null,this.attenuationDistance=1/0,this.attenuationColor=new rF(1,1,1),this.specularIntensity=1,this.specularIntensityMap=null,this.specularColor=new rF(1,1,1),this.specularColorMap=null,this._anisotropy=0,this._clearcoat=0,this._dispersion=0,this._iridescence=0,this._sheen=0,this._transmission=0,this.setValues(e)}get anisotropy(){return this._anisotropy}set anisotropy(e){this._anisotropy>0!=e>0&&this.version++,this._anisotropy=e}get clearcoat(){return this._clearcoat}set clearcoat(e){this._clearcoat>0!=e>0&&this.version++,this._clearcoat=e}get iridescence(){return this._iridescence}set iridescence(e){this._iridescence>0!=e>0&&this.version++,this._iridescence=e}get dispersion(){return this._dispersion}set dispersion(e){this._dispersion>0!=e>0&&this.version++,this._dispersion=e}get sheen(){return this._sheen}set sheen(e){this._sheen>0!=e>0&&this.version++,this._sheen=e}get transmission(){return this._transmission}set transmission(e){this._transmission>0!=e>0&&this.version++,this._transmission=e}copy(e){return super.copy(e),this.defines={STANDARD:"",PHYSICAL:""},this.anisotropy=e.anisotropy,this.anisotropyRotation=e.anisotropyRotation,this.anisotropyMap=e.anisotropyMap,this.clearcoat=e.clearcoat,this.clearcoatMap=e.clearcoatMap,this.clearcoatRoughness=e.clearcoatRoughness,this.clearcoatRoughnessMap=e.clearcoatRoughnessMap,this.clearcoatNormalMap=e.clearcoatNormalMap,this.clearcoatNormalScale.copy(e.clearcoatNormalScale),this.dispersion=e.dispersion,this.ior=e.ior,this.iridescence=e.iridescence,this.iridescenceMap=e.iridescenceMap,this.iridescenceIOR=e.iridescenceIOR,this.iridescenceThicknessRange=[...e.iridescenceThicknessRange],this.iridescenceThicknessMap=e.iridescenceThicknessMap,this.sheen=e.sheen,this.sheenColor.copy(e.sheenColor),this.sheenColorMap=e.sheenColorMap,this.sheenRoughness=e.sheenRoughness,this.sheenRoughnessMap=e.sheenRoughnessMap,this.transmission=e.transmission,this.transmissionMap=e.transmissionMap,this.thickness=e.thickness,this.thicknessMap=e.thicknessMap,this.attenuationDistance=e.attenuationDistance,this.attenuationColor.copy(e.attenuationColor),this.specularIntensity=e.specularIntensity,this.specularIntensityMap=e.specularIntensityMap,this.specularColor.copy(e.specularColor),this.specularColorMap=e.specularColorMap,this}}class aq extends rk{constructor(e){super(),this.isMeshPhongMaterial=!0,this.type="MeshPhongMaterial",this.color=new rF(0xffffff),this.specular=new rF(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new rF(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=tR,this.normalScale=new ii(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new rt,this.combine=ei,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.specular.copy(e.specular),this.shininess=e.shininess,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class aY extends rk{constructor(e){super(),this.isMeshDepthMaterial=!0,this.type="MeshDepthMaterial",this.depthPacking=3200,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(e)}copy(e){return super.copy(e),this.depthPacking=e.depthPacking,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this}}class aK extends rk{constructor(e){super(),this.isMeshDistanceMaterial=!0,this.type="MeshDistanceMaterial",this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.setValues(e)}copy(e){return super.copy(e),this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this}}function aJ(e,i){return e&&e.constructor!==i?"number"==typeof i.BYTES_PER_ELEMENT?new i(e):Array.prototype.slice.call(e):e}function aZ(e,i,r){let n=e.length,a=new e.constructor(n);for(let s=0,o=0;o!==n;++s){let n=r[s]*i;for(let r=0;r!==i;++r)a[o++]=e[n+r]}return a}function aQ(e,i,r,n){let a=1,s=e[0];for(;void 0!==s&&void 0===s[n];)s=e[a++];if(void 0===s)return;let o=s[n];if(void 0!==o)if(Array.isArray(o))do void 0!==(o=s[n])&&(i.push(s.time),r.push(...o)),s=e[a++];while(void 0!==s)else if(void 0!==o.toArray)do void 0!==(o=s[n])&&(i.push(s.time),o.toArray(r,r.length)),s=e[a++];while(void 0!==s)else do void 0!==(o=s[n])&&(i.push(s.time),r.push(o)),s=e[a++];while(void 0!==s)}class a${constructor(e,i,r,n){this.parameterPositions=e,this._cachedIndex=0,this.resultBuffer=void 0!==n?n:new i.constructor(r),this.sampleValues=i,this.valueSize=r,this.settings=null,this.DefaultSettings_={}}evaluate(e){let i=this.parameterPositions,r=this._cachedIndex,n=i[r],a=i[r-1];e:{t:{let s;i:{r:if(!(e<n)){for(let s=r+2;;){if(void 0===n){if(e<a)break r;return r=i.length,this._cachedIndex=r,this.copySampleValue_(r-1)}if(r===s)break;if(a=n,e<(n=i[++r]))break t}s=i.length;break i}if(!(e>=a)){let o=i[1];e<o&&(r=2,a=o);for(let s=r-2;;){if(void 0===a)return this._cachedIndex=0,this.copySampleValue_(0);if(r===s)break;if(n=a,e>=(a=i[--r-1]))break t}s=r,r=0;break i}break e}for(;r<s;){let n=r+s>>>1;e<i[n]?s=n:r=n+1}if(n=i[r],void 0===(a=i[r-1]))return this._cachedIndex=0,this.copySampleValue_(0);if(void 0===n)return r=i.length,this._cachedIndex=r,this.copySampleValue_(r-1)}this._cachedIndex=r,this.intervalChanged_(r,a,n)}return this.interpolate_(r,a,e,n)}getSettings_(){return this.settings||this.DefaultSettings_}copySampleValue_(e){let i=this.resultBuffer,r=this.sampleValues,n=this.valueSize,a=e*n;for(let e=0;e!==n;++e)i[e]=r[a+e];return i}interpolate_(){throw Error("call to abstract method")}intervalChanged_(){}}class a0 extends a${constructor(e,i,r,n){super(e,i,r,n),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0,this.DefaultSettings_={endingStart:2400,endingEnd:2400}}intervalChanged_(e,i,r){let n=this.parameterPositions,a=e-2,s=e+1,o=n[a],l=n[s];if(void 0===o)switch(this.getSettings_().endingStart){case 2401:a=e,o=2*i-r;break;case 2402:a=n.length-2,o=i+n[a]-n[a+1];break;default:a=e,o=r}if(void 0===l)switch(this.getSettings_().endingEnd){case 2401:s=e,l=2*r-i;break;case 2402:s=1,l=r+n[1]-n[0];break;default:s=e-1,l=i}let c=(r-i)*.5,h=this.valueSize;this._weightPrev=c/(i-o),this._weightNext=c/(l-r),this._offsetPrev=a*h,this._offsetNext=s*h}interpolate_(e,i,r,n){let a=this.resultBuffer,s=this.sampleValues,o=this.valueSize,l=e*o,c=l-o,h=this._offsetPrev,u=this._offsetNext,d=this._weightPrev,p=this._weightNext,f=(r-i)/(n-i),m=f*f,g=m*f,v=-d*g+2*d*m-d*f,_=(1+d)*g+(-1.5-2*d)*m+(-.5+d)*f+1,y=(-1-p)*g+(1.5+p)*m+.5*f,x=p*g-p*m;for(let e=0;e!==o;++e)a[e]=v*s[h+e]+_*s[c+e]+y*s[l+e]+x*s[u+e];return a}}class a1 extends a${constructor(e,i,r,n){super(e,i,r,n)}interpolate_(e,i,r,n){let a=this.resultBuffer,s=this.sampleValues,o=this.valueSize,l=e*o,c=l-o,h=(r-i)/(n-i),u=1-h;for(let e=0;e!==o;++e)a[e]=s[c+e]*u+s[l+e]*h;return a}}class a3 extends a${constructor(e,i,r,n){super(e,i,r,n)}interpolate_(e){return this.copySampleValue_(e-1)}}class a2{constructor(e,i,r,n){if(void 0===e)throw Error("THREE.KeyframeTrack: track name is undefined");if(void 0===i||0===i.length)throw Error("THREE.KeyframeTrack: no keyframes in track named "+e);this.name=e,this.times=aJ(i,this.TimeBufferType),this.values=aJ(r,this.ValueBufferType),this.setInterpolation(n||this.DefaultInterpolation)}static toJSON(e){let i,r=e.constructor;if(r.toJSON!==this.toJSON)i=r.toJSON(e);else{i={name:e.name,times:aJ(e.times,Array),values:aJ(e.values,Array)};let r=e.getInterpolation();r!==e.DefaultInterpolation&&(i.interpolation=r)}return i.type=e.ValueTypeName,i}InterpolantFactoryMethodDiscrete(e){return new a3(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodLinear(e){return new a1(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodSmooth(e){return new a0(this.times,this.values,this.getValueSize(),e)}setInterpolation(e){let i;switch(e){case tb:i=this.InterpolantFactoryMethodDiscrete;break;case tT:i=this.InterpolantFactoryMethodLinear;break;case 2302:i=this.InterpolantFactoryMethodSmooth}if(void 0===i){let i="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant)if(e!==this.DefaultInterpolation)this.setInterpolation(this.DefaultInterpolation);else throw Error(i);return tJ("KeyframeTrack:",i),this}return this.createInterpolant=i,this}getInterpolation(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return tb;case this.InterpolantFactoryMethodLinear:return tT;case this.InterpolantFactoryMethodSmooth:return 2302}}getValueSize(){return this.values.length/this.times.length}shift(e){if(0!==e){let i=this.times;for(let r=0,n=i.length;r!==n;++r)i[r]+=e}return this}scale(e){if(1!==e){let i=this.times;for(let r=0,n=i.length;r!==n;++r)i[r]*=e}return this}trim(e,i){let r=this.times,n=r.length,a=0,s=n-1;for(;a!==n&&r[a]<e;)++a;for(;-1!==s&&r[s]>i;)--s;if(++s,0!==a||s!==n){a>=s&&(a=(s=Math.max(s,1))-1);let e=this.getValueSize();this.times=r.slice(a,s),this.values=this.values.slice(a*e,s*e)}return this}validate(){var e;let i=!0,r=this.getValueSize();r-Math.floor(r)!=0&&(tZ("KeyframeTrack: Invalid value size in track.",this),i=!1);let n=this.times,a=this.values,s=n.length;0===s&&(tZ("KeyframeTrack: Track is empty.",this),i=!1);let o=null;for(let e=0;e!==s;e++){let r=n[e];if("number"==typeof r&&isNaN(r)){tZ("KeyframeTrack: Time is not a valid number.",this,e,r),i=!1;break}if(null!==o&&o>r){tZ("KeyframeTrack: Out of order keys.",this,e,r,o),i=!1;break}o=r}if(void 0!==a&&ArrayBuffer.isView(e=a)&&!(e instanceof DataView))for(let e=0,r=a.length;e!==r;++e){let r=a[e];if(isNaN(r)){tZ("KeyframeTrack: Value is not a valid number.",this,e,r),i=!1;break}}return i}optimize(){let e=this.times.slice(),i=this.values.slice(),r=this.getValueSize(),n=2302===this.getInterpolation(),a=e.length-1,s=1;for(let o=1;o<a;++o){let a=!1,l=e[o];if(l!==e[o+1]&&(1!==o||l!==e[0]))if(n)a=!0;else{let e=o*r,n=e-r,s=e+r;for(let o=0;o!==r;++o){let r=i[e+o];if(r!==i[n+o]||r!==i[s+o]){a=!0;break}}}if(a){if(o!==s){e[s]=e[o];let n=o*r,a=s*r;for(let e=0;e!==r;++e)i[a+e]=i[n+e]}++s}}if(a>0){e[s]=e[a];for(let e=a*r,n=s*r,o=0;o!==r;++o)i[n+o]=i[e+o];++s}return s!==e.length?(this.times=e.slice(0,s),this.values=i.slice(0,s*r)):(this.times=e,this.values=i),this}clone(){let e=this.times.slice(),i=this.values.slice(),r=new this.constructor(this.name,e,i);return r.createInterpolant=this.createInterpolant,r}}a2.prototype.ValueTypeName="",a2.prototype.TimeBufferType=Float32Array,a2.prototype.ValueBufferType=Float32Array,a2.prototype.DefaultInterpolation=tT;class a4 extends a2{constructor(e,i,r){super(e,i,r)}}a4.prototype.ValueTypeName="bool",a4.prototype.ValueBufferType=Array,a4.prototype.DefaultInterpolation=tb,a4.prototype.InterpolantFactoryMethodLinear=void 0,a4.prototype.InterpolantFactoryMethodSmooth=void 0;class a5 extends a2{constructor(e,i,r,n){super(e,i,r,n)}}a5.prototype.ValueTypeName="color";class a6 extends a2{constructor(e,i,r,n){super(e,i,r,n)}}a6.prototype.ValueTypeName="number";class a8 extends a${constructor(e,i,r,n){super(e,i,r,n)}interpolate_(e,i,r,n){let a=this.resultBuffer,s=this.sampleValues,o=this.valueSize,l=(r-i)/(n-i),c=e*o;for(let e=c+o;c!==e;c+=4)ir.slerpFlat(a,0,s,c-o,s,c,l);return a}}class a9 extends a2{constructor(e,i,r,n){super(e,i,r,n)}InterpolantFactoryMethodLinear(e){return new a8(this.times,this.values,this.getValueSize(),e)}}a9.prototype.ValueTypeName="quaternion",a9.prototype.InterpolantFactoryMethodSmooth=void 0;class a7 extends a2{constructor(e,i,r){super(e,i,r)}}a7.prototype.ValueTypeName="string",a7.prototype.ValueBufferType=Array,a7.prototype.DefaultInterpolation=tb,a7.prototype.InterpolantFactoryMethodLinear=void 0,a7.prototype.InterpolantFactoryMethodSmooth=void 0;class se extends a2{constructor(e,i,r,n){super(e,i,r,n)}}se.prototype.ValueTypeName="vector";class st{constructor(e="",i=-1,r=[],n=2500){this.name=e,this.tracks=r,this.duration=i,this.blendMode=n,this.uuid=t5(),this.userData={},this.duration<0&&this.resetDuration()}static parse(e){let i=[],r=e.tracks,n=1/(e.fps||1);for(let e=0,a=r.length;e!==a;++e)i.push((function(e){if(void 0===e.type)throw Error("THREE.KeyframeTrack: track type undefined, can not parse");let i=function(e){switch(e.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return a6;case"vector":case"vector2":case"vector3":case"vector4":return se;case"color":return a5;case"quaternion":return a9;case"bool":case"boolean":return a4;case"string":return a7}throw Error("THREE.KeyframeTrack: Unsupported typeName: "+e)}(e.type);if(void 0===e.times){let i=[],r=[];aQ(e.keys,i,r,"value"),e.times=i,e.values=r}return void 0!==i.parse?i.parse(e):new i(e.name,e.times,e.values,e.interpolation)})(r[e]).scale(n));let a=new this(e.name,e.duration,i,e.blendMode);return a.uuid=e.uuid,a.userData=JSON.parse(e.userData||"{}"),a}static toJSON(e){let i=[],r=e.tracks,n={name:e.name,duration:e.duration,tracks:i,uuid:e.uuid,blendMode:e.blendMode,userData:JSON.stringify(e.userData)};for(let e=0,n=r.length;e!==n;++e)i.push(a2.toJSON(r[e]));return n}static CreateFromMorphTargetSequence(e,i,r,n){let a=i.length,s=[];for(let e=0;e<a;e++){let o=[],l=[];o.push((e+a-1)%a,e,(e+1)%a),l.push(0,1,0);let c=function(e){let i=e.length,r=Array(i);for(let e=0;e!==i;++e)r[e]=e;return r.sort(function(i,r){return e[i]-e[r]}),r}(o);o=aZ(o,1,c),l=aZ(l,1,c),n||0!==o[0]||(o.push(a),l.push(l[0])),s.push(new a6(".morphTargetInfluences["+i[e].name+"]",o,l).scale(1/r))}return new this(e,-1,s)}static findByName(e,i){let r=e;Array.isArray(e)||(r=e.geometry&&e.geometry.animations||e.animations);for(let e=0;e<r.length;e++)if(r[e].name===i)return r[e];return null}static CreateClipsFromMorphTargetSequences(e,i,r){let n={},a=/^([\w-]*?)([\d]+)$/;for(let i=0,r=e.length;i<r;i++){let r=e[i],s=r.name.match(a);if(s&&s.length>1){let e=s[1],i=n[e];i||(n[e]=i=[]),i.push(r)}}let s=[];for(let e in n)s.push(this.CreateFromMorphTargetSequence(e,n[e],i,r));return s}static parseAnimation(e,i){if(tJ("AnimationClip: parseAnimation() is deprecated and will be removed with r185"),!e)return tZ("AnimationClip: No animation in JSONLoader data."),null;let r=function(e,i,r,n,a){if(0!==r.length){let s=[],o=[];aQ(r,s,o,n),0!==s.length&&a.push(new e(i,s,o))}},n=[],a=e.name||"default",s=e.fps||30,o=e.blendMode,l=e.length||-1,c=e.hierarchy||[];for(let e=0;e<c.length;e++){let a=c[e].keys;if(a&&0!==a.length)if(a[0].morphTargets){let e,i={};for(e=0;e<a.length;e++)if(a[e].morphTargets)for(let r=0;r<a[e].morphTargets.length;r++)i[a[e].morphTargets[r]]=-1;for(let r in i){let i=[],s=[];for(let n=0;n!==a[e].morphTargets.length;++n){let n=a[e];i.push(n.time),s.push(+(n.morphTarget===r))}n.push(new a6(".morphTargetInfluence["+r+"]",i,s))}l=i.length*s}else{let s=".bones["+i[e].name+"]";r(se,s+".position",a,"pos",n),r(a9,s+".quaternion",a,"rot",n),r(se,s+".scale",a,"scl",n)}}return 0===n.length?null:new this(a,l,n,o)}resetDuration(){let e=this.tracks,i=0;for(let r=0,n=e.length;r!==n;++r){let e=this.tracks[r];i=Math.max(i,e.times[e.times.length-1])}return this.duration=i,this}trim(){for(let e=0;e<this.tracks.length;e++)this.tracks[e].trim(0,this.duration);return this}validate(){let e=!0;for(let i=0;i<this.tracks.length;i++)e=e&&this.tracks[i].validate();return e}optimize(){for(let e=0;e<this.tracks.length;e++)this.tracks[e].optimize();return this}clone(){let e=[];for(let i=0;i<this.tracks.length;i++)e.push(this.tracks[i].clone());let i=new this.constructor(this.name,this.duration,e,this.blendMode);return i.userData=JSON.parse(JSON.stringify(this.userData)),i}toJSON(){return this.constructor.toJSON(this)}}let si={enabled:!1,files:{},add:function(e,i){!1!==this.enabled&&(this.files[e]=i)},get:function(e){if(!1!==this.enabled)return this.files[e]},remove:function(e){delete this.files[e]},clear:function(){this.files={}}},sr=new class{constructor(e,i,r){let n;const a=this;let s=!1,o=0,l=0;const c=[];this.onStart=void 0,this.onLoad=e,this.onProgress=i,this.onError=r,this._abortController=null,this.itemStart=function(e){l++,!1===s&&void 0!==a.onStart&&a.onStart(e,o,l),s=!0},this.itemEnd=function(e){o++,void 0!==a.onProgress&&a.onProgress(e,o,l),o===l&&(s=!1,void 0!==a.onLoad&&a.onLoad())},this.itemError=function(e){void 0!==a.onError&&a.onError(e)},this.resolveURL=function(e){return n?n(e):e},this.setURLModifier=function(e){return n=e,this},this.addHandler=function(e,i){return c.push(e,i),this},this.removeHandler=function(e){let i=c.indexOf(e);return -1!==i&&c.splice(i,2),this},this.getHandler=function(e){for(let i=0,r=c.length;i<r;i+=2){let r=c[i],n=c[i+1];if(r.global&&(r.lastIndex=0),r.test(e))return n}return null},this.abort=function(){return this.abortController.abort(),this._abortController=null,this}}get abortController(){return this._abortController||(this._abortController=new AbortController),this._abortController}};class sn{constructor(e){this.manager=void 0!==e?e:sr,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(e,i){let r=this;return new Promise(function(n,a){r.load(e,n,i,a)})}parse(){}setCrossOrigin(e){return this.crossOrigin=e,this}setWithCredentials(e){return this.withCredentials=e,this}setPath(e){return this.path=e,this}setResourcePath(e){return this.resourcePath=e,this}setRequestHeader(e){return this.requestHeader=e,this}abort(){return this}}sn.DEFAULT_MATERIAL_NAME="__DEFAULT";let sa={};class ss extends Error{constructor(e,i){super(e),this.response=i}}class so extends sn{constructor(e){super(e),this.mimeType="",this.responseType="",this._abortController=new AbortController}load(e,i,r,n){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);let a=si.get(`file:${e}`);if(void 0!==a)return this.manager.itemStart(e),setTimeout(()=>{i&&i(a),this.manager.itemEnd(e)},0),a;if(void 0!==sa[e])return void sa[e].push({onLoad:i,onProgress:r,onError:n});sa[e]=[],sa[e].push({onLoad:i,onProgress:r,onError:n});let s=new Request(e,{headers:new Headers(this.requestHeader),credentials:this.withCredentials?"include":"same-origin",signal:"function"==typeof AbortSignal.any?AbortSignal.any([this._abortController.signal,this.manager.abortController.signal]):this._abortController.signal}),o=this.mimeType,l=this.responseType;fetch(s).then(i=>{if(200===i.status||0===i.status){if(0===i.status&&tJ("FileLoader: HTTP Status 0 received."),"u"<typeof ReadableStream||void 0===i.body||void 0===i.body.getReader)return i;let r=sa[e],n=i.body.getReader(),a=i.headers.get("X-File-Size")||i.headers.get("Content-Length"),s=a?parseInt(a):0,o=0!==s,l=0;return new Response(new ReadableStream({start(e){!function i(){n.read().then(({done:n,value:a})=>{if(n)e.close();else{let n=new ProgressEvent("progress",{lengthComputable:o,loaded:l+=a.byteLength,total:s});for(let e=0,i=r.length;e<i;e++){let i=r[e];i.onProgress&&i.onProgress(n)}e.enqueue(a),i()}},i=>{e.error(i)})}()}}))}throw new ss(`fetch for "${i.url}" responded with ${i.status}: ${i.statusText}`,i)}).then(e=>{switch(l){case"arraybuffer":return e.arrayBuffer();case"blob":return e.blob();case"document":return e.text().then(e=>new DOMParser().parseFromString(e,o));case"json":return e.json();default:if(""===o)return e.text();{let i=/charset="?([^;"\s]*)"?/i.exec(o),r=new TextDecoder(i&&i[1]?i[1].toLowerCase():void 0);return e.arrayBuffer().then(e=>r.decode(e))}}}).then(i=>{si.add(`file:${e}`,i);let r=sa[e];delete sa[e];for(let e=0,n=r.length;e<n;e++){let n=r[e];n.onLoad&&n.onLoad(i)}}).catch(i=>{let r=sa[e];if(void 0===r)throw this.manager.itemError(e),i;delete sa[e];for(let e=0,n=r.length;e<n;e++){let n=r[e];n.onError&&n.onError(i)}this.manager.itemError(e)}).finally(()=>{this.manager.itemEnd(e)}),this.manager.itemStart(e)}setResponseType(e){return this.responseType=e,this}setMimeType(e){return this.mimeType=e,this}abort(){return this._abortController.abort(),this._abortController=new AbortController,this}}let sl=new WeakMap;class sc extends sn{constructor(e){super(e)}load(e,i,r,n){void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);let a=this,s=si.get(`image:${e}`);if(void 0!==s){if(!0===s.complete)a.manager.itemStart(e),setTimeout(function(){i&&i(s),a.manager.itemEnd(e)},0);else{let e=sl.get(s);void 0===e&&(e=[],sl.set(s,e)),e.push({onLoad:i,onError:n})}return s}let o=tj("img");function l(){h(),i&&i(this);let r=sl.get(this)||[];for(let e=0;e<r.length;e++){let i=r[e];i.onLoad&&i.onLoad(this)}sl.delete(this),a.manager.itemEnd(e)}function c(i){h(),n&&n(i),si.remove(`image:${e}`);let r=sl.get(this)||[];for(let e=0;e<r.length;e++){let n=r[e];n.onError&&n.onError(i)}sl.delete(this),a.manager.itemError(e),a.manager.itemEnd(e)}function h(){o.removeEventListener("load",l,!1),o.removeEventListener("error",c,!1)}return o.addEventListener("load",l,!1),o.addEventListener("error",c,!1),"data:"!==e.slice(0,5)&&void 0!==this.crossOrigin&&(o.crossOrigin=this.crossOrigin),si.add(`image:${e}`,o),a.manager.itemStart(e),o.src=e,o}}class sh extends sn{constructor(e){super(e)}load(e,i,r,n){let a=new iS,s=new sc(this.manager);return s.setCrossOrigin(this.crossOrigin),s.setPath(this.path),s.load(e,function(e){a.image=e,a.needsUpdate=!0,void 0!==i&&i(a)},r,n),a}}class su extends r_{constructor(e,i=1){super(),this.isLight=!0,this.type="Light",this.color=new rF(e),this.intensity=i}dispose(){this.dispatchEvent({type:"dispose"})}copy(e,i){return super.copy(e,i),this.color.copy(e.color),this.intensity=e.intensity,this}toJSON(e){let i=super.toJSON(e);return i.object.color=this.color.getHex(),i.object.intensity=this.intensity,i}}let sd=new i1,sp=new ia,sf=new ia;class sm{constructor(e){this.camera=e,this.intensity=1,this.bias=0,this.normalBias=0,this.radius=1,this.blurSamples=8,this.mapSize=new ii(512,512),this.mapType=eR,this.map=null,this.mapPass=null,this.matrix=new i1,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new n6,this._frameExtents=new ii(1,1),this._viewportCount=1,this._viewports=[new ib(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(e){let i=this.camera,r=this.matrix;sp.setFromMatrixPosition(e.matrixWorld),i.position.copy(sp),sf.setFromMatrixPosition(e.target.matrixWorld),i.lookAt(sf),i.updateMatrixWorld(),sd.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),this._frustum.setFromProjectionMatrix(sd,i.coordinateSystem,i.reversedDepth),i.reversedDepth?r.set(.5,0,0,.5,0,.5,0,.5,0,0,1,0,0,0,0,1):r.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),r.multiply(sd)}getViewport(e){return this._viewports[e]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(e){return this.camera=e.camera.clone(),this.intensity=e.intensity,this.bias=e.bias,this.radius=e.radius,this.autoUpdate=e.autoUpdate,this.needsUpdate=e.needsUpdate,this.normalBias=e.normalBias,this.blurSamples=e.blurSamples,this.mapSize.copy(e.mapSize),this}clone(){return new this.constructor().copy(this)}toJSON(){let e={};return 1!==this.intensity&&(e.intensity=this.intensity),0!==this.bias&&(e.bias=this.bias),0!==this.normalBias&&(e.normalBias=this.normalBias),1!==this.radius&&(e.radius=this.radius),(512!==this.mapSize.x||512!==this.mapSize.y)&&(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}}class sg extends sm{constructor(){super(new n_(50,1,.5,500)),this.isSpotLightShadow=!0,this.focus=1,this.aspect=1}updateMatrices(e){let i=this.camera,r=2*t4*e.angle*this.focus,n=this.mapSize.width/this.mapSize.height*this.aspect,a=e.distance||i.far;(r!==i.fov||n!==i.aspect||a!==i.far)&&(i.fov=r,i.aspect=n,i.far=a,i.updateProjectionMatrix()),super.updateMatrices(e)}copy(e){return super.copy(e),this.focus=e.focus,this}}class sv extends su{constructor(e,i,r=0,n=Math.PI/3,a=0,s=2){super(e,i),this.isSpotLight=!0,this.type="SpotLight",this.position.copy(r_.DEFAULT_UP),this.updateMatrix(),this.target=new r_,this.distance=r,this.angle=n,this.penumbra=a,this.decay=s,this.map=null,this.shadow=new sg}get power(){return this.intensity*Math.PI}set power(e){this.intensity=e/Math.PI}dispose(){super.dispose(),this.shadow.dispose()}copy(e,i){return super.copy(e,i),this.distance=e.distance,this.angle=e.angle,this.penumbra=e.penumbra,this.decay=e.decay,this.target=e.target.clone(),this.map=e.map,this.shadow=e.shadow.clone(),this}toJSON(e){let i=super.toJSON(e);return i.object.distance=this.distance,i.object.angle=this.angle,i.object.decay=this.decay,i.object.penumbra=this.penumbra,i.object.target=this.target.uuid,this.map&&this.map.isTexture&&(i.object.map=this.map.toJSON(e).uuid),i.object.shadow=this.shadow.toJSON(),i}}class s_ extends sm{constructor(){super(new n_(90,1,.5,500)),this.isPointLightShadow=!0}}class sy extends su{constructor(e,i,r=0,n=2){super(e,i),this.isPointLight=!0,this.type="PointLight",this.distance=r,this.decay=n,this.shadow=new s_}get power(){return 4*this.intensity*Math.PI}set power(e){this.intensity=e/(4*Math.PI)}dispose(){super.dispose(),this.shadow.dispose()}copy(e,i){return super.copy(e,i),this.distance=e.distance,this.decay=e.decay,this.shadow=e.shadow.clone(),this}toJSON(e){let i=super.toJSON(e);return i.object.distance=this.distance,i.object.decay=this.decay,i.object.shadow=this.shadow.toJSON(),i}}class sx extends nf{constructor(e=-1,i=1,r=1,n=-1,a=.1,s=2e3){super(),this.isOrthographicCamera=!0,this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=i,this.top=r,this.bottom=n,this.near=a,this.far=s,this.updateProjectionMatrix()}copy(e,i){return super.copy(e,i),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=null===e.view?null:Object.assign({},e.view),this}setViewOffset(e,i,r,n,a,s){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=i,this.view.offsetX=r,this.view.offsetY=n,this.view.width=a,this.view.height=s,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){let e=(this.right-this.left)/(2*this.zoom),i=(this.top-this.bottom)/(2*this.zoom),r=(this.right+this.left)/2,n=(this.top+this.bottom)/2,a=r-e,s=r+e,o=n+i,l=n-i;if(null!==this.view&&this.view.enabled){let e=(this.right-this.left)/this.view.fullWidth/this.zoom,i=(this.top-this.bottom)/this.view.fullHeight/this.zoom;a+=e*this.view.offsetX,s=a+e*this.view.width,o-=i*this.view.offsetY,l=o-i*this.view.height}this.projectionMatrix.makeOrthographic(a,s,o,l,this.near,this.far,this.coordinateSystem,this.reversedDepth),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){let i=super.toJSON(e);return i.object.zoom=this.zoom,i.object.left=this.left,i.object.right=this.right,i.object.top=this.top,i.object.bottom=this.bottom,i.object.near=this.near,i.object.far=this.far,null!==this.view&&(i.object.view=Object.assign({},this.view)),i}}class sM extends sm{constructor(){super(new sx(-5,5,5,-5,.5,500)),this.isDirectionalLightShadow=!0}}class sS extends su{constructor(e,i){super(e,i),this.isDirectionalLight=!0,this.type="DirectionalLight",this.position.copy(r_.DEFAULT_UP),this.updateMatrix(),this.target=new r_,this.shadow=new sM}dispose(){super.dispose(),this.shadow.dispose()}copy(e){return super.copy(e),this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}toJSON(e){let i=super.toJSON(e);return i.object.shadow=this.shadow.toJSON(),i.object.target=this.target.uuid,i}}class sb extends su{constructor(e,i){super(e,i),this.isAmbientLight=!0,this.type="AmbientLight"}}class sT{static extractUrlBase(e){let i=e.lastIndexOf("/");return -1===i?"./":e.slice(0,i+1)}static resolveURL(e,i){return"string"!=typeof e||""===e?"":(/^https?:\/\//i.test(i)&&/^\//.test(e)&&(i=i.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e))?e:i+e}}let sE=new WeakMap;class sw extends sn{constructor(e){super(e),this.isImageBitmapLoader=!0,"u"<typeof createImageBitmap&&tJ("ImageBitmapLoader: createImageBitmap() not supported."),"u"<typeof fetch&&tJ("ImageBitmapLoader: fetch() not supported."),this.options={premultiplyAlpha:"none"},this._abortController=new AbortController}setOptions(e){return this.options=e,this}load(e,i,r,n){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);let a=this,s=si.get(`image-bitmap:${e}`);if(void 0!==s)return(a.manager.itemStart(e),s.then)?void s.then(r=>{if(!0!==sE.has(s))return i&&i(r),a.manager.itemEnd(e),r;n&&n(sE.get(s)),a.manager.itemError(e),a.manager.itemEnd(e)}):(setTimeout(function(){i&&i(s),a.manager.itemEnd(e)},0),s);let o={};o.credentials="anonymous"===this.crossOrigin?"same-origin":"include",o.headers=this.requestHeader,o.signal="function"==typeof AbortSignal.any?AbortSignal.any([this._abortController.signal,this.manager.abortController.signal]):this._abortController.signal;let l=fetch(e,o).then(function(e){return e.blob()}).then(function(e){return createImageBitmap(e,Object.assign(a.options,{colorSpaceConversion:"none"}))}).then(function(r){return si.add(`image-bitmap:${e}`,r),i&&i(r),a.manager.itemEnd(e),r}).catch(function(i){n&&n(i),sE.set(l,i),si.remove(`image-bitmap:${e}`),a.manager.itemError(e),a.manager.itemEnd(e)});si.add(`image-bitmap:${e}`,l),a.manager.itemStart(e)}abort(){return this._abortController.abort(),this._abortController=new AbortController,this}}class sA{static getContext(){return void 0===a&&(a=new(window.AudioContext||window.webkitAudioContext)),a}static setContext(e){a=e}}class sR extends sn{constructor(e){super(e)}load(e,i,r,n){let a=this,s=new so(this.manager);function o(i){n?n(i):tZ(i),a.manager.itemError(e)}s.setResponseType("arraybuffer"),s.setPath(this.path),s.setRequestHeader(this.requestHeader),s.setWithCredentials(this.withCredentials),s.load(e,function(e){try{let r=e.slice(0);sA.getContext().decodeAudioData(r,function(e){i(e)}).catch(o)}catch(e){o(e)}},r,n)}}class sC extends n_{constructor(e=[]){super(),this.isArrayCamera=!0,this.isMultiViewCamera=!1,this.cameras=e}}class sP{constructor(e=!0){this.autoStart=e,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=performance.now(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let e=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){let i=performance.now();e=(i-this.oldTime)/1e3,this.oldTime=i,this.elapsedTime+=e}return e}}let sI=new ia,sL=new ir,sD=new ia,sU=new ia,sN=new ia;class sO extends r_{constructor(){super(),this.type="AudioListener",this.context=sA.getContext(),this.gain=this.context.createGain(),this.gain.connect(this.context.destination),this.filter=null,this.timeDelta=0,this._clock=new sP}getInput(){return this.gain}removeFilter(){return null!==this.filter&&(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination),this.gain.connect(this.context.destination),this.filter=null),this}getFilter(){return this.filter}setFilter(e){return null!==this.filter?(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination)):this.gain.disconnect(this.context.destination),this.filter=e,this.gain.connect(this.filter),this.filter.connect(this.context.destination),this}getMasterVolume(){return this.gain.gain.value}setMasterVolume(e){return this.gain.gain.setTargetAtTime(e,this.context.currentTime,.01),this}updateMatrixWorld(e){super.updateMatrixWorld(e);let i=this.context.listener;if(this.timeDelta=this._clock.getDelta(),this.matrixWorld.decompose(sI,sL,sD),sU.set(0,0,-1).applyQuaternion(sL),sN.set(0,1,0).applyQuaternion(sL),i.positionX){let e=this.context.currentTime+this.timeDelta;i.positionX.linearRampToValueAtTime(sI.x,e),i.positionY.linearRampToValueAtTime(sI.y,e),i.positionZ.linearRampToValueAtTime(sI.z,e),i.forwardX.linearRampToValueAtTime(sU.x,e),i.forwardY.linearRampToValueAtTime(sU.y,e),i.forwardZ.linearRampToValueAtTime(sU.z,e),i.upX.linearRampToValueAtTime(sN.x,e),i.upY.linearRampToValueAtTime(sN.y,e),i.upZ.linearRampToValueAtTime(sN.z,e)}else i.setPosition(sI.x,sI.y,sI.z),i.setOrientation(sU.x,sU.y,sU.z,sN.x,sN.y,sN.z)}}class sF extends r_{constructor(e){super(),this.type="Audio",this.listener=e,this.context=e.context,this.gain=this.context.createGain(),this.gain.connect(e.getInput()),this.autoplay=!1,this.buffer=null,this.detune=0,this.loop=!1,this.loopStart=0,this.loopEnd=0,this.offset=0,this.duration=void 0,this.playbackRate=1,this.isPlaying=!1,this.hasPlaybackControl=!0,this.source=null,this.sourceType="empty",this._startedAt=0,this._progress=0,this._connected=!1,this.filters=[]}getOutput(){return this.gain}setNodeSource(e){return this.hasPlaybackControl=!1,this.sourceType="audioNode",this.source=e,this.connect(),this}setMediaElementSource(e){return this.hasPlaybackControl=!1,this.sourceType="mediaNode",this.source=this.context.createMediaElementSource(e),this.connect(),this}setMediaStreamSource(e){return this.hasPlaybackControl=!1,this.sourceType="mediaStreamNode",this.source=this.context.createMediaStreamSource(e),this.connect(),this}setBuffer(e){return this.buffer=e,this.sourceType="buffer",this.autoplay&&this.play(),this}play(e=0){if(!0===this.isPlaying)return void tJ("Audio: Audio is already playing.");if(!1===this.hasPlaybackControl)return void tJ("Audio: this Audio has no playback control.");this._startedAt=this.context.currentTime+e;let i=this.context.createBufferSource();return i.buffer=this.buffer,i.loop=this.loop,i.loopStart=this.loopStart,i.loopEnd=this.loopEnd,i.onended=this.onEnded.bind(this),i.start(this._startedAt,this._progress+this.offset,this.duration),this.isPlaying=!0,this.source=i,this.setDetune(this.detune),this.setPlaybackRate(this.playbackRate),this.connect()}pause(){return!1===this.hasPlaybackControl?void tJ("Audio: this Audio has no playback control."):(!0===this.isPlaying&&(this._progress+=Math.max(this.context.currentTime-this._startedAt,0)*this.playbackRate,!0===this.loop&&(this._progress=this._progress%(this.duration||this.buffer.duration)),this.source.stop(),this.source.onended=null,this.isPlaying=!1),this)}stop(e=0){return!1===this.hasPlaybackControl?void tJ("Audio: this Audio has no playback control."):(this._progress=0,null!==this.source&&(this.source.stop(this.context.currentTime+e),this.source.onended=null),this.isPlaying=!1,this)}connect(){if(this.filters.length>0){this.source.connect(this.filters[0]);for(let e=1,i=this.filters.length;e<i;e++)this.filters[e-1].connect(this.filters[e]);this.filters[this.filters.length-1].connect(this.getOutput())}else this.source.connect(this.getOutput());return this._connected=!0,this}disconnect(){if(!1!==this._connected){if(this.filters.length>0){this.source.disconnect(this.filters[0]);for(let e=1,i=this.filters.length;e<i;e++)this.filters[e-1].disconnect(this.filters[e]);this.filters[this.filters.length-1].disconnect(this.getOutput())}else this.source.disconnect(this.getOutput());return this._connected=!1,this}}getFilters(){return this.filters}setFilters(e){return e||(e=[]),!0===this._connected?(this.disconnect(),this.filters=e.slice(),this.connect()):this.filters=e.slice(),this}setDetune(e){return this.detune=e,!0===this.isPlaying&&void 0!==this.source.detune&&this.source.detune.setTargetAtTime(this.detune,this.context.currentTime,.01),this}getDetune(){return this.detune}getFilter(){return this.getFilters()[0]}setFilter(e){return this.setFilters(e?[e]:[])}setPlaybackRate(e){return!1===this.hasPlaybackControl?void tJ("Audio: this Audio has no playback control."):(this.playbackRate=e,!0===this.isPlaying&&this.source.playbackRate.setTargetAtTime(this.playbackRate,this.context.currentTime,.01),this)}getPlaybackRate(){return this.playbackRate}onEnded(){this.isPlaying=!1,this._progress=0}getLoop(){return!1===this.hasPlaybackControl?(tJ("Audio: this Audio has no playback control."),!1):this.loop}setLoop(e){return!1===this.hasPlaybackControl?void tJ("Audio: this Audio has no playback control."):(this.loop=e,!0===this.isPlaying&&(this.source.loop=this.loop),this)}setLoopStart(e){return this.loopStart=e,this}setLoopEnd(e){return this.loopEnd=e,this}getVolume(){return this.gain.gain.value}setVolume(e){return this.gain.gain.setTargetAtTime(e,this.context.currentTime,.01),this}copy(e,i){return(super.copy(e,i),"buffer"!==e.sourceType)?tJ("Audio: Audio source type cannot be copied."):(this.autoplay=e.autoplay,this.buffer=e.buffer,this.detune=e.detune,this.loop=e.loop,this.loopStart=e.loopStart,this.loopEnd=e.loopEnd,this.offset=e.offset,this.duration=e.duration,this.playbackRate=e.playbackRate,this.hasPlaybackControl=e.hasPlaybackControl,this.sourceType=e.sourceType,this.filters=e.filters.slice()),this}clone(e){return new this.constructor(this.listener).copy(this,e)}}let sB="\\[\\]\\.:\\/",sz=RegExp("["+sB+"]","g"),sk="[^"+sB+"]",sV="[^"+sB.replace("\\.","")+"]",sH=RegExp("^"+/((?:WC+[\/:])*)/.source.replace("WC",sk)+/(WCOD+)?/.source.replace("WCOD",sV)+/(?:\.(WC+)(?:\[(.+)\])?)?/.source.replace("WC",sk)+/\.(WC+)(?:\[(.+)\])?/.source.replace("WC",sk)+"$"),sG=["material","materials","bones","map"];class sW{constructor(e,i,r){this.path=i,this.parsedPath=r||sW.parseTrackName(i),this.node=sW.findNode(e,this.parsedPath.nodeName),this.rootNode=e,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}static create(e,i,r){return e&&e.isAnimationObjectGroup?new sW.Composite(e,i,r):new sW(e,i,r)}static sanitizeNodeName(e){return e.replace(/\s/g,"_").replace(sz,"")}static parseTrackName(e){let i=sH.exec(e);if(null===i)throw Error("PropertyBinding: Cannot parse trackName: "+e);let r={nodeName:i[2],objectName:i[3],objectIndex:i[4],propertyName:i[5],propertyIndex:i[6]},n=r.nodeName&&r.nodeName.lastIndexOf(".");if(void 0!==n&&-1!==n){let e=r.nodeName.substring(n+1);-1!==sG.indexOf(e)&&(r.nodeName=r.nodeName.substring(0,n),r.objectName=e)}if(null===r.propertyName||0===r.propertyName.length)throw Error("PropertyBinding: can not parse propertyName from trackName: "+e);return r}static findNode(e,i){if(void 0===i||""===i||"."===i||-1===i||i===e.name||i===e.uuid)return e;if(e.skeleton){let r=e.skeleton.getBoneByName(i);if(void 0!==r)return r}if(e.children){let r=function(e){for(let n=0;n<e.length;n++){let a=e[n];if(a.name===i||a.uuid===i)return a;let s=r(a.children);if(s)return s}return null},n=r(e.children);if(n)return n}return null}_getValue_unavailable(){}_setValue_unavailable(){}_getValue_direct(e,i){e[i]=this.targetObject[this.propertyName]}_getValue_array(e,i){let r=this.resolvedProperty;for(let n=0,a=r.length;n!==a;++n)e[i++]=r[n]}_getValue_arrayElement(e,i){e[i]=this.resolvedProperty[this.propertyIndex]}_getValue_toArray(e,i){this.resolvedProperty.toArray(e,i)}_setValue_direct(e,i){this.targetObject[this.propertyName]=e[i]}_setValue_direct_setNeedsUpdate(e,i){this.targetObject[this.propertyName]=e[i],this.targetObject.needsUpdate=!0}_setValue_direct_setMatrixWorldNeedsUpdate(e,i){this.targetObject[this.propertyName]=e[i],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_array(e,i){let r=this.resolvedProperty;for(let n=0,a=r.length;n!==a;++n)r[n]=e[i++]}_setValue_array_setNeedsUpdate(e,i){let r=this.resolvedProperty;for(let n=0,a=r.length;n!==a;++n)r[n]=e[i++];this.targetObject.needsUpdate=!0}_setValue_array_setMatrixWorldNeedsUpdate(e,i){let r=this.resolvedProperty;for(let n=0,a=r.length;n!==a;++n)r[n]=e[i++];this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_arrayElement(e,i){this.resolvedProperty[this.propertyIndex]=e[i]}_setValue_arrayElement_setNeedsUpdate(e,i){this.resolvedProperty[this.propertyIndex]=e[i],this.targetObject.needsUpdate=!0}_setValue_arrayElement_setMatrixWorldNeedsUpdate(e,i){this.resolvedProperty[this.propertyIndex]=e[i],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_fromArray(e,i){this.resolvedProperty.fromArray(e,i)}_setValue_fromArray_setNeedsUpdate(e,i){this.resolvedProperty.fromArray(e,i),this.targetObject.needsUpdate=!0}_setValue_fromArray_setMatrixWorldNeedsUpdate(e,i){this.resolvedProperty.fromArray(e,i),this.targetObject.matrixWorldNeedsUpdate=!0}_getValue_unbound(e,i){this.bind(),this.getValue(e,i)}_setValue_unbound(e,i){this.bind(),this.setValue(e,i)}bind(){let e=this.node,i=this.parsedPath,r=i.objectName,n=i.propertyName,a=i.propertyIndex;if(e||(e=sW.findNode(this.rootNode,i.nodeName),this.node=e),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,!e)return void tJ("PropertyBinding: No target node found for track: "+this.path+".");if(r){let n=i.objectIndex;switch(r){case"materials":if(!e.material)return void tZ("PropertyBinding: Can not bind to material as node does not have a material.",this);if(!e.material.materials)return void tZ("PropertyBinding: Can not bind to material.materials as node.material does not have a materials array.",this);e=e.material.materials;break;case"bones":if(!e.skeleton)return void tZ("PropertyBinding: Can not bind to bones as node does not have a skeleton.",this);e=e.skeleton.bones;for(let i=0;i<e.length;i++)if(e[i].name===n){n=i;break}break;case"map":if("map"in e){e=e.map;break}if(!e.material)return void tZ("PropertyBinding: Can not bind to material as node does not have a material.",this);if(!e.material.map)return void tZ("PropertyBinding: Can not bind to material.map as node.material does not have a map.",this);e=e.material.map;break;default:if(void 0===e[r])return void tZ("PropertyBinding: Can not bind to objectName of node undefined.",this);e=e[r]}if(void 0!==n){if(void 0===e[n])return void tZ("PropertyBinding: Trying to bind to objectIndex of objectName, but is undefined.",this,e);e=e[n]}}let s=e[n];if(void 0===s)return void tZ("PropertyBinding: Trying to update property for track: "+i.nodeName+"."+n+" but it wasn't found.",e);let o=this.Versioning.None;this.targetObject=e,!0===e.isMaterial?o=this.Versioning.NeedsUpdate:!0===e.isObject3D&&(o=this.Versioning.MatrixWorldNeedsUpdate);let l=this.BindingType.Direct;if(void 0!==a){if("morphTargetInfluences"===n){if(!e.geometry)return void tZ("PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.",this);if(!e.geometry.morphAttributes)return void tZ("PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphAttributes.",this);void 0!==e.morphTargetDictionary[a]&&(a=e.morphTargetDictionary[a])}l=this.BindingType.ArrayElement,this.resolvedProperty=s,this.propertyIndex=a}else void 0!==s.fromArray&&void 0!==s.toArray?(l=this.BindingType.HasFromToArray,this.resolvedProperty=s):Array.isArray(s)?(l=this.BindingType.EntireArray,this.resolvedProperty=s):this.propertyName=n;this.getValue=this.GetterByBindingType[l],this.setValue=this.SetterByBindingTypeAndVersioning[l][o]}unbind(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}sW.Composite=class{constructor(e,i,r){const n=r||sW.parseTrackName(i);this._targetGroup=e,this._bindings=e.subscribe_(i,n)}getValue(e,i){this.bind();let r=this._targetGroup.nCachedObjects_,n=this._bindings[r];void 0!==n&&n.getValue(e,i)}setValue(e,i){let r=this._bindings;for(let n=this._targetGroup.nCachedObjects_,a=r.length;n!==a;++n)r[n].setValue(e,i)}bind(){let e=this._bindings;for(let i=this._targetGroup.nCachedObjects_,r=e.length;i!==r;++i)e[i].bind()}unbind(){let e=this._bindings;for(let i=this._targetGroup.nCachedObjects_,r=e.length;i!==r;++i)e[i].unbind()}},sW.prototype.BindingType={Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},sW.prototype.Versioning={None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},sW.prototype.GetterByBindingType=[sW.prototype._getValue_direct,sW.prototype._getValue_array,sW.prototype._getValue_arrayElement,sW.prototype._getValue_toArray],sW.prototype.SetterByBindingTypeAndVersioning=[[sW.prototype._setValue_direct,sW.prototype._setValue_direct_setNeedsUpdate,sW.prototype._setValue_direct_setMatrixWorldNeedsUpdate],[sW.prototype._setValue_array,sW.prototype._setValue_array_setNeedsUpdate,sW.prototype._setValue_array_setMatrixWorldNeedsUpdate],[sW.prototype._setValue_arrayElement,sW.prototype._setValue_arrayElement_setNeedsUpdate,sW.prototype._setValue_arrayElement_setMatrixWorldNeedsUpdate],[sW.prototype._setValue_fromArray,sW.prototype._setValue_fromArray_setNeedsUpdate,sW.prototype._setValue_fromArray_setMatrixWorldNeedsUpdate]],new Float32Array(1);let sX=new i1;class sj{constructor(e,i,r=0,n=1/0){this.ray=new i0(e,i),this.near=r,this.far=n,this.camera=null,this.layers=new ri,this.params={Mesh:{},Line:{threshold:1},LOD:{},Points:{threshold:1},Sprite:{}}}set(e,i){this.ray.set(e,i)}setFromCamera(e,i){i.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(i.matrixWorld),this.ray.direction.set(e.x,e.y,.5).unproject(i).sub(this.ray.origin).normalize(),this.camera=i):i.isOrthographicCamera?(this.ray.origin.set(e.x,e.y,(i.near+i.far)/(i.near-i.far)).unproject(i),this.ray.direction.set(0,0,-1).transformDirection(i.matrixWorld),this.camera=i):tZ("Raycaster: Unsupported camera type: "+i.type)}setFromXRController(e){return sX.identity().extractRotation(e.matrixWorld),this.ray.origin.setFromMatrixPosition(e.matrixWorld),this.ray.direction.set(0,0,-1).applyMatrix4(sX),this}intersectObject(e,i=!0,r=[]){return sY(e,this,r,i),r.sort(sq),r}intersectObjects(e,i=!0,r=[]){for(let n=0,a=e.length;n<a;n++)sY(e[n],this,r,i);return r.sort(sq),r}}function sq(e,i){return e.distance-i.distance}function sY(e,i,r,n){let a=!0;if(e.layers.test(i.layers)&&!1===e.raycast(i,r)&&(a=!1),!0===a&&!0===n){let n=e.children;for(let e=0,a=n.length;e<a;e++)sY(n[e],i,r,!0)}}let sK=new ia,sJ=new ia,sZ=new ia,sQ=new ia,s$=new ia,s0=new ia,s1=new ia;class s3{constructor(e=new ia,i=new ia){this.start=e,this.end=i}set(e,i){return this.start.copy(e),this.end.copy(i),this}copy(e){return this.start.copy(e.start),this.end.copy(e.end),this}getCenter(e){return e.addVectors(this.start,this.end).multiplyScalar(.5)}delta(e){return e.subVectors(this.end,this.start)}distanceSq(){return this.start.distanceToSquared(this.end)}distance(){return this.start.distanceTo(this.end)}at(e,i){return this.delta(i).multiplyScalar(e).add(this.start)}closestPointToPointParameter(e,i){sK.subVectors(e,this.start),sJ.subVectors(this.end,this.start);let r=sJ.dot(sJ),n=sJ.dot(sK)/r;return i&&(n=t6(n,0,1)),n}closestPointToPoint(e,i,r){let n=this.closestPointToPointParameter(e,i);return this.delta(r).multiplyScalar(n).add(this.start)}distanceSqToLine3(e,i=s0,r=s1){let n,a,s=1e-8*1e-8,o=this.start,l=e.start,c=this.end,h=e.end;sZ.subVectors(c,o),sQ.subVectors(h,l),s$.subVectors(o,l);let u=sZ.dot(sZ),d=sQ.dot(sQ),p=sQ.dot(s$);if(u<=s&&d<=s)return i.copy(o),r.copy(l),i.sub(r),i.dot(i);if(u<=s)n=0,a=t6(a=p/d,0,1);else{let e=sZ.dot(s$);if(d<=s)a=0,n=t6(-e/u,0,1);else{let i=sZ.dot(sQ),r=u*d-i*i;n=0!==r?t6((i*p-e*d)/r,0,1):0,(a=(i*n+p)/d)<0?(a=0,n=t6(-e/u,0,1)):a>1&&(a=1,n=t6((i-e)/u,0,1))}}return i.copy(o).add(sZ.multiplyScalar(n)),r.copy(l).add(sQ.multiplyScalar(a)),i.sub(r),i.dot(i)}applyMatrix4(e){return this.start.applyMatrix4(e),this.end.applyMatrix4(e),this}equals(e){return e.start.equals(this.start)&&e.end.equals(this.end)}clone(){return new this.constructor().copy(this)}}let s2=new ia;class s4 extends r_{constructor(e=new ia(0,0,1),i=new ia(0,0,0),r=1,n=0xffff00,a=.2*r,l=.2*a){super(),this.type="ArrowHelper",void 0===s&&((s=new r3).setAttribute("position",new rY([0,0,0,0,1,0],3)),(o=new aE(.5,1,5,1)).translate(0,-.5,0)),this.position.copy(i),this.line=new aa(s,new n8({color:n,toneMapped:!1})),this.line.matrixAutoUpdate=!1,this.add(this.line),this.cone=new nn(o,new rV({color:n,toneMapped:!1})),this.cone.matrixAutoUpdate=!1,this.add(this.cone),this.setDirection(e),this.setLength(r,a,l)}setDirection(e){if(e.y>.99999)this.quaternion.set(0,0,0,1);else if(e.y<-.99999)this.quaternion.set(1,0,0,0);else{s2.set(e.z,0,-e.x).normalize();let i=Math.acos(e.y);this.quaternion.setFromAxisAngle(s2,i)}}setLength(e,i=.2*e,r=.2*i){this.line.scale.set(1,Math.max(1e-4,e-i),1),this.line.updateMatrix(),this.cone.scale.set(r,i,r),this.cone.position.y=e,this.cone.updateMatrix()}setColor(e){this.line.material.color.set(e),this.cone.material.color.set(e)}copy(e){return super.copy(e,!1),this.line.copy(e.line),this.cone.copy(e.cone),this}dispose(){this.line.geometry.dispose(),this.line.material.dispose(),this.cone.geometry.dispose(),this.cone.material.dispose()}}function s5(e,i,r,n){let a=function(e){switch(e){case eR:case eC:return{byteLength:1,components:1};case eI:case eP:case eN:return{byteLength:2,components:1};case eO:case eF:return{byteLength:2,components:4};case eD:case eL:case eU:return{byteLength:4,components:1};case ez:case ek:return{byteLength:4,components:3}}throw Error(`Unknown texture type ${e}.`)}(n);switch(r){case eV:return e*i;case ej:case eq:return e*i/a.components*a.byteLength;case eY:case eK:return e*i*2/a.components*a.byteLength;case eH:return e*i*3/a.components*a.byteLength;case eG:case eJ:return e*i*4/a.components*a.byteLength;case eZ:case eQ:return Math.floor((e+3)/4)*Math.floor((i+3)/4)*8;case e$:case e0:return Math.floor((e+3)/4)*Math.floor((i+3)/4)*16;case e3:case e4:return Math.max(e,16)*Math.max(i,8)/4;case e1:case e2:return Math.max(e,8)*Math.max(i,8)/2;case e5:case e6:case e9:case e7:return Math.floor((e+3)/4)*Math.floor((i+3)/4)*8;case e8:case te:case tt:case ti:return Math.floor((e+3)/4)*Math.floor((i+3)/4)*16;case tr:return Math.floor((e+4)/5)*Math.floor((i+3)/4)*16;case tn:return Math.floor((e+4)/5)*Math.floor((i+4)/5)*16;case ta:return Math.floor((e+5)/6)*Math.floor((i+4)/5)*16;case ts:return Math.floor((e+5)/6)*Math.floor((i+5)/6)*16;case to:return Math.floor((e+7)/8)*Math.floor((i+4)/5)*16;case tl:return Math.floor((e+7)/8)*Math.floor((i+5)/6)*16;case tc:return Math.floor((e+7)/8)*Math.floor((i+7)/8)*16;case th:return Math.floor((e+9)/10)*Math.floor((i+4)/5)*16;case tu:return Math.floor((e+9)/10)*Math.floor((i+5)/6)*16;case td:return Math.floor((e+9)/10)*Math.floor((i+7)/8)*16;case tp:return Math.floor((e+9)/10)*Math.floor((i+9)/10)*16;case tf:return Math.floor((e+11)/12)*Math.floor((i+9)/10)*16;case tm:return Math.floor((e+11)/12)*Math.floor((i+11)/12)*16;case tg:case tv:case t_:return Math.ceil(e/4)*Math.ceil(i/4)*16;case ty:case tx:return Math.ceil(e/4)*Math.ceil(i/4)*8;case tM:case tS:return Math.ceil(e/4)*Math.ceil(i/4)*16}throw Error(`Unable to determine texture byte length for ${r} format.`)}"u">typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:d}})),"u">typeof window&&(window.__THREE__?tJ("WARNING: Multiple instances of Three.js being imported."):window.__THREE__=d)},"./node_modules/three/build/three.module.js"(e,i,r){"use strict";r.d(i,{JeP:()=>tV});var n=r("./node_modules/three/build/three.core.js");function a(){let e=null,i=!1,r=null,n=null;function a(i,s){r(i,s),n=e.requestAnimationFrame(a)}return{start:function(){!0===i||null!==r&&(n=e.requestAnimationFrame(a),i=!0)},stop:function(){e.cancelAnimationFrame(n),i=!1},setAnimationLoop:function(e){r=e},setContext:function(i){e=i}}}function s(e){let i=new WeakMap;return{get:function(e){return e.isInterleavedBufferAttribute&&(e=e.data),i.get(e)},remove:function(r){r.isInterleavedBufferAttribute&&(r=r.data);let n=i.get(r);n&&(e.deleteBuffer(n.buffer),i.delete(r))},update:function(r,n){if(r.isInterleavedBufferAttribute&&(r=r.data),r.isGLBufferAttribute){let e=i.get(r);(!e||e.version<r.version)&&i.set(r,{buffer:r.buffer,type:r.type,bytesPerElement:r.elementSize,version:r.version});return}let a=i.get(r);if(void 0===a)i.set(r,function(i,r){let n,a=i.array,s=i.usage,o=a.byteLength,l=e.createBuffer();if(e.bindBuffer(r,l),e.bufferData(r,a,s),i.onUploadCallback(),a instanceof Float32Array)n=e.FLOAT;else if("u">typeof Float16Array&&a instanceof Float16Array)n=e.HALF_FLOAT;else if(a instanceof Uint16Array)n=i.isFloat16BufferAttribute?e.HALF_FLOAT:e.UNSIGNED_SHORT;else if(a instanceof Int16Array)n=e.SHORT;else if(a instanceof Uint32Array)n=e.UNSIGNED_INT;else if(a instanceof Int32Array)n=e.INT;else if(a instanceof Int8Array)n=e.BYTE;else if(a instanceof Uint8Array)n=e.UNSIGNED_BYTE;else if(a instanceof Uint8ClampedArray)n=e.UNSIGNED_BYTE;else throw Error("THREE.WebGLAttributes: Unsupported buffer data format: "+a);return{buffer:l,type:n,bytesPerElement:a.BYTES_PER_ELEMENT,version:i.version,size:o}}(r,n));else if(a.version<r.version){if(a.size!==r.array.byteLength)throw Error("THREE.WebGLAttributes: The size of the buffer attribute's array buffer does not match the original size. Resizing buffer attributes is not supported.");!function(i,r,n){let a=r.array,s=r.updateRanges;if(e.bindBuffer(n,i),0===s.length)e.bufferSubData(n,0,a);else{s.sort((e,i)=>e.start-i.start);let i=0;for(let e=1;e<s.length;e++){let r=s[i],n=s[e];n.start<=r.start+r.count+1?r.count=Math.max(r.count,n.start+n.count-r.start):s[++i]=n}s.length=i+1;for(let i=0,r=s.length;i<r;i++){let r=s[i];e.bufferSubData(n,r.start*a.BYTES_PER_ELEMENT,a,r.start,r.count)}r.clearUpdateRanges()}r.onUploadCallback()}(a.buffer,r,n),a.version=r.version}}}}let o={alphahash_fragment:`#ifdef USE_ALPHAHASH
+			`},n=new ns(5,5,5),a=new np({name:"CubemapFromEquirect",uniforms:no(r.uniforms),vertexShader:r.vertexShader,fragmentShader:r.fragmentShader,side:y,blending:S});a.uniforms.tEquirect.value=i;let s=new nn(n,a),o=i.minFilter;return i.minFilter===eA&&(i.minFilter=eE),new nx(1,10,this).update(e,s),i.minFilter=o,s.geometry.dispose(),s.material.dispose(),this}clear(e,i=!0,r=!0,n=!0){let a=e.getRenderTarget();for(let a=0;a<6;a++)e.setRenderTarget(this,a),e.clear(i,r,n);e.setRenderTarget(a)}}class nS extends r_{constructor(){super(),this.isGroup=!0,this.type="Group"}}let nb={type:"move"};class nT{constructor(){this._targetRay=null,this._grip=null,this._hand=null}getHandSpace(){return null===this._hand&&(this._hand=new nS,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand}getTargetRaySpace(){return null===this._targetRay&&(this._targetRay=new nS,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1,this._targetRay.hasLinearVelocity=!1,this._targetRay.linearVelocity=new ia,this._targetRay.hasAngularVelocity=!1,this._targetRay.angularVelocity=new ia),this._targetRay}getGripSpace(){return null===this._grip&&(this._grip=new nS,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1,this._grip.hasLinearVelocity=!1,this._grip.linearVelocity=new ia,this._grip.hasAngularVelocity=!1,this._grip.angularVelocity=new ia),this._grip}dispatchEvent(e){return null!==this._targetRay&&this._targetRay.dispatchEvent(e),null!==this._grip&&this._grip.dispatchEvent(e),null!==this._hand&&this._hand.dispatchEvent(e),this}connect(e){if(e&&e.hand){let i=this._hand;if(i)for(let r of e.hand.values())this._getHandJoint(i,r)}return this.dispatchEvent({type:"connected",data:e}),this}disconnect(e){return this.dispatchEvent({type:"disconnected",data:e}),null!==this._targetRay&&(this._targetRay.visible=!1),null!==this._grip&&(this._grip.visible=!1),null!==this._hand&&(this._hand.visible=!1),this}update(e,i,r){let n=null,a=null,s=null,o=this._targetRay,l=this._grip,c=this._hand;if(e&&"visible-blurred"!==i.session.visibilityState){if(c&&e.hand){for(let n of(s=!0,e.hand.values())){let e=i.getJointPose(n,r),a=this._getHandJoint(c,n);null!==e&&(a.matrix.fromArray(e.transform.matrix),a.matrix.decompose(a.position,a.rotation,a.scale),a.matrixWorldNeedsUpdate=!0,a.jointRadius=e.radius),a.visible=null!==e}let n=c.joints["index-finger-tip"],a=c.joints["thumb-tip"],o=n.position.distanceTo(a.position);c.inputState.pinching&&o>.025?(c.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:e.handedness,target:this})):!c.inputState.pinching&&o<=.015&&(c.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:e.handedness,target:this}))}else null!==l&&e.gripSpace&&null!==(a=i.getPose(e.gripSpace,r))&&(l.matrix.fromArray(a.transform.matrix),l.matrix.decompose(l.position,l.rotation,l.scale),l.matrixWorldNeedsUpdate=!0,a.linearVelocity?(l.hasLinearVelocity=!0,l.linearVelocity.copy(a.linearVelocity)):l.hasLinearVelocity=!1,a.angularVelocity?(l.hasAngularVelocity=!0,l.angularVelocity.copy(a.angularVelocity)):l.hasAngularVelocity=!1);null!==o&&(null===(n=i.getPose(e.targetRaySpace,r))&&null!==a&&(n=a),null!==n&&(o.matrix.fromArray(n.transform.matrix),o.matrix.decompose(o.position,o.rotation,o.scale),o.matrixWorldNeedsUpdate=!0,n.linearVelocity?(o.hasLinearVelocity=!0,o.linearVelocity.copy(n.linearVelocity)):o.hasLinearVelocity=!1,n.angularVelocity?(o.hasAngularVelocity=!0,o.angularVelocity.copy(n.angularVelocity)):o.hasAngularVelocity=!1,this.dispatchEvent(nb)))}return null!==o&&(o.visible=null!==n),null!==l&&(l.visible=null!==a),null!==c&&(c.visible=null!==s),this}_getHandJoint(e,i){if(void 0===e.joints[i.jointName]){let r=new nS;r.matrixAutoUpdate=!1,r.visible=!1,e.joints[i.jointName]=r,e.add(r)}return e.joints[i.jointName]}}class nE extends r_{constructor(){super(),this.isScene=!0,this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.backgroundBlurriness=0,this.backgroundIntensity=1,this.backgroundRotation=new rt,this.environmentIntensity=1,this.environmentRotation=new rt,this.overrideMaterial=null,"u">typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(e,i){return super.copy(e,i),null!==e.background&&(this.background=e.background.clone()),null!==e.environment&&(this.environment=e.environment.clone()),null!==e.fog&&(this.fog=e.fog.clone()),this.backgroundBlurriness=e.backgroundBlurriness,this.backgroundIntensity=e.backgroundIntensity,this.backgroundRotation.copy(e.backgroundRotation),this.environmentIntensity=e.environmentIntensity,this.environmentRotation.copy(e.environmentRotation),null!==e.overrideMaterial&&(this.overrideMaterial=e.overrideMaterial.clone()),this.matrixAutoUpdate=e.matrixAutoUpdate,this}toJSON(e){let i=super.toJSON(e);return null!==this.fog&&(i.object.fog=this.fog.toJSON()),this.backgroundBlurriness>0&&(i.object.backgroundBlurriness=this.backgroundBlurriness),1!==this.backgroundIntensity&&(i.object.backgroundIntensity=this.backgroundIntensity),i.object.backgroundRotation=this.backgroundRotation.toArray(),1!==this.environmentIntensity&&(i.object.environmentIntensity=this.environmentIntensity),i.object.environmentRotation=this.environmentRotation.toArray(),i}}class nw{constructor(e,i){this.isInterleavedBuffer=!0,this.array=e,this.stride=i,this.count=void 0!==e?e.length/i:0,this.usage=35044,this.updateRanges=[],this.version=0,this.uuid=t5()}onUploadCallback(){}set needsUpdate(e){!0===e&&this.version++}setUsage(e){return this.usage=e,this}addUpdateRange(e,i){this.updateRanges.push({start:e,count:i})}clearUpdateRanges(){this.updateRanges.length=0}copy(e){return this.array=new e.array.constructor(e.array),this.count=e.count,this.stride=e.stride,this.usage=e.usage,this}copyAt(e,i,r){e*=this.stride,r*=i.stride;for(let n=0,a=this.stride;n<a;n++)this.array[e+n]=i.array[r+n];return this}set(e,i=0){return this.array.set(e,i),this}clone(e){void 0===e.arrayBuffers&&(e.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=t5()),void 0===e.arrayBuffers[this.array.buffer._uuid]&&(e.arrayBuffers[this.array.buffer._uuid]=this.array.slice(0).buffer);let i=new this.array.constructor(e.arrayBuffers[this.array.buffer._uuid]),r=new this.constructor(i,this.stride);return r.setUsage(this.usage),r}onUpload(e){return this.onUploadCallback=e,this}toJSON(e){return void 0===e.arrayBuffers&&(e.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=t5()),void 0===e.arrayBuffers[this.array.buffer._uuid]&&(e.arrayBuffers[this.array.buffer._uuid]=Array.from(new Uint32Array(this.array.buffer))),{uuid:this.uuid,buffer:this.array.buffer._uuid,type:this.array.constructor.name,stride:this.stride}}}let nA=new ia;class nR{constructor(e,i,r,n=!1){this.isInterleavedBufferAttribute=!0,this.name="",this.data=e,this.itemSize=i,this.offset=r,this.normalized=n}get count(){return this.data.count}get array(){return this.data.array}set needsUpdate(e){this.data.needsUpdate=e}applyMatrix4(e){for(let i=0,r=this.data.count;i<r;i++)nA.fromBufferAttribute(this,i),nA.applyMatrix4(e),this.setXYZ(i,nA.x,nA.y,nA.z);return this}applyNormalMatrix(e){for(let i=0,r=this.count;i<r;i++)nA.fromBufferAttribute(this,i),nA.applyNormalMatrix(e),this.setXYZ(i,nA.x,nA.y,nA.z);return this}transformDirection(e){for(let i=0,r=this.count;i<r;i++)nA.fromBufferAttribute(this,i),nA.transformDirection(e),this.setXYZ(i,nA.x,nA.y,nA.z);return this}getComponent(e,i){let r=this.array[e*this.data.stride+this.offset+i];return this.normalized&&(r=t7(r,this.array)),r}setComponent(e,i,r){return this.normalized&&(r=ie(r,this.array)),this.data.array[e*this.data.stride+this.offset+i]=r,this}setX(e,i){return this.normalized&&(i=ie(i,this.array)),this.data.array[e*this.data.stride+this.offset]=i,this}setY(e,i){return this.normalized&&(i=ie(i,this.array)),this.data.array[e*this.data.stride+this.offset+1]=i,this}setZ(e,i){return this.normalized&&(i=ie(i,this.array)),this.data.array[e*this.data.stride+this.offset+2]=i,this}setW(e,i){return this.normalized&&(i=ie(i,this.array)),this.data.array[e*this.data.stride+this.offset+3]=i,this}getX(e){let i=this.data.array[e*this.data.stride+this.offset];return this.normalized&&(i=t7(i,this.array)),i}getY(e){let i=this.data.array[e*this.data.stride+this.offset+1];return this.normalized&&(i=t7(i,this.array)),i}getZ(e){let i=this.data.array[e*this.data.stride+this.offset+2];return this.normalized&&(i=t7(i,this.array)),i}getW(e){let i=this.data.array[e*this.data.stride+this.offset+3];return this.normalized&&(i=t7(i,this.array)),i}setXY(e,i,r){return e=e*this.data.stride+this.offset,this.normalized&&(i=ie(i,this.array),r=ie(r,this.array)),this.data.array[e+0]=i,this.data.array[e+1]=r,this}setXYZ(e,i,r,n){return e=e*this.data.stride+this.offset,this.normalized&&(i=ie(i,this.array),r=ie(r,this.array),n=ie(n,this.array)),this.data.array[e+0]=i,this.data.array[e+1]=r,this.data.array[e+2]=n,this}setXYZW(e,i,r,n,a){return e=e*this.data.stride+this.offset,this.normalized&&(i=ie(i,this.array),r=ie(r,this.array),n=ie(n,this.array),a=ie(a,this.array)),this.data.array[e+0]=i,this.data.array[e+1]=r,this.data.array[e+2]=n,this.data.array[e+3]=a,this}clone(e){if(void 0!==e)return void 0===e.interleavedBuffers&&(e.interleavedBuffers={}),void 0===e.interleavedBuffers[this.data.uuid]&&(e.interleavedBuffers[this.data.uuid]=this.data.clone(e)),new nR(e.interleavedBuffers[this.data.uuid],this.itemSize,this.offset,this.normalized);{tK("InterleavedBufferAttribute.clone(): Cloning an interleaved buffer attribute will de-interleave buffer data.");let e=[];for(let i=0;i<this.count;i++){let r=i*this.data.stride+this.offset;for(let i=0;i<this.itemSize;i++)e.push(this.data.array[r+i])}return new rX(new this.array.constructor(e),this.itemSize,this.normalized)}}toJSON(e){if(void 0!==e)return void 0===e.interleavedBuffers&&(e.interleavedBuffers={}),void 0===e.interleavedBuffers[this.data.uuid]&&(e.interleavedBuffers[this.data.uuid]=this.data.toJSON(e)),{isInterleavedBufferAttribute:!0,itemSize:this.itemSize,data:this.data.uuid,offset:this.offset,normalized:this.normalized};{tK("InterleavedBufferAttribute.toJSON(): Serializing an interleaved buffer attribute will de-interleave buffer data.");let e=[];for(let i=0;i<this.count;i++){let r=i*this.data.stride+this.offset;for(let i=0;i<this.itemSize;i++)e.push(this.data.array[r+i])}return{itemSize:this.itemSize,type:this.array.constructor.name,array:e,normalized:this.normalized}}}}let nC=new ia,nP=new ib,nI=new ib,nL=new ia,nD=new i1,nU=new ia,nN=new ij,nO=new i1,nF=new i0;class nB extends nn{constructor(e,i){super(e,i),this.isSkinnedMesh=!0,this.type="SkinnedMesh",this.bindMode=ep,this.bindMatrix=new i1,this.bindMatrixInverse=new i1,this.boundingBox=null,this.boundingSphere=null}computeBoundingBox(){let e=this.geometry;null===this.boundingBox&&(this.boundingBox=new iR),this.boundingBox.makeEmpty();let i=e.getAttribute("position");for(let e=0;e<i.count;e++)this.getVertexPosition(e,nU),this.boundingBox.expandByPoint(nU)}computeBoundingSphere(){let e=this.geometry;null===this.boundingSphere&&(this.boundingSphere=new ij),this.boundingSphere.makeEmpty();let i=e.getAttribute("position");for(let e=0;e<i.count;e++)this.getVertexPosition(e,nU),this.boundingSphere.expandByPoint(nU)}copy(e,i){return super.copy(e,i),this.bindMode=e.bindMode,this.bindMatrix.copy(e.bindMatrix),this.bindMatrixInverse.copy(e.bindMatrixInverse),this.skeleton=e.skeleton,null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this}raycast(e,i){let r=this.material,n=this.matrixWorld;void 0===r||(null===this.boundingSphere&&this.computeBoundingSphere(),nN.copy(this.boundingSphere),nN.applyMatrix4(n),!1===e.ray.intersectsSphere(nN)||(nO.copy(n).invert(),nF.copy(e.ray).applyMatrix4(nO),(null===this.boundingBox||!1!==nF.intersectsBox(this.boundingBox))&&this._computeIntersections(e,i,nF)))}getVertexPosition(e,i){return super.getVertexPosition(e,i),this.applyBoneTransform(e,i),i}bind(e,i){this.skeleton=e,void 0===i&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),i=this.matrixWorld),this.bindMatrix.copy(i),this.bindMatrixInverse.copy(i).invert()}pose(){this.skeleton.pose()}normalizeSkinWeights(){let e=new ib,i=this.geometry.attributes.skinWeight;for(let r=0,n=i.count;r<n;r++){e.fromBufferAttribute(i,r);let n=1/e.manhattanLength();n!==1/0?e.multiplyScalar(n):e.set(1,0,0,0),i.setXYZW(r,e.x,e.y,e.z,e.w)}}updateMatrixWorld(e){super.updateMatrixWorld(e),this.bindMode===ep?this.bindMatrixInverse.copy(this.matrixWorld).invert():"detached"===this.bindMode?this.bindMatrixInverse.copy(this.bindMatrix).invert():tJ("SkinnedMesh: Unrecognized bindMode: "+this.bindMode)}applyBoneTransform(e,i){let r=this.skeleton,n=this.geometry;nP.fromBufferAttribute(n.attributes.skinIndex,e),nI.fromBufferAttribute(n.attributes.skinWeight,e),nC.copy(i).applyMatrix4(this.bindMatrix),i.set(0,0,0);for(let e=0;e<4;e++){let n=nI.getComponent(e);if(0!==n){let a=nP.getComponent(e);nD.multiplyMatrices(r.bones[a].matrixWorld,r.boneInverses[a]),i.addScaledVector(nL.copy(nC).applyMatrix4(nD),n)}}return i.applyMatrix4(this.bindMatrixInverse)}}class nz extends r_{constructor(){super(),this.isBone=!0,this.type="Bone"}}class nk extends iS{constructor(e=null,i=1,r=1,n,a,s,o,l,c=eS,h=eS,u,d){super(null,s,o,l,c,h,n,a,u,d),this.isDataTexture=!0,this.image={data:e,width:i,height:r},this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}let nV=new i1,nH=new i1;class nG{constructor(e=[],i=[]){this.uuid=t5(),this.bones=e.slice(0),this.boneInverses=i,this.boneMatrices=null,this.previousBoneMatrices=null,this.boneTexture=null,this.init()}init(){let e=this.bones,i=this.boneInverses;if(this.boneMatrices=new Float32Array(16*e.length),0===i.length)this.calculateInverses();else if(e.length!==i.length){tJ("Skeleton: Number of inverse bone matrices does not match amount of bones."),this.boneInverses=[];for(let e=0,i=this.bones.length;e<i;e++)this.boneInverses.push(new i1)}}calculateInverses(){this.boneInverses.length=0;for(let e=0,i=this.bones.length;e<i;e++){let i=new i1;this.bones[e]&&i.copy(this.bones[e].matrixWorld).invert(),this.boneInverses.push(i)}}pose(){for(let e=0,i=this.bones.length;e<i;e++){let i=this.bones[e];i&&i.matrixWorld.copy(this.boneInverses[e]).invert()}for(let e=0,i=this.bones.length;e<i;e++){let i=this.bones[e];i&&(i.parent&&i.parent.isBone?(i.matrix.copy(i.parent.matrixWorld).invert(),i.matrix.multiply(i.matrixWorld)):i.matrix.copy(i.matrixWorld),i.matrix.decompose(i.position,i.quaternion,i.scale))}}update(){let e=this.bones,i=this.boneInverses,r=this.boneMatrices,n=this.boneTexture;for(let n=0,a=e.length;n<a;n++){let a=e[n]?e[n].matrixWorld:nH;nV.multiplyMatrices(a,i[n]),nV.toArray(r,16*n)}null!==n&&(n.needsUpdate=!0)}clone(){return new nG(this.bones,this.boneInverses)}computeBoneTexture(){let e=Math.sqrt(4*this.bones.length),i=new Float32Array((e=Math.max(e=4*Math.ceil(e/4),4))*e*4);i.set(this.boneMatrices);let r=new nk(i,e,e,eG,eU);return r.needsUpdate=!0,this.boneMatrices=i,this.boneTexture=r,this}getBoneByName(e){for(let i=0,r=this.bones.length;i<r;i++){let r=this.bones[i];if(r.name===e)return r}}dispose(){null!==this.boneTexture&&(this.boneTexture.dispose(),this.boneTexture=null)}fromJSON(e,i){this.uuid=e.uuid;for(let r=0,n=e.bones.length;r<n;r++){let n=e.bones[r],a=i[n];void 0===a&&(tJ("Skeleton: No bone found with UUID:",n),a=new nz),this.bones.push(a),this.boneInverses.push(new i1().fromArray(e.boneInverses[r]))}return this.init(),this}toJSON(){let e={metadata:{version:4.7,type:"Skeleton",generator:"Skeleton.toJSON"},bones:[],boneInverses:[]};e.uuid=this.uuid;let i=this.bones,r=this.boneInverses;for(let n=0,a=i.length;n<a;n++){let a=i[n];e.bones.push(a.uuid);let s=r[n];e.boneInverses.push(s.toArray())}return e}}class nW extends rX{constructor(e,i,r,n=1){super(e,i,r),this.isInstancedBufferAttribute=!0,this.meshPerAttribute=n}copy(e){return super.copy(e),this.meshPerAttribute=e.meshPerAttribute,this}toJSON(){let e=super.toJSON();return e.meshPerAttribute=this.meshPerAttribute,e.isInstancedBufferAttribute=!0,e}}let nX=new i1,nj=new i1,nq=[],nY=new iR,nK=new i1,nJ=new nn,nZ=new ij;class nQ extends nn{constructor(e,i,r){super(e,i),this.isInstancedMesh=!0,this.instanceMatrix=new nW(new Float32Array(16*r),16),this.instanceColor=null,this.morphTexture=null,this.count=r,this.boundingBox=null,this.boundingSphere=null;for(let e=0;e<r;e++)this.setMatrixAt(e,nK)}computeBoundingBox(){let e=this.geometry,i=this.count;null===this.boundingBox&&(this.boundingBox=new iR),null===e.boundingBox&&e.computeBoundingBox(),this.boundingBox.makeEmpty();for(let r=0;r<i;r++)this.getMatrixAt(r,nX),nY.copy(e.boundingBox).applyMatrix4(nX),this.boundingBox.union(nY)}computeBoundingSphere(){let e=this.geometry,i=this.count;null===this.boundingSphere&&(this.boundingSphere=new ij),null===e.boundingSphere&&e.computeBoundingSphere(),this.boundingSphere.makeEmpty();for(let r=0;r<i;r++)this.getMatrixAt(r,nX),nZ.copy(e.boundingSphere).applyMatrix4(nX),this.boundingSphere.union(nZ)}copy(e,i){return super.copy(e,i),this.instanceMatrix.copy(e.instanceMatrix),null!==e.morphTexture&&(this.morphTexture=e.morphTexture.clone()),null!==e.instanceColor&&(this.instanceColor=e.instanceColor.clone()),this.count=e.count,null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this}getColorAt(e,i){i.fromArray(this.instanceColor.array,3*e)}getMatrixAt(e,i){i.fromArray(this.instanceMatrix.array,16*e)}getMorphAt(e,i){let r=i.morphTargetInfluences,n=this.morphTexture.source.data.data,a=e*(r.length+1)+1;for(let e=0;e<r.length;e++)r[e]=n[a+e]}raycast(e,i){let r=this.matrixWorld,n=this.count;if((nJ.geometry=this.geometry,nJ.material=this.material,void 0!==nJ.material)&&(null===this.boundingSphere&&this.computeBoundingSphere(),nZ.copy(this.boundingSphere),nZ.applyMatrix4(r),!1!==e.ray.intersectsSphere(nZ)))for(let a=0;a<n;a++){this.getMatrixAt(a,nX),nj.multiplyMatrices(r,nX),nJ.matrixWorld=nj,nJ.raycast(e,nq);for(let e=0,r=nq.length;e<r;e++){let r=nq[e];r.instanceId=a,r.object=this,i.push(r)}nq.length=0}}setColorAt(e,i){null===this.instanceColor&&(this.instanceColor=new nW(new Float32Array(3*this.instanceMatrix.count).fill(1),3)),i.toArray(this.instanceColor.array,3*e)}setMatrixAt(e,i){i.toArray(this.instanceMatrix.array,16*e)}setMorphAt(e,i){let r=i.morphTargetInfluences,n=r.length+1;null===this.morphTexture&&(this.morphTexture=new nk(new Float32Array(n*this.count),n,this.count,ej,eU));let a=this.morphTexture.source.data.data,s=0;for(let e=0;e<r.length;e++)s+=r[e];let o=this.geometry.morphTargetsRelative?1:1-s,l=n*e;a[l]=o,a.set(r,l+1)}updateMorphTargets(){}dispose(){this.dispatchEvent({type:"dispose"}),null!==this.morphTexture&&(this.morphTexture.dispose(),this.morphTexture=null)}}let n$=new ia,n0=new ia,n1=new il;class n3{constructor(e=new ia(1,0,0),i=0){this.isPlane=!0,this.normal=e,this.constant=i}set(e,i){return this.normal.copy(e),this.constant=i,this}setComponents(e,i,r,n){return this.normal.set(e,i,r),this.constant=n,this}setFromNormalAndCoplanarPoint(e,i){return this.normal.copy(e),this.constant=-i.dot(this.normal),this}setFromCoplanarPoints(e,i,r){let n=n$.subVectors(r,i).cross(n0.subVectors(e,i)).normalize();return this.setFromNormalAndCoplanarPoint(n,e),this}copy(e){return this.normal.copy(e.normal),this.constant=e.constant,this}normalize(){let e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(e){return this.normal.dot(e)+this.constant}distanceToSphere(e){return this.distanceToPoint(e.center)-e.radius}projectPoint(e,i){return i.copy(e).addScaledVector(this.normal,-this.distanceToPoint(e))}intersectLine(e,i){let r=e.delta(n$),n=this.normal.dot(r);if(0===n)return 0===this.distanceToPoint(e.start)?i.copy(e.start):null;let a=-(e.start.dot(this.normal)+this.constant)/n;return a<0||a>1?null:i.copy(e.start).addScaledVector(r,a)}intersectsLine(e){let i=this.distanceToPoint(e.start),r=this.distanceToPoint(e.end);return i<0&&r>0||r<0&&i>0}intersectsBox(e){return e.intersectsPlane(this)}intersectsSphere(e){return e.intersectsPlane(this)}coplanarPoint(e){return e.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(e,i){let r=i||n1.getNormalMatrix(e),n=this.coplanarPoint(n$).applyMatrix4(e),a=this.normal.applyMatrix3(r).normalize();return this.constant=-n.dot(a),this}translate(e){return this.constant-=e.dot(this.normal),this}equals(e){return e.normal.equals(this.normal)&&e.constant===this.constant}clone(){return new this.constructor().copy(this)}}let n2=new ij,n4=new ii(.5,.5),n5=new ia;class n6{constructor(e=new n3,i=new n3,r=new n3,n=new n3,a=new n3,s=new n3){this.planes=[e,i,r,n,a,s]}set(e,i,r,n,a,s){let o=this.planes;return o[0].copy(e),o[1].copy(i),o[2].copy(r),o[3].copy(n),o[4].copy(a),o[5].copy(s),this}copy(e){let i=this.planes;for(let r=0;r<6;r++)i[r].copy(e.planes[r]);return this}setFromProjectionMatrix(e,i=tW,r=!1){let n=this.planes,a=e.elements,s=a[0],o=a[1],l=a[2],c=a[3],h=a[4],u=a[5],d=a[6],p=a[7],f=a[8],m=a[9],g=a[10],v=a[11],_=a[12],x=a[13],y=a[14],M=a[15];if(n[0].setComponents(c-s,p-h,v-f,M-_).normalize(),n[1].setComponents(c+s,p+h,v+f,M+_).normalize(),n[2].setComponents(c+o,p+u,v+m,M+x).normalize(),n[3].setComponents(c-o,p-u,v-m,M-x).normalize(),r)n[4].setComponents(l,d,g,y).normalize(),n[5].setComponents(c-l,p-d,v-g,M-y).normalize();else if(n[4].setComponents(c-l,p-d,v-g,M-y).normalize(),i===tW)n[5].setComponents(c+l,p+d,v+g,M+y).normalize();else if(2001===i)n[5].setComponents(l,d,g,y).normalize();else throw Error("THREE.Frustum.setFromProjectionMatrix(): Invalid coordinate system: "+i);return this}intersectsObject(e){if(void 0!==e.boundingSphere)null===e.boundingSphere&&e.computeBoundingSphere(),n2.copy(e.boundingSphere).applyMatrix4(e.matrixWorld);else{let i=e.geometry;null===i.boundingSphere&&i.computeBoundingSphere(),n2.copy(i.boundingSphere).applyMatrix4(e.matrixWorld)}return this.intersectsSphere(n2)}intersectsSprite(e){return n2.center.set(0,0,0),n2.radius=.7071067811865476+n4.distanceTo(e.center),n2.applyMatrix4(e.matrixWorld),this.intersectsSphere(n2)}intersectsSphere(e){let i=this.planes,r=e.center,n=-e.radius;for(let e=0;e<6;e++)if(i[e].distanceToPoint(r)<n)return!1;return!0}intersectsBox(e){let i=this.planes;for(let r=0;r<6;r++){let n=i[r];if(n5.x=n.normal.x>0?e.max.x:e.min.x,n5.y=n.normal.y>0?e.max.y:e.min.y,n5.z=n.normal.z>0?e.max.z:e.min.z,0>n.distanceToPoint(n5))return!1}return!0}containsPoint(e){let i=this.planes;for(let r=0;r<6;r++)if(0>i[r].distanceToPoint(e))return!1;return!0}clone(){return new this.constructor().copy(this)}}class n8 extends rk{constructor(e){super(),this.isLineBasicMaterial=!0,this.type="LineBasicMaterial",this.color=new rF(0xffffff),this.map=null,this.linewidth=1,this.linecap="round",this.linejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this.fog=e.fog,this}}let n9=new ia,n7=new ia,ae=new i1,at=new i0,ai=new ij,ar=new ia,an=new ia;class aa extends r_{constructor(e=new r3,i=new n8){super(),this.isLine=!0,this.type="Line",this.geometry=e,this.material=i,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.updateMorphTargets()}copy(e,i){return super.copy(e,i),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}computeLineDistances(){let e=this.geometry;if(null===e.index){let i=e.attributes.position,r=[0];for(let e=1,n=i.count;e<n;e++)n9.fromBufferAttribute(i,e-1),n7.fromBufferAttribute(i,e),r[e]=r[e-1],r[e]+=n9.distanceTo(n7);e.setAttribute("lineDistance",new rY(r,1))}else tJ("Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}raycast(e,i){let r=this.geometry,n=this.matrixWorld,a=e.params.Line.threshold,s=r.drawRange;if(null===r.boundingSphere&&r.computeBoundingSphere(),ai.copy(r.boundingSphere),ai.applyMatrix4(n),ai.radius+=a,!1===e.ray.intersectsSphere(ai))return;ae.copy(n).invert(),at.copy(e.ray).applyMatrix4(ae);let o=a/((this.scale.x+this.scale.y+this.scale.z)/3),l=o*o,c=this.isLineSegments?2:1,h=r.index,u=r.attributes.position;if(null!==h){let r=Math.max(0,s.start),n=Math.min(h.count,s.start+s.count);for(let a=r,s=n-1;a<s;a+=c){let r=as(this,e,at,l,h.getX(a),h.getX(a+1),a);r&&i.push(r)}if(this.isLineLoop){let a=as(this,e,at,l,h.getX(n-1),h.getX(r),n-1);a&&i.push(a)}}else{let r=Math.max(0,s.start),n=Math.min(u.count,s.start+s.count);for(let a=r,s=n-1;a<s;a+=c){let r=as(this,e,at,l,a,a+1,a);r&&i.push(r)}if(this.isLineLoop){let a=as(this,e,at,l,n-1,r,n-1);a&&i.push(a)}}}updateMorphTargets(){let e=this.geometry.morphAttributes,i=Object.keys(e);if(i.length>0){let r=e[i[0]];if(void 0!==r){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,i=r.length;e<i;e++){let i=r[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=e}}}}}function as(e,i,r,n,a,s,o){let l=e.geometry.attributes.position;if(n9.fromBufferAttribute(l,a),n7.fromBufferAttribute(l,s),r.distanceSqToSegment(n9,n7,ar,an)>n)return;ar.applyMatrix4(e.matrixWorld);let c=i.ray.origin.distanceTo(ar);if(!(c<i.near)&&!(c>i.far))return{distance:c,point:an.clone().applyMatrix4(e.matrixWorld),index:o,face:null,faceIndex:null,barycoord:null,object:e}}let ao=new ia,al=new ia;class ac extends aa{constructor(e,i){super(e,i),this.isLineSegments=!0,this.type="LineSegments"}computeLineDistances(){let e=this.geometry;if(null===e.index){let i=e.attributes.position,r=[];for(let e=0,n=i.count;e<n;e+=2)ao.fromBufferAttribute(i,e),al.fromBufferAttribute(i,e+1),r[e]=0===e?0:r[e-1],r[e+1]=r[e]+ao.distanceTo(al);e.setAttribute("lineDistance",new rY(r,1))}else tJ("LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}}class ah extends aa{constructor(e,i){super(e,i),this.isLineLoop=!0,this.type="LineLoop"}}class au extends rk{constructor(e){super(),this.isPointsMaterial=!0,this.type="PointsMaterial",this.color=new rF(0xffffff),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this.fog=e.fog,this}}let ad=new i1,ap=new i0,af=new ij,am=new ia;class ag extends r_{constructor(e=new r3,i=new au){super(),this.isPoints=!0,this.type="Points",this.geometry=e,this.material=i,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.updateMorphTargets()}copy(e,i){return super.copy(e,i),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}raycast(e,i){let r=this.geometry,n=this.matrixWorld,a=e.params.Points.threshold,s=r.drawRange;if(null===r.boundingSphere&&r.computeBoundingSphere(),af.copy(r.boundingSphere),af.applyMatrix4(n),af.radius+=a,!1===e.ray.intersectsSphere(af))return;ad.copy(n).invert(),ap.copy(e.ray).applyMatrix4(ad);let o=a/((this.scale.x+this.scale.y+this.scale.z)/3),l=o*o,c=r.index,h=r.attributes.position;if(null!==c){let r=Math.max(0,s.start),a=Math.min(c.count,s.start+s.count);for(let s=r;s<a;s++){let r=c.getX(s);am.fromBufferAttribute(h,r),av(am,r,l,n,e,i,this)}}else{let r=Math.max(0,s.start),a=Math.min(h.count,s.start+s.count);for(let s=r;s<a;s++)am.fromBufferAttribute(h,s),av(am,s,l,n,e,i,this)}}updateMorphTargets(){let e=this.geometry.morphAttributes,i=Object.keys(e);if(i.length>0){let r=e[i[0]];if(void 0!==r){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,i=r.length;e<i;e++){let i=r[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=e}}}}}function av(e,i,r,n,a,s,o){let l=ap.distanceSqToPoint(e);if(l<r){let r=new ia;ap.closestPointToPoint(e,r),r.applyMatrix4(n);let c=a.ray.origin.distanceTo(r);if(c<a.near||c>a.far)return;s.push({distance:c,distanceToRay:Math.sqrt(l),point:r,index:i,face:null,faceIndex:null,barycoord:null,object:o})}}class a_ extends iS{constructor(e,i,r,n,a,s,o,l,c,h,u,d){super(null,s,o,l,c,h,n,a,u,d),this.isCompressedTexture=!0,this.image={width:i,height:r},this.mipmaps=e,this.flipY=!1,this.generateMipmaps=!1}}class ax extends iS{constructor(e,i,r,n,a,s,o,l,c){super(e,i,r,n,a,s,o,l,c),this.isCanvasTexture=!0,this.needsUpdate=!0}}class ay extends iS{constructor(e,i,r=eD,n,a,s,o=eS,l=eS,c,h=eW,u=1){if(h!==eW&&h!==eX)throw Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");super({width:e,height:i,depth:u},n,a,s,o,l,h,r,c),this.isDepthTexture=!0,this.flipY=!1,this.generateMipmaps=!1,this.compareFunction=null}copy(e){return super.copy(e),this.source=new i_(Object.assign({},e.image)),this.compareFunction=e.compareFunction,this}toJSON(e){let i=super.toJSON(e);return null!==this.compareFunction&&(i.compareFunction=this.compareFunction),i}}class aM extends ay{constructor(e,i=eD,r=ef,n,a,s=eS,o=eS,l,c=eW){const h={width:e,height:e,depth:1};super(e,e,i,r,n,a,s,o,l,c),this.image=[h,h,h,h,h,h],this.isCubeDepthTexture=!0,this.isCubeTexture=!0}get images(){return this.image}set images(e){this.image=e}}class aS extends iS{constructor(e=null){super(),this.sourceTexture=e,this.isExternalTexture=!0}copy(e){return super.copy(e),this.sourceTexture=e.sourceTexture,this}}class ab extends r3{constructor(e=1,i=32,r=0,n=2*Math.PI){super(),this.type="CircleGeometry",this.parameters={radius:e,segments:i,thetaStart:r,thetaLength:n},i=Math.max(3,i);const a=[],s=[],o=[],l=[],c=new ia,h=new ii;s.push(0,0,0),o.push(0,0,1),l.push(.5,.5);for(let a=0,u=3;a<=i;a++,u+=3){const d=r+a/i*n;c.x=e*Math.cos(d),c.y=e*Math.sin(d),s.push(c.x,c.y,c.z),o.push(0,0,1),h.x=(s[u]/e+1)/2,h.y=(s[u+1]/e+1)/2,l.push(h.x,h.y)}for(let e=1;e<=i;e++)a.push(e,e+1,0);this.setIndex(a),this.setAttribute("position",new rY(s,3)),this.setAttribute("normal",new rY(o,3)),this.setAttribute("uv",new rY(l,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new ab(e.radius,e.segments,e.thetaStart,e.thetaLength)}}class aT extends r3{constructor(e=1,i=1,r=1,n=32,a=1,s=!1,o=0,l=2*Math.PI){super(),this.type="CylinderGeometry",this.parameters={radiusTop:e,radiusBottom:i,height:r,radialSegments:n,heightSegments:a,openEnded:s,thetaStart:o,thetaLength:l};const c=this;n=Math.floor(n),a=Math.floor(a);const h=[],u=[],d=[],p=[];let f=0;const m=[],g=r/2;let v=0;function _(r){let a=f,s=new ii,m=new ia,_=0,x=!0===r?e:i,y=!0===r?1:-1;for(let e=1;e<=n;e++)u.push(0,g*y,0),d.push(0,y,0),p.push(.5,.5),f++;let M=f;for(let e=0;e<=n;e++){let i=e/n*l+o,r=Math.cos(i),a=Math.sin(i);m.x=x*a,m.y=g*y,m.z=x*r,u.push(m.x,m.y,m.z),d.push(0,y,0),s.x=.5*r+.5,s.y=.5*a*y+.5,p.push(s.x,s.y),f++}for(let e=0;e<n;e++){let i=a+e,n=M+e;!0===r?h.push(n,n+1,i):h.push(n+1,n,i),_+=3}c.addGroup(v,_,!0===r?1:2),v+=_}(function(){let s=new ia,_=new ia,x=0,y=(i-e)/r;for(let c=0;c<=a;c++){let h=[],v=c/a,x=v*(i-e)+e;for(let e=0;e<=n;e++){let i=e/n,a=i*l+o,c=Math.sin(a),m=Math.cos(a);_.x=x*c,_.y=-v*r+g,_.z=x*m,u.push(_.x,_.y,_.z),s.set(c,y,m).normalize(),d.push(s.x,s.y,s.z),p.push(i,1-v),h.push(f++)}m.push(h)}for(let r=0;r<n;r++)for(let n=0;n<a;n++){let s=m[n][r],o=m[n+1][r],l=m[n+1][r+1],c=m[n][r+1];(e>0||0!==n)&&(h.push(s,o,c),x+=3),(i>0||n!==a-1)&&(h.push(o,l,c),x+=3)}c.addGroup(v,x,0),v+=x})(),!1===s&&(e>0&&_(!0),i>0&&_(!1)),this.setIndex(h),this.setAttribute("position",new rY(u,3)),this.setAttribute("normal",new rY(d,3)),this.setAttribute("uv",new rY(p,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new aT(e.radiusTop,e.radiusBottom,e.height,e.radialSegments,e.heightSegments,e.openEnded,e.thetaStart,e.thetaLength)}}class aE extends aT{constructor(e=1,i=1,r=32,n=1,a=!1,s=0,o=2*Math.PI){super(0,e,i,r,n,a,s,o),this.type="ConeGeometry",this.parameters={radius:e,height:i,radialSegments:r,heightSegments:n,openEnded:a,thetaStart:s,thetaLength:o}}static fromJSON(e){return new aE(e.radius,e.height,e.radialSegments,e.heightSegments,e.openEnded,e.thetaStart,e.thetaLength)}}class aw extends r3{constructor(e=[],i=[],r=1,n=0){super(),this.type="PolyhedronGeometry",this.parameters={vertices:e,indices:i,radius:r,detail:n};const a=[],s=[];function o(e){a.push(e.x,e.y,e.z)}function l(i,r){let n=3*i;r.x=e[n+0],r.y=e[n+1],r.z=e[n+2]}function c(e,i,r,n){n<0&&1===e.x&&(s[i]=e.x-1),0===r.x&&0===r.z&&(s[i]=n/2/Math.PI+.5)}function h(e){return Math.atan2(e.z,-e.x)}(function(e){let r=new ia,n=new ia,a=new ia;for(let s=0;s<i.length;s+=3)l(i[s+0],r),l(i[s+1],n),l(i[s+2],a),function(e,i,r,n){let a=n+1,s=[];for(let n=0;n<=a;n++){s[n]=[];let o=e.clone().lerp(r,n/a),l=i.clone().lerp(r,n/a),c=a-n;for(let e=0;e<=c;e++)0===e&&n===a?s[n][e]=o:s[n][e]=o.clone().lerp(l,e/c)}for(let e=0;e<a;e++)for(let i=0;i<2*(a-e)-1;i++){let r=Math.floor(i/2);i%2==0?(o(s[e][r+1]),o(s[e+1][r]),o(s[e][r])):(o(s[e][r+1]),o(s[e+1][r+1]),o(s[e+1][r]))}}(r,n,a,e)})(n),function(e){let i=new ia;for(let r=0;r<a.length;r+=3)i.x=a[r+0],i.y=a[r+1],i.z=a[r+2],i.normalize().multiplyScalar(e),a[r+0]=i.x,a[r+1]=i.y,a[r+2]=i.z}(r),function(){let e=new ia;for(let r=0;r<a.length;r+=3){var i;e.x=a[r+0],e.y=a[r+1],e.z=a[r+2];let n=h(e)/2/Math.PI+.5,o=Math.atan2(-(i=e).y,Math.sqrt(i.x*i.x+i.z*i.z))/Math.PI+.5;s.push(n,1-o)}(function(){let e=new ia,i=new ia,r=new ia,n=new ia,o=new ii,l=new ii,u=new ii;for(let d=0,p=0;d<a.length;d+=9,p+=6){e.set(a[d+0],a[d+1],a[d+2]),i.set(a[d+3],a[d+4],a[d+5]),r.set(a[d+6],a[d+7],a[d+8]),o.set(s[p+0],s[p+1]),l.set(s[p+2],s[p+3]),u.set(s[p+4],s[p+5]),n.copy(e).add(i).add(r).divideScalar(3);let f=h(n);c(o,p+0,e,f),c(l,p+2,i,f),c(u,p+4,r,f)}})(),function(){for(let e=0;e<s.length;e+=6){let i=s[e+0],r=s[e+2],n=s[e+4],a=Math.max(i,r,n),o=Math.min(i,r,n);a>.9&&o<.1&&(i<.2&&(s[e+0]+=1),r<.2&&(s[e+2]+=1),n<.2&&(s[e+4]+=1))}}()}(),this.setAttribute("position",new rY(a,3)),this.setAttribute("normal",new rY(a.slice(),3)),this.setAttribute("uv",new rY(s,2)),0===n?this.computeVertexNormals():this.normalizeNormals()}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new aw(e.vertices,e.indices,e.radius,e.detail)}}class aA{constructor(){this.type="Curve",this.arcLengthDivisions=200,this.needsUpdate=!1,this.cacheArcLengths=null}getPoint(){tJ("Curve: .getPoint() not implemented.")}getPointAt(e,i){let r=this.getUtoTmapping(e);return this.getPoint(r,i)}getPoints(e=5){let i=[];for(let r=0;r<=e;r++)i.push(this.getPoint(r/e));return i}getSpacedPoints(e=5){let i=[];for(let r=0;r<=e;r++)i.push(this.getPointAt(r/e));return i}getLength(){let e=this.getLengths();return e[e.length-1]}getLengths(e=this.arcLengthDivisions){if(this.cacheArcLengths&&this.cacheArcLengths.length===e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;let i=[],r,n=this.getPoint(0),a=0;i.push(0);for(let s=1;s<=e;s++)i.push(a+=(r=this.getPoint(s/e)).distanceTo(n)),n=r;return this.cacheArcLengths=i,i}updateArcLengths(){this.needsUpdate=!0,this.getLengths()}getUtoTmapping(e,i=null){let r,n=this.getLengths(),a=0,s=n.length;r=i||e*n[s-1];let o=0,l=s-1,c;for(;o<=l;)if((c=n[a=Math.floor(o+(l-o)/2)]-r)<0)o=a+1;else if(c>0)l=a-1;else{l=a;break}if(n[a=l]===r)return a/(s-1);let h=n[a],u=n[a+1];return(a+(r-h)/(u-h))/(s-1)}getTangent(e,i){let r=e-1e-4,n=e+1e-4;r<0&&(r=0),n>1&&(n=1);let a=this.getPoint(r),s=this.getPoint(n),o=i||(a.isVector2?new ii:new ia);return o.copy(s).sub(a).normalize(),o}getTangentAt(e,i){let r=this.getUtoTmapping(e);return this.getTangent(r,i)}computeFrenetFrames(e,i=!1){let r=new ia,n=[],a=[],s=[],o=new ia,l=new i1;for(let i=0;i<=e;i++){let r=i/e;n[i]=this.getTangentAt(r,new ia)}a[0]=new ia,s[0]=new ia;let c=Number.MAX_VALUE,h=Math.abs(n[0].x),u=Math.abs(n[0].y),d=Math.abs(n[0].z);h<=c&&(c=h,r.set(1,0,0)),u<=c&&(c=u,r.set(0,1,0)),d<=c&&r.set(0,0,1),o.crossVectors(n[0],r).normalize(),a[0].crossVectors(n[0],o),s[0].crossVectors(n[0],a[0]);for(let i=1;i<=e;i++){if(a[i]=a[i-1].clone(),s[i]=s[i-1].clone(),o.crossVectors(n[i-1],n[i]),o.length()>Number.EPSILON){o.normalize();let e=Math.acos(t6(n[i-1].dot(n[i]),-1,1));a[i].applyMatrix4(l.makeRotationAxis(o,e))}s[i].crossVectors(n[i],a[i])}if(!0===i){let i=Math.acos(t6(a[0].dot(a[e]),-1,1));i/=e,n[0].dot(o.crossVectors(a[0],a[e]))>0&&(i=-i);for(let r=1;r<=e;r++)a[r].applyMatrix4(l.makeRotationAxis(n[r],i*r)),s[r].crossVectors(n[r],a[r])}return{tangents:n,normals:a,binormals:s}}clone(){return new this.constructor().copy(this)}copy(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}toJSON(){let e={metadata:{version:4.7,type:"Curve",generator:"Curve.toJSON"}};return e.arcLengthDivisions=this.arcLengthDivisions,e.type=this.type,e}fromJSON(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}}class aR extends aA{constructor(e=0,i=0,r=1,n=1,a=0,s=2*Math.PI,o=!1,l=0){super(),this.isEllipseCurve=!0,this.type="EllipseCurve",this.aX=e,this.aY=i,this.xRadius=r,this.yRadius=n,this.aStartAngle=a,this.aEndAngle=s,this.aClockwise=o,this.aRotation=l}getPoint(e,i=new ii){let r=2*Math.PI,n=this.aEndAngle-this.aStartAngle,a=Math.abs(n)<Number.EPSILON;for(;n<0;)n+=r;for(;n>r;)n-=r;n<Number.EPSILON&&(n=a?0:r),!0!==this.aClockwise||a||(n===r?n=-r:n-=r);let s=this.aStartAngle+e*n,o=this.aX+this.xRadius*Math.cos(s),l=this.aY+this.yRadius*Math.sin(s);if(0!==this.aRotation){let e=Math.cos(this.aRotation),i=Math.sin(this.aRotation),r=o-this.aX,n=l-this.aY;o=r*e-n*i+this.aX,l=r*i+n*e+this.aY}return i.set(o,l)}copy(e){return super.copy(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}toJSON(){let e=super.toJSON();return e.aX=this.aX,e.aY=this.aY,e.xRadius=this.xRadius,e.yRadius=this.yRadius,e.aStartAngle=this.aStartAngle,e.aEndAngle=this.aEndAngle,e.aClockwise=this.aClockwise,e.aRotation=this.aRotation,e}fromJSON(e){return super.fromJSON(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}}function aC(){let e=0,i=0,r=0,n=0;function a(a,s,o,l){e=a,i=o,r=-3*a+3*s-2*o-l,n=2*a-2*s+o+l}return{initCatmullRom:function(e,i,r,n,s){a(i,r,s*(r-e),s*(n-i))},initNonuniformCatmullRom:function(e,i,r,n,s,o,l){let c=(i-e)/s-(r-e)/(s+o)+(r-i)/o,h=(r-i)/o-(n-i)/(o+l)+(n-r)/l;a(i,r,c*=o,h*=o)},calc:function(a){let s=a*a;return e+i*a+r*s+s*a*n}}}let aP=new ia,aI=new aC,aL=new aC,aD=new aC;function aU(e,i,r,n,a){let s=(n-i)*.5,o=(a-r)*.5,l=e*e;return e*l*(2*r-2*n+s+o)+(-3*r+3*n-2*s-o)*l+s*e+r}function aN(e,i,r,n){let a;return(a=1-e)*a*i+2*(1-e)*e*r+e*e*n}function aO(e,i,r,n,a){let s,o;return(s=1-e)*s*s*i+3*(o=1-e)*o*e*r+3*(1-e)*e*e*n+e*e*e*a}class aF extends aA{constructor(e=new ii,i=new ii,r=new ii,n=new ii){super(),this.isCubicBezierCurve=!0,this.type="CubicBezierCurve",this.v0=e,this.v1=i,this.v2=r,this.v3=n}getPoint(e,i=new ii){let r=this.v0,n=this.v1,a=this.v2,s=this.v3;return i.set(aO(e,r.x,n.x,a.x,s.x),aO(e,r.y,n.y,a.y,s.y)),i}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this}toJSON(){let e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e.v3=this.v3.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this}}class aB extends aA{constructor(e=new ii,i=new ii){super(),this.isLineCurve=!0,this.type="LineCurve",this.v1=e,this.v2=i}getPoint(e,i=new ii){return 1===e?i.copy(this.v2):(i.copy(this.v2).sub(this.v1),i.multiplyScalar(e).add(this.v1)),i}getPointAt(e,i){return this.getPoint(e,i)}getTangent(e,i=new ii){return i.subVectors(this.v2,this.v1).normalize()}getTangentAt(e,i){return this.getTangent(e,i)}copy(e){return super.copy(e),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){let e=super.toJSON();return e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class az extends aA{constructor(e=new ii,i=new ii,r=new ii){super(),this.isQuadraticBezierCurve=!0,this.type="QuadraticBezierCurve",this.v0=e,this.v1=i,this.v2=r}getPoint(e,i=new ii){let r=this.v0,n=this.v1,a=this.v2;return i.set(aN(e,r.x,n.x,a.x),aN(e,r.y,n.y,a.y)),i}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){let e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class ak extends aA{constructor(e=new ia,i=new ia,r=new ia){super(),this.isQuadraticBezierCurve3=!0,this.type="QuadraticBezierCurve3",this.v0=e,this.v1=i,this.v2=r}getPoint(e,i=new ia){let r=this.v0,n=this.v1,a=this.v2;return i.set(aN(e,r.x,n.x,a.x),aN(e,r.y,n.y,a.y),aN(e,r.z,n.z,a.z)),i}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){let e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class aV extends aA{constructor(e=[]){super(),this.isSplineCurve=!0,this.type="SplineCurve",this.points=e}getPoint(e,i=new ii){let r=this.points,n=(r.length-1)*e,a=Math.floor(n),s=n-a,o=r[0===a?a:a-1],l=r[a],c=r[a>r.length-2?r.length-1:a+1],h=r[a>r.length-3?r.length-1:a+2];return i.set(aU(s,o.x,l.x,c.x,h.x),aU(s,o.y,l.y,c.y,h.y)),i}copy(e){super.copy(e),this.points=[];for(let i=0,r=e.points.length;i<r;i++){let r=e.points[i];this.points.push(r.clone())}return this}toJSON(){let e=super.toJSON();e.points=[];for(let i=0,r=this.points.length;i<r;i++){let r=this.points[i];e.points.push(r.toArray())}return e}fromJSON(e){super.fromJSON(e),this.points=[];for(let i=0,r=e.points.length;i<r;i++){let r=e.points[i];this.points.push(new ii().fromArray(r))}return this}}class aH extends aw{constructor(e=1,i=0){const r=(1+Math.sqrt(5))/2;super([-1,r,0,1,r,0,-1,-r,0,1,-r,0,0,-1,r,0,1,r,0,-1,-r,0,1,-r,r,0,-1,r,0,1,-r,0,-1,-r,0,1],[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],e,i),this.type="IcosahedronGeometry",this.parameters={radius:e,detail:i}}static fromJSON(e){return new aH(e.radius,e.detail)}}class aG extends r3{constructor(e=1,i=1,r=1,n=1){super(),this.type="PlaneGeometry",this.parameters={width:e,height:i,widthSegments:r,heightSegments:n};const a=e/2,s=i/2,o=Math.floor(r),l=Math.floor(n),c=o+1,h=l+1,u=e/o,d=i/l,p=[],f=[],m=[],g=[];for(let e=0;e<h;e++){const i=e*d-s;for(let r=0;r<c;r++){const n=r*u-a;f.push(n,-i,0),m.push(0,0,1),g.push(r/o),g.push(1-e/l)}}for(let e=0;e<l;e++)for(let i=0;i<o;i++){const r=i+c*e,n=i+c*(e+1),a=i+1+c*(e+1),s=i+1+c*e;p.push(r,n,s),p.push(n,a,s)}this.setIndex(p),this.setAttribute("position",new rY(f,3)),this.setAttribute("normal",new rY(m,3)),this.setAttribute("uv",new rY(g,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new aG(e.width,e.height,e.widthSegments,e.heightSegments)}}class aW extends np{constructor(e){super(e),this.isRawShaderMaterial=!0,this.type="RawShaderMaterial"}}class aX extends rk{constructor(e){super(),this.isMeshStandardMaterial=!0,this.type="MeshStandardMaterial",this.defines={STANDARD:""},this.color=new rF(0xffffff),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new rF(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=tR,this.normalScale=new ii(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new rt,this.envMapIntensity=1,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.defines={STANDARD:""},this.color.copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.envMapIntensity=e.envMapIntensity,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class aj extends aX{constructor(e){super(),this.isMeshPhysicalMaterial=!0,this.defines={STANDARD:"",PHYSICAL:""},this.type="MeshPhysicalMaterial",this.anisotropyRotation=0,this.anisotropyMap=null,this.clearcoatMap=null,this.clearcoatRoughness=0,this.clearcoatRoughnessMap=null,this.clearcoatNormalScale=new ii(1,1),this.clearcoatNormalMap=null,this.ior=1.5,Object.defineProperty(this,"reflectivity",{get:function(){return t6(2.5*(this.ior-1)/(this.ior+1),0,1)},set:function(e){this.ior=(1+.4*e)/(1-.4*e)}}),this.iridescenceMap=null,this.iridescenceIOR=1.3,this.iridescenceThicknessRange=[100,400],this.iridescenceThicknessMap=null,this.sheenColor=new rF(0),this.sheenColorMap=null,this.sheenRoughness=1,this.sheenRoughnessMap=null,this.transmissionMap=null,this.thickness=0,this.thicknessMap=null,this.attenuationDistance=1/0,this.attenuationColor=new rF(1,1,1),this.specularIntensity=1,this.specularIntensityMap=null,this.specularColor=new rF(1,1,1),this.specularColorMap=null,this._anisotropy=0,this._clearcoat=0,this._dispersion=0,this._iridescence=0,this._sheen=0,this._transmission=0,this.setValues(e)}get anisotropy(){return this._anisotropy}set anisotropy(e){this._anisotropy>0!=e>0&&this.version++,this._anisotropy=e}get clearcoat(){return this._clearcoat}set clearcoat(e){this._clearcoat>0!=e>0&&this.version++,this._clearcoat=e}get iridescence(){return this._iridescence}set iridescence(e){this._iridescence>0!=e>0&&this.version++,this._iridescence=e}get dispersion(){return this._dispersion}set dispersion(e){this._dispersion>0!=e>0&&this.version++,this._dispersion=e}get sheen(){return this._sheen}set sheen(e){this._sheen>0!=e>0&&this.version++,this._sheen=e}get transmission(){return this._transmission}set transmission(e){this._transmission>0!=e>0&&this.version++,this._transmission=e}copy(e){return super.copy(e),this.defines={STANDARD:"",PHYSICAL:""},this.anisotropy=e.anisotropy,this.anisotropyRotation=e.anisotropyRotation,this.anisotropyMap=e.anisotropyMap,this.clearcoat=e.clearcoat,this.clearcoatMap=e.clearcoatMap,this.clearcoatRoughness=e.clearcoatRoughness,this.clearcoatRoughnessMap=e.clearcoatRoughnessMap,this.clearcoatNormalMap=e.clearcoatNormalMap,this.clearcoatNormalScale.copy(e.clearcoatNormalScale),this.dispersion=e.dispersion,this.ior=e.ior,this.iridescence=e.iridescence,this.iridescenceMap=e.iridescenceMap,this.iridescenceIOR=e.iridescenceIOR,this.iridescenceThicknessRange=[...e.iridescenceThicknessRange],this.iridescenceThicknessMap=e.iridescenceThicknessMap,this.sheen=e.sheen,this.sheenColor.copy(e.sheenColor),this.sheenColorMap=e.sheenColorMap,this.sheenRoughness=e.sheenRoughness,this.sheenRoughnessMap=e.sheenRoughnessMap,this.transmission=e.transmission,this.transmissionMap=e.transmissionMap,this.thickness=e.thickness,this.thicknessMap=e.thicknessMap,this.attenuationDistance=e.attenuationDistance,this.attenuationColor.copy(e.attenuationColor),this.specularIntensity=e.specularIntensity,this.specularIntensityMap=e.specularIntensityMap,this.specularColor.copy(e.specularColor),this.specularColorMap=e.specularColorMap,this}}class aq extends rk{constructor(e){super(),this.isMeshPhongMaterial=!0,this.type="MeshPhongMaterial",this.color=new rF(0xffffff),this.specular=new rF(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new rF(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=tR,this.normalScale=new ii(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new rt,this.combine=ei,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.specular.copy(e.specular),this.shininess=e.shininess,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class aY extends rk{constructor(e){super(),this.isMeshDepthMaterial=!0,this.type="MeshDepthMaterial",this.depthPacking=3200,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(e)}copy(e){return super.copy(e),this.depthPacking=e.depthPacking,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this}}class aK extends rk{constructor(e){super(),this.isMeshDistanceMaterial=!0,this.type="MeshDistanceMaterial",this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.setValues(e)}copy(e){return super.copy(e),this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this}}function aJ(e,i){return e&&e.constructor!==i?"number"==typeof i.BYTES_PER_ELEMENT?new i(e):Array.prototype.slice.call(e):e}function aZ(e,i,r){let n=e.length,a=new e.constructor(n);for(let s=0,o=0;o!==n;++s){let n=r[s]*i;for(let r=0;r!==i;++r)a[o++]=e[n+r]}return a}function aQ(e,i,r,n){let a=1,s=e[0];for(;void 0!==s&&void 0===s[n];)s=e[a++];if(void 0===s)return;let o=s[n];if(void 0!==o)if(Array.isArray(o))do void 0!==(o=s[n])&&(i.push(s.time),r.push(...o)),s=e[a++];while(void 0!==s)else if(void 0!==o.toArray)do void 0!==(o=s[n])&&(i.push(s.time),o.toArray(r,r.length)),s=e[a++];while(void 0!==s)else do void 0!==(o=s[n])&&(i.push(s.time),r.push(o)),s=e[a++];while(void 0!==s)}class a${constructor(e,i,r,n){this.parameterPositions=e,this._cachedIndex=0,this.resultBuffer=void 0!==n?n:new i.constructor(r),this.sampleValues=i,this.valueSize=r,this.settings=null,this.DefaultSettings_={}}evaluate(e){let i=this.parameterPositions,r=this._cachedIndex,n=i[r],a=i[r-1];e:{t:{let s;i:{r:if(!(e<n)){for(let s=r+2;;){if(void 0===n){if(e<a)break r;return r=i.length,this._cachedIndex=r,this.copySampleValue_(r-1)}if(r===s)break;if(a=n,e<(n=i[++r]))break t}s=i.length;break i}if(!(e>=a)){let o=i[1];e<o&&(r=2,a=o);for(let s=r-2;;){if(void 0===a)return this._cachedIndex=0,this.copySampleValue_(0);if(r===s)break;if(n=a,e>=(a=i[--r-1]))break t}s=r,r=0;break i}break e}for(;r<s;){let n=r+s>>>1;e<i[n]?s=n:r=n+1}if(n=i[r],void 0===(a=i[r-1]))return this._cachedIndex=0,this.copySampleValue_(0);if(void 0===n)return r=i.length,this._cachedIndex=r,this.copySampleValue_(r-1)}this._cachedIndex=r,this.intervalChanged_(r,a,n)}return this.interpolate_(r,a,e,n)}getSettings_(){return this.settings||this.DefaultSettings_}copySampleValue_(e){let i=this.resultBuffer,r=this.sampleValues,n=this.valueSize,a=e*n;for(let e=0;e!==n;++e)i[e]=r[a+e];return i}interpolate_(){throw Error("call to abstract method")}intervalChanged_(){}}class a0 extends a${constructor(e,i,r,n){super(e,i,r,n),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0,this.DefaultSettings_={endingStart:2400,endingEnd:2400}}intervalChanged_(e,i,r){let n=this.parameterPositions,a=e-2,s=e+1,o=n[a],l=n[s];if(void 0===o)switch(this.getSettings_().endingStart){case 2401:a=e,o=2*i-r;break;case 2402:a=n.length-2,o=i+n[a]-n[a+1];break;default:a=e,o=r}if(void 0===l)switch(this.getSettings_().endingEnd){case 2401:s=e,l=2*r-i;break;case 2402:s=1,l=r+n[1]-n[0];break;default:s=e-1,l=i}let c=(r-i)*.5,h=this.valueSize;this._weightPrev=c/(i-o),this._weightNext=c/(l-r),this._offsetPrev=a*h,this._offsetNext=s*h}interpolate_(e,i,r,n){let a=this.resultBuffer,s=this.sampleValues,o=this.valueSize,l=e*o,c=l-o,h=this._offsetPrev,u=this._offsetNext,d=this._weightPrev,p=this._weightNext,f=(r-i)/(n-i),m=f*f,g=m*f,v=-d*g+2*d*m-d*f,_=(1+d)*g+(-1.5-2*d)*m+(-.5+d)*f+1,x=(-1-p)*g+(1.5+p)*m+.5*f,y=p*g-p*m;for(let e=0;e!==o;++e)a[e]=v*s[h+e]+_*s[c+e]+x*s[l+e]+y*s[u+e];return a}}class a1 extends a${constructor(e,i,r,n){super(e,i,r,n)}interpolate_(e,i,r,n){let a=this.resultBuffer,s=this.sampleValues,o=this.valueSize,l=e*o,c=l-o,h=(r-i)/(n-i),u=1-h;for(let e=0;e!==o;++e)a[e]=s[c+e]*u+s[l+e]*h;return a}}class a3 extends a${constructor(e,i,r,n){super(e,i,r,n)}interpolate_(e){return this.copySampleValue_(e-1)}}class a2{constructor(e,i,r,n){if(void 0===e)throw Error("THREE.KeyframeTrack: track name is undefined");if(void 0===i||0===i.length)throw Error("THREE.KeyframeTrack: no keyframes in track named "+e);this.name=e,this.times=aJ(i,this.TimeBufferType),this.values=aJ(r,this.ValueBufferType),this.setInterpolation(n||this.DefaultInterpolation)}static toJSON(e){let i,r=e.constructor;if(r.toJSON!==this.toJSON)i=r.toJSON(e);else{i={name:e.name,times:aJ(e.times,Array),values:aJ(e.values,Array)};let r=e.getInterpolation();r!==e.DefaultInterpolation&&(i.interpolation=r)}return i.type=e.ValueTypeName,i}InterpolantFactoryMethodDiscrete(e){return new a3(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodLinear(e){return new a1(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodSmooth(e){return new a0(this.times,this.values,this.getValueSize(),e)}setInterpolation(e){let i;switch(e){case tb:i=this.InterpolantFactoryMethodDiscrete;break;case tT:i=this.InterpolantFactoryMethodLinear;break;case 2302:i=this.InterpolantFactoryMethodSmooth}if(void 0===i){let i="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant)if(e!==this.DefaultInterpolation)this.setInterpolation(this.DefaultInterpolation);else throw Error(i);return tJ("KeyframeTrack:",i),this}return this.createInterpolant=i,this}getInterpolation(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return tb;case this.InterpolantFactoryMethodLinear:return tT;case this.InterpolantFactoryMethodSmooth:return 2302}}getValueSize(){return this.values.length/this.times.length}shift(e){if(0!==e){let i=this.times;for(let r=0,n=i.length;r!==n;++r)i[r]+=e}return this}scale(e){if(1!==e){let i=this.times;for(let r=0,n=i.length;r!==n;++r)i[r]*=e}return this}trim(e,i){let r=this.times,n=r.length,a=0,s=n-1;for(;a!==n&&r[a]<e;)++a;for(;-1!==s&&r[s]>i;)--s;if(++s,0!==a||s!==n){a>=s&&(a=(s=Math.max(s,1))-1);let e=this.getValueSize();this.times=r.slice(a,s),this.values=this.values.slice(a*e,s*e)}return this}validate(){var e;let i=!0,r=this.getValueSize();r-Math.floor(r)!=0&&(tZ("KeyframeTrack: Invalid value size in track.",this),i=!1);let n=this.times,a=this.values,s=n.length;0===s&&(tZ("KeyframeTrack: Track is empty.",this),i=!1);let o=null;for(let e=0;e!==s;e++){let r=n[e];if("number"==typeof r&&isNaN(r)){tZ("KeyframeTrack: Time is not a valid number.",this,e,r),i=!1;break}if(null!==o&&o>r){tZ("KeyframeTrack: Out of order keys.",this,e,r,o),i=!1;break}o=r}if(void 0!==a&&ArrayBuffer.isView(e=a)&&!(e instanceof DataView))for(let e=0,r=a.length;e!==r;++e){let r=a[e];if(isNaN(r)){tZ("KeyframeTrack: Value is not a valid number.",this,e,r),i=!1;break}}return i}optimize(){let e=this.times.slice(),i=this.values.slice(),r=this.getValueSize(),n=2302===this.getInterpolation(),a=e.length-1,s=1;for(let o=1;o<a;++o){let a=!1,l=e[o];if(l!==e[o+1]&&(1!==o||l!==e[0]))if(n)a=!0;else{let e=o*r,n=e-r,s=e+r;for(let o=0;o!==r;++o){let r=i[e+o];if(r!==i[n+o]||r!==i[s+o]){a=!0;break}}}if(a){if(o!==s){e[s]=e[o];let n=o*r,a=s*r;for(let e=0;e!==r;++e)i[a+e]=i[n+e]}++s}}if(a>0){e[s]=e[a];for(let e=a*r,n=s*r,o=0;o!==r;++o)i[n+o]=i[e+o];++s}return s!==e.length?(this.times=e.slice(0,s),this.values=i.slice(0,s*r)):(this.times=e,this.values=i),this}clone(){let e=this.times.slice(),i=this.values.slice(),r=new this.constructor(this.name,e,i);return r.createInterpolant=this.createInterpolant,r}}a2.prototype.ValueTypeName="",a2.prototype.TimeBufferType=Float32Array,a2.prototype.ValueBufferType=Float32Array,a2.prototype.DefaultInterpolation=tT;class a4 extends a2{constructor(e,i,r){super(e,i,r)}}a4.prototype.ValueTypeName="bool",a4.prototype.ValueBufferType=Array,a4.prototype.DefaultInterpolation=tb,a4.prototype.InterpolantFactoryMethodLinear=void 0,a4.prototype.InterpolantFactoryMethodSmooth=void 0;class a5 extends a2{constructor(e,i,r,n){super(e,i,r,n)}}a5.prototype.ValueTypeName="color";class a6 extends a2{constructor(e,i,r,n){super(e,i,r,n)}}a6.prototype.ValueTypeName="number";class a8 extends a${constructor(e,i,r,n){super(e,i,r,n)}interpolate_(e,i,r,n){let a=this.resultBuffer,s=this.sampleValues,o=this.valueSize,l=(r-i)/(n-i),c=e*o;for(let e=c+o;c!==e;c+=4)ir.slerpFlat(a,0,s,c-o,s,c,l);return a}}class a9 extends a2{constructor(e,i,r,n){super(e,i,r,n)}InterpolantFactoryMethodLinear(e){return new a8(this.times,this.values,this.getValueSize(),e)}}a9.prototype.ValueTypeName="quaternion",a9.prototype.InterpolantFactoryMethodSmooth=void 0;class a7 extends a2{constructor(e,i,r){super(e,i,r)}}a7.prototype.ValueTypeName="string",a7.prototype.ValueBufferType=Array,a7.prototype.DefaultInterpolation=tb,a7.prototype.InterpolantFactoryMethodLinear=void 0,a7.prototype.InterpolantFactoryMethodSmooth=void 0;class se extends a2{constructor(e,i,r,n){super(e,i,r,n)}}se.prototype.ValueTypeName="vector";class st{constructor(e="",i=-1,r=[],n=2500){this.name=e,this.tracks=r,this.duration=i,this.blendMode=n,this.uuid=t5(),this.userData={},this.duration<0&&this.resetDuration()}static parse(e){let i=[],r=e.tracks,n=1/(e.fps||1);for(let e=0,a=r.length;e!==a;++e)i.push((function(e){if(void 0===e.type)throw Error("THREE.KeyframeTrack: track type undefined, can not parse");let i=function(e){switch(e.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return a6;case"vector":case"vector2":case"vector3":case"vector4":return se;case"color":return a5;case"quaternion":return a9;case"bool":case"boolean":return a4;case"string":return a7}throw Error("THREE.KeyframeTrack: Unsupported typeName: "+e)}(e.type);if(void 0===e.times){let i=[],r=[];aQ(e.keys,i,r,"value"),e.times=i,e.values=r}return void 0!==i.parse?i.parse(e):new i(e.name,e.times,e.values,e.interpolation)})(r[e]).scale(n));let a=new this(e.name,e.duration,i,e.blendMode);return a.uuid=e.uuid,a.userData=JSON.parse(e.userData||"{}"),a}static toJSON(e){let i=[],r=e.tracks,n={name:e.name,duration:e.duration,tracks:i,uuid:e.uuid,blendMode:e.blendMode,userData:JSON.stringify(e.userData)};for(let e=0,n=r.length;e!==n;++e)i.push(a2.toJSON(r[e]));return n}static CreateFromMorphTargetSequence(e,i,r,n){let a=i.length,s=[];for(let e=0;e<a;e++){let o=[],l=[];o.push((e+a-1)%a,e,(e+1)%a),l.push(0,1,0);let c=function(e){let i=e.length,r=Array(i);for(let e=0;e!==i;++e)r[e]=e;return r.sort(function(i,r){return e[i]-e[r]}),r}(o);o=aZ(o,1,c),l=aZ(l,1,c),n||0!==o[0]||(o.push(a),l.push(l[0])),s.push(new a6(".morphTargetInfluences["+i[e].name+"]",o,l).scale(1/r))}return new this(e,-1,s)}static findByName(e,i){let r=e;Array.isArray(e)||(r=e.geometry&&e.geometry.animations||e.animations);for(let e=0;e<r.length;e++)if(r[e].name===i)return r[e];return null}static CreateClipsFromMorphTargetSequences(e,i,r){let n={},a=/^([\w-]*?)([\d]+)$/;for(let i=0,r=e.length;i<r;i++){let r=e[i],s=r.name.match(a);if(s&&s.length>1){let e=s[1],i=n[e];i||(n[e]=i=[]),i.push(r)}}let s=[];for(let e in n)s.push(this.CreateFromMorphTargetSequence(e,n[e],i,r));return s}static parseAnimation(e,i){if(tJ("AnimationClip: parseAnimation() is deprecated and will be removed with r185"),!e)return tZ("AnimationClip: No animation in JSONLoader data."),null;let r=function(e,i,r,n,a){if(0!==r.length){let s=[],o=[];aQ(r,s,o,n),0!==s.length&&a.push(new e(i,s,o))}},n=[],a=e.name||"default",s=e.fps||30,o=e.blendMode,l=e.length||-1,c=e.hierarchy||[];for(let e=0;e<c.length;e++){let a=c[e].keys;if(a&&0!==a.length)if(a[0].morphTargets){let e,i={};for(e=0;e<a.length;e++)if(a[e].morphTargets)for(let r=0;r<a[e].morphTargets.length;r++)i[a[e].morphTargets[r]]=-1;for(let r in i){let i=[],s=[];for(let n=0;n!==a[e].morphTargets.length;++n){let n=a[e];i.push(n.time),s.push(+(n.morphTarget===r))}n.push(new a6(".morphTargetInfluence["+r+"]",i,s))}l=i.length*s}else{let s=".bones["+i[e].name+"]";r(se,s+".position",a,"pos",n),r(a9,s+".quaternion",a,"rot",n),r(se,s+".scale",a,"scl",n)}}return 0===n.length?null:new this(a,l,n,o)}resetDuration(){let e=this.tracks,i=0;for(let r=0,n=e.length;r!==n;++r){let e=this.tracks[r];i=Math.max(i,e.times[e.times.length-1])}return this.duration=i,this}trim(){for(let e=0;e<this.tracks.length;e++)this.tracks[e].trim(0,this.duration);return this}validate(){let e=!0;for(let i=0;i<this.tracks.length;i++)e=e&&this.tracks[i].validate();return e}optimize(){for(let e=0;e<this.tracks.length;e++)this.tracks[e].optimize();return this}clone(){let e=[];for(let i=0;i<this.tracks.length;i++)e.push(this.tracks[i].clone());let i=new this.constructor(this.name,this.duration,e,this.blendMode);return i.userData=JSON.parse(JSON.stringify(this.userData)),i}toJSON(){return this.constructor.toJSON(this)}}let si={enabled:!1,files:{},add:function(e,i){!1!==this.enabled&&(this.files[e]=i)},get:function(e){if(!1!==this.enabled)return this.files[e]},remove:function(e){delete this.files[e]},clear:function(){this.files={}}},sr=new class{constructor(e,i,r){let n;const a=this;let s=!1,o=0,l=0;const c=[];this.onStart=void 0,this.onLoad=e,this.onProgress=i,this.onError=r,this._abortController=null,this.itemStart=function(e){l++,!1===s&&void 0!==a.onStart&&a.onStart(e,o,l),s=!0},this.itemEnd=function(e){o++,void 0!==a.onProgress&&a.onProgress(e,o,l),o===l&&(s=!1,void 0!==a.onLoad&&a.onLoad())},this.itemError=function(e){void 0!==a.onError&&a.onError(e)},this.resolveURL=function(e){return n?n(e):e},this.setURLModifier=function(e){return n=e,this},this.addHandler=function(e,i){return c.push(e,i),this},this.removeHandler=function(e){let i=c.indexOf(e);return -1!==i&&c.splice(i,2),this},this.getHandler=function(e){for(let i=0,r=c.length;i<r;i+=2){let r=c[i],n=c[i+1];if(r.global&&(r.lastIndex=0),r.test(e))return n}return null},this.abort=function(){return this.abortController.abort(),this._abortController=null,this}}get abortController(){return this._abortController||(this._abortController=new AbortController),this._abortController}};class sn{constructor(e){this.manager=void 0!==e?e:sr,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(e,i){let r=this;return new Promise(function(n,a){r.load(e,n,i,a)})}parse(){}setCrossOrigin(e){return this.crossOrigin=e,this}setWithCredentials(e){return this.withCredentials=e,this}setPath(e){return this.path=e,this}setResourcePath(e){return this.resourcePath=e,this}setRequestHeader(e){return this.requestHeader=e,this}abort(){return this}}sn.DEFAULT_MATERIAL_NAME="__DEFAULT";let sa={};class ss extends Error{constructor(e,i){super(e),this.response=i}}class so extends sn{constructor(e){super(e),this.mimeType="",this.responseType="",this._abortController=new AbortController}load(e,i,r,n){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);let a=si.get(`file:${e}`);if(void 0!==a)return this.manager.itemStart(e),setTimeout(()=>{i&&i(a),this.manager.itemEnd(e)},0),a;if(void 0!==sa[e])return void sa[e].push({onLoad:i,onProgress:r,onError:n});sa[e]=[],sa[e].push({onLoad:i,onProgress:r,onError:n});let s=new Request(e,{headers:new Headers(this.requestHeader),credentials:this.withCredentials?"include":"same-origin",signal:"function"==typeof AbortSignal.any?AbortSignal.any([this._abortController.signal,this.manager.abortController.signal]):this._abortController.signal}),o=this.mimeType,l=this.responseType;fetch(s).then(i=>{if(200===i.status||0===i.status){if(0===i.status&&tJ("FileLoader: HTTP Status 0 received."),"u"<typeof ReadableStream||void 0===i.body||void 0===i.body.getReader)return i;let r=sa[e],n=i.body.getReader(),a=i.headers.get("X-File-Size")||i.headers.get("Content-Length"),s=a?parseInt(a):0,o=0!==s,l=0;return new Response(new ReadableStream({start(e){!function i(){n.read().then(({done:n,value:a})=>{if(n)e.close();else{let n=new ProgressEvent("progress",{lengthComputable:o,loaded:l+=a.byteLength,total:s});for(let e=0,i=r.length;e<i;e++){let i=r[e];i.onProgress&&i.onProgress(n)}e.enqueue(a),i()}},i=>{e.error(i)})}()}}))}throw new ss(`fetch for "${i.url}" responded with ${i.status}: ${i.statusText}`,i)}).then(e=>{switch(l){case"arraybuffer":return e.arrayBuffer();case"blob":return e.blob();case"document":return e.text().then(e=>new DOMParser().parseFromString(e,o));case"json":return e.json();default:if(""===o)return e.text();{let i=/charset="?([^;"\s]*)"?/i.exec(o),r=new TextDecoder(i&&i[1]?i[1].toLowerCase():void 0);return e.arrayBuffer().then(e=>r.decode(e))}}}).then(i=>{si.add(`file:${e}`,i);let r=sa[e];delete sa[e];for(let e=0,n=r.length;e<n;e++){let n=r[e];n.onLoad&&n.onLoad(i)}}).catch(i=>{let r=sa[e];if(void 0===r)throw this.manager.itemError(e),i;delete sa[e];for(let e=0,n=r.length;e<n;e++){let n=r[e];n.onError&&n.onError(i)}this.manager.itemError(e)}).finally(()=>{this.manager.itemEnd(e)}),this.manager.itemStart(e)}setResponseType(e){return this.responseType=e,this}setMimeType(e){return this.mimeType=e,this}abort(){return this._abortController.abort(),this._abortController=new AbortController,this}}let sl=new WeakMap;class sc extends sn{constructor(e){super(e)}load(e,i,r,n){void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);let a=this,s=si.get(`image:${e}`);if(void 0!==s){if(!0===s.complete)a.manager.itemStart(e),setTimeout(function(){i&&i(s),a.manager.itemEnd(e)},0);else{let e=sl.get(s);void 0===e&&(e=[],sl.set(s,e)),e.push({onLoad:i,onError:n})}return s}let o=tj("img");function l(){h(),i&&i(this);let r=sl.get(this)||[];for(let e=0;e<r.length;e++){let i=r[e];i.onLoad&&i.onLoad(this)}sl.delete(this),a.manager.itemEnd(e)}function c(i){h(),n&&n(i),si.remove(`image:${e}`);let r=sl.get(this)||[];for(let e=0;e<r.length;e++){let n=r[e];n.onError&&n.onError(i)}sl.delete(this),a.manager.itemError(e),a.manager.itemEnd(e)}function h(){o.removeEventListener("load",l,!1),o.removeEventListener("error",c,!1)}return o.addEventListener("load",l,!1),o.addEventListener("error",c,!1),"data:"!==e.slice(0,5)&&void 0!==this.crossOrigin&&(o.crossOrigin=this.crossOrigin),si.add(`image:${e}`,o),a.manager.itemStart(e),o.src=e,o}}class sh extends sn{constructor(e){super(e)}load(e,i,r,n){let a=new iS,s=new sc(this.manager);return s.setCrossOrigin(this.crossOrigin),s.setPath(this.path),s.load(e,function(e){a.image=e,a.needsUpdate=!0,void 0!==i&&i(a)},r,n),a}}class su extends r_{constructor(e,i=1){super(),this.isLight=!0,this.type="Light",this.color=new rF(e),this.intensity=i}dispose(){this.dispatchEvent({type:"dispose"})}copy(e,i){return super.copy(e,i),this.color.copy(e.color),this.intensity=e.intensity,this}toJSON(e){let i=super.toJSON(e);return i.object.color=this.color.getHex(),i.object.intensity=this.intensity,i}}let sd=new i1,sp=new ia,sf=new ia;class sm{constructor(e){this.camera=e,this.intensity=1,this.bias=0,this.normalBias=0,this.radius=1,this.blurSamples=8,this.mapSize=new ii(512,512),this.mapType=eR,this.map=null,this.mapPass=null,this.matrix=new i1,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new n6,this._frameExtents=new ii(1,1),this._viewportCount=1,this._viewports=[new ib(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(e){let i=this.camera,r=this.matrix;sp.setFromMatrixPosition(e.matrixWorld),i.position.copy(sp),sf.setFromMatrixPosition(e.target.matrixWorld),i.lookAt(sf),i.updateMatrixWorld(),sd.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),this._frustum.setFromProjectionMatrix(sd,i.coordinateSystem,i.reversedDepth),i.reversedDepth?r.set(.5,0,0,.5,0,.5,0,.5,0,0,1,0,0,0,0,1):r.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),r.multiply(sd)}getViewport(e){return this._viewports[e]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(e){return this.camera=e.camera.clone(),this.intensity=e.intensity,this.bias=e.bias,this.radius=e.radius,this.autoUpdate=e.autoUpdate,this.needsUpdate=e.needsUpdate,this.normalBias=e.normalBias,this.blurSamples=e.blurSamples,this.mapSize.copy(e.mapSize),this}clone(){return new this.constructor().copy(this)}toJSON(){let e={};return 1!==this.intensity&&(e.intensity=this.intensity),0!==this.bias&&(e.bias=this.bias),0!==this.normalBias&&(e.normalBias=this.normalBias),1!==this.radius&&(e.radius=this.radius),(512!==this.mapSize.x||512!==this.mapSize.y)&&(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}}class sg extends sm{constructor(){super(new n_(50,1,.5,500)),this.isSpotLightShadow=!0,this.focus=1,this.aspect=1}updateMatrices(e){let i=this.camera,r=2*t4*e.angle*this.focus,n=this.mapSize.width/this.mapSize.height*this.aspect,a=e.distance||i.far;(r!==i.fov||n!==i.aspect||a!==i.far)&&(i.fov=r,i.aspect=n,i.far=a,i.updateProjectionMatrix()),super.updateMatrices(e)}copy(e){return super.copy(e),this.focus=e.focus,this}}class sv extends su{constructor(e,i,r=0,n=Math.PI/3,a=0,s=2){super(e,i),this.isSpotLight=!0,this.type="SpotLight",this.position.copy(r_.DEFAULT_UP),this.updateMatrix(),this.target=new r_,this.distance=r,this.angle=n,this.penumbra=a,this.decay=s,this.map=null,this.shadow=new sg}get power(){return this.intensity*Math.PI}set power(e){this.intensity=e/Math.PI}dispose(){super.dispose(),this.shadow.dispose()}copy(e,i){return super.copy(e,i),this.distance=e.distance,this.angle=e.angle,this.penumbra=e.penumbra,this.decay=e.decay,this.target=e.target.clone(),this.map=e.map,this.shadow=e.shadow.clone(),this}toJSON(e){let i=super.toJSON(e);return i.object.distance=this.distance,i.object.angle=this.angle,i.object.decay=this.decay,i.object.penumbra=this.penumbra,i.object.target=this.target.uuid,this.map&&this.map.isTexture&&(i.object.map=this.map.toJSON(e).uuid),i.object.shadow=this.shadow.toJSON(),i}}class s_ extends sm{constructor(){super(new n_(90,1,.5,500)),this.isPointLightShadow=!0}}class sx extends su{constructor(e,i,r=0,n=2){super(e,i),this.isPointLight=!0,this.type="PointLight",this.distance=r,this.decay=n,this.shadow=new s_}get power(){return 4*this.intensity*Math.PI}set power(e){this.intensity=e/(4*Math.PI)}dispose(){super.dispose(),this.shadow.dispose()}copy(e,i){return super.copy(e,i),this.distance=e.distance,this.decay=e.decay,this.shadow=e.shadow.clone(),this}toJSON(e){let i=super.toJSON(e);return i.object.distance=this.distance,i.object.decay=this.decay,i.object.shadow=this.shadow.toJSON(),i}}class sy extends nf{constructor(e=-1,i=1,r=1,n=-1,a=.1,s=2e3){super(),this.isOrthographicCamera=!0,this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=i,this.top=r,this.bottom=n,this.near=a,this.far=s,this.updateProjectionMatrix()}copy(e,i){return super.copy(e,i),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=null===e.view?null:Object.assign({},e.view),this}setViewOffset(e,i,r,n,a,s){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=i,this.view.offsetX=r,this.view.offsetY=n,this.view.width=a,this.view.height=s,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){let e=(this.right-this.left)/(2*this.zoom),i=(this.top-this.bottom)/(2*this.zoom),r=(this.right+this.left)/2,n=(this.top+this.bottom)/2,a=r-e,s=r+e,o=n+i,l=n-i;if(null!==this.view&&this.view.enabled){let e=(this.right-this.left)/this.view.fullWidth/this.zoom,i=(this.top-this.bottom)/this.view.fullHeight/this.zoom;a+=e*this.view.offsetX,s=a+e*this.view.width,o-=i*this.view.offsetY,l=o-i*this.view.height}this.projectionMatrix.makeOrthographic(a,s,o,l,this.near,this.far,this.coordinateSystem,this.reversedDepth),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){let i=super.toJSON(e);return i.object.zoom=this.zoom,i.object.left=this.left,i.object.right=this.right,i.object.top=this.top,i.object.bottom=this.bottom,i.object.near=this.near,i.object.far=this.far,null!==this.view&&(i.object.view=Object.assign({},this.view)),i}}class sM extends sm{constructor(){super(new sy(-5,5,5,-5,.5,500)),this.isDirectionalLightShadow=!0}}class sS extends su{constructor(e,i){super(e,i),this.isDirectionalLight=!0,this.type="DirectionalLight",this.position.copy(r_.DEFAULT_UP),this.updateMatrix(),this.target=new r_,this.shadow=new sM}dispose(){super.dispose(),this.shadow.dispose()}copy(e){return super.copy(e),this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}toJSON(e){let i=super.toJSON(e);return i.object.shadow=this.shadow.toJSON(),i.object.target=this.target.uuid,i}}class sb extends su{constructor(e,i){super(e,i),this.isAmbientLight=!0,this.type="AmbientLight"}}class sT{static extractUrlBase(e){let i=e.lastIndexOf("/");return -1===i?"./":e.slice(0,i+1)}static resolveURL(e,i){return"string"!=typeof e||""===e?"":(/^https?:\/\//i.test(i)&&/^\//.test(e)&&(i=i.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e))?e:i+e}}let sE=new WeakMap;class sw extends sn{constructor(e){super(e),this.isImageBitmapLoader=!0,"u"<typeof createImageBitmap&&tJ("ImageBitmapLoader: createImageBitmap() not supported."),"u"<typeof fetch&&tJ("ImageBitmapLoader: fetch() not supported."),this.options={premultiplyAlpha:"none"},this._abortController=new AbortController}setOptions(e){return this.options=e,this}load(e,i,r,n){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);let a=this,s=si.get(`image-bitmap:${e}`);if(void 0!==s)return(a.manager.itemStart(e),s.then)?void s.then(r=>{if(!0!==sE.has(s))return i&&i(r),a.manager.itemEnd(e),r;n&&n(sE.get(s)),a.manager.itemError(e),a.manager.itemEnd(e)}):(setTimeout(function(){i&&i(s),a.manager.itemEnd(e)},0),s);let o={};o.credentials="anonymous"===this.crossOrigin?"same-origin":"include",o.headers=this.requestHeader,o.signal="function"==typeof AbortSignal.any?AbortSignal.any([this._abortController.signal,this.manager.abortController.signal]):this._abortController.signal;let l=fetch(e,o).then(function(e){return e.blob()}).then(function(e){return createImageBitmap(e,Object.assign(a.options,{colorSpaceConversion:"none"}))}).then(function(r){return si.add(`image-bitmap:${e}`,r),i&&i(r),a.manager.itemEnd(e),r}).catch(function(i){n&&n(i),sE.set(l,i),si.remove(`image-bitmap:${e}`),a.manager.itemError(e),a.manager.itemEnd(e)});si.add(`image-bitmap:${e}`,l),a.manager.itemStart(e)}abort(){return this._abortController.abort(),this._abortController=new AbortController,this}}class sA{static getContext(){return void 0===a&&(a=new(window.AudioContext||window.webkitAudioContext)),a}static setContext(e){a=e}}class sR extends sn{constructor(e){super(e)}load(e,i,r,n){let a=this,s=new so(this.manager);function o(i){n?n(i):tZ(i),a.manager.itemError(e)}s.setResponseType("arraybuffer"),s.setPath(this.path),s.setRequestHeader(this.requestHeader),s.setWithCredentials(this.withCredentials),s.load(e,function(e){try{let r=e.slice(0);sA.getContext().decodeAudioData(r,function(e){i(e)}).catch(o)}catch(e){o(e)}},r,n)}}class sC extends n_{constructor(e=[]){super(),this.isArrayCamera=!0,this.isMultiViewCamera=!1,this.cameras=e}}class sP{constructor(e=!0){this.autoStart=e,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=performance.now(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let e=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){let i=performance.now();e=(i-this.oldTime)/1e3,this.oldTime=i,this.elapsedTime+=e}return e}}let sI=new ia,sL=new ir,sD=new ia,sU=new ia,sN=new ia;class sO extends r_{constructor(){super(),this.type="AudioListener",this.context=sA.getContext(),this.gain=this.context.createGain(),this.gain.connect(this.context.destination),this.filter=null,this.timeDelta=0,this._clock=new sP}getInput(){return this.gain}removeFilter(){return null!==this.filter&&(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination),this.gain.connect(this.context.destination),this.filter=null),this}getFilter(){return this.filter}setFilter(e){return null!==this.filter?(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination)):this.gain.disconnect(this.context.destination),this.filter=e,this.gain.connect(this.filter),this.filter.connect(this.context.destination),this}getMasterVolume(){return this.gain.gain.value}setMasterVolume(e){return this.gain.gain.setTargetAtTime(e,this.context.currentTime,.01),this}updateMatrixWorld(e){super.updateMatrixWorld(e);let i=this.context.listener;if(this.timeDelta=this._clock.getDelta(),this.matrixWorld.decompose(sI,sL,sD),sU.set(0,0,-1).applyQuaternion(sL),sN.set(0,1,0).applyQuaternion(sL),i.positionX){let e=this.context.currentTime+this.timeDelta;i.positionX.linearRampToValueAtTime(sI.x,e),i.positionY.linearRampToValueAtTime(sI.y,e),i.positionZ.linearRampToValueAtTime(sI.z,e),i.forwardX.linearRampToValueAtTime(sU.x,e),i.forwardY.linearRampToValueAtTime(sU.y,e),i.forwardZ.linearRampToValueAtTime(sU.z,e),i.upX.linearRampToValueAtTime(sN.x,e),i.upY.linearRampToValueAtTime(sN.y,e),i.upZ.linearRampToValueAtTime(sN.z,e)}else i.setPosition(sI.x,sI.y,sI.z),i.setOrientation(sU.x,sU.y,sU.z,sN.x,sN.y,sN.z)}}class sF extends r_{constructor(e){super(),this.type="Audio",this.listener=e,this.context=e.context,this.gain=this.context.createGain(),this.gain.connect(e.getInput()),this.autoplay=!1,this.buffer=null,this.detune=0,this.loop=!1,this.loopStart=0,this.loopEnd=0,this.offset=0,this.duration=void 0,this.playbackRate=1,this.isPlaying=!1,this.hasPlaybackControl=!0,this.source=null,this.sourceType="empty",this._startedAt=0,this._progress=0,this._connected=!1,this.filters=[]}getOutput(){return this.gain}setNodeSource(e){return this.hasPlaybackControl=!1,this.sourceType="audioNode",this.source=e,this.connect(),this}setMediaElementSource(e){return this.hasPlaybackControl=!1,this.sourceType="mediaNode",this.source=this.context.createMediaElementSource(e),this.connect(),this}setMediaStreamSource(e){return this.hasPlaybackControl=!1,this.sourceType="mediaStreamNode",this.source=this.context.createMediaStreamSource(e),this.connect(),this}setBuffer(e){return this.buffer=e,this.sourceType="buffer",this.autoplay&&this.play(),this}play(e=0){if(!0===this.isPlaying)return void tJ("Audio: Audio is already playing.");if(!1===this.hasPlaybackControl)return void tJ("Audio: this Audio has no playback control.");this._startedAt=this.context.currentTime+e;let i=this.context.createBufferSource();return i.buffer=this.buffer,i.loop=this.loop,i.loopStart=this.loopStart,i.loopEnd=this.loopEnd,i.onended=this.onEnded.bind(this),i.start(this._startedAt,this._progress+this.offset,this.duration),this.isPlaying=!0,this.source=i,this.setDetune(this.detune),this.setPlaybackRate(this.playbackRate),this.connect()}pause(){return!1===this.hasPlaybackControl?void tJ("Audio: this Audio has no playback control."):(!0===this.isPlaying&&(this._progress+=Math.max(this.context.currentTime-this._startedAt,0)*this.playbackRate,!0===this.loop&&(this._progress=this._progress%(this.duration||this.buffer.duration)),this.source.stop(),this.source.onended=null,this.isPlaying=!1),this)}stop(e=0){return!1===this.hasPlaybackControl?void tJ("Audio: this Audio has no playback control."):(this._progress=0,null!==this.source&&(this.source.stop(this.context.currentTime+e),this.source.onended=null),this.isPlaying=!1,this)}connect(){if(this.filters.length>0){this.source.connect(this.filters[0]);for(let e=1,i=this.filters.length;e<i;e++)this.filters[e-1].connect(this.filters[e]);this.filters[this.filters.length-1].connect(this.getOutput())}else this.source.connect(this.getOutput());return this._connected=!0,this}disconnect(){if(!1!==this._connected){if(this.filters.length>0){this.source.disconnect(this.filters[0]);for(let e=1,i=this.filters.length;e<i;e++)this.filters[e-1].disconnect(this.filters[e]);this.filters[this.filters.length-1].disconnect(this.getOutput())}else this.source.disconnect(this.getOutput());return this._connected=!1,this}}getFilters(){return this.filters}setFilters(e){return e||(e=[]),!0===this._connected?(this.disconnect(),this.filters=e.slice(),this.connect()):this.filters=e.slice(),this}setDetune(e){return this.detune=e,!0===this.isPlaying&&void 0!==this.source.detune&&this.source.detune.setTargetAtTime(this.detune,this.context.currentTime,.01),this}getDetune(){return this.detune}getFilter(){return this.getFilters()[0]}setFilter(e){return this.setFilters(e?[e]:[])}setPlaybackRate(e){return!1===this.hasPlaybackControl?void tJ("Audio: this Audio has no playback control."):(this.playbackRate=e,!0===this.isPlaying&&this.source.playbackRate.setTargetAtTime(this.playbackRate,this.context.currentTime,.01),this)}getPlaybackRate(){return this.playbackRate}onEnded(){this.isPlaying=!1,this._progress=0}getLoop(){return!1===this.hasPlaybackControl?(tJ("Audio: this Audio has no playback control."),!1):this.loop}setLoop(e){return!1===this.hasPlaybackControl?void tJ("Audio: this Audio has no playback control."):(this.loop=e,!0===this.isPlaying&&(this.source.loop=this.loop),this)}setLoopStart(e){return this.loopStart=e,this}setLoopEnd(e){return this.loopEnd=e,this}getVolume(){return this.gain.gain.value}setVolume(e){return this.gain.gain.setTargetAtTime(e,this.context.currentTime,.01),this}copy(e,i){return(super.copy(e,i),"buffer"!==e.sourceType)?tJ("Audio: Audio source type cannot be copied."):(this.autoplay=e.autoplay,this.buffer=e.buffer,this.detune=e.detune,this.loop=e.loop,this.loopStart=e.loopStart,this.loopEnd=e.loopEnd,this.offset=e.offset,this.duration=e.duration,this.playbackRate=e.playbackRate,this.hasPlaybackControl=e.hasPlaybackControl,this.sourceType=e.sourceType,this.filters=e.filters.slice()),this}clone(e){return new this.constructor(this.listener).copy(this,e)}}let sB="\\[\\]\\.:\\/",sz=RegExp("["+sB+"]","g"),sk="[^"+sB+"]",sV="[^"+sB.replace("\\.","")+"]",sH=RegExp("^"+/((?:WC+[\/:])*)/.source.replace("WC",sk)+/(WCOD+)?/.source.replace("WCOD",sV)+/(?:\.(WC+)(?:\[(.+)\])?)?/.source.replace("WC",sk)+/\.(WC+)(?:\[(.+)\])?/.source.replace("WC",sk)+"$"),sG=["material","materials","bones","map"];class sW{constructor(e,i,r){this.path=i,this.parsedPath=r||sW.parseTrackName(i),this.node=sW.findNode(e,this.parsedPath.nodeName),this.rootNode=e,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}static create(e,i,r){return e&&e.isAnimationObjectGroup?new sW.Composite(e,i,r):new sW(e,i,r)}static sanitizeNodeName(e){return e.replace(/\s/g,"_").replace(sz,"")}static parseTrackName(e){let i=sH.exec(e);if(null===i)throw Error("PropertyBinding: Cannot parse trackName: "+e);let r={nodeName:i[2],objectName:i[3],objectIndex:i[4],propertyName:i[5],propertyIndex:i[6]},n=r.nodeName&&r.nodeName.lastIndexOf(".");if(void 0!==n&&-1!==n){let e=r.nodeName.substring(n+1);-1!==sG.indexOf(e)&&(r.nodeName=r.nodeName.substring(0,n),r.objectName=e)}if(null===r.propertyName||0===r.propertyName.length)throw Error("PropertyBinding: can not parse propertyName from trackName: "+e);return r}static findNode(e,i){if(void 0===i||""===i||"."===i||-1===i||i===e.name||i===e.uuid)return e;if(e.skeleton){let r=e.skeleton.getBoneByName(i);if(void 0!==r)return r}if(e.children){let r=function(e){for(let n=0;n<e.length;n++){let a=e[n];if(a.name===i||a.uuid===i)return a;let s=r(a.children);if(s)return s}return null},n=r(e.children);if(n)return n}return null}_getValue_unavailable(){}_setValue_unavailable(){}_getValue_direct(e,i){e[i]=this.targetObject[this.propertyName]}_getValue_array(e,i){let r=this.resolvedProperty;for(let n=0,a=r.length;n!==a;++n)e[i++]=r[n]}_getValue_arrayElement(e,i){e[i]=this.resolvedProperty[this.propertyIndex]}_getValue_toArray(e,i){this.resolvedProperty.toArray(e,i)}_setValue_direct(e,i){this.targetObject[this.propertyName]=e[i]}_setValue_direct_setNeedsUpdate(e,i){this.targetObject[this.propertyName]=e[i],this.targetObject.needsUpdate=!0}_setValue_direct_setMatrixWorldNeedsUpdate(e,i){this.targetObject[this.propertyName]=e[i],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_array(e,i){let r=this.resolvedProperty;for(let n=0,a=r.length;n!==a;++n)r[n]=e[i++]}_setValue_array_setNeedsUpdate(e,i){let r=this.resolvedProperty;for(let n=0,a=r.length;n!==a;++n)r[n]=e[i++];this.targetObject.needsUpdate=!0}_setValue_array_setMatrixWorldNeedsUpdate(e,i){let r=this.resolvedProperty;for(let n=0,a=r.length;n!==a;++n)r[n]=e[i++];this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_arrayElement(e,i){this.resolvedProperty[this.propertyIndex]=e[i]}_setValue_arrayElement_setNeedsUpdate(e,i){this.resolvedProperty[this.propertyIndex]=e[i],this.targetObject.needsUpdate=!0}_setValue_arrayElement_setMatrixWorldNeedsUpdate(e,i){this.resolvedProperty[this.propertyIndex]=e[i],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_fromArray(e,i){this.resolvedProperty.fromArray(e,i)}_setValue_fromArray_setNeedsUpdate(e,i){this.resolvedProperty.fromArray(e,i),this.targetObject.needsUpdate=!0}_setValue_fromArray_setMatrixWorldNeedsUpdate(e,i){this.resolvedProperty.fromArray(e,i),this.targetObject.matrixWorldNeedsUpdate=!0}_getValue_unbound(e,i){this.bind(),this.getValue(e,i)}_setValue_unbound(e,i){this.bind(),this.setValue(e,i)}bind(){let e=this.node,i=this.parsedPath,r=i.objectName,n=i.propertyName,a=i.propertyIndex;if(e||(e=sW.findNode(this.rootNode,i.nodeName),this.node=e),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,!e)return void tJ("PropertyBinding: No target node found for track: "+this.path+".");if(r){let n=i.objectIndex;switch(r){case"materials":if(!e.material)return void tZ("PropertyBinding: Can not bind to material as node does not have a material.",this);if(!e.material.materials)return void tZ("PropertyBinding: Can not bind to material.materials as node.material does not have a materials array.",this);e=e.material.materials;break;case"bones":if(!e.skeleton)return void tZ("PropertyBinding: Can not bind to bones as node does not have a skeleton.",this);e=e.skeleton.bones;for(let i=0;i<e.length;i++)if(e[i].name===n){n=i;break}break;case"map":if("map"in e){e=e.map;break}if(!e.material)return void tZ("PropertyBinding: Can not bind to material as node does not have a material.",this);if(!e.material.map)return void tZ("PropertyBinding: Can not bind to material.map as node.material does not have a map.",this);e=e.material.map;break;default:if(void 0===e[r])return void tZ("PropertyBinding: Can not bind to objectName of node undefined.",this);e=e[r]}if(void 0!==n){if(void 0===e[n])return void tZ("PropertyBinding: Trying to bind to objectIndex of objectName, but is undefined.",this,e);e=e[n]}}let s=e[n];if(void 0===s)return void tZ("PropertyBinding: Trying to update property for track: "+i.nodeName+"."+n+" but it wasn't found.",e);let o=this.Versioning.None;this.targetObject=e,!0===e.isMaterial?o=this.Versioning.NeedsUpdate:!0===e.isObject3D&&(o=this.Versioning.MatrixWorldNeedsUpdate);let l=this.BindingType.Direct;if(void 0!==a){if("morphTargetInfluences"===n){if(!e.geometry)return void tZ("PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.",this);if(!e.geometry.morphAttributes)return void tZ("PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphAttributes.",this);void 0!==e.morphTargetDictionary[a]&&(a=e.morphTargetDictionary[a])}l=this.BindingType.ArrayElement,this.resolvedProperty=s,this.propertyIndex=a}else void 0!==s.fromArray&&void 0!==s.toArray?(l=this.BindingType.HasFromToArray,this.resolvedProperty=s):Array.isArray(s)?(l=this.BindingType.EntireArray,this.resolvedProperty=s):this.propertyName=n;this.getValue=this.GetterByBindingType[l],this.setValue=this.SetterByBindingTypeAndVersioning[l][o]}unbind(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}sW.Composite=class{constructor(e,i,r){const n=r||sW.parseTrackName(i);this._targetGroup=e,this._bindings=e.subscribe_(i,n)}getValue(e,i){this.bind();let r=this._targetGroup.nCachedObjects_,n=this._bindings[r];void 0!==n&&n.getValue(e,i)}setValue(e,i){let r=this._bindings;for(let n=this._targetGroup.nCachedObjects_,a=r.length;n!==a;++n)r[n].setValue(e,i)}bind(){let e=this._bindings;for(let i=this._targetGroup.nCachedObjects_,r=e.length;i!==r;++i)e[i].bind()}unbind(){let e=this._bindings;for(let i=this._targetGroup.nCachedObjects_,r=e.length;i!==r;++i)e[i].unbind()}},sW.prototype.BindingType={Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},sW.prototype.Versioning={None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},sW.prototype.GetterByBindingType=[sW.prototype._getValue_direct,sW.prototype._getValue_array,sW.prototype._getValue_arrayElement,sW.prototype._getValue_toArray],sW.prototype.SetterByBindingTypeAndVersioning=[[sW.prototype._setValue_direct,sW.prototype._setValue_direct_setNeedsUpdate,sW.prototype._setValue_direct_setMatrixWorldNeedsUpdate],[sW.prototype._setValue_array,sW.prototype._setValue_array_setNeedsUpdate,sW.prototype._setValue_array_setMatrixWorldNeedsUpdate],[sW.prototype._setValue_arrayElement,sW.prototype._setValue_arrayElement_setNeedsUpdate,sW.prototype._setValue_arrayElement_setMatrixWorldNeedsUpdate],[sW.prototype._setValue_fromArray,sW.prototype._setValue_fromArray_setNeedsUpdate,sW.prototype._setValue_fromArray_setMatrixWorldNeedsUpdate]],new Float32Array(1);let sX=new i1;class sj{constructor(e,i,r=0,n=1/0){this.ray=new i0(e,i),this.near=r,this.far=n,this.camera=null,this.layers=new ri,this.params={Mesh:{},Line:{threshold:1},LOD:{},Points:{threshold:1},Sprite:{}}}set(e,i){this.ray.set(e,i)}setFromCamera(e,i){i.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(i.matrixWorld),this.ray.direction.set(e.x,e.y,.5).unproject(i).sub(this.ray.origin).normalize(),this.camera=i):i.isOrthographicCamera?(this.ray.origin.set(e.x,e.y,(i.near+i.far)/(i.near-i.far)).unproject(i),this.ray.direction.set(0,0,-1).transformDirection(i.matrixWorld),this.camera=i):tZ("Raycaster: Unsupported camera type: "+i.type)}setFromXRController(e){return sX.identity().extractRotation(e.matrixWorld),this.ray.origin.setFromMatrixPosition(e.matrixWorld),this.ray.direction.set(0,0,-1).applyMatrix4(sX),this}intersectObject(e,i=!0,r=[]){return sY(e,this,r,i),r.sort(sq),r}intersectObjects(e,i=!0,r=[]){for(let n=0,a=e.length;n<a;n++)sY(e[n],this,r,i);return r.sort(sq),r}}function sq(e,i){return e.distance-i.distance}function sY(e,i,r,n){let a=!0;if(e.layers.test(i.layers)&&!1===e.raycast(i,r)&&(a=!1),!0===a&&!0===n){let n=e.children;for(let e=0,a=n.length;e<a;e++)sY(n[e],i,r,!0)}}let sK=new ia,sJ=new ia,sZ=new ia,sQ=new ia,s$=new ia,s0=new ia,s1=new ia;class s3{constructor(e=new ia,i=new ia){this.start=e,this.end=i}set(e,i){return this.start.copy(e),this.end.copy(i),this}copy(e){return this.start.copy(e.start),this.end.copy(e.end),this}getCenter(e){return e.addVectors(this.start,this.end).multiplyScalar(.5)}delta(e){return e.subVectors(this.end,this.start)}distanceSq(){return this.start.distanceToSquared(this.end)}distance(){return this.start.distanceTo(this.end)}at(e,i){return this.delta(i).multiplyScalar(e).add(this.start)}closestPointToPointParameter(e,i){sK.subVectors(e,this.start),sJ.subVectors(this.end,this.start);let r=sJ.dot(sJ),n=sJ.dot(sK)/r;return i&&(n=t6(n,0,1)),n}closestPointToPoint(e,i,r){let n=this.closestPointToPointParameter(e,i);return this.delta(r).multiplyScalar(n).add(this.start)}distanceSqToLine3(e,i=s0,r=s1){let n,a,s=1e-8*1e-8,o=this.start,l=e.start,c=this.end,h=e.end;sZ.subVectors(c,o),sQ.subVectors(h,l),s$.subVectors(o,l);let u=sZ.dot(sZ),d=sQ.dot(sQ),p=sQ.dot(s$);if(u<=s&&d<=s)return i.copy(o),r.copy(l),i.sub(r),i.dot(i);if(u<=s)n=0,a=t6(a=p/d,0,1);else{let e=sZ.dot(s$);if(d<=s)a=0,n=t6(-e/u,0,1);else{let i=sZ.dot(sQ),r=u*d-i*i;n=0!==r?t6((i*p-e*d)/r,0,1):0,(a=(i*n+p)/d)<0?(a=0,n=t6(-e/u,0,1)):a>1&&(a=1,n=t6((i-e)/u,0,1))}}return i.copy(o).add(sZ.multiplyScalar(n)),r.copy(l).add(sQ.multiplyScalar(a)),i.sub(r),i.dot(i)}applyMatrix4(e){return this.start.applyMatrix4(e),this.end.applyMatrix4(e),this}equals(e){return e.start.equals(this.start)&&e.end.equals(this.end)}clone(){return new this.constructor().copy(this)}}let s2=new ia;class s4 extends r_{constructor(e=new ia(0,0,1),i=new ia(0,0,0),r=1,n=0xffff00,a=.2*r,l=.2*a){super(),this.type="ArrowHelper",void 0===s&&((s=new r3).setAttribute("position",new rY([0,0,0,0,1,0],3)),(o=new aE(.5,1,5,1)).translate(0,-.5,0)),this.position.copy(i),this.line=new aa(s,new n8({color:n,toneMapped:!1})),this.line.matrixAutoUpdate=!1,this.add(this.line),this.cone=new nn(o,new rV({color:n,toneMapped:!1})),this.cone.matrixAutoUpdate=!1,this.add(this.cone),this.setDirection(e),this.setLength(r,a,l)}setDirection(e){if(e.y>.99999)this.quaternion.set(0,0,0,1);else if(e.y<-.99999)this.quaternion.set(1,0,0,0);else{s2.set(e.z,0,-e.x).normalize();let i=Math.acos(e.y);this.quaternion.setFromAxisAngle(s2,i)}}setLength(e,i=.2*e,r=.2*i){this.line.scale.set(1,Math.max(1e-4,e-i),1),this.line.updateMatrix(),this.cone.scale.set(r,i,r),this.cone.position.y=e,this.cone.updateMatrix()}setColor(e){this.line.material.color.set(e),this.cone.material.color.set(e)}copy(e){return super.copy(e,!1),this.line.copy(e.line),this.cone.copy(e.cone),this}dispose(){this.line.geometry.dispose(),this.line.material.dispose(),this.cone.geometry.dispose(),this.cone.material.dispose()}}function s5(e,i,r,n){let a=function(e){switch(e){case eR:case eC:return{byteLength:1,components:1};case eI:case eP:case eN:return{byteLength:2,components:1};case eO:case eF:return{byteLength:2,components:4};case eD:case eL:case eU:return{byteLength:4,components:1};case ez:case ek:return{byteLength:4,components:3}}throw Error(`Unknown texture type ${e}.`)}(n);switch(r){case eV:return e*i;case ej:case eq:return e*i/a.components*a.byteLength;case eY:case eK:return e*i*2/a.components*a.byteLength;case eH:return e*i*3/a.components*a.byteLength;case eG:case eJ:return e*i*4/a.components*a.byteLength;case eZ:case eQ:return Math.floor((e+3)/4)*Math.floor((i+3)/4)*8;case e$:case e0:return Math.floor((e+3)/4)*Math.floor((i+3)/4)*16;case e3:case e4:return Math.max(e,16)*Math.max(i,8)/4;case e1:case e2:return Math.max(e,8)*Math.max(i,8)/2;case e5:case e6:case e9:case e7:return Math.floor((e+3)/4)*Math.floor((i+3)/4)*8;case e8:case te:case tt:case ti:return Math.floor((e+3)/4)*Math.floor((i+3)/4)*16;case tr:return Math.floor((e+4)/5)*Math.floor((i+3)/4)*16;case tn:return Math.floor((e+4)/5)*Math.floor((i+4)/5)*16;case ta:return Math.floor((e+5)/6)*Math.floor((i+4)/5)*16;case ts:return Math.floor((e+5)/6)*Math.floor((i+5)/6)*16;case to:return Math.floor((e+7)/8)*Math.floor((i+4)/5)*16;case tl:return Math.floor((e+7)/8)*Math.floor((i+5)/6)*16;case tc:return Math.floor((e+7)/8)*Math.floor((i+7)/8)*16;case th:return Math.floor((e+9)/10)*Math.floor((i+4)/5)*16;case tu:return Math.floor((e+9)/10)*Math.floor((i+5)/6)*16;case td:return Math.floor((e+9)/10)*Math.floor((i+7)/8)*16;case tp:return Math.floor((e+9)/10)*Math.floor((i+9)/10)*16;case tf:return Math.floor((e+11)/12)*Math.floor((i+9)/10)*16;case tm:return Math.floor((e+11)/12)*Math.floor((i+11)/12)*16;case tg:case tv:case t_:return Math.ceil(e/4)*Math.ceil(i/4)*16;case tx:case ty:return Math.ceil(e/4)*Math.ceil(i/4)*8;case tM:case tS:return Math.ceil(e/4)*Math.ceil(i/4)*16}throw Error(`Unable to determine texture byte length for ${r} format.`)}"u">typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:d}})),"u">typeof window&&(window.__THREE__?tJ("WARNING: Multiple instances of Three.js being imported."):window.__THREE__=d)},"./node_modules/three/build/three.module.js"(e,i,r){"use strict";r.d(i,{JeP:()=>tV});var n=r("./node_modules/three/build/three.core.js");function a(){let e=null,i=!1,r=null,n=null;function a(i,s){r(i,s),n=e.requestAnimationFrame(a)}return{start:function(){!0===i||null!==r&&(n=e.requestAnimationFrame(a),i=!0)},stop:function(){e.cancelAnimationFrame(n),i=!1},setAnimationLoop:function(e){r=e},setContext:function(i){e=i}}}function s(e){let i=new WeakMap;return{get:function(e){return e.isInterleavedBufferAttribute&&(e=e.data),i.get(e)},remove:function(r){r.isInterleavedBufferAttribute&&(r=r.data);let n=i.get(r);n&&(e.deleteBuffer(n.buffer),i.delete(r))},update:function(r,n){if(r.isInterleavedBufferAttribute&&(r=r.data),r.isGLBufferAttribute){let e=i.get(r);(!e||e.version<r.version)&&i.set(r,{buffer:r.buffer,type:r.type,bytesPerElement:r.elementSize,version:r.version});return}let a=i.get(r);if(void 0===a)i.set(r,function(i,r){let n,a=i.array,s=i.usage,o=a.byteLength,l=e.createBuffer();if(e.bindBuffer(r,l),e.bufferData(r,a,s),i.onUploadCallback(),a instanceof Float32Array)n=e.FLOAT;else if("u">typeof Float16Array&&a instanceof Float16Array)n=e.HALF_FLOAT;else if(a instanceof Uint16Array)n=i.isFloat16BufferAttribute?e.HALF_FLOAT:e.UNSIGNED_SHORT;else if(a instanceof Int16Array)n=e.SHORT;else if(a instanceof Uint32Array)n=e.UNSIGNED_INT;else if(a instanceof Int32Array)n=e.INT;else if(a instanceof Int8Array)n=e.BYTE;else if(a instanceof Uint8Array)n=e.UNSIGNED_BYTE;else if(a instanceof Uint8ClampedArray)n=e.UNSIGNED_BYTE;else throw Error("THREE.WebGLAttributes: Unsupported buffer data format: "+a);return{buffer:l,type:n,bytesPerElement:a.BYTES_PER_ELEMENT,version:i.version,size:o}}(r,n));else if(a.version<r.version){if(a.size!==r.array.byteLength)throw Error("THREE.WebGLAttributes: The size of the buffer attribute's array buffer does not match the original size. Resizing buffer attributes is not supported.");!function(i,r,n){let a=r.array,s=r.updateRanges;if(e.bindBuffer(n,i),0===s.length)e.bufferSubData(n,0,a);else{s.sort((e,i)=>e.start-i.start);let i=0;for(let e=1;e<s.length;e++){let r=s[i],n=s[e];n.start<=r.start+r.count+1?r.count=Math.max(r.count,n.start+n.count-r.start):s[++i]=n}s.length=i+1;for(let i=0,r=s.length;i<r;i++){let r=s[i];e.bufferSubData(n,r.start*a.BYTES_PER_ELEMENT,a,r.start,r.count)}r.clearUpdateRanges()}r.onUploadCallback()}(a.buffer,r,n),a.version=r.version}}}}let o={alphahash_fragment:`#ifdef USE_ALPHAHASH
	if ( diffuseColor.a < getAlphaHashThreshold( vPosition ) ) discard;
 #endif`,alphahash_pars_fragment:`#ifdef USE_ALPHAHASH
	const float ALPHA_HASH_SCALE = 0.05;
	float hash2D( vec2 value ) {
		return fract( 1.0e4 * sin( 17.0 * value.x + 0.1 * value.y ) * ( 0.1 + abs( sin( 13.0 * value.y + value.x ) ) ) );
@@ -3601,11 +3600,11 @@ void main() {
	outgoingLight = diffuseColor.rgb;
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
-}`},l={common:{diffuse:{value:new n.Q1f(0xffffff)},opacity:{value:1},map:{value:null},mapTransform:{value:new n.dwI},alphaMap:{value:null},alphaMapTransform:{value:new n.dwI},alphaTest:{value:0}},specularmap:{specularMap:{value:null},specularMapTransform:{value:new n.dwI}},envmap:{envMap:{value:null},envMapRotation:{value:new n.dwI},flipEnvMap:{value:-1},reflectivity:{value:1},ior:{value:1.5},refractionRatio:{value:.98},dfgLUT:{value:null}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1},aoMapTransform:{value:new n.dwI}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1},lightMapTransform:{value:new n.dwI}},bumpmap:{bumpMap:{value:null},bumpMapTransform:{value:new n.dwI},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalMapTransform:{value:new n.dwI},normalScale:{value:new n.I9Y(1,1)}},displacementmap:{displacementMap:{value:null},displacementMapTransform:{value:new n.dwI},displacementScale:{value:1},displacementBias:{value:0}},emissivemap:{emissiveMap:{value:null},emissiveMapTransform:{value:new n.dwI}},metalnessmap:{metalnessMap:{value:null},metalnessMapTransform:{value:new n.dwI}},roughnessmap:{roughnessMap:{value:null},roughnessMapTransform:{value:new n.dwI}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new n.Q1f(0xffffff)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotLightMap:{value:[]},spotShadowMap:{value:[]},spotLightMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new n.Q1f(0xffffff)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},alphaMapTransform:{value:new n.dwI},alphaTest:{value:0},uvTransform:{value:new n.dwI}},sprite:{diffuse:{value:new n.Q1f(0xffffff)},opacity:{value:1},center:{value:new n.I9Y(.5,.5)},rotation:{value:0},map:{value:null},mapTransform:{value:new n.dwI},alphaMap:{value:null},alphaMapTransform:{value:new n.dwI},alphaTest:{value:0}}},c={basic:{uniforms:(0,n.Iit)([l.common,l.specularmap,l.envmap,l.aomap,l.lightmap,l.fog]),vertexShader:o.meshbasic_vert,fragmentShader:o.meshbasic_frag},lambert:{uniforms:(0,n.Iit)([l.common,l.specularmap,l.envmap,l.aomap,l.lightmap,l.emissivemap,l.bumpmap,l.normalmap,l.displacementmap,l.fog,l.lights,{emissive:{value:new n.Q1f(0)}}]),vertexShader:o.meshlambert_vert,fragmentShader:o.meshlambert_frag},phong:{uniforms:(0,n.Iit)([l.common,l.specularmap,l.envmap,l.aomap,l.lightmap,l.emissivemap,l.bumpmap,l.normalmap,l.displacementmap,l.fog,l.lights,{emissive:{value:new n.Q1f(0)},specular:{value:new n.Q1f(1118481)},shininess:{value:30}}]),vertexShader:o.meshphong_vert,fragmentShader:o.meshphong_frag},standard:{uniforms:(0,n.Iit)([l.common,l.envmap,l.aomap,l.lightmap,l.emissivemap,l.bumpmap,l.normalmap,l.displacementmap,l.roughnessmap,l.metalnessmap,l.fog,l.lights,{emissive:{value:new n.Q1f(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:o.meshphysical_vert,fragmentShader:o.meshphysical_frag},toon:{uniforms:(0,n.Iit)([l.common,l.aomap,l.lightmap,l.emissivemap,l.bumpmap,l.normalmap,l.displacementmap,l.gradientmap,l.fog,l.lights,{emissive:{value:new n.Q1f(0)}}]),vertexShader:o.meshtoon_vert,fragmentShader:o.meshtoon_frag},matcap:{uniforms:(0,n.Iit)([l.common,l.bumpmap,l.normalmap,l.displacementmap,l.fog,{matcap:{value:null}}]),vertexShader:o.meshmatcap_vert,fragmentShader:o.meshmatcap_frag},points:{uniforms:(0,n.Iit)([l.points,l.fog]),vertexShader:o.points_vert,fragmentShader:o.points_frag},dashed:{uniforms:(0,n.Iit)([l.common,l.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:o.linedashed_vert,fragmentShader:o.linedashed_frag},depth:{uniforms:(0,n.Iit)([l.common,l.displacementmap]),vertexShader:o.depth_vert,fragmentShader:o.depth_frag},normal:{uniforms:(0,n.Iit)([l.common,l.bumpmap,l.normalmap,l.displacementmap,{opacity:{value:1}}]),vertexShader:o.meshnormal_vert,fragmentShader:o.meshnormal_frag},sprite:{uniforms:(0,n.Iit)([l.sprite,l.fog]),vertexShader:o.sprite_vert,fragmentShader:o.sprite_frag},background:{uniforms:{uvTransform:{value:new n.dwI},t2D:{value:null},backgroundIntensity:{value:1}},vertexShader:o.background_vert,fragmentShader:o.background_frag},backgroundCube:{uniforms:{envMap:{value:null},flipEnvMap:{value:-1},backgroundBlurriness:{value:0},backgroundIntensity:{value:1},backgroundRotation:{value:new n.dwI}},vertexShader:o.backgroundCube_vert,fragmentShader:o.backgroundCube_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:o.cube_vert,fragmentShader:o.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:o.equirect_vert,fragmentShader:o.equirect_frag},distance:{uniforms:(0,n.Iit)([l.common,l.displacementmap,{referencePosition:{value:new n.Pq0},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:o.distance_vert,fragmentShader:o.distance_frag},shadow:{uniforms:(0,n.Iit)([l.lights,l.fog,{color:{value:new n.Q1f(0)},opacity:{value:1}}]),vertexShader:o.shadow_vert,fragmentShader:o.shadow_frag}};c.physical={uniforms:(0,n.Iit)([c.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatMapTransform:{value:new n.dwI},clearcoatNormalMap:{value:null},clearcoatNormalMapTransform:{value:new n.dwI},clearcoatNormalScale:{value:new n.I9Y(1,1)},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatRoughnessMapTransform:{value:new n.dwI},dispersion:{value:0},iridescence:{value:0},iridescenceMap:{value:null},iridescenceMapTransform:{value:new n.dwI},iridescenceIOR:{value:1.3},iridescenceThicknessMinimum:{value:100},iridescenceThicknessMaximum:{value:400},iridescenceThicknessMap:{value:null},iridescenceThicknessMapTransform:{value:new n.dwI},sheen:{value:0},sheenColor:{value:new n.Q1f(0)},sheenColorMap:{value:null},sheenColorMapTransform:{value:new n.dwI},sheenRoughness:{value:1},sheenRoughnessMap:{value:null},sheenRoughnessMapTransform:{value:new n.dwI},transmission:{value:0},transmissionMap:{value:null},transmissionMapTransform:{value:new n.dwI},transmissionSamplerSize:{value:new n.I9Y},transmissionSamplerMap:{value:null},thickness:{value:0},thicknessMap:{value:null},thicknessMapTransform:{value:new n.dwI},attenuationDistance:{value:0},attenuationColor:{value:new n.Q1f(0)},specularColor:{value:new n.Q1f(1,1,1)},specularColorMap:{value:null},specularColorMapTransform:{value:new n.dwI},specularIntensity:{value:1},specularIntensityMap:{value:null},specularIntensityMapTransform:{value:new n.dwI},anisotropyVector:{value:new n.I9Y},anisotropyMap:{value:null},anisotropyMapTransform:{value:new n.dwI}}]),vertexShader:o.meshphysical_vert,fragmentShader:o.meshphysical_frag};let h={r:0,b:0,g:0},u=new n.O9p,d=new n.kn4;function p(e,i,r,a,s,o,l){let p,f,m=new n.Q1f(0),g=+(!0!==o),v=null,_=0,y=null;function x(e){let n=!0===e.isScene?e.background:null;return n&&n.isTexture&&(n=(e.backgroundBlurriness>0?r:i).get(n)),n}function M(i,r){i.getRGB(h,(0,n._Ut)(e)),a.buffers.color.setClear(h.r,h.g,h.b,r,l)}return{getClearColor:function(){return m},setClearColor:function(e,i=1){m.set(e),M(m,g=i)},getClearAlpha:function(){return g},setClearAlpha:function(e){M(m,g=e)},render:function(i){let r=!1,n=x(i);null===n?M(m,g):n&&n.isColor&&(M(n,1),r=!0);let s=e.xr.getEnvironmentBlendMode();"additive"===s?a.buffers.color.setClear(0,0,0,1,l):"alpha-blend"===s&&a.buffers.color.setClear(0,0,0,0,l),(e.autoClear||r)&&(a.buffers.depth.setTest(!0),a.buffers.depth.setMask(!0),a.buffers.color.setMask(!0),e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil))},addToRenderList:function(i,r){let a=x(r);a&&(a.isCubeTexture||a.mapping===n.Om)?(void 0===f&&((f=new n.eaF(new n.iNn(1,1,1),new n.BKk({name:"BackgroundCubeMaterial",uniforms:(0,n.lxW)(c.backgroundCube.uniforms),vertexShader:c.backgroundCube.vertexShader,fragmentShader:c.backgroundCube.fragmentShader,side:n.hsX,depthTest:!1,depthWrite:!1,fog:!1,allowOverride:!1}))).geometry.deleteAttribute("normal"),f.geometry.deleteAttribute("uv"),f.onBeforeRender=function(e,i,r){this.matrixWorld.copyPosition(r.matrixWorld)},Object.defineProperty(f.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),s.update(f)),u.copy(r.backgroundRotation),u.x*=-1,u.y*=-1,u.z*=-1,a.isCubeTexture&&!1===a.isRenderTargetTexture&&(u.y*=-1,u.z*=-1),f.material.uniforms.envMap.value=a,f.material.uniforms.flipEnvMap.value=a.isCubeTexture&&!1===a.isRenderTargetTexture?-1:1,f.material.uniforms.backgroundBlurriness.value=r.backgroundBlurriness,f.material.uniforms.backgroundIntensity.value=r.backgroundIntensity,f.material.uniforms.backgroundRotation.value.setFromMatrix4(d.makeRotationFromEuler(u)),f.material.toneMapped=n.ppV.getTransfer(a.colorSpace)!==n.KLL,(v!==a||_!==a.version||y!==e.toneMapping)&&(f.material.needsUpdate=!0,v=a,_=a.version,y=e.toneMapping),f.layers.enableAll(),i.unshift(f,f.geometry,f.material,0,0,null)):a&&a.isTexture&&(void 0===p&&((p=new n.eaF(new n.bdM(2,2),new n.BKk({name:"BackgroundMaterial",uniforms:(0,n.lxW)(c.background.uniforms),vertexShader:c.background.vertexShader,fragmentShader:c.background.fragmentShader,side:n.hB5,depthTest:!1,depthWrite:!1,fog:!1,allowOverride:!1}))).geometry.deleteAttribute("normal"),Object.defineProperty(p.material,"map",{get:function(){return this.uniforms.t2D.value}}),s.update(p)),p.material.uniforms.t2D.value=a,p.material.uniforms.backgroundIntensity.value=r.backgroundIntensity,p.material.toneMapped=n.ppV.getTransfer(a.colorSpace)!==n.KLL,!0===a.matrixAutoUpdate&&a.updateMatrix(),p.material.uniforms.uvTransform.value.copy(a.matrix),(v!==a||_!==a.version||y!==e.toneMapping)&&(p.material.needsUpdate=!0,v=a,_=a.version,y=e.toneMapping),p.layers.enableAll(),i.unshift(p,p.geometry,p.material,0,0,null))},dispose:function(){void 0!==f&&(f.geometry.dispose(),f.material.dispose(),f=void 0),void 0!==p&&(p.geometry.dispose(),p.material.dispose(),p=void 0)}}}function f(e,i){let r=e.getParameter(e.MAX_VERTEX_ATTRIBS),a={},s=u(null),o=s,l=!1;function c(i){return e.bindVertexArray(i)}function h(i){return e.deleteVertexArray(i)}function u(e){let i=[],n=[],a=[];for(let e=0;e<r;e++)i[e]=0,n[e]=0,a[e]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:i,enabledAttributes:n,attributeDivisors:a,object:e,attributes:{},index:null}}function d(){let e=o.newAttributes;for(let i=0,r=e.length;i<r;i++)e[i]=0}function p(e){f(e,0)}function f(i,r){let n=o.newAttributes,a=o.enabledAttributes,s=o.attributeDivisors;n[i]=1,0===a[i]&&(e.enableVertexAttribArray(i),a[i]=1),s[i]!==r&&(e.vertexAttribDivisor(i,r),s[i]=r)}function m(){let i=o.newAttributes,r=o.enabledAttributes;for(let n=0,a=r.length;n<a;n++)r[n]!==i[n]&&(e.disableVertexAttribArray(n),r[n]=0)}function g(i,r,n,a,s,o,l){!0===l?e.vertexAttribIPointer(i,r,n,s,o):e.vertexAttribPointer(i,r,n,a,s,o)}function v(){_(),l=!0,o!==s&&c((o=s).object)}function _(){s.geometry=null,s.program=null,s.wireframe=!1}return{setup:function(r,s,h,v,_){var y,x;let M,S,b,T,E=!1,w=(y=v,x=h,M=!0===s.wireframe,void 0===(S=a[y.id])&&(S={},a[y.id]=S),void 0===(b=S[x.id])&&(b={},S[x.id]=b),void 0===(T=b[M])&&(T=u(e.createVertexArray()),b[M]=T),T);o!==w&&c((o=w).object),(E=function(e,i,r,n){let a=o.attributes,s=i.attributes,l=0,c=r.getAttributes();for(let i in c)if(c[i].location>=0){let r=a[i],n=s[i];if(void 0===n&&("instanceMatrix"===i&&e.instanceMatrix&&(n=e.instanceMatrix),"instanceColor"===i&&e.instanceColor&&(n=e.instanceColor)),void 0===r||r.attribute!==n||n&&r.data!==n.data)return!0;l++}return o.attributesNum!==l||o.index!==n}(r,v,h,_))&&function(e,i,r,n){let a={},s=i.attributes,l=0,c=r.getAttributes();for(let i in c)if(c[i].location>=0){let r=s[i];void 0===r&&("instanceMatrix"===i&&e.instanceMatrix&&(r=e.instanceMatrix),"instanceColor"===i&&e.instanceColor&&(r=e.instanceColor));let n={};n.attribute=r,r&&r.data&&(n.data=r.data),a[i]=n,l++}o.attributes=a,o.attributesNum=l,o.index=n}(r,v,h,_),null!==_&&i.update(_,e.ELEMENT_ARRAY_BUFFER),(E||l)&&(l=!1,function(r,a,s,o){d();let l=o.attributes,c=s.getAttributes(),h=a.defaultAttributeValues;for(let a in c){let s=c[a];if(s.location>=0){let c=l[a];if(void 0===c&&("instanceMatrix"===a&&r.instanceMatrix&&(c=r.instanceMatrix),"instanceColor"===a&&r.instanceColor&&(c=r.instanceColor)),void 0!==c){let a=c.normalized,l=c.itemSize,h=i.get(c);if(void 0===h)continue;let u=h.buffer,d=h.type,m=h.bytesPerElement,v=d===e.INT||d===e.UNSIGNED_INT||c.gpuType===n.Yuy;if(c.isInterleavedBufferAttribute){let i=c.data,n=i.stride,h=c.offset;if(i.isInstancedInterleavedBuffer){for(let e=0;e<s.locationSize;e++)f(s.location+e,i.meshPerAttribute);!0!==r.isInstancedMesh&&void 0===o._maxInstanceCount&&(o._maxInstanceCount=i.meshPerAttribute*i.count)}else for(let e=0;e<s.locationSize;e++)p(s.location+e);e.bindBuffer(e.ARRAY_BUFFER,u);for(let e=0;e<s.locationSize;e++)g(s.location+e,l/s.locationSize,d,a,n*m,(h+l/s.locationSize*e)*m,v)}else{if(c.isInstancedBufferAttribute){for(let e=0;e<s.locationSize;e++)f(s.location+e,c.meshPerAttribute);!0!==r.isInstancedMesh&&void 0===o._maxInstanceCount&&(o._maxInstanceCount=c.meshPerAttribute*c.count)}else for(let e=0;e<s.locationSize;e++)p(s.location+e);e.bindBuffer(e.ARRAY_BUFFER,u);for(let e=0;e<s.locationSize;e++)g(s.location+e,l/s.locationSize,d,a,l*m,l/s.locationSize*e*m,v)}}else if(void 0!==h){let i=h[a];if(void 0!==i)switch(i.length){case 2:e.vertexAttrib2fv(s.location,i);break;case 3:e.vertexAttrib3fv(s.location,i);break;case 4:e.vertexAttrib4fv(s.location,i);break;default:e.vertexAttrib1fv(s.location,i)}}}}m()}(r,s,h,v),null!==_&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,i.get(_).buffer))},reset:v,resetDefaultState:_,dispose:function(){for(let e in v(),a){let i=a[e];for(let e in i){let r=i[e];for(let e in r)h(r[e].object),delete r[e];delete i[e]}delete a[e]}},releaseStatesOfGeometry:function(e){if(void 0===a[e.id])return;let i=a[e.id];for(let e in i){let r=i[e];for(let e in r)h(r[e].object),delete r[e];delete i[e]}delete a[e.id]},releaseStatesOfProgram:function(e){for(let i in a){let r=a[i];if(void 0===r[e.id])continue;let n=r[e.id];for(let e in n)h(n[e].object),delete n[e];delete r[e.id]}},initAttributes:d,enableAttribute:p,disableUnusedAttributes:m}}function m(e,i,r){let n;function a(i,a,s){0!==s&&(e.drawArraysInstanced(n,i,a,s),r.update(a,n,s))}this.setMode=function(e){n=e},this.render=function(i,a){e.drawArrays(n,i,a),r.update(a,n,1)},this.renderInstances=a,this.renderMultiDraw=function(e,a,s){if(0===s)return;i.get("WEBGL_multi_draw").multiDrawArraysWEBGL(n,e,0,a,0,s);let o=0;for(let e=0;e<s;e++)o+=a[e];r.update(o,n,1)},this.renderMultiDrawInstances=function(e,s,o,l){if(0===o)return;let c=i.get("WEBGL_multi_draw");if(null===c)for(let i=0;i<e.length;i++)a(e[i],s[i],l[i]);else{c.multiDrawArraysInstancedWEBGL(n,e,0,s,0,l,0,o);let i=0;for(let e=0;e<o;e++)i+=s[e]*l[e];r.update(i,n,1)}}}function g(e,i,r,a){let s;function o(i){if("highp"===i){if(e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0)return"highp";i="mediump"}return"mediump"===i&&e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}let l=void 0!==r.precision?r.precision:"highp",c=o(l);return c!==l&&((0,n.R8M)("WebGLRenderer:",l,"not supported, using",c,"instead."),l=c),{isWebGL2:!0,getMaxAnisotropy:function(){if(void 0!==s)return s;if(!0===i.has("EXT_texture_filter_anisotropic")){let r=i.get("EXT_texture_filter_anisotropic");s=e.getParameter(r.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else s=0;return s},getMaxPrecision:o,textureFormatReadable:function(i){return i===n.GWd||a.convert(i)===e.getParameter(e.IMPLEMENTATION_COLOR_READ_FORMAT)},textureTypeReadable:function(r){let s=r===n.ix0&&(i.has("EXT_color_buffer_half_float")||i.has("EXT_color_buffer_float"));return r===n.OUM||a.convert(r)===e.getParameter(e.IMPLEMENTATION_COLOR_READ_TYPE)||r===n.RQf||!!s},precision:l,logarithmicDepthBuffer:!0===r.logarithmicDepthBuffer,reversedDepthBuffer:!0===r.reversedDepthBuffer&&i.has("EXT_clip_control"),maxTextures:e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),maxVertexTextures:e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:e.getParameter(e.MAX_TEXTURE_SIZE),maxCubemapSize:e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),maxAttributes:e.getParameter(e.MAX_VERTEX_ATTRIBS),maxVertexUniforms:e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),maxVaryings:e.getParameter(e.MAX_VARYING_VECTORS),maxFragmentUniforms:e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),maxSamples:e.getParameter(e.MAX_SAMPLES),samples:e.getParameter(e.SAMPLES)}}function v(e){let i=this,r=null,a=0,s=!1,o=!1,l=new n.Zcv,c=new n.dwI,h={value:null,needsUpdate:!1};function u(e,r,n,a){let s=null!==e?e.length:0,o=null;if(0!==s){if(o=h.value,!0!==a||null===o){let i=n+4*s,a=r.matrixWorldInverse;c.getNormalMatrix(a),(null===o||o.length<i)&&(o=new Float32Array(i));for(let i=0,r=n;i!==s;++i,r+=4)l.copy(e[i]).applyMatrix4(a,c),l.normal.toArray(o,r),o[r+3]=l.constant}h.value=o,h.needsUpdate=!0}return i.numPlanes=s,i.numIntersection=0,o}this.uniform=h,this.numPlanes=0,this.numIntersection=0,this.init=function(e,i){let r=0!==e.length||i||0!==a||s;return s=i,a=e.length,r},this.beginShadows=function(){o=!0,u(null)},this.endShadows=function(){o=!1},this.setGlobalState=function(e,i){r=u(e,i,0)},this.setState=function(n,l,c){let d=n.clippingPlanes,p=n.clipIntersection,f=n.clipShadows,m=e.get(n);if(s&&null!==d&&0!==d.length&&(!o||f)){let e=o?0:a,i=4*e,n=m.clippingState||null;h.value=n,n=u(d,l,i,c);for(let e=0;e!==i;++e)n[e]=r[e];m.clippingState=n,this.numIntersection=p?this.numPlanes:0,this.numPlanes+=e}else o?u(null):(h.value!==r&&(h.value=r,h.needsUpdate=a>0),i.numPlanes=a,i.numIntersection=0)}}function _(e){let i=new WeakMap;function r(e,i){return i===n.wfO?e.mapping=n.hy7:i===n.uV5&&(e.mapping=n.xFO),e}function a(e){let r=e.target;r.removeEventListener("dispose",a);let n=i.get(r);void 0!==n&&(i.delete(r),n.dispose())}return{get:function(s){if(s&&s.isTexture){let o=s.mapping;if(o===n.wfO||o===n.uV5)if(i.has(s))return r(i.get(s).texture,s.mapping);else{let o=s.image;if(!o||!(o.height>0))return null;{let l=new n.o6l(o.height);return l.fromEquirectangularTexture(e,s),i.set(s,l),s.addEventListener("dispose",a),r(l.texture,s.mapping)}}}return s},dispose:function(){i=new WeakMap}}}let y=[.125,.215,.35,.446,.526,.582],x=new n.qUd,M=new n.Q1f,S=null,b=0,T=0,E=!1,w=new n.Pq0;class A{constructor(e){this._renderer=e,this._pingPongRenderTarget=null,this._lodMax=0,this._cubeSize=0,this._sizeLods=[],this._sigmas=[],this._lodMeshes=[],this._backgroundBox=null,this._cubemapMaterial=null,this._equirectMaterial=null,this._blurMaterial=null,this._ggxMaterial=null}fromScene(e,i=0,r=.1,n=100,a={}){let{size:s=256,position:o=w}=a;S=this._renderer.getRenderTarget(),b=this._renderer.getActiveCubeFace(),T=this._renderer.getActiveMipmapLevel(),E=this._renderer.xr.enabled,this._renderer.xr.enabled=!1,this._setSize(s);let l=this._allocateTargets();return l.depthBuffer=!0,this._sceneToCubeUV(e,r,n,l,o),i>0&&this._blur(l,0,0,i),this._applyPMREM(l),this._cleanup(l),l}fromEquirectangular(e,i=null){return this._fromTexture(e,i)}fromCubemap(e,i=null){return this._fromTexture(e,i)}compileCubemapShader(){null===this._cubemapMaterial&&(this._cubemapMaterial=I(),this._compileMaterial(this._cubemapMaterial))}compileEquirectangularShader(){null===this._equirectMaterial&&(this._equirectMaterial=P(),this._compileMaterial(this._equirectMaterial))}dispose(){this._dispose(),null!==this._cubemapMaterial&&this._cubemapMaterial.dispose(),null!==this._equirectMaterial&&this._equirectMaterial.dispose(),null!==this._backgroundBox&&(this._backgroundBox.geometry.dispose(),this._backgroundBox.material.dispose())}_setSize(e){this._lodMax=Math.floor(Math.log2(e)),this._cubeSize=Math.pow(2,this._lodMax)}_dispose(){null!==this._blurMaterial&&this._blurMaterial.dispose(),null!==this._ggxMaterial&&this._ggxMaterial.dispose(),null!==this._pingPongRenderTarget&&this._pingPongRenderTarget.dispose();for(let e=0;e<this._lodMeshes.length;e++)this._lodMeshes[e].geometry.dispose()}_cleanup(e){this._renderer.setRenderTarget(S,b,T),this._renderer.xr.enabled=E,e.scissorTest=!1,C(e,0,0,e.width,e.height)}_fromTexture(e,i){e.mapping===n.hy7||e.mapping===n.xFO?this._setSize(0===e.image.length?16:e.image[0].width||e.image[0].image.width):this._setSize(e.image.width/4),S=this._renderer.getRenderTarget(),b=this._renderer.getActiveCubeFace(),T=this._renderer.getActiveMipmapLevel(),E=this._renderer.xr.enabled,this._renderer.xr.enabled=!1;let r=i||this._allocateTargets();return this._textureToCubeUV(e,r),this._applyPMREM(r),this._cleanup(r),r}_allocateTargets(){let e=3*Math.max(this._cubeSize,112),i=4*this._cubeSize,r={magFilter:n.k6q,minFilter:n.k6q,generateMipmaps:!1,type:n.ix0,format:n.GWd,colorSpace:n.Zr2,depthBuffer:!1},a=R(e,i,r);if(null===this._pingPongRenderTarget||this._pingPongRenderTarget.width!==e||this._pingPongRenderTarget.height!==i){var s,o,l,c,h,u;let a,d;null!==this._pingPongRenderTarget&&this._dispose(),this._pingPongRenderTarget=R(e,i,r);let{_lodMax:p}=this;({lodMeshes:this._lodMeshes,sizeLods:this._sizeLods,sigmas:this._sigmas}=function(e){let i=[],r=[],a=[],s=e,o=e-4+1+y.length;for(let l=0;l<o;l++){let o=Math.pow(2,s);i.push(o);let c=1/o;l>e-4?c=y[l-e+4-1]:0===l&&(c=0),r.push(c);let h=1/(o-2),u=-h,d=1+h,p=[u,u,d,u,d,d,u,u,d,d,u,d],f=new Float32Array(108),m=new Float32Array(72),g=new Float32Array(36);for(let e=0;e<6;e++){let i=e%3*2/3-1,r=e>2?0:-1,n=[i,r,0,i+2/3,r,0,i+2/3,r+1,0,i,r,0,i+2/3,r+1,0,i,r+1,0];f.set(n,18*e),m.set(p,12*e);let a=[e,e,e,e,e,e];g.set(a,6*e)}let v=new n.LoY;v.setAttribute("position",new n.THS(f,3)),v.setAttribute("uv",new n.THS(m,2)),v.setAttribute("faceIndex",new n.THS(g,1)),a.push(new n.eaF(v,null)),s>4&&s--}return{lodMeshes:a,sizeLods:i,sigmas:r}}(p)),this._blurMaterial=(s=p,o=e,l=i,a=new Float32Array(20),d=new n.Pq0(0,1,0),new n.BKk({name:"SphericalGaussianBlur",defines:{n:20,CUBEUV_TEXEL_WIDTH:1/o,CUBEUV_TEXEL_HEIGHT:1/l,CUBEUV_MAX_MIP:`${s}.0`},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:a},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:d}},vertexShader:L(),fragmentShader:`
+}`},l={common:{diffuse:{value:new n.Q1f(0xffffff)},opacity:{value:1},map:{value:null},mapTransform:{value:new n.dwI},alphaMap:{value:null},alphaMapTransform:{value:new n.dwI},alphaTest:{value:0}},specularmap:{specularMap:{value:null},specularMapTransform:{value:new n.dwI}},envmap:{envMap:{value:null},envMapRotation:{value:new n.dwI},flipEnvMap:{value:-1},reflectivity:{value:1},ior:{value:1.5},refractionRatio:{value:.98},dfgLUT:{value:null}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1},aoMapTransform:{value:new n.dwI}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1},lightMapTransform:{value:new n.dwI}},bumpmap:{bumpMap:{value:null},bumpMapTransform:{value:new n.dwI},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalMapTransform:{value:new n.dwI},normalScale:{value:new n.I9Y(1,1)}},displacementmap:{displacementMap:{value:null},displacementMapTransform:{value:new n.dwI},displacementScale:{value:1},displacementBias:{value:0}},emissivemap:{emissiveMap:{value:null},emissiveMapTransform:{value:new n.dwI}},metalnessmap:{metalnessMap:{value:null},metalnessMapTransform:{value:new n.dwI}},roughnessmap:{roughnessMap:{value:null},roughnessMapTransform:{value:new n.dwI}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new n.Q1f(0xffffff)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotLightMap:{value:[]},spotShadowMap:{value:[]},spotLightMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new n.Q1f(0xffffff)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},alphaMapTransform:{value:new n.dwI},alphaTest:{value:0},uvTransform:{value:new n.dwI}},sprite:{diffuse:{value:new n.Q1f(0xffffff)},opacity:{value:1},center:{value:new n.I9Y(.5,.5)},rotation:{value:0},map:{value:null},mapTransform:{value:new n.dwI},alphaMap:{value:null},alphaMapTransform:{value:new n.dwI},alphaTest:{value:0}}},c={basic:{uniforms:(0,n.Iit)([l.common,l.specularmap,l.envmap,l.aomap,l.lightmap,l.fog]),vertexShader:o.meshbasic_vert,fragmentShader:o.meshbasic_frag},lambert:{uniforms:(0,n.Iit)([l.common,l.specularmap,l.envmap,l.aomap,l.lightmap,l.emissivemap,l.bumpmap,l.normalmap,l.displacementmap,l.fog,l.lights,{emissive:{value:new n.Q1f(0)}}]),vertexShader:o.meshlambert_vert,fragmentShader:o.meshlambert_frag},phong:{uniforms:(0,n.Iit)([l.common,l.specularmap,l.envmap,l.aomap,l.lightmap,l.emissivemap,l.bumpmap,l.normalmap,l.displacementmap,l.fog,l.lights,{emissive:{value:new n.Q1f(0)},specular:{value:new n.Q1f(1118481)},shininess:{value:30}}]),vertexShader:o.meshphong_vert,fragmentShader:o.meshphong_frag},standard:{uniforms:(0,n.Iit)([l.common,l.envmap,l.aomap,l.lightmap,l.emissivemap,l.bumpmap,l.normalmap,l.displacementmap,l.roughnessmap,l.metalnessmap,l.fog,l.lights,{emissive:{value:new n.Q1f(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:o.meshphysical_vert,fragmentShader:o.meshphysical_frag},toon:{uniforms:(0,n.Iit)([l.common,l.aomap,l.lightmap,l.emissivemap,l.bumpmap,l.normalmap,l.displacementmap,l.gradientmap,l.fog,l.lights,{emissive:{value:new n.Q1f(0)}}]),vertexShader:o.meshtoon_vert,fragmentShader:o.meshtoon_frag},matcap:{uniforms:(0,n.Iit)([l.common,l.bumpmap,l.normalmap,l.displacementmap,l.fog,{matcap:{value:null}}]),vertexShader:o.meshmatcap_vert,fragmentShader:o.meshmatcap_frag},points:{uniforms:(0,n.Iit)([l.points,l.fog]),vertexShader:o.points_vert,fragmentShader:o.points_frag},dashed:{uniforms:(0,n.Iit)([l.common,l.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:o.linedashed_vert,fragmentShader:o.linedashed_frag},depth:{uniforms:(0,n.Iit)([l.common,l.displacementmap]),vertexShader:o.depth_vert,fragmentShader:o.depth_frag},normal:{uniforms:(0,n.Iit)([l.common,l.bumpmap,l.normalmap,l.displacementmap,{opacity:{value:1}}]),vertexShader:o.meshnormal_vert,fragmentShader:o.meshnormal_frag},sprite:{uniforms:(0,n.Iit)([l.sprite,l.fog]),vertexShader:o.sprite_vert,fragmentShader:o.sprite_frag},background:{uniforms:{uvTransform:{value:new n.dwI},t2D:{value:null},backgroundIntensity:{value:1}},vertexShader:o.background_vert,fragmentShader:o.background_frag},backgroundCube:{uniforms:{envMap:{value:null},flipEnvMap:{value:-1},backgroundBlurriness:{value:0},backgroundIntensity:{value:1},backgroundRotation:{value:new n.dwI}},vertexShader:o.backgroundCube_vert,fragmentShader:o.backgroundCube_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:o.cube_vert,fragmentShader:o.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:o.equirect_vert,fragmentShader:o.equirect_frag},distance:{uniforms:(0,n.Iit)([l.common,l.displacementmap,{referencePosition:{value:new n.Pq0},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:o.distance_vert,fragmentShader:o.distance_frag},shadow:{uniforms:(0,n.Iit)([l.lights,l.fog,{color:{value:new n.Q1f(0)},opacity:{value:1}}]),vertexShader:o.shadow_vert,fragmentShader:o.shadow_frag}};c.physical={uniforms:(0,n.Iit)([c.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatMapTransform:{value:new n.dwI},clearcoatNormalMap:{value:null},clearcoatNormalMapTransform:{value:new n.dwI},clearcoatNormalScale:{value:new n.I9Y(1,1)},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatRoughnessMapTransform:{value:new n.dwI},dispersion:{value:0},iridescence:{value:0},iridescenceMap:{value:null},iridescenceMapTransform:{value:new n.dwI},iridescenceIOR:{value:1.3},iridescenceThicknessMinimum:{value:100},iridescenceThicknessMaximum:{value:400},iridescenceThicknessMap:{value:null},iridescenceThicknessMapTransform:{value:new n.dwI},sheen:{value:0},sheenColor:{value:new n.Q1f(0)},sheenColorMap:{value:null},sheenColorMapTransform:{value:new n.dwI},sheenRoughness:{value:1},sheenRoughnessMap:{value:null},sheenRoughnessMapTransform:{value:new n.dwI},transmission:{value:0},transmissionMap:{value:null},transmissionMapTransform:{value:new n.dwI},transmissionSamplerSize:{value:new n.I9Y},transmissionSamplerMap:{value:null},thickness:{value:0},thicknessMap:{value:null},thicknessMapTransform:{value:new n.dwI},attenuationDistance:{value:0},attenuationColor:{value:new n.Q1f(0)},specularColor:{value:new n.Q1f(1,1,1)},specularColorMap:{value:null},specularColorMapTransform:{value:new n.dwI},specularIntensity:{value:1},specularIntensityMap:{value:null},specularIntensityMapTransform:{value:new n.dwI},anisotropyVector:{value:new n.I9Y},anisotropyMap:{value:null},anisotropyMapTransform:{value:new n.dwI}}]),vertexShader:o.meshphysical_vert,fragmentShader:o.meshphysical_frag};let h={r:0,b:0,g:0},u=new n.O9p,d=new n.kn4;function p(e,i,r,a,s,o,l){let p,f,m=new n.Q1f(0),g=+(!0!==o),v=null,_=0,x=null;function y(e){let n=!0===e.isScene?e.background:null;return n&&n.isTexture&&(n=(e.backgroundBlurriness>0?r:i).get(n)),n}function M(i,r){i.getRGB(h,(0,n._Ut)(e)),a.buffers.color.setClear(h.r,h.g,h.b,r,l)}return{getClearColor:function(){return m},setClearColor:function(e,i=1){m.set(e),M(m,g=i)},getClearAlpha:function(){return g},setClearAlpha:function(e){M(m,g=e)},render:function(i){let r=!1,n=y(i);null===n?M(m,g):n&&n.isColor&&(M(n,1),r=!0);let s=e.xr.getEnvironmentBlendMode();"additive"===s?a.buffers.color.setClear(0,0,0,1,l):"alpha-blend"===s&&a.buffers.color.setClear(0,0,0,0,l),(e.autoClear||r)&&(a.buffers.depth.setTest(!0),a.buffers.depth.setMask(!0),a.buffers.color.setMask(!0),e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil))},addToRenderList:function(i,r){let a=y(r);a&&(a.isCubeTexture||a.mapping===n.Om)?(void 0===f&&((f=new n.eaF(new n.iNn(1,1,1),new n.BKk({name:"BackgroundCubeMaterial",uniforms:(0,n.lxW)(c.backgroundCube.uniforms),vertexShader:c.backgroundCube.vertexShader,fragmentShader:c.backgroundCube.fragmentShader,side:n.hsX,depthTest:!1,depthWrite:!1,fog:!1,allowOverride:!1}))).geometry.deleteAttribute("normal"),f.geometry.deleteAttribute("uv"),f.onBeforeRender=function(e,i,r){this.matrixWorld.copyPosition(r.matrixWorld)},Object.defineProperty(f.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),s.update(f)),u.copy(r.backgroundRotation),u.x*=-1,u.y*=-1,u.z*=-1,a.isCubeTexture&&!1===a.isRenderTargetTexture&&(u.y*=-1,u.z*=-1),f.material.uniforms.envMap.value=a,f.material.uniforms.flipEnvMap.value=a.isCubeTexture&&!1===a.isRenderTargetTexture?-1:1,f.material.uniforms.backgroundBlurriness.value=r.backgroundBlurriness,f.material.uniforms.backgroundIntensity.value=r.backgroundIntensity,f.material.uniforms.backgroundRotation.value.setFromMatrix4(d.makeRotationFromEuler(u)),f.material.toneMapped=n.ppV.getTransfer(a.colorSpace)!==n.KLL,(v!==a||_!==a.version||x!==e.toneMapping)&&(f.material.needsUpdate=!0,v=a,_=a.version,x=e.toneMapping),f.layers.enableAll(),i.unshift(f,f.geometry,f.material,0,0,null)):a&&a.isTexture&&(void 0===p&&((p=new n.eaF(new n.bdM(2,2),new n.BKk({name:"BackgroundMaterial",uniforms:(0,n.lxW)(c.background.uniforms),vertexShader:c.background.vertexShader,fragmentShader:c.background.fragmentShader,side:n.hB5,depthTest:!1,depthWrite:!1,fog:!1,allowOverride:!1}))).geometry.deleteAttribute("normal"),Object.defineProperty(p.material,"map",{get:function(){return this.uniforms.t2D.value}}),s.update(p)),p.material.uniforms.t2D.value=a,p.material.uniforms.backgroundIntensity.value=r.backgroundIntensity,p.material.toneMapped=n.ppV.getTransfer(a.colorSpace)!==n.KLL,!0===a.matrixAutoUpdate&&a.updateMatrix(),p.material.uniforms.uvTransform.value.copy(a.matrix),(v!==a||_!==a.version||x!==e.toneMapping)&&(p.material.needsUpdate=!0,v=a,_=a.version,x=e.toneMapping),p.layers.enableAll(),i.unshift(p,p.geometry,p.material,0,0,null))},dispose:function(){void 0!==f&&(f.geometry.dispose(),f.material.dispose(),f=void 0),void 0!==p&&(p.geometry.dispose(),p.material.dispose(),p=void 0)}}}function f(e,i){let r=e.getParameter(e.MAX_VERTEX_ATTRIBS),a={},s=u(null),o=s,l=!1;function c(i){return e.bindVertexArray(i)}function h(i){return e.deleteVertexArray(i)}function u(e){let i=[],n=[],a=[];for(let e=0;e<r;e++)i[e]=0,n[e]=0,a[e]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:i,enabledAttributes:n,attributeDivisors:a,object:e,attributes:{},index:null}}function d(){let e=o.newAttributes;for(let i=0,r=e.length;i<r;i++)e[i]=0}function p(e){f(e,0)}function f(i,r){let n=o.newAttributes,a=o.enabledAttributes,s=o.attributeDivisors;n[i]=1,0===a[i]&&(e.enableVertexAttribArray(i),a[i]=1),s[i]!==r&&(e.vertexAttribDivisor(i,r),s[i]=r)}function m(){let i=o.newAttributes,r=o.enabledAttributes;for(let n=0,a=r.length;n<a;n++)r[n]!==i[n]&&(e.disableVertexAttribArray(n),r[n]=0)}function g(i,r,n,a,s,o,l){!0===l?e.vertexAttribIPointer(i,r,n,s,o):e.vertexAttribPointer(i,r,n,a,s,o)}function v(){_(),l=!0,o!==s&&c((o=s).object)}function _(){s.geometry=null,s.program=null,s.wireframe=!1}return{setup:function(r,s,h,v,_){var x,y;let M,S,b,T,E=!1,w=(x=v,y=h,M=!0===s.wireframe,void 0===(S=a[x.id])&&(S={},a[x.id]=S),void 0===(b=S[y.id])&&(b={},S[y.id]=b),void 0===(T=b[M])&&(T=u(e.createVertexArray()),b[M]=T),T);o!==w&&c((o=w).object),(E=function(e,i,r,n){let a=o.attributes,s=i.attributes,l=0,c=r.getAttributes();for(let i in c)if(c[i].location>=0){let r=a[i],n=s[i];if(void 0===n&&("instanceMatrix"===i&&e.instanceMatrix&&(n=e.instanceMatrix),"instanceColor"===i&&e.instanceColor&&(n=e.instanceColor)),void 0===r||r.attribute!==n||n&&r.data!==n.data)return!0;l++}return o.attributesNum!==l||o.index!==n}(r,v,h,_))&&function(e,i,r,n){let a={},s=i.attributes,l=0,c=r.getAttributes();for(let i in c)if(c[i].location>=0){let r=s[i];void 0===r&&("instanceMatrix"===i&&e.instanceMatrix&&(r=e.instanceMatrix),"instanceColor"===i&&e.instanceColor&&(r=e.instanceColor));let n={};n.attribute=r,r&&r.data&&(n.data=r.data),a[i]=n,l++}o.attributes=a,o.attributesNum=l,o.index=n}(r,v,h,_),null!==_&&i.update(_,e.ELEMENT_ARRAY_BUFFER),(E||l)&&(l=!1,function(r,a,s,o){d();let l=o.attributes,c=s.getAttributes(),h=a.defaultAttributeValues;for(let a in c){let s=c[a];if(s.location>=0){let c=l[a];if(void 0===c&&("instanceMatrix"===a&&r.instanceMatrix&&(c=r.instanceMatrix),"instanceColor"===a&&r.instanceColor&&(c=r.instanceColor)),void 0!==c){let a=c.normalized,l=c.itemSize,h=i.get(c);if(void 0===h)continue;let u=h.buffer,d=h.type,m=h.bytesPerElement,v=d===e.INT||d===e.UNSIGNED_INT||c.gpuType===n.Yuy;if(c.isInterleavedBufferAttribute){let i=c.data,n=i.stride,h=c.offset;if(i.isInstancedInterleavedBuffer){for(let e=0;e<s.locationSize;e++)f(s.location+e,i.meshPerAttribute);!0!==r.isInstancedMesh&&void 0===o._maxInstanceCount&&(o._maxInstanceCount=i.meshPerAttribute*i.count)}else for(let e=0;e<s.locationSize;e++)p(s.location+e);e.bindBuffer(e.ARRAY_BUFFER,u);for(let e=0;e<s.locationSize;e++)g(s.location+e,l/s.locationSize,d,a,n*m,(h+l/s.locationSize*e)*m,v)}else{if(c.isInstancedBufferAttribute){for(let e=0;e<s.locationSize;e++)f(s.location+e,c.meshPerAttribute);!0!==r.isInstancedMesh&&void 0===o._maxInstanceCount&&(o._maxInstanceCount=c.meshPerAttribute*c.count)}else for(let e=0;e<s.locationSize;e++)p(s.location+e);e.bindBuffer(e.ARRAY_BUFFER,u);for(let e=0;e<s.locationSize;e++)g(s.location+e,l/s.locationSize,d,a,l*m,l/s.locationSize*e*m,v)}}else if(void 0!==h){let i=h[a];if(void 0!==i)switch(i.length){case 2:e.vertexAttrib2fv(s.location,i);break;case 3:e.vertexAttrib3fv(s.location,i);break;case 4:e.vertexAttrib4fv(s.location,i);break;default:e.vertexAttrib1fv(s.location,i)}}}}m()}(r,s,h,v),null!==_&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,i.get(_).buffer))},reset:v,resetDefaultState:_,dispose:function(){for(let e in v(),a){let i=a[e];for(let e in i){let r=i[e];for(let e in r)h(r[e].object),delete r[e];delete i[e]}delete a[e]}},releaseStatesOfGeometry:function(e){if(void 0===a[e.id])return;let i=a[e.id];for(let e in i){let r=i[e];for(let e in r)h(r[e].object),delete r[e];delete i[e]}delete a[e.id]},releaseStatesOfProgram:function(e){for(let i in a){let r=a[i];if(void 0===r[e.id])continue;let n=r[e.id];for(let e in n)h(n[e].object),delete n[e];delete r[e.id]}},initAttributes:d,enableAttribute:p,disableUnusedAttributes:m}}function m(e,i,r){let n;function a(i,a,s){0!==s&&(e.drawArraysInstanced(n,i,a,s),r.update(a,n,s))}this.setMode=function(e){n=e},this.render=function(i,a){e.drawArrays(n,i,a),r.update(a,n,1)},this.renderInstances=a,this.renderMultiDraw=function(e,a,s){if(0===s)return;i.get("WEBGL_multi_draw").multiDrawArraysWEBGL(n,e,0,a,0,s);let o=0;for(let e=0;e<s;e++)o+=a[e];r.update(o,n,1)},this.renderMultiDrawInstances=function(e,s,o,l){if(0===o)return;let c=i.get("WEBGL_multi_draw");if(null===c)for(let i=0;i<e.length;i++)a(e[i],s[i],l[i]);else{c.multiDrawArraysInstancedWEBGL(n,e,0,s,0,l,0,o);let i=0;for(let e=0;e<o;e++)i+=s[e]*l[e];r.update(i,n,1)}}}function g(e,i,r,a){let s;function o(i){if("highp"===i){if(e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0)return"highp";i="mediump"}return"mediump"===i&&e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}let l=void 0!==r.precision?r.precision:"highp",c=o(l);return c!==l&&((0,n.R8M)("WebGLRenderer:",l,"not supported, using",c,"instead."),l=c),{isWebGL2:!0,getMaxAnisotropy:function(){if(void 0!==s)return s;if(!0===i.has("EXT_texture_filter_anisotropic")){let r=i.get("EXT_texture_filter_anisotropic");s=e.getParameter(r.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else s=0;return s},getMaxPrecision:o,textureFormatReadable:function(i){return i===n.GWd||a.convert(i)===e.getParameter(e.IMPLEMENTATION_COLOR_READ_FORMAT)},textureTypeReadable:function(r){let s=r===n.ix0&&(i.has("EXT_color_buffer_half_float")||i.has("EXT_color_buffer_float"));return r===n.OUM||a.convert(r)===e.getParameter(e.IMPLEMENTATION_COLOR_READ_TYPE)||r===n.RQf||!!s},precision:l,logarithmicDepthBuffer:!0===r.logarithmicDepthBuffer,reversedDepthBuffer:!0===r.reversedDepthBuffer&&i.has("EXT_clip_control"),maxTextures:e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),maxVertexTextures:e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:e.getParameter(e.MAX_TEXTURE_SIZE),maxCubemapSize:e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),maxAttributes:e.getParameter(e.MAX_VERTEX_ATTRIBS),maxVertexUniforms:e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),maxVaryings:e.getParameter(e.MAX_VARYING_VECTORS),maxFragmentUniforms:e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),maxSamples:e.getParameter(e.MAX_SAMPLES),samples:e.getParameter(e.SAMPLES)}}function v(e){let i=this,r=null,a=0,s=!1,o=!1,l=new n.Zcv,c=new n.dwI,h={value:null,needsUpdate:!1};function u(e,r,n,a){let s=null!==e?e.length:0,o=null;if(0!==s){if(o=h.value,!0!==a||null===o){let i=n+4*s,a=r.matrixWorldInverse;c.getNormalMatrix(a),(null===o||o.length<i)&&(o=new Float32Array(i));for(let i=0,r=n;i!==s;++i,r+=4)l.copy(e[i]).applyMatrix4(a,c),l.normal.toArray(o,r),o[r+3]=l.constant}h.value=o,h.needsUpdate=!0}return i.numPlanes=s,i.numIntersection=0,o}this.uniform=h,this.numPlanes=0,this.numIntersection=0,this.init=function(e,i){let r=0!==e.length||i||0!==a||s;return s=i,a=e.length,r},this.beginShadows=function(){o=!0,u(null)},this.endShadows=function(){o=!1},this.setGlobalState=function(e,i){r=u(e,i,0)},this.setState=function(n,l,c){let d=n.clippingPlanes,p=n.clipIntersection,f=n.clipShadows,m=e.get(n);if(s&&null!==d&&0!==d.length&&(!o||f)){let e=o?0:a,i=4*e,n=m.clippingState||null;h.value=n,n=u(d,l,i,c);for(let e=0;e!==i;++e)n[e]=r[e];m.clippingState=n,this.numIntersection=p?this.numPlanes:0,this.numPlanes+=e}else o?u(null):(h.value!==r&&(h.value=r,h.needsUpdate=a>0),i.numPlanes=a,i.numIntersection=0)}}function _(e){let i=new WeakMap;function r(e,i){return i===n.wfO?e.mapping=n.hy7:i===n.uV5&&(e.mapping=n.xFO),e}function a(e){let r=e.target;r.removeEventListener("dispose",a);let n=i.get(r);void 0!==n&&(i.delete(r),n.dispose())}return{get:function(s){if(s&&s.isTexture){let o=s.mapping;if(o===n.wfO||o===n.uV5)if(i.has(s))return r(i.get(s).texture,s.mapping);else{let o=s.image;if(!o||!(o.height>0))return null;{let l=new n.o6l(o.height);return l.fromEquirectangularTexture(e,s),i.set(s,l),s.addEventListener("dispose",a),r(l.texture,s.mapping)}}}return s},dispose:function(){i=new WeakMap}}}let x=[.125,.215,.35,.446,.526,.582],y=new n.qUd,M=new n.Q1f,S=null,b=0,T=0,E=!1,w=new n.Pq0;class A{constructor(e){this._renderer=e,this._pingPongRenderTarget=null,this._lodMax=0,this._cubeSize=0,this._sizeLods=[],this._sigmas=[],this._lodMeshes=[],this._backgroundBox=null,this._cubemapMaterial=null,this._equirectMaterial=null,this._blurMaterial=null,this._ggxMaterial=null}fromScene(e,i=0,r=.1,n=100,a={}){let{size:s=256,position:o=w}=a;S=this._renderer.getRenderTarget(),b=this._renderer.getActiveCubeFace(),T=this._renderer.getActiveMipmapLevel(),E=this._renderer.xr.enabled,this._renderer.xr.enabled=!1,this._setSize(s);let l=this._allocateTargets();return l.depthBuffer=!0,this._sceneToCubeUV(e,r,n,l,o),i>0&&this._blur(l,0,0,i),this._applyPMREM(l),this._cleanup(l),l}fromEquirectangular(e,i=null){return this._fromTexture(e,i)}fromCubemap(e,i=null){return this._fromTexture(e,i)}compileCubemapShader(){null===this._cubemapMaterial&&(this._cubemapMaterial=I(),this._compileMaterial(this._cubemapMaterial))}compileEquirectangularShader(){null===this._equirectMaterial&&(this._equirectMaterial=P(),this._compileMaterial(this._equirectMaterial))}dispose(){this._dispose(),null!==this._cubemapMaterial&&this._cubemapMaterial.dispose(),null!==this._equirectMaterial&&this._equirectMaterial.dispose(),null!==this._backgroundBox&&(this._backgroundBox.geometry.dispose(),this._backgroundBox.material.dispose())}_setSize(e){this._lodMax=Math.floor(Math.log2(e)),this._cubeSize=Math.pow(2,this._lodMax)}_dispose(){null!==this._blurMaterial&&this._blurMaterial.dispose(),null!==this._ggxMaterial&&this._ggxMaterial.dispose(),null!==this._pingPongRenderTarget&&this._pingPongRenderTarget.dispose();for(let e=0;e<this._lodMeshes.length;e++)this._lodMeshes[e].geometry.dispose()}_cleanup(e){this._renderer.setRenderTarget(S,b,T),this._renderer.xr.enabled=E,e.scissorTest=!1,C(e,0,0,e.width,e.height)}_fromTexture(e,i){e.mapping===n.hy7||e.mapping===n.xFO?this._setSize(0===e.image.length?16:e.image[0].width||e.image[0].image.width):this._setSize(e.image.width/4),S=this._renderer.getRenderTarget(),b=this._renderer.getActiveCubeFace(),T=this._renderer.getActiveMipmapLevel(),E=this._renderer.xr.enabled,this._renderer.xr.enabled=!1;let r=i||this._allocateTargets();return this._textureToCubeUV(e,r),this._applyPMREM(r),this._cleanup(r),r}_allocateTargets(){let e=3*Math.max(this._cubeSize,112),i=4*this._cubeSize,r={magFilter:n.k6q,minFilter:n.k6q,generateMipmaps:!1,type:n.ix0,format:n.GWd,colorSpace:n.Zr2,depthBuffer:!1},a=R(e,i,r);if(null===this._pingPongRenderTarget||this._pingPongRenderTarget.width!==e||this._pingPongRenderTarget.height!==i){var s,o,l,c,h,u;let a,d;null!==this._pingPongRenderTarget&&this._dispose(),this._pingPongRenderTarget=R(e,i,r);let{_lodMax:p}=this;({lodMeshes:this._lodMeshes,sizeLods:this._sizeLods,sigmas:this._sigmas}=function(e){let i=[],r=[],a=[],s=e,o=e-4+1+x.length;for(let l=0;l<o;l++){let o=Math.pow(2,s);i.push(o);let c=1/o;l>e-4?c=x[l-e+4-1]:0===l&&(c=0),r.push(c);let h=1/(o-2),u=-h,d=1+h,p=[u,u,d,u,d,d,u,u,d,d,u,d],f=new Float32Array(108),m=new Float32Array(72),g=new Float32Array(36);for(let e=0;e<6;e++){let i=e%3*2/3-1,r=e>2?0:-1,n=[i,r,0,i+2/3,r,0,i+2/3,r+1,0,i,r,0,i+2/3,r+1,0,i,r+1,0];f.set(n,18*e),m.set(p,12*e);let a=[e,e,e,e,e,e];g.set(a,6*e)}let v=new n.LoY;v.setAttribute("position",new n.THS(f,3)),v.setAttribute("uv",new n.THS(m,2)),v.setAttribute("faceIndex",new n.THS(g,1)),a.push(new n.eaF(v,null)),s>4&&s--}return{lodMeshes:a,sizeLods:i,sigmas:r}}(p)),this._blurMaterial=(s=p,o=e,l=i,a=new Float32Array(20),d=new n.Pq0(0,1,0),new n.BKk({name:"SphericalGaussianBlur",defines:{n:20,CUBEUV_TEXEL_WIDTH:1/o,CUBEUV_TEXEL_HEIGHT:1/l,CUBEUV_MAX_MIP:`${s}.0`},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:a},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:d}},vertexShader:L(),fragmentShader:`

			precision mediump float;
			precision mediump int;

			varying vec3 vOutputDirection;
@@ -3769,11 +3768,11 @@ void main() {
					prefilteredColor = prefilteredColor / totalWeight;
				}

				gl_FragColor = vec4(prefilteredColor, 1.0);
			}
-		`,blending:n.XIg,depthTest:!1,depthWrite:!1}))}return a}_compileMaterial(e){let i=new n.eaF(new n.LoY,e);this._renderer.compile(i,x)}_sceneToCubeUV(e,i,r,a,s){let o=new n.ubm(90,1,i,r),l=[1,-1,1,1,1,1],c=[1,1,1,-1,-1,-1],h=this._renderer,u=h.autoClear,d=h.toneMapping;h.getClearColor(M),h.toneMapping=n.y_p,h.autoClear=!1,h.state.buffers.depth.getReversed()&&(h.setRenderTarget(a),h.clearDepth(),h.setRenderTarget(null)),null===this._backgroundBox&&(this._backgroundBox=new n.eaF(new n.iNn,new n.V9B({name:"PMREM.Background",side:n.hsX,depthWrite:!1,depthTest:!1})));let p=this._backgroundBox,f=p.material,m=!1,g=e.background;g?g.isColor&&(f.color.copy(g),e.background=null,m=!0):(f.color.copy(M),m=!0);for(let i=0;i<6;i++){let r=i%3;0===r?(o.up.set(0,l[i],0),o.position.set(s.x,s.y,s.z),o.lookAt(s.x+c[i],s.y,s.z)):1===r?(o.up.set(0,0,l[i]),o.position.set(s.x,s.y,s.z),o.lookAt(s.x,s.y+c[i],s.z)):(o.up.set(0,l[i],0),o.position.set(s.x,s.y,s.z),o.lookAt(s.x,s.y,s.z+c[i]));let n=this._cubeSize;C(a,r*n,i>2?n:0,n,n),h.setRenderTarget(a),m&&h.render(p,o),h.render(e,o)}h.toneMapping=d,h.autoClear=u,e.background=g}_textureToCubeUV(e,i){let r=this._renderer,a=e.mapping===n.hy7||e.mapping===n.xFO;a?(null===this._cubemapMaterial&&(this._cubemapMaterial=I()),this._cubemapMaterial.uniforms.flipEnvMap.value=!1===e.isRenderTargetTexture?-1:1):null===this._equirectMaterial&&(this._equirectMaterial=P());let s=a?this._cubemapMaterial:this._equirectMaterial,o=this._lodMeshes[0];o.material=s,s.uniforms.envMap.value=e;let l=this._cubeSize;C(i,0,0,3*l,2*l),r.setRenderTarget(i),r.render(o,x)}_applyPMREM(e){let i=this._renderer,r=i.autoClear;i.autoClear=!1;let n=this._lodMeshes.length;for(let i=1;i<n;i++)this._applyGGXFilter(e,i-1,i);i.autoClear=r}_applyGGXFilter(e,i,r){let n=this._renderer,a=this._pingPongRenderTarget,s=this._ggxMaterial,o=this._lodMeshes[r];o.material=s;let l=s.uniforms,c=r/(this._lodMeshes.length-1),h=i/(this._lodMeshes.length-1),u=Math.sqrt(c*c-h*h),{_lodMax:d}=this,p=this._sizeLods[r],f=3*p*(r>d-4?r-d+4:0),m=4*(this._cubeSize-p);l.envMap.value=e.texture,l.roughness.value=u*(0+1.25*c),l.mipInt.value=d-i,C(a,f,m,3*p,2*p),n.setRenderTarget(a),n.render(o,x),l.envMap.value=a.texture,l.roughness.value=0,l.mipInt.value=d-r,C(e,f,m,3*p,2*p),n.setRenderTarget(e),n.render(o,x)}_blur(e,i,r,n,a){let s=this._pingPongRenderTarget;this._halfBlur(e,s,i,r,n,"latitudinal",a),this._halfBlur(s,e,r,r,n,"longitudinal",a)}_halfBlur(e,i,r,a,s,o,l){let c=this._renderer,h=this._blurMaterial;"latitudinal"!==o&&"longitudinal"!==o&&(0,n.z3S)("blur direction must be either latitudinal or longitudinal!");let u=this._lodMeshes[a];u.material=h;let d=h.uniforms,p=this._sizeLods[r]-1,f=isFinite(s)?Math.PI/(2*p):2*Math.PI/39,m=s/f,g=isFinite(s)?1+Math.floor(3*m):20;g>20&&(0,n.R8M)(`sigmaRadians, ${s}, is too large and will clip, as it requested ${g} samples when the maximum is set to 20`);let v=[],_=0;for(let e=0;e<20;++e){let i=e/m,r=Math.exp(-i*i/2);v.push(r),0===e?_+=r:e<g&&(_+=2*r)}for(let e=0;e<v.length;e++)v[e]=v[e]/_;d.envMap.value=e.texture,d.samples.value=g,d.weights.value=v,d.latitudinal.value="latitudinal"===o,l&&(d.poleAxis.value=l);let{_lodMax:y}=this;d.dTheta.value=f,d.mipInt.value=y-r;let M=this._sizeLods[a],S=4*(this._cubeSize-M);C(i,3*M*(a>y-4?a-y+4:0),S,3*M,2*M),c.setRenderTarget(i),c.render(u,x)}}function R(e,i,r){let a=new n.nWS(e,i,r);return a.texture.mapping=n.Om,a.texture.name="PMREM.cubeUv",a.scissorTest=!0,a}function C(e,i,r,n,a){e.viewport.set(i,r,n,a),e.scissor.set(i,r,n,a)}function P(){return new n.BKk({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null}},vertexShader:L(),fragmentShader:`
+		`,blending:n.XIg,depthTest:!1,depthWrite:!1}))}return a}_compileMaterial(e){let i=new n.eaF(new n.LoY,e);this._renderer.compile(i,y)}_sceneToCubeUV(e,i,r,a,s){let o=new n.ubm(90,1,i,r),l=[1,-1,1,1,1,1],c=[1,1,1,-1,-1,-1],h=this._renderer,u=h.autoClear,d=h.toneMapping;h.getClearColor(M),h.toneMapping=n.y_p,h.autoClear=!1,h.state.buffers.depth.getReversed()&&(h.setRenderTarget(a),h.clearDepth(),h.setRenderTarget(null)),null===this._backgroundBox&&(this._backgroundBox=new n.eaF(new n.iNn,new n.V9B({name:"PMREM.Background",side:n.hsX,depthWrite:!1,depthTest:!1})));let p=this._backgroundBox,f=p.material,m=!1,g=e.background;g?g.isColor&&(f.color.copy(g),e.background=null,m=!0):(f.color.copy(M),m=!0);for(let i=0;i<6;i++){let r=i%3;0===r?(o.up.set(0,l[i],0),o.position.set(s.x,s.y,s.z),o.lookAt(s.x+c[i],s.y,s.z)):1===r?(o.up.set(0,0,l[i]),o.position.set(s.x,s.y,s.z),o.lookAt(s.x,s.y+c[i],s.z)):(o.up.set(0,l[i],0),o.position.set(s.x,s.y,s.z),o.lookAt(s.x,s.y,s.z+c[i]));let n=this._cubeSize;C(a,r*n,i>2?n:0,n,n),h.setRenderTarget(a),m&&h.render(p,o),h.render(e,o)}h.toneMapping=d,h.autoClear=u,e.background=g}_textureToCubeUV(e,i){let r=this._renderer,a=e.mapping===n.hy7||e.mapping===n.xFO;a?(null===this._cubemapMaterial&&(this._cubemapMaterial=I()),this._cubemapMaterial.uniforms.flipEnvMap.value=!1===e.isRenderTargetTexture?-1:1):null===this._equirectMaterial&&(this._equirectMaterial=P());let s=a?this._cubemapMaterial:this._equirectMaterial,o=this._lodMeshes[0];o.material=s,s.uniforms.envMap.value=e;let l=this._cubeSize;C(i,0,0,3*l,2*l),r.setRenderTarget(i),r.render(o,y)}_applyPMREM(e){let i=this._renderer,r=i.autoClear;i.autoClear=!1;let n=this._lodMeshes.length;for(let i=1;i<n;i++)this._applyGGXFilter(e,i-1,i);i.autoClear=r}_applyGGXFilter(e,i,r){let n=this._renderer,a=this._pingPongRenderTarget,s=this._ggxMaterial,o=this._lodMeshes[r];o.material=s;let l=s.uniforms,c=r/(this._lodMeshes.length-1),h=i/(this._lodMeshes.length-1),u=Math.sqrt(c*c-h*h),{_lodMax:d}=this,p=this._sizeLods[r],f=3*p*(r>d-4?r-d+4:0),m=4*(this._cubeSize-p);l.envMap.value=e.texture,l.roughness.value=u*(0+1.25*c),l.mipInt.value=d-i,C(a,f,m,3*p,2*p),n.setRenderTarget(a),n.render(o,y),l.envMap.value=a.texture,l.roughness.value=0,l.mipInt.value=d-r,C(e,f,m,3*p,2*p),n.setRenderTarget(e),n.render(o,y)}_blur(e,i,r,n,a){let s=this._pingPongRenderTarget;this._halfBlur(e,s,i,r,n,"latitudinal",a),this._halfBlur(s,e,r,r,n,"longitudinal",a)}_halfBlur(e,i,r,a,s,o,l){let c=this._renderer,h=this._blurMaterial;"latitudinal"!==o&&"longitudinal"!==o&&(0,n.z3S)("blur direction must be either latitudinal or longitudinal!");let u=this._lodMeshes[a];u.material=h;let d=h.uniforms,p=this._sizeLods[r]-1,f=isFinite(s)?Math.PI/(2*p):2*Math.PI/39,m=s/f,g=isFinite(s)?1+Math.floor(3*m):20;g>20&&(0,n.R8M)(`sigmaRadians, ${s}, is too large and will clip, as it requested ${g} samples when the maximum is set to 20`);let v=[],_=0;for(let e=0;e<20;++e){let i=e/m,r=Math.exp(-i*i/2);v.push(r),0===e?_+=r:e<g&&(_+=2*r)}for(let e=0;e<v.length;e++)v[e]=v[e]/_;d.envMap.value=e.texture,d.samples.value=g,d.weights.value=v,d.latitudinal.value="latitudinal"===o,l&&(d.poleAxis.value=l);let{_lodMax:x}=this;d.dTheta.value=f,d.mipInt.value=x-r;let M=this._sizeLods[a],S=4*(this._cubeSize-M);C(i,3*M*(a>x-4?a-x+4:0),S,3*M,2*M),c.setRenderTarget(i),c.render(u,y)}}function R(e,i,r){let a=new n.nWS(e,i,r);return a.texture.mapping=n.Om,a.texture.name="PMREM.cubeUv",a.scissorTest=!0,a}function C(e,i,r,n,a){e.viewport.set(i,r,n,a),e.scissor.set(i,r,n,a)}function P(){return new n.BKk({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null}},vertexShader:L(),fragmentShader:`

			precision mediump float;
			precision mediump int;

			varying vec3 vOutputDirection;
@@ -3859,11 +3858,11 @@ void main() {

			vOutputDirection = getDirection( uv, faceIndex );
			gl_Position = vec4( position, 1.0 );

		}
-	`}function D(e){let i=new WeakMap,r=null;function a(e){let r=e.target;r.removeEventListener("dispose",a);let n=i.get(r);void 0!==n&&(i.delete(r),n.dispose())}return{get:function(s){if(s&&s.isTexture){let o=s.mapping,l=o===n.wfO||o===n.uV5,c=o===n.hy7||o===n.xFO;if(l||c){let n=i.get(s),o=void 0!==n?n.texture.pmremVersion:0;if(s.isRenderTargetTexture&&s.pmremVersion!==o)return null===r&&(r=new A(e)),(n=l?r.fromEquirectangular(s,n):r.fromCubemap(s,n)).texture.pmremVersion=s.pmremVersion,i.set(s,n),n.texture;{if(void 0!==n)return n.texture;let o=s.image;return l&&o&&o.height>0||c&&o&&function(e){let i=0;for(let r=0;r<6;r++)void 0!==e[r]&&i++;return 6===i}(o)?(null===r&&(r=new A(e)),(n=l?r.fromEquirectangular(s):r.fromCubemap(s)).texture.pmremVersion=s.pmremVersion,i.set(s,n),s.addEventListener("dispose",a),n.texture):null}}}return s},dispose:function(){i=new WeakMap,null!==r&&(r.dispose(),r=null)}}}function U(e){let i={};function r(r){if(void 0!==i[r])return i[r];let n=e.getExtension(r);return i[r]=n,n}return{has:function(e){return null!==r(e)},init:function(){r("EXT_color_buffer_float"),r("WEBGL_clip_cull_distance"),r("OES_texture_float_linear"),r("EXT_color_buffer_half_float"),r("WEBGL_multisampled_render_to_texture"),r("WEBGL_render_shared_exponent")},get:function(e){let i=r(e);return null===i&&(0,n.mcG)("WebGLRenderer: "+e+" extension not supported."),i}}}function N(e,i,r,a){let s={},o=new WeakMap;function l(e){let n=e.target;for(let e in null!==n.index&&i.remove(n.index),n.attributes)i.remove(n.attributes[e]);n.removeEventListener("dispose",l),delete s[n.id];let c=o.get(n);c&&(i.remove(c),o.delete(n)),a.releaseStatesOfGeometry(n),!0===n.isInstancedBufferGeometry&&delete n._maxInstanceCount,r.memory.geometries--}function c(e){let r=[],a=e.index,s=e.attributes.position,l=0;if(null!==a){let e=a.array;l=a.version;for(let i=0,n=e.length;i<n;i+=3){let n=e[i+0],a=e[i+1],s=e[i+2];r.push(n,a,a,s,s,n)}}else{if(void 0===s)return;let e=s.array;l=s.version;for(let i=0,n=e.length/3-1;i<n;i+=3){let e=i+0,n=i+1,a=i+2;r.push(e,n,n,a,a,e)}}let c=new((0,n.AQS)(r)?n.MW4:n.A$4)(r,1);c.version=l;let h=o.get(e);h&&i.remove(h),o.set(e,c)}return{get:function(e,i){return!0===s[i.id]||(i.addEventListener("dispose",l),s[i.id]=!0,r.memory.geometries++),i},update:function(r){let n=r.attributes;for(let r in n)i.update(n[r],e.ARRAY_BUFFER)},getWireframeAttribute:function(e){let i=o.get(e);if(i){let r=e.index;null!==r&&i.version<r.version&&c(e)}else c(e);return o.get(e)}}}function O(e,i,r){let n,a,s;function o(i,o,l){0!==l&&(e.drawElementsInstanced(n,o,a,i*s,l),r.update(o,n,l))}this.setMode=function(e){n=e},this.setIndex=function(e){a=e.type,s=e.bytesPerElement},this.render=function(i,o){e.drawElements(n,o,a,i*s),r.update(o,n,1)},this.renderInstances=o,this.renderMultiDraw=function(e,s,o){if(0===o)return;i.get("WEBGL_multi_draw").multiDrawElementsWEBGL(n,s,0,a,e,0,o);let l=0;for(let e=0;e<o;e++)l+=s[e];r.update(l,n,1)},this.renderMultiDrawInstances=function(e,l,c,h){if(0===c)return;let u=i.get("WEBGL_multi_draw");if(null===u)for(let i=0;i<e.length;i++)o(e[i]/s,l[i],h[i]);else{u.multiDrawElementsInstancedWEBGL(n,l,0,a,e,0,h,0,c);let i=0;for(let e=0;e<c;e++)i+=l[e]*h[e];r.update(i,n,1)}}}function F(e){let i={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:i,programs:null,autoReset:!0,reset:function(){i.calls=0,i.triangles=0,i.points=0,i.lines=0},update:function(r,a,s){switch(i.calls++,a){case e.TRIANGLES:i.triangles+=r/3*s;break;case e.LINES:i.lines+=r/2*s;break;case e.LINE_STRIP:i.lines+=s*(r-1);break;case e.LINE_LOOP:i.lines+=s*r;break;case e.POINTS:i.points+=s*r;break;default:(0,n.z3S)("WebGLInfo: Unknown draw mode:",a)}}}}function B(e,i,r){let a=new WeakMap,s=new n.IUQ;return{update:function(o,l,c){let h=o.morphTargetInfluences,u=l.morphAttributes.position||l.morphAttributes.normal||l.morphAttributes.color,d=void 0!==u?u.length:0,p=a.get(l);if(void 0===p||p.count!==d){void 0!==p&&p.texture.dispose();let e=void 0!==l.morphAttributes.position,r=void 0!==l.morphAttributes.normal,o=void 0!==l.morphAttributes.color,c=l.morphAttributes.position||[],h=l.morphAttributes.normal||[],u=l.morphAttributes.color||[],f=0;!0===e&&(f=1),!0===r&&(f=2),!0===o&&(f=3);let m=l.attributes.position.count*f,g=1;m>i.maxTextureSize&&(g=Math.ceil(m/i.maxTextureSize),m=i.maxTextureSize);let v=new Float32Array(m*g*4*d),_=new n.rFo(v,m,g,d);_.type=n.RQf,_.needsUpdate=!0;let y=4*f;for(let i=0;i<d;i++){let n=c[i],a=h[i],l=u[i],d=m*g*4*i;for(let i=0;i<n.count;i++){let c=i*y;!0===e&&(s.fromBufferAttribute(n,i),v[d+c+0]=s.x,v[d+c+1]=s.y,v[d+c+2]=s.z,v[d+c+3]=0),!0===r&&(s.fromBufferAttribute(a,i),v[d+c+4]=s.x,v[d+c+5]=s.y,v[d+c+6]=s.z,v[d+c+7]=0),!0===o&&(s.fromBufferAttribute(l,i),v[d+c+8]=s.x,v[d+c+9]=s.y,v[d+c+10]=s.z,v[d+c+11]=4===l.itemSize?s.w:1)}}p={count:d,texture:_,size:new n.I9Y(m,g)},a.set(l,p),l.addEventListener("dispose",function e(){_.dispose(),a.delete(l),l.removeEventListener("dispose",e)})}if(!0===o.isInstancedMesh&&null!==o.morphTexture)c.getUniforms().setValue(e,"morphTexture",o.morphTexture,r);else{let i=0;for(let e=0;e<h.length;e++)i+=h[e];let r=l.morphTargetsRelative?1:1-i;c.getUniforms().setValue(e,"morphTargetBaseInfluence",r),c.getUniforms().setValue(e,"morphTargetInfluences",h)}c.getUniforms().setValue(e,"morphTargetsTexture",p.texture,r),c.getUniforms().setValue(e,"morphTargetsTextureSize",p.size)}}}function z(e,i,r,n){let a=new WeakMap;function s(e){let i=e.target;i.removeEventListener("dispose",s),r.remove(i.instanceMatrix),null!==i.instanceColor&&r.remove(i.instanceColor)}return{update:function(o){let l=n.render.frame,c=o.geometry,h=i.get(o,c);if(a.get(h)!==l&&(i.update(h),a.set(h,l)),o.isInstancedMesh&&(!1===o.hasEventListener("dispose",s)&&o.addEventListener("dispose",s),a.get(o)!==l&&(r.update(o.instanceMatrix,e.ARRAY_BUFFER),null!==o.instanceColor&&r.update(o.instanceColor,e.ARRAY_BUFFER),a.set(o,l))),o.isSkinnedMesh){let e=o.skeleton;a.get(e)!==l&&(e.update(),a.set(e,l))}return h},dispose:function(){a=new WeakMap}}}let k={[n.kyO]:"LINEAR_TONE_MAPPING",[n.Mjd]:"REINHARD_TONE_MAPPING",[n.nNL]:"CINEON_TONE_MAPPING",[n.FV]:"ACES_FILMIC_TONE_MAPPING",[n.LAk]:"AGX_TONE_MAPPING",[n.aJ8]:"NEUTRAL_TONE_MAPPING",[n.g7M]:"CUSTOM_TONE_MAPPING"};function V(e,i,r,a,s){let o,l=new n.nWS(i,r,{type:e,depthBuffer:a,stencilBuffer:s}),c=new n.nWS(i,r,{type:n.ix0,depthBuffer:!1,stencilBuffer:!1}),h=new n.LoY;h.setAttribute("position",new n.qtW([-1,3,0,-1,-1,0,3,-1,0],3)),h.setAttribute("uv",new n.qtW([0,2,0,0,2,0],2));let u=new n.D$Q({uniforms:{tDiffuse:{value:null}},vertexShader:`
+	`}function D(e){let i=new WeakMap,r=null;function a(e){let r=e.target;r.removeEventListener("dispose",a);let n=i.get(r);void 0!==n&&(i.delete(r),n.dispose())}return{get:function(s){if(s&&s.isTexture){let o=s.mapping,l=o===n.wfO||o===n.uV5,c=o===n.hy7||o===n.xFO;if(l||c){let n=i.get(s),o=void 0!==n?n.texture.pmremVersion:0;if(s.isRenderTargetTexture&&s.pmremVersion!==o)return null===r&&(r=new A(e)),(n=l?r.fromEquirectangular(s,n):r.fromCubemap(s,n)).texture.pmremVersion=s.pmremVersion,i.set(s,n),n.texture;{if(void 0!==n)return n.texture;let o=s.image;return l&&o&&o.height>0||c&&o&&function(e){let i=0;for(let r=0;r<6;r++)void 0!==e[r]&&i++;return 6===i}(o)?(null===r&&(r=new A(e)),(n=l?r.fromEquirectangular(s):r.fromCubemap(s)).texture.pmremVersion=s.pmremVersion,i.set(s,n),s.addEventListener("dispose",a),n.texture):null}}}return s},dispose:function(){i=new WeakMap,null!==r&&(r.dispose(),r=null)}}}function U(e){let i={};function r(r){if(void 0!==i[r])return i[r];let n=e.getExtension(r);return i[r]=n,n}return{has:function(e){return null!==r(e)},init:function(){r("EXT_color_buffer_float"),r("WEBGL_clip_cull_distance"),r("OES_texture_float_linear"),r("EXT_color_buffer_half_float"),r("WEBGL_multisampled_render_to_texture"),r("WEBGL_render_shared_exponent")},get:function(e){let i=r(e);return null===i&&(0,n.mcG)("WebGLRenderer: "+e+" extension not supported."),i}}}function N(e,i,r,a){let s={},o=new WeakMap;function l(e){let n=e.target;for(let e in null!==n.index&&i.remove(n.index),n.attributes)i.remove(n.attributes[e]);n.removeEventListener("dispose",l),delete s[n.id];let c=o.get(n);c&&(i.remove(c),o.delete(n)),a.releaseStatesOfGeometry(n),!0===n.isInstancedBufferGeometry&&delete n._maxInstanceCount,r.memory.geometries--}function c(e){let r=[],a=e.index,s=e.attributes.position,l=0;if(null!==a){let e=a.array;l=a.version;for(let i=0,n=e.length;i<n;i+=3){let n=e[i+0],a=e[i+1],s=e[i+2];r.push(n,a,a,s,s,n)}}else{if(void 0===s)return;let e=s.array;l=s.version;for(let i=0,n=e.length/3-1;i<n;i+=3){let e=i+0,n=i+1,a=i+2;r.push(e,n,n,a,a,e)}}let c=new((0,n.AQS)(r)?n.MW4:n.A$4)(r,1);c.version=l;let h=o.get(e);h&&i.remove(h),o.set(e,c)}return{get:function(e,i){return!0===s[i.id]||(i.addEventListener("dispose",l),s[i.id]=!0,r.memory.geometries++),i},update:function(r){let n=r.attributes;for(let r in n)i.update(n[r],e.ARRAY_BUFFER)},getWireframeAttribute:function(e){let i=o.get(e);if(i){let r=e.index;null!==r&&i.version<r.version&&c(e)}else c(e);return o.get(e)}}}function O(e,i,r){let n,a,s;function o(i,o,l){0!==l&&(e.drawElementsInstanced(n,o,a,i*s,l),r.update(o,n,l))}this.setMode=function(e){n=e},this.setIndex=function(e){a=e.type,s=e.bytesPerElement},this.render=function(i,o){e.drawElements(n,o,a,i*s),r.update(o,n,1)},this.renderInstances=o,this.renderMultiDraw=function(e,s,o){if(0===o)return;i.get("WEBGL_multi_draw").multiDrawElementsWEBGL(n,s,0,a,e,0,o);let l=0;for(let e=0;e<o;e++)l+=s[e];r.update(l,n,1)},this.renderMultiDrawInstances=function(e,l,c,h){if(0===c)return;let u=i.get("WEBGL_multi_draw");if(null===u)for(let i=0;i<e.length;i++)o(e[i]/s,l[i],h[i]);else{u.multiDrawElementsInstancedWEBGL(n,l,0,a,e,0,h,0,c);let i=0;for(let e=0;e<c;e++)i+=l[e]*h[e];r.update(i,n,1)}}}function F(e){let i={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:i,programs:null,autoReset:!0,reset:function(){i.calls=0,i.triangles=0,i.points=0,i.lines=0},update:function(r,a,s){switch(i.calls++,a){case e.TRIANGLES:i.triangles+=r/3*s;break;case e.LINES:i.lines+=r/2*s;break;case e.LINE_STRIP:i.lines+=s*(r-1);break;case e.LINE_LOOP:i.lines+=s*r;break;case e.POINTS:i.points+=s*r;break;default:(0,n.z3S)("WebGLInfo: Unknown draw mode:",a)}}}}function B(e,i,r){let a=new WeakMap,s=new n.IUQ;return{update:function(o,l,c){let h=o.morphTargetInfluences,u=l.morphAttributes.position||l.morphAttributes.normal||l.morphAttributes.color,d=void 0!==u?u.length:0,p=a.get(l);if(void 0===p||p.count!==d){void 0!==p&&p.texture.dispose();let e=void 0!==l.morphAttributes.position,r=void 0!==l.morphAttributes.normal,o=void 0!==l.morphAttributes.color,c=l.morphAttributes.position||[],h=l.morphAttributes.normal||[],u=l.morphAttributes.color||[],f=0;!0===e&&(f=1),!0===r&&(f=2),!0===o&&(f=3);let m=l.attributes.position.count*f,g=1;m>i.maxTextureSize&&(g=Math.ceil(m/i.maxTextureSize),m=i.maxTextureSize);let v=new Float32Array(m*g*4*d),_=new n.rFo(v,m,g,d);_.type=n.RQf,_.needsUpdate=!0;let x=4*f;for(let i=0;i<d;i++){let n=c[i],a=h[i],l=u[i],d=m*g*4*i;for(let i=0;i<n.count;i++){let c=i*x;!0===e&&(s.fromBufferAttribute(n,i),v[d+c+0]=s.x,v[d+c+1]=s.y,v[d+c+2]=s.z,v[d+c+3]=0),!0===r&&(s.fromBufferAttribute(a,i),v[d+c+4]=s.x,v[d+c+5]=s.y,v[d+c+6]=s.z,v[d+c+7]=0),!0===o&&(s.fromBufferAttribute(l,i),v[d+c+8]=s.x,v[d+c+9]=s.y,v[d+c+10]=s.z,v[d+c+11]=4===l.itemSize?s.w:1)}}p={count:d,texture:_,size:new n.I9Y(m,g)},a.set(l,p),l.addEventListener("dispose",function e(){_.dispose(),a.delete(l),l.removeEventListener("dispose",e)})}if(!0===o.isInstancedMesh&&null!==o.morphTexture)c.getUniforms().setValue(e,"morphTexture",o.morphTexture,r);else{let i=0;for(let e=0;e<h.length;e++)i+=h[e];let r=l.morphTargetsRelative?1:1-i;c.getUniforms().setValue(e,"morphTargetBaseInfluence",r),c.getUniforms().setValue(e,"morphTargetInfluences",h)}c.getUniforms().setValue(e,"morphTargetsTexture",p.texture,r),c.getUniforms().setValue(e,"morphTargetsTextureSize",p.size)}}}function z(e,i,r,n){let a=new WeakMap;function s(e){let i=e.target;i.removeEventListener("dispose",s),r.remove(i.instanceMatrix),null!==i.instanceColor&&r.remove(i.instanceColor)}return{update:function(o){let l=n.render.frame,c=o.geometry,h=i.get(o,c);if(a.get(h)!==l&&(i.update(h),a.set(h,l)),o.isInstancedMesh&&(!1===o.hasEventListener("dispose",s)&&o.addEventListener("dispose",s),a.get(o)!==l&&(r.update(o.instanceMatrix,e.ARRAY_BUFFER),null!==o.instanceColor&&r.update(o.instanceColor,e.ARRAY_BUFFER),a.set(o,l))),o.isSkinnedMesh){let e=o.skeleton;a.get(e)!==l&&(e.update(),a.set(e,l))}return h},dispose:function(){a=new WeakMap}}}let k={[n.kyO]:"LINEAR_TONE_MAPPING",[n.Mjd]:"REINHARD_TONE_MAPPING",[n.nNL]:"CINEON_TONE_MAPPING",[n.FV]:"ACES_FILMIC_TONE_MAPPING",[n.LAk]:"AGX_TONE_MAPPING",[n.aJ8]:"NEUTRAL_TONE_MAPPING",[n.g7M]:"CUSTOM_TONE_MAPPING"};function V(e,i,r,a,s){let o,l=new n.nWS(i,r,{type:e,depthBuffer:a,stencilBuffer:s}),c=new n.nWS(i,r,{type:n.ix0,depthBuffer:!1,stencilBuffer:!1}),h=new n.LoY;h.setAttribute("position",new n.qtW([-1,3,0,-1,-1,0,3,-1,0],3)),h.setAttribute("uv",new n.qtW([0,2,0,0,2,0],2));let u=new n.D$Q({uniforms:{tDiffuse:{value:null}},vertexShader:`
			precision highp float;

			uniform mat4 modelViewMatrix;
			uniform mat4 projectionMatrix;

@@ -3905,11 +3904,11 @@ void main() {
				#endif

				#ifdef SRGB_TRANSFER
					gl_FragColor = sRGBTransferOETF( gl_FragColor );
				#endif
-			}`,depthTest:!1,depthWrite:!1}),d=new n.eaF(h,u),p=new n.qUd(-1,1,1,-1,0,1),f=null,m=null,g=!1,v=null,_=[],y=!1;this.setSize=function(e,i){l.setSize(e,i),c.setSize(e,i);for(let r=0;r<_.length;r++){let n=_[r];n.setSize&&n.setSize(e,i)}},this.setEffects=function(e){y=(_=e).length>0&&!0===_[0].isRenderPass;let i=l.width,r=l.height;for(let e=0;e<_.length;e++){let n=_[e];n.setSize&&n.setSize(i,r)}},this.begin=function(e,i){if(g||e.toneMapping===n.y_p&&0===_.length)return!1;if(v=i,null!==i){let e=i.width,r=i.height;(l.width!==e||l.height!==r)&&this.setSize(e,r)}return!1===y&&e.setRenderTarget(l),o=e.toneMapping,e.toneMapping=n.y_p,!0},this.hasRenderPass=function(){return y},this.end=function(e,i){e.toneMapping=o,g=!0;let r=l,a=c;for(let n=0;n<_.length;n++){let s=_[n];if(!1!==s.enabled&&(s.render(e,a,r,i),!1!==s.needsSwap)){let e=r;r=a,a=e}}if(f!==e.outputColorSpace||m!==e.toneMapping){f=e.outputColorSpace,m=e.toneMapping,u.defines={},n.ppV.getTransfer(f)===n.KLL&&(u.defines.SRGB_TRANSFER="");let i=k[m];i&&(u.defines[i]=""),u.needsUpdate=!0}u.uniforms.tDiffuse.value=r.texture,e.setRenderTarget(v),e.render(d,p),v=null,g=!1},this.isCompositing=function(){return g},this.dispose=function(){l.dispose(),c.dispose(),h.dispose(),u.dispose()}}let H=new n.gPd,G=new n.VCu(1,1),W=new n.rFo,X=new n.dYF,j=new n.b4q,q=[],Y=[],K=new Float32Array(16),J=new Float32Array(9),Z=new Float32Array(4);function Q(e,i,r){let n=e[0];if(n<=0||n>0)return e;let a=i*r,s=q[a];if(void 0===s&&(s=new Float32Array(a),q[a]=s),0!==i){n.toArray(s,0);for(let n=1,a=0;n!==i;++n)a+=r,e[n].toArray(s,a)}return s}function $(e,i){if(e.length!==i.length)return!1;for(let r=0,n=e.length;r<n;r++)if(e[r]!==i[r])return!1;return!0}function ee(e,i){for(let r=0,n=i.length;r<n;r++)e[r]=i[r]}function et(e,i){let r=Y[i];void 0===r&&(r=new Int32Array(i),Y[i]=r);for(let n=0;n!==i;++n)r[n]=e.allocateTextureUnit();return r}function ei(e,i){let r=this.cache;r[0]!==i&&(e.uniform1f(this.addr,i),r[0]=i)}function er(e,i){let r=this.cache;if(void 0!==i.x)(r[0]!==i.x||r[1]!==i.y)&&(e.uniform2f(this.addr,i.x,i.y),r[0]=i.x,r[1]=i.y);else{if($(r,i))return;e.uniform2fv(this.addr,i),ee(r,i)}}function en(e,i){let r=this.cache;if(void 0!==i.x)(r[0]!==i.x||r[1]!==i.y||r[2]!==i.z)&&(e.uniform3f(this.addr,i.x,i.y,i.z),r[0]=i.x,r[1]=i.y,r[2]=i.z);else if(void 0!==i.r)(r[0]!==i.r||r[1]!==i.g||r[2]!==i.b)&&(e.uniform3f(this.addr,i.r,i.g,i.b),r[0]=i.r,r[1]=i.g,r[2]=i.b);else{if($(r,i))return;e.uniform3fv(this.addr,i),ee(r,i)}}function ea(e,i){let r=this.cache;if(void 0!==i.x)(r[0]!==i.x||r[1]!==i.y||r[2]!==i.z||r[3]!==i.w)&&(e.uniform4f(this.addr,i.x,i.y,i.z,i.w),r[0]=i.x,r[1]=i.y,r[2]=i.z,r[3]=i.w);else{if($(r,i))return;e.uniform4fv(this.addr,i),ee(r,i)}}function es(e,i){let r=this.cache,n=i.elements;if(void 0===n){if($(r,i))return;e.uniformMatrix2fv(this.addr,!1,i),ee(r,i)}else{if($(r,n))return;Z.set(n),e.uniformMatrix2fv(this.addr,!1,Z),ee(r,n)}}function eo(e,i){let r=this.cache,n=i.elements;if(void 0===n){if($(r,i))return;e.uniformMatrix3fv(this.addr,!1,i),ee(r,i)}else{if($(r,n))return;J.set(n),e.uniformMatrix3fv(this.addr,!1,J),ee(r,n)}}function el(e,i){let r=this.cache,n=i.elements;if(void 0===n){if($(r,i))return;e.uniformMatrix4fv(this.addr,!1,i),ee(r,i)}else{if($(r,n))return;K.set(n),e.uniformMatrix4fv(this.addr,!1,K),ee(r,n)}}function ec(e,i){let r=this.cache;r[0]!==i&&(e.uniform1i(this.addr,i),r[0]=i)}function eh(e,i){let r=this.cache;if(void 0!==i.x)(r[0]!==i.x||r[1]!==i.y)&&(e.uniform2i(this.addr,i.x,i.y),r[0]=i.x,r[1]=i.y);else{if($(r,i))return;e.uniform2iv(this.addr,i),ee(r,i)}}function eu(e,i){let r=this.cache;if(void 0!==i.x)(r[0]!==i.x||r[1]!==i.y||r[2]!==i.z)&&(e.uniform3i(this.addr,i.x,i.y,i.z),r[0]=i.x,r[1]=i.y,r[2]=i.z);else{if($(r,i))return;e.uniform3iv(this.addr,i),ee(r,i)}}function ed(e,i){let r=this.cache;if(void 0!==i.x)(r[0]!==i.x||r[1]!==i.y||r[2]!==i.z||r[3]!==i.w)&&(e.uniform4i(this.addr,i.x,i.y,i.z,i.w),r[0]=i.x,r[1]=i.y,r[2]=i.z,r[3]=i.w);else{if($(r,i))return;e.uniform4iv(this.addr,i),ee(r,i)}}function ep(e,i){let r=this.cache;r[0]!==i&&(e.uniform1ui(this.addr,i),r[0]=i)}function ef(e,i){let r=this.cache;if(void 0!==i.x)(r[0]!==i.x||r[1]!==i.y)&&(e.uniform2ui(this.addr,i.x,i.y),r[0]=i.x,r[1]=i.y);else{if($(r,i))return;e.uniform2uiv(this.addr,i),ee(r,i)}}function em(e,i){let r=this.cache;if(void 0!==i.x)(r[0]!==i.x||r[1]!==i.y||r[2]!==i.z)&&(e.uniform3ui(this.addr,i.x,i.y,i.z),r[0]=i.x,r[1]=i.y,r[2]=i.z);else{if($(r,i))return;e.uniform3uiv(this.addr,i),ee(r,i)}}function eg(e,i){let r=this.cache;if(void 0!==i.x)(r[0]!==i.x||r[1]!==i.y||r[2]!==i.z||r[3]!==i.w)&&(e.uniform4ui(this.addr,i.x,i.y,i.z,i.w),r[0]=i.x,r[1]=i.y,r[2]=i.z,r[3]=i.w);else{if($(r,i))return;e.uniform4uiv(this.addr,i),ee(r,i)}}function ev(e,i,r){let a,s=this.cache,o=r.allocateTextureUnit();s[0]!==o&&(e.uniform1i(this.addr,o),s[0]=o),this.type===e.SAMPLER_2D_SHADOW?(G.compareFunction=r.isReversedDepthBuffer()?n.gWB:n.TiK,a=G):a=H,r.setTexture2D(i||a,o)}function e_(e,i,r){let n=this.cache,a=r.allocateTextureUnit();n[0]!==a&&(e.uniform1i(this.addr,a),n[0]=a),r.setTexture3D(i||X,a)}function ey(e,i,r){let n=this.cache,a=r.allocateTextureUnit();n[0]!==a&&(e.uniform1i(this.addr,a),n[0]=a),r.setTextureCube(i||j,a)}function ex(e,i,r){let n=this.cache,a=r.allocateTextureUnit();n[0]!==a&&(e.uniform1i(this.addr,a),n[0]=a),r.setTexture2DArray(i||W,a)}function eM(e,i){e.uniform1fv(this.addr,i)}function eS(e,i){let r=Q(i,this.size,2);e.uniform2fv(this.addr,r)}function eb(e,i){let r=Q(i,this.size,3);e.uniform3fv(this.addr,r)}function eT(e,i){let r=Q(i,this.size,4);e.uniform4fv(this.addr,r)}function eE(e,i){let r=Q(i,this.size,4);e.uniformMatrix2fv(this.addr,!1,r)}function ew(e,i){let r=Q(i,this.size,9);e.uniformMatrix3fv(this.addr,!1,r)}function eA(e,i){let r=Q(i,this.size,16);e.uniformMatrix4fv(this.addr,!1,r)}function eR(e,i){e.uniform1iv(this.addr,i)}function eC(e,i){e.uniform2iv(this.addr,i)}function eP(e,i){e.uniform3iv(this.addr,i)}function eI(e,i){e.uniform4iv(this.addr,i)}function eL(e,i){e.uniform1uiv(this.addr,i)}function eD(e,i){e.uniform2uiv(this.addr,i)}function eU(e,i){e.uniform3uiv(this.addr,i)}function eN(e,i){e.uniform4uiv(this.addr,i)}function eO(e,i,r){let n,a=this.cache,s=i.length,o=et(r,s);$(a,o)||(e.uniform1iv(this.addr,o),ee(a,o)),n=this.type===e.SAMPLER_2D_SHADOW?G:H;for(let e=0;e!==s;++e)r.setTexture2D(i[e]||n,o[e])}function eF(e,i,r){let n=this.cache,a=i.length,s=et(r,a);$(n,s)||(e.uniform1iv(this.addr,s),ee(n,s));for(let e=0;e!==a;++e)r.setTexture3D(i[e]||X,s[e])}function eB(e,i,r){let n=this.cache,a=i.length,s=et(r,a);$(n,s)||(e.uniform1iv(this.addr,s),ee(n,s));for(let e=0;e!==a;++e)r.setTextureCube(i[e]||j,s[e])}function ez(e,i,r){let n=this.cache,a=i.length,s=et(r,a);$(n,s)||(e.uniform1iv(this.addr,s),ee(n,s));for(let e=0;e!==a;++e)r.setTexture2DArray(i[e]||W,s[e])}class ek{constructor(e,i,r){this.id=e,this.addr=r,this.cache=[],this.type=i.type,this.setValue=function(e){switch(e){case 5126:return ei;case 35664:return er;case 35665:return en;case 35666:return ea;case 35674:return es;case 35675:return eo;case 35676:return el;case 5124:case 35670:return ec;case 35667:case 35671:return eh;case 35668:case 35672:return eu;case 35669:case 35673:return ed;case 5125:return ep;case 36294:return ef;case 36295:return em;case 36296:return eg;case 35678:case 36198:case 36298:case 36306:case 35682:return ev;case 35679:case 36299:case 36307:return e_;case 35680:case 36300:case 36308:case 36293:return ey;case 36289:case 36303:case 36311:case 36292:return ex}}(i.type)}}class eV{constructor(e,i,r){this.id=e,this.addr=r,this.cache=[],this.type=i.type,this.size=i.size,this.setValue=function(e){switch(e){case 5126:return eM;case 35664:return eS;case 35665:return eb;case 35666:return eT;case 35674:return eE;case 35675:return ew;case 35676:return eA;case 5124:case 35670:return eR;case 35667:case 35671:return eC;case 35668:case 35672:return eP;case 35669:case 35673:return eI;case 5125:return eL;case 36294:return eD;case 36295:return eU;case 36296:return eN;case 35678:case 36198:case 36298:case 36306:case 35682:return eO;case 35679:case 36299:case 36307:return eF;case 35680:case 36300:case 36308:case 36293:return eB;case 36289:case 36303:case 36311:case 36292:return ez}}(i.type)}}class eH{constructor(e){this.id=e,this.seq=[],this.map={}}setValue(e,i,r){let n=this.seq;for(let a=0,s=n.length;a!==s;++a){let s=n[a];s.setValue(e,i[s.id],r)}}}let eG=/(\w+)(\])?(\[|\.)?/g;function eW(e,i){e.seq.push(i),e.map[i.id]=i}class eX{constructor(e,i){this.seq=[],this.map={};const r=e.getProgramParameter(i,e.ACTIVE_UNIFORMS);for(let n=0;n<r;++n){const r=e.getActiveUniform(i,n),a=e.getUniformLocation(i,r.name);!function(e,i,r){let n=e.name,a=n.length;for(eG.lastIndex=0;;){let s=eG.exec(n),o=eG.lastIndex,l=s[1],c="]"===s[2],h=s[3];if(c&&(l|=0),void 0===h||"["===h&&o+2===a){eW(r,void 0===h?new ek(l,e,i):new eV(l,e,i));break}{let e=r.map[l];void 0===e&&eW(r,e=new eH(l)),r=e}}}(r,a,this)}const n=[],a=[];for(const i of this.seq)i.type===e.SAMPLER_2D_SHADOW||i.type===e.SAMPLER_CUBE_SHADOW||i.type===e.SAMPLER_2D_ARRAY_SHADOW?n.push(i):a.push(i);n.length>0&&(this.seq=n.concat(a))}setValue(e,i,r,n){let a=this.map[i];void 0!==a&&a.setValue(e,r,n)}setOptional(e,i,r){let n=i[r];void 0!==n&&this.setValue(e,r,n)}static upload(e,i,r,n){for(let a=0,s=i.length;a!==s;++a){let s=i[a],o=r[s.id];!1!==o.needsUpdate&&s.setValue(e,o.value,n)}}static seqWithValue(e,i){let r=[];for(let n=0,a=e.length;n!==a;++n){let a=e[n];a.id in i&&r.push(a)}return r}}function ej(e,i,r){let n=e.createShader(i);return e.shaderSource(n,r),e.compileShader(n),n}let eq=0,eY=new n.dwI;function eK(e,i,r){let n=e.getShaderParameter(i,e.COMPILE_STATUS),a=(e.getShaderInfoLog(i)||"").trim();if(n&&""===a)return"";let s=/ERROR: 0:(\d+)/.exec(a);if(!s)return a;{let n=parseInt(s[1]);return r.toUpperCase()+`
+			}`,depthTest:!1,depthWrite:!1}),d=new n.eaF(h,u),p=new n.qUd(-1,1,1,-1,0,1),f=null,m=null,g=!1,v=null,_=[],x=!1;this.setSize=function(e,i){l.setSize(e,i),c.setSize(e,i);for(let r=0;r<_.length;r++){let n=_[r];n.setSize&&n.setSize(e,i)}},this.setEffects=function(e){x=(_=e).length>0&&!0===_[0].isRenderPass;let i=l.width,r=l.height;for(let e=0;e<_.length;e++){let n=_[e];n.setSize&&n.setSize(i,r)}},this.begin=function(e,i){if(g||e.toneMapping===n.y_p&&0===_.length)return!1;if(v=i,null!==i){let e=i.width,r=i.height;(l.width!==e||l.height!==r)&&this.setSize(e,r)}return!1===x&&e.setRenderTarget(l),o=e.toneMapping,e.toneMapping=n.y_p,!0},this.hasRenderPass=function(){return x},this.end=function(e,i){e.toneMapping=o,g=!0;let r=l,a=c;for(let n=0;n<_.length;n++){let s=_[n];if(!1!==s.enabled&&(s.render(e,a,r,i),!1!==s.needsSwap)){let e=r;r=a,a=e}}if(f!==e.outputColorSpace||m!==e.toneMapping){f=e.outputColorSpace,m=e.toneMapping,u.defines={},n.ppV.getTransfer(f)===n.KLL&&(u.defines.SRGB_TRANSFER="");let i=k[m];i&&(u.defines[i]=""),u.needsUpdate=!0}u.uniforms.tDiffuse.value=r.texture,e.setRenderTarget(v),e.render(d,p),v=null,g=!1},this.isCompositing=function(){return g},this.dispose=function(){l.dispose(),c.dispose(),h.dispose(),u.dispose()}}let H=new n.gPd,G=new n.VCu(1,1),W=new n.rFo,X=new n.dYF,j=new n.b4q,q=[],Y=[],K=new Float32Array(16),J=new Float32Array(9),Z=new Float32Array(4);function Q(e,i,r){let n=e[0];if(n<=0||n>0)return e;let a=i*r,s=q[a];if(void 0===s&&(s=new Float32Array(a),q[a]=s),0!==i){n.toArray(s,0);for(let n=1,a=0;n!==i;++n)a+=r,e[n].toArray(s,a)}return s}function $(e,i){if(e.length!==i.length)return!1;for(let r=0,n=e.length;r<n;r++)if(e[r]!==i[r])return!1;return!0}function ee(e,i){for(let r=0,n=i.length;r<n;r++)e[r]=i[r]}function et(e,i){let r=Y[i];void 0===r&&(r=new Int32Array(i),Y[i]=r);for(let n=0;n!==i;++n)r[n]=e.allocateTextureUnit();return r}function ei(e,i){let r=this.cache;r[0]!==i&&(e.uniform1f(this.addr,i),r[0]=i)}function er(e,i){let r=this.cache;if(void 0!==i.x)(r[0]!==i.x||r[1]!==i.y)&&(e.uniform2f(this.addr,i.x,i.y),r[0]=i.x,r[1]=i.y);else{if($(r,i))return;e.uniform2fv(this.addr,i),ee(r,i)}}function en(e,i){let r=this.cache;if(void 0!==i.x)(r[0]!==i.x||r[1]!==i.y||r[2]!==i.z)&&(e.uniform3f(this.addr,i.x,i.y,i.z),r[0]=i.x,r[1]=i.y,r[2]=i.z);else if(void 0!==i.r)(r[0]!==i.r||r[1]!==i.g||r[2]!==i.b)&&(e.uniform3f(this.addr,i.r,i.g,i.b),r[0]=i.r,r[1]=i.g,r[2]=i.b);else{if($(r,i))return;e.uniform3fv(this.addr,i),ee(r,i)}}function ea(e,i){let r=this.cache;if(void 0!==i.x)(r[0]!==i.x||r[1]!==i.y||r[2]!==i.z||r[3]!==i.w)&&(e.uniform4f(this.addr,i.x,i.y,i.z,i.w),r[0]=i.x,r[1]=i.y,r[2]=i.z,r[3]=i.w);else{if($(r,i))return;e.uniform4fv(this.addr,i),ee(r,i)}}function es(e,i){let r=this.cache,n=i.elements;if(void 0===n){if($(r,i))return;e.uniformMatrix2fv(this.addr,!1,i),ee(r,i)}else{if($(r,n))return;Z.set(n),e.uniformMatrix2fv(this.addr,!1,Z),ee(r,n)}}function eo(e,i){let r=this.cache,n=i.elements;if(void 0===n){if($(r,i))return;e.uniformMatrix3fv(this.addr,!1,i),ee(r,i)}else{if($(r,n))return;J.set(n),e.uniformMatrix3fv(this.addr,!1,J),ee(r,n)}}function el(e,i){let r=this.cache,n=i.elements;if(void 0===n){if($(r,i))return;e.uniformMatrix4fv(this.addr,!1,i),ee(r,i)}else{if($(r,n))return;K.set(n),e.uniformMatrix4fv(this.addr,!1,K),ee(r,n)}}function ec(e,i){let r=this.cache;r[0]!==i&&(e.uniform1i(this.addr,i),r[0]=i)}function eh(e,i){let r=this.cache;if(void 0!==i.x)(r[0]!==i.x||r[1]!==i.y)&&(e.uniform2i(this.addr,i.x,i.y),r[0]=i.x,r[1]=i.y);else{if($(r,i))return;e.uniform2iv(this.addr,i),ee(r,i)}}function eu(e,i){let r=this.cache;if(void 0!==i.x)(r[0]!==i.x||r[1]!==i.y||r[2]!==i.z)&&(e.uniform3i(this.addr,i.x,i.y,i.z),r[0]=i.x,r[1]=i.y,r[2]=i.z);else{if($(r,i))return;e.uniform3iv(this.addr,i),ee(r,i)}}function ed(e,i){let r=this.cache;if(void 0!==i.x)(r[0]!==i.x||r[1]!==i.y||r[2]!==i.z||r[3]!==i.w)&&(e.uniform4i(this.addr,i.x,i.y,i.z,i.w),r[0]=i.x,r[1]=i.y,r[2]=i.z,r[3]=i.w);else{if($(r,i))return;e.uniform4iv(this.addr,i),ee(r,i)}}function ep(e,i){let r=this.cache;r[0]!==i&&(e.uniform1ui(this.addr,i),r[0]=i)}function ef(e,i){let r=this.cache;if(void 0!==i.x)(r[0]!==i.x||r[1]!==i.y)&&(e.uniform2ui(this.addr,i.x,i.y),r[0]=i.x,r[1]=i.y);else{if($(r,i))return;e.uniform2uiv(this.addr,i),ee(r,i)}}function em(e,i){let r=this.cache;if(void 0!==i.x)(r[0]!==i.x||r[1]!==i.y||r[2]!==i.z)&&(e.uniform3ui(this.addr,i.x,i.y,i.z),r[0]=i.x,r[1]=i.y,r[2]=i.z);else{if($(r,i))return;e.uniform3uiv(this.addr,i),ee(r,i)}}function eg(e,i){let r=this.cache;if(void 0!==i.x)(r[0]!==i.x||r[1]!==i.y||r[2]!==i.z||r[3]!==i.w)&&(e.uniform4ui(this.addr,i.x,i.y,i.z,i.w),r[0]=i.x,r[1]=i.y,r[2]=i.z,r[3]=i.w);else{if($(r,i))return;e.uniform4uiv(this.addr,i),ee(r,i)}}function ev(e,i,r){let a,s=this.cache,o=r.allocateTextureUnit();s[0]!==o&&(e.uniform1i(this.addr,o),s[0]=o),this.type===e.SAMPLER_2D_SHADOW?(G.compareFunction=r.isReversedDepthBuffer()?n.gWB:n.TiK,a=G):a=H,r.setTexture2D(i||a,o)}function e_(e,i,r){let n=this.cache,a=r.allocateTextureUnit();n[0]!==a&&(e.uniform1i(this.addr,a),n[0]=a),r.setTexture3D(i||X,a)}function ex(e,i,r){let n=this.cache,a=r.allocateTextureUnit();n[0]!==a&&(e.uniform1i(this.addr,a),n[0]=a),r.setTextureCube(i||j,a)}function ey(e,i,r){let n=this.cache,a=r.allocateTextureUnit();n[0]!==a&&(e.uniform1i(this.addr,a),n[0]=a),r.setTexture2DArray(i||W,a)}function eM(e,i){e.uniform1fv(this.addr,i)}function eS(e,i){let r=Q(i,this.size,2);e.uniform2fv(this.addr,r)}function eb(e,i){let r=Q(i,this.size,3);e.uniform3fv(this.addr,r)}function eT(e,i){let r=Q(i,this.size,4);e.uniform4fv(this.addr,r)}function eE(e,i){let r=Q(i,this.size,4);e.uniformMatrix2fv(this.addr,!1,r)}function ew(e,i){let r=Q(i,this.size,9);e.uniformMatrix3fv(this.addr,!1,r)}function eA(e,i){let r=Q(i,this.size,16);e.uniformMatrix4fv(this.addr,!1,r)}function eR(e,i){e.uniform1iv(this.addr,i)}function eC(e,i){e.uniform2iv(this.addr,i)}function eP(e,i){e.uniform3iv(this.addr,i)}function eI(e,i){e.uniform4iv(this.addr,i)}function eL(e,i){e.uniform1uiv(this.addr,i)}function eD(e,i){e.uniform2uiv(this.addr,i)}function eU(e,i){e.uniform3uiv(this.addr,i)}function eN(e,i){e.uniform4uiv(this.addr,i)}function eO(e,i,r){let n,a=this.cache,s=i.length,o=et(r,s);$(a,o)||(e.uniform1iv(this.addr,o),ee(a,o)),n=this.type===e.SAMPLER_2D_SHADOW?G:H;for(let e=0;e!==s;++e)r.setTexture2D(i[e]||n,o[e])}function eF(e,i,r){let n=this.cache,a=i.length,s=et(r,a);$(n,s)||(e.uniform1iv(this.addr,s),ee(n,s));for(let e=0;e!==a;++e)r.setTexture3D(i[e]||X,s[e])}function eB(e,i,r){let n=this.cache,a=i.length,s=et(r,a);$(n,s)||(e.uniform1iv(this.addr,s),ee(n,s));for(let e=0;e!==a;++e)r.setTextureCube(i[e]||j,s[e])}function ez(e,i,r){let n=this.cache,a=i.length,s=et(r,a);$(n,s)||(e.uniform1iv(this.addr,s),ee(n,s));for(let e=0;e!==a;++e)r.setTexture2DArray(i[e]||W,s[e])}class ek{constructor(e,i,r){this.id=e,this.addr=r,this.cache=[],this.type=i.type,this.setValue=function(e){switch(e){case 5126:return ei;case 35664:return er;case 35665:return en;case 35666:return ea;case 35674:return es;case 35675:return eo;case 35676:return el;case 5124:case 35670:return ec;case 35667:case 35671:return eh;case 35668:case 35672:return eu;case 35669:case 35673:return ed;case 5125:return ep;case 36294:return ef;case 36295:return em;case 36296:return eg;case 35678:case 36198:case 36298:case 36306:case 35682:return ev;case 35679:case 36299:case 36307:return e_;case 35680:case 36300:case 36308:case 36293:return ex;case 36289:case 36303:case 36311:case 36292:return ey}}(i.type)}}class eV{constructor(e,i,r){this.id=e,this.addr=r,this.cache=[],this.type=i.type,this.size=i.size,this.setValue=function(e){switch(e){case 5126:return eM;case 35664:return eS;case 35665:return eb;case 35666:return eT;case 35674:return eE;case 35675:return ew;case 35676:return eA;case 5124:case 35670:return eR;case 35667:case 35671:return eC;case 35668:case 35672:return eP;case 35669:case 35673:return eI;case 5125:return eL;case 36294:return eD;case 36295:return eU;case 36296:return eN;case 35678:case 36198:case 36298:case 36306:case 35682:return eO;case 35679:case 36299:case 36307:return eF;case 35680:case 36300:case 36308:case 36293:return eB;case 36289:case 36303:case 36311:case 36292:return ez}}(i.type)}}class eH{constructor(e){this.id=e,this.seq=[],this.map={}}setValue(e,i,r){let n=this.seq;for(let a=0,s=n.length;a!==s;++a){let s=n[a];s.setValue(e,i[s.id],r)}}}let eG=/(\w+)(\])?(\[|\.)?/g;function eW(e,i){e.seq.push(i),e.map[i.id]=i}class eX{constructor(e,i){this.seq=[],this.map={};const r=e.getProgramParameter(i,e.ACTIVE_UNIFORMS);for(let n=0;n<r;++n){const r=e.getActiveUniform(i,n),a=e.getUniformLocation(i,r.name);!function(e,i,r){let n=e.name,a=n.length;for(eG.lastIndex=0;;){let s=eG.exec(n),o=eG.lastIndex,l=s[1],c="]"===s[2],h=s[3];if(c&&(l|=0),void 0===h||"["===h&&o+2===a){eW(r,void 0===h?new ek(l,e,i):new eV(l,e,i));break}{let e=r.map[l];void 0===e&&eW(r,e=new eH(l)),r=e}}}(r,a,this)}const n=[],a=[];for(const i of this.seq)i.type===e.SAMPLER_2D_SHADOW||i.type===e.SAMPLER_CUBE_SHADOW||i.type===e.SAMPLER_2D_ARRAY_SHADOW?n.push(i):a.push(i);n.length>0&&(this.seq=n.concat(a))}setValue(e,i,r,n){let a=this.map[i];void 0!==a&&a.setValue(e,r,n)}setOptional(e,i,r){let n=i[r];void 0!==n&&this.setValue(e,r,n)}static upload(e,i,r,n){for(let a=0,s=i.length;a!==s;++a){let s=i[a],o=r[s.id];!1!==o.needsUpdate&&s.setValue(e,o.value,n)}}static seqWithValue(e,i){let r=[];for(let n=0,a=e.length;n!==a;++n){let a=e[n];a.id in i&&r.push(a)}return r}}function ej(e,i,r){let n=e.createShader(i);return e.shaderSource(n,r),e.compileShader(n),n}let eq=0,eY=new n.dwI;function eK(e,i,r){let n=e.getShaderParameter(i,e.COMPILE_STATUS),a=(e.getShaderInfoLog(i)||"").trim();if(n&&""===a)return"";let s=/ERROR: 0:(\d+)/.exec(a);if(!s)return a;{let n=parseInt(s[1]);return r.toUpperCase()+`

 `+a+`

 `+function(e,i){let r=e.split(`
 `),n=[],a=Math.max(i-6,0),s=Math.min(i+6,r.length);for(let e=a;e<s;e++){let a=e+1;n.push(`${a===i?">":" "} ${a}: ${r[e]}`)}return n.join(`
@@ -3931,20 +3930,20 @@ void main() {
	precision ${e.precision} usamplerCube;
	precision ${e.precision} usampler2DArray;
	`;return"highp"===e.precision?i+=`
 #define HIGH_PRECISION`:"mediump"===e.precision?i+=`
 #define MEDIUM_PRECISION`:"lowp"===e.precision&&(i+=`
-#define LOW_PRECISION`),i}let e7={[n.QP0]:"SHADOWMAP_TYPE_PCF",[n.RyA]:"SHADOWMAP_TYPE_VSM"},te={[n.hy7]:"ENVMAP_TYPE_CUBE",[n.xFO]:"ENVMAP_TYPE_CUBE",[n.Om]:"ENVMAP_TYPE_CUBE_UV"},tt={[n.xFO]:"ENVMAP_MODE_REFRACTION"},ti={[n.caT]:"ENVMAP_BLENDING_MULTIPLY",[n.KRh]:"ENVMAP_BLENDING_MIX",[n.XrR]:"ENVMAP_BLENDING_ADD"};function tr(e,i,r,a){var s,l;let c,h,u,d,p=e.getContext(),f=r.defines,m=r.vertexShader,g=r.fragmentShader,v=e7[r.shadowMapType]||"SHADOWMAP_TYPE_BASIC",_=!1===r.envMap?"ENVMAP_TYPE_CUBE":te[r.envMapMode]||"ENVMAP_TYPE_CUBE",y=!1===r.envMap?"ENVMAP_MODE_REFLECTION":tt[r.envMapMode]||"ENVMAP_MODE_REFLECTION",x=!1===r.envMap?"ENVMAP_BLENDING_NONE":ti[r.combine]||"ENVMAP_BLENDING_NONE",M=function(e){let i=e.envMapCubeUVHeight;if(null===i)return null;let r=Math.log2(i)-2;return{texelWidth:1/(3*Math.max(Math.pow(2,r),112)),texelHeight:1/i,maxMip:r}}(r),S=[r.extensionClipCullDistance?"#extension GL_ANGLE_clip_cull_distance : require":"",r.extensionMultiDraw?"#extension GL_ANGLE_multi_draw : require":""].filter(eQ).join(`
+#define LOW_PRECISION`),i}let e7={[n.QP0]:"SHADOWMAP_TYPE_PCF",[n.RyA]:"SHADOWMAP_TYPE_VSM"},te={[n.hy7]:"ENVMAP_TYPE_CUBE",[n.xFO]:"ENVMAP_TYPE_CUBE",[n.Om]:"ENVMAP_TYPE_CUBE_UV"},tt={[n.xFO]:"ENVMAP_MODE_REFRACTION"},ti={[n.caT]:"ENVMAP_BLENDING_MULTIPLY",[n.KRh]:"ENVMAP_BLENDING_MIX",[n.XrR]:"ENVMAP_BLENDING_ADD"};function tr(e,i,r,a){var s,l;let c,h,u,d,p=e.getContext(),f=r.defines,m=r.vertexShader,g=r.fragmentShader,v=e7[r.shadowMapType]||"SHADOWMAP_TYPE_BASIC",_=!1===r.envMap?"ENVMAP_TYPE_CUBE":te[r.envMapMode]||"ENVMAP_TYPE_CUBE",x=!1===r.envMap?"ENVMAP_MODE_REFLECTION":tt[r.envMapMode]||"ENVMAP_MODE_REFLECTION",y=!1===r.envMap?"ENVMAP_BLENDING_NONE":ti[r.combine]||"ENVMAP_BLENDING_NONE",M=function(e){let i=e.envMapCubeUVHeight;if(null===i)return null;let r=Math.log2(i)-2;return{texelWidth:1/(3*Math.max(Math.pow(2,r),112)),texelHeight:1/i,maxMip:r}}(r),S=[r.extensionClipCullDistance?"#extension GL_ANGLE_clip_cull_distance : require":"",r.extensionMultiDraw?"#extension GL_ANGLE_multi_draw : require":""].filter(eQ).join(`
 `),b=function(e){let i=[];for(let r in e){let n=e[r];!1!==n&&i.push("#define "+r+" "+n)}return i.join(`
 `)}(f),T=p.createProgram(),E=r.glslVersion?"#version "+r.glslVersion+`
 `:"";if(r.isRawShaderMaterial)(c=["#define SHADER_TYPE "+r.shaderType,"#define SHADER_NAME "+r.shaderName,b].filter(eQ).join(`
 `)).length>0&&(c+=`
 `),(h=["#define SHADER_TYPE "+r.shaderType,"#define SHADER_NAME "+r.shaderName,b].filter(eQ).join(`
 `)).length>0&&(h+=`
-`);else{let e,i,a,u,d;c=[e9(r),"#define SHADER_TYPE "+r.shaderType,"#define SHADER_NAME "+r.shaderName,b,r.extensionClipCullDistance?"#define USE_CLIP_DISTANCE":"",r.batching?"#define USE_BATCHING":"",r.batchingColor?"#define USE_BATCHING_COLOR":"",r.instancing?"#define USE_INSTANCING":"",r.instancingColor?"#define USE_INSTANCING_COLOR":"",r.instancingMorph?"#define USE_INSTANCING_MORPH":"",r.useFog&&r.fog?"#define USE_FOG":"",r.useFog&&r.fogExp2?"#define FOG_EXP2":"",r.map?"#define USE_MAP":"",r.envMap?"#define USE_ENVMAP":"",r.envMap?"#define "+y:"",r.lightMap?"#define USE_LIGHTMAP":"",r.aoMap?"#define USE_AOMAP":"",r.bumpMap?"#define USE_BUMPMAP":"",r.normalMap?"#define USE_NORMALMAP":"",r.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",r.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",r.displacementMap?"#define USE_DISPLACEMENTMAP":"",r.emissiveMap?"#define USE_EMISSIVEMAP":"",r.anisotropy?"#define USE_ANISOTROPY":"",r.anisotropyMap?"#define USE_ANISOTROPYMAP":"",r.clearcoatMap?"#define USE_CLEARCOATMAP":"",r.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",r.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",r.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",r.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",r.specularMap?"#define USE_SPECULARMAP":"",r.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",r.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",r.roughnessMap?"#define USE_ROUGHNESSMAP":"",r.metalnessMap?"#define USE_METALNESSMAP":"",r.alphaMap?"#define USE_ALPHAMAP":"",r.alphaHash?"#define USE_ALPHAHASH":"",r.transmission?"#define USE_TRANSMISSION":"",r.transmissionMap?"#define USE_TRANSMISSIONMAP":"",r.thicknessMap?"#define USE_THICKNESSMAP":"",r.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",r.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",r.mapUv?"#define MAP_UV "+r.mapUv:"",r.alphaMapUv?"#define ALPHAMAP_UV "+r.alphaMapUv:"",r.lightMapUv?"#define LIGHTMAP_UV "+r.lightMapUv:"",r.aoMapUv?"#define AOMAP_UV "+r.aoMapUv:"",r.emissiveMapUv?"#define EMISSIVEMAP_UV "+r.emissiveMapUv:"",r.bumpMapUv?"#define BUMPMAP_UV "+r.bumpMapUv:"",r.normalMapUv?"#define NORMALMAP_UV "+r.normalMapUv:"",r.displacementMapUv?"#define DISPLACEMENTMAP_UV "+r.displacementMapUv:"",r.metalnessMapUv?"#define METALNESSMAP_UV "+r.metalnessMapUv:"",r.roughnessMapUv?"#define ROUGHNESSMAP_UV "+r.roughnessMapUv:"",r.anisotropyMapUv?"#define ANISOTROPYMAP_UV "+r.anisotropyMapUv:"",r.clearcoatMapUv?"#define CLEARCOATMAP_UV "+r.clearcoatMapUv:"",r.clearcoatNormalMapUv?"#define CLEARCOAT_NORMALMAP_UV "+r.clearcoatNormalMapUv:"",r.clearcoatRoughnessMapUv?"#define CLEARCOAT_ROUGHNESSMAP_UV "+r.clearcoatRoughnessMapUv:"",r.iridescenceMapUv?"#define IRIDESCENCEMAP_UV "+r.iridescenceMapUv:"",r.iridescenceThicknessMapUv?"#define IRIDESCENCE_THICKNESSMAP_UV "+r.iridescenceThicknessMapUv:"",r.sheenColorMapUv?"#define SHEEN_COLORMAP_UV "+r.sheenColorMapUv:"",r.sheenRoughnessMapUv?"#define SHEEN_ROUGHNESSMAP_UV "+r.sheenRoughnessMapUv:"",r.specularMapUv?"#define SPECULARMAP_UV "+r.specularMapUv:"",r.specularColorMapUv?"#define SPECULAR_COLORMAP_UV "+r.specularColorMapUv:"",r.specularIntensityMapUv?"#define SPECULAR_INTENSITYMAP_UV "+r.specularIntensityMapUv:"",r.transmissionMapUv?"#define TRANSMISSIONMAP_UV "+r.transmissionMapUv:"",r.thicknessMapUv?"#define THICKNESSMAP_UV "+r.thicknessMapUv:"",r.vertexTangents&&!1===r.flatShading?"#define USE_TANGENT":"",r.vertexColors?"#define USE_COLOR":"",r.vertexAlphas?"#define USE_COLOR_ALPHA":"",r.vertexUv1s?"#define USE_UV1":"",r.vertexUv2s?"#define USE_UV2":"",r.vertexUv3s?"#define USE_UV3":"",r.pointsUvs?"#define USE_POINTS_UV":"",r.flatShading?"#define FLAT_SHADED":"",r.skinning?"#define USE_SKINNING":"",r.morphTargets?"#define USE_MORPHTARGETS":"",r.morphNormals&&!1===r.flatShading?"#define USE_MORPHNORMALS":"",r.morphColors?"#define USE_MORPHCOLORS":"",r.morphTargetsCount>0?"#define MORPHTARGETS_TEXTURE_STRIDE "+r.morphTextureStride:"",r.morphTargetsCount>0?"#define MORPHTARGETS_COUNT "+r.morphTargetsCount:"",r.doubleSided?"#define DOUBLE_SIDED":"",r.flipSided?"#define FLIP_SIDED":"",r.shadowMapEnabled?"#define USE_SHADOWMAP":"",r.shadowMapEnabled?"#define "+v:"",r.sizeAttenuation?"#define USE_SIZEATTENUATION":"",r.numLightProbes>0?"#define USE_LIGHT_PROBES":"",r.logarithmicDepthBuffer?"#define USE_LOGARITHMIC_DEPTH_BUFFER":"",r.reversedDepthBuffer?"#define USE_REVERSED_DEPTH_BUFFER":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","	attribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","	attribute vec3 instanceColor;","#endif","#ifdef USE_INSTANCING_MORPH","	uniform sampler2D morphTexture;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_UV1","	attribute vec2 uv1;","#endif","#ifdef USE_UV2","	attribute vec2 uv2;","#endif","#ifdef USE_UV3","	attribute vec2 uv3;","#endif","#ifdef USE_TANGENT","	attribute vec4 tangent;","#endif","#if defined( USE_COLOR_ALPHA )","	attribute vec4 color;","#elif defined( USE_COLOR )","	attribute vec3 color;","#endif","#ifdef USE_SKINNING","	attribute vec4 skinIndex;","	attribute vec4 skinWeight;","#endif",`
+`);else{let e,i,a,u,d;c=[e9(r),"#define SHADER_TYPE "+r.shaderType,"#define SHADER_NAME "+r.shaderName,b,r.extensionClipCullDistance?"#define USE_CLIP_DISTANCE":"",r.batching?"#define USE_BATCHING":"",r.batchingColor?"#define USE_BATCHING_COLOR":"",r.instancing?"#define USE_INSTANCING":"",r.instancingColor?"#define USE_INSTANCING_COLOR":"",r.instancingMorph?"#define USE_INSTANCING_MORPH":"",r.useFog&&r.fog?"#define USE_FOG":"",r.useFog&&r.fogExp2?"#define FOG_EXP2":"",r.map?"#define USE_MAP":"",r.envMap?"#define USE_ENVMAP":"",r.envMap?"#define "+x:"",r.lightMap?"#define USE_LIGHTMAP":"",r.aoMap?"#define USE_AOMAP":"",r.bumpMap?"#define USE_BUMPMAP":"",r.normalMap?"#define USE_NORMALMAP":"",r.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",r.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",r.displacementMap?"#define USE_DISPLACEMENTMAP":"",r.emissiveMap?"#define USE_EMISSIVEMAP":"",r.anisotropy?"#define USE_ANISOTROPY":"",r.anisotropyMap?"#define USE_ANISOTROPYMAP":"",r.clearcoatMap?"#define USE_CLEARCOATMAP":"",r.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",r.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",r.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",r.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",r.specularMap?"#define USE_SPECULARMAP":"",r.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",r.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",r.roughnessMap?"#define USE_ROUGHNESSMAP":"",r.metalnessMap?"#define USE_METALNESSMAP":"",r.alphaMap?"#define USE_ALPHAMAP":"",r.alphaHash?"#define USE_ALPHAHASH":"",r.transmission?"#define USE_TRANSMISSION":"",r.transmissionMap?"#define USE_TRANSMISSIONMAP":"",r.thicknessMap?"#define USE_THICKNESSMAP":"",r.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",r.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",r.mapUv?"#define MAP_UV "+r.mapUv:"",r.alphaMapUv?"#define ALPHAMAP_UV "+r.alphaMapUv:"",r.lightMapUv?"#define LIGHTMAP_UV "+r.lightMapUv:"",r.aoMapUv?"#define AOMAP_UV "+r.aoMapUv:"",r.emissiveMapUv?"#define EMISSIVEMAP_UV "+r.emissiveMapUv:"",r.bumpMapUv?"#define BUMPMAP_UV "+r.bumpMapUv:"",r.normalMapUv?"#define NORMALMAP_UV "+r.normalMapUv:"",r.displacementMapUv?"#define DISPLACEMENTMAP_UV "+r.displacementMapUv:"",r.metalnessMapUv?"#define METALNESSMAP_UV "+r.metalnessMapUv:"",r.roughnessMapUv?"#define ROUGHNESSMAP_UV "+r.roughnessMapUv:"",r.anisotropyMapUv?"#define ANISOTROPYMAP_UV "+r.anisotropyMapUv:"",r.clearcoatMapUv?"#define CLEARCOATMAP_UV "+r.clearcoatMapUv:"",r.clearcoatNormalMapUv?"#define CLEARCOAT_NORMALMAP_UV "+r.clearcoatNormalMapUv:"",r.clearcoatRoughnessMapUv?"#define CLEARCOAT_ROUGHNESSMAP_UV "+r.clearcoatRoughnessMapUv:"",r.iridescenceMapUv?"#define IRIDESCENCEMAP_UV "+r.iridescenceMapUv:"",r.iridescenceThicknessMapUv?"#define IRIDESCENCE_THICKNESSMAP_UV "+r.iridescenceThicknessMapUv:"",r.sheenColorMapUv?"#define SHEEN_COLORMAP_UV "+r.sheenColorMapUv:"",r.sheenRoughnessMapUv?"#define SHEEN_ROUGHNESSMAP_UV "+r.sheenRoughnessMapUv:"",r.specularMapUv?"#define SPECULARMAP_UV "+r.specularMapUv:"",r.specularColorMapUv?"#define SPECULAR_COLORMAP_UV "+r.specularColorMapUv:"",r.specularIntensityMapUv?"#define SPECULAR_INTENSITYMAP_UV "+r.specularIntensityMapUv:"",r.transmissionMapUv?"#define TRANSMISSIONMAP_UV "+r.transmissionMapUv:"",r.thicknessMapUv?"#define THICKNESSMAP_UV "+r.thicknessMapUv:"",r.vertexTangents&&!1===r.flatShading?"#define USE_TANGENT":"",r.vertexColors?"#define USE_COLOR":"",r.vertexAlphas?"#define USE_COLOR_ALPHA":"",r.vertexUv1s?"#define USE_UV1":"",r.vertexUv2s?"#define USE_UV2":"",r.vertexUv3s?"#define USE_UV3":"",r.pointsUvs?"#define USE_POINTS_UV":"",r.flatShading?"#define FLAT_SHADED":"",r.skinning?"#define USE_SKINNING":"",r.morphTargets?"#define USE_MORPHTARGETS":"",r.morphNormals&&!1===r.flatShading?"#define USE_MORPHNORMALS":"",r.morphColors?"#define USE_MORPHCOLORS":"",r.morphTargetsCount>0?"#define MORPHTARGETS_TEXTURE_STRIDE "+r.morphTextureStride:"",r.morphTargetsCount>0?"#define MORPHTARGETS_COUNT "+r.morphTargetsCount:"",r.doubleSided?"#define DOUBLE_SIDED":"",r.flipSided?"#define FLIP_SIDED":"",r.shadowMapEnabled?"#define USE_SHADOWMAP":"",r.shadowMapEnabled?"#define "+v:"",r.sizeAttenuation?"#define USE_SIZEATTENUATION":"",r.numLightProbes>0?"#define USE_LIGHT_PROBES":"",r.logarithmicDepthBuffer?"#define USE_LOGARITHMIC_DEPTH_BUFFER":"",r.reversedDepthBuffer?"#define USE_REVERSED_DEPTH_BUFFER":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","	attribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","	attribute vec3 instanceColor;","#endif","#ifdef USE_INSTANCING_MORPH","	uniform sampler2D morphTexture;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_UV1","	attribute vec2 uv1;","#endif","#ifdef USE_UV2","	attribute vec2 uv2;","#endif","#ifdef USE_UV3","	attribute vec2 uv3;","#endif","#ifdef USE_TANGENT","	attribute vec4 tangent;","#endif","#if defined( USE_COLOR_ALPHA )","	attribute vec4 color;","#elif defined( USE_COLOR )","	attribute vec3 color;","#endif","#ifdef USE_SKINNING","	attribute vec4 skinIndex;","	attribute vec4 skinWeight;","#endif",`
 `].filter(eQ).join(`
-`),h=[e9(r),"#define SHADER_TYPE "+r.shaderType,"#define SHADER_NAME "+r.shaderName,b,r.useFog&&r.fog?"#define USE_FOG":"",r.useFog&&r.fogExp2?"#define FOG_EXP2":"",r.alphaToCoverage?"#define ALPHA_TO_COVERAGE":"",r.map?"#define USE_MAP":"",r.matcap?"#define USE_MATCAP":"",r.envMap?"#define USE_ENVMAP":"",r.envMap?"#define "+_:"",r.envMap?"#define "+y:"",r.envMap?"#define "+x:"",M?"#define CUBEUV_TEXEL_WIDTH "+M.texelWidth:"",M?"#define CUBEUV_TEXEL_HEIGHT "+M.texelHeight:"",M?"#define CUBEUV_MAX_MIP "+M.maxMip+".0":"",r.lightMap?"#define USE_LIGHTMAP":"",r.aoMap?"#define USE_AOMAP":"",r.bumpMap?"#define USE_BUMPMAP":"",r.normalMap?"#define USE_NORMALMAP":"",r.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",r.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",r.emissiveMap?"#define USE_EMISSIVEMAP":"",r.anisotropy?"#define USE_ANISOTROPY":"",r.anisotropyMap?"#define USE_ANISOTROPYMAP":"",r.clearcoat?"#define USE_CLEARCOAT":"",r.clearcoatMap?"#define USE_CLEARCOATMAP":"",r.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",r.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",r.dispersion?"#define USE_DISPERSION":"",r.iridescence?"#define USE_IRIDESCENCE":"",r.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",r.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",r.specularMap?"#define USE_SPECULARMAP":"",r.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",r.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",r.roughnessMap?"#define USE_ROUGHNESSMAP":"",r.metalnessMap?"#define USE_METALNESSMAP":"",r.alphaMap?"#define USE_ALPHAMAP":"",r.alphaTest?"#define USE_ALPHATEST":"",r.alphaHash?"#define USE_ALPHAHASH":"",r.sheen?"#define USE_SHEEN":"",r.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",r.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",r.transmission?"#define USE_TRANSMISSION":"",r.transmissionMap?"#define USE_TRANSMISSIONMAP":"",r.thicknessMap?"#define USE_THICKNESSMAP":"",r.vertexTangents&&!1===r.flatShading?"#define USE_TANGENT":"",r.vertexColors||r.instancingColor||r.batchingColor?"#define USE_COLOR":"",r.vertexAlphas?"#define USE_COLOR_ALPHA":"",r.vertexUv1s?"#define USE_UV1":"",r.vertexUv2s?"#define USE_UV2":"",r.vertexUv3s?"#define USE_UV3":"",r.pointsUvs?"#define USE_POINTS_UV":"",r.gradientMap?"#define USE_GRADIENTMAP":"",r.flatShading?"#define FLAT_SHADED":"",r.doubleSided?"#define DOUBLE_SIDED":"",r.flipSided?"#define FLIP_SIDED":"",r.shadowMapEnabled?"#define USE_SHADOWMAP":"",r.shadowMapEnabled?"#define "+v:"",r.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",r.numLightProbes>0?"#define USE_LIGHT_PROBES":"",r.decodeVideoTexture?"#define DECODE_VIDEO_TEXTURE":"",r.decodeVideoTextureEmissive?"#define DECODE_VIDEO_TEXTURE_EMISSIVE":"",r.logarithmicDepthBuffer?"#define USE_LOGARITHMIC_DEPTH_BUFFER":"",r.reversedDepthBuffer?"#define USE_REVERSED_DEPTH_BUFFER":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",r.toneMapping!==n.y_p?"#define TONE_MAPPING":"",r.toneMapping!==n.y_p?o.tonemapping_pars_fragment:"",r.toneMapping!==n.y_p?(s="toneMapping",void 0===(e=eJ[l=r.toneMapping])?((0,n.R8M)("WebGLProgram: Unsupported toneMapping:",l),"vec3 "+s+"( vec3 color ) { return LinearToneMapping( color ); }"):"vec3 "+s+"( vec3 color ) { return "+e+"ToneMapping( color ); }"):"",r.dithering?"#define DITHERING":"",r.opaque?"#define OPAQUE":"",o.colorspace_pars_fragment,(i=function(e){n.ppV._getMatrix(eY,n.ppV.workingColorSpace,e);let i=`mat3( ${eY.elements.map(e=>e.toFixed(4))} )`;switch(n.ppV.getTransfer(e)){case n.VxR:return[i,"LinearTransferOETF"];case n.KLL:return[i,"sRGBTransferOETF"];default:return(0,n.R8M)("WebGLProgram: Unsupported color space: ",e),[i,"LinearTransferOETF"]}}(r.outputColorSpace),`vec4 linearToOutputTexel( vec4 value ) {
+`),h=[e9(r),"#define SHADER_TYPE "+r.shaderType,"#define SHADER_NAME "+r.shaderName,b,r.useFog&&r.fog?"#define USE_FOG":"",r.useFog&&r.fogExp2?"#define FOG_EXP2":"",r.alphaToCoverage?"#define ALPHA_TO_COVERAGE":"",r.map?"#define USE_MAP":"",r.matcap?"#define USE_MATCAP":"",r.envMap?"#define USE_ENVMAP":"",r.envMap?"#define "+_:"",r.envMap?"#define "+x:"",r.envMap?"#define "+y:"",M?"#define CUBEUV_TEXEL_WIDTH "+M.texelWidth:"",M?"#define CUBEUV_TEXEL_HEIGHT "+M.texelHeight:"",M?"#define CUBEUV_MAX_MIP "+M.maxMip+".0":"",r.lightMap?"#define USE_LIGHTMAP":"",r.aoMap?"#define USE_AOMAP":"",r.bumpMap?"#define USE_BUMPMAP":"",r.normalMap?"#define USE_NORMALMAP":"",r.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",r.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",r.emissiveMap?"#define USE_EMISSIVEMAP":"",r.anisotropy?"#define USE_ANISOTROPY":"",r.anisotropyMap?"#define USE_ANISOTROPYMAP":"",r.clearcoat?"#define USE_CLEARCOAT":"",r.clearcoatMap?"#define USE_CLEARCOATMAP":"",r.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",r.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",r.dispersion?"#define USE_DISPERSION":"",r.iridescence?"#define USE_IRIDESCENCE":"",r.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",r.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",r.specularMap?"#define USE_SPECULARMAP":"",r.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",r.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",r.roughnessMap?"#define USE_ROUGHNESSMAP":"",r.metalnessMap?"#define USE_METALNESSMAP":"",r.alphaMap?"#define USE_ALPHAMAP":"",r.alphaTest?"#define USE_ALPHATEST":"",r.alphaHash?"#define USE_ALPHAHASH":"",r.sheen?"#define USE_SHEEN":"",r.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",r.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",r.transmission?"#define USE_TRANSMISSION":"",r.transmissionMap?"#define USE_TRANSMISSIONMAP":"",r.thicknessMap?"#define USE_THICKNESSMAP":"",r.vertexTangents&&!1===r.flatShading?"#define USE_TANGENT":"",r.vertexColors||r.instancingColor||r.batchingColor?"#define USE_COLOR":"",r.vertexAlphas?"#define USE_COLOR_ALPHA":"",r.vertexUv1s?"#define USE_UV1":"",r.vertexUv2s?"#define USE_UV2":"",r.vertexUv3s?"#define USE_UV3":"",r.pointsUvs?"#define USE_POINTS_UV":"",r.gradientMap?"#define USE_GRADIENTMAP":"",r.flatShading?"#define FLAT_SHADED":"",r.doubleSided?"#define DOUBLE_SIDED":"",r.flipSided?"#define FLIP_SIDED":"",r.shadowMapEnabled?"#define USE_SHADOWMAP":"",r.shadowMapEnabled?"#define "+v:"",r.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",r.numLightProbes>0?"#define USE_LIGHT_PROBES":"",r.decodeVideoTexture?"#define DECODE_VIDEO_TEXTURE":"",r.decodeVideoTextureEmissive?"#define DECODE_VIDEO_TEXTURE_EMISSIVE":"",r.logarithmicDepthBuffer?"#define USE_LOGARITHMIC_DEPTH_BUFFER":"",r.reversedDepthBuffer?"#define USE_REVERSED_DEPTH_BUFFER":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",r.toneMapping!==n.y_p?"#define TONE_MAPPING":"",r.toneMapping!==n.y_p?o.tonemapping_pars_fragment:"",r.toneMapping!==n.y_p?(s="toneMapping",void 0===(e=eJ[l=r.toneMapping])?((0,n.R8M)("WebGLProgram: Unsupported toneMapping:",l),"vec3 "+s+"( vec3 color ) { return LinearToneMapping( color ); }"):"vec3 "+s+"( vec3 color ) { return "+e+"ToneMapping( color ); }"):"",r.dithering?"#define DITHERING":"",r.opaque?"#define OPAQUE":"",o.colorspace_pars_fragment,(i=function(e){n.ppV._getMatrix(eY,n.ppV.workingColorSpace,e);let i=`mat3( ${eY.elements.map(e=>e.toFixed(4))} )`;switch(n.ppV.getTransfer(e)){case n.VxR:return[i,"LinearTransferOETF"];case n.KLL:return[i,"sRGBTransferOETF"];default:return(0,n.R8M)("WebGLProgram: Unsupported color space: ",e),[i,"LinearTransferOETF"]}}(r.outputColorSpace),`vec4 linearToOutputTexel( vec4 value ) {
	return ${i[1]}( vec4( value.rgb * ${i[0]}, value.a ) );
 }`),(n.ppV.getLuminanceCoefficients(eZ),a=eZ.x.toFixed(4),u=eZ.y.toFixed(4),d=eZ.z.toFixed(4),`float luminance( const in vec3 rgb ) {
	const vec3 weights = vec3( ${a}, ${u}, ${d} );
	return dot( weights, rgb );
 }`),r.useDepthPacking?"#define DEPTH_PACKING "+r.depthPacking:"",`
@@ -3970,13 +3969,13 @@ void main() {
 Material Name: `+i.name+`
 Material Type: `+i.type+`

 Program Info Log: `+o+`
 `+e+`
-`+r)}else""!==o?(0,n.R8M)("WebGLProgram: Program Info Log:",o):(""===l||""===u)&&(f=!1);f&&(i.diagnostics={runnable:d,programLog:o,vertexShader:{log:l,prefix:c},fragmentShader:{log:u,prefix:h}})}p.deleteShader(R),p.deleteShader(C),u=new eX(p,T),d=function(e,i){let r={},n=e.getProgramParameter(i,e.ACTIVE_ATTRIBUTES);for(let a=0;a<n;a++){let n=e.getActiveAttrib(i,a),s=n.name,o=1;n.type===e.FLOAT_MAT2&&(o=2),n.type===e.FLOAT_MAT3&&(o=3),n.type===e.FLOAT_MAT4&&(o=4),r[s]={type:n.type,location:e.getAttribLocation(i,s),locationSize:o}}return r}(p,T)}p.attachShader(T,R),p.attachShader(T,C),void 0!==r.index0AttributeName?p.bindAttribLocation(T,0,r.index0AttributeName):!0===r.morphTargets&&p.bindAttribLocation(T,0,"position"),p.linkProgram(T),this.getUniforms=function(){return void 0===u&&P(this),u},this.getAttributes=function(){return void 0===d&&P(this),d};let I=!1===r.rendererExtensionParallelShaderCompile;return this.isReady=function(){return!1===I&&(I=p.getProgramParameter(T,37297)),I},this.destroy=function(){a.releaseStatesOfProgram(this),p.deleteProgram(T),this.program=void 0},this.type=r.shaderType,this.name=r.shaderName,this.id=eq++,this.cacheKey=i,this.usedTimes=1,this.program=T,this.vertexShader=R,this.fragmentShader=C,this}let tn=0;class ta{constructor(){this.shaderCache=new Map,this.materialCache=new Map}update(e){let i=e.vertexShader,r=e.fragmentShader,n=this._getShaderStage(i),a=this._getShaderStage(r),s=this._getShaderCacheForMaterial(e);return!1===s.has(n)&&(s.add(n),n.usedTimes++),!1===s.has(a)&&(s.add(a),a.usedTimes++),this}remove(e){for(let i of this.materialCache.get(e))i.usedTimes--,0===i.usedTimes&&this.shaderCache.delete(i.code);return this.materialCache.delete(e),this}getVertexShaderID(e){return this._getShaderStage(e.vertexShader).id}getFragmentShaderID(e){return this._getShaderStage(e.fragmentShader).id}dispose(){this.shaderCache.clear(),this.materialCache.clear()}_getShaderCacheForMaterial(e){let i=this.materialCache,r=i.get(e);return void 0===r&&(r=new Set,i.set(e,r)),r}_getShaderStage(e){let i=this.shaderCache,r=i.get(e);return void 0===r&&(r=new ts(e),i.set(e,r)),r}}class ts{constructor(e){this.id=tn++,this.code=e,this.usedTimes=0}}function to(e,i,r,a,s,o,l){let h=new n.zgK,u=new ta,d=new Set,p=[],f=new Map,m=s.logarithmicDepthBuffer,g=s.precision,v={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distance",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"};function _(e){return(d.add(e),0===e)?"uv":`uv${e}`}return{getParameters:function(o,h,p,f,y){let x,M,S,b,T=f.fog,E=y.geometry,w=o.isMeshStandardMaterial?f.environment:null,A=(o.isMeshStandardMaterial?r:i).get(o.envMap||w),R=A&&A.mapping===n.Om?A.image.height:null,C=v[o.type];null!==o.precision&&(g=s.getMaxPrecision(o.precision))!==o.precision&&(0,n.R8M)("WebGLProgram.getParameters:",o.precision,"not supported, using",g,"instead.");let P=E.morphAttributes.position||E.morphAttributes.normal||E.morphAttributes.color,I=void 0!==P?P.length:0,L=0;if(void 0!==E.morphAttributes.position&&(L=1),void 0!==E.morphAttributes.normal&&(L=2),void 0!==E.morphAttributes.color&&(L=3),C){let e=c[C];x=e.vertexShader,M=e.fragmentShader}else x=o.vertexShader,M=o.fragmentShader,u.update(o),S=u.getVertexShaderID(o),b=u.getFragmentShaderID(o);let D=e.getRenderTarget(),U=e.state.buffers.depth.getReversed(),N=!0===y.isInstancedMesh,O=!0===y.isBatchedMesh,F=!!o.map,B=!!o.matcap,z=!!A,k=!!o.aoMap,V=!!o.lightMap,H=!!o.bumpMap,G=!!o.normalMap,W=!!o.displacementMap,X=!!o.emissiveMap,j=!!o.metalnessMap,q=!!o.roughnessMap,Y=o.anisotropy>0,K=o.clearcoat>0,J=o.dispersion>0,Z=o.iridescence>0,Q=o.sheen>0,$=o.transmission>0,ee=Y&&!!o.anisotropyMap,et=K&&!!o.clearcoatMap,ei=K&&!!o.clearcoatNormalMap,er=K&&!!o.clearcoatRoughnessMap,en=Z&&!!o.iridescenceMap,ea=Z&&!!o.iridescenceThicknessMap,es=Q&&!!o.sheenColorMap,eo=Q&&!!o.sheenRoughnessMap,el=!!o.specularMap,ec=!!o.specularColorMap,eh=!!o.specularIntensityMap,eu=$&&!!o.transmissionMap,ed=$&&!!o.thicknessMap,ep=!!o.gradientMap,ef=!!o.alphaMap,em=o.alphaTest>0,eg=!!o.alphaHash,ev=!!o.extensions,e_=n.y_p;o.toneMapped&&(null===D||!0===D.isXRRenderTarget)&&(e_=e.toneMapping);let ey={shaderID:C,shaderType:o.type,shaderName:o.name,vertexShader:x,fragmentShader:M,defines:o.defines,customVertexShaderID:S,customFragmentShaderID:b,isRawShaderMaterial:!0===o.isRawShaderMaterial,glslVersion:o.glslVersion,precision:g,batching:O,batchingColor:O&&null!==y._colorsTexture,instancing:N,instancingColor:N&&null!==y.instanceColor,instancingMorph:N&&null!==y.morphTexture,outputColorSpace:null===D?e.outputColorSpace:!0===D.isXRRenderTarget?D.texture.colorSpace:n.Zr2,alphaToCoverage:!!o.alphaToCoverage,map:F,matcap:B,envMap:z,envMapMode:z&&A.mapping,envMapCubeUVHeight:R,aoMap:k,lightMap:V,bumpMap:H,normalMap:G,displacementMap:W,emissiveMap:X,normalMapObjectSpace:G&&o.normalMapType===n.vyJ,normalMapTangentSpace:G&&o.normalMapType===n.bI3,metalnessMap:j,roughnessMap:q,anisotropy:Y,anisotropyMap:ee,clearcoat:K,clearcoatMap:et,clearcoatNormalMap:ei,clearcoatRoughnessMap:er,dispersion:J,iridescence:Z,iridescenceMap:en,iridescenceThicknessMap:ea,sheen:Q,sheenColorMap:es,sheenRoughnessMap:eo,specularMap:el,specularColorMap:ec,specularIntensityMap:eh,transmission:$,transmissionMap:eu,thicknessMap:ed,gradientMap:ep,opaque:!1===o.transparent&&o.blending===n.NTi&&!1===o.alphaToCoverage,alphaMap:ef,alphaTest:em,alphaHash:eg,combine:o.combine,mapUv:F&&_(o.map.channel),aoMapUv:k&&_(o.aoMap.channel),lightMapUv:V&&_(o.lightMap.channel),bumpMapUv:H&&_(o.bumpMap.channel),normalMapUv:G&&_(o.normalMap.channel),displacementMapUv:W&&_(o.displacementMap.channel),emissiveMapUv:X&&_(o.emissiveMap.channel),metalnessMapUv:j&&_(o.metalnessMap.channel),roughnessMapUv:q&&_(o.roughnessMap.channel),anisotropyMapUv:ee&&_(o.anisotropyMap.channel),clearcoatMapUv:et&&_(o.clearcoatMap.channel),clearcoatNormalMapUv:ei&&_(o.clearcoatNormalMap.channel),clearcoatRoughnessMapUv:er&&_(o.clearcoatRoughnessMap.channel),iridescenceMapUv:en&&_(o.iridescenceMap.channel),iridescenceThicknessMapUv:ea&&_(o.iridescenceThicknessMap.channel),sheenColorMapUv:es&&_(o.sheenColorMap.channel),sheenRoughnessMapUv:eo&&_(o.sheenRoughnessMap.channel),specularMapUv:el&&_(o.specularMap.channel),specularColorMapUv:ec&&_(o.specularColorMap.channel),specularIntensityMapUv:eh&&_(o.specularIntensityMap.channel),transmissionMapUv:eu&&_(o.transmissionMap.channel),thicknessMapUv:ed&&_(o.thicknessMap.channel),alphaMapUv:ef&&_(o.alphaMap.channel),vertexTangents:!!E.attributes.tangent&&(G||Y),vertexColors:o.vertexColors,vertexAlphas:!0===o.vertexColors&&!!E.attributes.color&&4===E.attributes.color.itemSize,pointsUvs:!0===y.isPoints&&!!E.attributes.uv&&(F||ef),fog:!!T,useFog:!0===o.fog,fogExp2:!!T&&T.isFogExp2,flatShading:!0===o.flatShading&&!1===o.wireframe,sizeAttenuation:!0===o.sizeAttenuation,logarithmicDepthBuffer:m,reversedDepthBuffer:U,skinning:!0===y.isSkinnedMesh,morphTargets:void 0!==E.morphAttributes.position,morphNormals:void 0!==E.morphAttributes.normal,morphColors:void 0!==E.morphAttributes.color,morphTargetsCount:I,morphTextureStride:L,numDirLights:h.directional.length,numPointLights:h.point.length,numSpotLights:h.spot.length,numSpotLightMaps:h.spotLightMap.length,numRectAreaLights:h.rectArea.length,numHemiLights:h.hemi.length,numDirLightShadows:h.directionalShadowMap.length,numPointLightShadows:h.pointShadowMap.length,numSpotLightShadows:h.spotShadowMap.length,numSpotLightShadowsWithMaps:h.numSpotLightShadowsWithMaps,numLightProbes:h.numLightProbes,numClippingPlanes:l.numPlanes,numClipIntersection:l.numIntersection,dithering:o.dithering,shadowMapEnabled:e.shadowMap.enabled&&p.length>0,shadowMapType:e.shadowMap.type,toneMapping:e_,decodeVideoTexture:F&&!0===o.map.isVideoTexture&&n.ppV.getTransfer(o.map.colorSpace)===n.KLL,decodeVideoTextureEmissive:X&&!0===o.emissiveMap.isVideoTexture&&n.ppV.getTransfer(o.emissiveMap.colorSpace)===n.KLL,premultipliedAlpha:o.premultipliedAlpha,doubleSided:o.side===n.$EB,flipSided:o.side===n.hsX,useDepthPacking:o.depthPacking>=0,depthPacking:o.depthPacking||0,index0AttributeName:o.index0AttributeName,extensionClipCullDistance:ev&&!0===o.extensions.clipCullDistance&&a.has("WEBGL_clip_cull_distance"),extensionMultiDraw:(ev&&!0===o.extensions.multiDraw||O)&&a.has("WEBGL_multi_draw"),rendererExtensionParallelShaderCompile:a.has("KHR_parallel_shader_compile"),customProgramCacheKey:o.customProgramCacheKey()};return ey.vertexUv1s=d.has(1),ey.vertexUv2s=d.has(2),ey.vertexUv3s=d.has(3),d.clear(),ey},getProgramCacheKey:function(i){var r,n,a,s;let o=[];if(i.shaderID?o.push(i.shaderID):(o.push(i.customVertexShaderID),o.push(i.customFragmentShaderID)),void 0!==i.defines)for(let e in i.defines)o.push(e),o.push(i.defines[e]);return!1===i.isRawShaderMaterial&&(r=o,n=i,r.push(n.precision),r.push(n.outputColorSpace),r.push(n.envMapMode),r.push(n.envMapCubeUVHeight),r.push(n.mapUv),r.push(n.alphaMapUv),r.push(n.lightMapUv),r.push(n.aoMapUv),r.push(n.bumpMapUv),r.push(n.normalMapUv),r.push(n.displacementMapUv),r.push(n.emissiveMapUv),r.push(n.metalnessMapUv),r.push(n.roughnessMapUv),r.push(n.anisotropyMapUv),r.push(n.clearcoatMapUv),r.push(n.clearcoatNormalMapUv),r.push(n.clearcoatRoughnessMapUv),r.push(n.iridescenceMapUv),r.push(n.iridescenceThicknessMapUv),r.push(n.sheenColorMapUv),r.push(n.sheenRoughnessMapUv),r.push(n.specularMapUv),r.push(n.specularColorMapUv),r.push(n.specularIntensityMapUv),r.push(n.transmissionMapUv),r.push(n.thicknessMapUv),r.push(n.combine),r.push(n.fogExp2),r.push(n.sizeAttenuation),r.push(n.morphTargetsCount),r.push(n.morphAttributeCount),r.push(n.numDirLights),r.push(n.numPointLights),r.push(n.numSpotLights),r.push(n.numSpotLightMaps),r.push(n.numHemiLights),r.push(n.numRectAreaLights),r.push(n.numDirLightShadows),r.push(n.numPointLightShadows),r.push(n.numSpotLightShadows),r.push(n.numSpotLightShadowsWithMaps),r.push(n.numLightProbes),r.push(n.shadowMapType),r.push(n.toneMapping),r.push(n.numClippingPlanes),r.push(n.numClipIntersection),r.push(n.depthPacking),a=o,s=i,h.disableAll(),s.instancing&&h.enable(0),s.instancingColor&&h.enable(1),s.instancingMorph&&h.enable(2),s.matcap&&h.enable(3),s.envMap&&h.enable(4),s.normalMapObjectSpace&&h.enable(5),s.normalMapTangentSpace&&h.enable(6),s.clearcoat&&h.enable(7),s.iridescence&&h.enable(8),s.alphaTest&&h.enable(9),s.vertexColors&&h.enable(10),s.vertexAlphas&&h.enable(11),s.vertexUv1s&&h.enable(12),s.vertexUv2s&&h.enable(13),s.vertexUv3s&&h.enable(14),s.vertexTangents&&h.enable(15),s.anisotropy&&h.enable(16),s.alphaHash&&h.enable(17),s.batching&&h.enable(18),s.dispersion&&h.enable(19),s.batchingColor&&h.enable(20),s.gradientMap&&h.enable(21),a.push(h.mask),h.disableAll(),s.fog&&h.enable(0),s.useFog&&h.enable(1),s.flatShading&&h.enable(2),s.logarithmicDepthBuffer&&h.enable(3),s.reversedDepthBuffer&&h.enable(4),s.skinning&&h.enable(5),s.morphTargets&&h.enable(6),s.morphNormals&&h.enable(7),s.morphColors&&h.enable(8),s.premultipliedAlpha&&h.enable(9),s.shadowMapEnabled&&h.enable(10),s.doubleSided&&h.enable(11),s.flipSided&&h.enable(12),s.useDepthPacking&&h.enable(13),s.dithering&&h.enable(14),s.transmission&&h.enable(15),s.sheen&&h.enable(16),s.opaque&&h.enable(17),s.pointsUvs&&h.enable(18),s.decodeVideoTexture&&h.enable(19),s.decodeVideoTextureEmissive&&h.enable(20),s.alphaToCoverage&&h.enable(21),a.push(h.mask),o.push(e.outputColorSpace)),o.push(i.customProgramCacheKey),o.join()},getUniforms:function(e){let i,r=v[e.type];if(r){let e=c[r];i=n.LlO.clone(e.uniforms)}else i=e.uniforms;return i},acquireProgram:function(i,r){let n=f.get(r);return void 0!==n?++n.usedTimes:(n=new tr(e,r,i,o),p.push(n),f.set(r,n)),n},releaseProgram:function(e){if(0==--e.usedTimes){let i=p.indexOf(e);p[i]=p[p.length-1],p.pop(),f.delete(e.cacheKey),e.destroy()}},releaseShaderCache:function(e){u.remove(e)},programs:p,dispose:function(){u.dispose()}}}function tl(){let e=new WeakMap;return{has:function(i){return e.has(i)},get:function(i){let r=e.get(i);return void 0===r&&(r={},e.set(i,r)),r},remove:function(i){e.delete(i)},update:function(i,r,n){e.get(i)[r]=n},dispose:function(){e=new WeakMap}}}function tc(e,i){return e.groupOrder!==i.groupOrder?e.groupOrder-i.groupOrder:e.renderOrder!==i.renderOrder?e.renderOrder-i.renderOrder:e.material.id!==i.material.id?e.material.id-i.material.id:e.z!==i.z?e.z-i.z:e.id-i.id}function th(e,i){return e.groupOrder!==i.groupOrder?e.groupOrder-i.groupOrder:e.renderOrder!==i.renderOrder?e.renderOrder-i.renderOrder:e.z!==i.z?i.z-e.z:e.id-i.id}function tu(){let e=[],i=0,r=[],n=[],a=[];function s(r,n,a,s,o,l){let c=e[i];return void 0===c?(c={id:r.id,object:r,geometry:n,material:a,groupOrder:s,renderOrder:r.renderOrder,z:o,group:l},e[i]=c):(c.id=r.id,c.object=r,c.geometry=n,c.material=a,c.groupOrder=s,c.renderOrder=r.renderOrder,c.z=o,c.group=l),i++,c}return{opaque:r,transmissive:n,transparent:a,init:function(){i=0,r.length=0,n.length=0,a.length=0},push:function(e,i,o,l,c,h){let u=s(e,i,o,l,c,h);o.transmission>0?n.push(u):!0===o.transparent?a.push(u):r.push(u)},unshift:function(e,i,o,l,c,h){let u=s(e,i,o,l,c,h);o.transmission>0?n.unshift(u):!0===o.transparent?a.unshift(u):r.unshift(u)},finish:function(){for(let r=i,n=e.length;r<n;r++){let i=e[r];if(null===i.id)break;i.id=null,i.object=null,i.geometry=null,i.material=null,i.group=null}},sort:function(e,i){r.length>1&&r.sort(e||tc),n.length>1&&n.sort(i||th),a.length>1&&a.sort(i||th)}}}function td(){let e=new WeakMap;return{get:function(i,r){let n,a=e.get(i);return void 0===a?(n=new tu,e.set(i,[n])):r>=a.length?(n=new tu,a.push(n)):n=a[r],n},dispose:function(){e=new WeakMap}}}function tp(){let e={};return{get:function(i){let r;if(void 0!==e[i.id])return e[i.id];switch(i.type){case"DirectionalLight":r={direction:new n.Pq0,color:new n.Q1f};break;case"SpotLight":r={position:new n.Pq0,direction:new n.Pq0,color:new n.Q1f,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":r={position:new n.Pq0,color:new n.Q1f,distance:0,decay:0};break;case"HemisphereLight":r={direction:new n.Pq0,skyColor:new n.Q1f,groundColor:new n.Q1f};break;case"RectAreaLight":r={color:new n.Q1f,position:new n.Pq0,halfWidth:new n.Pq0,halfHeight:new n.Pq0}}return e[i.id]=r,r}}}let tf=0;function tm(e,i){return 2*!!i.castShadow-2*!!e.castShadow+ +!!i.map-!!e.map}function tg(e){let i,r=new tp,a=(i={},{get:function(e){let r;if(void 0!==i[e.id])return i[e.id];switch(e.type){case"DirectionalLight":case"SpotLight":r={shadowIntensity:1,shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new n.I9Y};break;case"PointLight":r={shadowIntensity:1,shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new n.I9Y,shadowCameraNear:1,shadowCameraFar:1e3}}return i[e.id]=r,r}}),s={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1,numSpotMaps:-1,numLightProbes:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotLightMap:[],spotShadow:[],spotShadowMap:[],spotLightMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[],numSpotLightShadowsWithMaps:0,numLightProbes:0};for(let e=0;e<9;e++)s.probe.push(new n.Pq0);let o=new n.Pq0,c=new n.kn4,h=new n.kn4;return{setup:function(i){let o=0,c=0,h=0;for(let e=0;e<9;e++)s.probe[e].set(0,0,0);let u=0,d=0,p=0,f=0,m=0,g=0,v=0,_=0,y=0,x=0,M=0;i.sort(tm);for(let e=0,l=i.length;e<l;e++){let l=i[e],S=l.color,b=l.intensity,T=l.distance,E=null;if(l.shadow&&l.shadow.map&&(E=l.shadow.map.texture.format===n.paN?l.shadow.map.texture:l.shadow.map.depthTexture||l.shadow.map.texture),l.isAmbientLight)o+=S.r*b,c+=S.g*b,h+=S.b*b;else if(l.isLightProbe){for(let e=0;e<9;e++)s.probe[e].addScaledVector(l.sh.coefficients[e],b);M++}else if(l.isDirectionalLight){let e=r.get(l);if(e.color.copy(l.color).multiplyScalar(l.intensity),l.castShadow){let e=l.shadow,i=a.get(l);i.shadowIntensity=e.intensity,i.shadowBias=e.bias,i.shadowNormalBias=e.normalBias,i.shadowRadius=e.radius,i.shadowMapSize=e.mapSize,s.directionalShadow[u]=i,s.directionalShadowMap[u]=E,s.directionalShadowMatrix[u]=l.shadow.matrix,g++}s.directional[u]=e,u++}else if(l.isSpotLight){let e=r.get(l);e.position.setFromMatrixPosition(l.matrixWorld),e.color.copy(S).multiplyScalar(b),e.distance=T,e.coneCos=Math.cos(l.angle),e.penumbraCos=Math.cos(l.angle*(1-l.penumbra)),e.decay=l.decay,s.spot[p]=e;let i=l.shadow;if(l.map&&(s.spotLightMap[y]=l.map,y++,i.updateMatrices(l),l.castShadow&&x++),s.spotLightMatrix[p]=i.matrix,l.castShadow){let e=a.get(l);e.shadowIntensity=i.intensity,e.shadowBias=i.bias,e.shadowNormalBias=i.normalBias,e.shadowRadius=i.radius,e.shadowMapSize=i.mapSize,s.spotShadow[p]=e,s.spotShadowMap[p]=E,_++}p++}else if(l.isRectAreaLight){let e=r.get(l);e.color.copy(S).multiplyScalar(b),e.halfWidth.set(.5*l.width,0,0),e.halfHeight.set(0,.5*l.height,0),s.rectArea[f]=e,f++}else if(l.isPointLight){let e=r.get(l);if(e.color.copy(l.color).multiplyScalar(l.intensity),e.distance=l.distance,e.decay=l.decay,l.castShadow){let e=l.shadow,i=a.get(l);i.shadowIntensity=e.intensity,i.shadowBias=e.bias,i.shadowNormalBias=e.normalBias,i.shadowRadius=e.radius,i.shadowMapSize=e.mapSize,i.shadowCameraNear=e.camera.near,i.shadowCameraFar=e.camera.far,s.pointShadow[d]=i,s.pointShadowMap[d]=E,s.pointShadowMatrix[d]=l.shadow.matrix,v++}s.point[d]=e,d++}else if(l.isHemisphereLight){let e=r.get(l);e.skyColor.copy(l.color).multiplyScalar(b),e.groundColor.copy(l.groundColor).multiplyScalar(b),s.hemi[m]=e,m++}}f>0&&(!0===e.has("OES_texture_float_linear")?(s.rectAreaLTC1=l.LTC_FLOAT_1,s.rectAreaLTC2=l.LTC_FLOAT_2):(s.rectAreaLTC1=l.LTC_HALF_1,s.rectAreaLTC2=l.LTC_HALF_2)),s.ambient[0]=o,s.ambient[1]=c,s.ambient[2]=h;let S=s.hash;(S.directionalLength!==u||S.pointLength!==d||S.spotLength!==p||S.rectAreaLength!==f||S.hemiLength!==m||S.numDirectionalShadows!==g||S.numPointShadows!==v||S.numSpotShadows!==_||S.numSpotMaps!==y||S.numLightProbes!==M)&&(s.directional.length=u,s.spot.length=p,s.rectArea.length=f,s.point.length=d,s.hemi.length=m,s.directionalShadow.length=g,s.directionalShadowMap.length=g,s.pointShadow.length=v,s.pointShadowMap.length=v,s.spotShadow.length=_,s.spotShadowMap.length=_,s.directionalShadowMatrix.length=g,s.pointShadowMatrix.length=v,s.spotLightMatrix.length=_+y-x,s.spotLightMap.length=y,s.numSpotLightShadowsWithMaps=x,s.numLightProbes=M,S.directionalLength=u,S.pointLength=d,S.spotLength=p,S.rectAreaLength=f,S.hemiLength=m,S.numDirectionalShadows=g,S.numPointShadows=v,S.numSpotShadows=_,S.numSpotMaps=y,S.numLightProbes=M,s.version=tf++)},setupView:function(e,i){let r=0,n=0,a=0,l=0,u=0,d=i.matrixWorldInverse;for(let i=0,p=e.length;i<p;i++){let p=e[i];if(p.isDirectionalLight){let e=s.directional[r];e.direction.setFromMatrixPosition(p.matrixWorld),o.setFromMatrixPosition(p.target.matrixWorld),e.direction.sub(o),e.direction.transformDirection(d),r++}else if(p.isSpotLight){let e=s.spot[a];e.position.setFromMatrixPosition(p.matrixWorld),e.position.applyMatrix4(d),e.direction.setFromMatrixPosition(p.matrixWorld),o.setFromMatrixPosition(p.target.matrixWorld),e.direction.sub(o),e.direction.transformDirection(d),a++}else if(p.isRectAreaLight){let e=s.rectArea[l];e.position.setFromMatrixPosition(p.matrixWorld),e.position.applyMatrix4(d),h.identity(),c.copy(p.matrixWorld),c.premultiply(d),h.extractRotation(c),e.halfWidth.set(.5*p.width,0,0),e.halfHeight.set(0,.5*p.height,0),e.halfWidth.applyMatrix4(h),e.halfHeight.applyMatrix4(h),l++}else if(p.isPointLight){let e=s.point[n];e.position.setFromMatrixPosition(p.matrixWorld),e.position.applyMatrix4(d),n++}else if(p.isHemisphereLight){let e=s.hemi[u];e.direction.setFromMatrixPosition(p.matrixWorld),e.direction.transformDirection(d),u++}}},state:s}}function tv(e){let i=new tg(e),r=[],n=[],a={lightsArray:r,shadowsArray:n,camera:null,lights:i,transmissionRenderTarget:{}};return{init:function(e){a.camera=e,r.length=0,n.length=0},state:a,setupLights:function(){i.setup(r)},setupLightsView:function(e){i.setupView(r,e)},pushLight:function(e){r.push(e)},pushShadow:function(e){n.push(e)}}}function t_(e){let i=new WeakMap;return{get:function(r,n=0){let a,s=i.get(r);return void 0===s?(a=new tv(e),i.set(r,[a])):n>=s.length?(a=new tv(e),s.push(a)):a=s[n],a},dispose:function(){i=new WeakMap}}}let ty=`void main() {
+`+r)}else""!==o?(0,n.R8M)("WebGLProgram: Program Info Log:",o):(""===l||""===u)&&(f=!1);f&&(i.diagnostics={runnable:d,programLog:o,vertexShader:{log:l,prefix:c},fragmentShader:{log:u,prefix:h}})}p.deleteShader(R),p.deleteShader(C),u=new eX(p,T),d=function(e,i){let r={},n=e.getProgramParameter(i,e.ACTIVE_ATTRIBUTES);for(let a=0;a<n;a++){let n=e.getActiveAttrib(i,a),s=n.name,o=1;n.type===e.FLOAT_MAT2&&(o=2),n.type===e.FLOAT_MAT3&&(o=3),n.type===e.FLOAT_MAT4&&(o=4),r[s]={type:n.type,location:e.getAttribLocation(i,s),locationSize:o}}return r}(p,T)}p.attachShader(T,R),p.attachShader(T,C),void 0!==r.index0AttributeName?p.bindAttribLocation(T,0,r.index0AttributeName):!0===r.morphTargets&&p.bindAttribLocation(T,0,"position"),p.linkProgram(T),this.getUniforms=function(){return void 0===u&&P(this),u},this.getAttributes=function(){return void 0===d&&P(this),d};let I=!1===r.rendererExtensionParallelShaderCompile;return this.isReady=function(){return!1===I&&(I=p.getProgramParameter(T,37297)),I},this.destroy=function(){a.releaseStatesOfProgram(this),p.deleteProgram(T),this.program=void 0},this.type=r.shaderType,this.name=r.shaderName,this.id=eq++,this.cacheKey=i,this.usedTimes=1,this.program=T,this.vertexShader=R,this.fragmentShader=C,this}let tn=0;class ta{constructor(){this.shaderCache=new Map,this.materialCache=new Map}update(e){let i=e.vertexShader,r=e.fragmentShader,n=this._getShaderStage(i),a=this._getShaderStage(r),s=this._getShaderCacheForMaterial(e);return!1===s.has(n)&&(s.add(n),n.usedTimes++),!1===s.has(a)&&(s.add(a),a.usedTimes++),this}remove(e){for(let i of this.materialCache.get(e))i.usedTimes--,0===i.usedTimes&&this.shaderCache.delete(i.code);return this.materialCache.delete(e),this}getVertexShaderID(e){return this._getShaderStage(e.vertexShader).id}getFragmentShaderID(e){return this._getShaderStage(e.fragmentShader).id}dispose(){this.shaderCache.clear(),this.materialCache.clear()}_getShaderCacheForMaterial(e){let i=this.materialCache,r=i.get(e);return void 0===r&&(r=new Set,i.set(e,r)),r}_getShaderStage(e){let i=this.shaderCache,r=i.get(e);return void 0===r&&(r=new ts(e),i.set(e,r)),r}}class ts{constructor(e){this.id=tn++,this.code=e,this.usedTimes=0}}function to(e,i,r,a,s,o,l){let h=new n.zgK,u=new ta,d=new Set,p=[],f=new Map,m=s.logarithmicDepthBuffer,g=s.precision,v={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distance",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"};function _(e){return(d.add(e),0===e)?"uv":`uv${e}`}return{getParameters:function(o,h,p,f,x){let y,M,S,b,T=f.fog,E=x.geometry,w=o.isMeshStandardMaterial?f.environment:null,A=(o.isMeshStandardMaterial?r:i).get(o.envMap||w),R=A&&A.mapping===n.Om?A.image.height:null,C=v[o.type];null!==o.precision&&(g=s.getMaxPrecision(o.precision))!==o.precision&&(0,n.R8M)("WebGLProgram.getParameters:",o.precision,"not supported, using",g,"instead.");let P=E.morphAttributes.position||E.morphAttributes.normal||E.morphAttributes.color,I=void 0!==P?P.length:0,L=0;if(void 0!==E.morphAttributes.position&&(L=1),void 0!==E.morphAttributes.normal&&(L=2),void 0!==E.morphAttributes.color&&(L=3),C){let e=c[C];y=e.vertexShader,M=e.fragmentShader}else y=o.vertexShader,M=o.fragmentShader,u.update(o),S=u.getVertexShaderID(o),b=u.getFragmentShaderID(o);let D=e.getRenderTarget(),U=e.state.buffers.depth.getReversed(),N=!0===x.isInstancedMesh,O=!0===x.isBatchedMesh,F=!!o.map,B=!!o.matcap,z=!!A,k=!!o.aoMap,V=!!o.lightMap,H=!!o.bumpMap,G=!!o.normalMap,W=!!o.displacementMap,X=!!o.emissiveMap,j=!!o.metalnessMap,q=!!o.roughnessMap,Y=o.anisotropy>0,K=o.clearcoat>0,J=o.dispersion>0,Z=o.iridescence>0,Q=o.sheen>0,$=o.transmission>0,ee=Y&&!!o.anisotropyMap,et=K&&!!o.clearcoatMap,ei=K&&!!o.clearcoatNormalMap,er=K&&!!o.clearcoatRoughnessMap,en=Z&&!!o.iridescenceMap,ea=Z&&!!o.iridescenceThicknessMap,es=Q&&!!o.sheenColorMap,eo=Q&&!!o.sheenRoughnessMap,el=!!o.specularMap,ec=!!o.specularColorMap,eh=!!o.specularIntensityMap,eu=$&&!!o.transmissionMap,ed=$&&!!o.thicknessMap,ep=!!o.gradientMap,ef=!!o.alphaMap,em=o.alphaTest>0,eg=!!o.alphaHash,ev=!!o.extensions,e_=n.y_p;o.toneMapped&&(null===D||!0===D.isXRRenderTarget)&&(e_=e.toneMapping);let ex={shaderID:C,shaderType:o.type,shaderName:o.name,vertexShader:y,fragmentShader:M,defines:o.defines,customVertexShaderID:S,customFragmentShaderID:b,isRawShaderMaterial:!0===o.isRawShaderMaterial,glslVersion:o.glslVersion,precision:g,batching:O,batchingColor:O&&null!==x._colorsTexture,instancing:N,instancingColor:N&&null!==x.instanceColor,instancingMorph:N&&null!==x.morphTexture,outputColorSpace:null===D?e.outputColorSpace:!0===D.isXRRenderTarget?D.texture.colorSpace:n.Zr2,alphaToCoverage:!!o.alphaToCoverage,map:F,matcap:B,envMap:z,envMapMode:z&&A.mapping,envMapCubeUVHeight:R,aoMap:k,lightMap:V,bumpMap:H,normalMap:G,displacementMap:W,emissiveMap:X,normalMapObjectSpace:G&&o.normalMapType===n.vyJ,normalMapTangentSpace:G&&o.normalMapType===n.bI3,metalnessMap:j,roughnessMap:q,anisotropy:Y,anisotropyMap:ee,clearcoat:K,clearcoatMap:et,clearcoatNormalMap:ei,clearcoatRoughnessMap:er,dispersion:J,iridescence:Z,iridescenceMap:en,iridescenceThicknessMap:ea,sheen:Q,sheenColorMap:es,sheenRoughnessMap:eo,specularMap:el,specularColorMap:ec,specularIntensityMap:eh,transmission:$,transmissionMap:eu,thicknessMap:ed,gradientMap:ep,opaque:!1===o.transparent&&o.blending===n.NTi&&!1===o.alphaToCoverage,alphaMap:ef,alphaTest:em,alphaHash:eg,combine:o.combine,mapUv:F&&_(o.map.channel),aoMapUv:k&&_(o.aoMap.channel),lightMapUv:V&&_(o.lightMap.channel),bumpMapUv:H&&_(o.bumpMap.channel),normalMapUv:G&&_(o.normalMap.channel),displacementMapUv:W&&_(o.displacementMap.channel),emissiveMapUv:X&&_(o.emissiveMap.channel),metalnessMapUv:j&&_(o.metalnessMap.channel),roughnessMapUv:q&&_(o.roughnessMap.channel),anisotropyMapUv:ee&&_(o.anisotropyMap.channel),clearcoatMapUv:et&&_(o.clearcoatMap.channel),clearcoatNormalMapUv:ei&&_(o.clearcoatNormalMap.channel),clearcoatRoughnessMapUv:er&&_(o.clearcoatRoughnessMap.channel),iridescenceMapUv:en&&_(o.iridescenceMap.channel),iridescenceThicknessMapUv:ea&&_(o.iridescenceThicknessMap.channel),sheenColorMapUv:es&&_(o.sheenColorMap.channel),sheenRoughnessMapUv:eo&&_(o.sheenRoughnessMap.channel),specularMapUv:el&&_(o.specularMap.channel),specularColorMapUv:ec&&_(o.specularColorMap.channel),specularIntensityMapUv:eh&&_(o.specularIntensityMap.channel),transmissionMapUv:eu&&_(o.transmissionMap.channel),thicknessMapUv:ed&&_(o.thicknessMap.channel),alphaMapUv:ef&&_(o.alphaMap.channel),vertexTangents:!!E.attributes.tangent&&(G||Y),vertexColors:o.vertexColors,vertexAlphas:!0===o.vertexColors&&!!E.attributes.color&&4===E.attributes.color.itemSize,pointsUvs:!0===x.isPoints&&!!E.attributes.uv&&(F||ef),fog:!!T,useFog:!0===o.fog,fogExp2:!!T&&T.isFogExp2,flatShading:!0===o.flatShading&&!1===o.wireframe,sizeAttenuation:!0===o.sizeAttenuation,logarithmicDepthBuffer:m,reversedDepthBuffer:U,skinning:!0===x.isSkinnedMesh,morphTargets:void 0!==E.morphAttributes.position,morphNormals:void 0!==E.morphAttributes.normal,morphColors:void 0!==E.morphAttributes.color,morphTargetsCount:I,morphTextureStride:L,numDirLights:h.directional.length,numPointLights:h.point.length,numSpotLights:h.spot.length,numSpotLightMaps:h.spotLightMap.length,numRectAreaLights:h.rectArea.length,numHemiLights:h.hemi.length,numDirLightShadows:h.directionalShadowMap.length,numPointLightShadows:h.pointShadowMap.length,numSpotLightShadows:h.spotShadowMap.length,numSpotLightShadowsWithMaps:h.numSpotLightShadowsWithMaps,numLightProbes:h.numLightProbes,numClippingPlanes:l.numPlanes,numClipIntersection:l.numIntersection,dithering:o.dithering,shadowMapEnabled:e.shadowMap.enabled&&p.length>0,shadowMapType:e.shadowMap.type,toneMapping:e_,decodeVideoTexture:F&&!0===o.map.isVideoTexture&&n.ppV.getTransfer(o.map.colorSpace)===n.KLL,decodeVideoTextureEmissive:X&&!0===o.emissiveMap.isVideoTexture&&n.ppV.getTransfer(o.emissiveMap.colorSpace)===n.KLL,premultipliedAlpha:o.premultipliedAlpha,doubleSided:o.side===n.$EB,flipSided:o.side===n.hsX,useDepthPacking:o.depthPacking>=0,depthPacking:o.depthPacking||0,index0AttributeName:o.index0AttributeName,extensionClipCullDistance:ev&&!0===o.extensions.clipCullDistance&&a.has("WEBGL_clip_cull_distance"),extensionMultiDraw:(ev&&!0===o.extensions.multiDraw||O)&&a.has("WEBGL_multi_draw"),rendererExtensionParallelShaderCompile:a.has("KHR_parallel_shader_compile"),customProgramCacheKey:o.customProgramCacheKey()};return ex.vertexUv1s=d.has(1),ex.vertexUv2s=d.has(2),ex.vertexUv3s=d.has(3),d.clear(),ex},getProgramCacheKey:function(i){var r,n,a,s;let o=[];if(i.shaderID?o.push(i.shaderID):(o.push(i.customVertexShaderID),o.push(i.customFragmentShaderID)),void 0!==i.defines)for(let e in i.defines)o.push(e),o.push(i.defines[e]);return!1===i.isRawShaderMaterial&&(r=o,n=i,r.push(n.precision),r.push(n.outputColorSpace),r.push(n.envMapMode),r.push(n.envMapCubeUVHeight),r.push(n.mapUv),r.push(n.alphaMapUv),r.push(n.lightMapUv),r.push(n.aoMapUv),r.push(n.bumpMapUv),r.push(n.normalMapUv),r.push(n.displacementMapUv),r.push(n.emissiveMapUv),r.push(n.metalnessMapUv),r.push(n.roughnessMapUv),r.push(n.anisotropyMapUv),r.push(n.clearcoatMapUv),r.push(n.clearcoatNormalMapUv),r.push(n.clearcoatRoughnessMapUv),r.push(n.iridescenceMapUv),r.push(n.iridescenceThicknessMapUv),r.push(n.sheenColorMapUv),r.push(n.sheenRoughnessMapUv),r.push(n.specularMapUv),r.push(n.specularColorMapUv),r.push(n.specularIntensityMapUv),r.push(n.transmissionMapUv),r.push(n.thicknessMapUv),r.push(n.combine),r.push(n.fogExp2),r.push(n.sizeAttenuation),r.push(n.morphTargetsCount),r.push(n.morphAttributeCount),r.push(n.numDirLights),r.push(n.numPointLights),r.push(n.numSpotLights),r.push(n.numSpotLightMaps),r.push(n.numHemiLights),r.push(n.numRectAreaLights),r.push(n.numDirLightShadows),r.push(n.numPointLightShadows),r.push(n.numSpotLightShadows),r.push(n.numSpotLightShadowsWithMaps),r.push(n.numLightProbes),r.push(n.shadowMapType),r.push(n.toneMapping),r.push(n.numClippingPlanes),r.push(n.numClipIntersection),r.push(n.depthPacking),a=o,s=i,h.disableAll(),s.instancing&&h.enable(0),s.instancingColor&&h.enable(1),s.instancingMorph&&h.enable(2),s.matcap&&h.enable(3),s.envMap&&h.enable(4),s.normalMapObjectSpace&&h.enable(5),s.normalMapTangentSpace&&h.enable(6),s.clearcoat&&h.enable(7),s.iridescence&&h.enable(8),s.alphaTest&&h.enable(9),s.vertexColors&&h.enable(10),s.vertexAlphas&&h.enable(11),s.vertexUv1s&&h.enable(12),s.vertexUv2s&&h.enable(13),s.vertexUv3s&&h.enable(14),s.vertexTangents&&h.enable(15),s.anisotropy&&h.enable(16),s.alphaHash&&h.enable(17),s.batching&&h.enable(18),s.dispersion&&h.enable(19),s.batchingColor&&h.enable(20),s.gradientMap&&h.enable(21),a.push(h.mask),h.disableAll(),s.fog&&h.enable(0),s.useFog&&h.enable(1),s.flatShading&&h.enable(2),s.logarithmicDepthBuffer&&h.enable(3),s.reversedDepthBuffer&&h.enable(4),s.skinning&&h.enable(5),s.morphTargets&&h.enable(6),s.morphNormals&&h.enable(7),s.morphColors&&h.enable(8),s.premultipliedAlpha&&h.enable(9),s.shadowMapEnabled&&h.enable(10),s.doubleSided&&h.enable(11),s.flipSided&&h.enable(12),s.useDepthPacking&&h.enable(13),s.dithering&&h.enable(14),s.transmission&&h.enable(15),s.sheen&&h.enable(16),s.opaque&&h.enable(17),s.pointsUvs&&h.enable(18),s.decodeVideoTexture&&h.enable(19),s.decodeVideoTextureEmissive&&h.enable(20),s.alphaToCoverage&&h.enable(21),a.push(h.mask),o.push(e.outputColorSpace)),o.push(i.customProgramCacheKey),o.join()},getUniforms:function(e){let i,r=v[e.type];if(r){let e=c[r];i=n.LlO.clone(e.uniforms)}else i=e.uniforms;return i},acquireProgram:function(i,r){let n=f.get(r);return void 0!==n?++n.usedTimes:(n=new tr(e,r,i,o),p.push(n),f.set(r,n)),n},releaseProgram:function(e){if(0==--e.usedTimes){let i=p.indexOf(e);p[i]=p[p.length-1],p.pop(),f.delete(e.cacheKey),e.destroy()}},releaseShaderCache:function(e){u.remove(e)},programs:p,dispose:function(){u.dispose()}}}function tl(){let e=new WeakMap;return{has:function(i){return e.has(i)},get:function(i){let r=e.get(i);return void 0===r&&(r={},e.set(i,r)),r},remove:function(i){e.delete(i)},update:function(i,r,n){e.get(i)[r]=n},dispose:function(){e=new WeakMap}}}function tc(e,i){return e.groupOrder!==i.groupOrder?e.groupOrder-i.groupOrder:e.renderOrder!==i.renderOrder?e.renderOrder-i.renderOrder:e.material.id!==i.material.id?e.material.id-i.material.id:e.z!==i.z?e.z-i.z:e.id-i.id}function th(e,i){return e.groupOrder!==i.groupOrder?e.groupOrder-i.groupOrder:e.renderOrder!==i.renderOrder?e.renderOrder-i.renderOrder:e.z!==i.z?i.z-e.z:e.id-i.id}function tu(){let e=[],i=0,r=[],n=[],a=[];function s(r,n,a,s,o,l){let c=e[i];return void 0===c?(c={id:r.id,object:r,geometry:n,material:a,groupOrder:s,renderOrder:r.renderOrder,z:o,group:l},e[i]=c):(c.id=r.id,c.object=r,c.geometry=n,c.material=a,c.groupOrder=s,c.renderOrder=r.renderOrder,c.z=o,c.group=l),i++,c}return{opaque:r,transmissive:n,transparent:a,init:function(){i=0,r.length=0,n.length=0,a.length=0},push:function(e,i,o,l,c,h){let u=s(e,i,o,l,c,h);o.transmission>0?n.push(u):!0===o.transparent?a.push(u):r.push(u)},unshift:function(e,i,o,l,c,h){let u=s(e,i,o,l,c,h);o.transmission>0?n.unshift(u):!0===o.transparent?a.unshift(u):r.unshift(u)},finish:function(){for(let r=i,n=e.length;r<n;r++){let i=e[r];if(null===i.id)break;i.id=null,i.object=null,i.geometry=null,i.material=null,i.group=null}},sort:function(e,i){r.length>1&&r.sort(e||tc),n.length>1&&n.sort(i||th),a.length>1&&a.sort(i||th)}}}function td(){let e=new WeakMap;return{get:function(i,r){let n,a=e.get(i);return void 0===a?(n=new tu,e.set(i,[n])):r>=a.length?(n=new tu,a.push(n)):n=a[r],n},dispose:function(){e=new WeakMap}}}function tp(){let e={};return{get:function(i){let r;if(void 0!==e[i.id])return e[i.id];switch(i.type){case"DirectionalLight":r={direction:new n.Pq0,color:new n.Q1f};break;case"SpotLight":r={position:new n.Pq0,direction:new n.Pq0,color:new n.Q1f,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":r={position:new n.Pq0,color:new n.Q1f,distance:0,decay:0};break;case"HemisphereLight":r={direction:new n.Pq0,skyColor:new n.Q1f,groundColor:new n.Q1f};break;case"RectAreaLight":r={color:new n.Q1f,position:new n.Pq0,halfWidth:new n.Pq0,halfHeight:new n.Pq0}}return e[i.id]=r,r}}}let tf=0;function tm(e,i){return 2*!!i.castShadow-2*!!e.castShadow+ +!!i.map-!!e.map}function tg(e){let i,r=new tp,a=(i={},{get:function(e){let r;if(void 0!==i[e.id])return i[e.id];switch(e.type){case"DirectionalLight":case"SpotLight":r={shadowIntensity:1,shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new n.I9Y};break;case"PointLight":r={shadowIntensity:1,shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new n.I9Y,shadowCameraNear:1,shadowCameraFar:1e3}}return i[e.id]=r,r}}),s={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1,numSpotMaps:-1,numLightProbes:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotLightMap:[],spotShadow:[],spotShadowMap:[],spotLightMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[],numSpotLightShadowsWithMaps:0,numLightProbes:0};for(let e=0;e<9;e++)s.probe.push(new n.Pq0);let o=new n.Pq0,c=new n.kn4,h=new n.kn4;return{setup:function(i){let o=0,c=0,h=0;for(let e=0;e<9;e++)s.probe[e].set(0,0,0);let u=0,d=0,p=0,f=0,m=0,g=0,v=0,_=0,x=0,y=0,M=0;i.sort(tm);for(let e=0,l=i.length;e<l;e++){let l=i[e],S=l.color,b=l.intensity,T=l.distance,E=null;if(l.shadow&&l.shadow.map&&(E=l.shadow.map.texture.format===n.paN?l.shadow.map.texture:l.shadow.map.depthTexture||l.shadow.map.texture),l.isAmbientLight)o+=S.r*b,c+=S.g*b,h+=S.b*b;else if(l.isLightProbe){for(let e=0;e<9;e++)s.probe[e].addScaledVector(l.sh.coefficients[e],b);M++}else if(l.isDirectionalLight){let e=r.get(l);if(e.color.copy(l.color).multiplyScalar(l.intensity),l.castShadow){let e=l.shadow,i=a.get(l);i.shadowIntensity=e.intensity,i.shadowBias=e.bias,i.shadowNormalBias=e.normalBias,i.shadowRadius=e.radius,i.shadowMapSize=e.mapSize,s.directionalShadow[u]=i,s.directionalShadowMap[u]=E,s.directionalShadowMatrix[u]=l.shadow.matrix,g++}s.directional[u]=e,u++}else if(l.isSpotLight){let e=r.get(l);e.position.setFromMatrixPosition(l.matrixWorld),e.color.copy(S).multiplyScalar(b),e.distance=T,e.coneCos=Math.cos(l.angle),e.penumbraCos=Math.cos(l.angle*(1-l.penumbra)),e.decay=l.decay,s.spot[p]=e;let i=l.shadow;if(l.map&&(s.spotLightMap[x]=l.map,x++,i.updateMatrices(l),l.castShadow&&y++),s.spotLightMatrix[p]=i.matrix,l.castShadow){let e=a.get(l);e.shadowIntensity=i.intensity,e.shadowBias=i.bias,e.shadowNormalBias=i.normalBias,e.shadowRadius=i.radius,e.shadowMapSize=i.mapSize,s.spotShadow[p]=e,s.spotShadowMap[p]=E,_++}p++}else if(l.isRectAreaLight){let e=r.get(l);e.color.copy(S).multiplyScalar(b),e.halfWidth.set(.5*l.width,0,0),e.halfHeight.set(0,.5*l.height,0),s.rectArea[f]=e,f++}else if(l.isPointLight){let e=r.get(l);if(e.color.copy(l.color).multiplyScalar(l.intensity),e.distance=l.distance,e.decay=l.decay,l.castShadow){let e=l.shadow,i=a.get(l);i.shadowIntensity=e.intensity,i.shadowBias=e.bias,i.shadowNormalBias=e.normalBias,i.shadowRadius=e.radius,i.shadowMapSize=e.mapSize,i.shadowCameraNear=e.camera.near,i.shadowCameraFar=e.camera.far,s.pointShadow[d]=i,s.pointShadowMap[d]=E,s.pointShadowMatrix[d]=l.shadow.matrix,v++}s.point[d]=e,d++}else if(l.isHemisphereLight){let e=r.get(l);e.skyColor.copy(l.color).multiplyScalar(b),e.groundColor.copy(l.groundColor).multiplyScalar(b),s.hemi[m]=e,m++}}f>0&&(!0===e.has("OES_texture_float_linear")?(s.rectAreaLTC1=l.LTC_FLOAT_1,s.rectAreaLTC2=l.LTC_FLOAT_2):(s.rectAreaLTC1=l.LTC_HALF_1,s.rectAreaLTC2=l.LTC_HALF_2)),s.ambient[0]=o,s.ambient[1]=c,s.ambient[2]=h;let S=s.hash;(S.directionalLength!==u||S.pointLength!==d||S.spotLength!==p||S.rectAreaLength!==f||S.hemiLength!==m||S.numDirectionalShadows!==g||S.numPointShadows!==v||S.numSpotShadows!==_||S.numSpotMaps!==x||S.numLightProbes!==M)&&(s.directional.length=u,s.spot.length=p,s.rectArea.length=f,s.point.length=d,s.hemi.length=m,s.directionalShadow.length=g,s.directionalShadowMap.length=g,s.pointShadow.length=v,s.pointShadowMap.length=v,s.spotShadow.length=_,s.spotShadowMap.length=_,s.directionalShadowMatrix.length=g,s.pointShadowMatrix.length=v,s.spotLightMatrix.length=_+x-y,s.spotLightMap.length=x,s.numSpotLightShadowsWithMaps=y,s.numLightProbes=M,S.directionalLength=u,S.pointLength=d,S.spotLength=p,S.rectAreaLength=f,S.hemiLength=m,S.numDirectionalShadows=g,S.numPointShadows=v,S.numSpotShadows=_,S.numSpotMaps=x,S.numLightProbes=M,s.version=tf++)},setupView:function(e,i){let r=0,n=0,a=0,l=0,u=0,d=i.matrixWorldInverse;for(let i=0,p=e.length;i<p;i++){let p=e[i];if(p.isDirectionalLight){let e=s.directional[r];e.direction.setFromMatrixPosition(p.matrixWorld),o.setFromMatrixPosition(p.target.matrixWorld),e.direction.sub(o),e.direction.transformDirection(d),r++}else if(p.isSpotLight){let e=s.spot[a];e.position.setFromMatrixPosition(p.matrixWorld),e.position.applyMatrix4(d),e.direction.setFromMatrixPosition(p.matrixWorld),o.setFromMatrixPosition(p.target.matrixWorld),e.direction.sub(o),e.direction.transformDirection(d),a++}else if(p.isRectAreaLight){let e=s.rectArea[l];e.position.setFromMatrixPosition(p.matrixWorld),e.position.applyMatrix4(d),h.identity(),c.copy(p.matrixWorld),c.premultiply(d),h.extractRotation(c),e.halfWidth.set(.5*p.width,0,0),e.halfHeight.set(0,.5*p.height,0),e.halfWidth.applyMatrix4(h),e.halfHeight.applyMatrix4(h),l++}else if(p.isPointLight){let e=s.point[n];e.position.setFromMatrixPosition(p.matrixWorld),e.position.applyMatrix4(d),n++}else if(p.isHemisphereLight){let e=s.hemi[u];e.direction.setFromMatrixPosition(p.matrixWorld),e.direction.transformDirection(d),u++}}},state:s}}function tv(e){let i=new tg(e),r=[],n=[],a={lightsArray:r,shadowsArray:n,camera:null,lights:i,transmissionRenderTarget:{}};return{init:function(e){a.camera=e,r.length=0,n.length=0},state:a,setupLights:function(){i.setup(r)},setupLightsView:function(e){i.setupView(r,e)},pushLight:function(e){r.push(e)},pushShadow:function(e){n.push(e)}}}function t_(e){let i=new WeakMap;return{get:function(r,n=0){let a,s=i.get(r);return void 0===s?(a=new tv(e),i.set(r,[a])):n>=s.length?(a=new tv(e),s.push(a)):a=s[n],a},dispose:function(){i=new WeakMap}}}let tx=`void main() {
	gl_Position = vec4( position, 1.0 );
-}`,tx=`uniform sampler2D shadow_pass;
+}`,ty=`uniform sampler2D shadow_pass;
 uniform vec2 resolution;
 uniform float radius;
 void main() {
	const float samples = float( VSM_SAMPLES );
	float mean = 0.0;
@@ -3997,11 +3996,11 @@ void main() {
	}
	mean = mean / samples;
	squared_mean = squared_mean / samples;
	float std_dev = sqrt( max( 0.0, squared_mean - mean * mean ) );
	gl_FragColor = vec4( mean, std_dev, 0.0, 1.0 );
-}`,tM=[new n.Pq0(1,0,0),new n.Pq0(-1,0,0),new n.Pq0(0,1,0),new n.Pq0(0,-1,0),new n.Pq0(0,0,1),new n.Pq0(0,0,-1)],tS=[new n.Pq0(0,-1,0),new n.Pq0(0,-1,0),new n.Pq0(0,0,1),new n.Pq0(0,0,-1),new n.Pq0(0,-1,0),new n.Pq0(0,-1,0)],tb=new n.kn4,tT=new n.Pq0,tE=new n.Pq0;function tw(e,i,r){let a=new n.PPD,s=new n.I9Y,o=new n.I9Y,l=new n.IUQ,c=new n.CSG,h=new n.aVO,u={},d=r.maxTextureSize,p={[n.hB5]:n.hsX,[n.hsX]:n.hB5,[n.$EB]:n.$EB},f=new n.BKk({defines:{VSM_SAMPLES:8},uniforms:{shadow_pass:{value:null},resolution:{value:new n.I9Y},radius:{value:4}},vertexShader:ty,fragmentShader:tx}),m=f.clone();m.defines.HORIZONTAL_PASS=1;let g=new n.LoY;g.setAttribute("position",new n.THS(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));let v=new n.eaF(g,f),_=this;this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=n.QP0;let y=this.type;function x(i,r,a,s){let o=null,l=!0===a.isPointLight?i.customDistanceMaterial:i.customDepthMaterial;if(void 0!==l)o=l;else if(o=!0===a.isPointLight?h:c,e.localClippingEnabled&&!0===r.clipShadows&&Array.isArray(r.clippingPlanes)&&0!==r.clippingPlanes.length||r.displacementMap&&0!==r.displacementScale||r.alphaMap&&r.alphaTest>0||r.map&&r.alphaTest>0||!0===r.alphaToCoverage){let e=o.uuid,i=r.uuid,n=u[e];void 0===n&&(n={},u[e]=n);let a=n[i];void 0===a&&(a=o.clone(),n[i]=a,r.addEventListener("dispose",M)),o=a}return o.visible=r.visible,o.wireframe=r.wireframe,s===n.RyA?o.side=null!==r.shadowSide?r.shadowSide:r.side:o.side=null!==r.shadowSide?r.shadowSide:p[r.side],o.alphaMap=r.alphaMap,o.alphaTest=!0===r.alphaToCoverage?.5:r.alphaTest,o.map=r.map,o.clipShadows=r.clipShadows,o.clippingPlanes=r.clippingPlanes,o.clipIntersection=r.clipIntersection,o.displacementMap=r.displacementMap,o.displacementScale=r.displacementScale,o.displacementBias=r.displacementBias,o.wireframeLinewidth=r.wireframeLinewidth,o.linewidth=r.linewidth,!0===a.isPointLight&&!0===o.isMeshDistanceMaterial&&(e.properties.get(o).light=a),o}function M(e){for(let i in e.target.removeEventListener("dispose",M),u){let r=u[i],n=e.target.uuid;n in r&&(r[n].dispose(),delete r[n])}}this.render=function(r,c,h){if(!1===_.enabled||!1===_.autoUpdate&&!1===_.needsUpdate||0===r.length)return;r.type===n.Wk7&&((0,n.R8M)("WebGLShadowMap: PCFSoftShadowMap has been deprecated. Using PCFShadowMap instead."),r.type=n.QP0);let u=e.getRenderTarget(),p=e.getActiveCubeFace(),g=e.getActiveMipmapLevel(),M=e.state;M.setBlending(n.XIg),!0===M.buffers.depth.getReversed()?M.buffers.color.setClear(0,0,0,0):M.buffers.color.setClear(1,1,1,1),M.buffers.depth.setTest(!0),M.setScissorTest(!1);let S=y!==this.type;S&&c.traverse(function(e){e.material&&(Array.isArray(e.material)?e.material.forEach(e=>e.needsUpdate=!0):e.material.needsUpdate=!0)});for(let u=0,p=r.length;u<p;u++){let p=r[u],g=p.shadow;if(void 0===g){(0,n.R8M)("WebGLShadowMap:",p,"has no shadow.");continue}if(!1===g.autoUpdate&&!1===g.needsUpdate)continue;s.copy(g.mapSize);let _=g.getFrameExtents();if(s.multiply(_),o.copy(g.mapSize),(s.x>d||s.y>d)&&(s.x>d&&(o.x=Math.floor(d/_.x),s.x=o.x*_.x,g.mapSize.x=o.x),s.y>d&&(o.y=Math.floor(d/_.y),s.y=o.y*_.y,g.mapSize.y=o.y)),null===g.map||!0===S){if(null!==g.map&&(null!==g.map.depthTexture&&(g.map.depthTexture.dispose(),g.map.depthTexture=null),g.map.dispose()),this.type===n.RyA){if(p.isPointLight){(0,n.R8M)("WebGLShadowMap: VSM shadow maps are not supported for PointLights. Use PCF or BasicShadowMap instead.");continue}g.map=new n.nWS(s.x,s.y,{format:n.paN,type:n.ix0,minFilter:n.k6q,magFilter:n.k6q,generateMipmaps:!1}),g.map.texture.name=p.name+".shadowMap",g.map.depthTexture=new n.VCu(s.x,s.y,n.RQf),g.map.depthTexture.name=p.name+".shadowMapDepth",g.map.depthTexture.format=n.zdS,g.map.depthTexture.compareFunction=null,g.map.depthTexture.minFilter=n.hxR,g.map.depthTexture.magFilter=n.hxR}else{p.isPointLight?(g.map=new n.o6l(s.x),g.map.depthTexture=new n.Gc6(s.x,n.bkx)):(g.map=new n.nWS(s.x,s.y),g.map.depthTexture=new n.VCu(s.x,s.y,n.bkx)),g.map.depthTexture.name=p.name+".shadowMap",g.map.depthTexture.format=n.zdS;let i=e.state.buffers.depth.getReversed();this.type===n.QP0?(g.map.depthTexture.compareFunction=i?n.gWB:n.TiK,g.map.depthTexture.minFilter=n.k6q,g.map.depthTexture.magFilter=n.k6q):(g.map.depthTexture.compareFunction=null,g.map.depthTexture.minFilter=n.hxR,g.map.depthTexture.magFilter=n.hxR)}g.camera.updateProjectionMatrix()}let y=g.map.isWebGLCubeRenderTarget?6:1;for(let r=0;r<y;r++){if(g.map.isWebGLCubeRenderTarget)e.setRenderTarget(g.map,r),e.clear();else{0===r&&(e.setRenderTarget(g.map),e.clear());let i=g.getViewport(r);l.set(o.x*i.x,o.y*i.y,o.x*i.z,o.y*i.w),M.viewport(l)}if(p.isPointLight){let e=g.camera,i=g.matrix,n=p.distance||e.far;n!==e.far&&(e.far=n,e.updateProjectionMatrix()),tT.setFromMatrixPosition(p.matrixWorld),e.position.copy(tT),tE.copy(e.position),tE.add(tM[r]),e.up.copy(tS[r]),e.lookAt(tE),e.updateMatrixWorld(),i.makeTranslation(-tT.x,-tT.y,-tT.z),tb.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),g._frustum.setFromProjectionMatrix(tb,e.coordinateSystem,e.reversedDepth)}else g.updateMatrices(p);a=g.getFrustum(),function r(s,o,l,c,h){if(!1===s.visible)return;if(s.layers.test(o.layers)&&(s.isMesh||s.isLine||s.isPoints)&&(s.castShadow||s.receiveShadow&&h===n.RyA)&&(!s.frustumCulled||a.intersectsObject(s))){s.modelViewMatrix.multiplyMatrices(l.matrixWorldInverse,s.matrixWorld);let r=i.update(s),n=s.material;if(Array.isArray(n)){let i=r.groups;for(let a=0,u=i.length;a<u;a++){let u=i[a],d=n[u.materialIndex];if(d&&d.visible){let i=x(s,d,c,h);s.onBeforeShadow(e,s,o,l,r,i,u),e.renderBufferDirect(l,null,r,i,s,u),s.onAfterShadow(e,s,o,l,r,i,u)}}}else if(n.visible){let i=x(s,n,c,h);s.onBeforeShadow(e,s,o,l,r,i,null),e.renderBufferDirect(l,null,r,i,s,null),s.onAfterShadow(e,s,o,l,r,i,null)}}let u=s.children;for(let e=0,i=u.length;e<i;e++)r(u[e],o,l,c,h)}(c,h,g.camera,p,this.type)}!0!==g.isPointLightShadow&&this.type===n.RyA&&function(r,a){let o=i.update(v);f.defines.VSM_SAMPLES!==r.blurSamples&&(f.defines.VSM_SAMPLES=r.blurSamples,m.defines.VSM_SAMPLES=r.blurSamples,f.needsUpdate=!0,m.needsUpdate=!0),null===r.mapPass&&(r.mapPass=new n.nWS(s.x,s.y,{format:n.paN,type:n.ix0})),f.uniforms.shadow_pass.value=r.map.depthTexture,f.uniforms.resolution.value=r.mapSize,f.uniforms.radius.value=r.radius,e.setRenderTarget(r.mapPass),e.clear(),e.renderBufferDirect(a,null,o,f,v,null),m.uniforms.shadow_pass.value=r.mapPass.texture,m.uniforms.resolution.value=r.mapSize,m.uniforms.radius.value=r.radius,e.setRenderTarget(r.map),e.clear(),e.renderBufferDirect(a,null,o,m,v,null)}(g,h),g.needsUpdate=!1}y=this.type,_.needsUpdate=!1,e.setRenderTarget(u,p,g)}}let tA={[n.eHc]:n.lGu,[n.brA]:n.K52,[n.U3G]:n.bw0,[n.xSv]:n.Gwm,[n.lGu]:n.eHc,[n.K52]:n.brA,[n.bw0]:n.U3G,[n.Gwm]:n.xSv};function tR(e,i){let r=new function(){let i=!1,r=new n.IUQ,a=null,s=new n.IUQ(0,0,0,0);return{setMask:function(r){a===r||i||(e.colorMask(r,r,r,r),a=r)},setLocked:function(e){i=e},setClear:function(i,n,a,o,l){!0===l&&(i*=o,n*=o,a*=o),r.set(i,n,a,o),!1===s.equals(r)&&(e.clearColor(i,n,a,o),s.copy(r))},reset:function(){i=!1,a=null,s.set(-1,0,0,0)}}},a=new function(){let r=!1,a=!1,s=null,o=null,l=null;return{setReversed:function(e){if(a!==e){let r=i.get("EXT_clip_control");e?r.clipControlEXT(r.LOWER_LEFT_EXT,r.ZERO_TO_ONE_EXT):r.clipControlEXT(r.LOWER_LEFT_EXT,r.NEGATIVE_ONE_TO_ONE_EXT),a=e;let n=l;l=null,this.setClear(n)}},getReversed:function(){return a},setTest:function(i){i?V(e.DEPTH_TEST):H(e.DEPTH_TEST)},setMask:function(i){s===i||r||(e.depthMask(i),s=i)},setFunc:function(i){if(a&&(i=tA[i]),o!==i){switch(i){case n.eHc:e.depthFunc(e.NEVER);break;case n.lGu:e.depthFunc(e.ALWAYS);break;case n.brA:e.depthFunc(e.LESS);break;case n.xSv:e.depthFunc(e.LEQUAL);break;case n.U3G:e.depthFunc(e.EQUAL);break;case n.Gwm:e.depthFunc(e.GEQUAL);break;case n.K52:e.depthFunc(e.GREATER);break;case n.bw0:e.depthFunc(e.NOTEQUAL);break;default:e.depthFunc(e.LEQUAL)}o=i}},setLocked:function(e){r=e},setClear:function(i){l!==i&&(a&&(i=1-i),e.clearDepth(i),l=i)},reset:function(){r=!1,s=null,o=null,l=null,a=!1}}},s=new function(){let i=!1,r=null,n=null,a=null,s=null,o=null,l=null,c=null,h=null;return{setTest:function(r){i||(r?V(e.STENCIL_TEST):H(e.STENCIL_TEST))},setMask:function(n){r===n||i||(e.stencilMask(n),r=n)},setFunc:function(i,r,o){(n!==i||a!==r||s!==o)&&(e.stencilFunc(i,r,o),n=i,a=r,s=o)},setOp:function(i,r,n){(o!==i||l!==r||c!==n)&&(e.stencilOp(i,r,n),o=i,l=r,c=n)},setLocked:function(e){i=e},setClear:function(i){h!==i&&(e.clearStencil(i),h=i)},reset:function(){i=!1,r=null,n=null,a=null,s=null,o=null,l=null,c=null,h=null}}},o=new WeakMap,l=new WeakMap,c={},h={},u=new WeakMap,d=[],p=null,f=!1,m=null,g=null,v=null,_=null,y=null,x=null,M=null,S=new n.Q1f(0,0,0),b=0,T=!1,E=null,w=null,A=null,R=null,C=null,P=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS),I=!1,L=e.getParameter(e.VERSION);-1!==L.indexOf("WebGL")?I=parseFloat(/^WebGL (\d)/.exec(L)[1])>=1:-1!==L.indexOf("OpenGL ES")&&(I=parseFloat(/^OpenGL ES (\d)/.exec(L)[1])>=2);let D=null,U={},N=e.getParameter(e.SCISSOR_BOX),O=e.getParameter(e.VIEWPORT),F=new n.IUQ().fromArray(N),B=new n.IUQ().fromArray(O);function z(i,r,n,a){let s=new Uint8Array(4),o=e.createTexture();e.bindTexture(i,o),e.texParameteri(i,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(i,e.TEXTURE_MAG_FILTER,e.NEAREST);for(let o=0;o<n;o++)i===e.TEXTURE_3D||i===e.TEXTURE_2D_ARRAY?e.texImage3D(r,0,e.RGBA,1,1,a,0,e.RGBA,e.UNSIGNED_BYTE,s):e.texImage2D(r+o,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,s);return o}let k={};function V(i){!0!==c[i]&&(e.enable(i),c[i]=!0)}function H(i){!1!==c[i]&&(e.disable(i),c[i]=!1)}k[e.TEXTURE_2D]=z(e.TEXTURE_2D,e.TEXTURE_2D,1),k[e.TEXTURE_CUBE_MAP]=z(e.TEXTURE_CUBE_MAP,e.TEXTURE_CUBE_MAP_POSITIVE_X,6),k[e.TEXTURE_2D_ARRAY]=z(e.TEXTURE_2D_ARRAY,e.TEXTURE_2D_ARRAY,1,1),k[e.TEXTURE_3D]=z(e.TEXTURE_3D,e.TEXTURE_3D,1,1),r.setClear(0,0,0,1),a.setClear(1),s.setClear(0),V(e.DEPTH_TEST),a.setFunc(n.xSv),j(!1),q(n.Vb5),V(e.CULL_FACE),X(n.XIg);let G={[n.gO9]:e.FUNC_ADD,[n.FXf]:e.FUNC_SUBTRACT,[n.nST]:e.FUNC_REVERSE_SUBTRACT};G[n.znC]=e.MIN,G[n.$ei]=e.MAX;let W={[n.ojh]:e.ZERO,[n.qad]:e.ONE,[n.f4X]:e.SRC_COLOR,[n.ie2]:e.SRC_ALPHA,[n.hgQ]:e.SRC_ALPHA_SATURATE,[n.wn6]:e.DST_COLOR,[n.hdd]:e.DST_ALPHA,[n.LiQ]:e.ONE_MINUS_SRC_COLOR,[n.OuU]:e.ONE_MINUS_SRC_ALPHA,[n.aEY]:e.ONE_MINUS_DST_COLOR,[n.Nt7]:e.ONE_MINUS_DST_ALPHA,[n.RrE]:e.CONSTANT_COLOR,[n.$Yl]:e.ONE_MINUS_CONSTANT_COLOR,[n.e0p]:e.CONSTANT_ALPHA,[n.ov9]:e.ONE_MINUS_CONSTANT_ALPHA};function X(i,r,a,s,o,l,c,h,u,d){if(i===n.XIg){!0===f&&(H(e.BLEND),f=!1);return}if(!1===f&&(V(e.BLEND),f=!0),i!==n.bCz){if(i!==m||d!==T){if((g!==n.gO9||y!==n.gO9)&&(e.blendEquation(e.FUNC_ADD),g=n.gO9,y=n.gO9),d)switch(i){case n.NTi:e.blendFuncSeparate(e.ONE,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);break;case n.EZo:e.blendFunc(e.ONE,e.ONE);break;case n.Kwu:e.blendFuncSeparate(e.ZERO,e.ONE_MINUS_SRC_COLOR,e.ZERO,e.ONE);break;case n.EdD:e.blendFuncSeparate(e.DST_COLOR,e.ONE_MINUS_SRC_ALPHA,e.ZERO,e.ONE);break;default:(0,n.z3S)("WebGLState: Invalid blending: ",i)}else switch(i){case n.NTi:e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);break;case n.EZo:e.blendFuncSeparate(e.SRC_ALPHA,e.ONE,e.ONE,e.ONE);break;case n.Kwu:(0,n.z3S)("WebGLState: SubtractiveBlending requires material.premultipliedAlpha = true");break;case n.EdD:(0,n.z3S)("WebGLState: MultiplyBlending requires material.premultipliedAlpha = true");break;default:(0,n.z3S)("WebGLState: Invalid blending: ",i)}v=null,_=null,x=null,M=null,S.set(0,0,0),b=0,m=i,T=d}return}o=o||r,l=l||a,c=c||s,(r!==g||o!==y)&&(e.blendEquationSeparate(G[r],G[o]),g=r,y=o),(a!==v||s!==_||l!==x||c!==M)&&(e.blendFuncSeparate(W[a],W[s],W[l],W[c]),v=a,_=s,x=l,M=c),(!1===h.equals(S)||u!==b)&&(e.blendColor(h.r,h.g,h.b,u),S.copy(h),b=u),m=i,T=!1}function j(i){E!==i&&(i?e.frontFace(e.CW):e.frontFace(e.CCW),E=i)}function q(i){i!==n.WNZ?(V(e.CULL_FACE),i!==w&&(i===n.Vb5?e.cullFace(e.BACK):i===n.Jnc?e.cullFace(e.FRONT):e.cullFace(e.FRONT_AND_BACK))):H(e.CULL_FACE),w=i}function Y(i,r,n){i?(V(e.POLYGON_OFFSET_FILL),(R!==r||C!==n)&&(e.polygonOffset(r,n),R=r,C=n)):H(e.POLYGON_OFFSET_FILL)}return{buffers:{color:r,depth:a,stencil:s},enable:V,disable:H,bindFramebuffer:function(i,r){return h[i]!==r&&(e.bindFramebuffer(i,r),h[i]=r,i===e.DRAW_FRAMEBUFFER&&(h[e.FRAMEBUFFER]=r),i===e.FRAMEBUFFER&&(h[e.DRAW_FRAMEBUFFER]=r),!0)},drawBuffers:function(i,r){let n=d,a=!1;if(i){void 0===(n=u.get(r))&&(n=[],u.set(r,n));let s=i.textures;if(n.length!==s.length||n[0]!==e.COLOR_ATTACHMENT0){for(let i=0,r=s.length;i<r;i++)n[i]=e.COLOR_ATTACHMENT0+i;n.length=s.length,a=!0}}else n[0]!==e.BACK&&(n[0]=e.BACK,a=!0);a&&e.drawBuffers(n)},useProgram:function(i){return p!==i&&(e.useProgram(i),p=i,!0)},setBlending:X,setMaterial:function(i,o){i.side===n.$EB?H(e.CULL_FACE):V(e.CULL_FACE);let l=i.side===n.hsX;o&&(l=!l),j(l),i.blending===n.NTi&&!1===i.transparent?X(n.XIg):X(i.blending,i.blendEquation,i.blendSrc,i.blendDst,i.blendEquationAlpha,i.blendSrcAlpha,i.blendDstAlpha,i.blendColor,i.blendAlpha,i.premultipliedAlpha),a.setFunc(i.depthFunc),a.setTest(i.depthTest),a.setMask(i.depthWrite),r.setMask(i.colorWrite);let c=i.stencilWrite;s.setTest(c),c&&(s.setMask(i.stencilWriteMask),s.setFunc(i.stencilFunc,i.stencilRef,i.stencilFuncMask),s.setOp(i.stencilFail,i.stencilZFail,i.stencilZPass)),Y(i.polygonOffset,i.polygonOffsetFactor,i.polygonOffsetUnits),!0===i.alphaToCoverage?V(e.SAMPLE_ALPHA_TO_COVERAGE):H(e.SAMPLE_ALPHA_TO_COVERAGE)},setFlipSided:j,setCullFace:q,setLineWidth:function(i){i!==A&&(I&&e.lineWidth(i),A=i)},setPolygonOffset:Y,setScissorTest:function(i){i?V(e.SCISSOR_TEST):H(e.SCISSOR_TEST)},activeTexture:function(i){void 0===i&&(i=e.TEXTURE0+P-1),D!==i&&(e.activeTexture(i),D=i)},bindTexture:function(i,r,n){void 0===n&&(n=null===D?e.TEXTURE0+P-1:D);let a=U[n];void 0===a&&(a={type:void 0,texture:void 0},U[n]=a),(a.type!==i||a.texture!==r)&&(D!==n&&(e.activeTexture(n),D=n),e.bindTexture(i,r||k[i]),a.type=i,a.texture=r)},unbindTexture:function(){let i=U[D];void 0!==i&&void 0!==i.type&&(e.bindTexture(i.type,null),i.type=void 0,i.texture=void 0)},compressedTexImage2D:function(){try{e.compressedTexImage2D(...arguments)}catch(e){(0,n.z3S)("WebGLState:",e)}},compressedTexImage3D:function(){try{e.compressedTexImage3D(...arguments)}catch(e){(0,n.z3S)("WebGLState:",e)}},texImage2D:function(){try{e.texImage2D(...arguments)}catch(e){(0,n.z3S)("WebGLState:",e)}},texImage3D:function(){try{e.texImage3D(...arguments)}catch(e){(0,n.z3S)("WebGLState:",e)}},updateUBOMapping:function(i,r){let n=l.get(r);void 0===n&&(n=new WeakMap,l.set(r,n));let a=n.get(i);void 0===a&&(a=e.getUniformBlockIndex(r,i.name),n.set(i,a))},uniformBlockBinding:function(i,r){let n=l.get(r).get(i);o.get(r)!==n&&(e.uniformBlockBinding(r,n,i.__bindingPointIndex),o.set(r,n))},texStorage2D:function(){try{e.texStorage2D(...arguments)}catch(e){(0,n.z3S)("WebGLState:",e)}},texStorage3D:function(){try{e.texStorage3D(...arguments)}catch(e){(0,n.z3S)("WebGLState:",e)}},texSubImage2D:function(){try{e.texSubImage2D(...arguments)}catch(e){(0,n.z3S)("WebGLState:",e)}},texSubImage3D:function(){try{e.texSubImage3D(...arguments)}catch(e){(0,n.z3S)("WebGLState:",e)}},compressedTexSubImage2D:function(){try{e.compressedTexSubImage2D(...arguments)}catch(e){(0,n.z3S)("WebGLState:",e)}},compressedTexSubImage3D:function(){try{e.compressedTexSubImage3D(...arguments)}catch(e){(0,n.z3S)("WebGLState:",e)}},scissor:function(i){!1===F.equals(i)&&(e.scissor(i.x,i.y,i.z,i.w),F.copy(i))},viewport:function(i){!1===B.equals(i)&&(e.viewport(i.x,i.y,i.z,i.w),B.copy(i))},reset:function(){e.disable(e.BLEND),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.disable(e.POLYGON_OFFSET_FILL),e.disable(e.SCISSOR_TEST),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ONE,e.ZERO),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.blendColor(0,0,0,0),e.colorMask(!0,!0,!0,!0),e.clearColor(0,0,0,0),e.depthMask(!0),e.depthFunc(e.LESS),a.setReversed(!1),e.clearDepth(1),e.stencilMask(0xffffffff),e.stencilFunc(e.ALWAYS,0,0xffffffff),e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.clearStencil(0),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.activeTexture(e.TEXTURE0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),e.bindFramebuffer(e.READ_FRAMEBUFFER,null),e.useProgram(null),e.lineWidth(1),e.scissor(0,0,e.canvas.width,e.canvas.height),e.viewport(0,0,e.canvas.width,e.canvas.height),c={},D=null,U={},h={},u=new WeakMap,d=[],p=null,f=!1,m=null,g=null,v=null,_=null,y=null,x=null,M=null,S=new n.Q1f(0,0,0),b=0,T=!1,E=null,w=null,A=null,R=null,C=null,F.set(0,0,e.canvas.width,e.canvas.height),B.set(0,0,e.canvas.width,e.canvas.height),r.reset(),a.reset(),s.reset()}}}function tC(e,i,r,a,s,o,l){let c,h=i.has("WEBGL_multisampled_render_to_texture")?i.get("WEBGL_multisampled_render_to_texture"):null,u="u">typeof navigator&&/OculusBrowser/g.test(navigator.userAgent),d=new n.I9Y,p=new WeakMap,f=new WeakMap,m=!1;try{m="u">typeof OffscreenCanvas&&null!==new OffscreenCanvas(1,1).getContext("2d")}catch(e){}function g(e,i){return m?new OffscreenCanvas(e,i):(0,n.qq$)("canvas")}function v(e,i,r){let a=1,s=W(e);if((s.width>r||s.height>r)&&(a=r/Math.max(s.width,s.height)),a<1)if("u">typeof HTMLImageElement&&e instanceof HTMLImageElement||"u">typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"u">typeof ImageBitmap&&e instanceof ImageBitmap||"u">typeof VideoFrame&&e instanceof VideoFrame){let r=Math.floor(a*s.width),o=Math.floor(a*s.height);void 0===c&&(c=g(r,o));let l=i?g(r,o):c;return l.width=r,l.height=o,l.getContext("2d").drawImage(e,0,0,r,o),(0,n.R8M)("WebGLRenderer: Texture has been resized from ("+s.width+"x"+s.height+") to ("+r+"x"+o+")."),l}else"data"in e&&(0,n.R8M)("WebGLRenderer: Image in DataTexture is too big ("+s.width+"x"+s.height+").");return e}function _(e){return e.generateMipmaps}function y(i){e.generateMipmap(i)}function x(r,a,s,o,l=!1){if(null!==r){if(void 0!==e[r])return e[r];(0,n.R8M)("WebGLRenderer: Attempt to use non-existing WebGL internal format '"+r+"'")}let c=a;if(a===e.RED&&(s===e.FLOAT&&(c=e.R32F),s===e.HALF_FLOAT&&(c=e.R16F),s===e.UNSIGNED_BYTE&&(c=e.R8)),a===e.RED_INTEGER&&(s===e.UNSIGNED_BYTE&&(c=e.R8UI),s===e.UNSIGNED_SHORT&&(c=e.R16UI),s===e.UNSIGNED_INT&&(c=e.R32UI),s===e.BYTE&&(c=e.R8I),s===e.SHORT&&(c=e.R16I),s===e.INT&&(c=e.R32I)),a===e.RG&&(s===e.FLOAT&&(c=e.RG32F),s===e.HALF_FLOAT&&(c=e.RG16F),s===e.UNSIGNED_BYTE&&(c=e.RG8)),a===e.RG_INTEGER&&(s===e.UNSIGNED_BYTE&&(c=e.RG8UI),s===e.UNSIGNED_SHORT&&(c=e.RG16UI),s===e.UNSIGNED_INT&&(c=e.RG32UI),s===e.BYTE&&(c=e.RG8I),s===e.SHORT&&(c=e.RG16I),s===e.INT&&(c=e.RG32I)),a===e.RGB_INTEGER&&(s===e.UNSIGNED_BYTE&&(c=e.RGB8UI),s===e.UNSIGNED_SHORT&&(c=e.RGB16UI),s===e.UNSIGNED_INT&&(c=e.RGB32UI),s===e.BYTE&&(c=e.RGB8I),s===e.SHORT&&(c=e.RGB16I),s===e.INT&&(c=e.RGB32I)),a===e.RGBA_INTEGER&&(s===e.UNSIGNED_BYTE&&(c=e.RGBA8UI),s===e.UNSIGNED_SHORT&&(c=e.RGBA16UI),s===e.UNSIGNED_INT&&(c=e.RGBA32UI),s===e.BYTE&&(c=e.RGBA8I),s===e.SHORT&&(c=e.RGBA16I),s===e.INT&&(c=e.RGBA32I)),a===e.RGB&&(s===e.UNSIGNED_INT_5_9_9_9_REV&&(c=e.RGB9_E5),s===e.UNSIGNED_INT_10F_11F_11F_REV&&(c=e.R11F_G11F_B10F)),a===e.RGBA){let i=l?n.VxR:n.ppV.getTransfer(o);s===e.FLOAT&&(c=e.RGBA32F),s===e.HALF_FLOAT&&(c=e.RGBA16F),s===e.UNSIGNED_BYTE&&(c=i===n.KLL?e.SRGB8_ALPHA8:e.RGBA8),s===e.UNSIGNED_SHORT_4_4_4_4&&(c=e.RGBA4),s===e.UNSIGNED_SHORT_5_5_5_1&&(c=e.RGB5_A1)}return(c===e.R16F||c===e.R32F||c===e.RG16F||c===e.RG32F||c===e.RGBA16F||c===e.RGBA32F)&&i.get("EXT_color_buffer_float"),c}function M(i,r){let a;return i?null===r||r===n.bkx||r===n.V3x?a=e.DEPTH24_STENCIL8:r===n.RQf?a=e.DEPTH32F_STENCIL8:r===n.cHt&&(a=e.DEPTH24_STENCIL8,(0,n.R8M)("DepthTexture: 16 bit depth attachment is not supported with stencil. Using 24-bit attachment.")):null===r||r===n.bkx||r===n.V3x?a=e.DEPTH_COMPONENT24:r===n.RQf?a=e.DEPTH_COMPONENT32F:r===n.cHt&&(a=e.DEPTH_COMPONENT16),a}function S(e,i){return!0===_(e)||e.isFramebufferTexture&&e.minFilter!==n.hxR&&e.minFilter!==n.k6q?Math.log2(Math.max(i.width,i.height))+1:void 0!==e.mipmaps&&e.mipmaps.length>0?e.mipmaps.length:e.isCompressedTexture&&Array.isArray(e.image)?i.mipmaps.length:1}function b(e){let i=e.target;i.removeEventListener("dispose",b),function(e){let i=a.get(e);if(void 0===i.__webglInit)return;let r=e.source,n=f.get(r);if(n){let a=n[i.__cacheKey];a.usedTimes--,0===a.usedTimes&&E(e),0===Object.keys(n).length&&f.delete(r)}a.remove(e)}(i),i.isVideoTexture&&p.delete(i)}function T(i){let r=i.target;r.removeEventListener("dispose",T),function(i){let r=a.get(i);if(i.depthTexture&&(i.depthTexture.dispose(),a.remove(i.depthTexture)),i.isWebGLCubeRenderTarget)for(let i=0;i<6;i++){if(Array.isArray(r.__webglFramebuffer[i]))for(let n=0;n<r.__webglFramebuffer[i].length;n++)e.deleteFramebuffer(r.__webglFramebuffer[i][n]);else e.deleteFramebuffer(r.__webglFramebuffer[i]);r.__webglDepthbuffer&&e.deleteRenderbuffer(r.__webglDepthbuffer[i])}else{if(Array.isArray(r.__webglFramebuffer))for(let i=0;i<r.__webglFramebuffer.length;i++)e.deleteFramebuffer(r.__webglFramebuffer[i]);else e.deleteFramebuffer(r.__webglFramebuffer);if(r.__webglDepthbuffer&&e.deleteRenderbuffer(r.__webglDepthbuffer),r.__webglMultisampledFramebuffer&&e.deleteFramebuffer(r.__webglMultisampledFramebuffer),r.__webglColorRenderbuffer)for(let i=0;i<r.__webglColorRenderbuffer.length;i++)r.__webglColorRenderbuffer[i]&&e.deleteRenderbuffer(r.__webglColorRenderbuffer[i]);r.__webglDepthRenderbuffer&&e.deleteRenderbuffer(r.__webglDepthRenderbuffer)}let n=i.textures;for(let i=0,r=n.length;i<r;i++){let r=a.get(n[i]);r.__webglTexture&&(e.deleteTexture(r.__webglTexture),l.memory.textures--),a.remove(n[i])}a.remove(i)}(r)}function E(i){let r=a.get(i);e.deleteTexture(r.__webglTexture);let n=i.source,s=f.get(n);delete s[r.__cacheKey],l.memory.textures--}let w=0;function A(i,s){var o;let c,h=a.get(i);if(i.isVideoTexture&&(o=i,c=l.render.frame,p.get(o)!==c&&(p.set(o,c),o.update())),!1===i.isRenderTargetTexture&&!0!==i.isExternalTexture&&i.version>0&&h.__version!==i.version){let e=i.image;if(null===e)(0,n.R8M)("WebGLRenderer: Texture marked for update but no image data found.");else{if(!1!==e.complete)return void U(h,i,s);(0,n.R8M)("WebGLRenderer: Texture marked for update but image is incomplete")}}else i.isExternalTexture&&(h.__webglTexture=i.sourceTexture?i.sourceTexture:null);r.bindTexture(e.TEXTURE_2D,h.__webglTexture,e.TEXTURE0+s)}let R={[n.GJx]:e.REPEAT,[n.ghU]:e.CLAMP_TO_EDGE,[n.kTW]:e.MIRRORED_REPEAT},C={[n.hxR]:e.NEAREST,[n.pHI]:e.NEAREST_MIPMAP_NEAREST,[n.Cfg]:e.NEAREST_MIPMAP_LINEAR,[n.k6q]:e.LINEAR,[n.kRr]:e.LINEAR_MIPMAP_NEAREST,[n.$_I]:e.LINEAR_MIPMAP_LINEAR},P={[n.amv]:e.NEVER,[n.FFZ]:e.ALWAYS,[n.vim]:e.LESS,[n.TiK]:e.LEQUAL,[n.kO0]:e.EQUAL,[n.gWB]:e.GEQUAL,[n.eoi]:e.GREATER,[n.jzd]:e.NOTEQUAL};function I(r,o){if((o.type===n.RQf&&!1===i.has("OES_texture_float_linear")&&(o.magFilter===n.k6q||o.magFilter===n.kRr||o.magFilter===n.Cfg||o.magFilter===n.$_I||o.minFilter===n.k6q||o.minFilter===n.kRr||o.minFilter===n.Cfg||o.minFilter===n.$_I)&&(0,n.R8M)("WebGLRenderer: Unable to use linear filtering with floating point textures. OES_texture_float_linear not supported on this device."),e.texParameteri(r,e.TEXTURE_WRAP_S,R[o.wrapS]),e.texParameteri(r,e.TEXTURE_WRAP_T,R[o.wrapT]),(r===e.TEXTURE_3D||r===e.TEXTURE_2D_ARRAY)&&e.texParameteri(r,e.TEXTURE_WRAP_R,R[o.wrapR]),e.texParameteri(r,e.TEXTURE_MAG_FILTER,C[o.magFilter]),e.texParameteri(r,e.TEXTURE_MIN_FILTER,C[o.minFilter]),o.compareFunction&&(e.texParameteri(r,e.TEXTURE_COMPARE_MODE,e.COMPARE_REF_TO_TEXTURE),e.texParameteri(r,e.TEXTURE_COMPARE_FUNC,P[o.compareFunction])),!0===i.has("EXT_texture_filter_anisotropic"))&&o.magFilter!==n.hxR&&(o.minFilter===n.Cfg||o.minFilter===n.$_I)&&(o.type!==n.RQf||!1!==i.has("OES_texture_float_linear"))&&(o.anisotropy>1||a.get(o).__currentAnisotropy)){let n=i.get("EXT_texture_filter_anisotropic");e.texParameterf(r,n.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(o.anisotropy,s.getMaxAnisotropy())),a.get(o).__currentAnisotropy=o.anisotropy}}function L(i,r){let n,a=!1;void 0===i.__webglInit&&(i.__webglInit=!0,r.addEventListener("dispose",b));let s=r.source,o=f.get(s);void 0===o&&(o={},f.set(s,o));let c=((n=[]).push(r.wrapS),n.push(r.wrapT),n.push(r.wrapR||0),n.push(r.magFilter),n.push(r.minFilter),n.push(r.anisotropy),n.push(r.internalFormat),n.push(r.format),n.push(r.type),n.push(r.generateMipmaps),n.push(r.premultiplyAlpha),n.push(r.flipY),n.push(r.unpackAlignment),n.push(r.colorSpace),n.join());if(c!==i.__cacheKey){void 0===o[c]&&(o[c]={texture:e.createTexture(),usedTimes:0},l.memory.textures++,a=!0),o[c].usedTimes++;let n=o[i.__cacheKey];void 0!==n&&(o[i.__cacheKey].usedTimes--,0===n.usedTimes&&E(r)),i.__cacheKey=c,i.__webglTexture=o[c].texture}return a}function D(e,i,r){return Math.floor(Math.floor(e/r)/i)}function U(i,l,c){let h=e.TEXTURE_2D;(l.isDataArrayTexture||l.isCompressedArrayTexture)&&(h=e.TEXTURE_2D_ARRAY),l.isData3DTexture&&(h=e.TEXTURE_3D);let u=L(i,l),d=l.source;r.bindTexture(h,i.__webglTexture,e.TEXTURE0+c);let p=a.get(d);if(d.version!==p.__version||!0===u){let i;r.activeTexture(e.TEXTURE0+c);let a=n.ppV.getPrimaries(n.ppV.workingColorSpace),f=l.colorSpace===n.jf0?null:n.ppV.getPrimaries(l.colorSpace),m=l.colorSpace===n.jf0||a===f?e.NONE:e.BROWSER_DEFAULT_WEBGL;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,l.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,l.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,l.unpackAlignment),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,m);let g=v(l.image,!1,s.maxTextureSize);g=G(l,g);let b=o.convert(l.format,l.colorSpace),T=o.convert(l.type),E=x(l.internalFormat,b,T,l.colorSpace,l.isVideoTexture);I(h,l);let w=l.mipmaps,A=!0!==l.isVideoTexture,R=void 0===p.__version||!0===u,C=d.dataReady,P=S(l,g);if(l.isDepthTexture)E=M(l.format===n.dcC,l.type),R&&(A?r.texStorage2D(e.TEXTURE_2D,1,E,g.width,g.height):r.texImage2D(e.TEXTURE_2D,0,E,g.width,g.height,0,b,T,null));else if(l.isDataTexture)if(w.length>0){A&&R&&r.texStorage2D(e.TEXTURE_2D,P,E,w[0].width,w[0].height);for(let n=0,a=w.length;n<a;n++)i=w[n],A?C&&r.texSubImage2D(e.TEXTURE_2D,n,0,0,i.width,i.height,b,T,i.data):r.texImage2D(e.TEXTURE_2D,n,E,i.width,i.height,0,b,T,i.data);l.generateMipmaps=!1}else A?(R&&r.texStorage2D(e.TEXTURE_2D,P,E,g.width,g.height),C&&function(i,n,a,s){let o=i.updateRanges;if(0===o.length)r.texSubImage2D(e.TEXTURE_2D,0,0,0,n.width,n.height,a,s,n.data);else{o.sort((e,i)=>e.start-i.start);let l=0;for(let e=1;e<o.length;e++){let i=o[l],r=o[e],a=i.start+i.count,s=D(r.start,n.width,4),c=D(i.start,n.width,4);r.start<=a+1&&s===c&&D(r.start+r.count-1,n.width,4)===s?i.count=Math.max(i.count,r.start+r.count-i.start):o[++l]=r}o.length=l+1;let c=e.getParameter(e.UNPACK_ROW_LENGTH),h=e.getParameter(e.UNPACK_SKIP_PIXELS),u=e.getParameter(e.UNPACK_SKIP_ROWS);e.pixelStorei(e.UNPACK_ROW_LENGTH,n.width);for(let i=0,l=o.length;i<l;i++){let l=o[i],c=Math.floor(l.start/4),h=Math.ceil(l.count/4),u=c%n.width,d=Math.floor(c/n.width);e.pixelStorei(e.UNPACK_SKIP_PIXELS,u),e.pixelStorei(e.UNPACK_SKIP_ROWS,d),r.texSubImage2D(e.TEXTURE_2D,0,u,d,h,1,a,s,n.data)}i.clearUpdateRanges(),e.pixelStorei(e.UNPACK_ROW_LENGTH,c),e.pixelStorei(e.UNPACK_SKIP_PIXELS,h),e.pixelStorei(e.UNPACK_SKIP_ROWS,u)}}(l,g,b,T)):r.texImage2D(e.TEXTURE_2D,0,E,g.width,g.height,0,b,T,g.data);else if(l.isCompressedTexture)if(l.isCompressedArrayTexture){A&&R&&r.texStorage3D(e.TEXTURE_2D_ARRAY,P,E,w[0].width,w[0].height,g.depth);for(let a=0,s=w.length;a<s;a++)if(i=w[a],l.format!==n.GWd)if(null!==b)if(A){if(C)if(l.layerUpdates.size>0){let s=(0,n.Nex)(i.width,i.height,l.format,l.type);for(let n of l.layerUpdates){let o=i.data.subarray(n*s/i.data.BYTES_PER_ELEMENT,(n+1)*s/i.data.BYTES_PER_ELEMENT);r.compressedTexSubImage3D(e.TEXTURE_2D_ARRAY,a,0,0,n,i.width,i.height,1,b,o)}l.clearLayerUpdates()}else r.compressedTexSubImage3D(e.TEXTURE_2D_ARRAY,a,0,0,0,i.width,i.height,g.depth,b,i.data)}else r.compressedTexImage3D(e.TEXTURE_2D_ARRAY,a,E,i.width,i.height,g.depth,0,i.data,0,0);else(0,n.R8M)("WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()");else A?C&&r.texSubImage3D(e.TEXTURE_2D_ARRAY,a,0,0,0,i.width,i.height,g.depth,b,T,i.data):r.texImage3D(e.TEXTURE_2D_ARRAY,a,E,i.width,i.height,g.depth,0,b,T,i.data)}else{A&&R&&r.texStorage2D(e.TEXTURE_2D,P,E,w[0].width,w[0].height);for(let a=0,s=w.length;a<s;a++)i=w[a],l.format!==n.GWd?null!==b?A?C&&r.compressedTexSubImage2D(e.TEXTURE_2D,a,0,0,i.width,i.height,b,i.data):r.compressedTexImage2D(e.TEXTURE_2D,a,E,i.width,i.height,0,i.data):(0,n.R8M)("WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):A?C&&r.texSubImage2D(e.TEXTURE_2D,a,0,0,i.width,i.height,b,T,i.data):r.texImage2D(e.TEXTURE_2D,a,E,i.width,i.height,0,b,T,i.data)}else if(l.isDataArrayTexture)if(A){if(R&&r.texStorage3D(e.TEXTURE_2D_ARRAY,P,E,g.width,g.height,g.depth),C)if(l.layerUpdates.size>0){let i=(0,n.Nex)(g.width,g.height,l.format,l.type);for(let n of l.layerUpdates){let a=g.data.subarray(n*i/g.data.BYTES_PER_ELEMENT,(n+1)*i/g.data.BYTES_PER_ELEMENT);r.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,n,g.width,g.height,1,b,T,a)}l.clearLayerUpdates()}else r.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,0,g.width,g.height,g.depth,b,T,g.data)}else r.texImage3D(e.TEXTURE_2D_ARRAY,0,E,g.width,g.height,g.depth,0,b,T,g.data);else if(l.isData3DTexture)A?(R&&r.texStorage3D(e.TEXTURE_3D,P,E,g.width,g.height,g.depth),C&&r.texSubImage3D(e.TEXTURE_3D,0,0,0,0,g.width,g.height,g.depth,b,T,g.data)):r.texImage3D(e.TEXTURE_3D,0,E,g.width,g.height,g.depth,0,b,T,g.data);else if(l.isFramebufferTexture){if(R)if(A)r.texStorage2D(e.TEXTURE_2D,P,E,g.width,g.height);else{let i=g.width,n=g.height;for(let a=0;a<P;a++)r.texImage2D(e.TEXTURE_2D,a,E,i,n,0,b,T,null),i>>=1,n>>=1}}else if(w.length>0){if(A&&R){let i=W(w[0]);r.texStorage2D(e.TEXTURE_2D,P,E,i.width,i.height)}for(let n=0,a=w.length;n<a;n++)i=w[n],A?C&&r.texSubImage2D(e.TEXTURE_2D,n,0,0,b,T,i):r.texImage2D(e.TEXTURE_2D,n,E,b,T,i);l.generateMipmaps=!1}else if(A){if(R){let i=W(g);r.texStorage2D(e.TEXTURE_2D,P,E,i.width,i.height)}C&&r.texSubImage2D(e.TEXTURE_2D,0,0,0,b,T,g)}else r.texImage2D(e.TEXTURE_2D,0,E,b,T,g);_(l)&&y(h),p.__version=d.version,l.onUpdate&&l.onUpdate(l)}i.__version=l.version}function N(i,n,s,l,c,u){let d=o.convert(s.format,s.colorSpace),p=o.convert(s.type),f=x(s.internalFormat,d,p,s.colorSpace),m=a.get(n),g=a.get(s);if(g.__renderTarget=n,!m.__hasExternalTextures){let i=Math.max(1,n.width>>u),a=Math.max(1,n.height>>u);c===e.TEXTURE_3D||c===e.TEXTURE_2D_ARRAY?r.texImage3D(c,u,f,i,a,n.depth,0,d,p,null):r.texImage2D(c,u,f,i,a,0,d,p,null)}r.bindFramebuffer(e.FRAMEBUFFER,i),H(n)?h.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,l,c,g.__webglTexture,0,V(n)):(c===e.TEXTURE_2D||c>=e.TEXTURE_CUBE_MAP_POSITIVE_X&&c<=e.TEXTURE_CUBE_MAP_NEGATIVE_Z)&&e.framebufferTexture2D(e.FRAMEBUFFER,l,c,g.__webglTexture,u),r.bindFramebuffer(e.FRAMEBUFFER,null)}function O(i,r,n){if(e.bindRenderbuffer(e.RENDERBUFFER,i),r.depthBuffer){let a=r.depthTexture,s=a&&a.isDepthTexture?a.type:null,o=M(r.stencilBuffer,s),l=r.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT;H(r)?h.renderbufferStorageMultisampleEXT(e.RENDERBUFFER,V(r),o,r.width,r.height):n?e.renderbufferStorageMultisample(e.RENDERBUFFER,V(r),o,r.width,r.height):e.renderbufferStorage(e.RENDERBUFFER,o,r.width,r.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,l,e.RENDERBUFFER,i)}else{let i=r.textures;for(let a=0;a<i.length;a++){let s=i[a],l=o.convert(s.format,s.colorSpace),c=o.convert(s.type),u=x(s.internalFormat,l,c,s.colorSpace);H(r)?h.renderbufferStorageMultisampleEXT(e.RENDERBUFFER,V(r),u,r.width,r.height):n?e.renderbufferStorageMultisample(e.RENDERBUFFER,V(r),u,r.width,r.height):e.renderbufferStorage(e.RENDERBUFFER,u,r.width,r.height)}}e.bindRenderbuffer(e.RENDERBUFFER,null)}function F(i,s,l){let c=!0===s.isWebGLCubeRenderTarget;if(r.bindFramebuffer(e.FRAMEBUFFER,i),!(s.depthTexture&&s.depthTexture.isDepthTexture))throw Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");let u=a.get(s.depthTexture);if(u.__renderTarget=s,u.__webglTexture&&s.depthTexture.image.width===s.width&&s.depthTexture.image.height===s.height||(s.depthTexture.image.width=s.width,s.depthTexture.image.height=s.height,s.depthTexture.needsUpdate=!0),c){if(void 0===u.__webglInit&&(u.__webglInit=!0,s.depthTexture.addEventListener("dispose",b)),void 0===u.__webglTexture){let i;u.__webglTexture=e.createTexture(),r.bindTexture(e.TEXTURE_CUBE_MAP,u.__webglTexture),I(e.TEXTURE_CUBE_MAP,s.depthTexture);let a=o.convert(s.depthTexture.format),l=o.convert(s.depthTexture.type);s.depthTexture.format===n.zdS?i=e.DEPTH_COMPONENT24:s.depthTexture.format===n.dcC&&(i=e.DEPTH24_STENCIL8);for(let r=0;r<6;r++)e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+r,0,i,s.width,s.height,0,a,l,null)}}else A(s.depthTexture,0);let d=u.__webglTexture,p=V(s),f=c?e.TEXTURE_CUBE_MAP_POSITIVE_X+l:e.TEXTURE_2D,m=s.depthTexture.format===n.dcC?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT;if(s.depthTexture.format===n.zdS)H(s)?h.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,m,f,d,0,p):e.framebufferTexture2D(e.FRAMEBUFFER,m,f,d,0);else if(s.depthTexture.format===n.dcC)H(s)?h.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,m,f,d,0,p):e.framebufferTexture2D(e.FRAMEBUFFER,m,f,d,0);else throw Error("Unknown depthTexture format")}function B(i){let n=a.get(i),s=!0===i.isWebGLCubeRenderTarget;if(n.__boundDepthTexture!==i.depthTexture){let e=i.depthTexture;if(n.__depthDisposeCallback&&n.__depthDisposeCallback(),e){let i=()=>{delete n.__boundDepthTexture,delete n.__depthDisposeCallback,e.removeEventListener("dispose",i)};e.addEventListener("dispose",i),n.__depthDisposeCallback=i}n.__boundDepthTexture=e}if(i.depthTexture&&!n.__autoAllocateDepthBuffer)if(s)for(let e=0;e<6;e++)F(n.__webglFramebuffer[e],i,e);else{let e=i.texture.mipmaps;e&&e.length>0?F(n.__webglFramebuffer[0],i,0):F(n.__webglFramebuffer,i,0)}else if(s){n.__webglDepthbuffer=[];for(let a=0;a<6;a++)if(r.bindFramebuffer(e.FRAMEBUFFER,n.__webglFramebuffer[a]),void 0===n.__webglDepthbuffer[a])n.__webglDepthbuffer[a]=e.createRenderbuffer(),O(n.__webglDepthbuffer[a],i,!1);else{let r=i.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,s=n.__webglDepthbuffer[a];e.bindRenderbuffer(e.RENDERBUFFER,s),e.framebufferRenderbuffer(e.FRAMEBUFFER,r,e.RENDERBUFFER,s)}}else{let a=i.texture.mipmaps;if(a&&a.length>0?r.bindFramebuffer(e.FRAMEBUFFER,n.__webglFramebuffer[0]):r.bindFramebuffer(e.FRAMEBUFFER,n.__webglFramebuffer),void 0===n.__webglDepthbuffer)n.__webglDepthbuffer=e.createRenderbuffer(),O(n.__webglDepthbuffer,i,!1);else{let r=i.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,a=n.__webglDepthbuffer;e.bindRenderbuffer(e.RENDERBUFFER,a),e.framebufferRenderbuffer(e.FRAMEBUFFER,r,e.RENDERBUFFER,a)}}r.bindFramebuffer(e.FRAMEBUFFER,null)}let z=[],k=[];function V(e){return Math.min(s.maxSamples,e.samples)}function H(e){let r=a.get(e);return e.samples>0&&!0===i.has("WEBGL_multisampled_render_to_texture")&&!1!==r.__useRenderToTexture}function G(e,i){let r=e.colorSpace,a=e.format,s=e.type;return!0===e.isCompressedTexture||!0===e.isVideoTexture||r!==n.Zr2&&r!==n.jf0&&(n.ppV.getTransfer(r)===n.KLL?(a!==n.GWd||s!==n.OUM)&&(0,n.R8M)("WebGLTextures: sRGB encoded textures have to use RGBAFormat and UnsignedByteType."):(0,n.z3S)("WebGLTextures: Unsupported texture color space:",r)),i}function W(e){return"u">typeof HTMLImageElement&&e instanceof HTMLImageElement?(d.width=e.naturalWidth||e.width,d.height=e.naturalHeight||e.height):"u">typeof VideoFrame&&e instanceof VideoFrame?(d.width=e.displayWidth,d.height=e.displayHeight):(d.width=e.width,d.height=e.height),d}this.allocateTextureUnit=function(){let e=w;return e>=s.maxTextures&&(0,n.R8M)("WebGLTextures: Trying to use "+e+" texture units while this GPU supports only "+s.maxTextures),w+=1,e},this.resetTextureUnits=function(){w=0},this.setTexture2D=A,this.setTexture2DArray=function(i,n){let s=a.get(i);!1===i.isRenderTargetTexture&&i.version>0&&s.__version!==i.version?U(s,i,n):(i.isExternalTexture&&(s.__webglTexture=i.sourceTexture?i.sourceTexture:null),r.bindTexture(e.TEXTURE_2D_ARRAY,s.__webglTexture,e.TEXTURE0+n))},this.setTexture3D=function(i,n){let s=a.get(i);!1===i.isRenderTargetTexture&&i.version>0&&s.__version!==i.version?U(s,i,n):r.bindTexture(e.TEXTURE_3D,s.__webglTexture,e.TEXTURE0+n)},this.setTextureCube=function(i,l){let c=a.get(i);!0!==i.isCubeDepthTexture&&i.version>0&&c.__version!==i.version?function(i,l,c){if(6!==l.image.length)return;let h=L(i,l),u=l.source;r.bindTexture(e.TEXTURE_CUBE_MAP,i.__webglTexture,e.TEXTURE0+c);let d=a.get(u);if(u.version!==d.__version||!0===h){let i;r.activeTexture(e.TEXTURE0+c);let a=n.ppV.getPrimaries(n.ppV.workingColorSpace),p=l.colorSpace===n.jf0?null:n.ppV.getPrimaries(l.colorSpace),f=l.colorSpace===n.jf0||a===p?e.NONE:e.BROWSER_DEFAULT_WEBGL;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,l.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,l.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,l.unpackAlignment),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,f);let m=l.isCompressedTexture||l.image[0].isCompressedTexture,g=l.image[0]&&l.image[0].isDataTexture,M=[];for(let e=0;e<6;e++)m||g?M[e]=g?l.image[e].image:l.image[e]:M[e]=v(l.image[e],!0,s.maxCubemapSize),M[e]=G(l,M[e]);let b=M[0],T=o.convert(l.format,l.colorSpace),E=o.convert(l.type),w=x(l.internalFormat,T,E,l.colorSpace),A=!0!==l.isVideoTexture,R=void 0===d.__version||!0===h,C=u.dataReady,P=S(l,b);if(I(e.TEXTURE_CUBE_MAP,l),m){A&&R&&r.texStorage2D(e.TEXTURE_CUBE_MAP,P,w,b.width,b.height);for(let a=0;a<6;a++){i=M[a].mipmaps;for(let s=0;s<i.length;s++){let o=i[s];l.format!==n.GWd?null!==T?A?C&&r.compressedTexSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+a,s,0,0,o.width,o.height,T,o.data):r.compressedTexImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+a,s,w,o.width,o.height,0,o.data):(0,n.R8M)("WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):A?C&&r.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+a,s,0,0,o.width,o.height,T,E,o.data):r.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+a,s,w,o.width,o.height,0,T,E,o.data)}}}else{if(i=l.mipmaps,A&&R){i.length>0&&P++;let n=W(M[0]);r.texStorage2D(e.TEXTURE_CUBE_MAP,P,w,n.width,n.height)}for(let n=0;n<6;n++)if(g){A?C&&r.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+n,0,0,0,M[n].width,M[n].height,T,E,M[n].data):r.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+n,0,w,M[n].width,M[n].height,0,T,E,M[n].data);for(let a=0;a<i.length;a++){let s=i[a].image[n].image;A?C&&r.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+n,a+1,0,0,s.width,s.height,T,E,s.data):r.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+n,a+1,w,s.width,s.height,0,T,E,s.data)}}else{A?C&&r.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+n,0,0,0,T,E,M[n]):r.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+n,0,w,T,E,M[n]);for(let a=0;a<i.length;a++){let s=i[a];A?C&&r.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+n,a+1,0,0,T,E,s.image[n]):r.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+n,a+1,w,T,E,s.image[n])}}}_(l)&&y(e.TEXTURE_CUBE_MAP),d.__version=u.version,l.onUpdate&&l.onUpdate(l)}i.__version=l.version}(c,i,l):r.bindTexture(e.TEXTURE_CUBE_MAP,c.__webglTexture,e.TEXTURE0+l)},this.rebindTextures=function(i,r,n){let s=a.get(i);void 0!==r&&N(s.__webglFramebuffer,i,i.texture,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,0),void 0!==n&&B(i)},this.setupRenderTarget=function(i){let n=i.texture,s=a.get(i),c=a.get(n);i.addEventListener("dispose",T);let h=i.textures,u=!0===i.isWebGLCubeRenderTarget,d=h.length>1;if(!d&&(void 0===c.__webglTexture&&(c.__webglTexture=e.createTexture()),c.__version=n.version,l.memory.textures++),u){s.__webglFramebuffer=[];for(let i=0;i<6;i++)if(n.mipmaps&&n.mipmaps.length>0){s.__webglFramebuffer[i]=[];for(let r=0;r<n.mipmaps.length;r++)s.__webglFramebuffer[i][r]=e.createFramebuffer()}else s.__webglFramebuffer[i]=e.createFramebuffer()}else{if(n.mipmaps&&n.mipmaps.length>0){s.__webglFramebuffer=[];for(let i=0;i<n.mipmaps.length;i++)s.__webglFramebuffer[i]=e.createFramebuffer()}else s.__webglFramebuffer=e.createFramebuffer();if(d)for(let i=0,r=h.length;i<r;i++){let r=a.get(h[i]);void 0===r.__webglTexture&&(r.__webglTexture=e.createTexture(),l.memory.textures++)}if(i.samples>0&&!1===H(i)){s.__webglMultisampledFramebuffer=e.createFramebuffer(),s.__webglColorRenderbuffer=[],r.bindFramebuffer(e.FRAMEBUFFER,s.__webglMultisampledFramebuffer);for(let r=0;r<h.length;r++){let n=h[r];s.__webglColorRenderbuffer[r]=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,s.__webglColorRenderbuffer[r]);let a=o.convert(n.format,n.colorSpace),l=o.convert(n.type),c=x(n.internalFormat,a,l,n.colorSpace,!0===i.isXRRenderTarget),u=V(i);e.renderbufferStorageMultisample(e.RENDERBUFFER,u,c,i.width,i.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+r,e.RENDERBUFFER,s.__webglColorRenderbuffer[r])}e.bindRenderbuffer(e.RENDERBUFFER,null),i.depthBuffer&&(s.__webglDepthRenderbuffer=e.createRenderbuffer(),O(s.__webglDepthRenderbuffer,i,!0)),r.bindFramebuffer(e.FRAMEBUFFER,null)}}if(u){r.bindTexture(e.TEXTURE_CUBE_MAP,c.__webglTexture),I(e.TEXTURE_CUBE_MAP,n);for(let r=0;r<6;r++)if(n.mipmaps&&n.mipmaps.length>0)for(let a=0;a<n.mipmaps.length;a++)N(s.__webglFramebuffer[r][a],i,n,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+r,a);else N(s.__webglFramebuffer[r],i,n,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+r,0);_(n)&&y(e.TEXTURE_CUBE_MAP),r.unbindTexture()}else if(d){for(let n=0,o=h.length;n<o;n++){let o=h[n],l=a.get(o),c=e.TEXTURE_2D;(i.isWebGL3DRenderTarget||i.isWebGLArrayRenderTarget)&&(c=i.isWebGL3DRenderTarget?e.TEXTURE_3D:e.TEXTURE_2D_ARRAY),r.bindTexture(c,l.__webglTexture),I(c,o),N(s.__webglFramebuffer,i,o,e.COLOR_ATTACHMENT0+n,c,0),_(o)&&y(c)}r.unbindTexture()}else{let a=e.TEXTURE_2D;if((i.isWebGL3DRenderTarget||i.isWebGLArrayRenderTarget)&&(a=i.isWebGL3DRenderTarget?e.TEXTURE_3D:e.TEXTURE_2D_ARRAY),r.bindTexture(a,c.__webglTexture),I(a,n),n.mipmaps&&n.mipmaps.length>0)for(let r=0;r<n.mipmaps.length;r++)N(s.__webglFramebuffer[r],i,n,e.COLOR_ATTACHMENT0,a,r);else N(s.__webglFramebuffer,i,n,e.COLOR_ATTACHMENT0,a,0);_(n)&&y(a),r.unbindTexture()}i.depthBuffer&&B(i)},this.updateRenderTargetMipmap=function(i){let n=i.textures;for(let s=0,o=n.length;s<o;s++){let o=n[s];if(_(o)){let n=i.isWebGLCubeRenderTarget?e.TEXTURE_CUBE_MAP:i.isWebGL3DRenderTarget?e.TEXTURE_3D:i.isWebGLArrayRenderTarget||i.isCompressedArrayTexture?e.TEXTURE_2D_ARRAY:e.TEXTURE_2D,s=a.get(o).__webglTexture;r.bindTexture(n,s),y(n),r.unbindTexture()}}},this.updateMultisampleRenderTarget=function(i){if(i.samples>0){if(!1===H(i)){let n=i.textures,s=i.width,o=i.height,l=e.COLOR_BUFFER_BIT,c=i.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,h=a.get(i),d=n.length>1;if(d)for(let i=0;i<n.length;i++)r.bindFramebuffer(e.FRAMEBUFFER,h.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+i,e.RENDERBUFFER,null),r.bindFramebuffer(e.FRAMEBUFFER,h.__webglFramebuffer),e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0+i,e.TEXTURE_2D,null,0);r.bindFramebuffer(e.READ_FRAMEBUFFER,h.__webglMultisampledFramebuffer);let p=i.texture.mipmaps;p&&p.length>0?r.bindFramebuffer(e.DRAW_FRAMEBUFFER,h.__webglFramebuffer[0]):r.bindFramebuffer(e.DRAW_FRAMEBUFFER,h.__webglFramebuffer);for(let r=0;r<n.length;r++){if(i.resolveDepthBuffer&&(i.depthBuffer&&(l|=e.DEPTH_BUFFER_BIT),i.stencilBuffer&&i.resolveStencilBuffer&&(l|=e.STENCIL_BUFFER_BIT)),d){e.framebufferRenderbuffer(e.READ_FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.RENDERBUFFER,h.__webglColorRenderbuffer[r]);let i=a.get(n[r]).__webglTexture;e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,i,0)}e.blitFramebuffer(0,0,s,o,0,0,s,o,l,e.NEAREST),!0===u&&(z.length=0,k.length=0,z.push(e.COLOR_ATTACHMENT0+r),i.depthBuffer&&!1===i.resolveDepthBuffer&&(z.push(c),k.push(c),e.invalidateFramebuffer(e.DRAW_FRAMEBUFFER,k)),e.invalidateFramebuffer(e.READ_FRAMEBUFFER,z))}if(r.bindFramebuffer(e.READ_FRAMEBUFFER,null),r.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),d)for(let i=0;i<n.length;i++){r.bindFramebuffer(e.FRAMEBUFFER,h.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+i,e.RENDERBUFFER,h.__webglColorRenderbuffer[i]);let s=a.get(n[i]).__webglTexture;r.bindFramebuffer(e.FRAMEBUFFER,h.__webglFramebuffer),e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0+i,e.TEXTURE_2D,s,0)}r.bindFramebuffer(e.DRAW_FRAMEBUFFER,h.__webglMultisampledFramebuffer)}else if(i.depthBuffer&&!1===i.resolveDepthBuffer&&u){let r=i.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT;e.invalidateFramebuffer(e.DRAW_FRAMEBUFFER,[r])}}},this.setupDepthRenderbuffer=B,this.setupFrameBufferTexture=N,this.useMultisampledRTT=H,this.isReversedDepthBuffer=function(){return r.buffers.depth.getReversed()}}function tP(e,i){return{convert:function(r,a=n.jf0){let s,o=n.ppV.getTransfer(a);if(r===n.OUM)return e.UNSIGNED_BYTE;if(r===n.Wew)return e.UNSIGNED_SHORT_4_4_4_4;if(r===n.gJ2)return e.UNSIGNED_SHORT_5_5_5_1;if(r===n.Dmk)return e.UNSIGNED_INT_5_9_9_9_REV;if(r===n.yT7)return e.UNSIGNED_INT_10F_11F_11F_REV;if(r===n.tJf)return e.BYTE;if(r===n.fBL)return e.SHORT;if(r===n.cHt)return e.UNSIGNED_SHORT;if(r===n.Yuy)return e.INT;if(r===n.bkx)return e.UNSIGNED_INT;if(r===n.RQf)return e.FLOAT;if(r===n.ix0)return e.HALF_FLOAT;if(r===n.wrO)return e.ALPHA;if(r===n.HIg)return e.RGB;if(r===n.GWd)return e.RGBA;if(r===n.zdS)return e.DEPTH_COMPONENT;if(r===n.dcC)return e.DEPTH_STENCIL;if(r===n.VT0)return e.RED;if(r===n.ZQM)return e.RED_INTEGER;if(r===n.paN)return e.RG;if(r===n.TkQ)return e.RG_INTEGER;if(r===n.c90)return e.RGBA_INTEGER;if(r===n.IE4||r===n.Nz6||r===n.jR7||r===n.BXX)if(o===n.KLL){if(null===(s=i.get("WEBGL_compressed_texture_s3tc_srgb")))return null;if(r===n.IE4)return s.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(r===n.Nz6)return s.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(r===n.jR7)return s.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(r===n.BXX)return s.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else{if(null===(s=i.get("WEBGL_compressed_texture_s3tc")))return null;if(r===n.IE4)return s.COMPRESSED_RGB_S3TC_DXT1_EXT;if(r===n.Nz6)return s.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(r===n.jR7)return s.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(r===n.BXX)return s.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(r===n.k6Q||r===n.kTp||r===n.HXV||r===n.pBf){if(null===(s=i.get("WEBGL_compressed_texture_pvrtc")))return null;if(r===n.k6Q)return s.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(r===n.kTp)return s.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(r===n.HXV)return s.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(r===n.pBf)return s.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(r===n.CVz||r===n.Riy||r===n.KDk||r===n.BVL||r===n.gZr||r===n.OtU||r===n.jSS){if(null===(s=i.get("WEBGL_compressed_texture_etc")))return null;if(r===n.CVz||r===n.Riy)return o===n.KLL?s.COMPRESSED_SRGB8_ETC2:s.COMPRESSED_RGB8_ETC2;if(r===n.KDk)return o===n.KLL?s.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:s.COMPRESSED_RGBA8_ETC2_EAC;if(r===n.BVL)return s.COMPRESSED_R11_EAC;if(r===n.gZr)return s.COMPRESSED_SIGNED_R11_EAC;if(r===n.OtU)return s.COMPRESSED_RG11_EAC;if(r===n.jSS)return s.COMPRESSED_SIGNED_RG11_EAC}if(r===n.qa3||r===n.B_h||r===n.czI||r===n.rSH||r===n.Qrf||r===n.psI||r===n.a5J||r===n._QJ||r===n.uB5||r===n.lyL||r===n.bC7||r===n.y3Z||r===n.ojs||r===n.S$4){if(null===(s=i.get("WEBGL_compressed_texture_astc")))return null;if(r===n.qa3)return o===n.KLL?s.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:s.COMPRESSED_RGBA_ASTC_4x4_KHR;if(r===n.B_h)return o===n.KLL?s.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:s.COMPRESSED_RGBA_ASTC_5x4_KHR;if(r===n.czI)return o===n.KLL?s.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:s.COMPRESSED_RGBA_ASTC_5x5_KHR;if(r===n.rSH)return o===n.KLL?s.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:s.COMPRESSED_RGBA_ASTC_6x5_KHR;if(r===n.Qrf)return o===n.KLL?s.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:s.COMPRESSED_RGBA_ASTC_6x6_KHR;if(r===n.psI)return o===n.KLL?s.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:s.COMPRESSED_RGBA_ASTC_8x5_KHR;if(r===n.a5J)return o===n.KLL?s.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:s.COMPRESSED_RGBA_ASTC_8x6_KHR;if(r===n._QJ)return o===n.KLL?s.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:s.COMPRESSED_RGBA_ASTC_8x8_KHR;if(r===n.uB5)return o===n.KLL?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:s.COMPRESSED_RGBA_ASTC_10x5_KHR;if(r===n.lyL)return o===n.KLL?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:s.COMPRESSED_RGBA_ASTC_10x6_KHR;if(r===n.bC7)return o===n.KLL?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:s.COMPRESSED_RGBA_ASTC_10x8_KHR;if(r===n.y3Z)return o===n.KLL?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:s.COMPRESSED_RGBA_ASTC_10x10_KHR;if(r===n.ojs)return o===n.KLL?s.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:s.COMPRESSED_RGBA_ASTC_12x10_KHR;if(r===n.S$4)return o===n.KLL?s.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:s.COMPRESSED_RGBA_ASTC_12x12_KHR}if(r===n.Fn||r===n.H23||r===n.W9U){if(null===(s=i.get("EXT_texture_compression_bptc")))return null;if(r===n.Fn)return o===n.KLL?s.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:s.COMPRESSED_RGBA_BPTC_UNORM_EXT;if(r===n.H23)return s.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;if(r===n.W9U)return s.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT}if(r===n.Kef||r===n.XG_||r===n.HO_||r===n.CWW){if(null===(s=i.get("EXT_texture_compression_rgtc")))return null;if(r===n.Kef)return s.COMPRESSED_RED_RGTC1_EXT;if(r===n.XG_)return s.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(r===n.HO_)return s.COMPRESSED_RED_GREEN_RGTC2_EXT;if(r===n.CWW)return s.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}return r===n.V3x?e.UNSIGNED_INT_24_8:void 0!==e[r]?e[r]:null}}}let tI=`
+}`,tM=[new n.Pq0(1,0,0),new n.Pq0(-1,0,0),new n.Pq0(0,1,0),new n.Pq0(0,-1,0),new n.Pq0(0,0,1),new n.Pq0(0,0,-1)],tS=[new n.Pq0(0,-1,0),new n.Pq0(0,-1,0),new n.Pq0(0,0,1),new n.Pq0(0,0,-1),new n.Pq0(0,-1,0),new n.Pq0(0,-1,0)],tb=new n.kn4,tT=new n.Pq0,tE=new n.Pq0;function tw(e,i,r){let a=new n.PPD,s=new n.I9Y,o=new n.I9Y,l=new n.IUQ,c=new n.CSG,h=new n.aVO,u={},d=r.maxTextureSize,p={[n.hB5]:n.hsX,[n.hsX]:n.hB5,[n.$EB]:n.$EB},f=new n.BKk({defines:{VSM_SAMPLES:8},uniforms:{shadow_pass:{value:null},resolution:{value:new n.I9Y},radius:{value:4}},vertexShader:tx,fragmentShader:ty}),m=f.clone();m.defines.HORIZONTAL_PASS=1;let g=new n.LoY;g.setAttribute("position",new n.THS(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));let v=new n.eaF(g,f),_=this;this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=n.QP0;let x=this.type;function y(i,r,a,s){let o=null,l=!0===a.isPointLight?i.customDistanceMaterial:i.customDepthMaterial;if(void 0!==l)o=l;else if(o=!0===a.isPointLight?h:c,e.localClippingEnabled&&!0===r.clipShadows&&Array.isArray(r.clippingPlanes)&&0!==r.clippingPlanes.length||r.displacementMap&&0!==r.displacementScale||r.alphaMap&&r.alphaTest>0||r.map&&r.alphaTest>0||!0===r.alphaToCoverage){let e=o.uuid,i=r.uuid,n=u[e];void 0===n&&(n={},u[e]=n);let a=n[i];void 0===a&&(a=o.clone(),n[i]=a,r.addEventListener("dispose",M)),o=a}return o.visible=r.visible,o.wireframe=r.wireframe,s===n.RyA?o.side=null!==r.shadowSide?r.shadowSide:r.side:o.side=null!==r.shadowSide?r.shadowSide:p[r.side],o.alphaMap=r.alphaMap,o.alphaTest=!0===r.alphaToCoverage?.5:r.alphaTest,o.map=r.map,o.clipShadows=r.clipShadows,o.clippingPlanes=r.clippingPlanes,o.clipIntersection=r.clipIntersection,o.displacementMap=r.displacementMap,o.displacementScale=r.displacementScale,o.displacementBias=r.displacementBias,o.wireframeLinewidth=r.wireframeLinewidth,o.linewidth=r.linewidth,!0===a.isPointLight&&!0===o.isMeshDistanceMaterial&&(e.properties.get(o).light=a),o}function M(e){for(let i in e.target.removeEventListener("dispose",M),u){let r=u[i],n=e.target.uuid;n in r&&(r[n].dispose(),delete r[n])}}this.render=function(r,c,h){if(!1===_.enabled||!1===_.autoUpdate&&!1===_.needsUpdate||0===r.length)return;r.type===n.Wk7&&((0,n.R8M)("WebGLShadowMap: PCFSoftShadowMap has been deprecated. Using PCFShadowMap instead."),r.type=n.QP0);let u=e.getRenderTarget(),p=e.getActiveCubeFace(),g=e.getActiveMipmapLevel(),M=e.state;M.setBlending(n.XIg),!0===M.buffers.depth.getReversed()?M.buffers.color.setClear(0,0,0,0):M.buffers.color.setClear(1,1,1,1),M.buffers.depth.setTest(!0),M.setScissorTest(!1);let S=x!==this.type;S&&c.traverse(function(e){e.material&&(Array.isArray(e.material)?e.material.forEach(e=>e.needsUpdate=!0):e.material.needsUpdate=!0)});for(let u=0,p=r.length;u<p;u++){let p=r[u],g=p.shadow;if(void 0===g){(0,n.R8M)("WebGLShadowMap:",p,"has no shadow.");continue}if(!1===g.autoUpdate&&!1===g.needsUpdate)continue;s.copy(g.mapSize);let _=g.getFrameExtents();if(s.multiply(_),o.copy(g.mapSize),(s.x>d||s.y>d)&&(s.x>d&&(o.x=Math.floor(d/_.x),s.x=o.x*_.x,g.mapSize.x=o.x),s.y>d&&(o.y=Math.floor(d/_.y),s.y=o.y*_.y,g.mapSize.y=o.y)),null===g.map||!0===S){if(null!==g.map&&(null!==g.map.depthTexture&&(g.map.depthTexture.dispose(),g.map.depthTexture=null),g.map.dispose()),this.type===n.RyA){if(p.isPointLight){(0,n.R8M)("WebGLShadowMap: VSM shadow maps are not supported for PointLights. Use PCF or BasicShadowMap instead.");continue}g.map=new n.nWS(s.x,s.y,{format:n.paN,type:n.ix0,minFilter:n.k6q,magFilter:n.k6q,generateMipmaps:!1}),g.map.texture.name=p.name+".shadowMap",g.map.depthTexture=new n.VCu(s.x,s.y,n.RQf),g.map.depthTexture.name=p.name+".shadowMapDepth",g.map.depthTexture.format=n.zdS,g.map.depthTexture.compareFunction=null,g.map.depthTexture.minFilter=n.hxR,g.map.depthTexture.magFilter=n.hxR}else{p.isPointLight?(g.map=new n.o6l(s.x),g.map.depthTexture=new n.Gc6(s.x,n.bkx)):(g.map=new n.nWS(s.x,s.y),g.map.depthTexture=new n.VCu(s.x,s.y,n.bkx)),g.map.depthTexture.name=p.name+".shadowMap",g.map.depthTexture.format=n.zdS;let i=e.state.buffers.depth.getReversed();this.type===n.QP0?(g.map.depthTexture.compareFunction=i?n.gWB:n.TiK,g.map.depthTexture.minFilter=n.k6q,g.map.depthTexture.magFilter=n.k6q):(g.map.depthTexture.compareFunction=null,g.map.depthTexture.minFilter=n.hxR,g.map.depthTexture.magFilter=n.hxR)}g.camera.updateProjectionMatrix()}let x=g.map.isWebGLCubeRenderTarget?6:1;for(let r=0;r<x;r++){if(g.map.isWebGLCubeRenderTarget)e.setRenderTarget(g.map,r),e.clear();else{0===r&&(e.setRenderTarget(g.map),e.clear());let i=g.getViewport(r);l.set(o.x*i.x,o.y*i.y,o.x*i.z,o.y*i.w),M.viewport(l)}if(p.isPointLight){let e=g.camera,i=g.matrix,n=p.distance||e.far;n!==e.far&&(e.far=n,e.updateProjectionMatrix()),tT.setFromMatrixPosition(p.matrixWorld),e.position.copy(tT),tE.copy(e.position),tE.add(tM[r]),e.up.copy(tS[r]),e.lookAt(tE),e.updateMatrixWorld(),i.makeTranslation(-tT.x,-tT.y,-tT.z),tb.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),g._frustum.setFromProjectionMatrix(tb,e.coordinateSystem,e.reversedDepth)}else g.updateMatrices(p);a=g.getFrustum(),function r(s,o,l,c,h){if(!1===s.visible)return;if(s.layers.test(o.layers)&&(s.isMesh||s.isLine||s.isPoints)&&(s.castShadow||s.receiveShadow&&h===n.RyA)&&(!s.frustumCulled||a.intersectsObject(s))){s.modelViewMatrix.multiplyMatrices(l.matrixWorldInverse,s.matrixWorld);let r=i.update(s),n=s.material;if(Array.isArray(n)){let i=r.groups;for(let a=0,u=i.length;a<u;a++){let u=i[a],d=n[u.materialIndex];if(d&&d.visible){let i=y(s,d,c,h);s.onBeforeShadow(e,s,o,l,r,i,u),e.renderBufferDirect(l,null,r,i,s,u),s.onAfterShadow(e,s,o,l,r,i,u)}}}else if(n.visible){let i=y(s,n,c,h);s.onBeforeShadow(e,s,o,l,r,i,null),e.renderBufferDirect(l,null,r,i,s,null),s.onAfterShadow(e,s,o,l,r,i,null)}}let u=s.children;for(let e=0,i=u.length;e<i;e++)r(u[e],o,l,c,h)}(c,h,g.camera,p,this.type)}!0!==g.isPointLightShadow&&this.type===n.RyA&&function(r,a){let o=i.update(v);f.defines.VSM_SAMPLES!==r.blurSamples&&(f.defines.VSM_SAMPLES=r.blurSamples,m.defines.VSM_SAMPLES=r.blurSamples,f.needsUpdate=!0,m.needsUpdate=!0),null===r.mapPass&&(r.mapPass=new n.nWS(s.x,s.y,{format:n.paN,type:n.ix0})),f.uniforms.shadow_pass.value=r.map.depthTexture,f.uniforms.resolution.value=r.mapSize,f.uniforms.radius.value=r.radius,e.setRenderTarget(r.mapPass),e.clear(),e.renderBufferDirect(a,null,o,f,v,null),m.uniforms.shadow_pass.value=r.mapPass.texture,m.uniforms.resolution.value=r.mapSize,m.uniforms.radius.value=r.radius,e.setRenderTarget(r.map),e.clear(),e.renderBufferDirect(a,null,o,m,v,null)}(g,h),g.needsUpdate=!1}x=this.type,_.needsUpdate=!1,e.setRenderTarget(u,p,g)}}let tA={[n.eHc]:n.lGu,[n.brA]:n.K52,[n.U3G]:n.bw0,[n.xSv]:n.Gwm,[n.lGu]:n.eHc,[n.K52]:n.brA,[n.bw0]:n.U3G,[n.Gwm]:n.xSv};function tR(e,i){let r=new function(){let i=!1,r=new n.IUQ,a=null,s=new n.IUQ(0,0,0,0);return{setMask:function(r){a===r||i||(e.colorMask(r,r,r,r),a=r)},setLocked:function(e){i=e},setClear:function(i,n,a,o,l){!0===l&&(i*=o,n*=o,a*=o),r.set(i,n,a,o),!1===s.equals(r)&&(e.clearColor(i,n,a,o),s.copy(r))},reset:function(){i=!1,a=null,s.set(-1,0,0,0)}}},a=new function(){let r=!1,a=!1,s=null,o=null,l=null;return{setReversed:function(e){if(a!==e){let r=i.get("EXT_clip_control");e?r.clipControlEXT(r.LOWER_LEFT_EXT,r.ZERO_TO_ONE_EXT):r.clipControlEXT(r.LOWER_LEFT_EXT,r.NEGATIVE_ONE_TO_ONE_EXT),a=e;let n=l;l=null,this.setClear(n)}},getReversed:function(){return a},setTest:function(i){i?V(e.DEPTH_TEST):H(e.DEPTH_TEST)},setMask:function(i){s===i||r||(e.depthMask(i),s=i)},setFunc:function(i){if(a&&(i=tA[i]),o!==i){switch(i){case n.eHc:e.depthFunc(e.NEVER);break;case n.lGu:e.depthFunc(e.ALWAYS);break;case n.brA:e.depthFunc(e.LESS);break;case n.xSv:e.depthFunc(e.LEQUAL);break;case n.U3G:e.depthFunc(e.EQUAL);break;case n.Gwm:e.depthFunc(e.GEQUAL);break;case n.K52:e.depthFunc(e.GREATER);break;case n.bw0:e.depthFunc(e.NOTEQUAL);break;default:e.depthFunc(e.LEQUAL)}o=i}},setLocked:function(e){r=e},setClear:function(i){l!==i&&(a&&(i=1-i),e.clearDepth(i),l=i)},reset:function(){r=!1,s=null,o=null,l=null,a=!1}}},s=new function(){let i=!1,r=null,n=null,a=null,s=null,o=null,l=null,c=null,h=null;return{setTest:function(r){i||(r?V(e.STENCIL_TEST):H(e.STENCIL_TEST))},setMask:function(n){r===n||i||(e.stencilMask(n),r=n)},setFunc:function(i,r,o){(n!==i||a!==r||s!==o)&&(e.stencilFunc(i,r,o),n=i,a=r,s=o)},setOp:function(i,r,n){(o!==i||l!==r||c!==n)&&(e.stencilOp(i,r,n),o=i,l=r,c=n)},setLocked:function(e){i=e},setClear:function(i){h!==i&&(e.clearStencil(i),h=i)},reset:function(){i=!1,r=null,n=null,a=null,s=null,o=null,l=null,c=null,h=null}}},o=new WeakMap,l=new WeakMap,c={},h={},u=new WeakMap,d=[],p=null,f=!1,m=null,g=null,v=null,_=null,x=null,y=null,M=null,S=new n.Q1f(0,0,0),b=0,T=!1,E=null,w=null,A=null,R=null,C=null,P=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS),I=!1,L=e.getParameter(e.VERSION);-1!==L.indexOf("WebGL")?I=parseFloat(/^WebGL (\d)/.exec(L)[1])>=1:-1!==L.indexOf("OpenGL ES")&&(I=parseFloat(/^OpenGL ES (\d)/.exec(L)[1])>=2);let D=null,U={},N=e.getParameter(e.SCISSOR_BOX),O=e.getParameter(e.VIEWPORT),F=new n.IUQ().fromArray(N),B=new n.IUQ().fromArray(O);function z(i,r,n,a){let s=new Uint8Array(4),o=e.createTexture();e.bindTexture(i,o),e.texParameteri(i,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(i,e.TEXTURE_MAG_FILTER,e.NEAREST);for(let o=0;o<n;o++)i===e.TEXTURE_3D||i===e.TEXTURE_2D_ARRAY?e.texImage3D(r,0,e.RGBA,1,1,a,0,e.RGBA,e.UNSIGNED_BYTE,s):e.texImage2D(r+o,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,s);return o}let k={};function V(i){!0!==c[i]&&(e.enable(i),c[i]=!0)}function H(i){!1!==c[i]&&(e.disable(i),c[i]=!1)}k[e.TEXTURE_2D]=z(e.TEXTURE_2D,e.TEXTURE_2D,1),k[e.TEXTURE_CUBE_MAP]=z(e.TEXTURE_CUBE_MAP,e.TEXTURE_CUBE_MAP_POSITIVE_X,6),k[e.TEXTURE_2D_ARRAY]=z(e.TEXTURE_2D_ARRAY,e.TEXTURE_2D_ARRAY,1,1),k[e.TEXTURE_3D]=z(e.TEXTURE_3D,e.TEXTURE_3D,1,1),r.setClear(0,0,0,1),a.setClear(1),s.setClear(0),V(e.DEPTH_TEST),a.setFunc(n.xSv),j(!1),q(n.Vb5),V(e.CULL_FACE),X(n.XIg);let G={[n.gO9]:e.FUNC_ADD,[n.FXf]:e.FUNC_SUBTRACT,[n.nST]:e.FUNC_REVERSE_SUBTRACT};G[n.znC]=e.MIN,G[n.$ei]=e.MAX;let W={[n.ojh]:e.ZERO,[n.qad]:e.ONE,[n.f4X]:e.SRC_COLOR,[n.ie2]:e.SRC_ALPHA,[n.hgQ]:e.SRC_ALPHA_SATURATE,[n.wn6]:e.DST_COLOR,[n.hdd]:e.DST_ALPHA,[n.LiQ]:e.ONE_MINUS_SRC_COLOR,[n.OuU]:e.ONE_MINUS_SRC_ALPHA,[n.aEY]:e.ONE_MINUS_DST_COLOR,[n.Nt7]:e.ONE_MINUS_DST_ALPHA,[n.RrE]:e.CONSTANT_COLOR,[n.$Yl]:e.ONE_MINUS_CONSTANT_COLOR,[n.e0p]:e.CONSTANT_ALPHA,[n.ov9]:e.ONE_MINUS_CONSTANT_ALPHA};function X(i,r,a,s,o,l,c,h,u,d){if(i===n.XIg){!0===f&&(H(e.BLEND),f=!1);return}if(!1===f&&(V(e.BLEND),f=!0),i!==n.bCz){if(i!==m||d!==T){if((g!==n.gO9||x!==n.gO9)&&(e.blendEquation(e.FUNC_ADD),g=n.gO9,x=n.gO9),d)switch(i){case n.NTi:e.blendFuncSeparate(e.ONE,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);break;case n.EZo:e.blendFunc(e.ONE,e.ONE);break;case n.Kwu:e.blendFuncSeparate(e.ZERO,e.ONE_MINUS_SRC_COLOR,e.ZERO,e.ONE);break;case n.EdD:e.blendFuncSeparate(e.DST_COLOR,e.ONE_MINUS_SRC_ALPHA,e.ZERO,e.ONE);break;default:(0,n.z3S)("WebGLState: Invalid blending: ",i)}else switch(i){case n.NTi:e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);break;case n.EZo:e.blendFuncSeparate(e.SRC_ALPHA,e.ONE,e.ONE,e.ONE);break;case n.Kwu:(0,n.z3S)("WebGLState: SubtractiveBlending requires material.premultipliedAlpha = true");break;case n.EdD:(0,n.z3S)("WebGLState: MultiplyBlending requires material.premultipliedAlpha = true");break;default:(0,n.z3S)("WebGLState: Invalid blending: ",i)}v=null,_=null,y=null,M=null,S.set(0,0,0),b=0,m=i,T=d}return}o=o||r,l=l||a,c=c||s,(r!==g||o!==x)&&(e.blendEquationSeparate(G[r],G[o]),g=r,x=o),(a!==v||s!==_||l!==y||c!==M)&&(e.blendFuncSeparate(W[a],W[s],W[l],W[c]),v=a,_=s,y=l,M=c),(!1===h.equals(S)||u!==b)&&(e.blendColor(h.r,h.g,h.b,u),S.copy(h),b=u),m=i,T=!1}function j(i){E!==i&&(i?e.frontFace(e.CW):e.frontFace(e.CCW),E=i)}function q(i){i!==n.WNZ?(V(e.CULL_FACE),i!==w&&(i===n.Vb5?e.cullFace(e.BACK):i===n.Jnc?e.cullFace(e.FRONT):e.cullFace(e.FRONT_AND_BACK))):H(e.CULL_FACE),w=i}function Y(i,r,n){i?(V(e.POLYGON_OFFSET_FILL),(R!==r||C!==n)&&(e.polygonOffset(r,n),R=r,C=n)):H(e.POLYGON_OFFSET_FILL)}return{buffers:{color:r,depth:a,stencil:s},enable:V,disable:H,bindFramebuffer:function(i,r){return h[i]!==r&&(e.bindFramebuffer(i,r),h[i]=r,i===e.DRAW_FRAMEBUFFER&&(h[e.FRAMEBUFFER]=r),i===e.FRAMEBUFFER&&(h[e.DRAW_FRAMEBUFFER]=r),!0)},drawBuffers:function(i,r){let n=d,a=!1;if(i){void 0===(n=u.get(r))&&(n=[],u.set(r,n));let s=i.textures;if(n.length!==s.length||n[0]!==e.COLOR_ATTACHMENT0){for(let i=0,r=s.length;i<r;i++)n[i]=e.COLOR_ATTACHMENT0+i;n.length=s.length,a=!0}}else n[0]!==e.BACK&&(n[0]=e.BACK,a=!0);a&&e.drawBuffers(n)},useProgram:function(i){return p!==i&&(e.useProgram(i),p=i,!0)},setBlending:X,setMaterial:function(i,o){i.side===n.$EB?H(e.CULL_FACE):V(e.CULL_FACE);let l=i.side===n.hsX;o&&(l=!l),j(l),i.blending===n.NTi&&!1===i.transparent?X(n.XIg):X(i.blending,i.blendEquation,i.blendSrc,i.blendDst,i.blendEquationAlpha,i.blendSrcAlpha,i.blendDstAlpha,i.blendColor,i.blendAlpha,i.premultipliedAlpha),a.setFunc(i.depthFunc),a.setTest(i.depthTest),a.setMask(i.depthWrite),r.setMask(i.colorWrite);let c=i.stencilWrite;s.setTest(c),c&&(s.setMask(i.stencilWriteMask),s.setFunc(i.stencilFunc,i.stencilRef,i.stencilFuncMask),s.setOp(i.stencilFail,i.stencilZFail,i.stencilZPass)),Y(i.polygonOffset,i.polygonOffsetFactor,i.polygonOffsetUnits),!0===i.alphaToCoverage?V(e.SAMPLE_ALPHA_TO_COVERAGE):H(e.SAMPLE_ALPHA_TO_COVERAGE)},setFlipSided:j,setCullFace:q,setLineWidth:function(i){i!==A&&(I&&e.lineWidth(i),A=i)},setPolygonOffset:Y,setScissorTest:function(i){i?V(e.SCISSOR_TEST):H(e.SCISSOR_TEST)},activeTexture:function(i){void 0===i&&(i=e.TEXTURE0+P-1),D!==i&&(e.activeTexture(i),D=i)},bindTexture:function(i,r,n){void 0===n&&(n=null===D?e.TEXTURE0+P-1:D);let a=U[n];void 0===a&&(a={type:void 0,texture:void 0},U[n]=a),(a.type!==i||a.texture!==r)&&(D!==n&&(e.activeTexture(n),D=n),e.bindTexture(i,r||k[i]),a.type=i,a.texture=r)},unbindTexture:function(){let i=U[D];void 0!==i&&void 0!==i.type&&(e.bindTexture(i.type,null),i.type=void 0,i.texture=void 0)},compressedTexImage2D:function(){try{e.compressedTexImage2D(...arguments)}catch(e){(0,n.z3S)("WebGLState:",e)}},compressedTexImage3D:function(){try{e.compressedTexImage3D(...arguments)}catch(e){(0,n.z3S)("WebGLState:",e)}},texImage2D:function(){try{e.texImage2D(...arguments)}catch(e){(0,n.z3S)("WebGLState:",e)}},texImage3D:function(){try{e.texImage3D(...arguments)}catch(e){(0,n.z3S)("WebGLState:",e)}},updateUBOMapping:function(i,r){let n=l.get(r);void 0===n&&(n=new WeakMap,l.set(r,n));let a=n.get(i);void 0===a&&(a=e.getUniformBlockIndex(r,i.name),n.set(i,a))},uniformBlockBinding:function(i,r){let n=l.get(r).get(i);o.get(r)!==n&&(e.uniformBlockBinding(r,n,i.__bindingPointIndex),o.set(r,n))},texStorage2D:function(){try{e.texStorage2D(...arguments)}catch(e){(0,n.z3S)("WebGLState:",e)}},texStorage3D:function(){try{e.texStorage3D(...arguments)}catch(e){(0,n.z3S)("WebGLState:",e)}},texSubImage2D:function(){try{e.texSubImage2D(...arguments)}catch(e){(0,n.z3S)("WebGLState:",e)}},texSubImage3D:function(){try{e.texSubImage3D(...arguments)}catch(e){(0,n.z3S)("WebGLState:",e)}},compressedTexSubImage2D:function(){try{e.compressedTexSubImage2D(...arguments)}catch(e){(0,n.z3S)("WebGLState:",e)}},compressedTexSubImage3D:function(){try{e.compressedTexSubImage3D(...arguments)}catch(e){(0,n.z3S)("WebGLState:",e)}},scissor:function(i){!1===F.equals(i)&&(e.scissor(i.x,i.y,i.z,i.w),F.copy(i))},viewport:function(i){!1===B.equals(i)&&(e.viewport(i.x,i.y,i.z,i.w),B.copy(i))},reset:function(){e.disable(e.BLEND),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.disable(e.POLYGON_OFFSET_FILL),e.disable(e.SCISSOR_TEST),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ONE,e.ZERO),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.blendColor(0,0,0,0),e.colorMask(!0,!0,!0,!0),e.clearColor(0,0,0,0),e.depthMask(!0),e.depthFunc(e.LESS),a.setReversed(!1),e.clearDepth(1),e.stencilMask(0xffffffff),e.stencilFunc(e.ALWAYS,0,0xffffffff),e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.clearStencil(0),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.activeTexture(e.TEXTURE0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),e.bindFramebuffer(e.READ_FRAMEBUFFER,null),e.useProgram(null),e.lineWidth(1),e.scissor(0,0,e.canvas.width,e.canvas.height),e.viewport(0,0,e.canvas.width,e.canvas.height),c={},D=null,U={},h={},u=new WeakMap,d=[],p=null,f=!1,m=null,g=null,v=null,_=null,x=null,y=null,M=null,S=new n.Q1f(0,0,0),b=0,T=!1,E=null,w=null,A=null,R=null,C=null,F.set(0,0,e.canvas.width,e.canvas.height),B.set(0,0,e.canvas.width,e.canvas.height),r.reset(),a.reset(),s.reset()}}}function tC(e,i,r,a,s,o,l){let c,h=i.has("WEBGL_multisampled_render_to_texture")?i.get("WEBGL_multisampled_render_to_texture"):null,u="u">typeof navigator&&/OculusBrowser/g.test(navigator.userAgent),d=new n.I9Y,p=new WeakMap,f=new WeakMap,m=!1;try{m="u">typeof OffscreenCanvas&&null!==new OffscreenCanvas(1,1).getContext("2d")}catch(e){}function g(e,i){return m?new OffscreenCanvas(e,i):(0,n.qq$)("canvas")}function v(e,i,r){let a=1,s=W(e);if((s.width>r||s.height>r)&&(a=r/Math.max(s.width,s.height)),a<1)if("u">typeof HTMLImageElement&&e instanceof HTMLImageElement||"u">typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"u">typeof ImageBitmap&&e instanceof ImageBitmap||"u">typeof VideoFrame&&e instanceof VideoFrame){let r=Math.floor(a*s.width),o=Math.floor(a*s.height);void 0===c&&(c=g(r,o));let l=i?g(r,o):c;return l.width=r,l.height=o,l.getContext("2d").drawImage(e,0,0,r,o),(0,n.R8M)("WebGLRenderer: Texture has been resized from ("+s.width+"x"+s.height+") to ("+r+"x"+o+")."),l}else"data"in e&&(0,n.R8M)("WebGLRenderer: Image in DataTexture is too big ("+s.width+"x"+s.height+").");return e}function _(e){return e.generateMipmaps}function x(i){e.generateMipmap(i)}function y(r,a,s,o,l=!1){if(null!==r){if(void 0!==e[r])return e[r];(0,n.R8M)("WebGLRenderer: Attempt to use non-existing WebGL internal format '"+r+"'")}let c=a;if(a===e.RED&&(s===e.FLOAT&&(c=e.R32F),s===e.HALF_FLOAT&&(c=e.R16F),s===e.UNSIGNED_BYTE&&(c=e.R8)),a===e.RED_INTEGER&&(s===e.UNSIGNED_BYTE&&(c=e.R8UI),s===e.UNSIGNED_SHORT&&(c=e.R16UI),s===e.UNSIGNED_INT&&(c=e.R32UI),s===e.BYTE&&(c=e.R8I),s===e.SHORT&&(c=e.R16I),s===e.INT&&(c=e.R32I)),a===e.RG&&(s===e.FLOAT&&(c=e.RG32F),s===e.HALF_FLOAT&&(c=e.RG16F),s===e.UNSIGNED_BYTE&&(c=e.RG8)),a===e.RG_INTEGER&&(s===e.UNSIGNED_BYTE&&(c=e.RG8UI),s===e.UNSIGNED_SHORT&&(c=e.RG16UI),s===e.UNSIGNED_INT&&(c=e.RG32UI),s===e.BYTE&&(c=e.RG8I),s===e.SHORT&&(c=e.RG16I),s===e.INT&&(c=e.RG32I)),a===e.RGB_INTEGER&&(s===e.UNSIGNED_BYTE&&(c=e.RGB8UI),s===e.UNSIGNED_SHORT&&(c=e.RGB16UI),s===e.UNSIGNED_INT&&(c=e.RGB32UI),s===e.BYTE&&(c=e.RGB8I),s===e.SHORT&&(c=e.RGB16I),s===e.INT&&(c=e.RGB32I)),a===e.RGBA_INTEGER&&(s===e.UNSIGNED_BYTE&&(c=e.RGBA8UI),s===e.UNSIGNED_SHORT&&(c=e.RGBA16UI),s===e.UNSIGNED_INT&&(c=e.RGBA32UI),s===e.BYTE&&(c=e.RGBA8I),s===e.SHORT&&(c=e.RGBA16I),s===e.INT&&(c=e.RGBA32I)),a===e.RGB&&(s===e.UNSIGNED_INT_5_9_9_9_REV&&(c=e.RGB9_E5),s===e.UNSIGNED_INT_10F_11F_11F_REV&&(c=e.R11F_G11F_B10F)),a===e.RGBA){let i=l?n.VxR:n.ppV.getTransfer(o);s===e.FLOAT&&(c=e.RGBA32F),s===e.HALF_FLOAT&&(c=e.RGBA16F),s===e.UNSIGNED_BYTE&&(c=i===n.KLL?e.SRGB8_ALPHA8:e.RGBA8),s===e.UNSIGNED_SHORT_4_4_4_4&&(c=e.RGBA4),s===e.UNSIGNED_SHORT_5_5_5_1&&(c=e.RGB5_A1)}return(c===e.R16F||c===e.R32F||c===e.RG16F||c===e.RG32F||c===e.RGBA16F||c===e.RGBA32F)&&i.get("EXT_color_buffer_float"),c}function M(i,r){let a;return i?null===r||r===n.bkx||r===n.V3x?a=e.DEPTH24_STENCIL8:r===n.RQf?a=e.DEPTH32F_STENCIL8:r===n.cHt&&(a=e.DEPTH24_STENCIL8,(0,n.R8M)("DepthTexture: 16 bit depth attachment is not supported with stencil. Using 24-bit attachment.")):null===r||r===n.bkx||r===n.V3x?a=e.DEPTH_COMPONENT24:r===n.RQf?a=e.DEPTH_COMPONENT32F:r===n.cHt&&(a=e.DEPTH_COMPONENT16),a}function S(e,i){return!0===_(e)||e.isFramebufferTexture&&e.minFilter!==n.hxR&&e.minFilter!==n.k6q?Math.log2(Math.max(i.width,i.height))+1:void 0!==e.mipmaps&&e.mipmaps.length>0?e.mipmaps.length:e.isCompressedTexture&&Array.isArray(e.image)?i.mipmaps.length:1}function b(e){let i=e.target;i.removeEventListener("dispose",b),function(e){let i=a.get(e);if(void 0===i.__webglInit)return;let r=e.source,n=f.get(r);if(n){let a=n[i.__cacheKey];a.usedTimes--,0===a.usedTimes&&E(e),0===Object.keys(n).length&&f.delete(r)}a.remove(e)}(i),i.isVideoTexture&&p.delete(i)}function T(i){let r=i.target;r.removeEventListener("dispose",T),function(i){let r=a.get(i);if(i.depthTexture&&(i.depthTexture.dispose(),a.remove(i.depthTexture)),i.isWebGLCubeRenderTarget)for(let i=0;i<6;i++){if(Array.isArray(r.__webglFramebuffer[i]))for(let n=0;n<r.__webglFramebuffer[i].length;n++)e.deleteFramebuffer(r.__webglFramebuffer[i][n]);else e.deleteFramebuffer(r.__webglFramebuffer[i]);r.__webglDepthbuffer&&e.deleteRenderbuffer(r.__webglDepthbuffer[i])}else{if(Array.isArray(r.__webglFramebuffer))for(let i=0;i<r.__webglFramebuffer.length;i++)e.deleteFramebuffer(r.__webglFramebuffer[i]);else e.deleteFramebuffer(r.__webglFramebuffer);if(r.__webglDepthbuffer&&e.deleteRenderbuffer(r.__webglDepthbuffer),r.__webglMultisampledFramebuffer&&e.deleteFramebuffer(r.__webglMultisampledFramebuffer),r.__webglColorRenderbuffer)for(let i=0;i<r.__webglColorRenderbuffer.length;i++)r.__webglColorRenderbuffer[i]&&e.deleteRenderbuffer(r.__webglColorRenderbuffer[i]);r.__webglDepthRenderbuffer&&e.deleteRenderbuffer(r.__webglDepthRenderbuffer)}let n=i.textures;for(let i=0,r=n.length;i<r;i++){let r=a.get(n[i]);r.__webglTexture&&(e.deleteTexture(r.__webglTexture),l.memory.textures--),a.remove(n[i])}a.remove(i)}(r)}function E(i){let r=a.get(i);e.deleteTexture(r.__webglTexture);let n=i.source,s=f.get(n);delete s[r.__cacheKey],l.memory.textures--}let w=0;function A(i,s){var o;let c,h=a.get(i);if(i.isVideoTexture&&(o=i,c=l.render.frame,p.get(o)!==c&&(p.set(o,c),o.update())),!1===i.isRenderTargetTexture&&!0!==i.isExternalTexture&&i.version>0&&h.__version!==i.version){let e=i.image;if(null===e)(0,n.R8M)("WebGLRenderer: Texture marked for update but no image data found.");else{if(!1!==e.complete)return void U(h,i,s);(0,n.R8M)("WebGLRenderer: Texture marked for update but image is incomplete")}}else i.isExternalTexture&&(h.__webglTexture=i.sourceTexture?i.sourceTexture:null);r.bindTexture(e.TEXTURE_2D,h.__webglTexture,e.TEXTURE0+s)}let R={[n.GJx]:e.REPEAT,[n.ghU]:e.CLAMP_TO_EDGE,[n.kTW]:e.MIRRORED_REPEAT},C={[n.hxR]:e.NEAREST,[n.pHI]:e.NEAREST_MIPMAP_NEAREST,[n.Cfg]:e.NEAREST_MIPMAP_LINEAR,[n.k6q]:e.LINEAR,[n.kRr]:e.LINEAR_MIPMAP_NEAREST,[n.$_I]:e.LINEAR_MIPMAP_LINEAR},P={[n.amv]:e.NEVER,[n.FFZ]:e.ALWAYS,[n.vim]:e.LESS,[n.TiK]:e.LEQUAL,[n.kO0]:e.EQUAL,[n.gWB]:e.GEQUAL,[n.eoi]:e.GREATER,[n.jzd]:e.NOTEQUAL};function I(r,o){if((o.type===n.RQf&&!1===i.has("OES_texture_float_linear")&&(o.magFilter===n.k6q||o.magFilter===n.kRr||o.magFilter===n.Cfg||o.magFilter===n.$_I||o.minFilter===n.k6q||o.minFilter===n.kRr||o.minFilter===n.Cfg||o.minFilter===n.$_I)&&(0,n.R8M)("WebGLRenderer: Unable to use linear filtering with floating point textures. OES_texture_float_linear not supported on this device."),e.texParameteri(r,e.TEXTURE_WRAP_S,R[o.wrapS]),e.texParameteri(r,e.TEXTURE_WRAP_T,R[o.wrapT]),(r===e.TEXTURE_3D||r===e.TEXTURE_2D_ARRAY)&&e.texParameteri(r,e.TEXTURE_WRAP_R,R[o.wrapR]),e.texParameteri(r,e.TEXTURE_MAG_FILTER,C[o.magFilter]),e.texParameteri(r,e.TEXTURE_MIN_FILTER,C[o.minFilter]),o.compareFunction&&(e.texParameteri(r,e.TEXTURE_COMPARE_MODE,e.COMPARE_REF_TO_TEXTURE),e.texParameteri(r,e.TEXTURE_COMPARE_FUNC,P[o.compareFunction])),!0===i.has("EXT_texture_filter_anisotropic"))&&o.magFilter!==n.hxR&&(o.minFilter===n.Cfg||o.minFilter===n.$_I)&&(o.type!==n.RQf||!1!==i.has("OES_texture_float_linear"))&&(o.anisotropy>1||a.get(o).__currentAnisotropy)){let n=i.get("EXT_texture_filter_anisotropic");e.texParameterf(r,n.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(o.anisotropy,s.getMaxAnisotropy())),a.get(o).__currentAnisotropy=o.anisotropy}}function L(i,r){let n,a=!1;void 0===i.__webglInit&&(i.__webglInit=!0,r.addEventListener("dispose",b));let s=r.source,o=f.get(s);void 0===o&&(o={},f.set(s,o));let c=((n=[]).push(r.wrapS),n.push(r.wrapT),n.push(r.wrapR||0),n.push(r.magFilter),n.push(r.minFilter),n.push(r.anisotropy),n.push(r.internalFormat),n.push(r.format),n.push(r.type),n.push(r.generateMipmaps),n.push(r.premultiplyAlpha),n.push(r.flipY),n.push(r.unpackAlignment),n.push(r.colorSpace),n.join());if(c!==i.__cacheKey){void 0===o[c]&&(o[c]={texture:e.createTexture(),usedTimes:0},l.memory.textures++,a=!0),o[c].usedTimes++;let n=o[i.__cacheKey];void 0!==n&&(o[i.__cacheKey].usedTimes--,0===n.usedTimes&&E(r)),i.__cacheKey=c,i.__webglTexture=o[c].texture}return a}function D(e,i,r){return Math.floor(Math.floor(e/r)/i)}function U(i,l,c){let h=e.TEXTURE_2D;(l.isDataArrayTexture||l.isCompressedArrayTexture)&&(h=e.TEXTURE_2D_ARRAY),l.isData3DTexture&&(h=e.TEXTURE_3D);let u=L(i,l),d=l.source;r.bindTexture(h,i.__webglTexture,e.TEXTURE0+c);let p=a.get(d);if(d.version!==p.__version||!0===u){let i;r.activeTexture(e.TEXTURE0+c);let a=n.ppV.getPrimaries(n.ppV.workingColorSpace),f=l.colorSpace===n.jf0?null:n.ppV.getPrimaries(l.colorSpace),m=l.colorSpace===n.jf0||a===f?e.NONE:e.BROWSER_DEFAULT_WEBGL;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,l.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,l.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,l.unpackAlignment),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,m);let g=v(l.image,!1,s.maxTextureSize);g=G(l,g);let b=o.convert(l.format,l.colorSpace),T=o.convert(l.type),E=y(l.internalFormat,b,T,l.colorSpace,l.isVideoTexture);I(h,l);let w=l.mipmaps,A=!0!==l.isVideoTexture,R=void 0===p.__version||!0===u,C=d.dataReady,P=S(l,g);if(l.isDepthTexture)E=M(l.format===n.dcC,l.type),R&&(A?r.texStorage2D(e.TEXTURE_2D,1,E,g.width,g.height):r.texImage2D(e.TEXTURE_2D,0,E,g.width,g.height,0,b,T,null));else if(l.isDataTexture)if(w.length>0){A&&R&&r.texStorage2D(e.TEXTURE_2D,P,E,w[0].width,w[0].height);for(let n=0,a=w.length;n<a;n++)i=w[n],A?C&&r.texSubImage2D(e.TEXTURE_2D,n,0,0,i.width,i.height,b,T,i.data):r.texImage2D(e.TEXTURE_2D,n,E,i.width,i.height,0,b,T,i.data);l.generateMipmaps=!1}else A?(R&&r.texStorage2D(e.TEXTURE_2D,P,E,g.width,g.height),C&&function(i,n,a,s){let o=i.updateRanges;if(0===o.length)r.texSubImage2D(e.TEXTURE_2D,0,0,0,n.width,n.height,a,s,n.data);else{o.sort((e,i)=>e.start-i.start);let l=0;for(let e=1;e<o.length;e++){let i=o[l],r=o[e],a=i.start+i.count,s=D(r.start,n.width,4),c=D(i.start,n.width,4);r.start<=a+1&&s===c&&D(r.start+r.count-1,n.width,4)===s?i.count=Math.max(i.count,r.start+r.count-i.start):o[++l]=r}o.length=l+1;let c=e.getParameter(e.UNPACK_ROW_LENGTH),h=e.getParameter(e.UNPACK_SKIP_PIXELS),u=e.getParameter(e.UNPACK_SKIP_ROWS);e.pixelStorei(e.UNPACK_ROW_LENGTH,n.width);for(let i=0,l=o.length;i<l;i++){let l=o[i],c=Math.floor(l.start/4),h=Math.ceil(l.count/4),u=c%n.width,d=Math.floor(c/n.width);e.pixelStorei(e.UNPACK_SKIP_PIXELS,u),e.pixelStorei(e.UNPACK_SKIP_ROWS,d),r.texSubImage2D(e.TEXTURE_2D,0,u,d,h,1,a,s,n.data)}i.clearUpdateRanges(),e.pixelStorei(e.UNPACK_ROW_LENGTH,c),e.pixelStorei(e.UNPACK_SKIP_PIXELS,h),e.pixelStorei(e.UNPACK_SKIP_ROWS,u)}}(l,g,b,T)):r.texImage2D(e.TEXTURE_2D,0,E,g.width,g.height,0,b,T,g.data);else if(l.isCompressedTexture)if(l.isCompressedArrayTexture){A&&R&&r.texStorage3D(e.TEXTURE_2D_ARRAY,P,E,w[0].width,w[0].height,g.depth);for(let a=0,s=w.length;a<s;a++)if(i=w[a],l.format!==n.GWd)if(null!==b)if(A){if(C)if(l.layerUpdates.size>0){let s=(0,n.Nex)(i.width,i.height,l.format,l.type);for(let n of l.layerUpdates){let o=i.data.subarray(n*s/i.data.BYTES_PER_ELEMENT,(n+1)*s/i.data.BYTES_PER_ELEMENT);r.compressedTexSubImage3D(e.TEXTURE_2D_ARRAY,a,0,0,n,i.width,i.height,1,b,o)}l.clearLayerUpdates()}else r.compressedTexSubImage3D(e.TEXTURE_2D_ARRAY,a,0,0,0,i.width,i.height,g.depth,b,i.data)}else r.compressedTexImage3D(e.TEXTURE_2D_ARRAY,a,E,i.width,i.height,g.depth,0,i.data,0,0);else(0,n.R8M)("WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()");else A?C&&r.texSubImage3D(e.TEXTURE_2D_ARRAY,a,0,0,0,i.width,i.height,g.depth,b,T,i.data):r.texImage3D(e.TEXTURE_2D_ARRAY,a,E,i.width,i.height,g.depth,0,b,T,i.data)}else{A&&R&&r.texStorage2D(e.TEXTURE_2D,P,E,w[0].width,w[0].height);for(let a=0,s=w.length;a<s;a++)i=w[a],l.format!==n.GWd?null!==b?A?C&&r.compressedTexSubImage2D(e.TEXTURE_2D,a,0,0,i.width,i.height,b,i.data):r.compressedTexImage2D(e.TEXTURE_2D,a,E,i.width,i.height,0,i.data):(0,n.R8M)("WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):A?C&&r.texSubImage2D(e.TEXTURE_2D,a,0,0,i.width,i.height,b,T,i.data):r.texImage2D(e.TEXTURE_2D,a,E,i.width,i.height,0,b,T,i.data)}else if(l.isDataArrayTexture)if(A){if(R&&r.texStorage3D(e.TEXTURE_2D_ARRAY,P,E,g.width,g.height,g.depth),C)if(l.layerUpdates.size>0){let i=(0,n.Nex)(g.width,g.height,l.format,l.type);for(let n of l.layerUpdates){let a=g.data.subarray(n*i/g.data.BYTES_PER_ELEMENT,(n+1)*i/g.data.BYTES_PER_ELEMENT);r.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,n,g.width,g.height,1,b,T,a)}l.clearLayerUpdates()}else r.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,0,g.width,g.height,g.depth,b,T,g.data)}else r.texImage3D(e.TEXTURE_2D_ARRAY,0,E,g.width,g.height,g.depth,0,b,T,g.data);else if(l.isData3DTexture)A?(R&&r.texStorage3D(e.TEXTURE_3D,P,E,g.width,g.height,g.depth),C&&r.texSubImage3D(e.TEXTURE_3D,0,0,0,0,g.width,g.height,g.depth,b,T,g.data)):r.texImage3D(e.TEXTURE_3D,0,E,g.width,g.height,g.depth,0,b,T,g.data);else if(l.isFramebufferTexture){if(R)if(A)r.texStorage2D(e.TEXTURE_2D,P,E,g.width,g.height);else{let i=g.width,n=g.height;for(let a=0;a<P;a++)r.texImage2D(e.TEXTURE_2D,a,E,i,n,0,b,T,null),i>>=1,n>>=1}}else if(w.length>0){if(A&&R){let i=W(w[0]);r.texStorage2D(e.TEXTURE_2D,P,E,i.width,i.height)}for(let n=0,a=w.length;n<a;n++)i=w[n],A?C&&r.texSubImage2D(e.TEXTURE_2D,n,0,0,b,T,i):r.texImage2D(e.TEXTURE_2D,n,E,b,T,i);l.generateMipmaps=!1}else if(A){if(R){let i=W(g);r.texStorage2D(e.TEXTURE_2D,P,E,i.width,i.height)}C&&r.texSubImage2D(e.TEXTURE_2D,0,0,0,b,T,g)}else r.texImage2D(e.TEXTURE_2D,0,E,b,T,g);_(l)&&x(h),p.__version=d.version,l.onUpdate&&l.onUpdate(l)}i.__version=l.version}function N(i,n,s,l,c,u){let d=o.convert(s.format,s.colorSpace),p=o.convert(s.type),f=y(s.internalFormat,d,p,s.colorSpace),m=a.get(n),g=a.get(s);if(g.__renderTarget=n,!m.__hasExternalTextures){let i=Math.max(1,n.width>>u),a=Math.max(1,n.height>>u);c===e.TEXTURE_3D||c===e.TEXTURE_2D_ARRAY?r.texImage3D(c,u,f,i,a,n.depth,0,d,p,null):r.texImage2D(c,u,f,i,a,0,d,p,null)}r.bindFramebuffer(e.FRAMEBUFFER,i),H(n)?h.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,l,c,g.__webglTexture,0,V(n)):(c===e.TEXTURE_2D||c>=e.TEXTURE_CUBE_MAP_POSITIVE_X&&c<=e.TEXTURE_CUBE_MAP_NEGATIVE_Z)&&e.framebufferTexture2D(e.FRAMEBUFFER,l,c,g.__webglTexture,u),r.bindFramebuffer(e.FRAMEBUFFER,null)}function O(i,r,n){if(e.bindRenderbuffer(e.RENDERBUFFER,i),r.depthBuffer){let a=r.depthTexture,s=a&&a.isDepthTexture?a.type:null,o=M(r.stencilBuffer,s),l=r.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT;H(r)?h.renderbufferStorageMultisampleEXT(e.RENDERBUFFER,V(r),o,r.width,r.height):n?e.renderbufferStorageMultisample(e.RENDERBUFFER,V(r),o,r.width,r.height):e.renderbufferStorage(e.RENDERBUFFER,o,r.width,r.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,l,e.RENDERBUFFER,i)}else{let i=r.textures;for(let a=0;a<i.length;a++){let s=i[a],l=o.convert(s.format,s.colorSpace),c=o.convert(s.type),u=y(s.internalFormat,l,c,s.colorSpace);H(r)?h.renderbufferStorageMultisampleEXT(e.RENDERBUFFER,V(r),u,r.width,r.height):n?e.renderbufferStorageMultisample(e.RENDERBUFFER,V(r),u,r.width,r.height):e.renderbufferStorage(e.RENDERBUFFER,u,r.width,r.height)}}e.bindRenderbuffer(e.RENDERBUFFER,null)}function F(i,s,l){let c=!0===s.isWebGLCubeRenderTarget;if(r.bindFramebuffer(e.FRAMEBUFFER,i),!(s.depthTexture&&s.depthTexture.isDepthTexture))throw Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");let u=a.get(s.depthTexture);if(u.__renderTarget=s,u.__webglTexture&&s.depthTexture.image.width===s.width&&s.depthTexture.image.height===s.height||(s.depthTexture.image.width=s.width,s.depthTexture.image.height=s.height,s.depthTexture.needsUpdate=!0),c){if(void 0===u.__webglInit&&(u.__webglInit=!0,s.depthTexture.addEventListener("dispose",b)),void 0===u.__webglTexture){let i;u.__webglTexture=e.createTexture(),r.bindTexture(e.TEXTURE_CUBE_MAP,u.__webglTexture),I(e.TEXTURE_CUBE_MAP,s.depthTexture);let a=o.convert(s.depthTexture.format),l=o.convert(s.depthTexture.type);s.depthTexture.format===n.zdS?i=e.DEPTH_COMPONENT24:s.depthTexture.format===n.dcC&&(i=e.DEPTH24_STENCIL8);for(let r=0;r<6;r++)e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+r,0,i,s.width,s.height,0,a,l,null)}}else A(s.depthTexture,0);let d=u.__webglTexture,p=V(s),f=c?e.TEXTURE_CUBE_MAP_POSITIVE_X+l:e.TEXTURE_2D,m=s.depthTexture.format===n.dcC?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT;if(s.depthTexture.format===n.zdS)H(s)?h.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,m,f,d,0,p):e.framebufferTexture2D(e.FRAMEBUFFER,m,f,d,0);else if(s.depthTexture.format===n.dcC)H(s)?h.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,m,f,d,0,p):e.framebufferTexture2D(e.FRAMEBUFFER,m,f,d,0);else throw Error("Unknown depthTexture format")}function B(i){let n=a.get(i),s=!0===i.isWebGLCubeRenderTarget;if(n.__boundDepthTexture!==i.depthTexture){let e=i.depthTexture;if(n.__depthDisposeCallback&&n.__depthDisposeCallback(),e){let i=()=>{delete n.__boundDepthTexture,delete n.__depthDisposeCallback,e.removeEventListener("dispose",i)};e.addEventListener("dispose",i),n.__depthDisposeCallback=i}n.__boundDepthTexture=e}if(i.depthTexture&&!n.__autoAllocateDepthBuffer)if(s)for(let e=0;e<6;e++)F(n.__webglFramebuffer[e],i,e);else{let e=i.texture.mipmaps;e&&e.length>0?F(n.__webglFramebuffer[0],i,0):F(n.__webglFramebuffer,i,0)}else if(s){n.__webglDepthbuffer=[];for(let a=0;a<6;a++)if(r.bindFramebuffer(e.FRAMEBUFFER,n.__webglFramebuffer[a]),void 0===n.__webglDepthbuffer[a])n.__webglDepthbuffer[a]=e.createRenderbuffer(),O(n.__webglDepthbuffer[a],i,!1);else{let r=i.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,s=n.__webglDepthbuffer[a];e.bindRenderbuffer(e.RENDERBUFFER,s),e.framebufferRenderbuffer(e.FRAMEBUFFER,r,e.RENDERBUFFER,s)}}else{let a=i.texture.mipmaps;if(a&&a.length>0?r.bindFramebuffer(e.FRAMEBUFFER,n.__webglFramebuffer[0]):r.bindFramebuffer(e.FRAMEBUFFER,n.__webglFramebuffer),void 0===n.__webglDepthbuffer)n.__webglDepthbuffer=e.createRenderbuffer(),O(n.__webglDepthbuffer,i,!1);else{let r=i.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,a=n.__webglDepthbuffer;e.bindRenderbuffer(e.RENDERBUFFER,a),e.framebufferRenderbuffer(e.FRAMEBUFFER,r,e.RENDERBUFFER,a)}}r.bindFramebuffer(e.FRAMEBUFFER,null)}let z=[],k=[];function V(e){return Math.min(s.maxSamples,e.samples)}function H(e){let r=a.get(e);return e.samples>0&&!0===i.has("WEBGL_multisampled_render_to_texture")&&!1!==r.__useRenderToTexture}function G(e,i){let r=e.colorSpace,a=e.format,s=e.type;return!0===e.isCompressedTexture||!0===e.isVideoTexture||r!==n.Zr2&&r!==n.jf0&&(n.ppV.getTransfer(r)===n.KLL?(a!==n.GWd||s!==n.OUM)&&(0,n.R8M)("WebGLTextures: sRGB encoded textures have to use RGBAFormat and UnsignedByteType."):(0,n.z3S)("WebGLTextures: Unsupported texture color space:",r)),i}function W(e){return"u">typeof HTMLImageElement&&e instanceof HTMLImageElement?(d.width=e.naturalWidth||e.width,d.height=e.naturalHeight||e.height):"u">typeof VideoFrame&&e instanceof VideoFrame?(d.width=e.displayWidth,d.height=e.displayHeight):(d.width=e.width,d.height=e.height),d}this.allocateTextureUnit=function(){let e=w;return e>=s.maxTextures&&(0,n.R8M)("WebGLTextures: Trying to use "+e+" texture units while this GPU supports only "+s.maxTextures),w+=1,e},this.resetTextureUnits=function(){w=0},this.setTexture2D=A,this.setTexture2DArray=function(i,n){let s=a.get(i);!1===i.isRenderTargetTexture&&i.version>0&&s.__version!==i.version?U(s,i,n):(i.isExternalTexture&&(s.__webglTexture=i.sourceTexture?i.sourceTexture:null),r.bindTexture(e.TEXTURE_2D_ARRAY,s.__webglTexture,e.TEXTURE0+n))},this.setTexture3D=function(i,n){let s=a.get(i);!1===i.isRenderTargetTexture&&i.version>0&&s.__version!==i.version?U(s,i,n):r.bindTexture(e.TEXTURE_3D,s.__webglTexture,e.TEXTURE0+n)},this.setTextureCube=function(i,l){let c=a.get(i);!0!==i.isCubeDepthTexture&&i.version>0&&c.__version!==i.version?function(i,l,c){if(6!==l.image.length)return;let h=L(i,l),u=l.source;r.bindTexture(e.TEXTURE_CUBE_MAP,i.__webglTexture,e.TEXTURE0+c);let d=a.get(u);if(u.version!==d.__version||!0===h){let i;r.activeTexture(e.TEXTURE0+c);let a=n.ppV.getPrimaries(n.ppV.workingColorSpace),p=l.colorSpace===n.jf0?null:n.ppV.getPrimaries(l.colorSpace),f=l.colorSpace===n.jf0||a===p?e.NONE:e.BROWSER_DEFAULT_WEBGL;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,l.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,l.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,l.unpackAlignment),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,f);let m=l.isCompressedTexture||l.image[0].isCompressedTexture,g=l.image[0]&&l.image[0].isDataTexture,M=[];for(let e=0;e<6;e++)m||g?M[e]=g?l.image[e].image:l.image[e]:M[e]=v(l.image[e],!0,s.maxCubemapSize),M[e]=G(l,M[e]);let b=M[0],T=o.convert(l.format,l.colorSpace),E=o.convert(l.type),w=y(l.internalFormat,T,E,l.colorSpace),A=!0!==l.isVideoTexture,R=void 0===d.__version||!0===h,C=u.dataReady,P=S(l,b);if(I(e.TEXTURE_CUBE_MAP,l),m){A&&R&&r.texStorage2D(e.TEXTURE_CUBE_MAP,P,w,b.width,b.height);for(let a=0;a<6;a++){i=M[a].mipmaps;for(let s=0;s<i.length;s++){let o=i[s];l.format!==n.GWd?null!==T?A?C&&r.compressedTexSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+a,s,0,0,o.width,o.height,T,o.data):r.compressedTexImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+a,s,w,o.width,o.height,0,o.data):(0,n.R8M)("WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):A?C&&r.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+a,s,0,0,o.width,o.height,T,E,o.data):r.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+a,s,w,o.width,o.height,0,T,E,o.data)}}}else{if(i=l.mipmaps,A&&R){i.length>0&&P++;let n=W(M[0]);r.texStorage2D(e.TEXTURE_CUBE_MAP,P,w,n.width,n.height)}for(let n=0;n<6;n++)if(g){A?C&&r.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+n,0,0,0,M[n].width,M[n].height,T,E,M[n].data):r.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+n,0,w,M[n].width,M[n].height,0,T,E,M[n].data);for(let a=0;a<i.length;a++){let s=i[a].image[n].image;A?C&&r.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+n,a+1,0,0,s.width,s.height,T,E,s.data):r.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+n,a+1,w,s.width,s.height,0,T,E,s.data)}}else{A?C&&r.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+n,0,0,0,T,E,M[n]):r.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+n,0,w,T,E,M[n]);for(let a=0;a<i.length;a++){let s=i[a];A?C&&r.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+n,a+1,0,0,T,E,s.image[n]):r.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+n,a+1,w,T,E,s.image[n])}}}_(l)&&x(e.TEXTURE_CUBE_MAP),d.__version=u.version,l.onUpdate&&l.onUpdate(l)}i.__version=l.version}(c,i,l):r.bindTexture(e.TEXTURE_CUBE_MAP,c.__webglTexture,e.TEXTURE0+l)},this.rebindTextures=function(i,r,n){let s=a.get(i);void 0!==r&&N(s.__webglFramebuffer,i,i.texture,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,0),void 0!==n&&B(i)},this.setupRenderTarget=function(i){let n=i.texture,s=a.get(i),c=a.get(n);i.addEventListener("dispose",T);let h=i.textures,u=!0===i.isWebGLCubeRenderTarget,d=h.length>1;if(!d&&(void 0===c.__webglTexture&&(c.__webglTexture=e.createTexture()),c.__version=n.version,l.memory.textures++),u){s.__webglFramebuffer=[];for(let i=0;i<6;i++)if(n.mipmaps&&n.mipmaps.length>0){s.__webglFramebuffer[i]=[];for(let r=0;r<n.mipmaps.length;r++)s.__webglFramebuffer[i][r]=e.createFramebuffer()}else s.__webglFramebuffer[i]=e.createFramebuffer()}else{if(n.mipmaps&&n.mipmaps.length>0){s.__webglFramebuffer=[];for(let i=0;i<n.mipmaps.length;i++)s.__webglFramebuffer[i]=e.createFramebuffer()}else s.__webglFramebuffer=e.createFramebuffer();if(d)for(let i=0,r=h.length;i<r;i++){let r=a.get(h[i]);void 0===r.__webglTexture&&(r.__webglTexture=e.createTexture(),l.memory.textures++)}if(i.samples>0&&!1===H(i)){s.__webglMultisampledFramebuffer=e.createFramebuffer(),s.__webglColorRenderbuffer=[],r.bindFramebuffer(e.FRAMEBUFFER,s.__webglMultisampledFramebuffer);for(let r=0;r<h.length;r++){let n=h[r];s.__webglColorRenderbuffer[r]=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,s.__webglColorRenderbuffer[r]);let a=o.convert(n.format,n.colorSpace),l=o.convert(n.type),c=y(n.internalFormat,a,l,n.colorSpace,!0===i.isXRRenderTarget),u=V(i);e.renderbufferStorageMultisample(e.RENDERBUFFER,u,c,i.width,i.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+r,e.RENDERBUFFER,s.__webglColorRenderbuffer[r])}e.bindRenderbuffer(e.RENDERBUFFER,null),i.depthBuffer&&(s.__webglDepthRenderbuffer=e.createRenderbuffer(),O(s.__webglDepthRenderbuffer,i,!0)),r.bindFramebuffer(e.FRAMEBUFFER,null)}}if(u){r.bindTexture(e.TEXTURE_CUBE_MAP,c.__webglTexture),I(e.TEXTURE_CUBE_MAP,n);for(let r=0;r<6;r++)if(n.mipmaps&&n.mipmaps.length>0)for(let a=0;a<n.mipmaps.length;a++)N(s.__webglFramebuffer[r][a],i,n,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+r,a);else N(s.__webglFramebuffer[r],i,n,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+r,0);_(n)&&x(e.TEXTURE_CUBE_MAP),r.unbindTexture()}else if(d){for(let n=0,o=h.length;n<o;n++){let o=h[n],l=a.get(o),c=e.TEXTURE_2D;(i.isWebGL3DRenderTarget||i.isWebGLArrayRenderTarget)&&(c=i.isWebGL3DRenderTarget?e.TEXTURE_3D:e.TEXTURE_2D_ARRAY),r.bindTexture(c,l.__webglTexture),I(c,o),N(s.__webglFramebuffer,i,o,e.COLOR_ATTACHMENT0+n,c,0),_(o)&&x(c)}r.unbindTexture()}else{let a=e.TEXTURE_2D;if((i.isWebGL3DRenderTarget||i.isWebGLArrayRenderTarget)&&(a=i.isWebGL3DRenderTarget?e.TEXTURE_3D:e.TEXTURE_2D_ARRAY),r.bindTexture(a,c.__webglTexture),I(a,n),n.mipmaps&&n.mipmaps.length>0)for(let r=0;r<n.mipmaps.length;r++)N(s.__webglFramebuffer[r],i,n,e.COLOR_ATTACHMENT0,a,r);else N(s.__webglFramebuffer,i,n,e.COLOR_ATTACHMENT0,a,0);_(n)&&x(a),r.unbindTexture()}i.depthBuffer&&B(i)},this.updateRenderTargetMipmap=function(i){let n=i.textures;for(let s=0,o=n.length;s<o;s++){let o=n[s];if(_(o)){let n=i.isWebGLCubeRenderTarget?e.TEXTURE_CUBE_MAP:i.isWebGL3DRenderTarget?e.TEXTURE_3D:i.isWebGLArrayRenderTarget||i.isCompressedArrayTexture?e.TEXTURE_2D_ARRAY:e.TEXTURE_2D,s=a.get(o).__webglTexture;r.bindTexture(n,s),x(n),r.unbindTexture()}}},this.updateMultisampleRenderTarget=function(i){if(i.samples>0){if(!1===H(i)){let n=i.textures,s=i.width,o=i.height,l=e.COLOR_BUFFER_BIT,c=i.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,h=a.get(i),d=n.length>1;if(d)for(let i=0;i<n.length;i++)r.bindFramebuffer(e.FRAMEBUFFER,h.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+i,e.RENDERBUFFER,null),r.bindFramebuffer(e.FRAMEBUFFER,h.__webglFramebuffer),e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0+i,e.TEXTURE_2D,null,0);r.bindFramebuffer(e.READ_FRAMEBUFFER,h.__webglMultisampledFramebuffer);let p=i.texture.mipmaps;p&&p.length>0?r.bindFramebuffer(e.DRAW_FRAMEBUFFER,h.__webglFramebuffer[0]):r.bindFramebuffer(e.DRAW_FRAMEBUFFER,h.__webglFramebuffer);for(let r=0;r<n.length;r++){if(i.resolveDepthBuffer&&(i.depthBuffer&&(l|=e.DEPTH_BUFFER_BIT),i.stencilBuffer&&i.resolveStencilBuffer&&(l|=e.STENCIL_BUFFER_BIT)),d){e.framebufferRenderbuffer(e.READ_FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.RENDERBUFFER,h.__webglColorRenderbuffer[r]);let i=a.get(n[r]).__webglTexture;e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,i,0)}e.blitFramebuffer(0,0,s,o,0,0,s,o,l,e.NEAREST),!0===u&&(z.length=0,k.length=0,z.push(e.COLOR_ATTACHMENT0+r),i.depthBuffer&&!1===i.resolveDepthBuffer&&(z.push(c),k.push(c),e.invalidateFramebuffer(e.DRAW_FRAMEBUFFER,k)),e.invalidateFramebuffer(e.READ_FRAMEBUFFER,z))}if(r.bindFramebuffer(e.READ_FRAMEBUFFER,null),r.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),d)for(let i=0;i<n.length;i++){r.bindFramebuffer(e.FRAMEBUFFER,h.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+i,e.RENDERBUFFER,h.__webglColorRenderbuffer[i]);let s=a.get(n[i]).__webglTexture;r.bindFramebuffer(e.FRAMEBUFFER,h.__webglFramebuffer),e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0+i,e.TEXTURE_2D,s,0)}r.bindFramebuffer(e.DRAW_FRAMEBUFFER,h.__webglMultisampledFramebuffer)}else if(i.depthBuffer&&!1===i.resolveDepthBuffer&&u){let r=i.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT;e.invalidateFramebuffer(e.DRAW_FRAMEBUFFER,[r])}}},this.setupDepthRenderbuffer=B,this.setupFrameBufferTexture=N,this.useMultisampledRTT=H,this.isReversedDepthBuffer=function(){return r.buffers.depth.getReversed()}}function tP(e,i){return{convert:function(r,a=n.jf0){let s,o=n.ppV.getTransfer(a);if(r===n.OUM)return e.UNSIGNED_BYTE;if(r===n.Wew)return e.UNSIGNED_SHORT_4_4_4_4;if(r===n.gJ2)return e.UNSIGNED_SHORT_5_5_5_1;if(r===n.Dmk)return e.UNSIGNED_INT_5_9_9_9_REV;if(r===n.yT7)return e.UNSIGNED_INT_10F_11F_11F_REV;if(r===n.tJf)return e.BYTE;if(r===n.fBL)return e.SHORT;if(r===n.cHt)return e.UNSIGNED_SHORT;if(r===n.Yuy)return e.INT;if(r===n.bkx)return e.UNSIGNED_INT;if(r===n.RQf)return e.FLOAT;if(r===n.ix0)return e.HALF_FLOAT;if(r===n.wrO)return e.ALPHA;if(r===n.HIg)return e.RGB;if(r===n.GWd)return e.RGBA;if(r===n.zdS)return e.DEPTH_COMPONENT;if(r===n.dcC)return e.DEPTH_STENCIL;if(r===n.VT0)return e.RED;if(r===n.ZQM)return e.RED_INTEGER;if(r===n.paN)return e.RG;if(r===n.TkQ)return e.RG_INTEGER;if(r===n.c90)return e.RGBA_INTEGER;if(r===n.IE4||r===n.Nz6||r===n.jR7||r===n.BXX)if(o===n.KLL){if(null===(s=i.get("WEBGL_compressed_texture_s3tc_srgb")))return null;if(r===n.IE4)return s.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(r===n.Nz6)return s.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(r===n.jR7)return s.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(r===n.BXX)return s.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else{if(null===(s=i.get("WEBGL_compressed_texture_s3tc")))return null;if(r===n.IE4)return s.COMPRESSED_RGB_S3TC_DXT1_EXT;if(r===n.Nz6)return s.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(r===n.jR7)return s.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(r===n.BXX)return s.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(r===n.k6Q||r===n.kTp||r===n.HXV||r===n.pBf){if(null===(s=i.get("WEBGL_compressed_texture_pvrtc")))return null;if(r===n.k6Q)return s.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(r===n.kTp)return s.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(r===n.HXV)return s.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(r===n.pBf)return s.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(r===n.CVz||r===n.Riy||r===n.KDk||r===n.BVL||r===n.gZr||r===n.OtU||r===n.jSS){if(null===(s=i.get("WEBGL_compressed_texture_etc")))return null;if(r===n.CVz||r===n.Riy)return o===n.KLL?s.COMPRESSED_SRGB8_ETC2:s.COMPRESSED_RGB8_ETC2;if(r===n.KDk)return o===n.KLL?s.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:s.COMPRESSED_RGBA8_ETC2_EAC;if(r===n.BVL)return s.COMPRESSED_R11_EAC;if(r===n.gZr)return s.COMPRESSED_SIGNED_R11_EAC;if(r===n.OtU)return s.COMPRESSED_RG11_EAC;if(r===n.jSS)return s.COMPRESSED_SIGNED_RG11_EAC}if(r===n.qa3||r===n.B_h||r===n.czI||r===n.rSH||r===n.Qrf||r===n.psI||r===n.a5J||r===n._QJ||r===n.uB5||r===n.lyL||r===n.bC7||r===n.y3Z||r===n.ojs||r===n.S$4){if(null===(s=i.get("WEBGL_compressed_texture_astc")))return null;if(r===n.qa3)return o===n.KLL?s.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:s.COMPRESSED_RGBA_ASTC_4x4_KHR;if(r===n.B_h)return o===n.KLL?s.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:s.COMPRESSED_RGBA_ASTC_5x4_KHR;if(r===n.czI)return o===n.KLL?s.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:s.COMPRESSED_RGBA_ASTC_5x5_KHR;if(r===n.rSH)return o===n.KLL?s.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:s.COMPRESSED_RGBA_ASTC_6x5_KHR;if(r===n.Qrf)return o===n.KLL?s.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:s.COMPRESSED_RGBA_ASTC_6x6_KHR;if(r===n.psI)return o===n.KLL?s.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:s.COMPRESSED_RGBA_ASTC_8x5_KHR;if(r===n.a5J)return o===n.KLL?s.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:s.COMPRESSED_RGBA_ASTC_8x6_KHR;if(r===n._QJ)return o===n.KLL?s.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:s.COMPRESSED_RGBA_ASTC_8x8_KHR;if(r===n.uB5)return o===n.KLL?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:s.COMPRESSED_RGBA_ASTC_10x5_KHR;if(r===n.lyL)return o===n.KLL?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:s.COMPRESSED_RGBA_ASTC_10x6_KHR;if(r===n.bC7)return o===n.KLL?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:s.COMPRESSED_RGBA_ASTC_10x8_KHR;if(r===n.y3Z)return o===n.KLL?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:s.COMPRESSED_RGBA_ASTC_10x10_KHR;if(r===n.ojs)return o===n.KLL?s.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:s.COMPRESSED_RGBA_ASTC_12x10_KHR;if(r===n.S$4)return o===n.KLL?s.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:s.COMPRESSED_RGBA_ASTC_12x12_KHR}if(r===n.Fn||r===n.H23||r===n.W9U){if(null===(s=i.get("EXT_texture_compression_bptc")))return null;if(r===n.Fn)return o===n.KLL?s.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:s.COMPRESSED_RGBA_BPTC_UNORM_EXT;if(r===n.H23)return s.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;if(r===n.W9U)return s.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT}if(r===n.Kef||r===n.XG_||r===n.HO_||r===n.CWW){if(null===(s=i.get("EXT_texture_compression_rgtc")))return null;if(r===n.Kef)return s.COMPRESSED_RED_RGTC1_EXT;if(r===n.XG_)return s.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(r===n.HO_)return s.COMPRESSED_RED_GREEN_RGTC2_EXT;if(r===n.CWW)return s.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}return r===n.V3x?e.UNSIGNED_INT_24_8:void 0!==e[r]?e[r]:null}}}let tI=`
 void main() {

	gl_Position = vec4( position, 1.0 );

 }`,tL=`
@@ -4021,6 +4020,6 @@ void main() {

		gl_FragDepth = texture( depthColor, vec3( coord.x, coord.y, 0 ) ).r;

	}

-}`;class tD{constructor(){this.texture=null,this.mesh=null,this.depthNear=0,this.depthFar=0}init(e,i){if(null===this.texture){let r=new n.rjZ(e.texture);(e.depthNear!==i.depthNear||e.depthFar!==i.depthFar)&&(this.depthNear=e.depthNear,this.depthFar=e.depthFar),this.texture=r}}getMesh(e){if(null!==this.texture&&null===this.mesh){let i=e.cameras[0].viewport,r=new n.BKk({vertexShader:tI,fragmentShader:tL,uniforms:{depthColor:{value:this.texture},depthWidth:{value:i.z},depthHeight:{value:i.w}}});this.mesh=new n.eaF(new n.bdM(20,20),r)}return this.mesh}reset(){this.texture=null,this.mesh=null}getDepthTexture(){return this.texture}}class tU extends n.Qev{constructor(e,i){super();const r=this;let s=null,o=1,l=null,c="local-floor",h=1,u=null,d=null,p=null,f=null,m=null,g=null;const v="u">typeof XRWebGLBinding,_=new tD,y={},x=i.getContextAttributes();let M=null,S=null;const b=[],T=[],E=new n.I9Y;let w=null;const A=new n.ubm;A.viewport=new n.IUQ;const R=new n.ubm;R.viewport=new n.IUQ;const C=[A,R],P=new n.nZQ;let I=null,L=null;function D(e){let i=T.indexOf(e.inputSource);if(-1===i)return;let r=b[i];void 0!==r&&(r.update(e.inputSource,e.frame,u||l),r.dispatchEvent({type:e.type,data:e.inputSource}))}function U(){s.removeEventListener("select",D),s.removeEventListener("selectstart",D),s.removeEventListener("selectend",D),s.removeEventListener("squeeze",D),s.removeEventListener("squeezestart",D),s.removeEventListener("squeezeend",D),s.removeEventListener("end",U),s.removeEventListener("inputsourceschange",N);for(let e=0;e<b.length;e++){let i=T[e];null!==i&&(T[e]=null,b[e].disconnect(i))}for(let e in I=null,L=null,_.reset(),y)delete y[e];e.setRenderTarget(M),m=null,f=null,p=null,s=null,S=null,k.stop(),r.isPresenting=!1,e.setPixelRatio(w),e.setSize(E.width,E.height,!1),r.dispatchEvent({type:"sessionend"})}function N(e){for(let i=0;i<e.removed.length;i++){let r=e.removed[i],n=T.indexOf(r);n>=0&&(T[n]=null,b[n].disconnect(r))}for(let i=0;i<e.added.length;i++){let r=e.added[i],n=T.indexOf(r);if(-1===n){for(let e=0;e<b.length;e++)if(e>=T.length){T.push(r),n=e;break}else if(null===T[e]){T[e]=r,n=e;break}if(-1===n)break}let a=b[n];a&&a.connect(r)}}this.cameraAutoUpdate=!0,this.enabled=!1,this.isPresenting=!1,this.getController=function(e){let i=b[e];return void 0===i&&(i=new n.R3r,b[e]=i),i.getTargetRaySpace()},this.getControllerGrip=function(e){let i=b[e];return void 0===i&&(i=new n.R3r,b[e]=i),i.getGripSpace()},this.getHand=function(e){let i=b[e];return void 0===i&&(i=new n.R3r,b[e]=i),i.getHandSpace()},this.setFramebufferScaleFactor=function(e){o=e,!0===r.isPresenting&&(0,n.R8M)("WebXRManager: Cannot change framebuffer scale while presenting.")},this.setReferenceSpaceType=function(e){c=e,!0===r.isPresenting&&(0,n.R8M)("WebXRManager: Cannot change reference space type while presenting.")},this.getReferenceSpace=function(){return u||l},this.setReferenceSpace=function(e){u=e},this.getBaseLayer=function(){return null!==f?f:m},this.getBinding=function(){return null===p&&v&&(p=new XRWebGLBinding(s,i)),p},this.getFrame=function(){return g},this.getSession=function(){return s},this.setSession=async function(a){if(null!==(s=a)){if(M=e.getRenderTarget(),s.addEventListener("select",D),s.addEventListener("selectstart",D),s.addEventListener("selectend",D),s.addEventListener("squeeze",D),s.addEventListener("squeezestart",D),s.addEventListener("squeezeend",D),s.addEventListener("end",U),s.addEventListener("inputsourceschange",N),!0!==x.xrCompatible&&await i.makeXRCompatible(),w=e.getPixelRatio(),e.getSize(E),v&&"createProjectionLayer"in XRWebGLBinding.prototype){let r=null,a=null,l=null;x.depth&&(l=x.stencil?i.DEPTH24_STENCIL8:i.DEPTH_COMPONENT24,r=x.stencil?n.dcC:n.zdS,a=x.stencil?n.V3x:n.bkx);let c={colorFormat:i.RGBA8,depthFormat:l,scaleFactor:o};f=(p=this.getBinding()).createProjectionLayer(c),s.updateRenderState({layers:[f]}),e.setPixelRatio(1),e.setSize(f.textureWidth,f.textureHeight,!1),S=new n.nWS(f.textureWidth,f.textureHeight,{format:n.GWd,type:n.OUM,depthTexture:new n.VCu(f.textureWidth,f.textureHeight,a,void 0,void 0,void 0,void 0,void 0,void 0,r),stencilBuffer:x.stencil,colorSpace:e.outputColorSpace,samples:4*!!x.antialias,resolveDepthBuffer:!1===f.ignoreDepthValues,resolveStencilBuffer:!1===f.ignoreDepthValues})}else{let r={antialias:x.antialias,alpha:!0,depth:x.depth,stencil:x.stencil,framebufferScaleFactor:o};m=new XRWebGLLayer(s,i,r),s.updateRenderState({baseLayer:m}),e.setPixelRatio(1),e.setSize(m.framebufferWidth,m.framebufferHeight,!1),S=new n.nWS(m.framebufferWidth,m.framebufferHeight,{format:n.GWd,type:n.OUM,colorSpace:e.outputColorSpace,stencilBuffer:x.stencil,resolveDepthBuffer:!1===m.ignoreDepthValues,resolveStencilBuffer:!1===m.ignoreDepthValues})}S.isXRRenderTarget=!0,this.setFoveation(h),u=null,l=await s.requestReferenceSpace(c),k.setContext(s),k.start(),r.isPresenting=!0,r.dispatchEvent({type:"sessionstart"})}},this.getEnvironmentBlendMode=function(){if(null!==s)return s.environmentBlendMode},this.getDepthTexture=function(){return _.getDepthTexture()};const O=new n.Pq0,F=new n.Pq0;function B(e,i){null===i?e.matrixWorld.copy(e.matrix):e.matrixWorld.multiplyMatrices(i.matrixWorld,e.matrix),e.matrixWorldInverse.copy(e.matrixWorld).invert()}this.updateCamera=function(e){var i,r,a;if(null===s)return;let o=e.near,l=e.far;null!==_.texture&&(_.depthNear>0&&(o=_.depthNear),_.depthFar>0&&(l=_.depthFar)),P.near=R.near=A.near=o,P.far=R.far=A.far=l,(I!==P.near||L!==P.far)&&(s.updateRenderState({depthNear:P.near,depthFar:P.far}),I=P.near,L=P.far),P.layers.mask=6|e.layers.mask,A.layers.mask=3&P.layers.mask,R.layers.mask=5&P.layers.mask;let c=e.parent,h=P.cameras;B(P,c);for(let e=0;e<h.length;e++)B(h[e],c);2===h.length?function(e,i,r){O.setFromMatrixPosition(i.matrixWorld),F.setFromMatrixPosition(r.matrixWorld);let n=O.distanceTo(F),a=i.projectionMatrix.elements,s=r.projectionMatrix.elements,o=a[14]/(a[10]-1),l=a[14]/(a[10]+1),c=(a[9]+1)/a[5],h=(a[9]-1)/a[5],u=(a[8]-1)/a[0],d=(s[8]+1)/s[0],p=n/(-u+d),f=-(p*u);if(i.matrixWorld.decompose(e.position,e.quaternion,e.scale),e.translateX(f),e.translateZ(p),e.matrixWorld.compose(e.position,e.quaternion,e.scale),e.matrixWorldInverse.copy(e.matrixWorld).invert(),-1===a[10])e.projectionMatrix.copy(i.projectionMatrix),e.projectionMatrixInverse.copy(i.projectionMatrixInverse);else{let i=o+p,r=l+p;e.projectionMatrix.makePerspective(o*u-f,o*d+(n-f),c*l/r*i,h*l/r*i,i,r),e.projectionMatrixInverse.copy(e.projectionMatrix).invert()}}(P,A,R):P.projectionMatrix.copy(A.projectionMatrix),i=e,r=P,null===(a=c)?i.matrix.copy(r.matrixWorld):(i.matrix.copy(a.matrixWorld),i.matrix.invert(),i.matrix.multiply(r.matrixWorld)),i.matrix.decompose(i.position,i.quaternion,i.scale),i.updateMatrixWorld(!0),i.projectionMatrix.copy(r.projectionMatrix),i.projectionMatrixInverse.copy(r.projectionMatrixInverse),i.isPerspectiveCamera&&(i.fov=2*n.a55*Math.atan(1/i.projectionMatrix.elements[5]),i.zoom=1)},this.getCamera=function(){return P},this.getFoveation=function(){if(null!==f||null!==m)return h},this.setFoveation=function(e){h=e,null!==f&&(f.fixedFoveation=e),null!==m&&void 0!==m.fixedFoveation&&(m.fixedFoveation=e)},this.hasDepthSensing=function(){return null!==_.texture},this.getDepthSensingMesh=function(){return _.getMesh(P)},this.getCameraTexture=function(e){return y[e]};let z=null;const k=new a;k.setAnimationLoop(function(i,a){if(d=a.getViewerPose(u||l),g=a,null!==d){let i=d.views;null!==m&&(e.setRenderTargetFramebuffer(S,m.framebuffer),e.setRenderTarget(S));let a=!1;i.length!==P.cameras.length&&(P.cameras.length=0,a=!0);for(let r=0;r<i.length;r++){let s=i[r],o=null;if(null!==m)o=m.getViewport(s);else{let i=p.getViewSubImage(f,s);o=i.viewport,0===r&&(e.setRenderTargetTextures(S,i.colorTexture,i.depthStencilTexture),e.setRenderTarget(S))}let l=C[r];void 0===l&&((l=new n.ubm).layers.enable(r),l.viewport=new n.IUQ,C[r]=l),l.matrix.fromArray(s.transform.matrix),l.matrix.decompose(l.position,l.quaternion,l.scale),l.projectionMatrix.fromArray(s.projectionMatrix),l.projectionMatrixInverse.copy(l.projectionMatrix).invert(),l.viewport.set(o.x,o.y,o.width,o.height),0===r&&(P.matrix.copy(l.matrix),P.matrix.decompose(P.position,P.quaternion,P.scale)),!0===a&&P.cameras.push(l)}let o=s.enabledFeatures;if(o&&o.includes("depth-sensing")&&"gpu-optimized"==s.depthUsage&&v){let e=(p=r.getBinding()).getDepthInformation(i[0]);e&&e.isValid&&e.texture&&_.init(e,s.renderState)}if(o&&o.includes("camera-access")&&v){e.state.unbindTexture(),p=r.getBinding();for(let e=0;e<i.length;e++){let r=i[e].camera;if(r){let e=y[r];e||(e=new n.rjZ,y[r]=e);let i=p.getCameraImage(r);e.sourceTexture=i}}}}for(let e=0;e<b.length;e++){let i=T[e],r=b[e];null!==i&&void 0!==r&&r.update(i,a,u||l)}z&&z(i,a),a.detectedPlanes&&r.dispatchEvent({type:"planesdetected",data:a}),g=null}),this.setAnimationLoop=function(e){z=e},this.dispose=function(){}}}let tN=new n.O9p,tO=new n.kn4;function tF(e,i){function r(e,i){!0===e.matrixAutoUpdate&&e.updateMatrix(),i.value.copy(e.matrix)}function a(e,a){e.opacity.value=a.opacity,a.color&&e.diffuse.value.copy(a.color),a.emissive&&e.emissive.value.copy(a.emissive).multiplyScalar(a.emissiveIntensity),a.map&&(e.map.value=a.map,r(a.map,e.mapTransform)),a.alphaMap&&(e.alphaMap.value=a.alphaMap,r(a.alphaMap,e.alphaMapTransform)),a.bumpMap&&(e.bumpMap.value=a.bumpMap,r(a.bumpMap,e.bumpMapTransform),e.bumpScale.value=a.bumpScale,a.side===n.hsX&&(e.bumpScale.value*=-1)),a.normalMap&&(e.normalMap.value=a.normalMap,r(a.normalMap,e.normalMapTransform),e.normalScale.value.copy(a.normalScale),a.side===n.hsX&&e.normalScale.value.negate()),a.displacementMap&&(e.displacementMap.value=a.displacementMap,r(a.displacementMap,e.displacementMapTransform),e.displacementScale.value=a.displacementScale,e.displacementBias.value=a.displacementBias),a.emissiveMap&&(e.emissiveMap.value=a.emissiveMap,r(a.emissiveMap,e.emissiveMapTransform)),a.specularMap&&(e.specularMap.value=a.specularMap,r(a.specularMap,e.specularMapTransform)),a.alphaTest>0&&(e.alphaTest.value=a.alphaTest);let s=i.get(a),o=s.envMap,l=s.envMapRotation;o&&(e.envMap.value=o,tN.copy(l),tN.x*=-1,tN.y*=-1,tN.z*=-1,o.isCubeTexture&&!1===o.isRenderTargetTexture&&(tN.y*=-1,tN.z*=-1),e.envMapRotation.value.setFromMatrix4(tO.makeRotationFromEuler(tN)),e.flipEnvMap.value=o.isCubeTexture&&!1===o.isRenderTargetTexture?-1:1,e.reflectivity.value=a.reflectivity,e.ior.value=a.ior,e.refractionRatio.value=a.refractionRatio),a.lightMap&&(e.lightMap.value=a.lightMap,e.lightMapIntensity.value=a.lightMapIntensity,r(a.lightMap,e.lightMapTransform)),a.aoMap&&(e.aoMap.value=a.aoMap,e.aoMapIntensity.value=a.aoMapIntensity,r(a.aoMap,e.aoMapTransform))}return{refreshFogUniforms:function(i,r){r.color.getRGB(i.fogColor.value,(0,n._Ut)(e)),r.isFog?(i.fogNear.value=r.near,i.fogFar.value=r.far):r.isFogExp2&&(i.fogDensity.value=r.density)},refreshMaterialUniforms:function(e,s,o,l,c){var h,u,d,p,f,m,g,v,_,y,x,M,S,b,T,E,w,A,R,C,P,I,L;let D;s.isMeshBasicMaterial||s.isMeshLambertMaterial?a(e,s):s.isMeshToonMaterial?(a(e,s),h=e,(u=s).gradientMap&&(h.gradientMap.value=u.gradientMap)):s.isMeshPhongMaterial?(a(e,s),d=e,p=s,d.specular.value.copy(p.specular),d.shininess.value=Math.max(p.shininess,1e-4)):s.isMeshStandardMaterial?(a(e,s),f=e,m=s,f.metalness.value=m.metalness,m.metalnessMap&&(f.metalnessMap.value=m.metalnessMap,r(m.metalnessMap,f.metalnessMapTransform)),f.roughness.value=m.roughness,m.roughnessMap&&(f.roughnessMap.value=m.roughnessMap,r(m.roughnessMap,f.roughnessMapTransform)),m.envMap&&(f.envMapIntensity.value=m.envMapIntensity),s.isMeshPhysicalMaterial&&(g=e,v=s,_=c,g.ior.value=v.ior,v.sheen>0&&(g.sheenColor.value.copy(v.sheenColor).multiplyScalar(v.sheen),g.sheenRoughness.value=v.sheenRoughness,v.sheenColorMap&&(g.sheenColorMap.value=v.sheenColorMap,r(v.sheenColorMap,g.sheenColorMapTransform)),v.sheenRoughnessMap&&(g.sheenRoughnessMap.value=v.sheenRoughnessMap,r(v.sheenRoughnessMap,g.sheenRoughnessMapTransform))),v.clearcoat>0&&(g.clearcoat.value=v.clearcoat,g.clearcoatRoughness.value=v.clearcoatRoughness,v.clearcoatMap&&(g.clearcoatMap.value=v.clearcoatMap,r(v.clearcoatMap,g.clearcoatMapTransform)),v.clearcoatRoughnessMap&&(g.clearcoatRoughnessMap.value=v.clearcoatRoughnessMap,r(v.clearcoatRoughnessMap,g.clearcoatRoughnessMapTransform)),v.clearcoatNormalMap&&(g.clearcoatNormalMap.value=v.clearcoatNormalMap,r(v.clearcoatNormalMap,g.clearcoatNormalMapTransform),g.clearcoatNormalScale.value.copy(v.clearcoatNormalScale),v.side===n.hsX&&g.clearcoatNormalScale.value.negate())),v.dispersion>0&&(g.dispersion.value=v.dispersion),v.iridescence>0&&(g.iridescence.value=v.iridescence,g.iridescenceIOR.value=v.iridescenceIOR,g.iridescenceThicknessMinimum.value=v.iridescenceThicknessRange[0],g.iridescenceThicknessMaximum.value=v.iridescenceThicknessRange[1],v.iridescenceMap&&(g.iridescenceMap.value=v.iridescenceMap,r(v.iridescenceMap,g.iridescenceMapTransform)),v.iridescenceThicknessMap&&(g.iridescenceThicknessMap.value=v.iridescenceThicknessMap,r(v.iridescenceThicknessMap,g.iridescenceThicknessMapTransform))),v.transmission>0&&(g.transmission.value=v.transmission,g.transmissionSamplerMap.value=_.texture,g.transmissionSamplerSize.value.set(_.width,_.height),v.transmissionMap&&(g.transmissionMap.value=v.transmissionMap,r(v.transmissionMap,g.transmissionMapTransform)),g.thickness.value=v.thickness,v.thicknessMap&&(g.thicknessMap.value=v.thicknessMap,r(v.thicknessMap,g.thicknessMapTransform)),g.attenuationDistance.value=v.attenuationDistance,g.attenuationColor.value.copy(v.attenuationColor)),v.anisotropy>0&&(g.anisotropyVector.value.set(v.anisotropy*Math.cos(v.anisotropyRotation),v.anisotropy*Math.sin(v.anisotropyRotation)),v.anisotropyMap&&(g.anisotropyMap.value=v.anisotropyMap,r(v.anisotropyMap,g.anisotropyMapTransform))),g.specularIntensity.value=v.specularIntensity,g.specularColor.value.copy(v.specularColor),v.specularColorMap&&(g.specularColorMap.value=v.specularColorMap,r(v.specularColorMap,g.specularColorMapTransform)),v.specularIntensityMap&&(g.specularIntensityMap.value=v.specularIntensityMap,r(v.specularIntensityMap,g.specularIntensityMapTransform)))):s.isMeshMatcapMaterial?(a(e,s),y=e,(x=s).matcap&&(y.matcap.value=x.matcap)):s.isMeshDepthMaterial?a(e,s):s.isMeshDistanceMaterial?(a(e,s),M=e,S=s,D=i.get(S).light,M.referencePosition.value.setFromMatrixPosition(D.matrixWorld),M.nearDistance.value=D.shadow.camera.near,M.farDistance.value=D.shadow.camera.far):s.isMeshNormalMaterial?a(e,s):s.isLineBasicMaterial?(b=e,T=s,b.diffuse.value.copy(T.color),b.opacity.value=T.opacity,T.map&&(b.map.value=T.map,r(T.map,b.mapTransform)),s.isLineDashedMaterial&&(E=e,w=s,E.dashSize.value=w.dashSize,E.totalSize.value=w.dashSize+w.gapSize,E.scale.value=w.scale)):s.isPointsMaterial?(A=e,R=s,C=o,P=l,A.diffuse.value.copy(R.color),A.opacity.value=R.opacity,A.size.value=R.size*C,A.scale.value=.5*P,R.map&&(A.map.value=R.map,r(R.map,A.uvTransform)),R.alphaMap&&(A.alphaMap.value=R.alphaMap,r(R.alphaMap,A.alphaMapTransform)),R.alphaTest>0&&(A.alphaTest.value=R.alphaTest)):s.isSpriteMaterial?(I=e,L=s,I.diffuse.value.copy(L.color),I.opacity.value=L.opacity,I.rotation.value=L.rotation,L.map&&(I.map.value=L.map,r(L.map,I.mapTransform)),L.alphaMap&&(I.alphaMap.value=L.alphaMap,r(L.alphaMap,I.alphaMapTransform)),L.alphaTest>0&&(I.alphaTest.value=L.alphaTest)):s.isShadowMaterial?(e.color.value.copy(s.color),e.opacity.value=s.opacity):s.isShaderMaterial&&(s.uniformsNeedUpdate=!1)}}}function tB(e,i,r,a){let s={},o={},l=[],c=e.getParameter(e.MAX_UNIFORM_BUFFER_BINDINGS);function h(e){let i={boundary:0,storage:0};return"number"==typeof e||"boolean"==typeof e?(i.boundary=4,i.storage=4):e.isVector2?(i.boundary=8,i.storage=8):e.isVector3||e.isColor?(i.boundary=16,i.storage=12):e.isVector4?(i.boundary=16,i.storage=16):e.isMatrix3?(i.boundary=48,i.storage=48):e.isMatrix4?(i.boundary=64,i.storage=64):e.isTexture?(0,n.R8M)("WebGLRenderer: Texture samplers can not be part of an uniforms group."):(0,n.R8M)("WebGLRenderer: Unsupported uniform value type.",e),i}function u(i){let r=i.target;r.removeEventListener("dispose",u);let n=l.indexOf(r.__bindingPointIndex);l.splice(n,1),e.deleteBuffer(s[r.id]),delete s[r.id],delete o[r.id]}return{bind:function(e,i){let r=i.program;a.uniformBlockBinding(e,r)},update:function(r,d){var p;let f,m,g,v,_=s[r.id];void 0===_&&(function(e){let i=e.uniforms,r=0;for(let e=0,n=i.length;e<n;e++){let n=Array.isArray(i[e])?i[e]:[i[e]];for(let e=0,i=n.length;e<i;e++){let i=n[e],a=Array.isArray(i.value)?i.value:[i.value];for(let e=0,n=a.length;e<n;e++){let n=h(a[e]),s=r%16,o=s%n.boundary,l=s+o;r+=o,0!==l&&16-l<n.storage&&(r+=16-l),i.__data=new Float32Array(n.storage/Float32Array.BYTES_PER_ELEMENT),i.__offset=r,r+=n.storage}}}let n=r%16;n>0&&(r+=16-n),e.__size=r,e.__cache={}}(r),(p=r).__bindingPointIndex=f=function(){for(let e=0;e<c;e++)if(-1===l.indexOf(e))return l.push(e),e;return(0,n.z3S)("WebGLRenderer: Maximum number of simultaneously usable uniforms groups reached."),0}(),m=e.createBuffer(),g=p.__size,v=p.usage,e.bindBuffer(e.UNIFORM_BUFFER,m),e.bufferData(e.UNIFORM_BUFFER,g,v),e.bindBuffer(e.UNIFORM_BUFFER,null),e.bindBufferBase(e.UNIFORM_BUFFER,f,m),_=m,s[r.id]=_,r.addEventListener("dispose",u));let y=d.program;a.updateUBOMapping(r,y);let x=i.render.frame;o[r.id]!==x&&(function(i){let r=s[i.id],n=i.uniforms,a=i.__cache;e.bindBuffer(e.UNIFORM_BUFFER,r);for(let i=0,r=n.length;i<r;i++){let r=Array.isArray(n[i])?n[i]:[n[i]];for(let n=0,s=r.length;n<s;n++){let s=r[n];if(!0===function(e,i,r,n){let a=e.value,s=i+"_"+r;if(void 0===n[s])return"number"==typeof a||"boolean"==typeof a?n[s]=a:n[s]=a.clone(),!0;{let e=n[s];if("number"==typeof a||"boolean"==typeof a){if(e!==a)return n[s]=a,!0}else if(!1===e.equals(a))return e.copy(a),!0}return!1}(s,i,n,a)){let i=s.__offset,r=Array.isArray(s.value)?s.value:[s.value],n=0;for(let a=0;a<r.length;a++){let o=r[a],l=h(o);"number"==typeof o||"boolean"==typeof o?(s.__data[0]=o,e.bufferSubData(e.UNIFORM_BUFFER,i+n,s.__data)):o.isMatrix3?(s.__data[0]=o.elements[0],s.__data[1]=o.elements[1],s.__data[2]=o.elements[2],s.__data[3]=0,s.__data[4]=o.elements[3],s.__data[5]=o.elements[4],s.__data[6]=o.elements[5],s.__data[7]=0,s.__data[8]=o.elements[6],s.__data[9]=o.elements[7],s.__data[10]=o.elements[8],s.__data[11]=0):(o.toArray(s.__data,n),n+=l.storage/Float32Array.BYTES_PER_ELEMENT)}e.bufferSubData(e.UNIFORM_BUFFER,i,s.__data)}}}e.bindBuffer(e.UNIFORM_BUFFER,null)}(r),o[r.id]=x)},dispose:function(){for(let i in s)e.deleteBuffer(s[i]);l=[],s={},o={}}}}let tz=new Uint16Array([12469,15057,12620,14925,13266,14620,13807,14376,14323,13990,14545,13625,14713,13328,14840,12882,14931,12528,14996,12233,15039,11829,15066,11525,15080,11295,15085,10976,15082,10705,15073,10495,13880,14564,13898,14542,13977,14430,14158,14124,14393,13732,14556,13410,14702,12996,14814,12596,14891,12291,14937,11834,14957,11489,14958,11194,14943,10803,14921,10506,14893,10278,14858,9960,14484,14039,14487,14025,14499,13941,14524,13740,14574,13468,14654,13106,14743,12678,14818,12344,14867,11893,14889,11509,14893,11180,14881,10751,14852,10428,14812,10128,14765,9754,14712,9466,14764,13480,14764,13475,14766,13440,14766,13347,14769,13070,14786,12713,14816,12387,14844,11957,14860,11549,14868,11215,14855,10751,14825,10403,14782,10044,14729,9651,14666,9352,14599,9029,14967,12835,14966,12831,14963,12804,14954,12723,14936,12564,14917,12347,14900,11958,14886,11569,14878,11247,14859,10765,14828,10401,14784,10011,14727,9600,14660,9289,14586,8893,14508,8533,15111,12234,15110,12234,15104,12216,15092,12156,15067,12010,15028,11776,14981,11500,14942,11205,14902,10752,14861,10393,14812,9991,14752,9570,14682,9252,14603,8808,14519,8445,14431,8145,15209,11449,15208,11451,15202,11451,15190,11438,15163,11384,15117,11274,15055,10979,14994,10648,14932,10343,14871,9936,14803,9532,14729,9218,14645,8742,14556,8381,14461,8020,14365,7603,15273,10603,15272,10607,15267,10619,15256,10631,15231,10614,15182,10535,15118,10389,15042,10167,14963,9787,14883,9447,14800,9115,14710,8665,14615,8318,14514,7911,14411,7507,14279,7198,15314,9675,15313,9683,15309,9712,15298,9759,15277,9797,15229,9773,15166,9668,15084,9487,14995,9274,14898,8910,14800,8539,14697,8234,14590,7790,14479,7409,14367,7067,14178,6621,15337,8619,15337,8631,15333,8677,15325,8769,15305,8871,15264,8940,15202,8909,15119,8775,15022,8565,14916,8328,14804,8009,14688,7614,14569,7287,14448,6888,14321,6483,14088,6171,15350,7402,15350,7419,15347,7480,15340,7613,15322,7804,15287,7973,15229,8057,15148,8012,15046,7846,14933,7611,14810,7357,14682,7069,14552,6656,14421,6316,14251,5948,14007,5528,15356,5942,15356,5977,15353,6119,15348,6294,15332,6551,15302,6824,15249,7044,15171,7122,15070,7050,14949,6861,14818,6611,14679,6349,14538,6067,14398,5651,14189,5311,13935,4958,15359,4123,15359,4153,15356,4296,15353,4646,15338,5160,15311,5508,15263,5829,15188,6042,15088,6094,14966,6001,14826,5796,14678,5543,14527,5287,14377,4985,14133,4586,13869,4257,15360,1563,15360,1642,15358,2076,15354,2636,15341,3350,15317,4019,15273,4429,15203,4732,15105,4911,14981,4932,14836,4818,14679,4621,14517,4386,14359,4156,14083,3795,13808,3437,15360,122,15360,137,15358,285,15355,636,15344,1274,15322,2177,15281,2765,15215,3223,15120,3451,14995,3569,14846,3567,14681,3466,14511,3305,14344,3121,14037,2800,13753,2467,15360,0,15360,1,15359,21,15355,89,15346,253,15325,479,15287,796,15225,1148,15133,1492,15008,1749,14856,1882,14685,1886,14506,1783,14324,1608,13996,1398,13702,1183]),tk=null;class tV{constructor(e={}){let i,r,o,l,c,h,u,d,y,x,M,S,b,T,E,w,A,R,C,P,I,L,k,H,G;const{canvas:W=(0,n.lPF)(),context:X=null,depth:j=!0,stencil:q=!1,alpha:Y=!1,antialias:K=!1,premultipliedAlpha:J=!0,preserveDrawingBuffer:Z=!1,powerPreference:Q="default",failIfMajorPerformanceCaveat:$=!1,reversedDepthBuffer:ee=!1,outputBufferType:et=n.OUM}=e;if(this.isWebGLRenderer=!0,null!==X){if("u">typeof WebGLRenderingContext&&X instanceof WebGLRenderingContext)throw Error("THREE.WebGLRenderer: WebGL 1 is not supported since r163.");i=X.getContextAttributes().alpha}else i=Y;const ei=new Set([n.c90,n.TkQ,n.ZQM]),er=new Set([n.OUM,n.bkx,n.cHt,n.V3x,n.Wew,n.gJ2]),en=new Uint32Array(4),ea=new Int32Array(4);let es=null,eo=null;const el=[],ec=[];let eh=null;this.domElement=W,this.debug={checkShaderErrors:!0,onShaderError:null},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.toneMapping=n.y_p,this.toneMappingExposure=1,this.transmissionResolutionScale=1;const eu=this;let ed=!1;this._outputColorSpace=n.er$;let ep=0,ef=0,em=null,eg=-1,ev=null;const e_=new n.IUQ,ey=new n.IUQ;let ex=null;const eM=new n.Q1f(0);let eS=0,eb=W.width,eT=W.height,eE=1,ew=null,eA=null;const eR=new n.IUQ(0,0,eb,eT),eC=new n.IUQ(0,0,eb,eT);let eP=!1;const eI=new n.PPD;let eL=!1,eD=!1;const eU=new n.kn4,eN=new n.Pq0,eO=new n.IUQ,eF={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};let eB=!1;function ez(){return null===em?eE:1}let ek=X;function eV(e,i){return W.getContext(e,i)}try{if("setAttribute"in W&&W.setAttribute("data-engine",`three.js r${n.sPf}`),W.addEventListener("webglcontextlost",eW,!1),W.addEventListener("webglcontextrestored",ej,!1),W.addEventListener("webglcontextcreationerror",eq,!1),null===ek){const e="webgl2";if(ek=eV(e,{alpha:!0,depth:j,stencil:q,antialias:K,premultipliedAlpha:J,preserveDrawingBuffer:Z,powerPreference:Q,failIfMajorPerformanceCaveat:$}),null===ek)if(eV(e))throw Error("Error creating WebGL context with your selected attributes.");else throw Error("Error creating WebGL context.")}}catch(e){throw(0,n.z3S)("WebGLRenderer: "+e.message),e}function eH(){(r=new U(ek)).init(),k=new tP(ek,r),o=new g(ek,r,e,k),l=new tR(ek,r),o.reversedDepthBuffer&&ee&&l.buffers.depth.setReversed(!0),c=new F(ek),h=new tl,u=new tC(ek,r,l,h,o,k,c),d=new _(eu),y=new D(eu),x=new s(ek),H=new f(ek,x),M=new N(ek,x,c,H),S=new z(ek,M,x,c),P=new B(ek,o,u),A=new v(h),b=new to(eu,d,y,r,o,H,A),T=new tF(eu,h),E=new td,w=new t_(r),C=new p(eu,d,y,l,S,i,J),R=new tw(eu,S,o),G=new tB(ek,c,o,l),I=new m(ek,r,c),L=new O(ek,r,c),c.programs=b.programs,eu.capabilities=o,eu.extensions=r,eu.properties=h,eu.renderLists=E,eu.shadowMap=R,eu.state=l,eu.info=c}eH(),et!==n.OUM&&(eh=new V(et,W.width,W.height,j,q));const eG=new tU(eu,ek);function eW(e){e.preventDefault(),(0,n.Rm2)("WebGLRenderer: Context Lost."),ed=!0}function ej(){(0,n.Rm2)("WebGLRenderer: Context Restored."),ed=!1;let e=c.autoReset,i=R.enabled,r=R.autoUpdate,a=R.needsUpdate,s=R.type;eH(),c.autoReset=e,R.enabled=i,R.autoUpdate=r,R.needsUpdate=a,R.type=s}function eq(e){(0,n.z3S)("WebGLRenderer: A WebGL context could not be created. Reason: ",e.statusMessage)}function eY(e){var i,r;let n,a=e.target;a.removeEventListener("dispose",eY),r=i=a,void 0!==(n=h.get(r).programs)&&(n.forEach(function(e){b.releaseProgram(e)}),r.isShaderMaterial&&b.releaseShaderCache(r)),h.remove(i)}function eK(e,i,r){!0===e.transparent&&e.side===n.$EB&&!1===e.forceSinglePass?(e.side=n.hsX,e.needsUpdate=!0,e5(e,i,r),e.side=n.hB5,e.needsUpdate=!0,e5(e,i,r),e.side=n.$EB):e5(e,i,r)}this.xr=eG,this.getContext=function(){return ek},this.getContextAttributes=function(){return ek.getContextAttributes()},this.forceContextLoss=function(){let e=r.get("WEBGL_lose_context");e&&e.loseContext()},this.forceContextRestore=function(){let e=r.get("WEBGL_lose_context");e&&e.restoreContext()},this.getPixelRatio=function(){return eE},this.setPixelRatio=function(e){void 0!==e&&(eE=e,this.setSize(eb,eT,!1))},this.getSize=function(e){return e.set(eb,eT)},this.setSize=function(e,i,r=!0){eG.isPresenting?(0,n.R8M)("WebGLRenderer: Can't change size while VR device is presenting."):(eb=e,eT=i,W.width=Math.floor(e*eE),W.height=Math.floor(i*eE),!0===r&&(W.style.width=e+"px",W.style.height=i+"px"),null!==eh&&eh.setSize(W.width,W.height),this.setViewport(0,0,e,i))},this.getDrawingBufferSize=function(e){return e.set(eb*eE,eT*eE).floor()},this.setDrawingBufferSize=function(e,i,r){eb=e,eT=i,eE=r,W.width=Math.floor(e*r),W.height=Math.floor(i*r),this.setViewport(0,0,e,i)},this.setEffects=function(e){if(et===n.OUM)return void console.error("THREE.WebGLRenderer: setEffects() requires outputBufferType set to HalfFloatType or FloatType.");if(e){for(let i=0;i<e.length;i++)if(!0===e[i].isOutputPass){console.warn("THREE.WebGLRenderer: OutputPass is not needed in setEffects(). Tone mapping and color space conversion are applied automatically.");break}}eh.setEffects(e||[])},this.getCurrentViewport=function(e){return e.copy(e_)},this.getViewport=function(e){return e.copy(eR)},this.setViewport=function(e,i,r,n){e.isVector4?eR.set(e.x,e.y,e.z,e.w):eR.set(e,i,r,n),l.viewport(e_.copy(eR).multiplyScalar(eE).round())},this.getScissor=function(e){return e.copy(eC)},this.setScissor=function(e,i,r,n){e.isVector4?eC.set(e.x,e.y,e.z,e.w):eC.set(e,i,r,n),l.scissor(ey.copy(eC).multiplyScalar(eE).round())},this.getScissorTest=function(){return eP},this.setScissorTest=function(e){l.setScissorTest(eP=e)},this.setOpaqueSort=function(e){ew=e},this.setTransparentSort=function(e){eA=e},this.getClearColor=function(e){return e.copy(C.getClearColor())},this.setClearColor=function(){C.setClearColor(...arguments)},this.getClearAlpha=function(){return C.getClearAlpha()},this.setClearAlpha=function(){C.setClearAlpha(...arguments)},this.clear=function(e=!0,i=!0,r=!0){let n=0;if(e){let e=!1;if(null!==em){let i=em.texture.format;e=ei.has(i)}if(e){let e=em.texture.type,i=er.has(e),r=C.getClearColor(),n=C.getClearAlpha(),a=r.r,s=r.g,o=r.b;i?(en[0]=a,en[1]=s,en[2]=o,en[3]=n,ek.clearBufferuiv(ek.COLOR,0,en)):(ea[0]=a,ea[1]=s,ea[2]=o,ea[3]=n,ek.clearBufferiv(ek.COLOR,0,ea))}else n|=ek.COLOR_BUFFER_BIT}i&&(n|=ek.DEPTH_BUFFER_BIT),r&&(n|=ek.STENCIL_BUFFER_BIT,this.state.buffers.stencil.setMask(0xffffffff)),ek.clear(n)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){W.removeEventListener("webglcontextlost",eW,!1),W.removeEventListener("webglcontextrestored",ej,!1),W.removeEventListener("webglcontextcreationerror",eq,!1),C.dispose(),E.dispose(),w.dispose(),h.dispose(),d.dispose(),y.dispose(),S.dispose(),H.dispose(),G.dispose(),b.dispose(),eG.dispose(),eG.removeEventListener("sessionstart",eZ),eG.removeEventListener("sessionend",eQ),e$.stop()},this.renderBufferDirect=function(e,i,a,s,c,p){let f;null===i&&(i=eF);let m=c.isMesh&&0>c.matrixWorld.determinant(),g=function(e,i,r,a,s){var c,p;!0!==i.isScene&&(i=eF),u.resetTextureUnits();let f=i.fog,m=a.isMeshStandardMaterial?i.environment:null,g=null===em?eu.outputColorSpace:!0===em.isXRRenderTarget?em.texture.colorSpace:n.Zr2,v=(a.isMeshStandardMaterial?y:d).get(a.envMap||m),_=!0===a.vertexColors&&!!r.attributes.color&&4===r.attributes.color.itemSize,x=!!r.attributes.tangent&&(!!a.normalMap||a.anisotropy>0),M=!!r.morphAttributes.position,S=!!r.morphAttributes.normal,b=!!r.morphAttributes.color,E=n.y_p;a.toneMapped&&(null===em||!0===em.isXRRenderTarget)&&(E=eu.toneMapping);let w=r.morphAttributes.position||r.morphAttributes.normal||r.morphAttributes.color,R=void 0!==w?w.length:0,C=h.get(a),I=eo.state.lights;if(!0===eL&&(!0===eD||e!==ev)){let i=e===ev&&a.id===eg;A.setState(a,e,i)}let L=!1;a.version===C.__version?C.needsLights&&C.lightsStateVersion!==I.state.version||C.outputColorSpace!==g||s.isBatchedMesh&&!1===C.batching?L=!0:s.isBatchedMesh||!0!==C.batching?s.isBatchedMesh&&!0===C.batchingColor&&null===s.colorTexture||s.isBatchedMesh&&!1===C.batchingColor&&null!==s.colorTexture||s.isInstancedMesh&&!1===C.instancing?L=!0:s.isInstancedMesh||!0!==C.instancing?s.isSkinnedMesh&&!1===C.skinning?L=!0:s.isSkinnedMesh||!0!==C.skinning?s.isInstancedMesh&&!0===C.instancingColor&&null===s.instanceColor||s.isInstancedMesh&&!1===C.instancingColor&&null!==s.instanceColor||s.isInstancedMesh&&!0===C.instancingMorph&&null===s.morphTexture||s.isInstancedMesh&&!1===C.instancingMorph&&null!==s.morphTexture||C.envMap!==v||!0===a.fog&&C.fog!==f||void 0!==C.numClippingPlanes&&(C.numClippingPlanes!==A.numPlanes||C.numIntersection!==A.numIntersection)||C.vertexAlphas!==_||C.vertexTangents!==x||C.morphTargets!==M||C.morphNormals!==S||C.morphColors!==b||C.toneMapping!==E?L=!0:C.morphTargetsCount!==R&&(L=!0):L=!0:L=!0:L=!0:(L=!0,C.__version=a.version);let D=C.currentProgram;!0===L&&(D=e5(a,i,s));let U=!1,N=!1,O=!1,F=D.getUniforms(),B=C.uniforms;if(l.useProgram(D.program)&&(U=!0,N=!0,O=!0),a.id!==eg&&(eg=a.id,N=!0),U||ev!==e){l.buffers.depth.getReversed()&&!0!==e.reversedDepth&&(e._reversedDepth=!0,e.updateProjectionMatrix()),F.setValue(ek,"projectionMatrix",e.projectionMatrix),F.setValue(ek,"viewMatrix",e.matrixWorldInverse);let i=F.map.cameraPosition;void 0!==i&&i.setValue(ek,eN.setFromMatrixPosition(e.matrixWorld)),o.logarithmicDepthBuffer&&F.setValue(ek,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),(a.isMeshPhongMaterial||a.isMeshToonMaterial||a.isMeshLambertMaterial||a.isMeshBasicMaterial||a.isMeshStandardMaterial||a.isShaderMaterial)&&F.setValue(ek,"isOrthographic",!0===e.isOrthographicCamera),ev!==e&&(ev=e,N=!0,O=!0)}if(C.needsLights&&(I.state.directionalShadowMap.length>0&&F.setValue(ek,"directionalShadowMap",I.state.directionalShadowMap,u),I.state.spotShadowMap.length>0&&F.setValue(ek,"spotShadowMap",I.state.spotShadowMap,u),I.state.pointShadowMap.length>0&&F.setValue(ek,"pointShadowMap",I.state.pointShadowMap,u)),s.isSkinnedMesh){F.setOptional(ek,s,"bindMatrix"),F.setOptional(ek,s,"bindMatrixInverse");let e=s.skeleton;e&&(null===e.boneTexture&&e.computeBoneTexture(),F.setValue(ek,"boneTexture",e.boneTexture,u))}s.isBatchedMesh&&(F.setOptional(ek,s,"batchingTexture"),F.setValue(ek,"batchingTexture",s._matricesTexture,u),F.setOptional(ek,s,"batchingIdTexture"),F.setValue(ek,"batchingIdTexture",s._indirectTexture,u),F.setOptional(ek,s,"batchingColorTexture"),null!==s._colorsTexture&&F.setValue(ek,"batchingColorTexture",s._colorsTexture,u));let z=r.morphAttributes;if((void 0!==z.position||void 0!==z.normal||void 0!==z.color)&&P.update(s,r,D),(N||C.receiveShadow!==s.receiveShadow)&&(C.receiveShadow=s.receiveShadow,F.setValue(ek,"receiveShadow",s.receiveShadow)),a.isMeshGouraudMaterial&&null!==a.envMap&&(B.envMap.value=v,B.flipEnvMap.value=v.isCubeTexture&&!1===v.isRenderTargetTexture?-1:1),a.isMeshStandardMaterial&&null===a.envMap&&null!==i.environment&&(B.envMapIntensity.value=i.environmentIntensity),void 0!==B.dfgLUT&&(B.dfgLUT.value=(null===tk&&((tk=new n.GYF(tz,16,16,n.paN,n.ix0)).name="DFG_LUT",tk.minFilter=n.k6q,tk.magFilter=n.k6q,tk.wrapS=n.ghU,tk.wrapT=n.ghU,tk.generateMipmaps=!1,tk.needsUpdate=!0),tk)),N&&(F.setValue(ek,"toneMappingExposure",eu.toneMappingExposure),C.needsLights&&(c=B,p=O,c.ambientLightColor.needsUpdate=p,c.lightProbe.needsUpdate=p,c.directionalLights.needsUpdate=p,c.directionalLightShadows.needsUpdate=p,c.pointLights.needsUpdate=p,c.pointLightShadows.needsUpdate=p,c.spotLights.needsUpdate=p,c.spotLightShadows.needsUpdate=p,c.rectAreaLights.needsUpdate=p,c.hemisphereLights.needsUpdate=p),f&&!0===a.fog&&T.refreshFogUniforms(B,f),T.refreshMaterialUniforms(B,a,eE,eT,eo.state.transmissionRenderTarget[e.id]),eX.upload(ek,e6(C),B,u)),a.isShaderMaterial&&!0===a.uniformsNeedUpdate&&(eX.upload(ek,e6(C),B,u),a.uniformsNeedUpdate=!1),a.isSpriteMaterial&&F.setValue(ek,"center",s.center),F.setValue(ek,"modelViewMatrix",s.modelViewMatrix),F.setValue(ek,"normalMatrix",s.normalMatrix),F.setValue(ek,"modelMatrix",s.matrixWorld),a.isShaderMaterial||a.isRawShaderMaterial){let e=a.uniformsGroups;for(let i=0,r=e.length;i<r;i++){let r=e[i];G.update(r,D),G.bind(r,D)}}return D}(e,i,a,s,c);l.setMaterial(s,m);let v=a.index,_=1;if(!0===s.wireframe){if(void 0===(v=M.getWireframeAttribute(a)))return;_=2}let S=a.drawRange,b=a.attributes.position,E=S.start*_,w=(S.start+S.count)*_;null!==p&&(E=Math.max(E,p.start*_),w=Math.min(w,(p.start+p.count)*_)),null!==v?(E=Math.max(E,0),w=Math.min(w,v.count)):null!=b&&(E=Math.max(E,0),w=Math.min(w,b.count));let R=w-E;if(R<0||R===1/0)return;H.setup(c,s,g,a,v);let C=I;if(null!==v&&(f=x.get(v),(C=L).setIndex(f)),c.isMesh)!0===s.wireframe?(l.setLineWidth(s.wireframeLinewidth*ez()),C.setMode(ek.LINES)):C.setMode(ek.TRIANGLES);else if(c.isLine){let e=s.linewidth;void 0===e&&(e=1),l.setLineWidth(e*ez()),c.isLineSegments?C.setMode(ek.LINES):c.isLineLoop?C.setMode(ek.LINE_LOOP):C.setMode(ek.LINE_STRIP)}else c.isPoints?C.setMode(ek.POINTS):c.isSprite&&C.setMode(ek.TRIANGLES);if(c.isBatchedMesh)if(null!==c._multiDrawInstances)(0,n.mcG)("WebGLRenderer: renderMultiDrawInstances has been deprecated and will be removed in r184. Append to renderMultiDraw arguments and use indirection."),C.renderMultiDrawInstances(c._multiDrawStarts,c._multiDrawCounts,c._multiDrawCount,c._multiDrawInstances);else if(r.get("WEBGL_multi_draw"))C.renderMultiDraw(c._multiDrawStarts,c._multiDrawCounts,c._multiDrawCount);else{let e=c._multiDrawStarts,i=c._multiDrawCounts,r=c._multiDrawCount,n=v?x.get(v).bytesPerElement:1,a=h.get(s).currentProgram.getUniforms();for(let s=0;s<r;s++)a.setValue(ek,"_gl_DrawID",s),C.render(e[s]/n,i[s])}else if(c.isInstancedMesh)C.renderInstances(E,R,c.count);else if(a.isInstancedBufferGeometry){let e=void 0!==a._maxInstanceCount?a._maxInstanceCount:1/0,i=Math.min(a.instanceCount,e);C.renderInstances(E,R,i)}else C.render(E,R)},this.compile=function(e,i,r=null){null===r&&(r=e),(eo=w.get(r)).init(i),ec.push(eo),r.traverseVisible(function(e){e.isLight&&e.layers.test(i.layers)&&(eo.pushLight(e),e.castShadow&&eo.pushShadow(e))}),e!==r&&e.traverseVisible(function(e){e.isLight&&e.layers.test(i.layers)&&(eo.pushLight(e),e.castShadow&&eo.pushShadow(e))}),eo.setupLights();let n=new Set;return e.traverse(function(e){if(!(e.isMesh||e.isPoints||e.isLine||e.isSprite))return;let i=e.material;if(i)if(Array.isArray(i))for(let a=0;a<i.length;a++){let s=i[a];eK(s,r,e),n.add(s)}else eK(i,r,e),n.add(i)}),eo=ec.pop(),n},this.compileAsync=function(e,i,n=null){let a=this.compile(e,i,n);return new Promise(i=>{function n(){(a.forEach(function(e){h.get(e).currentProgram.isReady()&&a.delete(e)}),0===a.size)?i(e):setTimeout(n,10)}null!==r.get("KHR_parallel_shader_compile")?n():setTimeout(n,10)})};let eJ=null;function eZ(){e$.stop()}function eQ(){e$.start()}const e$=new a;function e0(e,i,r,n){if(!1===e.visible)return;if(e.layers.test(i.layers)){if(e.isGroup)r=e.renderOrder;else if(e.isLOD)!0===e.autoUpdate&&e.update(i);else if(e.isLight)eo.pushLight(e),e.castShadow&&eo.pushShadow(e);else if(e.isSprite){if(!e.frustumCulled||eI.intersectsSprite(e)){n&&eO.setFromMatrixPosition(e.matrixWorld).applyMatrix4(eU);let i=S.update(e),a=e.material;a.visible&&es.push(e,i,a,r,eO.z,null)}}else if((e.isMesh||e.isLine||e.isPoints)&&(!e.frustumCulled||eI.intersectsObject(e))){let i=S.update(e),a=e.material;if(n&&(void 0!==e.boundingSphere?(null===e.boundingSphere&&e.computeBoundingSphere(),eO.copy(e.boundingSphere.center)):(null===i.boundingSphere&&i.computeBoundingSphere(),eO.copy(i.boundingSphere.center)),eO.applyMatrix4(e.matrixWorld).applyMatrix4(eU)),Array.isArray(a)){let n=i.groups;for(let s=0,o=n.length;s<o;s++){let o=n[s],l=a[o.materialIndex];l&&l.visible&&es.push(e,i,l,r,eO.z,o)}}else a.visible&&es.push(e,i,a,r,eO.z,null)}}let a=e.children;for(let e=0,s=a.length;e<s;e++)e0(a[e],i,r,n)}function e1(e,i,r,n){let{opaque:a,transmissive:s,transparent:o}=e;eo.setupLightsView(r),!0===eL&&A.setGlobalState(eu.clippingPlanes,r),n&&l.viewport(e_.copy(n)),a.length>0&&e2(a,i,r),s.length>0&&e2(s,i,r),o.length>0&&e2(o,i,r),l.buffers.depth.setTest(!0),l.buffers.depth.setMask(!0),l.buffers.color.setMask(!0),l.setPolygonOffset(!1)}function e3(e,i,a,s){if(null!==(!0===a.isScene?a.overrideMaterial:null))return;if(void 0===eo.state.transmissionRenderTarget[s.id]){let e=r.has("EXT_color_buffer_half_float")||r.has("EXT_color_buffer_float");eo.state.transmissionRenderTarget[s.id]=new n.nWS(1,1,{generateMipmaps:!0,type:e?n.ix0:n.OUM,minFilter:n.$_I,samples:o.samples,stencilBuffer:q,resolveDepthBuffer:!1,resolveStencilBuffer:!1,colorSpace:n.ppV.workingColorSpace})}let l=eo.state.transmissionRenderTarget[s.id],c=s.viewport||e_;l.setSize(c.z*eu.transmissionResolutionScale,c.w*eu.transmissionResolutionScale);let h=eu.getRenderTarget(),d=eu.getActiveCubeFace(),p=eu.getActiveMipmapLevel();eu.setRenderTarget(l),eu.getClearColor(eM),(eS=eu.getClearAlpha())<1&&eu.setClearColor(0xffffff,.5),eu.clear(),eB&&C.render(a);let f=eu.toneMapping;eu.toneMapping=n.y_p;let m=s.viewport;if(void 0!==s.viewport&&(s.viewport=void 0),eo.setupLightsView(s),!0===eL&&A.setGlobalState(eu.clippingPlanes,s),e2(e,a,s),u.updateMultisampleRenderTarget(l),u.updateRenderTargetMipmap(l),!1===r.has("WEBGL_multisampled_render_to_texture")){let e=!1;for(let r=0,o=i.length;r<o;r++){let{object:o,geometry:l,material:c,group:h}=i[r];if(c.side===n.$EB&&o.layers.test(s.layers)){let i=c.side;c.side=n.hsX,c.needsUpdate=!0,e4(o,a,s,l,c,h),c.side=i,c.needsUpdate=!0,e=!0}}!0===e&&(u.updateMultisampleRenderTarget(l),u.updateRenderTargetMipmap(l))}eu.setRenderTarget(h,d,p),eu.setClearColor(eM,eS),void 0!==m&&(s.viewport=m),eu.toneMapping=f}function e2(e,i,r){let n=!0===i.isScene?i.overrideMaterial:null;for(let a=0,s=e.length;a<s;a++){let s=e[a],{object:o,geometry:l,group:c}=s,h=s.material;!0===h.allowOverride&&null!==n&&(h=n),o.layers.test(r.layers)&&e4(o,i,r,l,h,c)}}function e4(e,i,r,a,s,o){e.onBeforeRender(eu,i,r,a,s,o),e.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix),s.onBeforeRender(eu,i,r,a,e,o),!0===s.transparent&&s.side===n.$EB&&!1===s.forceSinglePass?(s.side=n.hsX,s.needsUpdate=!0,eu.renderBufferDirect(r,i,a,s,e,o),s.side=n.hB5,s.needsUpdate=!0,eu.renderBufferDirect(r,i,a,s,e,o),s.side=n.$EB):eu.renderBufferDirect(r,i,a,s,e,o),e.onAfterRender(eu,i,r,a,s,o)}function e5(e,i,r){var n;!0!==i.isScene&&(i=eF);let a=h.get(e),s=eo.state.lights,o=eo.state.shadowsArray,l=s.state.version,c=b.getParameters(e,s.state,o,i,r),u=b.getProgramCacheKey(c),p=a.programs;a.environment=e.isMeshStandardMaterial?i.environment:null,a.fog=i.fog,a.envMap=(e.isMeshStandardMaterial?y:d).get(e.envMap||a.environment),a.envMapRotation=null!==a.environment&&null===e.envMap?i.environmentRotation:e.envMapRotation,void 0===p&&(e.addEventListener("dispose",eY),a.programs=p=new Map);let f=p.get(u);if(void 0!==f){if(a.currentProgram===f&&a.lightsStateVersion===l)return e8(e,c),f}else c.uniforms=b.getUniforms(e),e.onBeforeCompile(c,eu),f=b.acquireProgram(c,u),p.set(u,f),a.uniforms=c.uniforms;let m=a.uniforms;return(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(m.clippingPlanes=A.uniform),e8(e,c),a.needsLights=(n=e).isMeshLambertMaterial||n.isMeshToonMaterial||n.isMeshPhongMaterial||n.isMeshStandardMaterial||n.isShadowMaterial||n.isShaderMaterial&&!0===n.lights,a.lightsStateVersion=l,a.needsLights&&(m.ambientLightColor.value=s.state.ambient,m.lightProbe.value=s.state.probe,m.directionalLights.value=s.state.directional,m.directionalLightShadows.value=s.state.directionalShadow,m.spotLights.value=s.state.spot,m.spotLightShadows.value=s.state.spotShadow,m.rectAreaLights.value=s.state.rectArea,m.ltc_1.value=s.state.rectAreaLTC1,m.ltc_2.value=s.state.rectAreaLTC2,m.pointLights.value=s.state.point,m.pointLightShadows.value=s.state.pointShadow,m.hemisphereLights.value=s.state.hemi,m.directionalShadowMap.value=s.state.directionalShadowMap,m.directionalShadowMatrix.value=s.state.directionalShadowMatrix,m.spotShadowMap.value=s.state.spotShadowMap,m.spotLightMatrix.value=s.state.spotLightMatrix,m.spotLightMap.value=s.state.spotLightMap,m.pointShadowMap.value=s.state.pointShadowMap,m.pointShadowMatrix.value=s.state.pointShadowMatrix),a.currentProgram=f,a.uniformsList=null,f}function e6(e){if(null===e.uniformsList){let i=e.currentProgram.getUniforms();e.uniformsList=eX.seqWithValue(i.seq,e.uniforms)}return e.uniformsList}function e8(e,i){let r=h.get(e);r.outputColorSpace=i.outputColorSpace,r.batching=i.batching,r.batchingColor=i.batchingColor,r.instancing=i.instancing,r.instancingColor=i.instancingColor,r.instancingMorph=i.instancingMorph,r.skinning=i.skinning,r.morphTargets=i.morphTargets,r.morphNormals=i.morphNormals,r.morphColors=i.morphColors,r.morphTargetsCount=i.morphTargetsCount,r.numClippingPlanes=i.numClippingPlanes,r.numIntersection=i.numClipIntersection,r.vertexAlphas=i.vertexAlphas,r.vertexTangents=i.vertexTangents,r.toneMapping=i.toneMapping}e$.setAnimationLoop(function(e){eJ&&eJ(e)}),"u">typeof self&&e$.setContext(self),this.setAnimationLoop=function(e){eJ=e,eG.setAnimationLoop(e),null===e?e$.stop():e$.start()},eG.addEventListener("sessionstart",eZ),eG.addEventListener("sessionend",eQ),this.render=function(e,i){if(void 0!==i&&!0!==i.isCamera)return void(0,n.z3S)("WebGLRenderer.render: camera is not an instance of THREE.Camera.");if(!0===ed)return;let r=!0===eG.enabled&&!0===eG.isPresenting,a=null!==eh&&(null===em||r)&&eh.begin(eu,em);if(!0===e.matrixWorldAutoUpdate&&e.updateMatrixWorld(),null===i.parent&&!0===i.matrixWorldAutoUpdate&&i.updateMatrixWorld(),!0===eG.enabled&&!0===eG.isPresenting&&(null===eh||!1===eh.isCompositing())&&(!0===eG.cameraAutoUpdate&&eG.updateCamera(i),i=eG.getCamera()),!0===e.isScene&&e.onBeforeRender(eu,e,i,em),(eo=w.get(e,ec.length)).init(i),ec.push(eo),eU.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),eI.setFromProjectionMatrix(eU,n.TdN,i.reversedDepth),eD=this.localClippingEnabled,eL=A.init(this.clippingPlanes,eD),(es=E.get(e,el.length)).init(),el.push(es),!0===eG.enabled&&!0===eG.isPresenting){let e=eu.xr.getDepthSensingMesh();null!==e&&e0(e,i,-1/0,eu.sortObjects)}e0(e,i,0,eu.sortObjects),es.finish(),!0===eu.sortObjects&&es.sort(ew,eA),(eB=!1===eG.enabled||!1===eG.isPresenting||!1===eG.hasDepthSensing())&&C.addToRenderList(es,e),this.info.render.frame++,!0===eL&&A.beginShadows();let s=eo.state.shadowsArray;if(R.render(s,e,i),!0===eL&&A.endShadows(),!0===this.info.autoReset&&this.info.reset(),!1===(a&&eh.hasRenderPass())){let r=es.opaque,n=es.transmissive;if(eo.setupLights(),i.isArrayCamera){let a=i.cameras;if(n.length>0)for(let i=0,s=a.length;i<s;i++)e3(r,n,e,a[i]);eB&&C.render(e);for(let i=0,r=a.length;i<r;i++){let r=a[i];e1(es,e,r,r.viewport)}}else n.length>0&&e3(r,n,e,i),eB&&C.render(e),e1(es,e,i)}null!==em&&0===ef&&(u.updateMultisampleRenderTarget(em),u.updateRenderTargetMipmap(em)),a&&eh.end(eu),!0===e.isScene&&e.onAfterRender(eu,e,i),H.resetDefaultState(),eg=-1,ev=null,ec.pop(),ec.length>0?(eo=ec[ec.length-1],!0===eL&&A.setGlobalState(eu.clippingPlanes,eo.state.camera)):eo=null,el.pop(),es=el.length>0?el[el.length-1]:null},this.getActiveCubeFace=function(){return ep},this.getActiveMipmapLevel=function(){return ef},this.getRenderTarget=function(){return em},this.setRenderTargetTextures=function(e,i,r){let n=h.get(e);n.__autoAllocateDepthBuffer=!1===e.resolveDepthBuffer,!1===n.__autoAllocateDepthBuffer&&(n.__useRenderToTexture=!1),h.get(e.texture).__webglTexture=i,h.get(e.depthTexture).__webglTexture=n.__autoAllocateDepthBuffer?void 0:r,n.__hasExternalTextures=!0},this.setRenderTargetFramebuffer=function(e,i){let r=h.get(e);r.__webglFramebuffer=i,r.__useDefaultFramebuffer=void 0===i};const e9=ek.createFramebuffer();this.setRenderTarget=function(e,i=0,r=0){em=e,ep=i,ef=r;let n=null,a=!1,s=!1;if(e){let o=h.get(e);if(void 0!==o.__useDefaultFramebuffer){l.bindFramebuffer(ek.FRAMEBUFFER,o.__webglFramebuffer),e_.copy(e.viewport),ey.copy(e.scissor),ex=e.scissorTest,l.viewport(e_),l.scissor(ey),l.setScissorTest(ex),eg=-1;return}if(void 0===o.__webglFramebuffer)u.setupRenderTarget(e);else if(o.__hasExternalTextures)u.rebindTextures(e,h.get(e.texture).__webglTexture,h.get(e.depthTexture).__webglTexture);else if(e.depthBuffer){let i=e.depthTexture;if(o.__boundDepthTexture!==i){if(null!==i&&h.has(i)&&(e.width!==i.image.width||e.height!==i.image.height))throw Error("WebGLRenderTarget: Attached DepthTexture is initialized to the incorrect size.");u.setupDepthRenderbuffer(e)}}let c=e.texture;(c.isData3DTexture||c.isDataArrayTexture||c.isCompressedArrayTexture)&&(s=!0);let d=h.get(e).__webglFramebuffer;e.isWebGLCubeRenderTarget?(n=Array.isArray(d[i])?d[i][r]:d[i],a=!0):n=e.samples>0&&!1===u.useMultisampledRTT(e)?h.get(e).__webglMultisampledFramebuffer:Array.isArray(d)?d[r]:d,e_.copy(e.viewport),ey.copy(e.scissor),ex=e.scissorTest}else e_.copy(eR).multiplyScalar(eE).floor(),ey.copy(eC).multiplyScalar(eE).floor(),ex=eP;if(0!==r&&(n=e9),l.bindFramebuffer(ek.FRAMEBUFFER,n)&&l.drawBuffers(e,n),l.viewport(e_),l.scissor(ey),l.setScissorTest(ex),a){let n=h.get(e.texture);ek.framebufferTexture2D(ek.FRAMEBUFFER,ek.COLOR_ATTACHMENT0,ek.TEXTURE_CUBE_MAP_POSITIVE_X+i,n.__webglTexture,r)}else if(s)for(let n=0;n<e.textures.length;n++){let a=h.get(e.textures[n]);ek.framebufferTextureLayer(ek.FRAMEBUFFER,ek.COLOR_ATTACHMENT0+n,a.__webglTexture,r,i)}else if(null!==e&&0!==r){let i=h.get(e.texture);ek.framebufferTexture2D(ek.FRAMEBUFFER,ek.COLOR_ATTACHMENT0,ek.TEXTURE_2D,i.__webglTexture,r)}eg=-1},this.readRenderTargetPixels=function(e,i,r,a,s,c,u,d=0){if(!(e&&e.isWebGLRenderTarget))return void(0,n.z3S)("WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let p=h.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==u&&(p=p[u]),p){l.bindFramebuffer(ek.FRAMEBUFFER,p);try{let l=e.textures[d],h=l.format,u=l.type;if(!o.textureFormatReadable(h))return void(0,n.z3S)("WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");if(!o.textureTypeReadable(u))return void(0,n.z3S)("WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");i>=0&&i<=e.width-a&&r>=0&&r<=e.height-s&&(e.textures.length>1&&ek.readBuffer(ek.COLOR_ATTACHMENT0+d),ek.readPixels(i,r,a,s,k.convert(h),k.convert(u),c))}finally{let e=null!==em?h.get(em).__webglFramebuffer:null;l.bindFramebuffer(ek.FRAMEBUFFER,e)}}},this.readRenderTargetPixelsAsync=async function(e,i,r,a,s,c,u,d=0){if(!(e&&e.isWebGLRenderTarget))throw Error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let p=h.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==u&&(p=p[u]),p)if(i>=0&&i<=e.width-a&&r>=0&&r<=e.height-s){l.bindFramebuffer(ek.FRAMEBUFFER,p);let u=e.textures[d],f=u.format,m=u.type;if(!o.textureFormatReadable(f))throw Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: renderTarget is not in RGBA or implementation defined format.");if(!o.textureTypeReadable(m))throw Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: renderTarget is not in UnsignedByteType or implementation defined type.");let g=ek.createBuffer();ek.bindBuffer(ek.PIXEL_PACK_BUFFER,g),ek.bufferData(ek.PIXEL_PACK_BUFFER,c.byteLength,ek.STREAM_READ),e.textures.length>1&&ek.readBuffer(ek.COLOR_ATTACHMENT0+d),ek.readPixels(i,r,a,s,k.convert(f),k.convert(m),0);let v=null!==em?h.get(em).__webglFramebuffer:null;l.bindFramebuffer(ek.FRAMEBUFFER,v);let _=ek.fenceSync(ek.SYNC_GPU_COMMANDS_COMPLETE,0);return ek.flush(),await (0,n.jej)(ek,_,4),ek.bindBuffer(ek.PIXEL_PACK_BUFFER,g),ek.getBufferSubData(ek.PIXEL_PACK_BUFFER,0,c),ek.deleteBuffer(g),ek.deleteSync(_),c}else throw Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: requested read bounds are out of range.")},this.copyFramebufferToTexture=function(e,i=null,r=0){let n=Math.pow(2,-r),a=Math.floor(e.image.width*n),s=Math.floor(e.image.height*n),o=null!==i?i.x:0,c=null!==i?i.y:0;u.setTexture2D(e,0),ek.copyTexSubImage2D(ek.TEXTURE_2D,r,0,0,o,c,a,s),l.unbindTexture()};const e7=ek.createFramebuffer(),te=ek.createFramebuffer();this.copyTextureToTexture=function(e,i,r=null,a=null,s=0,o=null){let c,d,p,f,m,g,v,_,y,x;null===o&&(0!==s?((0,n.mcG)("WebGLRenderer: copyTextureToTexture function signature has changed to support src and dst mipmap levels."),o=s,s=0):o=0);let M=e.isCompressedTexture?e.mipmaps[o]:e.image;if(null!==r)c=r.max.x-r.min.x,d=r.max.y-r.min.y,p=r.isBox3?r.max.z-r.min.z:1,f=r.min.x,m=r.min.y,g=r.isBox3?r.min.z:0;else{let i=Math.pow(2,-s);c=Math.floor(M.width*i),d=Math.floor(M.height*i),p=e.isDataArrayTexture?M.depth:e.isData3DTexture?Math.floor(M.depth*i):1,f=0,m=0,g=0}null!==a?(v=a.x,_=a.y,y=a.z):(v=0,_=0,y=0);let S=k.convert(i.format),b=k.convert(i.type);i.isData3DTexture?(u.setTexture3D(i,0),x=ek.TEXTURE_3D):i.isDataArrayTexture||i.isCompressedArrayTexture?(u.setTexture2DArray(i,0),x=ek.TEXTURE_2D_ARRAY):(u.setTexture2D(i,0),x=ek.TEXTURE_2D),ek.pixelStorei(ek.UNPACK_FLIP_Y_WEBGL,i.flipY),ek.pixelStorei(ek.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i.premultiplyAlpha),ek.pixelStorei(ek.UNPACK_ALIGNMENT,i.unpackAlignment);let T=ek.getParameter(ek.UNPACK_ROW_LENGTH),E=ek.getParameter(ek.UNPACK_IMAGE_HEIGHT),w=ek.getParameter(ek.UNPACK_SKIP_PIXELS),A=ek.getParameter(ek.UNPACK_SKIP_ROWS),R=ek.getParameter(ek.UNPACK_SKIP_IMAGES);ek.pixelStorei(ek.UNPACK_ROW_LENGTH,M.width),ek.pixelStorei(ek.UNPACK_IMAGE_HEIGHT,M.height),ek.pixelStorei(ek.UNPACK_SKIP_PIXELS,f),ek.pixelStorei(ek.UNPACK_SKIP_ROWS,m),ek.pixelStorei(ek.UNPACK_SKIP_IMAGES,g);let C=e.isDataArrayTexture||e.isData3DTexture,P=i.isDataArrayTexture||i.isData3DTexture;if(e.isDepthTexture){let r=h.get(e),n=h.get(i),a=h.get(r.__renderTarget),u=h.get(n.__renderTarget);l.bindFramebuffer(ek.READ_FRAMEBUFFER,a.__webglFramebuffer),l.bindFramebuffer(ek.DRAW_FRAMEBUFFER,u.__webglFramebuffer);for(let r=0;r<p;r++)C&&(ek.framebufferTextureLayer(ek.READ_FRAMEBUFFER,ek.COLOR_ATTACHMENT0,h.get(e).__webglTexture,s,g+r),ek.framebufferTextureLayer(ek.DRAW_FRAMEBUFFER,ek.COLOR_ATTACHMENT0,h.get(i).__webglTexture,o,y+r)),ek.blitFramebuffer(f,m,c,d,v,_,c,d,ek.DEPTH_BUFFER_BIT,ek.NEAREST);l.bindFramebuffer(ek.READ_FRAMEBUFFER,null),l.bindFramebuffer(ek.DRAW_FRAMEBUFFER,null)}else if(0!==s||e.isRenderTargetTexture||h.has(e)){let r=h.get(e),n=h.get(i);l.bindFramebuffer(ek.READ_FRAMEBUFFER,e7),l.bindFramebuffer(ek.DRAW_FRAMEBUFFER,te);for(let e=0;e<p;e++)C?ek.framebufferTextureLayer(ek.READ_FRAMEBUFFER,ek.COLOR_ATTACHMENT0,r.__webglTexture,s,g+e):ek.framebufferTexture2D(ek.READ_FRAMEBUFFER,ek.COLOR_ATTACHMENT0,ek.TEXTURE_2D,r.__webglTexture,s),P?ek.framebufferTextureLayer(ek.DRAW_FRAMEBUFFER,ek.COLOR_ATTACHMENT0,n.__webglTexture,o,y+e):ek.framebufferTexture2D(ek.DRAW_FRAMEBUFFER,ek.COLOR_ATTACHMENT0,ek.TEXTURE_2D,n.__webglTexture,o),0!==s?ek.blitFramebuffer(f,m,c,d,v,_,c,d,ek.COLOR_BUFFER_BIT,ek.NEAREST):P?ek.copyTexSubImage3D(x,o,v,_,y+e,f,m,c,d):ek.copyTexSubImage2D(x,o,v,_,f,m,c,d);l.bindFramebuffer(ek.READ_FRAMEBUFFER,null),l.bindFramebuffer(ek.DRAW_FRAMEBUFFER,null)}else P?e.isDataTexture||e.isData3DTexture?ek.texSubImage3D(x,o,v,_,y,c,d,p,S,b,M.data):i.isCompressedArrayTexture?ek.compressedTexSubImage3D(x,o,v,_,y,c,d,p,S,M.data):ek.texSubImage3D(x,o,v,_,y,c,d,p,S,b,M):e.isDataTexture?ek.texSubImage2D(ek.TEXTURE_2D,o,v,_,c,d,S,b,M.data):e.isCompressedTexture?ek.compressedTexSubImage2D(ek.TEXTURE_2D,o,v,_,M.width,M.height,S,M.data):ek.texSubImage2D(ek.TEXTURE_2D,o,v,_,c,d,S,b,M);ek.pixelStorei(ek.UNPACK_ROW_LENGTH,T),ek.pixelStorei(ek.UNPACK_IMAGE_HEIGHT,E),ek.pixelStorei(ek.UNPACK_SKIP_PIXELS,w),ek.pixelStorei(ek.UNPACK_SKIP_ROWS,A),ek.pixelStorei(ek.UNPACK_SKIP_IMAGES,R),0===o&&i.generateMipmaps&&ek.generateMipmap(x),l.unbindTexture()},this.initRenderTarget=function(e){void 0===h.get(e).__webglFramebuffer&&u.setupRenderTarget(e)},this.initTexture=function(e){e.isCubeTexture?u.setTextureCube(e,0):e.isData3DTexture?u.setTexture3D(e,0):e.isDataArrayTexture||e.isCompressedArrayTexture?u.setTexture2DArray(e,0):u.setTexture2D(e,0),l.unbindTexture()},this.resetState=function(){ep=0,ef=0,em=null,l.reset(),H.reset()},"u">typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}get coordinateSystem(){return n.TdN}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(e){this._outputColorSpace=e;let i=this.getContext();i.drawingBufferColorSpace=n.ppV._getDrawingBufferColorSpace(e),i.unpackColorSpace=n.ppV._getUnpackColorSpace()}}}},s={};function o(e){var i=s[e];if(void 0!==i)return i.exports;var r=s[e]={id:e,loaded:!1,exports:{}};return a[e].call(r.exports,r,r.exports,o),r.loaded=!0,r.exports}o.m=a,e=[],o.O=(i,r,n,a)=>{if(r){a=a||0;for(var s=e.length;s>0&&e[s-1][2]>a;s--)e[s]=e[s-1];e[s]=[r,n,a];return}for(var l=1/0,s=0;s<e.length;s++){for(var[r,n,a]=e[s],c=!0,h=0;h<r.length;h++)(!1&a||l>=a)&&Object.keys(o.O).every(e=>o.O[e](r[h]))?r.splice(h--,1):(c=!1,a<l&&(l=a));if(c){e.splice(s--,1);var u=n();void 0!==u&&(i=u)}}return i},o.n=e=>{var i=e&&e.__esModule?()=>e.default:()=>e;return o.d(i,{a:i}),i},o.d=(e,i)=>{for(var r in i)o.o(i,r)&&!o.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:i[r]})},o.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||Function("return this")()}catch(e){if("object"==typeof window)return window}}(),o.o=(e,i)=>Object.prototype.hasOwnProperty.call(e,i),o.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),i={121:0},o.O.j=e=>0===i[e],r=(e,r)=>{var n,a,[s,l,c]=r,h=0;if(s.some(e=>0!==i[e])){for(n in l)o.o(l,n)&&(o.m[n]=l[n]);if(c)var u=c(o)}for(e&&e(r);h<s.length;h++)a=s[h],o.o(i,a)&&i[a]&&i[a][0](),i[a]=0;return o.O(u)},(n=self.webpackChunkbilliards=self.webpackChunkbilliards||[]).forEach(r.bind(null,0)),n.push=r.bind(null,n.push.bind(n)),o("./node_modules/cross-fetch/dist/browser-ponyfill.js"),o("./node_modules/interactjs/dist/interact.min.js"),o("./node_modules/jsoncrush/JSONCrush.js");var l=o("./node_modules/three/build/three.module.js");l=o.O(l)})();
\ No newline at end of file
+}`;class tD{constructor(){this.texture=null,this.mesh=null,this.depthNear=0,this.depthFar=0}init(e,i){if(null===this.texture){let r=new n.rjZ(e.texture);(e.depthNear!==i.depthNear||e.depthFar!==i.depthFar)&&(this.depthNear=e.depthNear,this.depthFar=e.depthFar),this.texture=r}}getMesh(e){if(null!==this.texture&&null===this.mesh){let i=e.cameras[0].viewport,r=new n.BKk({vertexShader:tI,fragmentShader:tL,uniforms:{depthColor:{value:this.texture},depthWidth:{value:i.z},depthHeight:{value:i.w}}});this.mesh=new n.eaF(new n.bdM(20,20),r)}return this.mesh}reset(){this.texture=null,this.mesh=null}getDepthTexture(){return this.texture}}class tU extends n.Qev{constructor(e,i){super();const r=this;let s=null,o=1,l=null,c="local-floor",h=1,u=null,d=null,p=null,f=null,m=null,g=null;const v="u">typeof XRWebGLBinding,_=new tD,x={},y=i.getContextAttributes();let M=null,S=null;const b=[],T=[],E=new n.I9Y;let w=null;const A=new n.ubm;A.viewport=new n.IUQ;const R=new n.ubm;R.viewport=new n.IUQ;const C=[A,R],P=new n.nZQ;let I=null,L=null;function D(e){let i=T.indexOf(e.inputSource);if(-1===i)return;let r=b[i];void 0!==r&&(r.update(e.inputSource,e.frame,u||l),r.dispatchEvent({type:e.type,data:e.inputSource}))}function U(){s.removeEventListener("select",D),s.removeEventListener("selectstart",D),s.removeEventListener("selectend",D),s.removeEventListener("squeeze",D),s.removeEventListener("squeezestart",D),s.removeEventListener("squeezeend",D),s.removeEventListener("end",U),s.removeEventListener("inputsourceschange",N);for(let e=0;e<b.length;e++){let i=T[e];null!==i&&(T[e]=null,b[e].disconnect(i))}for(let e in I=null,L=null,_.reset(),x)delete x[e];e.setRenderTarget(M),m=null,f=null,p=null,s=null,S=null,k.stop(),r.isPresenting=!1,e.setPixelRatio(w),e.setSize(E.width,E.height,!1),r.dispatchEvent({type:"sessionend"})}function N(e){for(let i=0;i<e.removed.length;i++){let r=e.removed[i],n=T.indexOf(r);n>=0&&(T[n]=null,b[n].disconnect(r))}for(let i=0;i<e.added.length;i++){let r=e.added[i],n=T.indexOf(r);if(-1===n){for(let e=0;e<b.length;e++)if(e>=T.length){T.push(r),n=e;break}else if(null===T[e]){T[e]=r,n=e;break}if(-1===n)break}let a=b[n];a&&a.connect(r)}}this.cameraAutoUpdate=!0,this.enabled=!1,this.isPresenting=!1,this.getController=function(e){let i=b[e];return void 0===i&&(i=new n.R3r,b[e]=i),i.getTargetRaySpace()},this.getControllerGrip=function(e){let i=b[e];return void 0===i&&(i=new n.R3r,b[e]=i),i.getGripSpace()},this.getHand=function(e){let i=b[e];return void 0===i&&(i=new n.R3r,b[e]=i),i.getHandSpace()},this.setFramebufferScaleFactor=function(e){o=e,!0===r.isPresenting&&(0,n.R8M)("WebXRManager: Cannot change framebuffer scale while presenting.")},this.setReferenceSpaceType=function(e){c=e,!0===r.isPresenting&&(0,n.R8M)("WebXRManager: Cannot change reference space type while presenting.")},this.getReferenceSpace=function(){return u||l},this.setReferenceSpace=function(e){u=e},this.getBaseLayer=function(){return null!==f?f:m},this.getBinding=function(){return null===p&&v&&(p=new XRWebGLBinding(s,i)),p},this.getFrame=function(){return g},this.getSession=function(){return s},this.setSession=async function(a){if(null!==(s=a)){if(M=e.getRenderTarget(),s.addEventListener("select",D),s.addEventListener("selectstart",D),s.addEventListener("selectend",D),s.addEventListener("squeeze",D),s.addEventListener("squeezestart",D),s.addEventListener("squeezeend",D),s.addEventListener("end",U),s.addEventListener("inputsourceschange",N),!0!==y.xrCompatible&&await i.makeXRCompatible(),w=e.getPixelRatio(),e.getSize(E),v&&"createProjectionLayer"in XRWebGLBinding.prototype){let r=null,a=null,l=null;y.depth&&(l=y.stencil?i.DEPTH24_STENCIL8:i.DEPTH_COMPONENT24,r=y.stencil?n.dcC:n.zdS,a=y.stencil?n.V3x:n.bkx);let c={colorFormat:i.RGBA8,depthFormat:l,scaleFactor:o};f=(p=this.getBinding()).createProjectionLayer(c),s.updateRenderState({layers:[f]}),e.setPixelRatio(1),e.setSize(f.textureWidth,f.textureHeight,!1),S=new n.nWS(f.textureWidth,f.textureHeight,{format:n.GWd,type:n.OUM,depthTexture:new n.VCu(f.textureWidth,f.textureHeight,a,void 0,void 0,void 0,void 0,void 0,void 0,r),stencilBuffer:y.stencil,colorSpace:e.outputColorSpace,samples:4*!!y.antialias,resolveDepthBuffer:!1===f.ignoreDepthValues,resolveStencilBuffer:!1===f.ignoreDepthValues})}else{let r={antialias:y.antialias,alpha:!0,depth:y.depth,stencil:y.stencil,framebufferScaleFactor:o};m=new XRWebGLLayer(s,i,r),s.updateRenderState({baseLayer:m}),e.setPixelRatio(1),e.setSize(m.framebufferWidth,m.framebufferHeight,!1),S=new n.nWS(m.framebufferWidth,m.framebufferHeight,{format:n.GWd,type:n.OUM,colorSpace:e.outputColorSpace,stencilBuffer:y.stencil,resolveDepthBuffer:!1===m.ignoreDepthValues,resolveStencilBuffer:!1===m.ignoreDepthValues})}S.isXRRenderTarget=!0,this.setFoveation(h),u=null,l=await s.requestReferenceSpace(c),k.setContext(s),k.start(),r.isPresenting=!0,r.dispatchEvent({type:"sessionstart"})}},this.getEnvironmentBlendMode=function(){if(null!==s)return s.environmentBlendMode},this.getDepthTexture=function(){return _.getDepthTexture()};const O=new n.Pq0,F=new n.Pq0;function B(e,i){null===i?e.matrixWorld.copy(e.matrix):e.matrixWorld.multiplyMatrices(i.matrixWorld,e.matrix),e.matrixWorldInverse.copy(e.matrixWorld).invert()}this.updateCamera=function(e){var i,r,a;if(null===s)return;let o=e.near,l=e.far;null!==_.texture&&(_.depthNear>0&&(o=_.depthNear),_.depthFar>0&&(l=_.depthFar)),P.near=R.near=A.near=o,P.far=R.far=A.far=l,(I!==P.near||L!==P.far)&&(s.updateRenderState({depthNear:P.near,depthFar:P.far}),I=P.near,L=P.far),P.layers.mask=6|e.layers.mask,A.layers.mask=3&P.layers.mask,R.layers.mask=5&P.layers.mask;let c=e.parent,h=P.cameras;B(P,c);for(let e=0;e<h.length;e++)B(h[e],c);2===h.length?function(e,i,r){O.setFromMatrixPosition(i.matrixWorld),F.setFromMatrixPosition(r.matrixWorld);let n=O.distanceTo(F),a=i.projectionMatrix.elements,s=r.projectionMatrix.elements,o=a[14]/(a[10]-1),l=a[14]/(a[10]+1),c=(a[9]+1)/a[5],h=(a[9]-1)/a[5],u=(a[8]-1)/a[0],d=(s[8]+1)/s[0],p=n/(-u+d),f=-(p*u);if(i.matrixWorld.decompose(e.position,e.quaternion,e.scale),e.translateX(f),e.translateZ(p),e.matrixWorld.compose(e.position,e.quaternion,e.scale),e.matrixWorldInverse.copy(e.matrixWorld).invert(),-1===a[10])e.projectionMatrix.copy(i.projectionMatrix),e.projectionMatrixInverse.copy(i.projectionMatrixInverse);else{let i=o+p,r=l+p;e.projectionMatrix.makePerspective(o*u-f,o*d+(n-f),c*l/r*i,h*l/r*i,i,r),e.projectionMatrixInverse.copy(e.projectionMatrix).invert()}}(P,A,R):P.projectionMatrix.copy(A.projectionMatrix),i=e,r=P,null===(a=c)?i.matrix.copy(r.matrixWorld):(i.matrix.copy(a.matrixWorld),i.matrix.invert(),i.matrix.multiply(r.matrixWorld)),i.matrix.decompose(i.position,i.quaternion,i.scale),i.updateMatrixWorld(!0),i.projectionMatrix.copy(r.projectionMatrix),i.projectionMatrixInverse.copy(r.projectionMatrixInverse),i.isPerspectiveCamera&&(i.fov=2*n.a55*Math.atan(1/i.projectionMatrix.elements[5]),i.zoom=1)},this.getCamera=function(){return P},this.getFoveation=function(){if(null!==f||null!==m)return h},this.setFoveation=function(e){h=e,null!==f&&(f.fixedFoveation=e),null!==m&&void 0!==m.fixedFoveation&&(m.fixedFoveation=e)},this.hasDepthSensing=function(){return null!==_.texture},this.getDepthSensingMesh=function(){return _.getMesh(P)},this.getCameraTexture=function(e){return x[e]};let z=null;const k=new a;k.setAnimationLoop(function(i,a){if(d=a.getViewerPose(u||l),g=a,null!==d){let i=d.views;null!==m&&(e.setRenderTargetFramebuffer(S,m.framebuffer),e.setRenderTarget(S));let a=!1;i.length!==P.cameras.length&&(P.cameras.length=0,a=!0);for(let r=0;r<i.length;r++){let s=i[r],o=null;if(null!==m)o=m.getViewport(s);else{let i=p.getViewSubImage(f,s);o=i.viewport,0===r&&(e.setRenderTargetTextures(S,i.colorTexture,i.depthStencilTexture),e.setRenderTarget(S))}let l=C[r];void 0===l&&((l=new n.ubm).layers.enable(r),l.viewport=new n.IUQ,C[r]=l),l.matrix.fromArray(s.transform.matrix),l.matrix.decompose(l.position,l.quaternion,l.scale),l.projectionMatrix.fromArray(s.projectionMatrix),l.projectionMatrixInverse.copy(l.projectionMatrix).invert(),l.viewport.set(o.x,o.y,o.width,o.height),0===r&&(P.matrix.copy(l.matrix),P.matrix.decompose(P.position,P.quaternion,P.scale)),!0===a&&P.cameras.push(l)}let o=s.enabledFeatures;if(o&&o.includes("depth-sensing")&&"gpu-optimized"==s.depthUsage&&v){let e=(p=r.getBinding()).getDepthInformation(i[0]);e&&e.isValid&&e.texture&&_.init(e,s.renderState)}if(o&&o.includes("camera-access")&&v){e.state.unbindTexture(),p=r.getBinding();for(let e=0;e<i.length;e++){let r=i[e].camera;if(r){let e=x[r];e||(e=new n.rjZ,x[r]=e);let i=p.getCameraImage(r);e.sourceTexture=i}}}}for(let e=0;e<b.length;e++){let i=T[e],r=b[e];null!==i&&void 0!==r&&r.update(i,a,u||l)}z&&z(i,a),a.detectedPlanes&&r.dispatchEvent({type:"planesdetected",data:a}),g=null}),this.setAnimationLoop=function(e){z=e},this.dispose=function(){}}}let tN=new n.O9p,tO=new n.kn4;function tF(e,i){function r(e,i){!0===e.matrixAutoUpdate&&e.updateMatrix(),i.value.copy(e.matrix)}function a(e,a){e.opacity.value=a.opacity,a.color&&e.diffuse.value.copy(a.color),a.emissive&&e.emissive.value.copy(a.emissive).multiplyScalar(a.emissiveIntensity),a.map&&(e.map.value=a.map,r(a.map,e.mapTransform)),a.alphaMap&&(e.alphaMap.value=a.alphaMap,r(a.alphaMap,e.alphaMapTransform)),a.bumpMap&&(e.bumpMap.value=a.bumpMap,r(a.bumpMap,e.bumpMapTransform),e.bumpScale.value=a.bumpScale,a.side===n.hsX&&(e.bumpScale.value*=-1)),a.normalMap&&(e.normalMap.value=a.normalMap,r(a.normalMap,e.normalMapTransform),e.normalScale.value.copy(a.normalScale),a.side===n.hsX&&e.normalScale.value.negate()),a.displacementMap&&(e.displacementMap.value=a.displacementMap,r(a.displacementMap,e.displacementMapTransform),e.displacementScale.value=a.displacementScale,e.displacementBias.value=a.displacementBias),a.emissiveMap&&(e.emissiveMap.value=a.emissiveMap,r(a.emissiveMap,e.emissiveMapTransform)),a.specularMap&&(e.specularMap.value=a.specularMap,r(a.specularMap,e.specularMapTransform)),a.alphaTest>0&&(e.alphaTest.value=a.alphaTest);let s=i.get(a),o=s.envMap,l=s.envMapRotation;o&&(e.envMap.value=o,tN.copy(l),tN.x*=-1,tN.y*=-1,tN.z*=-1,o.isCubeTexture&&!1===o.isRenderTargetTexture&&(tN.y*=-1,tN.z*=-1),e.envMapRotation.value.setFromMatrix4(tO.makeRotationFromEuler(tN)),e.flipEnvMap.value=o.isCubeTexture&&!1===o.isRenderTargetTexture?-1:1,e.reflectivity.value=a.reflectivity,e.ior.value=a.ior,e.refractionRatio.value=a.refractionRatio),a.lightMap&&(e.lightMap.value=a.lightMap,e.lightMapIntensity.value=a.lightMapIntensity,r(a.lightMap,e.lightMapTransform)),a.aoMap&&(e.aoMap.value=a.aoMap,e.aoMapIntensity.value=a.aoMapIntensity,r(a.aoMap,e.aoMapTransform))}return{refreshFogUniforms:function(i,r){r.color.getRGB(i.fogColor.value,(0,n._Ut)(e)),r.isFog?(i.fogNear.value=r.near,i.fogFar.value=r.far):r.isFogExp2&&(i.fogDensity.value=r.density)},refreshMaterialUniforms:function(e,s,o,l,c){var h,u,d,p,f,m,g,v,_,x,y,M,S,b,T,E,w,A,R,C,P,I,L;let D;s.isMeshBasicMaterial||s.isMeshLambertMaterial?a(e,s):s.isMeshToonMaterial?(a(e,s),h=e,(u=s).gradientMap&&(h.gradientMap.value=u.gradientMap)):s.isMeshPhongMaterial?(a(e,s),d=e,p=s,d.specular.value.copy(p.specular),d.shininess.value=Math.max(p.shininess,1e-4)):s.isMeshStandardMaterial?(a(e,s),f=e,m=s,f.metalness.value=m.metalness,m.metalnessMap&&(f.metalnessMap.value=m.metalnessMap,r(m.metalnessMap,f.metalnessMapTransform)),f.roughness.value=m.roughness,m.roughnessMap&&(f.roughnessMap.value=m.roughnessMap,r(m.roughnessMap,f.roughnessMapTransform)),m.envMap&&(f.envMapIntensity.value=m.envMapIntensity),s.isMeshPhysicalMaterial&&(g=e,v=s,_=c,g.ior.value=v.ior,v.sheen>0&&(g.sheenColor.value.copy(v.sheenColor).multiplyScalar(v.sheen),g.sheenRoughness.value=v.sheenRoughness,v.sheenColorMap&&(g.sheenColorMap.value=v.sheenColorMap,r(v.sheenColorMap,g.sheenColorMapTransform)),v.sheenRoughnessMap&&(g.sheenRoughnessMap.value=v.sheenRoughnessMap,r(v.sheenRoughnessMap,g.sheenRoughnessMapTransform))),v.clearcoat>0&&(g.clearcoat.value=v.clearcoat,g.clearcoatRoughness.value=v.clearcoatRoughness,v.clearcoatMap&&(g.clearcoatMap.value=v.clearcoatMap,r(v.clearcoatMap,g.clearcoatMapTransform)),v.clearcoatRoughnessMap&&(g.clearcoatRoughnessMap.value=v.clearcoatRoughnessMap,r(v.clearcoatRoughnessMap,g.clearcoatRoughnessMapTransform)),v.clearcoatNormalMap&&(g.clearcoatNormalMap.value=v.clearcoatNormalMap,r(v.clearcoatNormalMap,g.clearcoatNormalMapTransform),g.clearcoatNormalScale.value.copy(v.clearcoatNormalScale),v.side===n.hsX&&g.clearcoatNormalScale.value.negate())),v.dispersion>0&&(g.dispersion.value=v.dispersion),v.iridescence>0&&(g.iridescence.value=v.iridescence,g.iridescenceIOR.value=v.iridescenceIOR,g.iridescenceThicknessMinimum.value=v.iridescenceThicknessRange[0],g.iridescenceThicknessMaximum.value=v.iridescenceThicknessRange[1],v.iridescenceMap&&(g.iridescenceMap.value=v.iridescenceMap,r(v.iridescenceMap,g.iridescenceMapTransform)),v.iridescenceThicknessMap&&(g.iridescenceThicknessMap.value=v.iridescenceThicknessMap,r(v.iridescenceThicknessMap,g.iridescenceThicknessMapTransform))),v.transmission>0&&(g.transmission.value=v.transmission,g.transmissionSamplerMap.value=_.texture,g.transmissionSamplerSize.value.set(_.width,_.height),v.transmissionMap&&(g.transmissionMap.value=v.transmissionMap,r(v.transmissionMap,g.transmissionMapTransform)),g.thickness.value=v.thickness,v.thicknessMap&&(g.thicknessMap.value=v.thicknessMap,r(v.thicknessMap,g.thicknessMapTransform)),g.attenuationDistance.value=v.attenuationDistance,g.attenuationColor.value.copy(v.attenuationColor)),v.anisotropy>0&&(g.anisotropyVector.value.set(v.anisotropy*Math.cos(v.anisotropyRotation),v.anisotropy*Math.sin(v.anisotropyRotation)),v.anisotropyMap&&(g.anisotropyMap.value=v.anisotropyMap,r(v.anisotropyMap,g.anisotropyMapTransform))),g.specularIntensity.value=v.specularIntensity,g.specularColor.value.copy(v.specularColor),v.specularColorMap&&(g.specularColorMap.value=v.specularColorMap,r(v.specularColorMap,g.specularColorMapTransform)),v.specularIntensityMap&&(g.specularIntensityMap.value=v.specularIntensityMap,r(v.specularIntensityMap,g.specularIntensityMapTransform)))):s.isMeshMatcapMaterial?(a(e,s),x=e,(y=s).matcap&&(x.matcap.value=y.matcap)):s.isMeshDepthMaterial?a(e,s):s.isMeshDistanceMaterial?(a(e,s),M=e,S=s,D=i.get(S).light,M.referencePosition.value.setFromMatrixPosition(D.matrixWorld),M.nearDistance.value=D.shadow.camera.near,M.farDistance.value=D.shadow.camera.far):s.isMeshNormalMaterial?a(e,s):s.isLineBasicMaterial?(b=e,T=s,b.diffuse.value.copy(T.color),b.opacity.value=T.opacity,T.map&&(b.map.value=T.map,r(T.map,b.mapTransform)),s.isLineDashedMaterial&&(E=e,w=s,E.dashSize.value=w.dashSize,E.totalSize.value=w.dashSize+w.gapSize,E.scale.value=w.scale)):s.isPointsMaterial?(A=e,R=s,C=o,P=l,A.diffuse.value.copy(R.color),A.opacity.value=R.opacity,A.size.value=R.size*C,A.scale.value=.5*P,R.map&&(A.map.value=R.map,r(R.map,A.uvTransform)),R.alphaMap&&(A.alphaMap.value=R.alphaMap,r(R.alphaMap,A.alphaMapTransform)),R.alphaTest>0&&(A.alphaTest.value=R.alphaTest)):s.isSpriteMaterial?(I=e,L=s,I.diffuse.value.copy(L.color),I.opacity.value=L.opacity,I.rotation.value=L.rotation,L.map&&(I.map.value=L.map,r(L.map,I.mapTransform)),L.alphaMap&&(I.alphaMap.value=L.alphaMap,r(L.alphaMap,I.alphaMapTransform)),L.alphaTest>0&&(I.alphaTest.value=L.alphaTest)):s.isShadowMaterial?(e.color.value.copy(s.color),e.opacity.value=s.opacity):s.isShaderMaterial&&(s.uniformsNeedUpdate=!1)}}}function tB(e,i,r,a){let s={},o={},l=[],c=e.getParameter(e.MAX_UNIFORM_BUFFER_BINDINGS);function h(e){let i={boundary:0,storage:0};return"number"==typeof e||"boolean"==typeof e?(i.boundary=4,i.storage=4):e.isVector2?(i.boundary=8,i.storage=8):e.isVector3||e.isColor?(i.boundary=16,i.storage=12):e.isVector4?(i.boundary=16,i.storage=16):e.isMatrix3?(i.boundary=48,i.storage=48):e.isMatrix4?(i.boundary=64,i.storage=64):e.isTexture?(0,n.R8M)("WebGLRenderer: Texture samplers can not be part of an uniforms group."):(0,n.R8M)("WebGLRenderer: Unsupported uniform value type.",e),i}function u(i){let r=i.target;r.removeEventListener("dispose",u);let n=l.indexOf(r.__bindingPointIndex);l.splice(n,1),e.deleteBuffer(s[r.id]),delete s[r.id],delete o[r.id]}return{bind:function(e,i){let r=i.program;a.uniformBlockBinding(e,r)},update:function(r,d){var p;let f,m,g,v,_=s[r.id];void 0===_&&(function(e){let i=e.uniforms,r=0;for(let e=0,n=i.length;e<n;e++){let n=Array.isArray(i[e])?i[e]:[i[e]];for(let e=0,i=n.length;e<i;e++){let i=n[e],a=Array.isArray(i.value)?i.value:[i.value];for(let e=0,n=a.length;e<n;e++){let n=h(a[e]),s=r%16,o=s%n.boundary,l=s+o;r+=o,0!==l&&16-l<n.storage&&(r+=16-l),i.__data=new Float32Array(n.storage/Float32Array.BYTES_PER_ELEMENT),i.__offset=r,r+=n.storage}}}let n=r%16;n>0&&(r+=16-n),e.__size=r,e.__cache={}}(r),(p=r).__bindingPointIndex=f=function(){for(let e=0;e<c;e++)if(-1===l.indexOf(e))return l.push(e),e;return(0,n.z3S)("WebGLRenderer: Maximum number of simultaneously usable uniforms groups reached."),0}(),m=e.createBuffer(),g=p.__size,v=p.usage,e.bindBuffer(e.UNIFORM_BUFFER,m),e.bufferData(e.UNIFORM_BUFFER,g,v),e.bindBuffer(e.UNIFORM_BUFFER,null),e.bindBufferBase(e.UNIFORM_BUFFER,f,m),_=m,s[r.id]=_,r.addEventListener("dispose",u));let x=d.program;a.updateUBOMapping(r,x);let y=i.render.frame;o[r.id]!==y&&(function(i){let r=s[i.id],n=i.uniforms,a=i.__cache;e.bindBuffer(e.UNIFORM_BUFFER,r);for(let i=0,r=n.length;i<r;i++){let r=Array.isArray(n[i])?n[i]:[n[i]];for(let n=0,s=r.length;n<s;n++){let s=r[n];if(!0===function(e,i,r,n){let a=e.value,s=i+"_"+r;if(void 0===n[s])return"number"==typeof a||"boolean"==typeof a?n[s]=a:n[s]=a.clone(),!0;{let e=n[s];if("number"==typeof a||"boolean"==typeof a){if(e!==a)return n[s]=a,!0}else if(!1===e.equals(a))return e.copy(a),!0}return!1}(s,i,n,a)){let i=s.__offset,r=Array.isArray(s.value)?s.value:[s.value],n=0;for(let a=0;a<r.length;a++){let o=r[a],l=h(o);"number"==typeof o||"boolean"==typeof o?(s.__data[0]=o,e.bufferSubData(e.UNIFORM_BUFFER,i+n,s.__data)):o.isMatrix3?(s.__data[0]=o.elements[0],s.__data[1]=o.elements[1],s.__data[2]=o.elements[2],s.__data[3]=0,s.__data[4]=o.elements[3],s.__data[5]=o.elements[4],s.__data[6]=o.elements[5],s.__data[7]=0,s.__data[8]=o.elements[6],s.__data[9]=o.elements[7],s.__data[10]=o.elements[8],s.__data[11]=0):(o.toArray(s.__data,n),n+=l.storage/Float32Array.BYTES_PER_ELEMENT)}e.bufferSubData(e.UNIFORM_BUFFER,i,s.__data)}}}e.bindBuffer(e.UNIFORM_BUFFER,null)}(r),o[r.id]=y)},dispose:function(){for(let i in s)e.deleteBuffer(s[i]);l=[],s={},o={}}}}let tz=new Uint16Array([12469,15057,12620,14925,13266,14620,13807,14376,14323,13990,14545,13625,14713,13328,14840,12882,14931,12528,14996,12233,15039,11829,15066,11525,15080,11295,15085,10976,15082,10705,15073,10495,13880,14564,13898,14542,13977,14430,14158,14124,14393,13732,14556,13410,14702,12996,14814,12596,14891,12291,14937,11834,14957,11489,14958,11194,14943,10803,14921,10506,14893,10278,14858,9960,14484,14039,14487,14025,14499,13941,14524,13740,14574,13468,14654,13106,14743,12678,14818,12344,14867,11893,14889,11509,14893,11180,14881,10751,14852,10428,14812,10128,14765,9754,14712,9466,14764,13480,14764,13475,14766,13440,14766,13347,14769,13070,14786,12713,14816,12387,14844,11957,14860,11549,14868,11215,14855,10751,14825,10403,14782,10044,14729,9651,14666,9352,14599,9029,14967,12835,14966,12831,14963,12804,14954,12723,14936,12564,14917,12347,14900,11958,14886,11569,14878,11247,14859,10765,14828,10401,14784,10011,14727,9600,14660,9289,14586,8893,14508,8533,15111,12234,15110,12234,15104,12216,15092,12156,15067,12010,15028,11776,14981,11500,14942,11205,14902,10752,14861,10393,14812,9991,14752,9570,14682,9252,14603,8808,14519,8445,14431,8145,15209,11449,15208,11451,15202,11451,15190,11438,15163,11384,15117,11274,15055,10979,14994,10648,14932,10343,14871,9936,14803,9532,14729,9218,14645,8742,14556,8381,14461,8020,14365,7603,15273,10603,15272,10607,15267,10619,15256,10631,15231,10614,15182,10535,15118,10389,15042,10167,14963,9787,14883,9447,14800,9115,14710,8665,14615,8318,14514,7911,14411,7507,14279,7198,15314,9675,15313,9683,15309,9712,15298,9759,15277,9797,15229,9773,15166,9668,15084,9487,14995,9274,14898,8910,14800,8539,14697,8234,14590,7790,14479,7409,14367,7067,14178,6621,15337,8619,15337,8631,15333,8677,15325,8769,15305,8871,15264,8940,15202,8909,15119,8775,15022,8565,14916,8328,14804,8009,14688,7614,14569,7287,14448,6888,14321,6483,14088,6171,15350,7402,15350,7419,15347,7480,15340,7613,15322,7804,15287,7973,15229,8057,15148,8012,15046,7846,14933,7611,14810,7357,14682,7069,14552,6656,14421,6316,14251,5948,14007,5528,15356,5942,15356,5977,15353,6119,15348,6294,15332,6551,15302,6824,15249,7044,15171,7122,15070,7050,14949,6861,14818,6611,14679,6349,14538,6067,14398,5651,14189,5311,13935,4958,15359,4123,15359,4153,15356,4296,15353,4646,15338,5160,15311,5508,15263,5829,15188,6042,15088,6094,14966,6001,14826,5796,14678,5543,14527,5287,14377,4985,14133,4586,13869,4257,15360,1563,15360,1642,15358,2076,15354,2636,15341,3350,15317,4019,15273,4429,15203,4732,15105,4911,14981,4932,14836,4818,14679,4621,14517,4386,14359,4156,14083,3795,13808,3437,15360,122,15360,137,15358,285,15355,636,15344,1274,15322,2177,15281,2765,15215,3223,15120,3451,14995,3569,14846,3567,14681,3466,14511,3305,14344,3121,14037,2800,13753,2467,15360,0,15360,1,15359,21,15355,89,15346,253,15325,479,15287,796,15225,1148,15133,1492,15008,1749,14856,1882,14685,1886,14506,1783,14324,1608,13996,1398,13702,1183]),tk=null;class tV{constructor(e={}){let i,r,o,l,c,h,u,d,x,y,M,S,b,T,E,w,A,R,C,P,I,L,k,H,G;const{canvas:W=(0,n.lPF)(),context:X=null,depth:j=!0,stencil:q=!1,alpha:Y=!1,antialias:K=!1,premultipliedAlpha:J=!0,preserveDrawingBuffer:Z=!1,powerPreference:Q="default",failIfMajorPerformanceCaveat:$=!1,reversedDepthBuffer:ee=!1,outputBufferType:et=n.OUM}=e;if(this.isWebGLRenderer=!0,null!==X){if("u">typeof WebGLRenderingContext&&X instanceof WebGLRenderingContext)throw Error("THREE.WebGLRenderer: WebGL 1 is not supported since r163.");i=X.getContextAttributes().alpha}else i=Y;const ei=new Set([n.c90,n.TkQ,n.ZQM]),er=new Set([n.OUM,n.bkx,n.cHt,n.V3x,n.Wew,n.gJ2]),en=new Uint32Array(4),ea=new Int32Array(4);let es=null,eo=null;const el=[],ec=[];let eh=null;this.domElement=W,this.debug={checkShaderErrors:!0,onShaderError:null},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.toneMapping=n.y_p,this.toneMappingExposure=1,this.transmissionResolutionScale=1;const eu=this;let ed=!1;this._outputColorSpace=n.er$;let ep=0,ef=0,em=null,eg=-1,ev=null;const e_=new n.IUQ,ex=new n.IUQ;let ey=null;const eM=new n.Q1f(0);let eS=0,eb=W.width,eT=W.height,eE=1,ew=null,eA=null;const eR=new n.IUQ(0,0,eb,eT),eC=new n.IUQ(0,0,eb,eT);let eP=!1;const eI=new n.PPD;let eL=!1,eD=!1;const eU=new n.kn4,eN=new n.Pq0,eO=new n.IUQ,eF={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};let eB=!1;function ez(){return null===em?eE:1}let ek=X;function eV(e,i){return W.getContext(e,i)}try{if("setAttribute"in W&&W.setAttribute("data-engine",`three.js r${n.sPf}`),W.addEventListener("webglcontextlost",eW,!1),W.addEventListener("webglcontextrestored",ej,!1),W.addEventListener("webglcontextcreationerror",eq,!1),null===ek){const e="webgl2";if(ek=eV(e,{alpha:!0,depth:j,stencil:q,antialias:K,premultipliedAlpha:J,preserveDrawingBuffer:Z,powerPreference:Q,failIfMajorPerformanceCaveat:$}),null===ek)if(eV(e))throw Error("Error creating WebGL context with your selected attributes.");else throw Error("Error creating WebGL context.")}}catch(e){throw(0,n.z3S)("WebGLRenderer: "+e.message),e}function eH(){(r=new U(ek)).init(),k=new tP(ek,r),o=new g(ek,r,e,k),l=new tR(ek,r),o.reversedDepthBuffer&&ee&&l.buffers.depth.setReversed(!0),c=new F(ek),h=new tl,u=new tC(ek,r,l,h,o,k,c),d=new _(eu),x=new D(eu),y=new s(ek),H=new f(ek,y),M=new N(ek,y,c,H),S=new z(ek,M,y,c),P=new B(ek,o,u),A=new v(h),b=new to(eu,d,x,r,o,H,A),T=new tF(eu,h),E=new td,w=new t_(r),C=new p(eu,d,x,l,S,i,J),R=new tw(eu,S,o),G=new tB(ek,c,o,l),I=new m(ek,r,c),L=new O(ek,r,c),c.programs=b.programs,eu.capabilities=o,eu.extensions=r,eu.properties=h,eu.renderLists=E,eu.shadowMap=R,eu.state=l,eu.info=c}eH(),et!==n.OUM&&(eh=new V(et,W.width,W.height,j,q));const eG=new tU(eu,ek);function eW(e){e.preventDefault(),(0,n.Rm2)("WebGLRenderer: Context Lost."),ed=!0}function ej(){(0,n.Rm2)("WebGLRenderer: Context Restored."),ed=!1;let e=c.autoReset,i=R.enabled,r=R.autoUpdate,a=R.needsUpdate,s=R.type;eH(),c.autoReset=e,R.enabled=i,R.autoUpdate=r,R.needsUpdate=a,R.type=s}function eq(e){(0,n.z3S)("WebGLRenderer: A WebGL context could not be created. Reason: ",e.statusMessage)}function eY(e){var i,r;let n,a=e.target;a.removeEventListener("dispose",eY),r=i=a,void 0!==(n=h.get(r).programs)&&(n.forEach(function(e){b.releaseProgram(e)}),r.isShaderMaterial&&b.releaseShaderCache(r)),h.remove(i)}function eK(e,i,r){!0===e.transparent&&e.side===n.$EB&&!1===e.forceSinglePass?(e.side=n.hsX,e.needsUpdate=!0,e5(e,i,r),e.side=n.hB5,e.needsUpdate=!0,e5(e,i,r),e.side=n.$EB):e5(e,i,r)}this.xr=eG,this.getContext=function(){return ek},this.getContextAttributes=function(){return ek.getContextAttributes()},this.forceContextLoss=function(){let e=r.get("WEBGL_lose_context");e&&e.loseContext()},this.forceContextRestore=function(){let e=r.get("WEBGL_lose_context");e&&e.restoreContext()},this.getPixelRatio=function(){return eE},this.setPixelRatio=function(e){void 0!==e&&(eE=e,this.setSize(eb,eT,!1))},this.getSize=function(e){return e.set(eb,eT)},this.setSize=function(e,i,r=!0){eG.isPresenting?(0,n.R8M)("WebGLRenderer: Can't change size while VR device is presenting."):(eb=e,eT=i,W.width=Math.floor(e*eE),W.height=Math.floor(i*eE),!0===r&&(W.style.width=e+"px",W.style.height=i+"px"),null!==eh&&eh.setSize(W.width,W.height),this.setViewport(0,0,e,i))},this.getDrawingBufferSize=function(e){return e.set(eb*eE,eT*eE).floor()},this.setDrawingBufferSize=function(e,i,r){eb=e,eT=i,eE=r,W.width=Math.floor(e*r),W.height=Math.floor(i*r),this.setViewport(0,0,e,i)},this.setEffects=function(e){if(et===n.OUM)return void console.error("THREE.WebGLRenderer: setEffects() requires outputBufferType set to HalfFloatType or FloatType.");if(e){for(let i=0;i<e.length;i++)if(!0===e[i].isOutputPass){console.warn("THREE.WebGLRenderer: OutputPass is not needed in setEffects(). Tone mapping and color space conversion are applied automatically.");break}}eh.setEffects(e||[])},this.getCurrentViewport=function(e){return e.copy(e_)},this.getViewport=function(e){return e.copy(eR)},this.setViewport=function(e,i,r,n){e.isVector4?eR.set(e.x,e.y,e.z,e.w):eR.set(e,i,r,n),l.viewport(e_.copy(eR).multiplyScalar(eE).round())},this.getScissor=function(e){return e.copy(eC)},this.setScissor=function(e,i,r,n){e.isVector4?eC.set(e.x,e.y,e.z,e.w):eC.set(e,i,r,n),l.scissor(ex.copy(eC).multiplyScalar(eE).round())},this.getScissorTest=function(){return eP},this.setScissorTest=function(e){l.setScissorTest(eP=e)},this.setOpaqueSort=function(e){ew=e},this.setTransparentSort=function(e){eA=e},this.getClearColor=function(e){return e.copy(C.getClearColor())},this.setClearColor=function(){C.setClearColor(...arguments)},this.getClearAlpha=function(){return C.getClearAlpha()},this.setClearAlpha=function(){C.setClearAlpha(...arguments)},this.clear=function(e=!0,i=!0,r=!0){let n=0;if(e){let e=!1;if(null!==em){let i=em.texture.format;e=ei.has(i)}if(e){let e=em.texture.type,i=er.has(e),r=C.getClearColor(),n=C.getClearAlpha(),a=r.r,s=r.g,o=r.b;i?(en[0]=a,en[1]=s,en[2]=o,en[3]=n,ek.clearBufferuiv(ek.COLOR,0,en)):(ea[0]=a,ea[1]=s,ea[2]=o,ea[3]=n,ek.clearBufferiv(ek.COLOR,0,ea))}else n|=ek.COLOR_BUFFER_BIT}i&&(n|=ek.DEPTH_BUFFER_BIT),r&&(n|=ek.STENCIL_BUFFER_BIT,this.state.buffers.stencil.setMask(0xffffffff)),ek.clear(n)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){W.removeEventListener("webglcontextlost",eW,!1),W.removeEventListener("webglcontextrestored",ej,!1),W.removeEventListener("webglcontextcreationerror",eq,!1),C.dispose(),E.dispose(),w.dispose(),h.dispose(),d.dispose(),x.dispose(),S.dispose(),H.dispose(),G.dispose(),b.dispose(),eG.dispose(),eG.removeEventListener("sessionstart",eZ),eG.removeEventListener("sessionend",eQ),e$.stop()},this.renderBufferDirect=function(e,i,a,s,c,p){let f;null===i&&(i=eF);let m=c.isMesh&&0>c.matrixWorld.determinant(),g=function(e,i,r,a,s){var c,p;!0!==i.isScene&&(i=eF),u.resetTextureUnits();let f=i.fog,m=a.isMeshStandardMaterial?i.environment:null,g=null===em?eu.outputColorSpace:!0===em.isXRRenderTarget?em.texture.colorSpace:n.Zr2,v=(a.isMeshStandardMaterial?x:d).get(a.envMap||m),_=!0===a.vertexColors&&!!r.attributes.color&&4===r.attributes.color.itemSize,y=!!r.attributes.tangent&&(!!a.normalMap||a.anisotropy>0),M=!!r.morphAttributes.position,S=!!r.morphAttributes.normal,b=!!r.morphAttributes.color,E=n.y_p;a.toneMapped&&(null===em||!0===em.isXRRenderTarget)&&(E=eu.toneMapping);let w=r.morphAttributes.position||r.morphAttributes.normal||r.morphAttributes.color,R=void 0!==w?w.length:0,C=h.get(a),I=eo.state.lights;if(!0===eL&&(!0===eD||e!==ev)){let i=e===ev&&a.id===eg;A.setState(a,e,i)}let L=!1;a.version===C.__version?C.needsLights&&C.lightsStateVersion!==I.state.version||C.outputColorSpace!==g||s.isBatchedMesh&&!1===C.batching?L=!0:s.isBatchedMesh||!0!==C.batching?s.isBatchedMesh&&!0===C.batchingColor&&null===s.colorTexture||s.isBatchedMesh&&!1===C.batchingColor&&null!==s.colorTexture||s.isInstancedMesh&&!1===C.instancing?L=!0:s.isInstancedMesh||!0!==C.instancing?s.isSkinnedMesh&&!1===C.skinning?L=!0:s.isSkinnedMesh||!0!==C.skinning?s.isInstancedMesh&&!0===C.instancingColor&&null===s.instanceColor||s.isInstancedMesh&&!1===C.instancingColor&&null!==s.instanceColor||s.isInstancedMesh&&!0===C.instancingMorph&&null===s.morphTexture||s.isInstancedMesh&&!1===C.instancingMorph&&null!==s.morphTexture||C.envMap!==v||!0===a.fog&&C.fog!==f||void 0!==C.numClippingPlanes&&(C.numClippingPlanes!==A.numPlanes||C.numIntersection!==A.numIntersection)||C.vertexAlphas!==_||C.vertexTangents!==y||C.morphTargets!==M||C.morphNormals!==S||C.morphColors!==b||C.toneMapping!==E?L=!0:C.morphTargetsCount!==R&&(L=!0):L=!0:L=!0:L=!0:(L=!0,C.__version=a.version);let D=C.currentProgram;!0===L&&(D=e5(a,i,s));let U=!1,N=!1,O=!1,F=D.getUniforms(),B=C.uniforms;if(l.useProgram(D.program)&&(U=!0,N=!0,O=!0),a.id!==eg&&(eg=a.id,N=!0),U||ev!==e){l.buffers.depth.getReversed()&&!0!==e.reversedDepth&&(e._reversedDepth=!0,e.updateProjectionMatrix()),F.setValue(ek,"projectionMatrix",e.projectionMatrix),F.setValue(ek,"viewMatrix",e.matrixWorldInverse);let i=F.map.cameraPosition;void 0!==i&&i.setValue(ek,eN.setFromMatrixPosition(e.matrixWorld)),o.logarithmicDepthBuffer&&F.setValue(ek,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),(a.isMeshPhongMaterial||a.isMeshToonMaterial||a.isMeshLambertMaterial||a.isMeshBasicMaterial||a.isMeshStandardMaterial||a.isShaderMaterial)&&F.setValue(ek,"isOrthographic",!0===e.isOrthographicCamera),ev!==e&&(ev=e,N=!0,O=!0)}if(C.needsLights&&(I.state.directionalShadowMap.length>0&&F.setValue(ek,"directionalShadowMap",I.state.directionalShadowMap,u),I.state.spotShadowMap.length>0&&F.setValue(ek,"spotShadowMap",I.state.spotShadowMap,u),I.state.pointShadowMap.length>0&&F.setValue(ek,"pointShadowMap",I.state.pointShadowMap,u)),s.isSkinnedMesh){F.setOptional(ek,s,"bindMatrix"),F.setOptional(ek,s,"bindMatrixInverse");let e=s.skeleton;e&&(null===e.boneTexture&&e.computeBoneTexture(),F.setValue(ek,"boneTexture",e.boneTexture,u))}s.isBatchedMesh&&(F.setOptional(ek,s,"batchingTexture"),F.setValue(ek,"batchingTexture",s._matricesTexture,u),F.setOptional(ek,s,"batchingIdTexture"),F.setValue(ek,"batchingIdTexture",s._indirectTexture,u),F.setOptional(ek,s,"batchingColorTexture"),null!==s._colorsTexture&&F.setValue(ek,"batchingColorTexture",s._colorsTexture,u));let z=r.morphAttributes;if((void 0!==z.position||void 0!==z.normal||void 0!==z.color)&&P.update(s,r,D),(N||C.receiveShadow!==s.receiveShadow)&&(C.receiveShadow=s.receiveShadow,F.setValue(ek,"receiveShadow",s.receiveShadow)),a.isMeshGouraudMaterial&&null!==a.envMap&&(B.envMap.value=v,B.flipEnvMap.value=v.isCubeTexture&&!1===v.isRenderTargetTexture?-1:1),a.isMeshStandardMaterial&&null===a.envMap&&null!==i.environment&&(B.envMapIntensity.value=i.environmentIntensity),void 0!==B.dfgLUT&&(B.dfgLUT.value=(null===tk&&((tk=new n.GYF(tz,16,16,n.paN,n.ix0)).name="DFG_LUT",tk.minFilter=n.k6q,tk.magFilter=n.k6q,tk.wrapS=n.ghU,tk.wrapT=n.ghU,tk.generateMipmaps=!1,tk.needsUpdate=!0),tk)),N&&(F.setValue(ek,"toneMappingExposure",eu.toneMappingExposure),C.needsLights&&(c=B,p=O,c.ambientLightColor.needsUpdate=p,c.lightProbe.needsUpdate=p,c.directionalLights.needsUpdate=p,c.directionalLightShadows.needsUpdate=p,c.pointLights.needsUpdate=p,c.pointLightShadows.needsUpdate=p,c.spotLights.needsUpdate=p,c.spotLightShadows.needsUpdate=p,c.rectAreaLights.needsUpdate=p,c.hemisphereLights.needsUpdate=p),f&&!0===a.fog&&T.refreshFogUniforms(B,f),T.refreshMaterialUniforms(B,a,eE,eT,eo.state.transmissionRenderTarget[e.id]),eX.upload(ek,e6(C),B,u)),a.isShaderMaterial&&!0===a.uniformsNeedUpdate&&(eX.upload(ek,e6(C),B,u),a.uniformsNeedUpdate=!1),a.isSpriteMaterial&&F.setValue(ek,"center",s.center),F.setValue(ek,"modelViewMatrix",s.modelViewMatrix),F.setValue(ek,"normalMatrix",s.normalMatrix),F.setValue(ek,"modelMatrix",s.matrixWorld),a.isShaderMaterial||a.isRawShaderMaterial){let e=a.uniformsGroups;for(let i=0,r=e.length;i<r;i++){let r=e[i];G.update(r,D),G.bind(r,D)}}return D}(e,i,a,s,c);l.setMaterial(s,m);let v=a.index,_=1;if(!0===s.wireframe){if(void 0===(v=M.getWireframeAttribute(a)))return;_=2}let S=a.drawRange,b=a.attributes.position,E=S.start*_,w=(S.start+S.count)*_;null!==p&&(E=Math.max(E,p.start*_),w=Math.min(w,(p.start+p.count)*_)),null!==v?(E=Math.max(E,0),w=Math.min(w,v.count)):null!=b&&(E=Math.max(E,0),w=Math.min(w,b.count));let R=w-E;if(R<0||R===1/0)return;H.setup(c,s,g,a,v);let C=I;if(null!==v&&(f=y.get(v),(C=L).setIndex(f)),c.isMesh)!0===s.wireframe?(l.setLineWidth(s.wireframeLinewidth*ez()),C.setMode(ek.LINES)):C.setMode(ek.TRIANGLES);else if(c.isLine){let e=s.linewidth;void 0===e&&(e=1),l.setLineWidth(e*ez()),c.isLineSegments?C.setMode(ek.LINES):c.isLineLoop?C.setMode(ek.LINE_LOOP):C.setMode(ek.LINE_STRIP)}else c.isPoints?C.setMode(ek.POINTS):c.isSprite&&C.setMode(ek.TRIANGLES);if(c.isBatchedMesh)if(null!==c._multiDrawInstances)(0,n.mcG)("WebGLRenderer: renderMultiDrawInstances has been deprecated and will be removed in r184. Append to renderMultiDraw arguments and use indirection."),C.renderMultiDrawInstances(c._multiDrawStarts,c._multiDrawCounts,c._multiDrawCount,c._multiDrawInstances);else if(r.get("WEBGL_multi_draw"))C.renderMultiDraw(c._multiDrawStarts,c._multiDrawCounts,c._multiDrawCount);else{let e=c._multiDrawStarts,i=c._multiDrawCounts,r=c._multiDrawCount,n=v?y.get(v).bytesPerElement:1,a=h.get(s).currentProgram.getUniforms();for(let s=0;s<r;s++)a.setValue(ek,"_gl_DrawID",s),C.render(e[s]/n,i[s])}else if(c.isInstancedMesh)C.renderInstances(E,R,c.count);else if(a.isInstancedBufferGeometry){let e=void 0!==a._maxInstanceCount?a._maxInstanceCount:1/0,i=Math.min(a.instanceCount,e);C.renderInstances(E,R,i)}else C.render(E,R)},this.compile=function(e,i,r=null){null===r&&(r=e),(eo=w.get(r)).init(i),ec.push(eo),r.traverseVisible(function(e){e.isLight&&e.layers.test(i.layers)&&(eo.pushLight(e),e.castShadow&&eo.pushShadow(e))}),e!==r&&e.traverseVisible(function(e){e.isLight&&e.layers.test(i.layers)&&(eo.pushLight(e),e.castShadow&&eo.pushShadow(e))}),eo.setupLights();let n=new Set;return e.traverse(function(e){if(!(e.isMesh||e.isPoints||e.isLine||e.isSprite))return;let i=e.material;if(i)if(Array.isArray(i))for(let a=0;a<i.length;a++){let s=i[a];eK(s,r,e),n.add(s)}else eK(i,r,e),n.add(i)}),eo=ec.pop(),n},this.compileAsync=function(e,i,n=null){let a=this.compile(e,i,n);return new Promise(i=>{function n(){(a.forEach(function(e){h.get(e).currentProgram.isReady()&&a.delete(e)}),0===a.size)?i(e):setTimeout(n,10)}null!==r.get("KHR_parallel_shader_compile")?n():setTimeout(n,10)})};let eJ=null;function eZ(){e$.stop()}function eQ(){e$.start()}const e$=new a;function e0(e,i,r,n){if(!1===e.visible)return;if(e.layers.test(i.layers)){if(e.isGroup)r=e.renderOrder;else if(e.isLOD)!0===e.autoUpdate&&e.update(i);else if(e.isLight)eo.pushLight(e),e.castShadow&&eo.pushShadow(e);else if(e.isSprite){if(!e.frustumCulled||eI.intersectsSprite(e)){n&&eO.setFromMatrixPosition(e.matrixWorld).applyMatrix4(eU);let i=S.update(e),a=e.material;a.visible&&es.push(e,i,a,r,eO.z,null)}}else if((e.isMesh||e.isLine||e.isPoints)&&(!e.frustumCulled||eI.intersectsObject(e))){let i=S.update(e),a=e.material;if(n&&(void 0!==e.boundingSphere?(null===e.boundingSphere&&e.computeBoundingSphere(),eO.copy(e.boundingSphere.center)):(null===i.boundingSphere&&i.computeBoundingSphere(),eO.copy(i.boundingSphere.center)),eO.applyMatrix4(e.matrixWorld).applyMatrix4(eU)),Array.isArray(a)){let n=i.groups;for(let s=0,o=n.length;s<o;s++){let o=n[s],l=a[o.materialIndex];l&&l.visible&&es.push(e,i,l,r,eO.z,o)}}else a.visible&&es.push(e,i,a,r,eO.z,null)}}let a=e.children;for(let e=0,s=a.length;e<s;e++)e0(a[e],i,r,n)}function e1(e,i,r,n){let{opaque:a,transmissive:s,transparent:o}=e;eo.setupLightsView(r),!0===eL&&A.setGlobalState(eu.clippingPlanes,r),n&&l.viewport(e_.copy(n)),a.length>0&&e2(a,i,r),s.length>0&&e2(s,i,r),o.length>0&&e2(o,i,r),l.buffers.depth.setTest(!0),l.buffers.depth.setMask(!0),l.buffers.color.setMask(!0),l.setPolygonOffset(!1)}function e3(e,i,a,s){if(null!==(!0===a.isScene?a.overrideMaterial:null))return;if(void 0===eo.state.transmissionRenderTarget[s.id]){let e=r.has("EXT_color_buffer_half_float")||r.has("EXT_color_buffer_float");eo.state.transmissionRenderTarget[s.id]=new n.nWS(1,1,{generateMipmaps:!0,type:e?n.ix0:n.OUM,minFilter:n.$_I,samples:o.samples,stencilBuffer:q,resolveDepthBuffer:!1,resolveStencilBuffer:!1,colorSpace:n.ppV.workingColorSpace})}let l=eo.state.transmissionRenderTarget[s.id],c=s.viewport||e_;l.setSize(c.z*eu.transmissionResolutionScale,c.w*eu.transmissionResolutionScale);let h=eu.getRenderTarget(),d=eu.getActiveCubeFace(),p=eu.getActiveMipmapLevel();eu.setRenderTarget(l),eu.getClearColor(eM),(eS=eu.getClearAlpha())<1&&eu.setClearColor(0xffffff,.5),eu.clear(),eB&&C.render(a);let f=eu.toneMapping;eu.toneMapping=n.y_p;let m=s.viewport;if(void 0!==s.viewport&&(s.viewport=void 0),eo.setupLightsView(s),!0===eL&&A.setGlobalState(eu.clippingPlanes,s),e2(e,a,s),u.updateMultisampleRenderTarget(l),u.updateRenderTargetMipmap(l),!1===r.has("WEBGL_multisampled_render_to_texture")){let e=!1;for(let r=0,o=i.length;r<o;r++){let{object:o,geometry:l,material:c,group:h}=i[r];if(c.side===n.$EB&&o.layers.test(s.layers)){let i=c.side;c.side=n.hsX,c.needsUpdate=!0,e4(o,a,s,l,c,h),c.side=i,c.needsUpdate=!0,e=!0}}!0===e&&(u.updateMultisampleRenderTarget(l),u.updateRenderTargetMipmap(l))}eu.setRenderTarget(h,d,p),eu.setClearColor(eM,eS),void 0!==m&&(s.viewport=m),eu.toneMapping=f}function e2(e,i,r){let n=!0===i.isScene?i.overrideMaterial:null;for(let a=0,s=e.length;a<s;a++){let s=e[a],{object:o,geometry:l,group:c}=s,h=s.material;!0===h.allowOverride&&null!==n&&(h=n),o.layers.test(r.layers)&&e4(o,i,r,l,h,c)}}function e4(e,i,r,a,s,o){e.onBeforeRender(eu,i,r,a,s,o),e.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix),s.onBeforeRender(eu,i,r,a,e,o),!0===s.transparent&&s.side===n.$EB&&!1===s.forceSinglePass?(s.side=n.hsX,s.needsUpdate=!0,eu.renderBufferDirect(r,i,a,s,e,o),s.side=n.hB5,s.needsUpdate=!0,eu.renderBufferDirect(r,i,a,s,e,o),s.side=n.$EB):eu.renderBufferDirect(r,i,a,s,e,o),e.onAfterRender(eu,i,r,a,s,o)}function e5(e,i,r){var n;!0!==i.isScene&&(i=eF);let a=h.get(e),s=eo.state.lights,o=eo.state.shadowsArray,l=s.state.version,c=b.getParameters(e,s.state,o,i,r),u=b.getProgramCacheKey(c),p=a.programs;a.environment=e.isMeshStandardMaterial?i.environment:null,a.fog=i.fog,a.envMap=(e.isMeshStandardMaterial?x:d).get(e.envMap||a.environment),a.envMapRotation=null!==a.environment&&null===e.envMap?i.environmentRotation:e.envMapRotation,void 0===p&&(e.addEventListener("dispose",eY),a.programs=p=new Map);let f=p.get(u);if(void 0!==f){if(a.currentProgram===f&&a.lightsStateVersion===l)return e8(e,c),f}else c.uniforms=b.getUniforms(e),e.onBeforeCompile(c,eu),f=b.acquireProgram(c,u),p.set(u,f),a.uniforms=c.uniforms;let m=a.uniforms;return(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(m.clippingPlanes=A.uniform),e8(e,c),a.needsLights=(n=e).isMeshLambertMaterial||n.isMeshToonMaterial||n.isMeshPhongMaterial||n.isMeshStandardMaterial||n.isShadowMaterial||n.isShaderMaterial&&!0===n.lights,a.lightsStateVersion=l,a.needsLights&&(m.ambientLightColor.value=s.state.ambient,m.lightProbe.value=s.state.probe,m.directionalLights.value=s.state.directional,m.directionalLightShadows.value=s.state.directionalShadow,m.spotLights.value=s.state.spot,m.spotLightShadows.value=s.state.spotShadow,m.rectAreaLights.value=s.state.rectArea,m.ltc_1.value=s.state.rectAreaLTC1,m.ltc_2.value=s.state.rectAreaLTC2,m.pointLights.value=s.state.point,m.pointLightShadows.value=s.state.pointShadow,m.hemisphereLights.value=s.state.hemi,m.directionalShadowMap.value=s.state.directionalShadowMap,m.directionalShadowMatrix.value=s.state.directionalShadowMatrix,m.spotShadowMap.value=s.state.spotShadowMap,m.spotLightMatrix.value=s.state.spotLightMatrix,m.spotLightMap.value=s.state.spotLightMap,m.pointShadowMap.value=s.state.pointShadowMap,m.pointShadowMatrix.value=s.state.pointShadowMatrix),a.currentProgram=f,a.uniformsList=null,f}function e6(e){if(null===e.uniformsList){let i=e.currentProgram.getUniforms();e.uniformsList=eX.seqWithValue(i.seq,e.uniforms)}return e.uniformsList}function e8(e,i){let r=h.get(e);r.outputColorSpace=i.outputColorSpace,r.batching=i.batching,r.batchingColor=i.batchingColor,r.instancing=i.instancing,r.instancingColor=i.instancingColor,r.instancingMorph=i.instancingMorph,r.skinning=i.skinning,r.morphTargets=i.morphTargets,r.morphNormals=i.morphNormals,r.morphColors=i.morphColors,r.morphTargetsCount=i.morphTargetsCount,r.numClippingPlanes=i.numClippingPlanes,r.numIntersection=i.numClipIntersection,r.vertexAlphas=i.vertexAlphas,r.vertexTangents=i.vertexTangents,r.toneMapping=i.toneMapping}e$.setAnimationLoop(function(e){eJ&&eJ(e)}),"u">typeof self&&e$.setContext(self),this.setAnimationLoop=function(e){eJ=e,eG.setAnimationLoop(e),null===e?e$.stop():e$.start()},eG.addEventListener("sessionstart",eZ),eG.addEventListener("sessionend",eQ),this.render=function(e,i){if(void 0!==i&&!0!==i.isCamera)return void(0,n.z3S)("WebGLRenderer.render: camera is not an instance of THREE.Camera.");if(!0===ed)return;let r=!0===eG.enabled&&!0===eG.isPresenting,a=null!==eh&&(null===em||r)&&eh.begin(eu,em);if(!0===e.matrixWorldAutoUpdate&&e.updateMatrixWorld(),null===i.parent&&!0===i.matrixWorldAutoUpdate&&i.updateMatrixWorld(),!0===eG.enabled&&!0===eG.isPresenting&&(null===eh||!1===eh.isCompositing())&&(!0===eG.cameraAutoUpdate&&eG.updateCamera(i),i=eG.getCamera()),!0===e.isScene&&e.onBeforeRender(eu,e,i,em),(eo=w.get(e,ec.length)).init(i),ec.push(eo),eU.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),eI.setFromProjectionMatrix(eU,n.TdN,i.reversedDepth),eD=this.localClippingEnabled,eL=A.init(this.clippingPlanes,eD),(es=E.get(e,el.length)).init(),el.push(es),!0===eG.enabled&&!0===eG.isPresenting){let e=eu.xr.getDepthSensingMesh();null!==e&&e0(e,i,-1/0,eu.sortObjects)}e0(e,i,0,eu.sortObjects),es.finish(),!0===eu.sortObjects&&es.sort(ew,eA),(eB=!1===eG.enabled||!1===eG.isPresenting||!1===eG.hasDepthSensing())&&C.addToRenderList(es,e),this.info.render.frame++,!0===eL&&A.beginShadows();let s=eo.state.shadowsArray;if(R.render(s,e,i),!0===eL&&A.endShadows(),!0===this.info.autoReset&&this.info.reset(),!1===(a&&eh.hasRenderPass())){let r=es.opaque,n=es.transmissive;if(eo.setupLights(),i.isArrayCamera){let a=i.cameras;if(n.length>0)for(let i=0,s=a.length;i<s;i++)e3(r,n,e,a[i]);eB&&C.render(e);for(let i=0,r=a.length;i<r;i++){let r=a[i];e1(es,e,r,r.viewport)}}else n.length>0&&e3(r,n,e,i),eB&&C.render(e),e1(es,e,i)}null!==em&&0===ef&&(u.updateMultisampleRenderTarget(em),u.updateRenderTargetMipmap(em)),a&&eh.end(eu),!0===e.isScene&&e.onAfterRender(eu,e,i),H.resetDefaultState(),eg=-1,ev=null,ec.pop(),ec.length>0?(eo=ec[ec.length-1],!0===eL&&A.setGlobalState(eu.clippingPlanes,eo.state.camera)):eo=null,el.pop(),es=el.length>0?el[el.length-1]:null},this.getActiveCubeFace=function(){return ep},this.getActiveMipmapLevel=function(){return ef},this.getRenderTarget=function(){return em},this.setRenderTargetTextures=function(e,i,r){let n=h.get(e);n.__autoAllocateDepthBuffer=!1===e.resolveDepthBuffer,!1===n.__autoAllocateDepthBuffer&&(n.__useRenderToTexture=!1),h.get(e.texture).__webglTexture=i,h.get(e.depthTexture).__webglTexture=n.__autoAllocateDepthBuffer?void 0:r,n.__hasExternalTextures=!0},this.setRenderTargetFramebuffer=function(e,i){let r=h.get(e);r.__webglFramebuffer=i,r.__useDefaultFramebuffer=void 0===i};const e9=ek.createFramebuffer();this.setRenderTarget=function(e,i=0,r=0){em=e,ep=i,ef=r;let n=null,a=!1,s=!1;if(e){let o=h.get(e);if(void 0!==o.__useDefaultFramebuffer){l.bindFramebuffer(ek.FRAMEBUFFER,o.__webglFramebuffer),e_.copy(e.viewport),ex.copy(e.scissor),ey=e.scissorTest,l.viewport(e_),l.scissor(ex),l.setScissorTest(ey),eg=-1;return}if(void 0===o.__webglFramebuffer)u.setupRenderTarget(e);else if(o.__hasExternalTextures)u.rebindTextures(e,h.get(e.texture).__webglTexture,h.get(e.depthTexture).__webglTexture);else if(e.depthBuffer){let i=e.depthTexture;if(o.__boundDepthTexture!==i){if(null!==i&&h.has(i)&&(e.width!==i.image.width||e.height!==i.image.height))throw Error("WebGLRenderTarget: Attached DepthTexture is initialized to the incorrect size.");u.setupDepthRenderbuffer(e)}}let c=e.texture;(c.isData3DTexture||c.isDataArrayTexture||c.isCompressedArrayTexture)&&(s=!0);let d=h.get(e).__webglFramebuffer;e.isWebGLCubeRenderTarget?(n=Array.isArray(d[i])?d[i][r]:d[i],a=!0):n=e.samples>0&&!1===u.useMultisampledRTT(e)?h.get(e).__webglMultisampledFramebuffer:Array.isArray(d)?d[r]:d,e_.copy(e.viewport),ex.copy(e.scissor),ey=e.scissorTest}else e_.copy(eR).multiplyScalar(eE).floor(),ex.copy(eC).multiplyScalar(eE).floor(),ey=eP;if(0!==r&&(n=e9),l.bindFramebuffer(ek.FRAMEBUFFER,n)&&l.drawBuffers(e,n),l.viewport(e_),l.scissor(ex),l.setScissorTest(ey),a){let n=h.get(e.texture);ek.framebufferTexture2D(ek.FRAMEBUFFER,ek.COLOR_ATTACHMENT0,ek.TEXTURE_CUBE_MAP_POSITIVE_X+i,n.__webglTexture,r)}else if(s)for(let n=0;n<e.textures.length;n++){let a=h.get(e.textures[n]);ek.framebufferTextureLayer(ek.FRAMEBUFFER,ek.COLOR_ATTACHMENT0+n,a.__webglTexture,r,i)}else if(null!==e&&0!==r){let i=h.get(e.texture);ek.framebufferTexture2D(ek.FRAMEBUFFER,ek.COLOR_ATTACHMENT0,ek.TEXTURE_2D,i.__webglTexture,r)}eg=-1},this.readRenderTargetPixels=function(e,i,r,a,s,c,u,d=0){if(!(e&&e.isWebGLRenderTarget))return void(0,n.z3S)("WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let p=h.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==u&&(p=p[u]),p){l.bindFramebuffer(ek.FRAMEBUFFER,p);try{let l=e.textures[d],h=l.format,u=l.type;if(!o.textureFormatReadable(h))return void(0,n.z3S)("WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");if(!o.textureTypeReadable(u))return void(0,n.z3S)("WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");i>=0&&i<=e.width-a&&r>=0&&r<=e.height-s&&(e.textures.length>1&&ek.readBuffer(ek.COLOR_ATTACHMENT0+d),ek.readPixels(i,r,a,s,k.convert(h),k.convert(u),c))}finally{let e=null!==em?h.get(em).__webglFramebuffer:null;l.bindFramebuffer(ek.FRAMEBUFFER,e)}}},this.readRenderTargetPixelsAsync=async function(e,i,r,a,s,c,u,d=0){if(!(e&&e.isWebGLRenderTarget))throw Error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let p=h.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==u&&(p=p[u]),p)if(i>=0&&i<=e.width-a&&r>=0&&r<=e.height-s){l.bindFramebuffer(ek.FRAMEBUFFER,p);let u=e.textures[d],f=u.format,m=u.type;if(!o.textureFormatReadable(f))throw Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: renderTarget is not in RGBA or implementation defined format.");if(!o.textureTypeReadable(m))throw Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: renderTarget is not in UnsignedByteType or implementation defined type.");let g=ek.createBuffer();ek.bindBuffer(ek.PIXEL_PACK_BUFFER,g),ek.bufferData(ek.PIXEL_PACK_BUFFER,c.byteLength,ek.STREAM_READ),e.textures.length>1&&ek.readBuffer(ek.COLOR_ATTACHMENT0+d),ek.readPixels(i,r,a,s,k.convert(f),k.convert(m),0);let v=null!==em?h.get(em).__webglFramebuffer:null;l.bindFramebuffer(ek.FRAMEBUFFER,v);let _=ek.fenceSync(ek.SYNC_GPU_COMMANDS_COMPLETE,0);return ek.flush(),await (0,n.jej)(ek,_,4),ek.bindBuffer(ek.PIXEL_PACK_BUFFER,g),ek.getBufferSubData(ek.PIXEL_PACK_BUFFER,0,c),ek.deleteBuffer(g),ek.deleteSync(_),c}else throw Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: requested read bounds are out of range.")},this.copyFramebufferToTexture=function(e,i=null,r=0){let n=Math.pow(2,-r),a=Math.floor(e.image.width*n),s=Math.floor(e.image.height*n),o=null!==i?i.x:0,c=null!==i?i.y:0;u.setTexture2D(e,0),ek.copyTexSubImage2D(ek.TEXTURE_2D,r,0,0,o,c,a,s),l.unbindTexture()};const e7=ek.createFramebuffer(),te=ek.createFramebuffer();this.copyTextureToTexture=function(e,i,r=null,a=null,s=0,o=null){let c,d,p,f,m,g,v,_,x,y;null===o&&(0!==s?((0,n.mcG)("WebGLRenderer: copyTextureToTexture function signature has changed to support src and dst mipmap levels."),o=s,s=0):o=0);let M=e.isCompressedTexture?e.mipmaps[o]:e.image;if(null!==r)c=r.max.x-r.min.x,d=r.max.y-r.min.y,p=r.isBox3?r.max.z-r.min.z:1,f=r.min.x,m=r.min.y,g=r.isBox3?r.min.z:0;else{let i=Math.pow(2,-s);c=Math.floor(M.width*i),d=Math.floor(M.height*i),p=e.isDataArrayTexture?M.depth:e.isData3DTexture?Math.floor(M.depth*i):1,f=0,m=0,g=0}null!==a?(v=a.x,_=a.y,x=a.z):(v=0,_=0,x=0);let S=k.convert(i.format),b=k.convert(i.type);i.isData3DTexture?(u.setTexture3D(i,0),y=ek.TEXTURE_3D):i.isDataArrayTexture||i.isCompressedArrayTexture?(u.setTexture2DArray(i,0),y=ek.TEXTURE_2D_ARRAY):(u.setTexture2D(i,0),y=ek.TEXTURE_2D),ek.pixelStorei(ek.UNPACK_FLIP_Y_WEBGL,i.flipY),ek.pixelStorei(ek.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i.premultiplyAlpha),ek.pixelStorei(ek.UNPACK_ALIGNMENT,i.unpackAlignment);let T=ek.getParameter(ek.UNPACK_ROW_LENGTH),E=ek.getParameter(ek.UNPACK_IMAGE_HEIGHT),w=ek.getParameter(ek.UNPACK_SKIP_PIXELS),A=ek.getParameter(ek.UNPACK_SKIP_ROWS),R=ek.getParameter(ek.UNPACK_SKIP_IMAGES);ek.pixelStorei(ek.UNPACK_ROW_LENGTH,M.width),ek.pixelStorei(ek.UNPACK_IMAGE_HEIGHT,M.height),ek.pixelStorei(ek.UNPACK_SKIP_PIXELS,f),ek.pixelStorei(ek.UNPACK_SKIP_ROWS,m),ek.pixelStorei(ek.UNPACK_SKIP_IMAGES,g);let C=e.isDataArrayTexture||e.isData3DTexture,P=i.isDataArrayTexture||i.isData3DTexture;if(e.isDepthTexture){let r=h.get(e),n=h.get(i),a=h.get(r.__renderTarget),u=h.get(n.__renderTarget);l.bindFramebuffer(ek.READ_FRAMEBUFFER,a.__webglFramebuffer),l.bindFramebuffer(ek.DRAW_FRAMEBUFFER,u.__webglFramebuffer);for(let r=0;r<p;r++)C&&(ek.framebufferTextureLayer(ek.READ_FRAMEBUFFER,ek.COLOR_ATTACHMENT0,h.get(e).__webglTexture,s,g+r),ek.framebufferTextureLayer(ek.DRAW_FRAMEBUFFER,ek.COLOR_ATTACHMENT0,h.get(i).__webglTexture,o,x+r)),ek.blitFramebuffer(f,m,c,d,v,_,c,d,ek.DEPTH_BUFFER_BIT,ek.NEAREST);l.bindFramebuffer(ek.READ_FRAMEBUFFER,null),l.bindFramebuffer(ek.DRAW_FRAMEBUFFER,null)}else if(0!==s||e.isRenderTargetTexture||h.has(e)){let r=h.get(e),n=h.get(i);l.bindFramebuffer(ek.READ_FRAMEBUFFER,e7),l.bindFramebuffer(ek.DRAW_FRAMEBUFFER,te);for(let e=0;e<p;e++)C?ek.framebufferTextureLayer(ek.READ_FRAMEBUFFER,ek.COLOR_ATTACHMENT0,r.__webglTexture,s,g+e):ek.framebufferTexture2D(ek.READ_FRAMEBUFFER,ek.COLOR_ATTACHMENT0,ek.TEXTURE_2D,r.__webglTexture,s),P?ek.framebufferTextureLayer(ek.DRAW_FRAMEBUFFER,ek.COLOR_ATTACHMENT0,n.__webglTexture,o,x+e):ek.framebufferTexture2D(ek.DRAW_FRAMEBUFFER,ek.COLOR_ATTACHMENT0,ek.TEXTURE_2D,n.__webglTexture,o),0!==s?ek.blitFramebuffer(f,m,c,d,v,_,c,d,ek.COLOR_BUFFER_BIT,ek.NEAREST):P?ek.copyTexSubImage3D(y,o,v,_,x+e,f,m,c,d):ek.copyTexSubImage2D(y,o,v,_,f,m,c,d);l.bindFramebuffer(ek.READ_FRAMEBUFFER,null),l.bindFramebuffer(ek.DRAW_FRAMEBUFFER,null)}else P?e.isDataTexture||e.isData3DTexture?ek.texSubImage3D(y,o,v,_,x,c,d,p,S,b,M.data):i.isCompressedArrayTexture?ek.compressedTexSubImage3D(y,o,v,_,x,c,d,p,S,M.data):ek.texSubImage3D(y,o,v,_,x,c,d,p,S,b,M):e.isDataTexture?ek.texSubImage2D(ek.TEXTURE_2D,o,v,_,c,d,S,b,M.data):e.isCompressedTexture?ek.compressedTexSubImage2D(ek.TEXTURE_2D,o,v,_,M.width,M.height,S,M.data):ek.texSubImage2D(ek.TEXTURE_2D,o,v,_,c,d,S,b,M);ek.pixelStorei(ek.UNPACK_ROW_LENGTH,T),ek.pixelStorei(ek.UNPACK_IMAGE_HEIGHT,E),ek.pixelStorei(ek.UNPACK_SKIP_PIXELS,w),ek.pixelStorei(ek.UNPACK_SKIP_ROWS,A),ek.pixelStorei(ek.UNPACK_SKIP_IMAGES,R),0===o&&i.generateMipmaps&&ek.generateMipmap(y),l.unbindTexture()},this.initRenderTarget=function(e){void 0===h.get(e).__webglFramebuffer&&u.setupRenderTarget(e)},this.initTexture=function(e){e.isCubeTexture?u.setTextureCube(e,0):e.isData3DTexture?u.setTexture3D(e,0):e.isDataArrayTexture||e.isCompressedArrayTexture?u.setTexture2DArray(e,0):u.setTexture2D(e,0),l.unbindTexture()},this.resetState=function(){ep=0,ef=0,em=null,l.reset(),H.reset()},"u">typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}get coordinateSystem(){return n.TdN}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(e){this._outputColorSpace=e;let i=this.getContext();i.drawingBufferColorSpace=n.ppV._getDrawingBufferColorSpace(e),i.unpackColorSpace=n.ppV._getUnpackColorSpace()}}}},s={};function o(e){var i=s[e];if(void 0!==i)return i.exports;var r=s[e]={id:e,loaded:!1,exports:{}};return a[e].call(r.exports,r,r.exports,o),r.loaded=!0,r.exports}o.m=a,e=[],o.O=(i,r,n,a)=>{if(r){a=a||0;for(var s=e.length;s>0&&e[s-1][2]>a;s--)e[s]=e[s-1];e[s]=[r,n,a];return}for(var l=1/0,s=0;s<e.length;s++){for(var[r,n,a]=e[s],c=!0,h=0;h<r.length;h++)(!1&a||l>=a)&&Object.keys(o.O).every(e=>o.O[e](r[h]))?r.splice(h--,1):(c=!1,a<l&&(l=a));if(c){e.splice(s--,1);var u=n();void 0!==u&&(i=u)}}return i},o.n=e=>{var i=e&&e.__esModule?()=>e.default:()=>e;return o.d(i,{a:i}),i},o.d=(e,i)=>{for(var r in i)o.o(i,r)&&!o.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:i[r]})},o.o=(e,i)=>Object.prototype.hasOwnProperty.call(e,i),o.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),i={121:0},o.O.j=e=>0===i[e],r=(e,r)=>{var n,a,[s,l,c]=r,h=0;if(s.some(e=>0!==i[e])){for(n in l)o.o(l,n)&&(o.m[n]=l[n]);if(c)var u=c(o)}for(e&&e(r);h<s.length;h++)a=s[h],o.o(i,a)&&i[a]&&i[a][0](),i[a]=0;return o.O(u)},(n=self.webpackChunkbilliards=self.webpackChunkbilliards||[]).forEach(r.bind(null,0)),n.push=r.bind(null,n.push.bind(n)),o("./node_modules/interactjs/dist/interact.min.js"),o("./node_modules/jsoncrush/JSONCrush.js");var l=o("./node_modules/three/build/three.module.js");l=o.O(l)})();
\ No newline at end of file
diff --git a/package.json b/package.json
index 5eee5ed..0ad82bc 100644
--- a/package.json
+++ b/package.json
@@ -57,11 +57,11 @@
     "ts-jest": "29.4.6",
     "ts-loader": "9.5.4",
     "ts-node": "^10.9.2",
     "typescript": "5.9.3",
     "typescript-eslint": "8.55.0",
-    "webpack": "5.105.1",
+    "webpack": "5.105.2",
     "webpack-cli": "6.0.1",
     "webpack-dev-server": "5.2.3",
     "webpack-node-externals": "^3.0.0"
   }
 }
diff --git a/src/events/recorder.ts b/src/events/recorder.ts
index a0dad23..198663e 100644
--- a/src/events/recorder.ts
+++ b/src/events/recorder.ts
@@ -66,12 +66,12 @@ export class Recorder {
       return undefined
     }
     const session = Session.getInstance()
     const isP1 = session.playerIndex === 0
     return {
-      player1: (isP1 ? session.playername : session.opponentName) || "Player 1",
-      player2: (isP1 ? session.opponentName : session.playername) || "Player 2",
+      player1: (isP1 ? session.playername : session.opponentName) || "Player",
+      player2: (isP1 ? session.opponentName : session.playername) || "Opponent",
     }
   }

   wholeGame() {
     return ReplayEncoder.createState(
diff --git a/src/network/client/nchanmessagerelay.ts b/src/network/client/nchanmessagerelay.ts
index 610ce63..c13fbf6 100644
--- a/src/network/client/nchanmessagerelay.ts
+++ b/src/network/client/nchanmessagerelay.ts
@@ -53,14 +53,19 @@ export class NchanMessageRelay implements MessageRelay {
     })
   }

   async getOnlineCount(): Promise<number | null> {
     try {
-      const response = await fetch(`https://${this.baseURL}/basic_status`)
-      const text = await response.text()
-      const match = text.match(/Active connections:\s+(\d+)/)
-      return match ? Number.parseInt(match[1], 10) - 1 : null
+      const response = await fetch(
+        `https://${this.baseURL}/publish/presence/lobby`,
+        {
+          method: "POST",
+          headers: { Accept: "application/json" },
+        }
+      )
+      const data = await response.json()
+      return typeof data.subscribers === "number" ? data.subscribers : null
     } catch {
       return null
     }
   }
 }
diff --git a/src/view/lobbyindicator.ts b/src/view/lobbyindicator.ts
index fef6673..9b1e626 100644
--- a/src/view/lobbyindicator.ts
+++ b/src/view/lobbyindicator.ts
@@ -16,25 +16,9 @@ export class LobbyIndicator {
       if (count !== null && this.element) {
         this.element.textContent = ` ${count} ðŸ‘¥`
       }
     }

-    // Initial update
     await refresh()
-
-    // Subscribe to lobby for updates
-    this.relay.subscribe(
-      "lobby",
-      (message) => {
-        try {
-          const data = JSON.parse(message)
-          if (data.action === "connected") {
-            refresh()
-          }
-        } catch {
-          // Ignore non-JSON messages
-        }
-      },
-      "lobby"
-    )
+    setInterval(refresh, 5 * 60 * 1000)
   }
 }
diff --git a/test/network/client/nchanmessagerelay.spec.ts b/test/network/client/nchanmessagerelay.spec.ts
index ed10750..a29293a 100644
--- a/test/network/client/nchanmessagerelay.spec.ts
+++ b/test/network/client/nchanmessagerelay.spec.ts
@@ -7,25 +7,28 @@ describe("NchanMessageRelay", () => {
     mockFetch = jest.fn()
     globalThis.fetch = mockFetch
   })

   describe("getOnlineCount", () => {
-    it("should return the number of active connections minus one", async () => {
+    it("should return the subscribers count from JSON response", async () => {
       const relay = new NchanMessageRelay("test.com")
       mockFetch.mockResolvedValueOnce({
-        text: () => Promise.resolve("Active connections: 10"),
+        json: () => Promise.resolve({ subscribers: 6 }),
       })

       const count = await relay.getOnlineCount()
-      expect(count).toBe(9)
-      expect(mockFetch).toHaveBeenCalledWith("https://test.com/basic_status")
+      expect(count).toBe(6)
+      expect(mockFetch).toHaveBeenCalledWith(
+        "https://test.com/publish/presence/lobby",
+        { method: "POST", headers: { Accept: "application/json" } }
+      )
     })

-    it("should return null if no match is found", async () => {
+    it("should return null if subscribers field is missing", async () => {
       const relay = new NchanMessageRelay()
       mockFetch.mockResolvedValueOnce({
-        text: () => Promise.resolve("Some other text"),
+        json: () => Promise.resolve({ messages: 0 }),
       })

       const count = await relay.getOnlineCount()
       expect(count).toBeNull()
     })
diff --git a/test/view/lobbyindicator.spec.ts b/test/view/lobbyindicator.spec.ts
index b3676ea..26b0ada 100644
--- a/test/view/lobbyindicator.spec.ts
+++ b/test/view/lobbyindicator.spec.ts
@@ -16,33 +16,13 @@ describe("LobbyIndicator", () => {
     const element = document.getElementById("lobby")
     if (element) {
       element.textContent = "ðŸ‘¥"
     }

-    // Mock getOnlineCount to return 5
     relay.getOnlineCount = async () => 5

     const indicator = new LobbyIndicator(relay)
     await indicator.init()

     expect(element?.textContent).to.equal(" 5 ðŸ‘¥")
   })
-
-  it("updates text content on message", async () => {
-    const element = document.getElementById("lobby")
-    relay.getOnlineCount = async () => 5
-
-    const indicator = new LobbyIndicator(relay)
-    await indicator.init()
-
-    expect(element?.textContent).to.equal(" 5 ðŸ‘¥")
-
-    // Change count and publish message
-    relay.getOnlineCount = async () => 6
-    relay.publish("lobby", JSON.stringify({ action: "connected" }), "lobby")
-
-    // Wait for async refresh
-    await new Promise((resolve) => setTimeout(resolve, 10))
-
-    expect(element?.textContent).to.equal(" 6 ðŸ‘¥")
-  })
 })
diff --git a/webpack.config.js b/webpack.config.js
index a31def5..ac421af 100644
--- a/webpack.config.js
+++ b/webpack.config.js
@@ -1,14 +1,15 @@
 const path = require("path")
 const TerserPlugin = require("terser-webpack-plugin")
 let packagedeps = require("./package.json")
 module.exports = {
   entry: {
-    index: "./src/index.ts",
-    diagram: "./src/diagrams.ts",
-    mathaven: "./src/mathaven.ts",
-    compare: "./src/compare.ts",
+    vendor: Object.keys(packagedeps.dependencies),
+    index: { dependOn: "vendor", import: "./src/index.ts" },
+    diagram: { dependOn: "vendor", import: "./src/diagrams.ts" },
+    mathaven: { dependOn: "vendor", import: "./src/mathaven.ts" },
+    compare: { dependOn: "vendor", import: "./src/compare.ts" },
   },
   module: {
     rules: [
       {
         use: "swc-loader",
@@ -31,21 +32,11 @@ module.exports = {
       progress: true,
     },
   },
   performance: { hints: false },
   mode: "production",
-  devtool: "source-map",
   optimization: {
-    splitChunks: {
-      cacheGroups: {
-        vendor: {
-          test: /[\\/]node_modules[\\/]/,
-          name: "vendor",
-          chunks: "all",
-        },
-      },
-    },
     minimize: true,
     minimizer: [
       new TerserPlugin({
         minify: TerserPlugin.swcMinify,
         extractComments: false,
@@ -53,11 +44,11 @@ module.exports = {
           safari10: true,
         },
       }),
     ],
     usedExports: true,
-    moduleIds: "deterministic",
+    moduleIds: "named",
   },
   stats: {
     errorDetails: true,
   },
   cache: {
diff --git a/yarn.lock b/yarn.lock
index 31c35ae..6e3455c 100644
--- a/yarn.lock
+++ b/yarn.lock
@@ -11,52 +11,52 @@
     "@csstools/css-color-parser" "^3.0.9"
     "@csstools/css-parser-algorithms" "^3.0.4"
     "@csstools/css-tokenizer" "^3.0.3"
     lru-cache "^10.4.3"

-"@babel/code-frame@^7.0.0", "@babel/code-frame@^7.10.4", "@babel/code-frame@^7.27.1", "@babel/code-frame@^7.28.6":
-  version "7.28.6"
-  resolved "https://registry.yarnpkg.com/@babel/code-frame/-/code-frame-7.28.6.tgz#72499312ec58b1e2245ba4a4f550c132be4982f7"
-  integrity sha512-JYgintcMjRiCvS8mMECzaEn+m3PfoQiyqukOMCCVQtoJGYJw8j/8LBJEiqkHLkfwCcs74E3pbAUFNg7d9VNJ+Q==
+"@babel/code-frame@^7.0.0", "@babel/code-frame@^7.10.4", "@babel/code-frame@^7.27.1", "@babel/code-frame@^7.28.6", "@babel/code-frame@^7.29.0":
+  version "7.29.0"
+  resolved "https://registry.yarnpkg.com/@babel/code-frame/-/code-frame-7.29.0.tgz#7cd7a59f15b3cc0dcd803038f7792712a7d0b15c"
+  integrity sha512-9NhCeYjq9+3uxgdtp20LSiJXJvN0FeCtNGpJxuMFZ1Kv3cWUNb6DOhJwUvcVCzKGR66cw4njwM6hrJLqgOwbcw==
   dependencies:
     "@babel/helper-validator-identifier" "^7.28.5"
     js-tokens "^4.0.0"
     picocolors "^1.1.1"

 "@babel/compat-data@^7.28.6":
-  version "7.28.6"
-  resolved "https://registry.yarnpkg.com/@babel/compat-data/-/compat-data-7.28.6.tgz#103f466803fa0f059e82ccac271475470570d74c"
-  integrity sha512-2lfu57JtzctfIrcGMz992hyLlByuzgIk58+hhGCxjKZ3rWI82NnVLjXcaTqkI2NvlcvOskZaiZ5kjUALo3Lpxg==
+  version "7.29.0"
+  resolved "https://registry.yarnpkg.com/@babel/compat-data/-/compat-data-7.29.0.tgz#00d03e8c0ac24dd9be942c5370990cbe1f17d88d"
+  integrity sha512-T1NCJqT/j9+cn8fvkt7jtwbLBfLC/1y1c7NtCeXFRgzGTsafi68MRv8yzkYSapBnFA6L3U2VSc02ciDzoAJhJg==

 "@babel/core@^7.23.9", "@babel/core@^7.27.4":
-  version "7.28.6"
-  resolved "https://registry.yarnpkg.com/@babel/core/-/core-7.28.6.tgz#531bf883a1126e53501ba46eb3bb414047af507f"
-  integrity sha512-H3mcG6ZDLTlYfaSNi0iOKkigqMFvkTKlGUYlD8GW7nNOYRrevuA46iTypPyv+06V3fEmvvazfntkBU34L0azAw==
+  version "7.29.0"
+  resolved "https://registry.yarnpkg.com/@babel/core/-/core-7.29.0.tgz#5286ad785df7f79d656e88ce86e650d16ca5f322"
+  integrity sha512-CGOfOJqWjg2qW/Mb6zNsDm+u5vFQ8DxXfbM09z69p5Z6+mE1ikP2jUXw+j42Pf1XTYED2Rni5f95npYeuwMDQA==
   dependencies:
-    "@babel/code-frame" "^7.28.6"
-    "@babel/generator" "^7.28.6"
+    "@babel/code-frame" "^7.29.0"
+    "@babel/generator" "^7.29.0"
     "@babel/helper-compilation-targets" "^7.28.6"
     "@babel/helper-module-transforms" "^7.28.6"
     "@babel/helpers" "^7.28.6"
-    "@babel/parser" "^7.28.6"
+    "@babel/parser" "^7.29.0"
     "@babel/template" "^7.28.6"
-    "@babel/traverse" "^7.28.6"
-    "@babel/types" "^7.28.6"
+    "@babel/traverse" "^7.29.0"
+    "@babel/types" "^7.29.0"
     "@jridgewell/remapping" "^2.3.5"
     convert-source-map "^2.0.0"
     debug "^4.1.0"
     gensync "^1.0.0-beta.2"
     json5 "^2.2.3"
     semver "^6.3.1"

-"@babel/generator@^7.27.5", "@babel/generator@^7.28.6":
-  version "7.28.6"
-  resolved "https://registry.yarnpkg.com/@babel/generator/-/generator-7.28.6.tgz#48dcc65d98fcc8626a48f72b62e263d25fc3c3f1"
-  integrity sha512-lOoVRwADj8hjf7al89tvQ2a1lf53Z+7tiXMgpZJL3maQPDxh0DgLMN62B2MKUOFcoodBHLMbDM6WAbKgNy5Suw==
+"@babel/generator@^7.27.5", "@babel/generator@^7.29.0":
+  version "7.29.1"
+  resolved "https://registry.yarnpkg.com/@babel/generator/-/generator-7.29.1.tgz#d09876290111abbb00ef962a7b83a5307fba0d50"
+  integrity sha512-qsaF+9Qcm2Qv8SRIMMscAvG4O3lJ0F1GuMo5HR/Bp02LopNgnZBC/EkbevHFeGs4ls/oPz9v+Bsmzbkbe+0dUw==
   dependencies:
-    "@babel/parser" "^7.28.6"
-    "@babel/types" "^7.28.6"
+    "@babel/parser" "^7.29.0"
+    "@babel/types" "^7.29.0"
     "@jridgewell/gen-mapping" "^0.3.12"
     "@jridgewell/trace-mapping" "^0.3.28"
     jsesc "^3.0.2"

 "@babel/helper-compilation-targets@^7.28.6":
@@ -118,16 +118,16 @@
   integrity sha512-xOBvwq86HHdB7WUDTfKfT/Vuxh7gElQ+Sfti2Cy6yIWNW05P8iUslOVcZ4/sKbE+/jQaukQAdz/gf3724kYdqw==
   dependencies:
     "@babel/template" "^7.28.6"
     "@babel/types" "^7.28.6"

-"@babel/parser@^7.1.0", "@babel/parser@^7.20.7", "@babel/parser@^7.23.9", "@babel/parser@^7.28.6":
-  version "7.28.6"
-  resolved "https://registry.yarnpkg.com/@babel/parser/-/parser-7.28.6.tgz#f01a8885b7fa1e56dd8a155130226cd698ef13fd"
-  integrity sha512-TeR9zWR18BvbfPmGbLampPMW+uW1NZnJlRuuHso8i87QZNq2JRF9i6RgxRqtEq+wQGsS19NNTWr2duhnE49mfQ==
+"@babel/parser@^7.1.0", "@babel/parser@^7.20.7", "@babel/parser@^7.23.9", "@babel/parser@^7.28.6", "@babel/parser@^7.29.0":
+  version "7.29.0"
+  resolved "https://registry.yarnpkg.com/@babel/parser/-/parser-7.29.0.tgz#669ef345add7d057e92b7ed15f0bac07611831b6"
+  integrity sha512-IyDgFV5GeDUVX4YdF/3CPULtVGSXXMLh1xVIgdCgxApktqnQV0r7/8Nqthg+8YLGaAtdyIlo2qIdZrbCv4+7ww==
   dependencies:
-    "@babel/types" "^7.28.6"
+    "@babel/types" "^7.29.0"

 "@babel/plugin-syntax-async-generators@^7.8.4":
   version "7.8.4"
   resolved "https://registry.yarnpkg.com/@babel/plugin-syntax-async-generators/-/plugin-syntax-async-generators-7.8.4.tgz#a983fb1aeb2ec3f6ed042a210f640e90e786fe0d"
   integrity sha512-tycmZxkGfZaxhMRbXlPXuVFpdWlXpir2W4AMhSJgRKzk/eDlIXOhb2LHWoLpDF7TEHylV5zNhykX6KAgHJmTNw==
@@ -258,27 +258,27 @@
   dependencies:
     "@babel/code-frame" "^7.28.6"
     "@babel/parser" "^7.28.6"
     "@babel/types" "^7.28.6"

-"@babel/traverse@^7.28.6":
-  version "7.28.6"
-  resolved "https://registry.yarnpkg.com/@babel/traverse/-/traverse-7.28.6.tgz#871ddc79a80599a5030c53b1cc48cbe3a5583c2e"
-  integrity sha512-fgWX62k02qtjqdSNTAGxmKYY/7FSL9WAS1o2Hu5+I5m9T0yxZzr4cnrfXQ/MX0rIifthCSs6FKTlzYbJcPtMNg==
+"@babel/traverse@^7.28.6", "@babel/traverse@^7.29.0":
+  version "7.29.0"
+  resolved "https://registry.yarnpkg.com/@babel/traverse/-/traverse-7.29.0.tgz#f323d05001440253eead3c9c858adbe00b90310a"
+  integrity sha512-4HPiQr0X7+waHfyXPZpWPfWL/J7dcN1mx9gL6WdQVMbPnF3+ZhSMs8tCxN7oHddJE9fhNE7+lxdnlyemKfJRuA==
   dependencies:
-    "@babel/code-frame" "^7.28.6"
-    "@babel/generator" "^7.28.6"
+    "@babel/code-frame" "^7.29.0"
+    "@babel/generator" "^7.29.0"
     "@babel/helper-globals" "^7.28.0"
-    "@babel/parser" "^7.28.6"
+    "@babel/parser" "^7.29.0"
     "@babel/template" "^7.28.6"
-    "@babel/types" "^7.28.6"
+    "@babel/types" "^7.29.0"
     debug "^4.3.1"

-"@babel/types@^7.0.0", "@babel/types@^7.20.7", "@babel/types@^7.27.3", "@babel/types@^7.28.2", "@babel/types@^7.28.6":
-  version "7.28.6"
-  resolved "https://registry.yarnpkg.com/@babel/types/-/types-7.28.6.tgz#c3e9377f1b155005bcc4c46020e7e394e13089df"
-  integrity sha512-0ZrskXVEHSWIqZM/sQZ4EV3jZJXRkio/WCxaqKZP1g//CEWEPSfeZFcms4XeKBCHU0ZKnIkdJeU/kF+eRp5lBg==
+"@babel/types@^7.0.0", "@babel/types@^7.20.7", "@babel/types@^7.27.3", "@babel/types@^7.28.2", "@babel/types@^7.28.6", "@babel/types@^7.29.0":
+  version "7.29.0"
+  resolved "https://registry.yarnpkg.com/@babel/types/-/types-7.29.0.tgz#9f5b1e838c446e72cf3cd4b918152b8c605e37c7"
+  integrity sha512-LwdZHpScM4Qz8Xw2iKSzS+cfglZzJGvofQICy7W7v4caru4EaAmyUuO6BGrbyQ2mYV11W0U8j5mBhd14dd3B0A==
   dependencies:
     "@babel/helper-string-parser" "^7.27.1"
     "@babel/helper-validator-identifier" "^7.28.5"

 "@bcoe/v8-coverage@^0.2.3":
@@ -456,10 +456,15 @@
     strip-ansi "^7.0.1"
     strip-ansi-cjs "npm:strip-ansi@^6.0.1"
     wrap-ansi "^8.1.0"
     wrap-ansi-cjs "npm:wrap-ansi@^7.0.0"

+"@isaacs/cliui@^9.0.0":
+  version "9.0.0"
+  resolved "https://registry.yarnpkg.com/@isaacs/cliui/-/cliui-9.0.0.tgz#4d0a3f127058043bf2e7ee169eaf30ed901302f3"
+  integrity sha512-AokJm4tuBHillT+FpMtxQ60n8ObyXBatq7jD2/JA9dxbDDokKQm8KMht5ibGzLVU9IJDIKK4TPKgMHEYMn3lMg==
+
 "@istanbuljs/load-nyc-config@^1.0.0":
   version "1.1.0"
   resolved "https://registry.yarnpkg.com/@istanbuljs/load-nyc-config/-/load-nyc-config-1.1.0.tgz#fd3db1d59ecf7cf121e80650bb86712f9b55eced"
   integrity sha512-VjeHSlIzpv/NyD3N0YuHfXOPDIixcA1q2ZV98wsMqcYlPmv2n3Yb2lYP9XMElnaFVXg5A7YLTeLu6V84uQDjmQ==
   dependencies:
@@ -762,34 +767,34 @@
   integrity sha512-zzNR+SdQSDJzc8joaeP8QQoCQr8NuYx2dIIytl1QeBEZHJ9uW6hebsrYgbz8hJwUQao3TWCMtmfV8Nu1twOLAw==
   dependencies:
     "@jridgewell/resolve-uri" "^3.1.0"
     "@jridgewell/sourcemap-codec" "^1.4.14"

-"@jsonjoy.com/base64@17.65.0":
-  version "17.65.0"
-  resolved "https://registry.yarnpkg.com/@jsonjoy.com/base64/-/base64-17.65.0.tgz#ba3b023c69ab311e5b706289414a44ee46117824"
-  integrity sha512-Xrh7Fm/M0QAYpekSgmskdZYnFdSGnsxJ/tHaolA4bNwWdG9i65S8m83Meh7FOxyJyQAdo4d4J97NOomBLEfkDQ==
+"@jsonjoy.com/base64@17.67.0":
+  version "17.67.0"
+  resolved "https://registry.yarnpkg.com/@jsonjoy.com/base64/-/base64-17.67.0.tgz#7eeda3cb41138d77a90408fd2e42b2aba10576d7"
+  integrity sha512-5SEsJGsm15aP8TQGkDfJvz9axgPwAEm98S5DxOuYe8e1EbfajcDmgeXXzccEjh+mLnjqEKrkBdjHWS5vFNwDdw==

 "@jsonjoy.com/base64@^1.1.2":
   version "1.1.2"
   resolved "https://registry.yarnpkg.com/@jsonjoy.com/base64/-/base64-1.1.2.tgz#cf8ea9dcb849b81c95f14fc0aaa151c6b54d2578"
   integrity sha512-q6XAnWQDIMA3+FTiOYajoYqySkO+JSat0ytXGSuRdq9uXE7o92gzuQwQM14xaCRlBLGq3v5miDGC4vkVTn54xA==

-"@jsonjoy.com/buffers@17.65.0", "@jsonjoy.com/buffers@^17.65.0":
-  version "17.65.0"
-  resolved "https://registry.yarnpkg.com/@jsonjoy.com/buffers/-/buffers-17.65.0.tgz#d6890737d9cbc49c17e2c5d1a2d796c57205152c"
-  integrity sha512-eBrIXd0/Ld3p9lpDDlMaMn6IEfWqtHMD+z61u0JrIiPzsV1r7m6xDZFRxJyvIFTEO+SWdYF9EiQbXZGd8BzPfA==
+"@jsonjoy.com/buffers@17.67.0", "@jsonjoy.com/buffers@^17.65.0":
+  version "17.67.0"
+  resolved "https://registry.yarnpkg.com/@jsonjoy.com/buffers/-/buffers-17.67.0.tgz#5c58dbcdeea8824ce296bd1cfce006c2eb167b3d"
+  integrity sha512-tfExRpYxBvi32vPs9ZHaTjSP4fHAfzSmcahOfNxtvGHcyJel+aibkPlGeBB+7AoC6hL7lXIE++8okecBxx7lcw==

 "@jsonjoy.com/buffers@^1.0.0", "@jsonjoy.com/buffers@^1.2.0":
   version "1.2.1"
   resolved "https://registry.yarnpkg.com/@jsonjoy.com/buffers/-/buffers-1.2.1.tgz#8d99c7f67eaf724d3428dfd9826c6455266a5c83"
   integrity sha512-12cdlDwX4RUM3QxmUbVJWqZ/mrK6dFQH4Zxq6+r1YXKXYBNgZXndx2qbCJwh3+WWkCSn67IjnlG3XYTvmvYtgA==

-"@jsonjoy.com/codegen@17.65.0":
-  version "17.65.0"
-  resolved "https://registry.yarnpkg.com/@jsonjoy.com/codegen/-/codegen-17.65.0.tgz#531524f37fd3e1d1189de18fef346e998eee8952"
-  integrity sha512-7MXcRYe7n3BG+fo3jicvjB0+6ypl2Y/bQp79Sp7KeSiiCgLqw4Oled6chVv07/xLVTdo3qa1CD0VCCnPaw+RGA==
+"@jsonjoy.com/codegen@17.67.0":
+  version "17.67.0"
+  resolved "https://registry.yarnpkg.com/@jsonjoy.com/codegen/-/codegen-17.67.0.tgz#3635fd8769d77e19b75dc5574bc9756019b2e591"
+  integrity sha512-idnkUplROpdBOV0HMcwhsCUS5TRUi9poagdGs70A6S4ux9+/aPuKbh8+UYRTLYQHtXvAdNfQWXDqZEx5k4Dj2Q==

 "@jsonjoy.com/codegen@^1.0.0":
   version "1.0.0"
   resolved "https://registry.yarnpkg.com/@jsonjoy.com/codegen/-/codegen-1.0.0.tgz#5c23f796c47675f166d23b948cdb889184b93207"
   integrity sha512-E8Oy+08cmCf0EK/NMxpaJZmOxPqM+6iSe2S4nlSBrPZOORoDJILxtbSUEDKQyTamm/BVAhIGllOBNU79/dwf0g==
@@ -878,45 +883,45 @@
     hyperdyperid "^1.2.0"
     thingies "^2.5.0"
     tree-dump "^1.1.0"

 "@jsonjoy.com/json-pack@^17.65.0":
-  version "17.65.0"
-  resolved "https://registry.yarnpkg.com/@jsonjoy.com/json-pack/-/json-pack-17.65.0.tgz#4ea06dd0aee1c29954bd978c4f107401dbf713fb"
-  integrity sha512-e0SG/6qUCnVhHa0rjDJHgnXnbsacooHVqQHxspjvlYQSkHm+66wkHw6Gql+3u/WxI/b1VsOdUi0M+fOtkgKGdQ==
-  dependencies:
-    "@jsonjoy.com/base64" "17.65.0"
-    "@jsonjoy.com/buffers" "17.65.0"
-    "@jsonjoy.com/codegen" "17.65.0"
-    "@jsonjoy.com/json-pointer" "17.65.0"
-    "@jsonjoy.com/util" "17.65.0"
+  version "17.67.0"
+  resolved "https://registry.yarnpkg.com/@jsonjoy.com/json-pack/-/json-pack-17.67.0.tgz#8dd8ff65dd999c5d4d26df46c63915c7bdec093a"
+  integrity sha512-t0ejURcGaZsn1ClbJ/3kFqSOjlryd92eQY465IYrezsXmPcfHPE/av4twRSxf6WE+TkZgLY+71vCZbiIiFKA/w==
+  dependencies:
+    "@jsonjoy.com/base64" "17.67.0"
+    "@jsonjoy.com/buffers" "17.67.0"
+    "@jsonjoy.com/codegen" "17.67.0"
+    "@jsonjoy.com/json-pointer" "17.67.0"
+    "@jsonjoy.com/util" "17.67.0"
     hyperdyperid "^1.2.0"
     thingies "^2.5.0"
     tree-dump "^1.1.0"

-"@jsonjoy.com/json-pointer@17.65.0":
-  version "17.65.0"
-  resolved "https://registry.yarnpkg.com/@jsonjoy.com/json-pointer/-/json-pointer-17.65.0.tgz#4bad42d86c9ee0ad1758c082b065bd5e16f8dc36"
-  integrity sha512-uhTe+XhlIZpWOxgPcnO+iSCDgKKBpwkDVTyYiXX9VayGV8HSFVJM67M6pUE71zdnXF1W0Da21AvnhlmdwYPpow==
+"@jsonjoy.com/json-pointer@17.67.0":
+  version "17.67.0"
+  resolved "https://registry.yarnpkg.com/@jsonjoy.com/json-pointer/-/json-pointer-17.67.0.tgz#74439573dc046e0c9a3a552fb94b391bc75313b8"
+  integrity sha512-+iqOFInH+QZGmSuaybBUNdh7yvNrXvqR+h3wjXm0N/3JK1EyyFAeGJvqnmQL61d1ARLlk/wJdFKSL+LHJ1eaUA==
   dependencies:
-    "@jsonjoy.com/util" "17.65.0"
+    "@jsonjoy.com/util" "17.67.0"

 "@jsonjoy.com/json-pointer@^1.0.2":
   version "1.0.2"
   resolved "https://registry.yarnpkg.com/@jsonjoy.com/json-pointer/-/json-pointer-1.0.2.tgz#049cb530ac24e84cba08590c5e36b431c4843408"
   integrity sha512-Fsn6wM2zlDzY1U+v4Nc8bo3bVqgfNTGcn6dMgs6FjrEnt4ZCe60o6ByKRjOGlI2gow0aE/Q41QOigdTqkyK5fg==
   dependencies:
     "@jsonjoy.com/codegen" "^1.0.0"
     "@jsonjoy.com/util" "^1.9.0"

-"@jsonjoy.com/util@17.65.0", "@jsonjoy.com/util@^17.65.0":
-  version "17.65.0"
-  resolved "https://registry.yarnpkg.com/@jsonjoy.com/util/-/util-17.65.0.tgz#b27832bdf7aeaf4a36f9cb8721cb4ffb086f06a1"
-  integrity sha512-cWiEHZccQORf96q2y6zU3wDeIVPeidmGqd9cNKJRYoVHTV0S1eHPy5JTbHpMnGfDvtvujQwQozOqgO9ABu6h0w==
+"@jsonjoy.com/util@17.67.0", "@jsonjoy.com/util@^17.65.0":
+  version "17.67.0"
+  resolved "https://registry.yarnpkg.com/@jsonjoy.com/util/-/util-17.67.0.tgz#7c4288fc3808233e55c7610101e7bb4590cddd3f"
+  integrity sha512-6+8xBaz1rLSohlGh68D1pdw3AwDi9xydm8QNlAFkvnavCJYSze+pxoW2VKP8p308jtlMRLs5NTHfPlZLd4w7ew==
   dependencies:
-    "@jsonjoy.com/buffers" "17.65.0"
-    "@jsonjoy.com/codegen" "17.65.0"
+    "@jsonjoy.com/buffers" "17.67.0"
+    "@jsonjoy.com/codegen" "17.67.0"

 "@jsonjoy.com/util@^1.9.0":
   version "1.9.0"
   resolved "https://registry.yarnpkg.com/@jsonjoy.com/util/-/util-1.9.0.tgz#7ee95586aed0a766b746cd8d8363e336c3c47c46"
   integrity sha512-pLuQo+VPRnN8hfPqUTLTHk126wuYdXVxE6aDmjSeV4NCAgyxWbiOIeNJVtID3h1Vzpoi9m4jXezf73I6LgabgQ==
@@ -941,84 +946,84 @@
 "@noble/hashes@1.4.0":
   version "1.4.0"
   resolved "https://registry.yarnpkg.com/@noble/hashes/-/hashes-1.4.0.tgz#45814aa329f30e4fe0ba49426f49dfccdd066426"
   integrity sha512-V1JJ1WTRUqHHrOSh597hURcMqVKVGL/ea3kv0gSnEdsEZ0/+VyPghM1lMNGc00z7CIQorSvbKpuJkxvuHbvdbg==

-"@peculiar/asn1-cms@^2.6.0":
-  version "2.6.0"
-  resolved "https://registry.yarnpkg.com/@peculiar/asn1-cms/-/asn1-cms-2.6.0.tgz#88267055c460ca806651f916315a934c1b1ac994"
-  integrity sha512-2uZqP+ggSncESeUF/9Su8rWqGclEfEiz1SyU02WX5fUONFfkjzS2Z/F1Li0ofSmf4JqYXIOdCAZqIXAIBAT1OA==
+"@peculiar/asn1-cms@^2.6.0", "@peculiar/asn1-cms@^2.6.1":
+  version "2.6.1"
+  resolved "https://registry.yarnpkg.com/@peculiar/asn1-cms/-/asn1-cms-2.6.1.tgz#cb5445c1bad9197d176073bf142a5c035b460640"
+  integrity sha512-vdG4fBF6Lkirkcl53q6eOdn3XYKt+kJTG59edgRZORlg/3atWWEReRCx5rYE1ZzTTX6vLK5zDMjHh7vbrcXGtw==
   dependencies:
     "@peculiar/asn1-schema" "^2.6.0"
-    "@peculiar/asn1-x509" "^2.6.0"
-    "@peculiar/asn1-x509-attr" "^2.6.0"
+    "@peculiar/asn1-x509" "^2.6.1"
+    "@peculiar/asn1-x509-attr" "^2.6.1"
     asn1js "^3.0.6"
     tslib "^2.8.1"

 "@peculiar/asn1-csr@^2.6.0":
-  version "2.6.0"
-  resolved "https://registry.yarnpkg.com/@peculiar/asn1-csr/-/asn1-csr-2.6.0.tgz#a7eff845b0020720070a12f38f26effb9fdab158"
-  integrity sha512-BeWIu5VpTIhfRysfEp73SGbwjjoLL/JWXhJ/9mo4vXnz3tRGm+NGm3KNcRzQ9VMVqwYS2RHlolz21svzRXIHPQ==
+  version "2.6.1"
+  resolved "https://registry.yarnpkg.com/@peculiar/asn1-csr/-/asn1-csr-2.6.1.tgz#9629d403bc5a61254f28ed0b90e99cee61c0e8be"
+  integrity sha512-WRWnKfIocHyzFYQTka8O/tXCiBquAPSrRjXbOkHbO4qdmS6loffCEGs+rby6WxxGdJCuunnhS2duHURhjyio6w==
   dependencies:
     "@peculiar/asn1-schema" "^2.6.0"
-    "@peculiar/asn1-x509" "^2.6.0"
+    "@peculiar/asn1-x509" "^2.6.1"
     asn1js "^3.0.6"
     tslib "^2.8.1"

 "@peculiar/asn1-ecc@^2.6.0":
-  version "2.6.0"
-  resolved "https://registry.yarnpkg.com/@peculiar/asn1-ecc/-/asn1-ecc-2.6.0.tgz#4846d39712a1a2b4786c2d6ea27b19a6dcc05ef5"
-  integrity sha512-FF3LMGq6SfAOwUG2sKpPXblibn6XnEIKa+SryvUl5Pik+WR9rmRA3OCiwz8R3lVXnYnyRkSZsSLdml8H3UiOcw==
+  version "2.6.1"
+  resolved "https://registry.yarnpkg.com/@peculiar/asn1-ecc/-/asn1-ecc-2.6.1.tgz#d29c4af671508a9934edc78e7c9419fbf7bc9870"
+  integrity sha512-+Vqw8WFxrtDIN5ehUdvlN2m73exS2JVG0UAyfVB31gIfor3zWEAQPD+K9ydCxaj3MLen9k0JhKpu9LqviuCE1g==
   dependencies:
     "@peculiar/asn1-schema" "^2.6.0"
-    "@peculiar/asn1-x509" "^2.6.0"
+    "@peculiar/asn1-x509" "^2.6.1"
     asn1js "^3.0.6"
     tslib "^2.8.1"

-"@peculiar/asn1-pfx@^2.6.0":
-  version "2.6.0"
-  resolved "https://registry.yarnpkg.com/@peculiar/asn1-pfx/-/asn1-pfx-2.6.0.tgz#4c8ed3050cdd5b3e63ec4192bf8f646d9e06e3f5"
-  integrity sha512-rtUvtf+tyKGgokHHmZzeUojRZJYPxoD/jaN1+VAB4kKR7tXrnDCA/RAWXAIhMJJC+7W27IIRGe9djvxKgsldCQ==
+"@peculiar/asn1-pfx@^2.6.1":
+  version "2.6.1"
+  resolved "https://registry.yarnpkg.com/@peculiar/asn1-pfx/-/asn1-pfx-2.6.1.tgz#75cddd14d43ef875109e91ea150377d679c8fbc1"
+  integrity sha512-nB5jVQy3MAAWvq0KY0R2JUZG8bO/bTLpnwyOzXyEh/e54ynGTatAR+csOnXkkVD9AFZ2uL8Z7EV918+qB1qDvw==
   dependencies:
-    "@peculiar/asn1-cms" "^2.6.0"
-    "@peculiar/asn1-pkcs8" "^2.6.0"
-    "@peculiar/asn1-rsa" "^2.6.0"
+    "@peculiar/asn1-cms" "^2.6.1"
+    "@peculiar/asn1-pkcs8" "^2.6.1"
+    "@peculiar/asn1-rsa" "^2.6.1"
     "@peculiar/asn1-schema" "^2.6.0"
     asn1js "^3.0.6"
     tslib "^2.8.1"

-"@peculiar/asn1-pkcs8@^2.6.0":
-  version "2.6.0"
-  resolved "https://registry.yarnpkg.com/@peculiar/asn1-pkcs8/-/asn1-pkcs8-2.6.0.tgz#c426caf81cb49935c553b591e0273b4b44d1696f"
-  integrity sha512-KyQ4D8G/NrS7Fw3XCJrngxmjwO/3htnA0lL9gDICvEQ+GJ+EPFqldcJQTwPIdvx98Tua+WjkdKHSC0/Km7T+lA==
+"@peculiar/asn1-pkcs8@^2.6.1":
+  version "2.6.1"
+  resolved "https://registry.yarnpkg.com/@peculiar/asn1-pkcs8/-/asn1-pkcs8-2.6.1.tgz#bd56b4bb9e8a3702369049713a89134c87c6931a"
+  integrity sha512-JB5iQ9Izn5yGMw3ZG4Nw3Xn/hb/G38GYF3lf7WmJb8JZUydhVGEjK/ZlFSWhnlB7K/4oqEs8HnfFIKklhR58Tw==
   dependencies:
     "@peculiar/asn1-schema" "^2.6.0"
-    "@peculiar/asn1-x509" "^2.6.0"
+    "@peculiar/asn1-x509" "^2.6.1"
     asn1js "^3.0.6"
     tslib "^2.8.1"

 "@peculiar/asn1-pkcs9@^2.6.0":
-  version "2.6.0"
-  resolved "https://registry.yarnpkg.com/@peculiar/asn1-pkcs9/-/asn1-pkcs9-2.6.0.tgz#96b57122228a0e2e30e81118cd3baa570c13a51d"
-  integrity sha512-b78OQ6OciW0aqZxdzliXGYHASeCvvw5caqidbpQRYW2mBtXIX2WhofNXTEe7NyxTb0P6J62kAAWLwn0HuMF1Fw==
+  version "2.6.1"
+  resolved "https://registry.yarnpkg.com/@peculiar/asn1-pkcs9/-/asn1-pkcs9-2.6.1.tgz#ddc5222952f25b59a0562a6f8cabdb72f586a496"
+  integrity sha512-5EV8nZoMSxeWmcxWmmcolg22ojZRgJg+Y9MX2fnE2bGRo5KQLqV5IL9kdSQDZxlHz95tHvIq9F//bvL1OeNILw==
   dependencies:
-    "@peculiar/asn1-cms" "^2.6.0"
-    "@peculiar/asn1-pfx" "^2.6.0"
-    "@peculiar/asn1-pkcs8" "^2.6.0"
+    "@peculiar/asn1-cms" "^2.6.1"
+    "@peculiar/asn1-pfx" "^2.6.1"
+    "@peculiar/asn1-pkcs8" "^2.6.1"
     "@peculiar/asn1-schema" "^2.6.0"
-    "@peculiar/asn1-x509" "^2.6.0"
-    "@peculiar/asn1-x509-attr" "^2.6.0"
+    "@peculiar/asn1-x509" "^2.6.1"
+    "@peculiar/asn1-x509-attr" "^2.6.1"
     asn1js "^3.0.6"
     tslib "^2.8.1"

-"@peculiar/asn1-rsa@^2.6.0":
-  version "2.6.0"
-  resolved "https://registry.yarnpkg.com/@peculiar/asn1-rsa/-/asn1-rsa-2.6.0.tgz#49d905ab67ae8aa54e996734f37a391bb7958747"
-  integrity sha512-Nu4C19tsrTsCp9fDrH+sdcOKoVfdfoQQ7S3VqjJU6vedR7tY3RLkQ5oguOIB3zFW33USDUuYZnPEQYySlgha4w==
+"@peculiar/asn1-rsa@^2.6.0", "@peculiar/asn1-rsa@^2.6.1":
+  version "2.6.1"
+  resolved "https://registry.yarnpkg.com/@peculiar/asn1-rsa/-/asn1-rsa-2.6.1.tgz#2cdf9f9ea6d6fdbaae214b9fed6de0534b654437"
+  integrity sha512-1nVMEh46SElUt5CB3RUTV4EG/z7iYc7EoaDY5ECwganibQPkZ/Y2eMsTKB/LeyrUJ+W/tKoD9WUqIy8vB+CEdA==
   dependencies:
     "@peculiar/asn1-schema" "^2.6.0"
-    "@peculiar/asn1-x509" "^2.6.0"
+    "@peculiar/asn1-x509" "^2.6.1"
     asn1js "^3.0.6"
     tslib "^2.8.1"

 "@peculiar/asn1-schema@^2.6.0":
   version "2.6.0"
@@ -1027,24 +1032,24 @@
   dependencies:
     asn1js "^3.0.6"
     pvtsutils "^1.3.6"
     tslib "^2.8.1"

-"@peculiar/asn1-x509-attr@^2.6.0":
-  version "2.6.0"
-  resolved "https://registry.yarnpkg.com/@peculiar/asn1-x509-attr/-/asn1-x509-attr-2.6.0.tgz#057cb0c3c600a259c9f40582ee5fd7f0114c5be6"
-  integrity sha512-MuIAXFX3/dc8gmoZBkwJWxUWOSvG4MMDntXhrOZpJVMkYX+MYc/rUAU2uJOved9iJEoiUx7//3D8oG83a78UJA==
+"@peculiar/asn1-x509-attr@^2.6.1":
+  version "2.6.1"
+  resolved "https://registry.yarnpkg.com/@peculiar/asn1-x509-attr/-/asn1-x509-attr-2.6.1.tgz#6425008b8099476010aace5b8ae9f9cbc41db0ab"
+  integrity sha512-tlW6cxoHwgcQghnJwv3YS+9OO1737zgPogZ+CgWRUK4roEwIPzRH4JEiG770xe5HX2ATfCpmX60gurfWIF9dcQ==
   dependencies:
     "@peculiar/asn1-schema" "^2.6.0"
-    "@peculiar/asn1-x509" "^2.6.0"
+    "@peculiar/asn1-x509" "^2.6.1"
     asn1js "^3.0.6"
     tslib "^2.8.1"

-"@peculiar/asn1-x509@^2.6.0":
-  version "2.6.0"
-  resolved "https://registry.yarnpkg.com/@peculiar/asn1-x509/-/asn1-x509-2.6.0.tgz#9aa0784b455ca34095fdc91a5cc52869e21528dd"
-  integrity sha512-uzYbPEpoQiBoTq0/+jZtpM6Gq6zADBx+JNFP3yqRgziWBxQ/Dt/HcuvRfm9zJTPdRcBqPNdaRHTVwpyiq6iNMA==
+"@peculiar/asn1-x509@^2.6.0", "@peculiar/asn1-x509@^2.6.1":
+  version "2.6.1"
+  resolved "https://registry.yarnpkg.com/@peculiar/asn1-x509/-/asn1-x509-2.6.1.tgz#4e8995659e16178e0e90fe90519aa269045af262"
+  integrity sha512-O9jT5F1A2+t3r7C4VT7LYGXqkGLK7Kj1xFpz7U0isPrubwU5PbDoyYtx6MiGst29yq7pXN5vZbQFKRCP+lLZlA==
   dependencies:
     "@peculiar/asn1-schema" "^2.6.0"
     asn1js "^3.0.6"
     pvtsutils "^1.3.6"
     tslib "^2.8.1"
@@ -1433,18 +1438,11 @@
 "@types/mime@^1":
   version "1.3.5"
   resolved "https://registry.yarnpkg.com/@types/mime/-/mime-1.3.5.tgz#1ef302e01cf7d2b5a0fa526790c9123bf1d06690"
   integrity sha512-/pyBZWSLD2n0dcHE3hq8s8ZvcETHtEuF+3E7XVt0Ig2nvsVQXdghHVcEkIWjy9A0wKfTn97a/PSDYohKIlnP/w==

-"@types/node@*":
-  version "25.1.0"
-  resolved "https://registry.yarnpkg.com/@types/node/-/node-25.1.0.tgz#95cc584f1f478301efc86de4f1867e5875e83571"
-  integrity sha512-t7frlewr6+cbx+9Ohpl0NOTKXZNV9xHRmNOvql47BFJKcEG1CxtxlPEEe+gR9uhVWM4DwhnvTF110mIL4yP9RA==
-  dependencies:
-    undici-types "~7.16.0"
-
-"@types/node@25.2.3":
+"@types/node@*", "@types/node@25.2.3":
   version "25.2.3"
   resolved "https://registry.yarnpkg.com/@types/node/-/node-25.2.3.tgz#9c18245be768bdb4ce631566c7da303a5c99a7f8"
   integrity sha512-m0jEgYlYz+mDJZ2+F4v8D1AyQb+QzsNqRuI7xg1VQX/KlKS0qT9r1Mo16yo5F/MtifXFgaofIFsdFMox2SxIbQ==
   dependencies:
     undici-types "~7.16.0"
@@ -2128,10 +2126,17 @@ babel-preset-jest@30.2.0:
 balanced-match@^1.0.0:
   version "1.0.2"
   resolved "https://registry.yarnpkg.com/balanced-match/-/balanced-match-1.0.2.tgz#e83e3a7e3f300b34cb9d87f615fa0cbf357690ee"
   integrity sha512-3oSeUO0TMV67hN1AmbXsK4yaqU7tjiHlbxRDZOpH0KW9+CeX4bRAaX0Anxt0tx2MrpRpWwQaPwIlISEJhYU5Pw==

+balanced-match@^4.0.2:
+  version "4.0.2"
+  resolved "https://registry.yarnpkg.com/balanced-match/-/balanced-match-4.0.2.tgz#241591ea634702bef9c482696f2469406e16d233"
+  integrity sha512-x0K50QvKQ97fdEz2kPehIerj+YTeptKF9hyYkKf6egnwmMWAkADiO0QCzSp0R5xN8FTZgYaBfSaue46Ej62nMg==
+  dependencies:
+    jackspeak "^4.2.3"
+
 base64-js@^1.3.1:
   version "1.5.1"
   resolved "https://registry.yarnpkg.com/base64-js/-/base64-js-1.5.1.tgz#1b1b440160a5bf7ad40b650f095963481903930a"
   integrity sha512-AKpaYlHn8t4SVbOHCy+b5+KKgvR4vrsD8vbvrbiQJps7fKDTkjkDry6ji0rUJjC0kzbNePLwzxq8iypo41qeWA==

@@ -2198,10 +2203,17 @@ brace-expansion@^2.0.1:
   resolved "https://registry.yarnpkg.com/brace-expansion/-/brace-expansion-2.0.2.tgz#54fc53237a613d854c7bd37463aad17df87214e7"
   integrity sha512-Jt0vHyM+jmUBqojB7E1NIYadt0vI0Qxjxd2TErW94wDz+E2LAm5vKMXXwg6ZZBTHPuUlDgQHKXvjGBdfcF1ZDQ==
   dependencies:
     balanced-match "^1.0.0"

+brace-expansion@^5.0.2:
+  version "5.0.2"
+  resolved "https://registry.yarnpkg.com/brace-expansion/-/brace-expansion-5.0.2.tgz#b6c16d0791087af6c2bc463f52a8142046c06b6f"
+  integrity sha512-Pdk8c9poy+YhOgVWw1JNN22/HcivgKWwpxKq04M/jTmHyCZn12WPJebZxdjSa5TmBqISrUSgNYU3eRORljfCCw==
+  dependencies:
+    balanced-match "^4.0.2"
+
 braces@^3.0.3, braces@~3.0.2:
   version "3.0.3"
   resolved "https://registry.yarnpkg.com/braces/-/braces-3.0.3.tgz#490332f40919452272d55a8480adc0c441358789"
   integrity sha512-yQbXgO/OSZVD2IsiLlro+7Hf6Q18EJrKSEsdoMzKePKXct3gvD8oLcOQdIzGupr5Fj+EDe8gO/lxc1BzfMpxvA==
   dependencies:
@@ -2297,13 +2309,13 @@ camelcase@^6.3.0:
   version "6.3.0"
   resolved "https://registry.yarnpkg.com/camelcase/-/camelcase-6.3.0.tgz#5685b95eb209ac9c0c177467778c9c84df58ba9a"
   integrity sha512-Gmy6FhYlCY7uOElZUSbxo2UCDH8owEk996gkbrpsgGtrJLM3J7jGxl9Ic7Qwwj4ivOE5AWZWRMecDdF7hqGjFA==

 caniuse-lite@^1.0.30001759:
-  version "1.0.30001766"
-  resolved "https://registry.yarnpkg.com/caniuse-lite/-/caniuse-lite-1.0.30001766.tgz#b6f6b55cb25a2d888d9393104d14751c6a7d6f7a"
-  integrity sha512-4C0lfJ0/YPjJQHagaE9x2Elb69CIqEPZeG0anQt9SIvIoOH4a4uaRl73IavyO+0qZh6MDLH//DrXThEYKHkmYA==
+  version "1.0.30001769"
+  resolved "https://registry.yarnpkg.com/caniuse-lite/-/caniuse-lite-1.0.30001769.tgz#1ad91594fad7dc233777c2781879ab5409f7d9c2"
+  integrity sha512-BCfFL1sHijQlBGWBMuJyhZUhzo7wer5sVj9hqekB/7xn0Ypy+pER/edCYQm4exbXj4WiySGp40P8UuTh6w1srg==

 canvas@^3.2.1:
   version "3.2.1"
   resolved "https://registry.yarnpkg.com/canvas/-/canvas-3.2.1.tgz#8f0390569f36b94bffba9c0e7aed6948875aec7b"
   integrity sha512-ej1sPFR5+0YWtaVp6S1N1FVz69TQCqmrkGeRvQxZeAB1nAIcjNTHVwrZtYtWFFBmQsF40/uDLehsW5KuYC99mg==
@@ -2353,13 +2365,13 @@ chrome-trace-event@^1.0.2:
   version "1.0.4"
   resolved "https://registry.yarnpkg.com/chrome-trace-event/-/chrome-trace-event-1.0.4.tgz#05bffd7ff928465093314708c93bdfa9bd1f0f5b"
   integrity sha512-rNjApaLzuwaOTjCiT8lSDdGN1APCiqkChLMJxJPWLunPAt5fy8xgU9/jNOchV84wfIxrA0lRQB7oCT8jrn/wrQ==

 ci-info@^4.2.0:
-  version "4.3.1"
-  resolved "https://registry.yarnpkg.com/ci-info/-/ci-info-4.3.1.tgz#355ad571920810b5623e11d40232f443f16f1daa"
-  integrity sha512-Wdy2Igu8OcBpI2pZePZ5oWjPC38tmDVx5WKUXKwlLYkA0ozo85sLsLvkBbBn/sZaSCMFOGZJ14fvW9t5/d7kdA==
+  version "4.4.0"
+  resolved "https://registry.yarnpkg.com/ci-info/-/ci-info-4.4.0.tgz#7d54eff9f54b45b62401c26032696eb59c8bd18c"
+  integrity sha512-77PSwercCZU2Fc4sX94eF8k8Pxte6JAwL4/ICZLFjJLqegs7kCuAsqqj/70NQF6TvDpgFjkubQB2FW2ZZddvQg==

 cjs-module-lexer@^2.1.0:
   version "2.2.0"
   resolved "https://registry.yarnpkg.com/cjs-module-lexer/-/cjs-module-lexer-2.2.0.tgz#b3ca5101843389259ade7d88c77bd06ce55849ca"
   integrity sha512-4bHTS2YuzUvtoLjdy+98ykbNB5jS0+07EvFNXerqZQJ89F7DI6ET7OQo/HJuW6K0aVsKA9hj9/RVb2kQVOrPDQ==
@@ -2561,13 +2573,13 @@ default-browser-id@^5.0.0:
   version "5.0.1"
   resolved "https://registry.yarnpkg.com/default-browser-id/-/default-browser-id-5.0.1.tgz#f7a7ccb8f5104bf8e0f71ba3b1ccfa5eafdb21e8"
   integrity sha512-x1VCxdX4t+8wVfd1so/9w+vQ4vx7lKd2Qp5tDRutErwmR85OgmfX7RlLRMWafRMY7hbEiXIbudNrjOAPa/hL8Q==

 default-browser@^5.2.1:
-  version "5.4.0"
-  resolved "https://registry.yarnpkg.com/default-browser/-/default-browser-5.4.0.tgz#b55cf335bb0b465dd7c961a02cd24246aa434287"
-  integrity sha512-XDuvSq38Hr1MdN47EDvYtx3U0MTqpCEn+F6ft8z2vYDzMrvQhVp0ui9oQdqW3MvK3vqUETglt1tVGgjLuJ5izg==
+  version "5.5.0"
+  resolved "https://registry.yarnpkg.com/default-browser/-/default-browser-5.5.0.tgz#2792e886f2422894545947cc80e1a444496c5976"
+  integrity sha512-H9LMLr5zwIbSxrmvikGuI/5KGhZ8E2zH3stkMgM5LpOWDutGM2JZaj460Udnf1a+946zc7YBgrqEWwbk7zHvGw==
   dependencies:
     bundle-name "^4.1.0"
     default-browser-id "^5.0.0"

 define-lazy-prop@^3.0.0:
@@ -2675,13 +2687,13 @@ ee-first@1.1.1:
   version "1.1.1"
   resolved "https://registry.yarnpkg.com/ee-first/-/ee-first-1.1.1.tgz#590c61156b0ae2f4f0255732a158b266bc56b21d"
   integrity sha512-WMwm9LhRUo+WUaRN+vRuETqG89IgZphVSNkdFgeb6sS/E4OrDIN7t48CAewSHXc6C8lefD8KKfr5vY61brQlow==

 electron-to-chromium@^1.5.263:
-  version "1.5.279"
-  resolved "https://registry.yarnpkg.com/electron-to-chromium/-/electron-to-chromium-1.5.279.tgz#67dfdeb22fd81412d0d18d1d9b2c749e9b8945cb"
-  integrity sha512-0bblUU5UNdOt5G7XqGiJtpZMONma6WAfq9vsFmtn9x1+joAObr6x1chfqyxFSDCAFwFhCQDrqeAr6MYdpwJ9Hg==
+  version "1.5.286"
+  resolved "https://registry.yarnpkg.com/electron-to-chromium/-/electron-to-chromium-1.5.286.tgz#142be1ab5e1cd5044954db0e5898f60a4960384e"
+  integrity sha512-9tfDXhJ4RKFNerfjdCcZfufu49vg620741MNs26a9+bhLThdB+plgMeou98CAaHu/WATj2iHOOHTp1hWtABj2A==

 emittery@^0.13.1:
   version "0.13.1"
   resolved "https://registry.yarnpkg.com/emittery/-/emittery-0.13.1.tgz#c04b8c3457490e0847ae51fced3af52d338e3dad"
   integrity sha512-DeWwawk6r5yR9jFgnDKYt4sLS0LmHJJi3ZOnb5/JdbYwj3nW+FxQnHIjhBKz8YLC7oRNPVM9NQ47I3CVx34eqQ==
@@ -2706,19 +2718,11 @@ end-of-stream@^1.1.0, end-of-stream@^1.4.1:
   resolved "https://registry.yarnpkg.com/end-of-stream/-/end-of-stream-1.4.5.tgz#7344d711dea40e0b74abc2ed49778743ccedb08c"
   integrity sha512-ooEGc6HP26xXq/N+GCGOT0JKCLDGrq2bQUZrQ7gyrJiZANJ/8YDTxTpQBXGMn+WbIQXNVpyWymm7KYVICQnyOg==
   dependencies:
     once "^1.4.0"

-enhanced-resolve@^5.0.0:
-  version "5.18.4"
-  resolved "https://registry.yarnpkg.com/enhanced-resolve/-/enhanced-resolve-5.18.4.tgz#c22d33055f3952035ce6a144ce092447c525f828"
-  integrity sha512-LgQMM4WXU3QI+SYgEc2liRgznaD5ojbmY3sb8LxyguVkIg5FxdpTkvk72te2R38/TGKxH634oLxXRGY6d7AP+Q==
-  dependencies:
-    graceful-fs "^4.2.4"
-    tapable "^2.2.0"
-
-enhanced-resolve@^5.19.0:
+enhanced-resolve@^5.0.0, enhanced-resolve@^5.19.0:
   version "5.19.0"
   resolved "https://registry.yarnpkg.com/enhanced-resolve/-/enhanced-resolve-5.19.0.tgz#6687446a15e969eaa63c2fa2694510e17ae6d97c"
   integrity sha512-phv3E1Xl4tQOShqSte26C7Fl84EwUdZsyOuSSk9qtAGyyQs2s3jJzComh+Abf4g187lUUAvH+H26omrqia2aGg==
   dependencies:
     graceful-fs "^4.2.4"
@@ -3686,10 +3690,17 @@ jackspeak@^3.1.2:
   dependencies:
     "@isaacs/cliui" "^8.0.2"
   optionalDependencies:
     "@pkgjs/parseargs" "^0.11.0"

+jackspeak@^4.2.3:
+  version "4.2.3"
+  resolved "https://registry.yarnpkg.com/jackspeak/-/jackspeak-4.2.3.tgz#27ef80f33b93412037c3bea4f8eddf80e1931483"
+  integrity sha512-ykkVRwrYvFm1nb2AJfKKYPr0emF6IiXDYUaFx4Zn9ZuIH7MrzEZ3sD5RlqGXNRpHtvUHJyOnCEFxOlNDtGo7wg==
+  dependencies:
+    "@isaacs/cliui" "^9.0.0"
+
 jest-changed-files@30.2.0:
   version "30.2.0"
   resolved "https://registry.yarnpkg.com/jest-changed-files/-/jest-changed-files-30.2.0.tgz#602266e478ed554e1e1469944faa7efd37cee61c"
   integrity sha512-L8lR1ChrRnSdfeOvTrwZMlnWV8G/LLjQ0nG9MBclwWZidA2N5FviRki0Bvh20WRMOX31/JYvzdqTJrk5oBdydQ==
   dependencies:
@@ -4356,17 +4367,24 @@ mimic-response@^3.1.0:
 minimalistic-assert@^1.0.0:
   version "1.0.1"
   resolved "https://registry.yarnpkg.com/minimalistic-assert/-/minimalistic-assert-1.0.1.tgz#2e194de044626d4a10e7f7fbc00ce73e83e4d5c7"
   integrity sha512-UtJcAD4yEaGtjPezWuO9wC4nwUnVH/8/Im3yEHQP4b67cXlD/Qr9hdITCU1xDbSEXg2XKNaP8jsReV7vQd00/A==

-minimatch@10.1.2, minimatch@^10.1.1:
+minimatch@10.1.2:
   version "10.1.2"
   resolved "https://registry.yarnpkg.com/minimatch/-/minimatch-10.1.2.tgz#6c3f289f9de66d628fa3feb1842804396a43d81c"
   integrity sha512-fu656aJ0n2kcXwsnwnv9g24tkU5uSmOlTjd6WyyaKm2Z+h1qmY6bAjrcaIxF/BslFqbZ8UBtbJi7KgQOZD2PTw==
   dependencies:
     "@isaacs/brace-expansion" "^5.0.1"

+minimatch@^10.1.1:
+  version "10.2.0"
+  resolved "https://registry.yarnpkg.com/minimatch/-/minimatch-10.2.0.tgz#e710473e66e3e1aaf376d0aa82438375cac86e9e"
+  integrity sha512-ugkC31VaVg9cF0DFVoADH12k6061zNZkZON+aX8AWsR9GhPcErkcMBceb6znR8wLERM2AkkOxy2nWRLpT9Jq5w==
+  dependencies:
+    brace-expansion "^5.0.2"
+
 minimatch@^3.0.4, minimatch@^3.1.1:
   version "3.1.2"
   resolved "https://registry.yarnpkg.com/minimatch/-/minimatch-3.1.2.tgz#19cd194bfd3e428f049a70817c038d89ab4be35b"
   integrity sha512-J7p63hRiAjw1NDEww1W7i37+ByIrOWO5XQQAzZ3VOcL0PNybwpfmV/N05zFAzwQ9USyEcX6t3UO+K5aqBQOIHw==
   dependencies:
@@ -4780,13 +4798,13 @@ pvutils@^1.1.3:
   version "1.1.5"
   resolved "https://registry.yarnpkg.com/pvutils/-/pvutils-1.1.5.tgz#84b0dea4a5d670249aa9800511804ee0b7c2809c"
   integrity sha512-KTqnxsgGiQ6ZAzZCVlJH5eOjSnvlyEgx1m8bkRJfOhmGRqfo5KLvmAlACQkrjEtOQ4B7wF9TdSLIs9O90MX9xA==

 qs@~6.14.0:
-  version "6.14.1"
-  resolved "https://registry.yarnpkg.com/qs/-/qs-6.14.1.tgz#a41d85b9d3902f31d27861790506294881871159"
-  integrity sha512-4EK3+xJl8Ts67nLYNwqw/dsFVnCf+qR7RgXSK9jEEm9unao3njwMDdmsdvoKBKHzxd7tCYz5e5M+SnMjdtXGQQ==
+  version "6.14.2"
+  resolved "https://registry.yarnpkg.com/qs/-/qs-6.14.2.tgz#b5634cf9d9ad9898e31fba3504e866e8efb6798c"
+  integrity sha512-V/yCWTTF7VJ9hIh18Ugr2zhJMP01MY7c5kh4J870L7imm6/DIzBsNLTXzMwUA3yZ5b/KBqLx8Kp3uRvd7xSe3Q==
   dependencies:
     side-channel "^1.1.0"

 randombytes@^2.1.0:
   version "2.1.0"
@@ -4989,25 +5007,20 @@ selfsigned@^5.5.0:
   integrity sha512-ftnu3TW4+3eBfLRFnDEkzGxSF/10BJBkaLJuBHZX0kiPS7bRdlpZGu6YGt4KngMkdTwJE6MbjavFpqHvqVt+Ew==
   dependencies:
     "@peculiar/x509" "^1.14.2"
     pkijs "^3.3.3"

-semver@7.7.4:
+semver@7.7.4, semver@^7.3.4, semver@^7.3.5, semver@^7.5.3, semver@^7.5.4, semver@^7.7.2, semver@^7.7.3:
   version "7.7.4"
   resolved "https://registry.yarnpkg.com/semver/-/semver-7.7.4.tgz#28464e36060e991fa7a11d0279d2d3f3b57a7e8a"
   integrity sha512-vFKC2IEtQnVhpT78h1Yp8wzwrf8CM+MzKMHGJZfBtzhZNycRFnXsHk6E5TxIkkMsgNS7mdX3AGB7x2QM2di4lA==

 semver@^6.3.1:
   version "6.3.1"
   resolved "https://registry.yarnpkg.com/semver/-/semver-6.3.1.tgz#556d2ef8689146e46dcea4bfdd095f3434dffcb4"
   integrity sha512-BR7VvDCVHO+q2xBEWskxS6DJE1qRnb7DxzUrogb71CWoSficBxYsiAGd+Kl0mmq/MprG9yArRkyrQxTO6XjMzA==

-semver@^7.3.4, semver@^7.3.5, semver@^7.5.3, semver@^7.5.4, semver@^7.7.2, semver@^7.7.3:
-  version "7.7.3"
-  resolved "https://registry.yarnpkg.com/semver/-/semver-7.7.3.tgz#4b5f4143d007633a8dc671cd0a6ef9147b8bb946"
-  integrity sha512-SdsKMrI9TdgjdweUSR9MweHA4EJ8YxHn8DFaDisvhVlUOe4BF1tLD7GAj0lIqWVl+dPb/rExr0Btby5loQm20Q==
-
 send@~0.19.0, send@~0.19.1:
   version "0.19.2"
   resolved "https://registry.yarnpkg.com/send/-/send-0.19.2.tgz#59bc0da1b4ea7ad42736fd642b1c4294e114ff29"
   integrity sha512-VMbMxbDeehAxpOtWJXlcUS5E8iXh6QmN+BkRX1GARS3wRaXEEgzCcB10gTQazO42tpNIya8xIyNx8fll1OFPrg==
   dependencies:
@@ -5364,11 +5377,11 @@ synckit@^0.11.8:
   resolved "https://registry.yarnpkg.com/synckit/-/synckit-0.11.12.tgz#abe74124264fbc00a48011b0d98bdc1cffb64a7b"
   integrity sha512-Bh7QjT8/SuKUIfObSXNHNSK6WHo6J1tHCqJsuaFDP7gP0fkzSfTxI8y85JrppZ0h8l0maIgc2tfuZQ6/t3GtnQ==
   dependencies:
     "@pkgr/core" "^0.2.9"

-tapable@^2.2.0, tapable@^2.3.0:
+tapable@^2.3.0:
   version "2.3.0"
   resolved "https://registry.yarnpkg.com/tapable/-/tapable-2.3.0.tgz#7e3ea6d5ca31ba8e078b560f0d83ce9a14aa8be6"
   integrity sha512-g9ljZiwki/LfxmQADO3dEY1CbpmXT5Hm2fJ+QaGKwSXUylMybePR7/67YW7jOrrvjEgL1Fmz5kzyAjWVWLlucg==

 tar-fs@^2.0.0:
@@ -5819,14 +5832,14 @@ webpack-node-externals@^3.0.0:
 webpack-sources@^3.3.3:
   version "3.3.3"
   resolved "https://registry.yarnpkg.com/webpack-sources/-/webpack-sources-3.3.3.tgz#d4bf7f9909675d7a070ff14d0ef2a4f3c982c723"
   integrity sha512-yd1RBzSGanHkitROoPFd6qsrxt+oFhg/129YzheDGqeustzX0vTZJZsSsQjVQC4yzBQ56K55XU8gaNCtIzOnTg==

-webpack@5.105.1:
-  version "5.105.1"
-  resolved "https://registry.yarnpkg.com/webpack/-/webpack-5.105.1.tgz#c05cb3621196c76fa3b3a9bea446d14616b83778"
-  integrity sha512-Gdj3X74CLJJ8zy4URmK42W7wTZUJrqL+z8nyGEr4dTN0kb3nVs+ZvjbTOqRYPD7qX4tUmwyHL9Q9K6T1seW6Yw==
+webpack@5.105.2:
+  version "5.105.2"
+  resolved "https://registry.yarnpkg.com/webpack/-/webpack-5.105.2.tgz#f3b76f9fc36f1152e156e63ffda3bbb82e6739ea"
+  integrity sha512-dRXm0a2qcHPUBEzVk8uph0xWSjV/xZxenQQbLwnwP7caQCYpqG1qddwlyEkIDkYn0K8tvmcrZ+bOrzoQ3HxCDw==
   dependencies:
     "@types/eslint-scope" "^3.7.7"
     "@types/estree" "^1.0.8"
     "@types/json-schema" "^7.0.15"
     "@webassemblyjs/ast" "^1.14.1"
