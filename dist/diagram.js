"use strict";(self.webpackChunkbilliards=self.webpackChunkbilliards||[]).push([[338],{"./src/container/container.ts":(e,t,n)=>{n.d(t,{m:()=>Y});var r=n("./src/events/stationaryevent.ts"),i=n("./node_modules/three/build/three.core.js"),s=n("./src/utils/utils.ts"),o=n("./src/view/cameratop.ts"),a=n("./src/model/physics/constants.ts");function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var c=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");l(this,"camera",void 0),l(this,"mode",this.topView),l(this,"mainMode",this.aimView),l(this,"height",8*a.R),l(this,"elapsed",void 0),this.camera=new i.ubm(45,e,a.R,1e3*a.R)}return e=[{key:"update",value:function(e,t){this.elapsed=e,this.mode(t)}},{key:"topView",value:function(e){this.camera.fov=o.v.fov,this.camera.position.lerp(o.v.viewPoint(this.camera.aspect,this.camera.fov),.9),this.camera.up=s.up,this.camera.lookAt(s.v_)}},{key:"aimView",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.08,n=this.height,r=this.camera.aspect<.8;if(this.camera.fov=r?60:40,n<10*a.R){var i=100*(10*a.R-n);this.camera.fov-=i*(r?3:1)}this.camera.position.lerp(e.pos.clone().addScaledVector((0,s.Dz)(e.angle),-(18*a.R)),t),this.camera.position.z=n,this.camera.up=s.up,this.camera.lookAt(e.pos.clone().addScaledVector(s.up,n/2))}},{key:"adjustHeight",value:function(e){e=this.height<10*a.R?e/8:e,this.height=i.cj9.clamp(this.height+e,6*a.R,120*a.R),this.height>110*a.R&&this.suggestMode(this.topView),this.height<105*a.R&&this.suggestMode(this.aimView)}},{key:"suggestMode",value:function(e){this.mainMode===this.aimView&&(this.mode=e)}},{key:"forceMode",value:function(e){this.mode=e,this.mainMode=e}},{key:"forceMove",value:function(e){this.mode===this.aimView&&this.aimView(e,1)}},{key:"toggleMode",value:function(){this.mode===this.topView?this.mode=this.aimView:this.mode=this.topView,this.mainMode=this.mode}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),u=n("./src/view/tablegeometry.ts"),h=function(){var e;function t(){var e,n;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");e="material",n=new i.mrM({color:132,opacity:.15,transparent:!0}),e in this?Object.defineProperty(this,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):this[e]=n}return e=[{key:"generateLineSegments",value:function(){var e=this,t=[this.point(0,-11.13*a.R/.5),this.point(0,11.13*a.R/.5)],n=u.P.X/4,r=u.P.tableY+a.R;[1,2,3,-1,-2,-3].forEach(function(i){t.push(e.point(i*n,-r)),t.push(e.point(i*n,r))});var s=(u.P.Y+a.R)/2,o=u.P.tableX+a.R;[-1,0,1].forEach(function(n){t.push(e.point(-o,n*s)),t.push(e.point(o,n*s))});var l=new i.LoY().setFromPoints(t);return new i.DXC(l,this.material)}},{key:"point",value:function(e,t){var n=-(.485*a.R)/.5;return new i.Pq0(e,t,n)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),f=n("./node_modules/three/build/three.module.js"),p=n("./src/controller/rules/snooker.ts");function d(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var v=function(){var e;function t(e,n,r){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");d(this,"scene",new i.Z58),d(this,"renderer",void 0),d(this,"camera",void 0),d(this,"windowWidth",1),d(this,"windowHeight",1),d(this,"element",void 0),d(this,"table",void 0),d(this,"loadAssets",!0),d(this,"assets",void 0),d(this,"ballToCheck",0),this.element=e,this.table=n,this.assets=r,this.renderer=function(e){if("undefined"==typeof process){var t=new f.JeP({antialias:!1});return t.shadowMap.enabled=!1,t.autoClear=!1,t.setSize(e.offsetWidth,e.offsetHeight),t.setPixelRatio(.75*window.devicePixelRatio),e.appendChild(t.domElement),t}}(e),this.camera=new c(e?e.offsetWidth/e.offsetHeight:1),this.initialiseScene()}return e=[{key:"update",value:function(e,t){this.camera.update(e,t)}},{key:"sizeChanged",value:function(){var e,t;return this.windowWidth!=(null==(e=this.element)?void 0:e.offsetWidth)||this.windowHeight!=(null==(t=this.element)?void 0:t.offsetHeight)}},{key:"updateSize",value:function(){var e,t,n=this.sizeChanged();return n&&(this.windowWidth=null==(e=this.element)?void 0:e.offsetWidth,this.windowHeight=null==(t=this.element)?void 0:t.offsetHeight),n}},{key:"render",value:function(){this.isInMotionNotVisible()&&this.camera.suggestMode(this.camera.topView),this.renderCamera(this.camera)}},{key:"renderCamera",value:function(e){var t;if(this.updateSize()){var n,r,i,s,o=this.windowWidth,a=this.windowHeight;null==(n=this.renderer)||n.setSize(o,a),null==(r=this.renderer)||r.setViewport(0,0,o,a),null==(i=this.renderer)||i.setScissor(0,0,o,a),null==(s=this.renderer)||s.setScissorTest(!0),e.camera.aspect=o/a}e.camera.updateProjectionMatrix(),null==(t=this.renderer)||t.render(this.scene,e.camera)}},{key:"initialiseScene",value:function(){this.scene.add(new i.$p8(39202,.3)),this.assets.background&&this.scene.add(this.assets.background),this.scene.add(this.assets.table),this.table.mesh=this.assets.table,this.assets.rules.asset()!==p.c.tablemodel&&this.scene.add(new h().generateLineSegments())}},{key:"isInMotionNotVisible",value:function(){var e=this.viewFrustrum(),t=this.table.balls[this.ballToCheck++%this.table.balls.length];return t.inMotion()&&!e.intersectsObject(t.ballmesh.mesh)}},{key:"viewFrustrum",value:function(){var e=this.camera.camera,t=new i.PPD;return t.setFromProjectionMatrix(new i.kn4().multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse)),t}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),m=n("./src/controller/init.ts"),y=n("./src/events/input.ts");function b(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var g=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");b(this,"line",new i.cZY),b(this,"balls",void 0),this.balls=e}return e=[{key:"getFirst",value:function(e,t){var n=this;this.line.set(e.pos,(0,s.xb)(t).multiplyScalar(4*u.P.X).add(e.pos));var r=new i.Pq0,o=this.balls.map(function(t){return n.line.closestPointToPoint(t.pos,!0,r),{ball:t,perpendicular:r.distanceTo(t.pos),distance:r.distanceTo(e.pos)}}).filter(function(e){return e.perpendicular<2*a.R}).filter(function(t){return t.ball!==e});return o.reduce(function(e,t){return e.distance<t.distance?e:t},o[0])}},{key:"getOverlapOffset",value:function(e,t){var n=this.getFirst(e,t);if(n){var r=n.ball.pos.clone().sub(e.pos),i=n.perpendicular*Math.sign(r.cross(t).z)/a.R;return{ball:n.ball,overlap:i}}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function w(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var k=function(){var e;function t(e){var n,r=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");w(this,"cueBallElement",void 0),w(this,"cueTipElement",void 0),w(this,"cuePowerElement",void 0),w(this,"cueHitElement",void 0),w(this,"objectBallStyle",void 0),w(this,"container",void 0),w(this,"overlap",void 0),w(this,"ballWidth",void 0),w(this,"ballHeight",void 0),w(this,"tipRadius",void 0),w(this,"mousemove",function(e){1===e.buttons&&r.adjustSpin(e)}),w(this,"powerChanged",function(e){r.container.table.cue.setPower(r.cuePowerElement.value)}),w(this,"hit",function(e){var t;r.container.table.cue.setPower(null==(t=r.cuePowerElement)?void 0:t.value),r.container.inputQueue.push(new y.p(0,"SpaceUp"))}),w(this,"mousewheel",function(e){r.cuePowerElement&&(r.cuePowerElement.value-=Math.sign(e.deltaY)/10,r.container.table.cue.setPower(r.cuePowerElement.value),r.container.lastEventTime=performance.now())}),this.container=e,this.cueBallElement=document.getElementById("cueBall"),this.cueTipElement=document.getElementById("cueTip"),this.cuePowerElement=document.getElementById("cuePower"),this.cueHitElement=document.getElementById("cueHit"),this.objectBallStyle=null==(n=document.getElementById("objectBall"))?void 0:n.style,this.overlap=new g(this.container.table.balls),this.addListeners()}return e=[{key:"addListeners",value:function(){var e,t,n,r,i,s=this;null==(e=this.cueBallElement)||e.addEventListener("pointermove",this.mousemove),null==(t=this.cueBallElement)||t.addEventListener("click",function(e){s.adjustSpin(e)}),null==(n=this.cueHitElement)||n.addEventListener("click",this.hit),null==(r=this.cuePowerElement)||r.addEventListener("change",this.powerChanged),"ontouchstart"in window||null==(i=document.getElementById("viewP1"))||i.addEventListener("dblclick",this.hit),document.addEventListener("wheel",this.mousewheel)}},{key:"setButtonText",value:function(e){this.cueHitElement&&(this.cueHitElement.innerText=e)}},{key:"readDimensions",value:function(){var e,t,n;this.ballWidth=null==(e=this.cueBallElement)?void 0:e.offsetWidth,this.ballHeight=null==(t=this.cueBallElement)?void 0:t.offsetHeight,this.tipRadius=(null==(n=this.cueTipElement)?void 0:n.offsetWidth)/2}},{key:"adjustSpin",value:function(e){this.readDimensions(),this.container.table.cue.setSpin(new i.Pq0(-(e.offsetX-this.ballWidth/2)/this.ballWidth,-(e.offsetY-this.ballHeight/2)/this.ballHeight),this.container.table),this.container.lastEventTime=performance.now()}},{key:"updateVisualState",value:function(e,t){this.readDimensions();var n,r=null==(n=this.cueTipElement)?void 0:n.style;r&&(r.left=(-e+.5)*this.ballWidth-this.tipRadius+"px",r.top=(-t+.5)*this.ballHeight-this.tipRadius+"px"),this.showOverlap()}},{key:"showOverlap",value:function(){if(this.objectBallStyle){var e=this.container.table,t=(0,s.Dz)(e.cue.aim.angle),n=this.overlap.getOverlapOffset(e.cueball,t);n?(this.readDimensions(),this.objectBallStyle.visibility="visible",this.objectBallStyle.left=5+n.overlap*this.ballWidth/2+"px",this.objectBallStyle.backgroundColor=new i.Q1f(0,0,0).lerp(n.ball.ballmesh.color,.5).getStyle()):this.objectBallStyle.visibility="hidden"}}},{key:"updatePowerSlider",value:function(e){var t;e>0&&(null==(t=this.cuePowerElement)?void 0:t.value)&&(this.cuePowerElement.value=e)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),x=n("./src/controller/aim.ts"),T=n("./src/controller/watchaim.ts"),P=n("./src/controller/playshot.ts"),R=n("./src/controller/watchshot.ts"),S=n("./src/controller/replay.ts"),E=n("./src/controller/end.ts"),A=n("./src/controller/placeball.ts");function O(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}function M(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var _=function(){var e;function t(e){var n,r=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");M(this,"chatoutput",void 0),M(this,"chatInput",void 0),M(this,"chatSend",void 0),M(this,"chatInputText",void 0),M(this,"send",void 0),M(this,"sendClicked",function(e){var t,n;r.send(null==(t=r.chatInputText)?void 0:t.value),r.showMessage(null==(n=r.chatInputText)?void 0:n.value)}),this.chatoutput=document.getElementById("chatoutput"),this.chatInputText=document.getElementById("chatinputtext"),this.chatSend=document.getElementById("chatsend"),null==(n=this.chatSend)||n.addEventListener("click",this.sendClicked),this.send=e}return e=[{key:"showMessage",value:function(e){this.chatoutput&&(this.chatoutput.innerHTML+=e),this.updateScroll()}},{key:"updateScroll",value:function(){this.chatoutput&&(this.chatoutput.scrollTop=this.chatoutput.scrollHeight)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),I=n("./src/events/chatevent.ts"),C=n("./src/events/eventtype.ts");function j(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var B=function(){var e;function t(e,n){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");j(this,"period",void 0),j(this,"pending",null),j(this,"sentTime",0),j(this,"apply",function(e){}),this.period=e,this.apply=n}return e=[{key:"flush",value:function(){this.pending&&(this.apply(this.pending),this.pending=null)}},{key:"send",value:function(e){if(performance.now()>this.sentTime+this.period||e.type!==C.B.AIM){this.flush(),this.apply(e),this.sentTime=performance.now();return}this.pending=e}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),L=n("./src/view/sliders.ts"),N=n("./src/model/outcome.ts"),F=n("./node_modules/jsoncrush/JSONCrush.js"),H=n("./src/events/rerackevent.ts");function U(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var D=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");U(this,"container",void 0),U(this,"shots",[]),U(this,"states",[]),U(this,"start",Date.now()),U(this,"breakStart",void 0),U(this,"breakStartTime",void 0),U(this,"replayUrl",void 0),U(this,"hiScoreUrl","https://scoreboard-tailuge.vercel.app/hiscore.html"),this.container=e}return e=[{key:"record",value:function(e){e.type===C.B.WATCHAIM&&"rerack"in e.json&&(this.states.push(this.container.table.shortSerialise()),this.shots.push(H.x.fromJson({balls:e.json.balls}))),e.type===C.B.HIT&&(this.states.push(this.container.table.shortSerialise()),this.shots.push(e.tablejson.aim))}},{key:"wholeGame",value:function(){return this.state(this.states[0],this.shots,this.start,this.container.rules.score,!0)}},{key:"last",value:function(){var e=this.states.length-1;return e>0&&"RERACK"===this.shots[e].type&&e--,e}},{key:"lastShot",value:function(){var e=this.last();return this.state(this.states[e],[this.shots[e]])}},{key:"currentBreak",value:function(){if(void 0!==this.breakStart)return this.state(this.states[this.breakStart],this.shots.slice(this.breakStart),this.breakStartTime,this.container.rules.previousBreak)}},{key:"state",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments.length>4&&void 0!==arguments[4]&&arguments[4];return{init:e,shots:t,start:n,now:Date.now(),score:r,wholeGame:i,v:1}}},{key:"updateBreak",value:function(e){var t=this.container.rules.isPartOfBreak(e),n=this.container.rules.isEndOfGame(e),r=N.P.potCount(e);if(t||this.breakLink(n),this.lastShotLink(t||n,r,N.P.pots(e)),n&&this.breakLink(n),!t){this.breakStart=void 0;return}void 0===this.breakStart&&(this.breakStart=this.last(),this.breakStartTime=Date.now())}},{key:"lastShotLink",value:function(e,t,n){var r="#000000";n.length>0&&n.forEach(function(e){r="#"+e.ballmesh.color.getHexString()});var i="⚈".repeat(t>1?t-1:0)+(e?"⚈":"⚆"),s=JSON.stringify(this.lastShot());this.generateLink(i,s,r)}},{key:"breakLink",value:function(e){var t=this.currentBreak();if(t&&(e||t.shots.pop(),1!==t.shots.length)){var n=0===this.container.rules.currentBreak?this.container.rules.previousBreak:this.container.rules.currentBreak;t.score=n;var r=JSON.stringify(t),i=F.A.crush(r);this.generateLink("break(".concat(n,")"),i,"black"),n>=2&&this.generateHiScoreLink(i)}}},{key:"wholeGameLink",value:function(){var e=this.wholeGame(),t="frame(".concat(this.shotCount(e.shots)," shots)"),n=JSON.stringify(e),r=F.A.crush(n);this.generateLink(t,r,"black")}},{key:"shotCount",value:function(e){return e.filter(function(e){return"RERACK"!==e.type}).length}},{key:"generateLink",value:function(e,t,n){var r="".concat(this.replayUrl).concat(this.fullyEncodeURI(t)),i='<a class="pill" style="color: '.concat(n,'" target="_blank" href="').concat(r,'">').concat(e,"</a>");this.container.eventQueue.push(new I.b(null,"".concat(i)))}},{key:"generateHiScoreLink",value:function(e){var t="".concat(this.hiScoreUrl,"?ruletype=").concat(this.container.rules.rulename,"&state=").concat(this.fullyEncodeURI(e)),n='<a class="pill" target="_blank" href="'.concat(t,'">').concat("hi score 🏆","</a>");this.container.eventQueue.push(new I.b(null,"".concat(n)))}},{key:"fullyEncodeURI",value:function(e){return encodeURIComponent(e).replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\!/g,"%21").replace(/\*/g,"%2A")}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),z=n("./src/controller/rules/rulefactory.ts"),q=n("./src/events/breakevent.ts");function V(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var G=function(){var e;function t(e){var n=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");V(this,"container",void 0),V(this,"redo",void 0),V(this,"share",void 0),V(this,"replay",void 0),V(this,"camera",void 0),V(this,"disabled",!0),this.container=e,this.replay=this.getElement("replay"),this.redo=this.getElement("redo"),this.share=this.getElement("share"),this.camera=this.getElement("camera"),this.camera&&(this.setMenu(!0),this.camera.onclick=function(e){n.adjustCamera()})}return e=[{key:"setMenu",value:function(e){this.replay.disabled=e,this.redo.disabled=e,this.share.disabled=e}},{key:"adjustCamera",value:function(){this.container.view.camera.toggleMode(),this.container.lastEventTime=performance.now()}},{key:"replayMode",value:function(e,t){var n=this;if(this.replay){this.setMenu(!1);var r=this.container.eventQueue;this.share.onclick=function(t){!function(e,t){var n;if(("undefined"==typeof process?"undefined":(n=process)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)=="object")return t(e);fetch("https://scoreboard-tailuge.vercel.app/api/shorten",{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({input:new URL(e.replaceAll("(","%28").replaceAll(")","%29").replaceAll("!","%21").replaceAll("*","%2A")).search})}).then(function(e){return e.json()}).then(function(n){"shortUrl"in n?t(n.shortUrl):(console.log("Could not shorten url:"),console.log(n),t(e))})}(e,function(e){var t,n,i,s,o=(s={title:"Billiards",text:"Replay break",url:e},(null==(t=(n=navigator).canShare)?void 0:t.call(n,s))?(navigator.share(s).then(function(){return console.log("shared successfully")}).catch(function(e){console.log("Error: "+e)}),"link shared"):(null==(i=navigator.clipboard)||i.writeText(e),'link copied to clipboard <a href="'.concat(e,'">').concat(e,"</a>")));r.push(new I.b(null,o))})},this.redo.onclick=function(e){var r=new q.W(t.init,t.shots);r.retry=!0,n.interuptEventQueue(r)},this.replay.onclick=function(e){n.interuptEventQueue(t)}}}},{key:"interuptEventQueue",value:function(e){this.container.table.halt();var t=this.container.eventQueue;t.length=0,t.push(new r.T),t.push(e)}},{key:"getElement",value:function(e){return document.getElementById(e)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),K=function(){var e;function t(){var e,n;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");n=void 0,(e="element")in this?Object.defineProperty(this,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):this[e]=n,this.element=this.getElement("snookerScore")}return e=[{key:"updateBreak",value:function(e){this.element&&(e>0?this.element.innerHTML="Break</br>"+e:this.element.innerHTML="")}},{key:"getElement",value:function(e){return document.getElementById(e)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),X=function e(){if(!(this instanceof e))throw TypeError("Cannot call a class as a function")};function W(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Y=function(){var e;function t(e,n,r,i,s,o){var a=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");W(this,"table",void 0),W(this,"view",void 0),W(this,"controller",void 0),W(this,"inputQueue",[]),W(this,"eventQueue",[]),W(this,"keyboard",void 0),W(this,"sound",void 0),W(this,"chat",void 0),W(this,"sliders",void 0),W(this,"recorder",void 0),W(this,"id",""),W(this,"isSinglePlayer",!0),W(this,"rules",void 0),W(this,"menu",void 0),W(this,"hud",void 0),W(this,"lobbyIndicator",void 0),W(this,"frame",void 0),W(this,"last",performance.now()),W(this,"step",.001953125),W(this,"broadcast",function(){}),W(this,"log",void 0),W(this,"sendChat",function(e){a.sendEvent(new I.b(a.id,e))}),W(this,"throttle",new B(0,function(e){a.broadcast(e)})),W(this,"lastEventTime",performance.now()),this.log=n,this.rules=z.V.create(i,this),this.table=this.rules.table(),this.view=new v(e,this.table,r),this.table.cue.aimInputs=new k(this),this.keyboard=s,this.sound=r.sound,this.chat=new _(this.sendChat),this.sliders=new L.r,this.recorder=new D(this),this.id=o,this.menu=new G(this),this.table.addToScene(this.view.scene),this.hud=new K,this.lobbyIndicator=new X,this.updateController(new m.J(this))}return e=[{key:"sendEvent",value:function(e){this.throttle.send(e)}},{key:"advance",value:function(e){null==(t=this.frame)||t.call(this,e);for(var t,n=Math.floor(e/this.step),i=n*this.step,s=this.table.allStationary(),o=0;o<n;o++)this.table.advance(this.step);this.table.updateBallMesh(i),this.view.update(i,this.table.cue.aim),this.table.cue.update(i),!s&&this.table.allStationary()&&this.eventQueue.push(new r.T),this.sound.processOutcomes(this.table.outcome)}},{key:"processEvents",value:function(){var e=this;for(this.keyboard&&this.keyboard.getEvents().forEach(function(t){return e.inputQueue.push(t)});this.inputQueue.length>0;){this.lastEventTime=this.last;var t=this.inputQueue.shift();t&&this.updateController(this.controller.handleInput(t))}if(this.table.allStationary()){var n=this.eventQueue.shift();n&&(this.lastEventTime=performance.now(),this.updateController(n.applyToController(this.controller)))}}},{key:"animate",value:function(e){var t=this;this.advance((e-this.last)/1e3),this.last=e,this.processEvents(),(e<this.lastEventTime+12e3||!this.table.allStationary()||this.view.sizeChanged())&&this.view.render(),requestAnimationFrame(function(e){t.animate(e)})}},{key:"updateController",value:function(e){e!==this.controller&&(this.log("Transition to "+(O(e,m.J)?"Init":O(e,A.x)?"PlaceBall":O(e,x.m)?"Aim":O(e,T.r)?"WatchAim":O(e,P.H)?"PlayShot":O(e,R.O)?"WatchShot":O(e,S.e)?"Replay":O(e,E.o)?"End":"UNKNOWN")),this.controller=e,this.controller.onFirst())}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/controller/aim.ts":(e,t,n)=>{n.d(t,{m:()=>u});var r=n("./src/controller/controller.ts"),i=n("./src/controller/controllerbase.ts"),s=n("./src/controller/playshot.ts"),o=n("./src/controller/replay.ts");function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(c=function(){return!!e})()}var u=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");t=n,r=[e],t=a(t);var t,r,i,s=(i=function(e,t){var n;if(t&&("object"==((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,c()?Reflect.construct(t,r||[],a(this).constructor):t.apply(this,r))).container.table;return s.cue.aimMode(),s.cue.showHelper(!0),s.cueball=i.container.rules.cueball,s.cue.moveTo(s.cueball.pos),i.container.view.camera.suggestMode(i.container.view.camera.aimView),s.cue.aimInputs.showOverlap(),i}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&l(n,e),t=[{key:"handleInput",value:function(e){switch(e.key){case"Space":this.container.table.cue.adjustPower(e.t*this.scale*.7);break;case"SpaceUp":return this.playShot();default:if(!this.commonKeyHandler(e))return this}return this.container.sendEvent(this.container.table.cue.aim),this}},{key:"handleBreak",value:function(e){return new o.e(this.container,e.init,e.shots,e.retry)}},{key:"playShot",value:function(){var e=new r.Qe(this.container.table.serialise());return this.container.sendEvent(e),this.container.recorder.record(e),new s.H(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(i.y)},"./src/controller/controller.ts":(e,t,n)=>{n.d(t,{Qe:()=>i.Q,pd:()=>s.p,wG:()=>r.w,xI:()=>o}),n("./src/events/beginevent.ts");var r=n("./src/events/aimevent.ts"),i=n("./src/events/hitevent.ts"),s=n("./src/events/input.ts");n("./src/events/abortevent.ts"),n("./src/events/stationaryevent.ts");var o=function(){var e;function t(e){var n,r;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");r=void 0,(n="container")in this?Object.defineProperty(this,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):this[n]=r,this.container=e}return e=[{key:"handleInput",value:function(e){return this}},{key:"handleBegin",value:function(e){return this}},{key:"handleBreak",value:function(e){return this}},{key:"handleStartAim",value:function(e){return this}},{key:"handleAim",value:function(e){return this}},{key:"handleHit",value:function(e){return this}},{key:"handleAbort",value:function(e){return this}},{key:"handleWatch",value:function(e){return this}},{key:"handlePlaceBall",value:function(e){return this}},{key:"handleStationary",value:function(e){return this}},{key:"handleChat",value:function(e){return this}},{key:"handleRejoin",value:function(e){return this}},{key:"onFirst",value:function(){}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/controller/controllerbase.ts":(e,t,n)=>{n.d(t,{y:()=>h});var r=n("./src/controller/controller.ts"),i=n("./src/utils/gltf.ts"),s=n("./src/model/outcome.ts"),o=n("./node_modules/three/build/three.core.js");function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(u=function(){return!!e})()}var h=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t,r,i;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return t=n,r=arguments,t=a(t),e=function(e,t){if(t&&("object"===c(t)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,u()?Reflect.construct(t,r||[],a(this).constructor):t.apply(this,r)),(i="scale")in e?Object.defineProperty(e,i,{value:.001,enumerable:!0,configurable:!0,writable:!0}):e[i]=.001,e}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&l(n,e),t=[{key:"handleChat",value:function(e){var t=e.sender?"".concat(e.sender,":"):"",n="".concat(t," ").concat(e.message);return this.container.chat.showMessage(n),this}},{key:"hit",value:function(){this.container.table.outcome=[s.P.hit(this.container.table.cueball,this.container.table.cue.aim.power)],this.container.table.hit(),this.container.view.camera.suggestMode(this.container.view.camera.aimView),this.container.table.cue.showHelper(!1)}},{key:"commonKeyHandler",value:function(e){var t=this.container.table.cue,n=e.t*this.scale;switch(e.key){case"ArrowLeft":return t.rotateAim(-n,this.container.table),!0;case"ArrowRight":return t.rotateAim(n,this.container.table),!0;case"ArrowDown":return t.adjustSpin(new o.Pq0(0,-n),this.container.table),!0;case"ArrowUp":return t.adjustSpin(new o.Pq0(0,n),this.container.table),!0;case"ShiftArrowLeft":return t.adjustSpin(new o.Pq0(n,0),this.container.table),!0;case"ShiftArrowRight":return t.adjustSpin(new o.Pq0(-n,0),this.container.table),!0;case"KeyPUp":return(0,i.KP)(this.container.view.scene),!0;case"KeyHUp":return t.toggleHelper(),!0;case"movementXUp":return t.rotateAim(2*n,this.container.table),!0;case"movementYUp":case"NumpadSubtract":return this.container.view.camera.adjustHeight(8*n),!0;case"NumpadAdd":return this.container.view.camera.adjustHeight(-(8*n)),!0;case"KeyOUp":return this.container.view.camera.toggleMode(),!0;case"KeyDUp":return this.togglePanel(),!0;case"KeyFUp":return this.toggleFullscreen(),!0;default:return!1}}},{key:"togglePanel",value:function(){this.container.sliders.toggleVisibility(),this.container.table.showSpin(!0),this.container.table.showTraces(!0),("undefined"==typeof process?"undefined":c(process))!=="object"&&console.log(this.container.table.serialise())}},{key:"toggleFullscreen",value:function(){document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen()}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.xI)},"./src/controller/end.ts":(e,t,n)=>{n.d(t,{o:()=>l});var r=n("./src/controller/controller.ts"),i=n("./src/controller/init.ts");function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function o(e,t){return(o=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function a(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(a=function(){return!!e})()}var l=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return e=n,t=arguments,e=s(e),function(e,t){var n;if(t&&("object"==((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,a()?Reflect.construct(e,t||[],s(this).constructor):e.apply(this,t))}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&o(n,e),t=[{key:"handleChat",value:function(e){var t=e.sender?"".concat(e.sender,":"):"",n="".concat(t," ").concat(e.message);return this.container.chat.showMessage(n),this}},{key:"handleBegin",value:function(e){return new i.J(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.xI)},"./src/controller/init.ts":(e,t,n)=>{n.d(t,{J:()=>k});var r=n("./src/events/watchevent.ts"),i=n("./src/controller/watchaim.ts"),s=n("./src/controller/controllerbase.ts"),o=n("./src/controller/placeball.ts"),a=n("./src/controller/replay.ts"),l=n("./src/network/client/session.ts"),c=n("./src/controller/controller.ts"),u=n("./src/events/eventutil.ts");function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function f(e){return(f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function v(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(v=function(){return!!e})()}var m=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e,t,r){var i,s,o;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return s=n,o=[e],s=f(s),h(i=function(e,t){var n;if(t&&("object"==((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,v()?Reflect.construct(s,o||[],f(this).constructor):s.apply(this,o)),"messageRelay",void 0),h(i,"tableId",void 0),h(i,"messages",[]),i.messageRelay=t,i.tableId=r,i.messageRelay.subscribe(i.tableId,function(e){console.log(e);var t=u.d.fromSerialised(e);i.messages.push(t),(p(t,c.Qe)||p(t,c.wG))&&i.container.eventQueue.push(t)}),console.log("Spectate"),i}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&d(n,e),t=[{key:"handleAim",value:function(e){return this.container.table.cue.aim=e,this.container.table.cueball.pos.copy(e.pos),this}},{key:"handleHit",value:function(e){return console.log("Spectate Hit"),this.container.table.updateFromSerialised(e.tablejson),this.container.table.outcome=[],this.container.table.hit(),this}},{key:"handleInput",value:function(e){return this.commonKeyHandler(e),this}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(s.y),y=n("./src/network/client/nchanmessagerelay.ts");function b(e){return(b=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function g(e,t){return(g=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function w(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(w=function(){return!!e})()}var k=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return e=n,t=arguments,e=b(e),function(e,t){var n;if(t&&("object"==((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,w()?Reflect.construct(e,t||[],b(this).constructor):e.apply(this,t))}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&g(n,e),t=[{key:"handleBegin",value:function(e){return l.N.isSpectator()?new m(this.container,new y.p,l.N.getInstance().tableId):(this.container.chat.showMessage("Start"),this.container.sendEvent(new r.Q(this.container.table.serialise())),new o.x(this.container))}},{key:"handleWatch",value:function(e){return this.container.chat.showMessage("Opponent to break"),this.container.rules.secondToPlay(),this.container.table.updateFromSerialised(e.json),new i.r(this.container)}},{key:"handleBreak",value:function(e){return e.init?(this.container.table.updateFromShortSerialised(e.init),this.container.chat.showMessage("Replay"),new a.e(this.container,e.init,e.shots)):new o.x(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(s.y)},"./src/controller/placeball.ts":(e,t,n)=>{n.d(t,{x:()=>p});var r=n("./src/controller/controllerbase.ts"),i=n("./src/controller/controller.ts"),s=n("./src/controller/aim.ts"),o=n("./src/events/breakevent.ts"),a=n("./src/model/physics/constants.ts"),l=n("./node_modules/three/build/three.core.js"),c=n("./src/view/cuemesh.ts");function u(e){return(u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function h(e,t){return(h=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function f(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(f=function(){return!!e})()}var p=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){var t,r,i,s,o,l;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return r=n,i=[e],r=u(r),s=t=function(e,t){var n;if(t&&("object"==((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,f()?Reflect.construct(r,i||[],u(this).constructor):r.apply(this,i)),o="placescale",l=.02*a.R,o in s?Object.defineProperty(s,o,{value:l,enumerable:!0,configurable:!0,writable:!0}):s[o]=l,t.container.table.cue.moveTo(t.container.table.cueball.pos),t.container.table.cue.aim.power=0,t.container.view.camera.forceMode(t.container.view.camera.aimView),t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&h(n,e),t=[{key:"onFirst",value:function(){var e=this.container.table.cueball;this.container.rules.allowsPlaceBall()&&e.pos.copy(this.container.rules.placeBall()),e.setStationary(),e.updateMesh(0),this.container.table.cue.placeBallMode(),this.container.table.cue.showHelper(!1),this.container.table.cue.moveTo(this.container.table.cueball.pos),this.container.table.cue.aimInputs.setButtonText(`Place
Ball`),this.container.rules.allowsPlaceBall()||this.container.inputQueue.push(new i.pd(1,"SpaceUp"))}},{key:"handleInput",value:function(e){var t=this.container.table.cueball.pos;switch(e.key){case"ArrowLeft":case"KeyI":this.moveTo(0,e.t*this.placescale);break;case"ArrowRight":case"KeyK":this.moveTo(0,-e.t*this.placescale);break;case"movementXUp":this.moveTo(0,-e.t*this.placescale*2);break;case"movementYUp":this.moveTo(-e.t*this.placescale*2,0);break;case"KeyJ":this.moveTo(-e.t*this.placescale,0);break;case"KeyL":this.moveTo(e.t*this.placescale,0);break;case"SpaceUp":return this.placed();default:this.commonKeyHandler(e)}return this.container.table.cue.moveTo(t),this.container.view.camera.forceMove(this.container.table.cue.aim),this.container.sendEvent(this.container.table.cue.aim),this}},{key:"moveTo",value:function(e,t){var n=new l.Pq0(e,t),r=this.container.table.cueball.pos.add(n);r.copy(this.container.rules.placeBall(r)),c.l.indicateValid(!this.container.table.overlapsAny(r))}},{key:"placed",value:function(){return this.container.table.overlapsAny(this.container.table.cueball.pos)?this:(this.container.table.cue.aimInputs.setButtonText("Hit"),this.container.sound.playNotify(),this.container.sendEvent(new o.W(this.container.table.shortSerialise())),new s.m(this.container))}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.y)},"./src/controller/playshot.ts":(e,t,n)=>{n.d(t,{H:()=>a});var r=n("./src/controller/controllerbase.ts");function i(e){return(i=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function o(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(o=function(){return!!e})()}var a=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){var t,r,s;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return r=n,s=[e],r=i(r),(t=function(e,t){var n;if(t&&("object"==((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,o()?Reflect.construct(r,s||[],i(this).constructor):r.apply(this,s))).hit(),t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&s(n,e),t=[{key:"handleStationary",value:function(e){var t=this.container.table,n=t.outcome,r=this.container.rules.update(n);return this.container.recorder.updateBreak(n),t.cue.aimAtNext(t.cueball,this.container.rules.nextCandidateBall()),r}},{key:"handleInput",value:function(e){return this.commonKeyHandler(e),this}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.y)},"./src/controller/replay.ts":(e,t,n)=>{n.d(t,{e:()=>y});var r=n("./src/events/hitevent.ts"),i=n("./src/controller/controllerbase.ts"),s=n("./src/events/aimevent.ts"),o=n("./src/events/breakevent.ts"),a=n("./src/controller/aim.ts"),l=n("./src/events/eventtype.ts"),c=n("./src/events/rerackevent.ts"),u=n("./src/controller/end.ts");function h(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function p(e){return(p=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function v(e){return function(e){if(Array.isArray(e))return h(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return h(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return h(e,t)}}(e)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function m(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(m=function(){return!!e})()}var y=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e,t,r){var i,s,a,l=arguments.length>3&&void 0!==arguments[3]&&arguments[3],c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1500;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");if(i=n,s=[e],i=p(i),f(a=function(e,t){var n;if(t&&("object"==((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,m()?Reflect.construct(i,s||[],p(this).constructor):i.apply(this,s)),"delay",void 0),f(a,"shots",void 0),f(a,"firstShot",void 0),f(a,"timer",void 0),f(a,"init",void 0),a.init=t,a.shots=v(r),a.firstShot=a.shots[0],a.delay=c,a.container.table.showTraces(!0),a.container.table.updateFromShortSerialised(a.init),l){var u=new o.W(t,r);u.retry=!0,a.container.eventQueue.push(u)}else a.container.view.camera.forceMode(a.container.view.camera.topView),a.playNextShot(1.5*a.delay);return a}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&d(n,e),t=[{key:"playNextShot",value:function(e){var t=this,n=this.shots.shift();if((null==n?void 0:n.type)===l.B.RERACK){c.x.fromJson(n.ballinfo).applyToController(this),this.shots.length>0&&this.playNextShot(e);return}var i=s.w.fromJson(n);this.container.table.cueball=this.container.table.balls[i.i],console.log(this.container.table.cueball.pos.distanceTo(i.pos)),this.container.table.cueball.pos.copy(i.pos),this.container.table.cue.aim=i,this.container.table.cue.updateAimInput(),this.container.table.cue.t=1,clearTimeout(this.timer),this.timer=setTimeout(function(){t.container.eventQueue.push(new r.Q(t.container.table.cue.aim)),t.timer=void 0},e)}},{key:"handleHit",value:function(e){return this.hit(),this}},{key:"handleStationary",value:function(e){return this.shots.length>0&&void 0===this.timer&&this.playNextShot(this.delay),this}},{key:"handleInput",value:function(e){return this.commonKeyHandler(e),this}},{key:"handleBreak",value:function(e){return(this.container.table.updateFromShortSerialised(e.init),this.shots=v(e.shots),this.container.table.showSpin(!0),e.retry)?this.retry():(this.playNextShot(this.delay),this)}},{key:"handleAbort",value:function(e){return console.log("Replay aborted"),new u.o(this.container)}},{key:"retry",value:function(){clearTimeout(this.timer),this.timer=void 0,this.container.table.updateFromShortSerialised(this.init);var e=s.w.fromJson(this.firstShot);return this.container.table.cueball=this.container.table.balls[e.i],this.container.rules.cueball=this.container.table.cueball,this.container.table.cueball.pos.copy(e.pos),this.container.table.cue.aim=e,this.container.view.camera.forceMode(this.container.view.camera.aimView),new a.m(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(i.y)},"./src/controller/rules/rulefactory.ts":(e,t,n)=>{n.d(t,{V:()=>M});var r=n("./src/events/watchevent.ts"),i=n("./src/utils/rack.ts"),s=n("./node_modules/three/build/three.core.js"),o=n("./src/controller/aim.ts"),a=n("./src/controller/placeball.ts"),l=n("./src/controller/watchaim.ts"),c=n("./src/events/chatevent.ts"),u=n("./src/events/placeballevent.ts"),h=n("./src/model/outcome.ts"),f=n("./src/model/table.ts"),p=n("./src/utils/utils.ts"),d=n("./src/controller/end.ts"),v=n("./src/model/physics/constants.ts"),m=n("./src/utils/respot.ts"),y=n("./src/view/tablegeometry.ts"),b=n("./src/events/startaimevent.ts");function g(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var w=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");g(this,"container",void 0),g(this,"cueball",void 0),g(this,"currentBreak",0),g(this,"previousBreak",0),g(this,"score",0),g(this,"rulename","nineball"),this.container=e}return e=[{key:"startTurn",value:function(){this.previousBreak=this.currentBreak,this.currentBreak=0}},{key:"nextCandidateBall",value:function(){return m.k.closest(this.container.table.cueball,this.container.table.balls)}},{key:"placeBall",value:function(e){if(e){var t=new s.Pq0(-y.P.X/2,y.P.tableY),n=new s.Pq0(-y.P.tableX,-y.P.tableY);return e.clamp(n,t)}return new s.Pq0(-(11*v.R)/.5,0,0)}},{key:"asset",value:function(){return"models/p8.min.gltf"}},{key:"tableGeometry",value:function(){y.P.hasPockets=!0}},{key:"table",value:function(){var e=new f.X(this.rack());return this.cueball=e.cueball,e}},{key:"rack",value:function(){return i.m.diamond()}},{key:"update",value:function(e){var t=this.container.table;if(h.P.isCueBallPotted(t.cueball,e))return(this.startTurn(),this.container.isSinglePlayer)?new a.x(this.container):(this.container.sendEvent(new u.z(p.v_,!0)),new l.r(this.container));if(h.P.isBallPottedNoFoul(t.cueball,e)){var n=h.P.potCount(e);return(this.currentBreak+=n,this.score+=n,this.container.sound.playSuccess(t.inPockets()),this.isEndOfGame(e))?(this.container.eventQueue.push(new c.b(null,"game over")),this.container.recorder.wholeGameLink(),new d.o(this.container)):(this.container.sendEvent(new r.Q(t.serialise())),new o.m(this.container))}return(this.container.sendEvent(new b.M),this.container.isSinglePlayer)?(this.container.sendEvent(new r.Q(t.serialise())),this.startTurn(),new o.m(this.container)):new l.r(this.container)}},{key:"isPartOfBreak",value:function(e){return h.P.isBallPottedNoFoul(this.container.table.cueball,e)}},{key:"isEndOfGame",value:function(e){var t=this.container.table.balls.filter(function(e){return e.onTable()});return 1===t.length&&t[0]===this.cueball}},{key:"otherPlayersCueBall",value:function(){return this.cueball}},{key:"secondToPlay",value:function(){}},{key:"allowsPlaceBall",value:function(){return!0}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function k(e,t,n){return(k="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=x(e)););return e}(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(n||e):i.value}})(e,t,n||e)}function x(e){return(x=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function T(e,t){return(T=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function P(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(P=function(){return!!e})()}var R=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){var t,r,i;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return r=n,i=[e],r=x(r),(t=function(e,t){var n;if(t&&("object"==((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,P()?Reflect.construct(r,i||[],x(this).constructor):r.apply(this,i))).rulename="fourteenone",t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&T(n,e),t=[{key:"asset",value:function(){return"models/p8.min.gltf"}},{key:"rack",value:function(){return i.m.triangle()}},{key:"update",value:function(e){var t=this.container.table;return this.checkRerack(t),k(x(n.prototype),"update",this).call(this,e)}},{key:"checkRerack",value:function(e){var t=e.balls.filter(function(e){return e.onTable()}).filter(function(t){return t!==e.cueball});if(1===t.length){i.m.rerack(t[0],e),this.container.sound.playSuccess(e.inPockets());var n,s,o=e.serialise(),a=new r.Q((n=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(t){var r;r=n[t],t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r})}return e}({},o),s=s={rerack:!0},Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(s)):(function(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n.push.apply(n,r)}return n})(Object(s)).forEach(function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(s,e))}),n));this.container.sendEvent(a),this.container.recorder.record(a),this.container.recorder.wholeGameLink()}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(w),S=n("./src/controller/rules/snooker.ts"),E=n("./src/view/cameratop.ts");function A(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var O=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");A(this,"container",void 0),A(this,"cueball",void 0),A(this,"currentBreak",0),A(this,"previousBreak",0),A(this,"score",0),A(this,"rulename","threecushion"),this.container=e}return e=[{key:"startTurn",value:function(){}},{key:"nextCandidateBall",value:function(){return m.k.closest(this.container.table.cueball,this.container.table.balls)}},{key:"placeBall",value:function(e){return p.v_}},{key:"asset",value:function(){return"models/threecushion.min.gltf"}},{key:"secondToPlay",value:function(){this.cueball=this.container.table.balls[1]}},{key:"tableGeometry",value:function(){y.P.tableX=49*v.R,y.P.tableY=24*v.R,y.P.X=y.P.tableX+v.R,y.P.Y=y.P.tableY+v.R,y.P.hasPockets=!1}},{key:"table",value:function(){this.tableGeometry(),E.v.zoomFactor=.92;var e=new f.X(this.rack());return this.cueball=e.cueball,e}},{key:"rack",value:function(){return i.m.three()}},{key:"update",value:function(e){return h.P.isThreeCushionPoint(this.cueball,e)?(this.container.sound.playSuccess(e.length/3),this.container.sendEvent(new r.Q(this.container.table.serialise())),this.currentBreak++,this.score++,new o.m(this.container)):(this.previousBreak=this.currentBreak,this.currentBreak=0,this.container.isSinglePlayer)?(this.cueball=this.otherPlayersCueBall(),this.container.table.cue.aim.i=this.container.table.balls.indexOf(this.cueball),new o.m(this.container)):(this.container.sendEvent(new b.M),new l.r(this.container))}},{key:"otherPlayersCueBall",value:function(){var e=this.container.table.balls;return this.cueball===e[0]?e[1]:e[0]}},{key:"isPartOfBreak",value:function(e){return h.P.isThreeCushionPoint(this.cueball,e)}},{key:"isEndOfGame",value:function(e){return!1}},{key:"allowsPlaceBall",value:function(){return!1}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),M=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"create",value:function(e,t){switch(e){case"threecushion":return new O(t);case"fourteenone":return new R(t);case"snooker":return new S.c(t);default:return new w(t)}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/controller/rules/snooker.ts":(e,t,n)=>{n.d(t,{c:()=>k});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/events/watchevent.ts"),s=n("./src/model/outcome.ts"),o=n("./src/utils/rack.ts"),a=n("./src/utils/respot.ts"),l=n("./src/controller/aim.ts"),c=n("./src/controller/watchaim.ts"),u=n("./src/events/chatevent.ts"),h=n("./src/controller/end.ts"),f=n("./src/model/table.ts"),p=n("./src/view/tablegeometry.ts"),d=n("./src/controller/placeball.ts"),v=n("./src/events/placeballevent.ts"),m=n("./src/utils/utils.ts"),y=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"shotInfo",value:function(e,n,r){var i=s.P.firstCollision(n);return{pots:s.P.potCount(n),firstCollision:i,legalFirstCollision:t.isLegalFirstCollision(e,r,i),whitePotted:s.P.isCueBallPotted(e.cueball,n)}}},{key:"isLegalFirstCollision",value:function(e,n,r){if(!r)return!1;var i=r.ballB.id;return n?i>=7:!(t.coloursOnTable(e).filter(function(e){return e.id<i}).length>0)}},{key:"respotAllPottedColours",value:function(e,t){return s.P.pots(t).filter(function(e){return e.id<7}).filter(function(e){return 0!==e.id}).map(function(t){return a.k.respot(t,e)})}},{key:"redsOnTable",value:function(e){return e.balls.slice(7).filter(function(e){return e.onTable()})}},{key:"coloursOnTable",value:function(e){return e.balls.slice(1,7).filter(function(e){return e.onTable()})}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}(),b=n("./src/events/startaimevent.ts");function g(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function w(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var k=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");w(this,"cueball",void 0),w(this,"previousPotRed",!1),w(this,"targetIsRed",!0),w(this,"currentBreak",0),w(this,"previousBreak",0),w(this,"foulPoints",0),w(this,"score",0),w(this,"rulename","snooker"),w(this,"container",void 0),this.container=e}return e=[{key:"snookerrule",value:function(e){this.foulPoints=0;var t=y.shotInfo(this.container.table,e,this.targetIsRed);if(0===t.pots){if(!t.legalFirstCollision){var n,r,i,s=null!=(i=null==(r=t.firstCollision)||null==(n=r.ballB)?void 0:n.id)?i:0;this.foulPoints=Math.max(4,s+1)}return this.currentBreak,this.targetIsRed=y.redsOnTable(this.container.table).length>0,this.switchPlayer()}return this.targetIsRed?this.targetRedRule(e,t):this.targetColourRule(e,t)}},{key:"targetRedRule",value:function(e,t){return(console.log("applying target red rule"),t.legalFirstCollision&&s.P.onlyRedsPotted(e))?(this.currentBreak+=t.pots,this.targetIsRed=!1,this.previousPotRed=!0,this.container.hud.updateBreak(this.currentBreak),this.continueBreak()):(this.foulPoints=this.foulCalculation(e,t),this.respot(e),t.whitePotted)?this.whiteInHand():this.switchPlayer()}},{key:"targetColourRule",value:function(e,t){if(console.log("applying target colour rule"),t.whitePotted)return this.respot(e),this.whiteInHand();if(t.pots>1)return this.foulPoints=this.foulCalculation(e,t),this.respot(e),this.switchPlayer();if(s.P.pots(e)[0].id>6)return this.foulPoints=this.foulCalculation(e,t),this.switchPlayer();this.targetIsRed=y.redsOnTable(this.container.table).length>0;var n=s.P.pots(e)[0].id;return n!==t.firstCollision.ballB.id?this.foul(e,t):this.previousPotRed?(this.respot(e),this.currentBreak+=n+1,this.previousPotRed=!1,this.continueBreak()):y.coloursOnTable(this.container.table).filter(function(e){return e.id<n}).length>0?this.foul(e,t):(this.currentBreak+=n+1,this.previousPotRed=!1,this.continueBreak())}},{key:"foul",value:function(e,t){return this.foulPoints=this.foulCalculation(e,t),this.respot(e),this.switchPlayer()}},{key:"foulCalculation",value:function(e,t){var n,r,i,o,a=s.P.pots(e).map(function(e){return e.id}).filter(function(e){return e<7}),l=null!=(o=null==(i=t.firstCollision)||null==(r=i.ballB)?void 0:r.id)?o:0;return l>6&&(l=0),(n=Math).max.apply(n,[3,l].concat(function(e){if(Array.isArray(e))return g(e)}(a)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(a)||function(e,t){if(e){if("string"==typeof e)return g(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return g(e,t)}}(a)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()))+1}},{key:"tableGeometry",value:function(){p.P.hasPockets=!0}},{key:"table",value:function(){var e=new f.X(this.rack());return this.cueball=e.cueball,e}},{key:"otherPlayersCueBall",value:function(){return this.cueball}},{key:"secondToPlay",value:function(){}},{key:"isPartOfBreak",value:function(e){return this.currentBreak>0}},{key:"isEndOfGame",value:function(e){return s.P.isClearTable(this.container.table)&&this.currentBreak>0}},{key:"allowsPlaceBall",value:function(){return!0}},{key:"asset",value:function(){return t.tablemodel}},{key:"startTurn",value:function(){this.previousPotRed=!1,this.targetIsRed=y.redsOnTable(this.container.table).length>0,this.previousBreak=this.currentBreak,this.score+=this.currentBreak,this.currentBreak=0,this.container.hud.updateBreak(this.currentBreak)}},{key:"rack",value:function(){return o.m.snooker()}},{key:"nextCandidateBall",value:function(){var e=this.container.table,t=y.redsOnTable(e),n=y.coloursOnTable(e);return this.previousPotRed?a.k.closest(e.cueball,n):t.length>0?a.k.closest(e.cueball,t):n.length>0?n[0]:void 0}},{key:"placeBall",value:function(e){if(e){var t=new r.Pq0(o.m.baulk,0,0),n=o.m.sixth,i=e.distanceTo(t);if(e.x>=o.m.baulk&&(e.x=o.m.baulk),!(i>n))return e;var s=e.clone().sub(t).normalize();return t.add(s.multiplyScalar(n))}return new r.Pq0(o.m.baulk,-o.m.sixth/2.6,0)}},{key:"switchPlayer",value:function(){this.foulPoints>0&&console.log("foul, ".concat(this.foulPoints," to opponent")),console.log("end of break, switch player");var e=this.container.table;return(console.log(e.cue.aim),this.container.sendEvent(new b.M(this.foulPoints)),this.container.isSinglePlayer)?(this.container.sendEvent(new i.Q(e.serialise())),this.startTurn(),new l.m(this.container)):new c.r(this.container)}},{key:"continueBreak",value:function(){this.container.hud.updateBreak(this.currentBreak);var e=this.container.table;return(this.container.sound.playSuccess(e.inPockets()),s.P.isClearTable(e))?(this.container.eventQueue.push(new u.b(null,"game over")),this.container.recorder.wholeGameLink(),new h.o(this.container)):(this.container.sendEvent(new i.Q(e.serialise())),new l.m(this.container))}},{key:"whiteInHand",value:function(){return(this.foulPoints>0&&console.log("foul, ".concat(this.foulPoints," to opponent")),this.startTurn(),this.container.isSinglePlayer)?new d.x(this.container):(this.container.sendEvent(new v.z(m.v_,!0)),new c.r(this.container))}},{key:"update",value:function(e){return this.snookerrule(e)}},{key:"respot",value:function(e){var t=y.respotAllPottedColours(this.container.table,e);if(t.length>0){var n={balls:t.map(function(e){return e.serialise()}),rerack:!0},r=new i.Q(n);this.container.sendEvent(r),this.container.recorder.record(r)}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();w(k,"tablemodel","models/d-snooker.min.gltf")},"./src/controller/watchaim.ts":(e,t,n)=>{n.d(t,{r:()=>l});var r=n("./src/controller/watchshot.ts"),i=n("./src/controller/controllerbase.ts");function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function o(e,t){return(o=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function a(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(a=function(){return!!e})()}var l=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){var t,r,i;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return r=n,i=[e],r=s(r),(t=function(e,t){var n;if(t&&("object"==((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,a()?Reflect.construct(r,i||[],s(this).constructor):r.apply(this,i))).container.table.cueball=t.container.rules.otherPlayersCueBall(),t.container.table.cue.moveTo(t.container.table.cueball.pos),t.container.view.camera.suggestMode(t.container.view.camera.topView),t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&o(n,e),t=[{key:"handleAim",value:function(e){return this.container.table.cue.aim=e,this.container.table.cueball.pos.copy(e.pos),this}},{key:"handleHit",value:function(e){return this.container.table.updateFromSerialised(e.tablejson),new r.O(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(i.y)},"./src/controller/watchshot.ts":(e,t,n)=>{n.d(t,{O:()=>u});var r=n("./src/controller/aim.ts"),i=n("./src/controller/watchaim.ts"),s=n("./src/controller/controllerbase.ts"),o=n("./src/controller/placeball.ts");function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(c=function(){return!!e})()}var u=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(e){var t,r,i;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return r=n,i=[e],r=a(r),(t=function(e,t){var n;if(t&&("object"==((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,c()?Reflect.construct(r,i||[],a(this).constructor):r.apply(this,i))).container.table.outcome=[],t.container.table.hit(),t}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&l(n,e),t=[{key:"handleStartAim",value:function(e){return new r.m(this.container)}},{key:"handlePlaceBall",value:function(e){return new o.x(this.container)}},{key:"handleWatch",value:function(e){return"rerack"in e.json?(console.log("Respot"),this.container.table.updateFromSerialised(e.json),this):new i.r(this.container)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(s.y)},"./src/diagram/diagramcontainer.ts":(e,t,n)=>{n.d(t,{n:()=>x});var r=n("./src/container/container.ts"),i=n("./src/events/keyboard.ts"),s=n("./src/events/breakevent.ts"),o=n("./src/view/cameratop.ts"),a=n("./src/model/physics/physics.ts"),l=n("./src/view/assets.ts"),c=n("./node_modules/three/build/three.core.js");function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}var h=function(){var e;function t(e){var n,r,i=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");r=void 0,(n="shots")in this?Object.defineProperty(this,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):this[n]=r,this.shots=e.map(function(e){return i.interpolateAllBalls(e)})}return e=[{key:"interpolateUntilMove",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.3,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e-5;return e.t.length>1&&e.t[1]-e.t[0]>t&&(e.t.splice(1,0,e.t[1]-n),e.x.splice(1,0,e.x[0]),e.y.splice(1,0,e.y[0])),e}},{key:"interpolateAllBalls",value:function(e){var t=this;return e.balls=Object.fromEntries(Object.entries(e.balls).map(function(e){var n=function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n,r,i=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=i){var s=[],o=!0,a=!1;try{for(i=i.call(e);!(o=(n=i.next()).done)&&(s.push(n.value),s.length!==t);o=!0);}catch(e){a=!0,r=e}finally{try{o||null==i.return||i.return()}finally{if(a)throw r}}return s}}(e,2)||function(e,t){if(e){if("string"==typeof e)return u(e,2);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return u(e,t)}}(e,2)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(),r=n[0],i=n[1];return[r,t.interpolateUntilMove(i)]})),e}},{key:"getInterpolatedPosition",value:function(e,t,n){if(!e||0===e.length||n<=e[0])return t[0];if(n>=e[e.length-1])return t[t.length-1];for(var r=0,i=e.length-1;r<i-1;){var s=Math.floor((r+i)/2);e[s]<n?r=s:i=s}var o=e[r],a=e[i],l=t[r];return l+(n-o)/(a-o)*(t[i]-l)}},{key:"getPositionsAtTime",value:function(e,t){var n=this.shots.find(function(t){return t.shotID===e}),r={};for(var i in n.balls){var s=n.balls[i],o=this.getInterpolatedPosition(s.t,s.x,t),a=this.getInterpolatedPosition(s.t,s.y,t);r[i]={x:o,y:a}}return r}},{key:"realToSim",value:function(e,t){return{x:2.3*(.71-t[e].x/2),y:2.3*(-.36+t[e].y/2)}}},{key:"identifyFirstMover",value:function(e){return console.log(e),e.balls["1"].t[1]<e.balls["2"].t[1]?"1":"2"}},{key:"estimateDirection",value:function(e){var t=this.getPositionsAtTime(e.shotID,0),n=this.getPositionsAtTime(e.shotID,.2),r=this.identifyFirstMover(e),i=t[r],s=new c.Pq0(i.x,i.y),o=n[r],a=new c.Pq0(o.x,o.y);return{pos1:t,pos2:n,firstMover:r,speed:2*s.distanceTo(a),angle:new c.Pq0(-1,0).angleTo(a.sub(s))}}},{key:"stateFrom",value:function(e){var t=this.getPositionsAtTime(e.shotID,0),n={init:[],shots:[]};for(var r in t){var i=this.realToSim(r,t);n.init.push(i.x),n.init.push(i.y)}var s=this.estimateDirection(e);console.log("estimated",s);var o=+("1"!=s.firstMover);return console.log(s),n.shots.push({type:"AIM",offset:{x:-0,y:0,z:0},angle:s.angle,power:s.speed,pos:{x:n.init[2*o],y:n.init[2*o+1],z:0},i:o}),n}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var p=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");f(this,"ctx",void 0),f(this,"canvas",void 0),f(this,"BALL_COLORS",{1:"white",2:"yellow",3:"red"}),f(this,"BALL_DIAMETER",.0615),f(this,"TABLE_WIDTH",2.84),f(this,"PIXELS_PER_METER",void 0),f(this,"ballPaths",{}),this.canvas=e,this.ctx=this.canvas.getContext("2d"),this.PIXELS_PER_METER=this.canvas.width/this.TABLE_WIDTH}return e=[{key:"drawBall",value:function(e,t,n){var r=this.BALL_DIAMETER/2*this.PIXELS_PER_METER,i=this.canvas.width-e;this.ctx.beginPath(),this.ctx.arc(i,t,r,0,2*Math.PI),this.ctx.fillStyle=n,this.ctx.fill(),this.ctx.strokeStyle="black",this.ctx.lineWidth=1,this.ctx.stroke()}},{key:"drawBallPath",value:function(e,t){var n=this,r=this.BALL_COLORS[e];this.ctx.save(),this.ctx.beginPath(),t.forEach(function(e,t){var r=n.canvas.width-e.x*n.PIXELS_PER_METER,i=n.canvas.height-e.y*n.PIXELS_PER_METER;0===t?n.ctx.moveTo(r,i):n.ctx.lineTo(r,i)}),this.ctx.setLineDash([4,4]),this.ctx.strokeStyle=r,this.ctx.lineWidth=1,this.ctx.stroke(),this.ctx.restore()}},{key:"clear",value:function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}},{key:"drawShot",value:function(e){for(var t in this.ballPaths)this.drawBallPath(t,this.ballPaths[t]);for(var n in e){var r=e[n],i=this.BALL_COLORS[n],s=r.x*this.PIXELS_PER_METER,o=this.canvas.height-r.y*this.PIXELS_PER_METER;this.drawBall(s,o,i)}}},{key:"resetCanvas",value:function(){this.clear(),this.ballPaths={}}},{key:"updateBallPaths",value:function(e,t){this.ballPaths[e]||(this.ballPaths[e]=[]),this.ballPaths[e].push(t)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),d=n("./src/events/abortevent.ts"),v=n("./src/events/beginevent.ts");function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var y=function(){var e;function t(){var e;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");m(this,"aimBall",void 0),m(this,"aimCoordinatesDisplay",void 0),m(this,"aimBallContainer",void 0),m(this,"powerSlider",void 0),m(this,"directionSlider",void 0),m(this,"BALL_CONTAINER_RADIUS",void 0),m(this,"MAX_DISTANCE",.7),m(this,"position",{x:0,y:0}),m(this,"power",5),m(this,"direction",0),this.aimBall=document.getElementById("aim-ball"),this.aimCoordinatesDisplay=document.getElementById("aim-coordinates"),this.aimBallContainer=document.getElementById("aim-ball-container"),this.powerSlider=document.getElementById("power"),this.directionSlider=document.getElementById("direction"),this.BALL_CONTAINER_RADIUS=((null==(e=this.aimBallContainer)?void 0:e.clientWidth)||0)/2,this.addEventListeners()}return e=[{key:"addEventListeners",value:function(){var e,t,n,r=this;null==(e=this.aimBallContainer)||e.addEventListener("click",function(e){return r.handleClick(e)}),null==(t=this.powerSlider)||t.addEventListener("input",function(e){r.power=parseInt(e.target.value)}),null==(n=this.directionSlider)||n.addEventListener("input",function(e){r.direction=parseInt(e.target.value)})}},{key:"handleClick",value:function(e){if(this.aimBallContainer&&this.aimBall){var t=this.aimBallContainer.getBoundingClientRect(),n=e.clientX-t.left-t.width/2,r=e.clientY-t.top-t.height/2;if(Math.sqrt(n*n+r*r)>this.MAX_DISTANCE*this.BALL_CONTAINER_RADIUS){var i=Math.atan2(r,n);n=this.MAX_DISTANCE*this.BALL_CONTAINER_RADIUS*Math.cos(i),r=this.MAX_DISTANCE*this.BALL_CONTAINER_RADIUS*Math.sin(i)}var s=t.width/2-this.aimBall.offsetWidth/2,o=t.height/2-this.aimBall.offsetHeight/2,a=Math.max(-s,Math.min(s,n)),l=Math.max(-o,Math.min(o,r));this.position.x=a/this.BALL_CONTAINER_RADIUS,this.position.y=l/this.BALL_CONTAINER_RADIUS,this.updateDom()}}},{key:"updateDom",value:function(){if(this.aimBall&&this.aimBallContainer){var e=this.aimBallContainer.getBoundingClientRect(),t=this.position.x*this.BALL_CONTAINER_RADIUS,n=this.position.y*this.BALL_CONTAINER_RADIUS;this.aimBall.style.left="".concat(t+e.width/2-this.aimBall.offsetWidth/2,"px"),this.aimBall.style.top="".concat(n+e.height/2-this.aimBall.offsetHeight/2,"px"),this.aimCoordinatesDisplay&&(this.aimCoordinatesDisplay.textContent="x: ".concat(this.position.x.toFixed(2),", y: ").concat(this.position.y.toFixed(2)))}}},{key:"getAim",value:function(){return{offset:{x:this.position.x,y:this.position.y,z:0},angle:this.direction,power:this.power}}},{key:"setAim",value:function(e){this.position.x=e.offset.x,this.position.y=e.offset.y,this.power=e.power,this.powerSlider.value=e.power.toString(),this.direction=e.angle,this.directionSlider.value=e.angle.toString(),console.log("set aim",e),this.updateDom()}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function b(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var g=function(){var e;function t(e,n){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");b(this,"drawer",void 0),b(this,"aimInputs",void 0),b(this,"fileInput",document.getElementById("fileInput")),b(this,"shotIndexDisplay",document.getElementById("shotIndexDisplay")),b(this,"shotSelector",document.getElementById("shotSelector")),b(this,"replayButton",document.getElementById("replay")),b(this,"myIframe",document.getElementById("myIframe")),b(this,"allShots",[]),b(this,"currentShotIndex",0),b(this,"animationTimer",-2.35),b(this,"isPlaying",!1),b(this,"lastFrameTime",0),b(this,"animationStartTime",0),b(this,"realPosition",null),b(this,"elapsedTime",0),b(this,"container",void 0),this.drawer=new p(e),this.container=n,this.aimInputs=new y,n&&(n.frame=this.advance.bind(this)),this.start()}return e=[{key:"start",value:function(){console.log("real overlay start"),this.loadDefaultData(),this.addEventListeners()}},{key:"addEventListeners",value:function(){var e=this;this.fileInput.addEventListener("change",function(t){return e.handleFileChange(t)}),this.shotSelector.addEventListener("change",function(){return e.handleShotSelect()}),this.replayButton.addEventListener("click",function(){return e.handleReplay()})}},{key:"handleFileChange",value:function(e){var t=this,n=e.target.files[0];if(n){var r=new FileReader;r.onload=function(e){try{var n=JSON.parse(e.target.result);t.processShots(n)}catch(e){console.error("Error parsing JSON:",e),alert("Error parsing JSON file.")}},r.readAsText(n)}}},{key:"handleShotSelect",value:function(){this.currentShotIndex=parseInt(this.shotSelector.value,10),this.updateDisplay(),this.resetAnimation()}},{key:"loadDefaultData",value:function(){var e=this;fetch("simple_shots.json").then(function(e){if(!e.ok)throw Error("HTTP error! status: ".concat(e.status));return e.json()}).then(function(t){return e.processShots(t)})}},{key:"processShots",value:function(e){this.allShots=e,this.realPosition=new h(this.allShots),this.allShots.length>0&&(this.currentShotIndex=0,this.populateShotSelector(),this.updateDisplay(),this.resetAnimation())}},{key:"populateShotSelector",value:function(){var e=this;this.shotSelector.innerHTML="",this.allShots.forEach(function(t,n){var r=document.createElement("option");r.value=n.toString(),r.text="Shot ".concat(n+1," (ID: ").concat(t.shotID,")"),e.shotSelector.appendChild(r)}),this.allShots.length>0&&(this.shotSelector.value=this.currentShotIndex.toString())}},{key:"updateDisplay",value:function(){this.shotIndexDisplay.textContent="Shot: ".concat(this.currentShotIndex+1),this.allShots[this.currentShotIndex]&&(this.shotSelector.value=this.currentShotIndex.toString())}},{key:"drawShot",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(this.realPosition){var n=this.realPosition.getPositionsAtTime(e.shotID,t);if(n){for(var r in n)this.drawer.updateBallPaths(r,n[r]);this.drawer.clear(),this.drawer.drawShot(n)}}}},{key:"handleReplay",value:function(){this.resetAnimation()}},{key:"resetAnimation",value:function(){this.isPlaying=!1,this.animationTimer=-2.3,this.drawer.resetCanvas(),this.drawShot(this.allShots[this.currentShotIndex],0),this.resetSimulation(this.allShots[this.currentShotIndex])}},{key:"resetSimulation",value:function(e){console.log("reset simulation");var t=this.realPosition.stateFrom(e);this.container.table.updateFromShortSerialised(t.init),this.container.eventQueue.push(new d.h),this.container.eventQueue.push(new v.u),this.container.eventQueue.push(new s.W(t.init,t.shots)),this.aimInputs.setAim(t.shots[0])}},{key:"advance",value:function(e){this.elapsedTime+=e,this.animationTimer+=e;var t=this.allShots[this.currentShotIndex];this.drawShot(t,this.animationTimer)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function w(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function k(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var x=function(){var e,t;function n(e,t,r){var i=this;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");k(this,"container",void 0),k(this,"canvas3d",void 0),k(this,"ruletype",void 0),k(this,"replay",void 0),k(this,"cushionModel",void 0),k(this,"breakState",{init:null,shots:[]}),k(this,"realOverlay",void 0),k(this,"onAssetsReady",function(){console.log("diagram ready");var e=document.getElementById("replay");i.replayButton(e);var t=document.getElementById("overlaycanvas");t?i.realOverlay=new g(t,i.container):(i.breakState=JSON.parse(decodeURIComponent(i.replay)),i.container.eventQueue.push(new s.W(i.breakState.init,i.breakState.shots))),i.container.animate(performance.now())}),this.replay=r,this.ruletype=t,this.canvas3d=e,o.v.zoomFactor=.88}return e=[{key:"start",value:function(){var e=new i.s(this.canvas3d);this.container=new r.m(this.canvas3d,console.log,l.s.localAssets(this.ruletype),this.ruletype,e,"diagram"),this.cushionModel&&(this.container.table.cushionModel=this.cushionModel),this.onAssetsReady()}},{key:"replayButton",value:function(e){var t=this;e.innerHTML="↻",e.addEventListener("click",function(){var e;0==t.container.eventQueue.length&&t.container.eventQueue.push(new s.W(t.breakState.init,t.breakState.shots)),null==(e=t.realOverlay)||e.start()})}}],t=[{key:"fromDiamgramElement",value:function(e){var t=null==e?void 0:e.getElementsByClassName("topview")[0],r=null==t?void 0:t.getAttribute("data-state"),i=new URLSearchParams(r),s=null==e?void 0:e.getElementsByClassName("description")[0],o=document.getElementById("common"),l=document.createElement("a");l.href="../".concat(r),l.innerHTML="⬀",l.target="_blank",null==s||s.appendChild(l),null==o||o.appendChild(l);var c=document.createElement("button");null==s||s.appendChild(c);var u=new n(t,i.get("ruletype"),i.get("state"));return u.replayButton(c),"bounceHan"==i.get("cushionModel")&&(u.cushionModel=a.QV),u}}],e&&w(n.prototype,e),t&&w(n,t),n}()},"./src/diagrams.ts":(e,t,n)=>{var r,i,s,o,a,l,c,u,h,f=n("./src/model/physics/physics.ts"),p=n("./node_modules/three/build/three.core.js");function d(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var v=function(){var e;function t(e,n){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");d(this,"canvas",void 0),d(this,"context",void 0),d(this,"endx",100),d(this,"endy",100),d(this,"scale",2e3),d(this,"r",20),e.firstElementChild.innerHTML=n,this.canvas=e.lastElementChild,this.context=this.canvas.getContext("2d")}return e=[{key:"drawBall",value:function(){this.context.beginPath(),this.context.strokeStyle="lightgray",this.context.fillStyle="beige",this.context.arc(this.endx,this.endy,this.r,0,2*Math.PI,!1),this.context.fill(),this.context.stroke()}},{key:"drawCushion",value:function(){var e=this.context.createLinearGradient(10,90,200,90);e.addColorStop(0,"lightgray"),e.addColorStop(.75,"white"),this.context.fillStyle=e,this.context.fillRect(this.endx+this.r,10,200,250)}},{key:"plot",value:function(e,t,n,r,i){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawCushion(),this.drawBall();for(var s=e;s<=t;s+=n){var o=r(s),a=i(s),l=(0,f.yO)(o,a)?[]:[2,2];this.context.setLineDash(l);var c=(s+360)*101%360;this.context.strokeStyle="hsl(".concat(c,",50%,50%)"),this.drawArrow(this.endx-o.x*this.scale,this.endy-o.y*this.scale,this.endx,this.endy);var u=(0,f.QK)(0,o,a,f.Qy);o.add(u.v),this.drawArrow(this.endx,this.endy,this.endx+o.x*this.scale,this.endy+o.y*this.scale)}}},{key:"drawArrow",value:function(e,t,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:.9,s={dx:n-e,dy:r-t},o={x:s.dx*i+e,y:s.dy*i+t},a={dx:n-o.x,dy:r-o.y};this.context.beginPath(),this.context.moveTo(e,t),this.context.lineTo(o.x,o.y),this.context.moveTo(o.x+.5*a.dy,o.y-.5*a.dx),this.context.lineTo(o.x-.5*a.dy,o.y+.5*a.dx),this.context.lineTo(n,r),this.context.closePath(),this.context.stroke()}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function m(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function b(e){return function(e){if(Array.isArray(e))return m(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return m(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return m(e,t)}}(e)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var g=function(){var e;function t(e,n,r){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");y(this,"canvas",void 0),y(this,"ctx",void 0),y(this,"xAxis",void 0),y(this,"yAxis",void 0),y(this,"gutter",20),this.canvas=document.getElementById(e),this.ctx=this.canvas.getContext("2d"),this.canvas.previousElementSibling.innerHTML=n,this.canvas.nextElementSibling.innerHTML=r}return e=[{key:"plot",value:function(e,t,n){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.shadowColor="grey",this.ctx.shadowBlur=2;var r=b(t).concat(b(n));r.push(0),this.xAxis=this.axisInfo(e,this.canvas.width),this.yAxis=this.axisInfo(r,this.canvas.height),this.drawXAxis(e),this.drawYAxis(r),this.plotLine(e,t,"blue"),this.plotLine(e,n,"red")}},{key:"plotLine",value:function(e,t,n){this.ctx.beginPath();for(var r=0;r<e.length;r++){var i=this.scale(e[r],this.xAxis),s=this.canvas.height-.8*this.scale(t[r],this.yAxis)-this.gutter;0===r?this.ctx.moveTo(i,s):this.ctx.lineTo(i,s)}this.ctx.strokeStyle=n,this.ctx.stroke()}},{key:"drawXAxis",value:function(e){var t=this.canvas.height-this.gutter;this.ctx.beginPath(),this.ctx.moveTo(0,t),this.ctx.lineTo(this.canvas.width,t),this.ctx.strokeStyle="grey",this.ctx.stroke(),this.ctx.font="8px Arial",this.ctx.strokeStyle="grey";for(var n=!1,r=2;r<e.length-2;r++){var i=this.scale(e[r],this.xAxis);this.ctx.beginPath(),this.ctx.moveTo(i,t),this.ctx.lineTo(i,t+4),this.ctx.stroke(),n||this.ctx.fillText(e[r],i-5,t+10),n=!n}}},{key:"drawYAxis",value:function(e){var t,n=(t=Math).max.apply(t,b(e)),r=this.canvas.height-.8*this.scale(n,this.yAxis)-this.gutter,i=this.canvas.height-.8*this.scale(0,this.yAxis)-this.gutter;this.ctx.beginPath(),this.ctx.moveTo(0,i),this.ctx.lineTo(0,r),this.ctx.strokeStyle="grey",this.ctx.stroke(),this.ctx.fillText("".concat("0.000"),0,i),this.ctx.fillText("".concat(n.toFixed(3)),0,r)}},{key:"scale",value:function(e,t){return(e-t.min)*t.scale}},{key:"axisInfo",value:function(e,t){var n,r,i=(n=Math).min.apply(n,b(e)),s=(r=Math).max.apply(r,b(e));return{min:i,max:s,scale:t/(s-i||1)}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),w=n("./src/model/ball.ts"),k=n("./src/model/physics/constants.ts"),x=n("./src/utils/utils.ts");function T(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var P=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");T(this,"ball",void 0),T(this,"theta",0),T(this,"canvas",void 0),T(this,"ctx",void 0),T(this,"step",.01),this.canvas=e,this.ctx=this.canvas.getContext("2d"),this.ball=new w.c(x.v_),this.ball.vel.copy(new p.Pq0(32*k.R,0,0)),this.ball.rvel.copy(new p.Pq0(0,-(2*this.ball.vel.x)/k.R,0)),this.ball.state=w.U.Sliding}return e=[{key:"drawBall",value:function(e,t,n){var r=this.canvas.width,i=this.canvas.height,s=r/(27*k.R);this.ctx.beginPath(),this.ctx.strokeStyle=n,this.ctx.fillStyle=n;var o=e*s+2*k.R*s,a=t*s+i/2,l=k.R*s;this.ctx.ellipse(o,a,l,l,0,0,2*Math.PI),this.ctx.stroke();var c=o+-(k.R*Math.sin(this.theta))*s,u=a+k.R*Math.cos(this.theta)*s;this.ctx.beginPath(),this.ctx.strokeStyle="black",this.ctx.moveTo(o,a),this.ctx.lineTo(c,u),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.fillStyle="black",this.ctx.arc(c,u,3,0,2*Math.PI),this.ctx.fill()}},{key:"advance",value:function(e){this.ball.update(e);var t=this.ball.rvel.length()*e;this.theta+=t}},{key:"draw",value:function(e){this.ctx.clearRect(0,0,1,1);for(var t=0;t<e;){var n="blue";this.ball.isRolling()?n="red":this.ball.inMotion()&&(n="green"),this.drawBall(this.ball.pos.x,0,n),this.advance(this.step),t+=this.step}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),R=n("./src/view/sliders.ts"),S=n("./src/diagram/diagramcontainer.ts"),E=n("./src/view/cue.ts"),A=3*k.R;function O(e){A=e}function M(){r&&(function(){function e(e){return function(t){return I(0,0,e)}}var t=function(e){return I(Math.cos(e*Math.PI/180),Math.sin(e*Math.PI/180),0)};r.plot(10,80,10,t,function(e){return I(0,0,0)}),i.plot(10,80,10,t,e(-40)),s.plot(10,80,10,t,e(40)),o.plot(-6,6,1,function(e){return I(.7,.7,0)},function(e){return I(0,0,6*e)}),a.plot(-6,6,1,function(e){return I(2,2,0)},function(e){return I(0,0,6*e)})}(),function(){for(var e=[],t=[],n=[],r=-180;r<=180;r+=30){e.push(r);var i=new p.Pq0(.2*k.R,0,0),s=new p.Pq0(0,0,r*k.R);t.push((0,f.Gp)((0,f.c0)(i))),n.push((0,f.Un)((0,f.s0)(i,s)))}l.plot(e,t,n)}(),function(){for(var e=[],t=[],n=[],r=-180;r<=180;r+=30){e.push(r);var i=new p.Pq0(150*k.R,0,0),s=new p.Pq0(0,r*k.R,0);t.push((0,f.Gp)((0,f.c0)(i))),n.push((0,f.Un)((0,f.s0)(i,s)))}c.plot(e,t,n)}(),function(){for(var e=[],t=[],n=[],r=-80;r<=80;r+=10){e.push(r);var i=r*Math.PI/180,s=new p.Pq0(Math.cos(i)*k.R,Math.sin(i)*k.R,0);s.multiplyScalar(A);var o=new p.Pq0(0,0,-10*k.R);t.push((0,f.Gp)((0,f.c0)(s))),n.push((0,f.Un)((0,f.s0)(s,o)))}u.plot(e,t,n)}(),function(){for(var e=[],t=[],n=[],r=0;r<=88;r+=2){e.push(r);var i=r*Math.PI/180,s=new p.Pq0(Math.cos(i)*k.R,Math.sin(i)*k.R,0),o=new p.Pq0(0,0,50*k.R),a=(0,f.QV)(s,o),l=s.clone().add(a.v),c=-(180*Math.atan2(-l.y,-l.x))/Math.PI;t.push(c);var u=(0,f.$8)(s,o),d=s.clone().add(u.v),v=-(180*Math.atan2(-d.y,-d.x))/Math.PI;n.push(v)}h.plot(e,t,n)}())}function _(e){return document.getElementById(e)}function I(e,t,n){return new p.Pq0(e*k.R,t*k.R,n*k.R)}document.addEventListener("DOMContentLoaded",function(){for(var e,t,n,d=document.getElementsByClassName("replaydiagram"),m=0;m<d.length;m++){var y=d.item(m);S.n.fromDiamgramElement(y).start()}var b=_("rollcanvas");b?new P(b).draw(5):(_("cushion1")&&(r=new v(_("cushion1"),"stun shot"),i=new v(_("cushion2"),"running side"),s=new v(_("cushion3"),"check side"),o=new v(_("cushion4"),"varying side"),a=new v(_("cushion5"),"varying side high vel"),l=new g("plot1","Top spin ball played slow directly into cushion","top/back spin w.y"),c=new g("plot2","Top spin ball played hard directly into cushion","top/back spin w.y"),u=new g("plot3","Right hand spinning ball with varying incident angleand speed s","Incident angle (degrees) of ball to cushion with right side"),h=new g("plot4","Bounce angle of ball with check side (y-axis outward angle)","Incident angle (degrees) of ball to cushion, 0=perpendicular, 90=parallel. Blue=Han2005 Red=Blend"),M()),new R.r(M).initialiseSlider("s",A,O,4),_("derived")&&(e=_("derived"),t=new p.Pq0(new E.s().maxPower,0,0),n=(0,f.t6)(new p.Pq0(.5),t),e.innerHTML+="Mx,My    = ".concat(k.x3.toFixed(6),`
`),e.innerHTML+="Mz       = ".concat(k.Mz.toFixed(6),`
`),e.innerHTML+="I        = ".concat(k.I.toFixed(6),`
`),e.innerHTML+="Max vel  = ".concat(t.length().toFixed(6),`
`),e.innerHTML+="Max rvel = ".concat(n.length().toFixed(4),`
`)))})},"./src/events/abortevent.ts":(e,t,n)=>{n.d(t,{h:()=>l});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function o(e,t){return(o=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function a(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(a=function(){return!!e})()}var l=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t,r;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return t=s(t=n),(e=function(e,t){var n;if(t&&("object"==((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,a()?Reflect.construct(t,[],s(this).constructor):t.apply(this,r))).type=i.B.ABORT,e}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&o(n,e),t=[{key:"applyToController",value:function(e){return e.handleAbort(this)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.F)},"./src/events/aimevent.ts":(e,t,n)=>{n.d(t,{w:()=>f});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts"),s=n("./src/utils/utils.ts"),o=n("./node_modules/three/build/three.core.js");function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function u(e,t){return(u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function h(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(h=function(){return!!e})()}var f=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(){var e,t,n;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return t=c(t=r),l(e=function(e,t){var n;if(t&&("object"==((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,h()?Reflect.construct(t,[],c(this).constructor):t.apply(this,n)),"offset",new o.Pq0(0,0,0)),l(e,"angle",0),l(e,"power",0),l(e,"pos",new o.Pq0(0,0,0)),l(e,"i",0),e.type=i.B.AIM,e}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&u(r,e),t=[{key:"applyToController",value:function(e){return e.handleAim(this)}},{key:"copy",value:function(){return r.fromJson(this)}}],n=[{key:"fromJson",value:function(e){var t=new r;return t.pos=(0,s.t6)(e.pos),t.angle=e.angle,t.offset=(0,s.t6)(e.offset),t.power=e.power,e.i&&(t.i=e.i),t}}],t&&a(r.prototype,t),n&&a(r,n),r}(r.F)},"./src/events/beginevent.ts":(e,t,n)=>{n.d(t,{u:()=>l});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function o(e,t){return(o=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function a(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(a=function(){return!!e})()}var l=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t,r;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return t=s(t=n),(e=function(e,t){var n;if(t&&("object"==((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,a()?Reflect.construct(t,[],s(this).constructor):t.apply(this,r))).type=i.B.BEGIN,e}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&o(n,e),t=[{key:"applyToController",value:function(e){return e.handleBegin(this)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.F)},"./src/events/breakevent.ts":(e,t,n)=>{n.d(t,{W:()=>u});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(c=function(){return!!e})()}var u=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(e,t){var n,s,l;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return s=a(s=r),o(n=function(e,t){var n;if(t&&("object"==((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,c()?Reflect.construct(s,[],a(this).constructor):s.apply(this,l)),"init",void 0),o(n,"shots",void 0),o(n,"retry",void 0),n.init=e,n.shots=t,n.type=i.B.BREAK,n}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&l(r,e),t=[{key:"applyToController",value:function(e){return e.handleBreak(this)}}],n=[{key:"fromJson",value:function(e){return new r(e.init,e.shots)}}],t&&s(r.prototype,t),n&&s(r,n),r}(r.F)},"./src/events/chatevent.ts":(e,t,n)=>{n.d(t,{b:()=>u});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(c=function(){return!!e})()}var u=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(e,t){var n,s,l;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return s=a(s=r),o(n=function(e,t){var n;if(t&&("object"==((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,c()?Reflect.construct(s,[],a(this).constructor):s.apply(this,l)),"sender",void 0),o(n,"message",void 0),n.sender=e,n.message=t,n.type=i.B.CHAT,n}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&l(r,e),t=[{key:"applyToController",value:function(e){return e.handleChat(this)}}],n=[{key:"fromJson",value:function(e){return new r(e.sender,e.message)}}],t&&s(r.prototype,t),n&&s(r,n),r}(r.F)},"./src/events/eventtype.ts":(e,t,n)=>{n.d(t,{B:()=>r});var r=function(e){return e.BEGIN="BEGIN",e.BREAK="BREAK",e.WATCHAIM="WATCHAIM",e.AIM="AIM",e.HIT="HIT",e.STATIONARY="STATIONARY",e.CHAT="CHAT",e.ABORT="ABORT",e.PLACEBALL="PLACEBALL",e.REJOIN="REJOIN",e.RERACK="RERACK",e.STARTAIM="STARTAIM",e}({})},"./src/events/eventutil.ts":(e,t,n)=>{n.d(t,{d:()=>w});var r=n("./src/events/eventtype.ts"),i=n("./src/events/aimevent.ts"),s=n("./src/events/watchevent.ts"),o=n("./src/events/hitevent.ts"),a=n("./src/events/abortevent.ts"),l=n("./src/events/breakevent.ts"),c=n("./src/events/beginevent.ts"),u=n("./src/events/chatevent.ts");function h(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function p(e){return(p=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function v(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(v=function(){return!!e})()}var m=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function i(){var e,t,n,s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(!(this instanceof i))throw TypeError("Cannot call a class as a function");return e=p(e=i),f(n=function(e,t){var n;if(t&&("object"==((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,v()?Reflect.construct(e,[],p(this).constructor):e.apply(this,t)),"clientResendFrom",void 0),f(n,"serverResendFrom",void 0),n.type=r.B.REJOIN,n.clientResendFrom=s,n.serverResendFrom=o,n}return i.prototype=Object.create(e&&e.prototype,{constructor:{value:i,writable:!0,configurable:!0}}),e&&d(i,e),t=[{key:"applyToController",value:function(e){return e.handleRejoin(this)}}],n=[{key:"fromJson",value:function(e){return new i(e.clientResendFrom,e.serverResendFrom)}}],t&&h(i.prototype,t),n&&h(i,n),i}(n("./src/events/gameevent.ts").F),y=n("./src/events/placeballevent.ts"),b=n("./src/events/rerackevent.ts"),g=n("./src/events/startaimevent.ts"),w=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"serialise",value:function(e){return JSON.stringify(e)}},{key:"fromJson",value:function(e){switch(e.type){case r.B.BEGIN:return new c.u;case r.B.AIM:return i.w.fromJson(e);case r.B.BREAK:return l.W.fromJson(e);case r.B.WATCHAIM:return s.Q.fromJson(e.json);case r.B.HIT:return o.Q.fromJson(e);case r.B.CHAT:return u.b.fromJson(e);case r.B.REJOIN:return m.fromJson(e);case r.B.ABORT:return new a.h;case r.B.PLACEBALL:return y.z.fromJson(e);case r.B.RERACK:return b.x.fromJson(e);case r.B.STARTAIM:return g.M.fromJson(e);default:throw Error("Unknown GameEvent :"+e)}}},{key:"fromSerialised",value:function(e){var n=JSON.parse(e),r=t.fromJson(n);return"sequence"in n&&(r.sequence=n.sequence),"clientId"in n&&(r.clientId=n.clientId),r}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/events/gameevent.ts":(e,t,n)=>{function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,{F:()=>i});var i=function e(){if(!(this instanceof e))throw TypeError("Cannot call a class as a function");r(this,"type",void 0),r(this,"sequence",void 0),r(this,"clientId",void 0)}},"./src/events/hitevent.ts":(e,t,n)=>{n.d(t,{Q:()=>c});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function o(e){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(e){var t,n,s,a,c;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return n=o(n=r),t=function(e,t){var n;if(t&&("object"==((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(n,[],o(this).constructor):n.apply(this,s)),c=void 0,(a="tablejson")in t?Object.defineProperty(t,a,{value:c,enumerable:!0,configurable:!0,writable:!0}):t[a]=c,t.type=i.B.HIT,t.tablejson=e,t}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&a(r,e),t=[{key:"applyToController",value:function(e){return e.handleHit(this)}}],n=[{key:"fromJson",value:function(e){return new r(e.tablejson)}}],t&&s(r.prototype,t),n&&s(r,n),r}(r.F)},"./src/events/input.ts":(e,t,n)=>{function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,{p:()=>i});var i=function e(t,n){if(!(this instanceof e))throw TypeError("Cannot call a class as a function");r(this,"t",void 0),r(this,"key",void 0),this.t=t,this.key=n}},"./src/events/keyboard.ts":(e,t,n)=>{n.d(t,{s:()=>a});var r=n("./src/events/input.ts"),i=n("./node_modules/interactjs/dist/interact.min.js"),s=n.n(i);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e;function t(e){var n=this;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");o(this,"pressed",{}),o(this,"released",{}),o(this,"keydown",function(e){null==n.pressed[e.code]&&(n.pressed[e.code]=performance.now()),e.stopImmediatePropagation(),"F12"!==e.key&&e.preventDefault()}),o(this,"keyup",function(e){n.released[e.code]=performance.now()-n.pressed[e.code],delete n.pressed[e.code],e.stopImmediatePropagation(),"F12"!==e.key&&e.preventDefault()}),o(this,"mousetouch",function(e){var t,r,i=n.released,s=e.client.y<e.rect.height/2||e.ctrlKey?.5:1,o=e.dx*s,a=.8*e.dy;i.movementY=(null!=(t=i.movementY)?t:0)+a,i.movementX=(null!=(r=i.movementX)?r:0)+o,Math.abs(i.movementX)>Math.abs(i.movementY)&&(i.movementY=0)}),this.addHandlers(e),/Android|iPhone/i.test(navigator.userAgent)||(e.contentEditable="true")}return e=[{key:"getEvents",value:function(){var e=this,t=Object.keys(this.pressed).filter(function(e){return!/Shift/.test(e)}).filter(function(e){return!/Control/.test(e)}),n=Object.keys(this.pressed).some(function(e){return/Shift/.test(e)}),i=Object.keys(this.pressed).some(function(e){return/Control/.test(e)}),s=[];return t.forEach(function(t){var o=performance.now()-e.pressed[t];s.push(new r.p(i?o/3:o,n?"Shift"+t:t)),"Space"!=t&&(e.pressed[t]=performance.now())}),Object.keys(this.released).forEach(function(t){return s.push(new r.p(e.released[t],t+"Up"))}),this.released={},s}},{key:"addHandlers",value:function(e){var t=this;e.addEventListener("keydown",this.keydown),e.addEventListener("keyup",this.keyup),e.focus(),s()(e).draggable({listeners:{move:function(e){t.mousetouch(e)}}}),s()(e).gesturable({onmove:function(e){e.dx/=3,t.mousetouch(e)}})}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/events/placeballevent.ts":(e,t,n)=>{n.d(t,{z:()=>h});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts"),s=n("./src/utils/utils.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(u=function(){return!!e})()}var h=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(e,t){var n,s,o;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return s=l(s=r),a(n=function(e,t){var n;if(t&&("object"==((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,u()?Reflect.construct(s,[],l(this).constructor):s.apply(this,o)),"pos",void 0),a(n,"allTable",void 0),n.pos=e,n.allTable=t,n.type=i.B.PLACEBALL,n}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&c(r,e),t=[{key:"applyToController",value:function(e){return e.handlePlaceBall(this)}}],n=[{key:"fromJson",value:function(e){return new r((0,s.t6)(e.pos),e.allTable)}}],t&&o(r.prototype,t),n&&o(r,n),r}(r.F)},"./src/events/rerackevent.ts":(e,t,n)=>{n.d(t,{x:()=>c});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function o(e){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(){var e,t,n,s,a;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return t=o(t=r),e=function(e,t){var n;if(t&&("object"==((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(t,[],o(this).constructor):t.apply(this,n)),a=void 0,(s="ballinfo")in e?Object.defineProperty(e,s,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[s]=a,e.type=i.B.RERACK,e}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&a(r,e),t=[{key:"applyToController",value:function(e){return e.container.table.updateFromSerialised(this.ballinfo),e}}],n=[{key:"fromJson",value:function(e){var t=new r;return t.ballinfo=e,t}}],t&&s(r.prototype,t),n&&s(r,n),r}(r.F)},"./src/events/startaimevent.ts":(e,t,n)=>{n.d(t,{M:()=>c});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function o(e){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(){var e,t,n,s,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return e=o(e=r),s=function(e,t){var n;if(t&&("object"==((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(e,[],o(this).constructor):e.apply(this,t)),(n="foul")in s?Object.defineProperty(s,n,{value:0,enumerable:!0,configurable:!0,writable:!0}):s[n]=0,s.type=i.B.STARTAIM,s.foul=a,s}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&a(r,e),t=[{key:"applyToController",value:function(e){return e.handleStartAim(this)}}],n=[{key:"fromJson",value:function(e){return new r(e.foul)}}],t&&s(r.prototype,t),n&&s(r,n),r}(r.F)},"./src/events/stationaryevent.ts":(e,t,n)=>{n.d(t,{T:()=>l});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function o(e,t){return(o=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function a(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(a=function(){return!!e})()}var l=function(e){var t;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function n(){var e,t,r;if(!(this instanceof n))throw TypeError("Cannot call a class as a function");return t=s(t=n),(e=function(e,t){var n;if(t&&("object"==((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,a()?Reflect.construct(t,[],s(this).constructor):t.apply(this,r))).type=i.B.STATIONARY,e}return n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),e&&o(n,e),t=[{key:"applyToController",value:function(e){return e.handleStationary(this)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(n.prototype,t),n}(r.F)},"./src/events/watchevent.ts":(e,t,n)=>{n.d(t,{Q:()=>c});var r=n("./src/events/gameevent.ts"),i=n("./src/events/eventtype.ts");function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function o(e){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(l=function(){return!!e})()}var c=function(e){var t,n;if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");function r(e){var t,n,s,a,c;if(!(this instanceof r))throw TypeError("Cannot call a class as a function");return n=o(n=r),t=function(e,t){var n;if(t&&("object"==((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)||"function"==typeof t))return t;if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,l()?Reflect.construct(n,[],o(this).constructor):n.apply(this,s)),c=void 0,(a="json")in t?Object.defineProperty(t,a,{value:c,enumerable:!0,configurable:!0,writable:!0}):t[a]=c,t.type=i.B.WATCHAIM,t.json=e,t}return r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&a(r,e),t=[{key:"applyToController",value:function(e){return e.handleWatch(this)}}],n=[{key:"fromJson",value:function(e){return new r(e)}}],t&&s(r.prototype,t),n&&s(r,n),r}(r.F)},"./src/model/ball.ts":(e,t,n)=>{n.d(t,{c:()=>d,U:()=>p});var r=n("./src/utils/utils.ts"),i=n("./src/model/physics/physics.ts"),s=n("./node_modules/three/build/three.core.js"),o=n("./src/model/physics/constants.ts");function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var l=function(){var e;function t(e,n){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");a(this,"line",void 0),a(this,"geometry",void 0),a(this,"positions",void 0),a(this,"lastPos",new s.Pq0),a(this,"lastVel",new s.Pq0),this.geometry=new s.LoY,this.positions=new Float32Array(3*e),this.geometry.setAttribute("position",new s.THS(this.positions,3)),this.reset();var r=new s.mrM({color:n,opacity:.25,linewidth:3,transparent:!0});this.line=new s.N1A(this.geometry,r),this.line.visible=!1}return e=[{key:"reset",value:function(){this.geometry.setDrawRange(0,0),this.lastVel.setZ(1)}},{key:"forceTrace",value:function(e){this.lastVel.z=1,this.addTraceGiven(e,this.lastVel,1,.1,1)}},{key:"addTrace",value:function(e,t){if(0!==t.length()){var n=this.lastVel.angleTo(t),r=n>Math.PI/32?.01*o.R:o.R,i=this.lastPos.distanceTo(e);this.addTraceGiven(e,t,i,r,n)}}},{key:"addTraceGiven",value:function(e,t,n,r,i){var s=this.geometry.drawRange.count;0!==s&&n<r||(s>1&&i<1e-4&&s--,this.lastPos.copy(e),this.lastVel.copy(t),this.addPoint(e,s))}},{key:"addPoint",value:function(e,t){var n=3*t;n>this.positions.length||(this.positions[n++]=e.x,this.positions[n++]=e.y,this.positions[n]=e.z,this.geometry.setDrawRange(0,t+1),this.line.geometry.attributes.position.needsUpdate=!0)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var u=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");c(this,"mesh",void 0),c(this,"shadow",void 0),c(this,"spinAxisArrow",void 0),c(this,"trace",void 0),c(this,"color",void 0),c(this,"m",new s.kn4),this.color=new s.Q1f(e),this.initialiseMesh(e)}return e=[{key:"updateAll",value:function(e,t){this.updatePosition(e.pos),this.updateArrows(e.pos,e.rvel,e.state),0!==e.rvel.lengthSq()&&(this.updateRotation(e.rvel,t),this.trace.addTrace(e.pos,e.vel))}},{key:"updatePosition",value:function(e){this.mesh.position.copy(e),this.shadow.position.copy(e)}},{key:"updateRotation",value:function(e,t){var n=e.length()*t;this.mesh.rotateOnWorldAxis((0,r.xb)(e),n)}},{key:"updateArrows",value:function(e,t,n){this.spinAxisArrow.setLength(o.R+o.R*t.length()/2,o.R,o.R),this.spinAxisArrow.position.copy(e),this.spinAxisArrow.setDirection((0,r.xb)(t)),n==p.Rolling?this.spinAxisArrow.setColor(0xcc0000):this.spinAxisArrow.setColor(52224)}},{key:"initialiseMesh",value:function(e){var t=new s.WBB(o.R,1),n=new s.tXL({emissive:0,flatShading:!0,vertexColors:!0,forceSinglePass:!0,shininess:25,specular:5592371});this.addDots(t,e),this.mesh=new s.eaF(t,n),this.mesh.name="ball",this.updateRotation(new s.Pq0().random(),100);var i=new s.tcD(.9*o.R,9);i.applyMatrix4(new s.kn4().identity().makeTranslation(0,0,-(.99*o.R)));var a=new s.V9B({color:1118498});this.shadow=new s.eaF(i,a),this.spinAxisArrow=new s.E0M(r.up,r.v_,2,0,.01,.01),this.spinAxisArrow.visible=!1,this.trace=new l(500,e)}},{key:"addDots",value:function(e,t){var n=this,r=e.attributes.position.count,i=new s.Q1f(t),o=new s.Q1f(0xaa2222);e.setAttribute("color",new s.THS(new Float32Array(3*r),3));for(var a=e.attributes.color,l=0;l<r/3;l++)this.colorVerticesForFace(l,a,this.scaleNoise(i.r),this.scaleNoise(i.g),this.scaleNoise(i.b));[0,96,111,156,186,195].forEach(function(e){n.colorVerticesForFace(e/3,a,o.r,o.g,o.b)})}},{key:"addToScene",value:function(e){e.add(this.mesh),e.add(this.shadow),e.add(this.spinAxisArrow),e.add(this.trace.line)}},{key:"colorVerticesForFace",value:function(e,t,n,r,i){t.setXYZ(3*e+0,n,r,i),t.setXYZ(3*e+1,n,r,i),t.setXYZ(3*e+2,n,r,i)}},{key:"scaleNoise",value:function(e){return(1-.25*Math.random())*e}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();function h(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var p=function(e){return e.Stationary="Stationary",e.Rolling="Rolling",e.Sliding="Sliding",e.Falling="Falling",e.InPocket="InPocket",e}({}),d=function(){var e,t;function n(e,t){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");f(this,"pos",void 0),f(this,"vel",r.v_.clone()),f(this,"rvel",r.v_.clone()),f(this,"futurePos",r.v_.clone()),f(this,"ballmesh",void 0),f(this,"state","Stationary"),f(this,"pocket",void 0),f(this,"id",n.id++),this.pos=e.clone(),this.ballmesh=new u(t||0xeeeeee*Math.random())}return e=[{key:"update",value:function(e){this.updatePosition(e),"Falling"==this.state?this.pocket.updateFall(this,e):this.updateVelocity(e)}},{key:"updateMesh",value:function(e){this.ballmesh.updateAll(this,e)}},{key:"updatePosition",value:function(e){this.pos.addScaledVector(this.vel,e)}},{key:"updateVelocity",value:function(e){this.inMotion()&&(this.isRolling()?(this.state="Rolling",(0,i.lx)(this.vel,this.rvel),this.addDelta(e,(0,i.JD)(this.rvel))):(this.state="Sliding",this.addDelta(e,(0,i.p2)(this.vel,this.rvel))))}},{key:"addDelta",value:function(e,t){t.v.multiplyScalar(e),t.w.multiplyScalar(e),this.passesZero(t)||(this.vel.add(t.v),this.rvel.add(t.w))}},{key:"passesZero",value:function(e){var t=(0,r.rq)(this.vel,e.v),n=(0,r.rq)(this.rvel,e.w);return!!(("Rolling"===this.state?t||n:t&&n)&&.01>Math.abs(this.rvel.z))&&(this.setStationary(),!0)}},{key:"setStationary",value:function(){this.vel.copy(r.v_),this.rvel.copy(r.v_),this.state="Stationary"}},{key:"isRolling",value:function(){return 0!==this.vel.lengthSq()&&0!==this.rvel.lengthSq()&&(0,i.Mq)(this.vel,this.rvel).length()<n.transition}},{key:"onTable",value:function(){return"Falling"!==this.state&&"InPocket"!==this.state}},{key:"inMotion",value:function(){return"Rolling"===this.state||"Sliding"===this.state||this.isFalling()}},{key:"isFalling",value:function(){return"Falling"===this.state}},{key:"futurePosition",value:function(e){return this.futurePos.copy(this.pos).addScaledVector(this.vel,e),this.futurePos}},{key:"fround",value:function(){this.pos.x=Math.fround(this.pos.x),this.pos.y=Math.fround(this.pos.y),this.vel.x=Math.fround(this.vel.x),this.vel.y=Math.fround(this.vel.y),this.rvel.x=Math.fround(this.rvel.x),this.rvel.y=Math.fround(this.rvel.y),this.rvel.z=Math.fround(this.rvel.z)}},{key:"serialise",value:function(){return{pos:this.pos.clone(),id:this.id}}}],t=[{key:"fromSerialised",value:function(e){return n.updateFromSerialised(new n((0,r.t6)(e.pos)),e)}},{key:"updateFromSerialised",value:function(e,t){var n,i;return e.pos.copy(t.pos),e.vel.copy(null!=(n=null==t?void 0:t.vel)?n:r.v_),e.rvel.copy(null!=(i=null==t?void 0:t.rvel)?i:r.v_),e.state="Stationary",e}}],e&&h(n.prototype,e),t&&h(n,t),n}();f(d,"id",0),f(d,"transition",.05)},"./src/model/outcome.ts":(e,t,n)=>{n.d(t,{P:()=>i});function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var i=function(){var e;function t(e,n,i,s){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");r(this,"type",void 0),r(this,"timestamp",void 0),r(this,"ballA",null),r(this,"ballB",null),r(this,"incidentSpeed",void 0),this.type=e,this.ballA=n,this.ballB=i,this.incidentSpeed=s,this.timestamp=Date.now()}return e=[{key:"pot",value:function(e,n){return new t("Pot",e,e,n)}},{key:"cushion",value:function(e,n){return new t("Cushion",e,e,n)}},{key:"collision",value:function(e,n,r){return new t("Collision",e,n,r)}},{key:"hit",value:function(e,n){return new t("Hit",e,e,n)}},{key:"isCueBallPotted",value:function(e,t){return t.some(function(t){return"Pot"==t.type&&t.ballA===e})}},{key:"isBallPottedNoFoul",value:function(e,n){return n.some(function(e){return"Pot"==e.type&&null!==e.ballA})&&!t.isCueBallPotted(e,n)}},{key:"pots",value:function(e){return e.filter(function(e){return"Pot"==e.type}).map(function(e){return e.ballA})}},{key:"potCount",value:function(e){return this.pots(e).length}},{key:"onlyRedsPotted",value:function(e){return this.pots(e).every(function(e){return e.id>6})}},{key:"firstCollision",value:function(e){var t=e.filter(function(e){return"Collision"===e.type});return t.length>0?t[0]:void 0}},{key:"isClearTable",value:function(e){var t=e.balls.filter(function(e){return e.onTable()});return 1===t.length&&t[0]===e.cueball}},{key:"isThreeCushionPoint",value:function(e,n){n=t.cueBallFirst(e,n).filter(function(t){return t.ballA===e});var r=new Set,i=0,s=!0,o=!1,a=void 0;try{for(var l,c=n[Symbol.iterator]();!(s=(l=c.next()).done);s=!0){var u=l.value;if("Cushion"===u.type&&i++,"Collision"===u.type&&(r.add(u.ballB),2===r.size))return i>=3}}catch(e){o=!0,a=e}finally{try{s||null==c.return||c.return()}finally{if(o)throw a}}return!1}},{key:"cueBallFirst",value:function(e,t){return t.forEach(function(t){"Collision"===t.type&&t.ballB===e&&(t.ballB=t.ballA,t.ballA=e)}),t}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/model/physics/collision.ts":(e,t,n)=>{n.d(t,{F:()=>c});var r=n("./src/model/ball.ts"),i=n("./node_modules/three/build/three.core.js"),s=n("./src/model/physics/constants.ts"),o=n("./src/utils/utils.ts");function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var l=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");a(this,"normalImpulse",void 0),a(this,"tangentialImpulse",void 0)}return e=[{key:"dynamicFriction",value:function(e){return .01+.108*(0,o.oN)(-1.088*e)}},{key:"updateVelocities",value:function(e,t){var n=c.positionsAtContact(e,t);e.ballmesh.trace.forceTrace(n.a),t.ballmesh.trace.forceTrace(n.b);var r=n.b.sub(n.a).normalize(),o=new i.Pq0(-r.y,r.x,0),a=e.vel.clone().sub(t.vel).add(r.clone().multiplyScalar(-s.R).cross(e.rvel).sub(r.clone().multiplyScalar(s.R).cross(t.rvel))),l=r.dot(a),u=a.addScaledVector(r,-l),h=u.length(),f=o.dot(u),p=this.dynamicFriction(h);this.normalImpulse=-1.99*l/(2/s.m),this.tangentialImpulse=-(.25*Math.min(p*Math.abs(this.normalImpulse)/h,1/7)*f);var d=r.clone().multiplyScalar(this.normalImpulse),v=o.clone().multiplyScalar(this.tangentialImpulse);e.vel.addScaledVector(d,1/s.m).addScaledVector(v,1/s.m),t.vel.addScaledVector(d,-1/s.m).addScaledVector(v,-1/s.m);var m=r.clone().multiplyScalar(-s.R).cross(v),y=r.clone().multiplyScalar(s.R).cross(v);return e.rvel.addScaledVector(m,1/s.I),t.rvel.addScaledVector(y,1/s.I),l}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),c=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"willCollide",value:function(e,t,n){return(e.inMotion()||t.inMotion())&&e.onTable()&&t.onTable()&&e.futurePosition(n).distanceToSquared(t.futurePosition(n))<4*s.R*s.R}},{key:"collide",value:function(e,n){return t.updateVelocities(e,n)}},{key:"positionsAtContact",value:function(e,t){var n=e.pos.distanceTo(t.pos),r=e.vel.clone().sub(t.vel),i=(n-2*s.R)/r.length()||0;return{a:e.pos.clone().addScaledVector(e.vel,i),b:t.pos.clone().addScaledVector(t.vel,i)}}},{key:"updateVelocities",value:function(e,n){var i=t.model.updateVelocities(e,n);return e.state=r.U.Sliding,n.state=r.U.Sliding,i}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();!function(e,t,n){t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}(c,"model",new l)},"./src/model/physics/constants.ts":(e,t,n)=>{n.d(t,{I:()=>s,Mz:()=>r,PX:()=>O,Qg:()=>k,R:()=>f,Wv:()=>T,Ys:()=>P,Z3:()=>y,_m:()=>m,cM:()=>R,e:()=>p,ee:()=>d,g:()=>o,gT:()=>c,gf:()=>l,jG:()=>w,kL:()=>u,kM:()=>S,ki:()=>A,ko:()=>E,m:()=>h,mu:()=>a,o5:()=>b,oV:()=>v,x3:()=>i,xO:()=>x});var r,i,s,o=9.8,a=.00985,l=.16,c=.85,u=.034,h=.23,f=.03275,p=.86,d=.98,v=.212,m=.14,y=.4,b=Math.sqrt(21)/5;function g(){r=a*h*o*2/3*u,i=7/(5*Math.sqrt(2))*f*a*h*o,s=.4*h*f*f}function w(e){f=e,g()}function k(e){h=e,g()}function x(e){a=e,g()}function T(e){u=e,g()}function P(e){l=e}function R(e){p=e}function S(e){c=e}function E(e){v=e}function A(e){m=e}function O(e){d=e}g()},"./src/model/physics/knuckle.ts":(e,t,n)=>{n.d(t,{O:()=>a});var r=n("./src/model/physics/constants.ts"),i=n("./src/view/pocketgeometry.ts");function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e,t;function n(e,t){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");o(this,"pos",void 0),o(this,"radius",void 0),this.pos=e,this.radius=t}return e=[{key:"bounce",value:function(e){var t=e.pos.clone().sub(this.pos).normalize(),n=t.dot(e.vel);return e.vel.addScaledVector(t,-2*r.e*n),e.rvel.multiplyScalar(.5),Math.abs(n)}}],t=[{key:"willBounce",value:function(e,t){return t.distanceTo(e.pos)<r.R+e.radius}},{key:"findBouncing",value:function(e,t){var r=e.futurePosition(t);return i.f.knuckles.find(function(e){return n.willBounce(e,r)})}}],e&&s(n.prototype,e),t&&s(n,t),n}()},"./src/model/physics/mathaven.ts":(e,t,n)=>{n.d(t,{z:()=>o});var r=n("./src/utils/utils.ts"),i=n("./src/model/physics/constants.ts");function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var o=function(){var e;function t(e,n,r,i,o){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");s(this,"P",0),s(this,"WzI",0),s(this,"vx",void 0),s(this,"vy",void 0),s(this,"ωx",void 0),s(this,"ωy",void 0),s(this,"ωz",void 0),s(this,"s",void 0),s(this,"φ",void 0),s(this,"sʹ",void 0),s(this,"φʹ",void 0),s(this,"i",0),s(this,"N",100),s(this,"M",void 0),s(this,"R",void 0),s(this,"μs",void 0),s(this,"μw",void 0),s(this,"ee",void 0),this.M=e,this.R=n,this.ee=r,this.μs=i,this.μw=o}return e=[{key:"updateSlipSpeedsAndAngles",value:function(){var e=this.R,t=this.vx+this.ωy*e*i.Z3-this.ωz*e*i.o5,n=-this.vy*i.Z3+this.ωx*e,s=this.vx-this.ωy*e,o=this.vy+this.ωx*e;this.s=(0,r.RZ)((0,r.n7)(t,2)+(0,r.n7)(n,2)),this.φ=(0,r.FP)(n,t),this.φ<0&&(this.φ+=2*Math.PI),this.sʹ=(0,r.RZ)((0,r.n7)(s,2)+(0,r.n7)(o,2)),this.φʹ=(0,r.FP)(o,s),this.φʹ<0&&(this.φʹ+=2*Math.PI)}},{key:"compressionPhase",value:function(){for(var e=Math.max(this.M*this.vy/this.N,.001);this.vy>0;)this.updateSingleStep(e)}},{key:"restitutionPhase",value:function(e){var t=Math.max(e/this.N,.001);for(this.WzI=0;this.WzI<e;)this.updateSingleStep(t)}},{key:"updateSingleStep",value:function(e){if(this.updateSlipSpeedsAndAngles(),this.updateVelocity(e),this.updateAngularVelocity(e),this.updateWorkDone(e),this.i++>10*this.N)throw Error("Solution not found")}},{key:"updateVelocity",value:function(e){var t=this.μs,n=this.μw,s=this.M;this.vx-=1/s*(n*(0,r.gn)(this.φ)+t*(0,r.gn)(this.φʹ)*(i.Z3+n*(0,r.F8)(this.φ)*i.o5))*e,this.vy-=1/s*(i.o5-n*i.Z3*(0,r.F8)(this.φ)+t*(0,r.F8)(this.φʹ)*(i.Z3+n*(0,r.F8)(this.φ)*i.o5))*e}},{key:"updateAngularVelocity",value:function(e){var t=this.μs,n=this.μw,s=this.M,o=this.R;this.ωx+=-(5/(2*s*o))*(n*(0,r.F8)(this.φ)+t*(0,r.F8)(this.φʹ)*(i.Z3+n*(0,r.F8)(this.φ)*i.o5))*e,this.ωy+=-(5/(2*s*o))*(n*(0,r.gn)(this.φ)*i.Z3-t*(0,r.gn)(this.φʹ)*(i.Z3+n*(0,r.F8)(this.φ)*i.o5))*e,this.ωz+=5/(2*s*o)*(n*(0,r.gn)(this.φ)*i.o5)*e}},{key:"updateWorkDone",value:function(e){var t=e*Math.abs(this.vy);this.WzI+=t,this.P+=e}},{key:"solvePaper",value:function(e,t,n,i){this.solve(e*(0,r.gn)(t),e*(0,r.F8)(t),-i*(0,r.F8)(t),i*(0,r.gn)(t),n)}},{key:"solve",value:function(e,t,n,r,i){this.vx=e,this.vy=t,this.ωx=n,this.ωy=r,this.ωz=i,this.WzI=0,this.P=0,this.i=0,this.compressionPhase();var s=this.ee*this.ee*this.WzI;this.restitutionPhase(s)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/model/physics/physics.ts":(e,t,n)=>{n.d(t,{$8:()=>S,Gp:()=>w,JD:()=>h,Mq:()=>l,QK:()=>p,QV:()=>R,Qy:()=>O,Un:()=>g,c0:()=>b,lx:()=>f,p2:()=>u,s0:()=>y,t6:()=>M,yO:()=>k});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/utils/utils.ts"),s=n("./src/model/physics/constants.ts"),o=n("./src/model/physics/mathaven.ts"),a=new r.Pq0;function l(e,t){return a.copy(e).addScaledVector((0,i.KM)(t),s.R)}var c={v:new r.Pq0,w:new r.Pq0};function u(e,t){var n=l(e,t).setZ(0);return c.v.copy((0,i.xb)(n).multiplyScalar(-s.gf*s.g)),c.w.copy((0,i.xb)((0,i.KM)(n)).multiplyScalar(2.5*s.gf*s.g/s.R)),c.w.setZ(-2.5*(s.Mz/(s.m*s.R*s.R))*Math.sign(t.z)),c}function h(e){var t=new r.Pq0(e.x,e.y,0).length(),n=5/7*s.x3/(s.m*s.R)/t,i=5/7*s.x3/(s.m*s.R*s.R)/t;return c.v.set(-n*e.y,n*e.x,0),c.w.set(-i*e.x,-i*e.y,-2.5*(s.Mz/(s.m*s.R*s.R))*Math.sign(e.z)),c}function f(e,t){var n=t.z;t.copy((0,i.KM)(e).multiplyScalar(1/s.R)),t.setZ(n)}function p(e,t,n,r){var s=r(t.clone().applyAxisAngle(i.up,e),n.clone().applyAxisAngle(i.up,e));return s.v.applyAxisAngle(i.up,-e),s.w.applyAxisAngle(i.up,-e),s}Object.freeze(c);var d=Math.asin(.1*s.R/s.R),v=(0,i.F8)(d),m=(0,i.gn)(d);function y(e,t){return new r.Pq0(e.x*v-e.z*m+s.R*t.y,-e.y-s.R*t.z*m+s.R*t.x*v)}function b(e){return e.x*m}function g(e){var t=3.5/s.m;return e.length()/t}function w(e){var t,n=1/s.m,i=.39+.257*(t=new r.Pq0(e/m,0,0)).x-.044*t.x*t.x;return s.gT*((1+i)*e)/n}function k(e,t){var n=w(b(e));return g(y(e,t))<=n}function x(e,t){return{c:b(e),s:y(e,t),A:3.5/s.m,B:1/s.m}}function T(e,t){var n=x(e,t),r=n.c,i=n.s,o=n.A,a=n.B,l=(1+s.e)*(r/a);return E(-i.x/o*v-l*m,i.y/o,i.x/o*m-l*v)}function P(e,t){var n,r=x(e,t),i=r.c,o=r.B,a=(1+s.e)*(i/o),l=.471-.241*Math.atan2(Math.abs((n=e).y),n.x),c=Math.atan2(e.y,e.x),u=Math.cos(c);return E(-l*a*u*m-a*m,l*a*Math.sin(c),l*a*u*m-a*v)}function R(e,t){return k(e,t)?T(e,t):P(e,t)}function S(e,t){var n=T(e,t),r=P(e,t),i=Math.sign(e.y)===Math.sign(t.z)?Math.cos(Math.atan2(e.y,e.x)):1;return{v:r.v.lerp(n.v,i),w:r.w.lerp(n.w,i)}}function E(e,t,n){return{v:new r.Pq0(e/s.m,t/s.m),w:new r.Pq0(-s.R/s.I*t*v,s.R/s.I*(e*v-n*m),s.R/s.I*t*m)}}function A(e,t){var n=new o.z(s.m,s.R,s.ee,s.oV,s._m+.1);n.solve(e.x,e.y,t.x,t.y,t.z);var i=new r.Pq0(n.vx,n.vy,0),a=new r.Pq0(n.ωx,n.ωy,n.ωz);return{v:i.sub(e),w:a.sub(t)}}function O(e,t){return p(Math.PI/2,e,t,A)}function M(e,t){var n=Math.atan2(-e.x,e.y),r=2.5*t.length()*(e.length()*s.R)/(s.R*s.R),o=t.clone().normalize();return(0,i.KM)(o).applyAxisAngle(o,n).multiplyScalar(r)}},"./src/model/physics/pocket.ts":(e,t,n)=>{n.d(t,{Z:()=>l});var r=n("./src/model/ball.ts"),i=n("./src/model/physics/constants.ts"),s=n("./src/utils/utils.ts");function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var l=function(){var e,t;function n(e,t){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");a(this,"pos",void 0),a(this,"radius",void 0),this.pos=e,this.radius=t}return e=[{key:"fall",value:function(e,t){return e.vel.z=-i.g*t,e.state=r.U.Falling,e.pocket=this,e.vel.length()}},{key:"updateFall",value:function(e,t){e.vel.addScaledVector(s.up,-(10*i.R)*t*i.g);var n=e.pos.z;if(e.pos.clone().setZ(0).distanceTo(this.pos)>this.radius-i.R){var o=this.pos.clone().sub(e.pos).normalize().setZ(0);n>-i.R/2&&(e.vel.addScaledVector(o,7*i.R*t*i.g),e.rvel.addScaledVector((0,s.KM)(o),7*t*i.g)),0>e.vel.dot(o)&&(e.ballmesh.trace.forceTrace(e.pos),e.vel.x=o.x*e.vel.length()/2,e.vel.y=o.y*e.vel.length()/2)}var a=this.restingDepth(e);n<a&&0!==e.rvel.length()&&(e.pos.z=a,e.vel.z=-i.R/10,e.rvel.copy(s.v_)),n<a-i.R&&(e.pos.z=a-i.R,e.setStationary(),e.state=r.U.InPocket)}},{key:"restingDepth",value:function(e){return -3*i.R-i.R*e.id/4}}],t=[{key:"willFall",value:function(e,t){return t.distanceTo(e.pos)<e.radius}},{key:"findPocket",value:function(e,t,r){var i=t.futurePosition(r);return e.find(function(e){return n.willFall(e,i)})}}],e&&o(n.prototype,e),t&&o(n,t),n}()},"./src/model/table.ts":(e,t,n)=>{n.d(t,{X:()=>b});var r=n("./src/view/tablegeometry.ts"),i=n("./src/model/physics/physics.ts"),s=n("./src/view/pocketgeometry.ts"),o=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"bounceAny",value:function(e,n){var s=!(arguments.length>2)||void 0===arguments[2]||arguments[2],o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:i.$8,a=e.futurePosition(n);if(t.willBounceLong(a,s)){var l=a.y>r.P.tableY?-Math.PI/2:Math.PI/2;return t.bounceIn(l,e,o)}if(t.willBounceShort(a,s)){var c=a.x>r.P.tableX?0:Math.PI;return t.bounceIn(c,e,o)}}},{key:"willBounceShort",value:function(e,n){return n?t.willBounceShortSegment(s.f.pockets.pocketNW.knuckleSW.pos.y,s.f.pockets.pocketSW.knuckleNW.pos.y,e):t.willBounceShortSegment(r.P.Y,-r.P.Y,e)}},{key:"willBounceLong",value:function(e,n){return n?t.willBounceLongSegment(s.f.pockets.pocketNW.knuckleNE.pos.x,s.f.pockets.pocketN.knuckleNW.pos.x,e)||t.willBounceLongSegment(s.f.pockets.pocketN.knuckleNE.pos.x,s.f.pockets.pocketNE.knuckleNW.pos.x,e):t.willBounceLongSegment(-r.P.X,r.P.X,e)}},{key:"willBounceLongSegment",value:function(e,t,n){return n.x>e&&n.x<t&&Math.abs(n.y)>r.P.tableY}},{key:"willBounceShortSegment",value:function(e,t,n){return n.y>t&&n.y<e&&Math.abs(n.x)>r.P.tableX}},{key:"bounceIn",value:function(e,t,n){t.ballmesh.trace.forceTrace(t.futurePos);var r=(0,i.QK)(e,t.vel,t.rvel,n);return t.vel.add(r.v),t.rvel.add(r.w),r.v.length()}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}(),a=n("./src/model/physics/collision.ts"),l=n("./src/model/physics/knuckle.ts"),c=n("./src/model/physics/pocket.ts"),u=n("./src/view/cue.ts"),h=n("./src/model/ball.ts"),f=n("./src/events/aimevent.ts"),p=n("./src/model/outcome.ts"),d=n("./src/utils/utils.ts"),v=n("./src/model/physics/constants.ts");function m(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var b=function(){var e,t;function n(e){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");y(this,"balls",void 0),y(this,"cue",new u.s),y(this,"pairs",void 0),y(this,"outcome",[]),y(this,"cueball",void 0),y(this,"cushionModel",i.$8),y(this,"mesh",void 0),this.cueball=e[0],this.initialiseBalls(e)}return e=[{key:"initialiseBalls",value:function(e){this.balls=e,this.pairs=[];for(var t=0;t<e.length;t++)for(var n=0;n<e.length;n++)t<n&&this.pairs.push({a:e[t],b:e[n]})}},{key:"updateBallMesh",value:function(e){this.balls.forEach(function(t){t.updateMesh(e)})}},{key:"advance",value:function(e){for(var t=0;!this.prepareAdvanceAll(e);)if(t++>100)throw Error("Depth exceeded resolving collisions");this.balls.forEach(function(t){t.update(e),t.fround()})}},{key:"prepareAdvanceAll",value:function(e){var t=this;return this.pairs.every(function(n){return t.prepareAdvancePair(n.a,n.b,e)})&&this.balls.every(function(n){return t.prepareAdvanceToCushions(n,e)})}},{key:"prepareAdvancePair",value:function(e,t,n){if(a.F.willCollide(e,t,n)){var r=a.F.collide(e,t);return this.outcome.push(p.P.collision(e,t,r)),!1}return!0}},{key:"prepareAdvanceToCushions",value:function(e,t){if(!e.onTable())return!0;var n=e.futurePosition(t);if(Math.abs(n.y)<r.P.tableY&&Math.abs(n.x)<r.P.tableX)return!0;var i=o.bounceAny(e,t,r.P.hasPockets,this.cushionModel);if(i)return this.outcome.push(p.P.cushion(e,i)),!1;var a=l.O.findBouncing(e,t);if(a){var u=a.bounce(e);return this.outcome.push(p.P.cushion(e,u)),!1}var h=c.Z.findPocket(s.f.pocketCenters,e,t);if(h){var f=h.fall(e,t);return this.outcome.push(p.P.pot(e,f)),!1}return!0}},{key:"allStationary",value:function(){return this.balls.every(function(e){return!e.inMotion()})}},{key:"inPockets",value:function(){return this.balls.reduce(function(e,t){return t.onTable()?e:e+1},0)}},{key:"hit",value:function(){this.cue.hit(this.cueball),this.balls.forEach(function(e){e.ballmesh.trace.reset()})}},{key:"serialise",value:function(){return{balls:this.balls.map(function(e){return e.serialise()}),aim:this.cue.aim.copy()}}},{key:"updateFromSerialised",value:function(e){var t=this;e.balls&&e.balls.forEach(function(e){return h.c.updateFromSerialised(t.balls[e.id],e)}),e.aim&&(this.cue.aim=f.w.fromJson(e.aim))}},{key:"shortSerialise",value:function(){return this.balls.map(function(e){return[e.pos.x,e.pos.y]}).reduce(function(e,t){return e.concat(t)},[])}},{key:"updateFromShortSerialised",value:function(e){this.balls.forEach(function(t,n){t.pos.x=e[2*n],t.pos.y=e[2*n+1],t.pos.z=0,t.vel.copy(d.v_),t.rvel.copy(d.v_),t.state=h.U.Stationary})}},{key:"addToScene",value:function(e){this.balls.forEach(function(t){t.ballmesh.addToScene(e)}),e.add(this.cue.mesh),e.add(this.cue.helperMesh),e.add(this.cue.placerMesh)}},{key:"showTraces",value:function(e){this.balls.forEach(function(t){t.ballmesh.trace.line.visible=e,t.ballmesh.trace.reset()})}},{key:"showSpin",value:function(e){this.balls.forEach(function(t){t.ballmesh.spinAxisArrow.visible=e})}},{key:"halt",value:function(){this.balls.forEach(function(e){e.vel.copy(d.v_),e.rvel.copy(d.v_),e.state=h.U.Stationary})}},{key:"roundCueBallPosition",value:function(){var e=this.cueball.pos.clone();this.overlapsAny(e)||this.cueball.pos.copy(e)}},{key:"overlapsAny",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.cueball;return this.balls.filter(function(e){return e!==t}).some(function(t){return t.pos.distanceTo(e)<2*v.R})}}],t=[{key:"fromSerialised",value:function(e){var t=new n(e.balls.map(function(e){return h.c.fromSerialised(e)}));return t.updateFromSerialised(e),t}}],e&&m(n.prototype,e),t&&m(n,t),n}()},"./src/network/client/nchanmessagerelay.ts":(e,t,n)=>{n.d(t,{p:()=>o});var r=n("./node_modules/cross-fetch/dist/browser-ponyfill.js"),i=n.n(r);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var o=function(){var e;function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"billiards-network.onrender.com";if(!(this instanceof t))throw TypeError("Cannot call a class as a function");s(this,"baseURL",void 0),s(this,"websockets",void 0),this.baseURL=e,this.websockets=new Map}return e=[{key:"subscribe",value:function(e,t){var n="wss://".concat(this.baseURL,"/subscribe/table/").concat(e),r=new WebSocket(n);console.log("Subscribed to ",n),r.onmessage=function(e){try{var n=e.data;t(n)}catch(e){console.error("Error parsing message:",e)}},r.onerror=function(e){console.error("WebSocket error:",e)},r.onopen=function(){console.log("Connected to ".concat(n))},r.onclose=function(e){console.log("Disconnected from ".concat(n,":"),e.reason)},this.websockets.set(e,r)}},{key:"publish",value:function(e,t){var n="https://".concat(this.baseURL,"/publish/table/").concat(e);i()(n,{method:"POST",headers:{"Content-Type":"application/json"},body:t}).catch(function(e){console.error("Publication error:",e)})}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/network/client/session.ts":(e,t,n)=>{n.d(t,{N:()=>i});function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var i=function(){var e;function t(e,n,i,s){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");r(this,"clientId",void 0),r(this,"username",void 0),r(this,"tableId",void 0),r(this,"spectator",void 0),this.clientId=e,this.username=n,this.tableId=i,this.spectator=s}return e=[{key:"getInstance",value:function(){if(!t.instance)throw Error("Session not initialized");return t.instance}},{key:"isSpectator",value:function(){return void 0!==t.instance&&t.getInstance().spectator}},{key:"reset",value:function(){t.instance=void 0}},{key:"init",value:function(e,n,r,i){t.instance=new t(e,n,r,i)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();r(i,"instance",void 0)},"./src/utils/gltf.ts":(e,t,n)=>{n.d(t,{KP:()=>eR,Ro:()=>eS});var r=n("./node_modules/three/build/three.core.js");let i={POSITION:["byte","byte normalized","unsigned byte","unsigned byte normalized","short","short normalized","unsigned short","unsigned short normalized"],NORMAL:["byte normalized","short normalized"],TANGENT:["byte normalized","short normalized"],TEXCOORD:["byte","byte normalized","unsigned byte","short","short normalized","unsigned short"]};class s{constructor(){this.textureUtils=null,this.pluginCallbacks=[],this.register(function(e){return new m(e)}),this.register(function(e){return new y(e)}),this.register(function(e){return new k(e)}),this.register(function(e){return new x(e)}),this.register(function(e){return new T(e)}),this.register(function(e){return new P(e)}),this.register(function(e){return new b(e)}),this.register(function(e){return new g(e)}),this.register(function(e){return new w(e)}),this.register(function(e){return new R(e)}),this.register(function(e){return new S(e)}),this.register(function(e){return new E(e)}),this.register(function(e){return new A(e)}),this.register(function(e){return new O(e)})}register(e){return -1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return -1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}setTextureUtils(e){return this.textureUtils=e,this}parse(e,t,n,r){let i=new v,s=[];for(let e=0,t=this.pluginCallbacks.length;e<t;e++)s.push(this.pluginCallbacks[e](i));i.setPlugins(s),i.setTextureUtils(this.textureUtils),i.writeAsync(e,t,r).catch(n)}parseAsync(e,t){let n=this;return new Promise(function(r,i){n.parse(e,r,i,t)})}}let o={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},a="KHR_mesh_quantization",l={};l[r.hxR]=o.NEAREST,l[r.pHI]=o.NEAREST_MIPMAP_NEAREST,l[r.Cfg]=o.NEAREST_MIPMAP_LINEAR,l[r.k6q]=o.LINEAR,l[r.kRr]=o.LINEAR_MIPMAP_NEAREST,l[r.$_I]=o.LINEAR_MIPMAP_LINEAR,l[r.ghU]=o.CLAMP_TO_EDGE,l[r.GJx]=o.REPEAT,l[r.kTW]=o.MIRRORED_REPEAT;let c={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},u=new r.Q1f;function h(e,t){return e.length===t.length&&e.every(function(e,n){return e===t[n]})}function f(e){return 4*Math.ceil(e/4)}function p(e,t=0){let n=f(e.byteLength);if(n!==e.byteLength){let r=new Uint8Array(n);if(r.set(new Uint8Array(e)),0!==t)for(let i=e.byteLength;i<n;i++)r[i]=t;return r.buffer}return e}function d(){return"undefined"==typeof document&&"undefined"!=typeof OffscreenCanvas?new OffscreenCanvas(1,1):document.createElement("canvas")}class v{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.extensionsRequired={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter r"+r.sPf}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map},this.textureUtils=null}setPlugins(e){this.plugins=e}setTextureUtils(e){this.textureUtils=e}async writeAsync(e,t,n={}){this.options=Object.assign({binary:!1,trs:!1,onlyVisible:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},n),this.options.animations.length>0&&(this.options.trs=!0),await this.processInputAsync(e),await Promise.all(this.pending);let r=this.buffers,i=this.json;n=this.options;let s=this.extensionsUsed,o=this.extensionsRequired,a=new Blob(r,{type:"application/octet-stream"}),l=Object.keys(s),c=Object.keys(o);if(l.length>0&&(i.extensionsUsed=l),c.length>0&&(i.extensionsRequired=c),i.buffers&&i.buffers.length>0&&(i.buffers[0].byteLength=a.size),!0===n.binary){let e=new FileReader;e.readAsArrayBuffer(a),e.onloadend=function(){var n;let r=p(e.result),s=new DataView(new ArrayBuffer(8));s.setUint32(0,r.byteLength,!0),s.setUint32(4,5130562,!0);let o=p((n=JSON.stringify(i),new TextEncoder().encode(n).buffer),32),a=new DataView(new ArrayBuffer(8));a.setUint32(0,o.byteLength,!0),a.setUint32(4,0x4e4f534a,!0);let l=new ArrayBuffer(12),c=new DataView(l);c.setUint32(0,0x46546c67,!0),c.setUint32(4,2,!0);let u=12+a.byteLength+o.byteLength+s.byteLength+r.byteLength;c.setUint32(8,u,!0);let h=new Blob([l,a,o,s,r],{type:"application/octet-stream"}),f=new FileReader;f.readAsArrayBuffer(h),f.onloadend=function(){t(f.result)}}}else if(i.buffers&&i.buffers.length>0){let e=new FileReader;e.readAsDataURL(a),e.onloadend=function(){let n=e.result;i.buffers[0].uri=n,t(i)}}else t(i)}serializeUserData(e,t){if(0===Object.keys(e.userData).length)return;let n=this.options,r=this.extensionsUsed;try{let i=JSON.parse(JSON.stringify(e.userData));if(n.includeCustomExtensions&&i.gltfExtensions){for(let e in void 0===t.extensions&&(t.extensions={}),i.gltfExtensions)t.extensions[e]=i.gltfExtensions[e],r[e]=!0;delete i.gltfExtensions}Object.keys(i).length>0&&(t.extras=i)}catch(t){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+t.message)}}getUID(e,t=!1){if(!1===this.uids.has(e)){let t=new Map;t.set(!0,this.uid++),t.set(!1,this.uid++),this.uids.set(e,t)}return this.uids.get(e).get(t)}isNormalizedNormalAttribute(e){if(this.cache.attributesNormalized.has(e))return!1;let t=new r.Pq0;for(let n=0,r=e.count;n<r;n++)if(Math.abs(t.fromBufferAttribute(e,n).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(e){let t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);let n=e.clone(),i=new r.Pq0;for(let e=0,t=n.count;e<t;e++)i.fromBufferAttribute(n,e),0===i.x&&0===i.y&&0===i.z?i.setX(1):i.normalize(),n.setXYZ(e,i.x,i.y,i.z);return t.attributesNormalized.set(e,n),n}applyTextureTransform(e,t){let n=!1,r={};(0!==t.offset.x||0!==t.offset.y)&&(r.offset=t.offset.toArray(),n=!0),0!==t.rotation&&(r.rotation=t.rotation,n=!0),(1!==t.repeat.x||1!==t.repeat.y)&&(r.scale=t.repeat.toArray(),n=!0),n&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=r,this.extensionsUsed.KHR_texture_transform=!0)}async buildMetalRoughTextureAsync(e,t){if(e===t)return e;function n(e){return e.colorSpace===r.er$?function(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}:function(e){return e}}e instanceof r.FvD&&(e=await this.decompressTextureAsync(e)),t instanceof r.FvD&&(t=await this.decompressTextureAsync(t));let i=e?e.image:null,s=t?t.image:null,o=Math.max(i?i.width:0,s?s.width:0),a=Math.max(i?i.height:0,s?s.height:0),l=d();l.width=o,l.height=a;let c=l.getContext("2d",{willReadFrequently:!0});c.fillStyle="#00ffff",c.fillRect(0,0,o,a);let u=c.getImageData(0,0,o,a);if(i){c.drawImage(i,0,0,o,a);let t=n(e),r=c.getImageData(0,0,o,a).data;for(let e=2;e<r.length;e+=4)u.data[e]=256*t(r[e]/256)}if(s){c.drawImage(s,0,0,o,a);let e=n(t),r=c.getImageData(0,0,o,a).data;for(let t=1;t<r.length;t+=4)u.data[t]=256*e(r[t]/256)}c.putImageData(u,0,0);let h=(e||t).clone();return h.source=new r.kLi(l),h.colorSpace=r.jf0,h.channel=(e||t).channel,e&&t&&e.channel!==t.channel&&console.warn("THREE.GLTFExporter: UV channels for metalnessMap and roughnessMap textures must match."),console.warn("THREE.GLTFExporter: Merged metalnessMap and roughnessMap textures."),h}async decompressTextureAsync(e,t=1/0){if(null===this.textureUtils)throw Error("THREE.GLTFExporter: setTextureUtils() must be called to process compressed textures.");return await this.textureUtils.decompress(e,t)}processBuffer(e){let t=this.json,n=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),n.push(e),0}processBufferView(e,t,n,i,s){let a,l=this.json;switch(!l.bufferViews&&(l.bufferViews=[]),t){case o.BYTE:case o.UNSIGNED_BYTE:a=1;break;case o.SHORT:case o.UNSIGNED_SHORT:a=2;break;default:a=4}let c=e.itemSize*a;s===o.ARRAY_BUFFER&&(c=4*Math.ceil(c/4));let u=f(i*c),h=new DataView(new ArrayBuffer(u)),p=0;for(let s=n;s<n+i;s++){for(let n=0;n<e.itemSize;n++){let i;e.itemSize>4?i=e.array[s*e.itemSize+n]:(0===n?i=e.getX(s):1===n?i=e.getY(s):2===n?i=e.getZ(s):3===n&&(i=e.getW(s)),!0===e.normalized&&(i=r.cj9.normalize(i,e.array))),t===o.FLOAT?h.setFloat32(p,i,!0):t===o.INT?h.setInt32(p,i,!0):t===o.UNSIGNED_INT?h.setUint32(p,i,!0):t===o.SHORT?h.setInt16(p,i,!0):t===o.UNSIGNED_SHORT?h.setUint16(p,i,!0):t===o.BYTE?h.setInt8(p,i):t===o.UNSIGNED_BYTE&&h.setUint8(p,i),p+=a}p%c!=0&&(p+=c-p%c)}let d={buffer:this.processBuffer(h.buffer),byteOffset:this.byteOffset,byteLength:u};return void 0!==s&&(d.target=s),s===o.ARRAY_BUFFER&&(d.byteStride=c),this.byteOffset+=u,l.bufferViews.push(d),{id:l.bufferViews.length-1,byteLength:0}}processBufferViewImage(e){let t=this,n=t.json;return n.bufferViews||(n.bufferViews=[]),new Promise(function(r){let i=new FileReader;i.readAsArrayBuffer(e),i.onloadend=function(){let e=p(i.result),s={buffer:t.processBuffer(e),byteOffset:t.byteOffset,byteLength:e.byteLength};t.byteOffset+=e.byteLength,r(n.bufferViews.push(s)-1)}})}processAccessor(e,t,n,i){let s,a,l=this.json;if(e.array.constructor===Float32Array)s=o.FLOAT;else if(e.array.constructor===Int32Array)s=o.INT;else if(e.array.constructor===Uint32Array)s=o.UNSIGNED_INT;else if(e.array.constructor===Int16Array)s=o.SHORT;else if(e.array.constructor===Uint16Array)s=o.UNSIGNED_SHORT;else if(e.array.constructor===Int8Array)s=o.BYTE;else if(e.array.constructor===Uint8Array)s=o.UNSIGNED_BYTE;else throw Error("THREE.GLTFExporter: Unsupported bufferAttribute component type: "+e.array.constructor.name);if(void 0===n&&(n=0),(void 0===i||i===1/0)&&(i=e.count),0===i)return null;let c=function(e,t,n){let i={min:Array(e.itemSize).fill(1/0),max:Array(e.itemSize).fill(-1/0)};for(let s=t;s<t+n;s++)for(let t=0;t<e.itemSize;t++){let n;e.itemSize>4?n=e.array[s*e.itemSize+t]:(0===t?n=e.getX(s):1===t?n=e.getY(s):2===t?n=e.getZ(s):3===t&&(n=e.getW(s)),!0===e.normalized&&(n=r.cj9.normalize(n,e.array))),i.min[t]=Math.min(i.min[t],n),i.max[t]=Math.max(i.max[t],n)}return i}(e,n,i);void 0!==t&&(a=e===t.index?o.ELEMENT_ARRAY_BUFFER:o.ARRAY_BUFFER);let u=this.processBufferView(e,s,n,i,a),h={bufferView:u.id,byteOffset:u.byteOffset,componentType:s,count:i,max:c.max,min:c.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",9:"MAT3",16:"MAT4"}[e.itemSize]};return!0===e.normalized&&(h.normalized=!0),l.accessors||(l.accessors=[]),l.accessors.push(h)-1}processImage(e,t,n,i="image/png"){if(null!==e){let s=this,o=s.cache,a=s.json,l=s.options,c=s.pending;o.images.has(e)||o.images.set(e,{});let u=o.images.get(e),h=i+":flipY/"+n.toString();if(void 0!==u[h])return u[h];a.images||(a.images=[]);let f={mimeType:i},p=d();p.width=Math.min(e.width,l.maxTextureSize),p.height=Math.min(e.height,l.maxTextureSize);let v=p.getContext("2d",{willReadFrequently:!0});if(!0===n&&(v.translate(0,p.height),v.scale(1,-1)),void 0!==e.data){t!==r.GWd&&console.error("GLTFExporter: Only RGBAFormat is supported.",t),(e.width>l.maxTextureSize||e.height>l.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",e);let n=new Uint8ClampedArray(e.height*e.width*4);for(let t=0;t<n.length;t+=4)n[t+0]=e.data[t+0],n[t+1]=e.data[t+1],n[t+2]=e.data[t+2],n[t+3]=e.data[t+3];v.putImageData(new ImageData(n,e.width,e.height),0,0)}else if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas)v.drawImage(e,0,0,p.width,p.height);else throw Error("THREE.GLTFExporter: Invalid image type. Use HTMLImageElement, HTMLCanvasElement, ImageBitmap or OffscreenCanvas.");!0===l.binary?c.push((function(e,t){if(!("undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas))return new Promise(n=>e.toBlob(n,t));{let n;return"image/jpeg"===t?n=.92:"image/webp"===t&&(n=.8),e.convertToBlob({type:t,quality:n})}})(p,i).then(e=>s.processBufferViewImage(e)).then(e=>{f.bufferView=e})):f.uri=r.HgN.getDataURL(p,i);let m=a.images.push(f)-1;return u[h]=m,m}throw Error("THREE.GLTFExporter: No valid image data found. Unable to process texture.")}processSampler(e){let t=this.json;t.samplers||(t.samplers=[]);let n={magFilter:l[e.magFilter],minFilter:l[e.minFilter],wrapS:l[e.wrapS],wrapT:l[e.wrapT]};return t.samplers.push(n)-1}async processTextureAsync(e){let t=this.options,n=this.cache,i=this.json;if(n.textures.has(e))return n.textures.get(e);i.textures||(i.textures=[]),e instanceof r.FvD&&(e=await this.decompressTextureAsync(e,t.maxTextureSize));let s=e.userData.mimeType;"image/webp"===s&&(s="image/png");let o={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY,s)};e.name&&(o.name=e.name),await this._invokeAllAsync(async function(t){t.writeTexture&&await t.writeTexture(e,o)});let a=i.textures.push(o)-1;return n.textures.set(e,a),a}async processMaterialAsync(e){let t=this.cache,n=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;n.materials||(n.materials=[]);let i={pbrMetallicRoughness:{}};!0!==e.isMeshStandardMaterial&&!0!==e.isMeshBasicMaterial&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");let s=e.color.toArray().concat([e.opacity]);if(h(s,[1,1,1,1])||(i.pbrMetallicRoughness.baseColorFactor=s),e.isMeshStandardMaterial?(i.pbrMetallicRoughness.metallicFactor=e.metalness,i.pbrMetallicRoughness.roughnessFactor=e.roughness):(i.pbrMetallicRoughness.metallicFactor=0,i.pbrMetallicRoughness.roughnessFactor=1),e.metalnessMap||e.roughnessMap){let t=await this.buildMetalRoughTextureAsync(e.metalnessMap,e.roughnessMap),n={index:await this.processTextureAsync(t),texCoord:t.channel};this.applyTextureTransform(n,t),i.pbrMetallicRoughness.metallicRoughnessTexture=n}if(e.map){let t={index:await this.processTextureAsync(e.map),texCoord:e.map.channel};this.applyTextureTransform(t,e.map),i.pbrMetallicRoughness.baseColorTexture=t}if(e.emissive){let t=e.emissive;if(Math.max(t.r,t.g,t.b)>0&&(i.emissiveFactor=e.emissive.toArray()),e.emissiveMap){let t={index:await this.processTextureAsync(e.emissiveMap),texCoord:e.emissiveMap.channel};this.applyTextureTransform(t,e.emissiveMap),i.emissiveTexture=t}}if(e.normalMap){let t={index:await this.processTextureAsync(e.normalMap),texCoord:e.normalMap.channel};e.normalScale&&1!==e.normalScale.x&&(t.scale=e.normalScale.x),this.applyTextureTransform(t,e.normalMap),i.normalTexture=t}if(e.aoMap){let t={index:await this.processTextureAsync(e.aoMap),texCoord:e.aoMap.channel};1!==e.aoMapIntensity&&(t.strength=e.aoMapIntensity),this.applyTextureTransform(t,e.aoMap),i.occlusionTexture=t}e.transparent?i.alphaMode="BLEND":e.alphaTest>0&&(i.alphaMode="MASK",i.alphaCutoff=e.alphaTest),e.side===r.$EB&&(i.doubleSided=!0),""!==e.name&&(i.name=e.name),this.serializeUserData(e,i),await this._invokeAllAsync(async function(t){t.writeMaterialAsync&&await t.writeMaterialAsync(e,i)});let o=n.materials.push(i)-1;return t.materials.set(e,o),o}async processMeshAsync(e){let t,n=this.cache,i=this.json,a=[e.geometry.uuid];if(Array.isArray(e.material))for(let t=0,n=e.material.length;t<n;t++)a.push(e.material[t].uuid);else a.push(e.material.uuid);let l=a.join(":");if(n.meshes.has(l))return n.meshes.get(l);let c=e.geometry;t=e.isLineSegments?o.LINES:e.isLineLoop?o.LINE_LOOP:e.isLine?o.LINE_STRIP:e.isPoints?o.POINTS:e.material.wireframe?o.LINES:o.TRIANGLES;let u={},h={},f=[],p=[],d={uv:"TEXCOORD_0",uv1:"TEXCOORD_1",uv2:"TEXCOORD_2",uv3:"TEXCOORD_3",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},v=c.getAttribute("normal");void 0===v||this.isNormalizedNormalAttribute(v)||(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),c.setAttribute("normal",this.createNormalizedNormalAttribute(v)));let m=null;for(let e in c.attributes){if("morph"===e.slice(0,5))continue;let t=c.attributes[e];if(e=d[e]||e.toUpperCase(),/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(e)||(e="_"+e),n.attributes.has(this.getUID(t))){h[e]=n.attributes.get(this.getUID(t));continue}m=null;let i=t.array;"JOINTS_0"!==e||i instanceof Uint16Array||i instanceof Uint8Array?(i instanceof Uint32Array||i instanceof Int32Array)&&!e.startsWith("_")&&(console.warn(`GLTFExporter: Attribute "${e}" converted to type FLOAT.`),m=s.Utils.toFloat32BufferAttribute(t)):(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),m=new r.THS(new Uint16Array(i),t.itemSize,t.normalized));let o=this.processAccessor(m||t,c);null!==o&&(e.startsWith("_")||this.detectMeshQuantization(e,t),h[e]=o,n.attributes.set(this.getUID(t),o))}if(void 0!==v&&c.setAttribute("normal",v),0===Object.keys(h).length)return null;if(void 0!==e.morphTargetInfluences&&e.morphTargetInfluences.length>0){let t=[],r=[],i={};if(void 0!==e.morphTargetDictionary)for(let t in e.morphTargetDictionary)i[e.morphTargetDictionary[t]]=t;for(let s=0;s<e.morphTargetInfluences.length;++s){let o={},a=!1;for(let e in c.morphAttributes){if("position"!==e&&"normal"!==e){a||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),a=!0);continue}let t=c.morphAttributes[e][s],r=e.toUpperCase(),i=c.attributes[e];if(n.attributes.has(this.getUID(t,!0))){o[r]=n.attributes.get(this.getUID(t,!0));continue}let l=t.clone();if(!c.morphTargetsRelative)for(let e=0,n=t.count;e<n;e++)for(let n=0;n<t.itemSize;n++)0===n&&l.setX(e,t.getX(e)-i.getX(e)),1===n&&l.setY(e,t.getY(e)-i.getY(e)),2===n&&l.setZ(e,t.getZ(e)-i.getZ(e)),3===n&&l.setW(e,t.getW(e)-i.getW(e));o[r]=this.processAccessor(l,c),n.attributes.set(this.getUID(i,!0),o[r])}p.push(o),t.push(e.morphTargetInfluences[s]),void 0!==e.morphTargetDictionary&&r.push(i[s])}u.weights=t,r.length>0&&(u.extras={},u.extras.targetNames=r)}let y=Array.isArray(e.material);if(y&&0===c.groups.length)return null;let b=!1;if(y&&null===c.index){let e=[];for(let t=0,n=c.attributes.position.count;t<n;t++)e[t]=t;c.setIndex(e),b=!0}let g=y?e.material:[e.material],w=y?c.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let e=0,r=w.length;e<r;e++){let r={mode:t,attributes:h};if(this.serializeUserData(c,r),p.length>0&&(r.targets=p),null!==c.index){let t=this.getUID(c.index);(void 0!==w[e].start||void 0!==w[e].count)&&(t+=":"+w[e].start+":"+w[e].count),n.attributes.has(t)?r.indices=n.attributes.get(t):(r.indices=this.processAccessor(c.index,c,w[e].start,w[e].count),n.attributes.set(t,r.indices)),null===r.indices&&delete r.indices}let i=await this.processMaterialAsync(g[w[e].materialIndex]);null!==i&&(r.material=i),f.push(r)}!0===b&&c.setIndex(null),u.primitives=f,i.meshes||(i.meshes=[]),await this._invokeAllAsync(function(t){t.writeMesh&&t.writeMesh(e,u)});let k=i.meshes.push(u)-1;return n.meshes.set(l,k),k}detectMeshQuantization(e,t){let n;if(this.extensionsUsed[a])return;switch(t.array.constructor){case Int8Array:n="byte";break;case Uint8Array:n="unsigned byte";break;case Int16Array:n="short";break;case Uint16Array:n="unsigned short";break;default:return}t.normalized&&(n+=" normalized");let r=e.split("_",1)[0];i[r]&&i[r].includes(n)&&(this.extensionsUsed[a]=!0,this.extensionsRequired[a]=!0)}processCamera(e){let t=this.json;t.cameras||(t.cameras=[]);let n=e.isOrthographicCamera,i={type:n?"orthographic":"perspective"};return n?i.orthographic={xmag:2*e.right,ymag:2*e.top,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:i.perspective={aspectRatio:e.aspect,yfov:r.cj9.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},""!==e.name&&(i.name=e.type),t.cameras.push(i)-1}processAnimation(e,t){let n=this.json,i=this.nodeMap;n.animations||(n.animations=[]);let o=(e=s.Utils.mergeMorphTargetTracks(e.clone(),t)).tracks,a=[],l=[];for(let e=0;e<o.length;++e){let n,s=o[e],u=r.Nwf.parseTrackName(s.name),h=r.Nwf.findNode(t,u.nodeName),f=c[u.propertyName];if("bones"===u.objectName&&(h=!0===h.isSkinnedMesh?h.skeleton.getBoneByName(u.objectIndex):void 0),!h||!f){console.warn('THREE.GLTFExporter: Could not export animation track "%s".',s.name);continue}let p=s.values.length/s.times.length;f===c.morphTargetInfluences&&(p/=h.morphTargetInfluences.length),!0===s.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(n="CUBICSPLINE",p/=3):n=s.getInterpolation()===r.ljd?"STEP":"LINEAR",l.push({input:this.processAccessor(new r.THS(s.times,1)),output:this.processAccessor(new r.THS(s.values,p)),interpolation:n}),a.push({sampler:l.length-1,target:{node:i.get(h),path:f}})}let u={name:e.name||"clip_"+n.animations.length,samplers:l,channels:a};return this.serializeUserData(e,u),n.animations.push(u),n.animations.length-1}processSkin(e){let t=this.json,n=this.nodeMap,i=t.nodes[n.get(e)],s=e.skeleton;if(void 0===s)return null;let o=e.skeleton.bones[0];if(void 0===o)return null;let a=[],l=new Float32Array(16*s.bones.length),c=new r.kn4;for(let t=0;t<s.bones.length;++t)a.push(n.get(s.bones[t])),c.copy(s.boneInverses[t]),c.multiply(e.bindMatrix).toArray(l,16*t);return void 0===t.skins&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new r.THS(l,16)),joints:a,skeleton:n.get(o)}),i.skin=t.skins.length-1}async processNodeAsync(e){let t=this.json,n=this.options,r=this.nodeMap;t.nodes||(t.nodes=[]);let i={};if(n.trs){let t=e.quaternion.toArray(),n=e.position.toArray(),r=e.scale.toArray();h(t,[0,0,0,1])||(i.rotation=t),h(n,[0,0,0])||(i.translation=n),h(r,[1,1,1])||(i.scale=r)}else e.matrixAutoUpdate&&e.updateMatrix(),!1===h(e.matrix.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])&&(i.matrix=e.matrix.elements);if(""!==e.name&&(i.name=String(e.name)),this.serializeUserData(e,i),e.isMesh||e.isLine||e.isPoints){let t=await this.processMeshAsync(e);null!==t&&(i.mesh=t)}else e.isCamera&&(i.camera=this.processCamera(e));e.isSkinnedMesh&&this.skins.push(e);let s=t.nodes.push(i)-1;if(r.set(e,s),e.children.length>0){let t=[];for(let r=0,i=e.children.length;r<i;r++){let i=e.children[r];if(i.visible||!1===n.onlyVisible){let e=await this.processNodeAsync(i);null!==e&&t.push(e)}}t.length>0&&(i.children=t)}return await this._invokeAllAsync(function(t){t.writeNode&&t.writeNode(e,i)}),s}async processSceneAsync(e){let t=this.json,n=this.options;t.scenes||(t.scenes=[],t.scene=0);let r={};""!==e.name&&(r.name=e.name),t.scenes.push(r);let i=[];for(let t=0,r=e.children.length;t<r;t++){let r=e.children[t];if(r.visible||!1===n.onlyVisible){let e=await this.processNodeAsync(r);null!==e&&i.push(e)}}i.length>0&&(r.nodes=i),this.serializeUserData(e,r)}async processObjectsAsync(e){let t=new r.Z58;t.name="AuxScene";for(let n=0;n<e.length;n++)t.children.push(e[n]);await this.processSceneAsync(t)}async processInputAsync(e){let t=this.options;e=e instanceof Array?e:[e],await this._invokeAllAsync(function(t){t.beforeParse&&t.beforeParse(e)});let n=[];for(let t=0;t<e.length;t++)e[t]instanceof r.Z58?await this.processSceneAsync(e[t]):n.push(e[t]);n.length>0&&await this.processObjectsAsync(n);for(let e=0;e<this.skins.length;++e)this.processSkin(this.skins[e]);for(let n=0;n<t.animations.length;++n)this.processAnimation(t.animations[n],e[0]);await this._invokeAllAsync(function(t){t.afterParse&&t.afterParse(e)})}async _invokeAllAsync(e){for(let t=0,n=this.plugins.length;t<n;t++)await e(this.plugins[t])}}class m{constructor(e){this.writer=e,this.name="KHR_lights_punctual"}writeNode(e,t){if(!e.isLight)return;if(!e.isDirectionalLight&&!e.isPointLight&&!e.isSpotLight)return void console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e);let n=this.writer,r=n.json,i=n.extensionsUsed,s={};e.name&&(s.name=e.name),s.color=e.color.toArray(),s.intensity=e.intensity,e.isDirectionalLight?s.type="directional":e.isPointLight?(s.type="point",e.distance>0&&(s.range=e.distance)):e.isSpotLight&&(s.type="spot",e.distance>0&&(s.range=e.distance),s.spot={},s.spot.innerConeAngle=(1-e.penumbra)*e.angle,s.spot.outerConeAngle=e.angle),void 0!==e.decay&&2!==e.decay&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),e.target&&(e.target.parent!==e||0!==e.target.position.x||0!==e.target.position.y||-1!==e.target.position.z)&&console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),i[this.name]||(r.extensions=r.extensions||{},r.extensions[this.name]={lights:[]},i[this.name]=!0);let o=r.extensions[this.name].lights;o.push(s),t.extensions=t.extensions||{},t.extensions[this.name]={light:o.length-1}}}class y{constructor(e){this.writer=e,this.name="KHR_materials_unlit"}async writeMaterialAsync(e,t){if(!e.isMeshBasicMaterial)return;let n=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},n[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}}class b{constructor(e){this.writer=e,this.name="KHR_materials_clearcoat"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.clearcoat)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.clearcoatFactor=e.clearcoat,e.clearcoatMap){let t={index:await n.processTextureAsync(e.clearcoatMap),texCoord:e.clearcoatMap.channel};n.applyTextureTransform(t,e.clearcoatMap),i.clearcoatTexture=t}if(i.clearcoatRoughnessFactor=e.clearcoatRoughness,e.clearcoatRoughnessMap){let t={index:await n.processTextureAsync(e.clearcoatRoughnessMap),texCoord:e.clearcoatRoughnessMap.channel};n.applyTextureTransform(t,e.clearcoatRoughnessMap),i.clearcoatRoughnessTexture=t}if(e.clearcoatNormalMap){let t={index:await n.processTextureAsync(e.clearcoatNormalMap),texCoord:e.clearcoatNormalMap.channel};1!==e.clearcoatNormalScale.x&&(t.scale=e.clearcoatNormalScale.x),n.applyTextureTransform(t,e.clearcoatNormalMap),i.clearcoatNormalTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class g{constructor(e){this.writer=e,this.name="KHR_materials_dispersion"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.dispersion)return;let n=this.writer.extensionsUsed,r={};r.dispersion=e.dispersion,t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class w{constructor(e){this.writer=e,this.name="KHR_materials_iridescence"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.iridescence)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.iridescenceFactor=e.iridescence,e.iridescenceMap){let t={index:await n.processTextureAsync(e.iridescenceMap),texCoord:e.iridescenceMap.channel};n.applyTextureTransform(t,e.iridescenceMap),i.iridescenceTexture=t}if(i.iridescenceIor=e.iridescenceIOR,i.iridescenceThicknessMinimum=e.iridescenceThicknessRange[0],i.iridescenceThicknessMaximum=e.iridescenceThicknessRange[1],e.iridescenceThicknessMap){let t={index:await n.processTextureAsync(e.iridescenceThicknessMap),texCoord:e.iridescenceThicknessMap.channel};n.applyTextureTransform(t,e.iridescenceThicknessMap),i.iridescenceThicknessTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class k{constructor(e){this.writer=e,this.name="KHR_materials_transmission"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.transmissionFactor=e.transmission,e.transmissionMap){let t={index:await n.processTextureAsync(e.transmissionMap),texCoord:e.transmissionMap.channel};n.applyTextureTransform(t,e.transmissionMap),i.transmissionTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class x{constructor(e){this.writer=e,this.name="KHR_materials_volume"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;let n=this.writer,r=n.extensionsUsed,i={};if(i.thicknessFactor=e.thickness,e.thicknessMap){let t={index:await n.processTextureAsync(e.thicknessMap),texCoord:e.thicknessMap.channel};n.applyTextureTransform(t,e.thicknessMap),i.thicknessTexture=t}e.attenuationDistance!==1/0&&(i.attenuationDistance=e.attenuationDistance),i.attenuationColor=e.attenuationColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class T{constructor(e){this.writer=e,this.name="KHR_materials_ior"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||1.5===e.ior)return;let n=this.writer.extensionsUsed,r={};r.ior=e.ior,t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class P{constructor(e){this.writer=e,this.name="KHR_materials_specular"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||1===e.specularIntensity&&e.specularColor.equals(u)&&!e.specularIntensityMap&&!e.specularColorMap)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.specularIntensityMap){let t={index:await n.processTextureAsync(e.specularIntensityMap),texCoord:e.specularIntensityMap.channel};n.applyTextureTransform(t,e.specularIntensityMap),i.specularTexture=t}if(e.specularColorMap){let t={index:await n.processTextureAsync(e.specularColorMap),texCoord:e.specularColorMap.channel};n.applyTextureTransform(t,e.specularColorMap),i.specularColorTexture=t}i.specularFactor=e.specularIntensity,i.specularColorFactor=e.specularColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class R{constructor(e){this.writer=e,this.name="KHR_materials_sheen"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0==e.sheen)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.sheenRoughnessMap){let t={index:await n.processTextureAsync(e.sheenRoughnessMap),texCoord:e.sheenRoughnessMap.channel};n.applyTextureTransform(t,e.sheenRoughnessMap),i.sheenRoughnessTexture=t}if(e.sheenColorMap){let t={index:await n.processTextureAsync(e.sheenColorMap),texCoord:e.sheenColorMap.channel};n.applyTextureTransform(t,e.sheenColorMap),i.sheenColorTexture=t}i.sheenRoughnessFactor=e.sheenRoughness,i.sheenColorFactor=e.sheenColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class S{constructor(e){this.writer=e,this.name="KHR_materials_anisotropy"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0==e.anisotropy)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.anisotropyMap){let t={index:await n.processTextureAsync(e.anisotropyMap)};n.applyTextureTransform(t,e.anisotropyMap),i.anisotropyTexture=t}i.anisotropyStrength=e.anisotropy,i.anisotropyRotation=e.anisotropyRotation,t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class E{constructor(e){this.writer=e,this.name="KHR_materials_emissive_strength"}async writeMaterialAsync(e,t){if(!e.isMeshStandardMaterial||1===e.emissiveIntensity)return;let n=this.writer.extensionsUsed,r={};r.emissiveStrength=e.emissiveIntensity,t.extensions=t.extensions||{},t.extensions[this.name]=r,n[this.name]=!0}}class A{constructor(e){this.writer=e,this.name="EXT_materials_bump"}async writeMaterialAsync(e,t){if(!e.isMeshStandardMaterial||1===e.bumpScale&&!e.bumpMap)return;let n=this.writer,r=n.extensionsUsed,i={};if(e.bumpMap){let t={index:await n.processTextureAsync(e.bumpMap),texCoord:e.bumpMap.channel};n.applyTextureTransform(t,e.bumpMap),i.bumpTexture=t}i.bumpFactor=e.bumpScale,t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class O{constructor(e){this.writer=e,this.name="EXT_mesh_gpu_instancing"}writeNode(e,t){if(!e.isInstancedMesh)return;let n=this.writer,i=new Float32Array(3*e.count),s=new Float32Array(4*e.count),o=new Float32Array(3*e.count),a=new r.kn4,l=new r.Pq0,c=new r.PTz,u=new r.Pq0;for(let t=0;t<e.count;t++)e.getMatrixAt(t,a),a.decompose(l,c,u),l.toArray(i,3*t),c.toArray(s,4*t),u.toArray(o,3*t);let h={TRANSLATION:n.processAccessor(new r.THS(i,3)),ROTATION:n.processAccessor(new r.THS(s,4)),SCALE:n.processAccessor(new r.THS(o,3))};e.instanceColor&&(h._COLOR_0=n.processAccessor(e.instanceColor)),t.extensions=t.extensions||{},t.extensions[this.name]={attributes:h},n.extensionsUsed[this.name]=!0,n.extensionsRequired[this.name]=!0}}function M(e,t){if(t===r.RJ4)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(t!==r.rYR&&t!==r.O49)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),e;{let n=e.getIndex();if(null===n){let t=[],r=e.getAttribute("position");if(void 0===r)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<r.count;e++)t.push(e);e.setIndex(t),n=e.getIndex()}let i=n.count-2,s=[];if(t===r.rYR)for(let e=1;e<=i;e++)s.push(n.getX(0)),s.push(n.getX(e)),s.push(n.getX(e+1));else for(let e=0;e<i;e++)e%2==0?(s.push(n.getX(e)),s.push(n.getX(e+1)),s.push(n.getX(e+2))):(s.push(n.getX(e+2)),s.push(n.getX(e+1)),s.push(n.getX(e)));s.length/3!==i&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");let o=e.clone();return o.setIndex(s),o.clearGroups(),o}}s.Utils={insertKeyframe:function(e,t){let n,r=e.getValueSize(),i=new e.TimeBufferType(e.times.length+1),s=new e.ValueBufferType(e.values.length+r),o=e.createInterpolant(new e.ValueBufferType(r));if(0===e.times.length){i[0]=t;for(let e=0;e<r;e++)s[e]=0;n=0}else if(t<e.times[0]){if(.001>Math.abs(e.times[0]-t))return 0;i[0]=t,i.set(e.times,1),s.set(o.evaluate(t),0),s.set(e.values,r),n=0}else if(t>e.times[e.times.length-1]){if(.001>Math.abs(e.times[e.times.length-1]-t))return e.times.length-1;i[i.length-1]=t,i.set(e.times,0),s.set(e.values,0),s.set(o.evaluate(t),e.values.length),n=i.length-1}else for(let a=0;a<e.times.length;a++){if(.001>Math.abs(e.times[a]-t))return a;if(e.times[a]<t&&e.times[a+1]>t){i.set(e.times.slice(0,a+1),0),i[a+1]=t,i.set(e.times.slice(a+1),a+2),s.set(e.values.slice(0,(a+1)*r),0),s.set(o.evaluate(t),(a+1)*r),s.set(e.values.slice((a+1)*r),(a+2)*r),n=a+1;break}}return e.times=i,e.values=s,n},mergeMorphTargetTracks:function(e,t){let n=[],i={},s=e.tracks;for(let e=0;e<s.length;++e){let o,a=s[e],l=r.Nwf.parseTrackName(a.name),c=r.Nwf.findNode(t,l.nodeName);if("morphTargetInfluences"!==l.propertyName||void 0===l.propertyIndex){n.push(a);continue}if(a.createInterpolant!==a.InterpolantFactoryMethodDiscrete&&a.createInterpolant!==a.InterpolantFactoryMethodLinear){if(a.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),(a=a.clone()).setInterpolation(r.PJ3)}let u=c.morphTargetInfluences.length,h=c.morphTargetDictionary[l.propertyIndex];if(void 0===h)throw Error("THREE.GLTFExporter: Morph target name not found: "+l.propertyIndex);if(void 0===i[c.uuid]){let e=new(o=a.clone()).ValueBufferType(u*o.times.length);for(let t=0;t<o.times.length;t++)e[t*u+h]=o.values[t];o.name=(l.nodeName||"")+".morphTargetInfluences",o.values=e,i[c.uuid]=o,n.push(o);continue}let f=a.createInterpolant(new a.ValueBufferType(1));o=i[c.uuid];for(let e=0;e<o.times.length;e++)o.values[e*u+h]=f.evaluate(o.times[e]);for(let e=0;e<a.times.length;e++){let t=this.insertKeyframe(o,a.times[e]);o.values[t*u+h]=a.values[e]}}return e.tracks=n,e},toFloat32BufferAttribute:function(e){let t=new r.THS(new Float32Array(e.count*e.itemSize),e.itemSize,!1);if(!e.normalized&&!e.isInterleavedBufferAttribute)return t.array.set(e.array),t;for(let n=0,r=e.count;n<r;n++)for(let r=0;r<e.itemSize;r++)t.setComponent(n,r,e.getComponent(n,r));return t}};class _ extends r.aHM{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(e){return new N(e)}),this.register(function(e){return new F(e)}),this.register(function(e){return new X(e)}),this.register(function(e){return new W(e)}),this.register(function(e){return new Y(e)}),this.register(function(e){return new U(e)}),this.register(function(e){return new D(e)}),this.register(function(e){return new z(e)}),this.register(function(e){return new q(e)}),this.register(function(e){return new L(e)}),this.register(function(e){return new V(e)}),this.register(function(e){return new H(e)}),this.register(function(e){return new K(e)}),this.register(function(e){return new G(e)}),this.register(function(e){return new j(e)}),this.register(function(e){return new J(e)}),this.register(function(e){return new Q(e)})}load(e,t,n,i){let s,o=this;if(""!==this.resourcePath)s=this.resourcePath;else if(""!==this.path){let t=r.r6x.extractUrlBase(e);s=r.r6x.resolveURL(t,this.path)}else s=r.r6x.extractUrlBase(e);this.manager.itemStart(e);let a=function(t){i?i(t):console.error(t),o.manager.itemError(e),o.manager.itemEnd(e)},l=new r.Y9S(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials),l.load(e,function(n){try{o.parse(n,s,function(n){t(n),o.manager.itemEnd(e)},a)}catch(e){a(e)}},n,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return -1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return -1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,n,r){let i,s={},o={},a=new TextDecoder;if("string"==typeof e)i=JSON.parse(e);else if(e instanceof ArrayBuffer)if(a.decode(new Uint8Array(e,0,4))===Z){try{s[C.KHR_BINARY_GLTF]=new ee(e)}catch(e){r&&r(e);return}i=JSON.parse(s[C.KHR_BINARY_GLTF].content)}else i=JSON.parse(a.decode(e));else i=e;if(void 0===i.asset||i.asset.version[0]<2){r&&r(Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}let l=new ek(i,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){let t=this.pluginCallbacks[e](l);t.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),o[t.name]=t,s[t.name]=!0}if(i.extensionsUsed)for(let e=0;e<i.extensionsUsed.length;++e){let t=i.extensionsUsed[e],n=i.extensionsRequired||[];switch(t){case C.KHR_MATERIALS_UNLIT:s[t]=new B;break;case C.KHR_DRACO_MESH_COMPRESSION:s[t]=new et(i,this.dracoLoader);break;case C.KHR_TEXTURE_TRANSFORM:s[t]=new en;break;case C.KHR_MESH_QUANTIZATION:s[t]=new er;break;default:n.indexOf(t)>=0&&void 0===o[t]&&console.warn('THREE.GLTFLoader: Unknown extension "'+t+'".')}}l.setExtensions(s),l.setPlugins(o),l.parse(n,r)}parseAsync(e,t){let n=this;return new Promise(function(r,i){n.parse(e,t,r,i)})}}function I(){let e={};return{get:function(t){return e[t]},add:function(t,n){e[t]=n},remove:function(t){delete e[t]},removeAll:function(){e={}}}}let C={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class j{constructor(e){this.parser=e,this.name=C.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){let e=this.parser,t=this.parser.json.nodes||[];for(let n=0,r=t.length;n<r;n++){let r=t[n];r.extensions&&r.extensions[this.name]&&void 0!==r.extensions[this.name].light&&e._addNodeRef(this.cache,r.extensions[this.name].light)}}_loadLight(e){let t,n=this.parser,i="light:"+e,s=n.cache.get(i);if(s)return s;let o=n.json,a=((o.extensions&&o.extensions[this.name]||{}).lights||[])[e],l=new r.Q1f(0xffffff);void 0!==a.color&&l.setRGB(a.color[0],a.color[1],a.color[2],r.Zr2);let c=void 0!==a.range?a.range:0;switch(a.type){case"directional":(t=new r.ZyN(l)).target.position.set(0,0,-1),t.add(t.target);break;case"point":(t=new r.HiM(l)).distance=c;break;case"spot":(t=new r.nCl(l)).distance=c,a.spot=a.spot||{},a.spot.innerConeAngle=void 0!==a.spot.innerConeAngle?a.spot.innerConeAngle:0,a.spot.outerConeAngle=void 0!==a.spot.outerConeAngle?a.spot.outerConeAngle:Math.PI/4,t.angle=a.spot.outerConeAngle,t.penumbra=1-a.spot.innerConeAngle/a.spot.outerConeAngle,t.target.position.set(0,0,-1),t.add(t.target);break;default:throw Error("THREE.GLTFLoader: Unexpected light type: "+a.type)}return t.position.set(0,0,0),ey(t,a),void 0!==a.intensity&&(t.intensity=a.intensity),t.name=n.createUniqueName(a.name||"light_"+e),s=Promise.resolve(t),n.cache.add(i,s),s}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){let t=this,n=this.parser,r=n.json.nodes[e],i=(r.extensions&&r.extensions[this.name]||{}).light;return void 0===i?null:this._loadLight(i).then(function(e){return n._getNodeRef(t.cache,i,e)})}}class B{constructor(){this.name=C.KHR_MATERIALS_UNLIT}getMaterialType(){return r.V9B}extendParams(e,t,n){let i=[];e.color=new r.Q1f(1,1,1),e.opacity=1;let s=t.pbrMetallicRoughness;if(s){if(Array.isArray(s.baseColorFactor)){let t=s.baseColorFactor;e.color.setRGB(t[0],t[1],t[2],r.Zr2),e.opacity=t[3]}void 0!==s.baseColorTexture&&i.push(n.assignTexture(e,"map",s.baseColorTexture,r.er$))}return Promise.all(i)}}class L{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){let n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=n.extensions[this.name].emissiveStrength;return void 0!==r&&(t.emissiveIntensity=r),Promise.resolve()}}class N{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let s=[],o=i.extensions[this.name];if(void 0!==o.clearcoatFactor&&(t.clearcoat=o.clearcoatFactor),void 0!==o.clearcoatTexture&&s.push(n.assignTexture(t,"clearcoatMap",o.clearcoatTexture)),void 0!==o.clearcoatRoughnessFactor&&(t.clearcoatRoughness=o.clearcoatRoughnessFactor),void 0!==o.clearcoatRoughnessTexture&&s.push(n.assignTexture(t,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),void 0!==o.clearcoatNormalTexture&&(s.push(n.assignTexture(t,"clearcoatNormalMap",o.clearcoatNormalTexture)),void 0!==o.clearcoatNormalTexture.scale)){let e=o.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new r.I9Y(e,e)}return Promise.all(s)}}class F{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_DISPERSION}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=n.extensions[this.name];return t.dispersion=void 0!==r.dispersion?r.dispersion:0,Promise.resolve()}}class H{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],s=r.extensions[this.name];return void 0!==s.iridescenceFactor&&(t.iridescence=s.iridescenceFactor),void 0!==s.iridescenceTexture&&i.push(n.assignTexture(t,"iridescenceMap",s.iridescenceTexture)),void 0!==s.iridescenceIor&&(t.iridescenceIOR=s.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==s.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=s.iridescenceThicknessMinimum),void 0!==s.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=s.iridescenceThicknessMaximum),void 0!==s.iridescenceThicknessTexture&&i.push(n.assignTexture(t,"iridescenceThicknessMap",s.iridescenceThicknessTexture)),Promise.all(i)}}class U{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_SHEEN}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let s=[];t.sheenColor=new r.Q1f(0,0,0),t.sheenRoughness=0,t.sheen=1;let o=i.extensions[this.name];if(void 0!==o.sheenColorFactor){let e=o.sheenColorFactor;t.sheenColor.setRGB(e[0],e[1],e[2],r.Zr2)}return void 0!==o.sheenRoughnessFactor&&(t.sheenRoughness=o.sheenRoughnessFactor),void 0!==o.sheenColorTexture&&s.push(n.assignTexture(t,"sheenColorMap",o.sheenColorTexture,r.er$)),void 0!==o.sheenRoughnessTexture&&s.push(n.assignTexture(t,"sheenRoughnessMap",o.sheenRoughnessTexture)),Promise.all(s)}}class D{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],s=r.extensions[this.name];return void 0!==s.transmissionFactor&&(t.transmission=s.transmissionFactor),void 0!==s.transmissionTexture&&i.push(n.assignTexture(t,"transmissionMap",s.transmissionTexture)),Promise.all(i)}}class z{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_VOLUME}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let s=[],o=i.extensions[this.name];t.thickness=void 0!==o.thicknessFactor?o.thicknessFactor:0,void 0!==o.thicknessTexture&&s.push(n.assignTexture(t,"thicknessMap",o.thicknessTexture)),t.attenuationDistance=o.attenuationDistance||1/0;let a=o.attenuationColor||[1,1,1];return t.attenuationColor=new r.Q1f().setRGB(a[0],a[1],a[2],r.Zr2),Promise.all(s)}}class q{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_IOR}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();let r=n.extensions[this.name];return t.ior=void 0!==r.ior?r.ior:1.5,Promise.resolve()}}class V{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_SPECULAR}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let s=[],o=i.extensions[this.name];t.specularIntensity=void 0!==o.specularFactor?o.specularFactor:1,void 0!==o.specularTexture&&s.push(n.assignTexture(t,"specularIntensityMap",o.specularTexture));let a=o.specularColorFactor||[1,1,1];return t.specularColor=new r.Q1f().setRGB(a[0],a[1],a[2],r.Zr2),void 0!==o.specularColorTexture&&s.push(n.assignTexture(t,"specularColorMap",o.specularColorTexture,r.er$)),Promise.all(s)}}class G{constructor(e){this.parser=e,this.name=C.EXT_MATERIALS_BUMP}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],s=r.extensions[this.name];return t.bumpScale=void 0!==s.bumpFactor?s.bumpFactor:1,void 0!==s.bumpTexture&&i.push(n.assignTexture(t,"bumpMap",s.bumpTexture)),Promise.all(i)}}class K{constructor(e){this.parser=e,this.name=C.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.uSd:null}extendMaterialParams(e,t){let n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=[],s=r.extensions[this.name];return void 0!==s.anisotropyStrength&&(t.anisotropy=s.anisotropyStrength),void 0!==s.anisotropyRotation&&(t.anisotropyRotation=s.anisotropyRotation),void 0!==s.anisotropyTexture&&i.push(n.assignTexture(t,"anisotropyMap",s.anisotropyTexture)),Promise.all(i)}}class X{constructor(e){this.parser=e,this.name=C.KHR_TEXTURE_BASISU}loadTexture(e){let t=this.parser,n=t.json,r=n.textures[e];if(!r.extensions||!r.extensions[this.name])return null;let i=r.extensions[this.name],s=t.options.ktx2Loader;if(!s)if(!(n.extensionsRequired&&n.extensionsRequired.indexOf(this.name)>=0))return null;else throw Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return t.loadTextureImage(e,i.source,s)}}class W{constructor(e){this.parser=e,this.name=C.EXT_TEXTURE_WEBP}loadTexture(e){let t=this.name,n=this.parser,r=n.json,i=r.textures[e];if(!i.extensions||!i.extensions[t])return null;let s=i.extensions[t],o=r.images[s.source],a=n.textureLoader;if(o.uri){let e=n.options.manager.getHandler(o.uri);null!==e&&(a=e)}return n.loadTextureImage(e,s.source,a)}}class Y{constructor(e){this.parser=e,this.name=C.EXT_TEXTURE_AVIF}loadTexture(e){let t=this.name,n=this.parser,r=n.json,i=r.textures[e];if(!i.extensions||!i.extensions[t])return null;let s=i.extensions[t],o=r.images[s.source],a=n.textureLoader;if(o.uri){let e=n.options.manager.getHandler(o.uri);null!==e&&(a=e)}return n.loadTextureImage(e,s.source,a)}}class J{constructor(e){this.name=C.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){let t=this.parser.json,n=t.bufferViews[e];if(!n.extensions||!n.extensions[this.name])return null;{let e=n.extensions[this.name],r=this.parser.getDependency("buffer",e.buffer),i=this.parser.options.meshoptDecoder;if(!i||!i.supported)if(!(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0))return null;else throw Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return r.then(function(t){let n=e.byteOffset||0,r=e.byteLength||0,s=e.count,o=e.byteStride,a=new Uint8Array(t,n,r);return i.decodeGltfBufferAsync?i.decodeGltfBufferAsync(s,o,a,e.mode,e.filter).then(function(e){return e.buffer}):i.ready.then(function(){let t=new ArrayBuffer(s*o);return i.decodeGltfBuffer(new Uint8Array(t),s,o,a,e.mode,e.filter),t})})}}}class Q{constructor(e){this.name=C.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){let t=this.parser.json,n=t.nodes[e];if(!n.extensions||!n.extensions[this.name]||void 0===n.mesh)return null;for(let e of t.meshes[n.mesh].primitives)if(e.mode!==ea.TRIANGLES&&e.mode!==ea.TRIANGLE_STRIP&&e.mode!==ea.TRIANGLE_FAN&&void 0!==e.mode)return null;let i=n.extensions[this.name].attributes,s=[],o={};for(let e in i)s.push(this.parser.getDependency("accessor",i[e]).then(t=>(o[e]=t,o[e])));return s.length<1?null:(s.push(this.parser.createNodeMesh(e)),Promise.all(s).then(e=>{let t=e.pop(),n=t.isGroup?t.children:[t],i=e[0].count,s=[];for(let e of n){let t=new r.kn4,n=new r.Pq0,a=new r.PTz,l=new r.Pq0(1,1,1),c=new r.ZLX(e.geometry,e.material,i);for(let e=0;e<i;e++)o.TRANSLATION&&n.fromBufferAttribute(o.TRANSLATION,e),o.ROTATION&&a.fromBufferAttribute(o.ROTATION,e),o.SCALE&&l.fromBufferAttribute(o.SCALE,e),c.setMatrixAt(e,t.compose(n,a,l));for(let t in o)if("_COLOR_0"===t){let e=o[t];c.instanceColor=new r.uWO(e.array,e.itemSize,e.normalized)}else"TRANSLATION"!==t&&"ROTATION"!==t&&"SCALE"!==t&&e.geometry.setAttribute(t,o[t]);r.B69.prototype.copy.call(c,e),this.parser.assignFinalMaterial(c),s.push(c)}return t.isGroup?(t.clear(),t.add(...s),t):s[0]}))}}let Z="glTF",$={JSON:0x4e4f534a,BIN:5130562};class ee{constructor(e){this.name=C.KHR_BINARY_GLTF,this.content=null,this.body=null;let t=new DataView(e,0,12),n=new TextDecoder;if(this.header={magic:n.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Z)throw Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw Error("THREE.GLTFLoader: Legacy binary file detected.");let r=this.header.length-12,i=new DataView(e,12),s=0;for(;s<r;){let t=i.getUint32(s,!0);s+=4;let r=i.getUint32(s,!0);if(s+=4,r===$.JSON){let r=new Uint8Array(e,12+s,t);this.content=n.decode(r)}else if(r===$.BIN){let n=12+s;this.body=e.slice(n,n+t)}s+=t}if(null===this.content)throw Error("THREE.GLTFLoader: JSON content not found.")}}class et{constructor(e,t){if(!t)throw Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=C.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){let n=this.json,i=this.dracoLoader,s=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,a={},l={},c={};for(let e in o)a[ef[e]||e.toLowerCase()]=o[e];for(let t in e.attributes){let r=ef[t]||t.toLowerCase();if(void 0!==o[t]){let i=n.accessors[e.attributes[t]],s=el[i.componentType];c[r]=s.name,l[r]=!0===i.normalized}}return t.getDependency("bufferView",s).then(function(e){return new Promise(function(t,n){i.decodeDracoFile(e,function(e){for(let t in e.attributes){let n=e.attributes[t],r=l[t];void 0!==r&&(n.normalized=r)}t(e)},a,c,r.Zr2,n)})})}}class en{constructor(){this.name=C.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(void 0===t.texCoord||t.texCoord===e.channel)&&void 0===t.offset&&void 0===t.rotation&&void 0===t.scale||(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class er{constructor(){this.name=C.KHR_MESH_QUANTIZATION}}class ei extends r.lGw{constructor(e,t,n,r){super(e,t,n,r)}copySampleValue_(e){let t=this.resultBuffer,n=this.sampleValues,r=this.valueSize,i=e*r*3+r;for(let e=0;e!==r;e++)t[e]=n[i+e];return t}interpolate_(e,t,n,r){let i=this.resultBuffer,s=this.sampleValues,o=this.valueSize,a=2*o,l=3*o,c=r-t,u=(n-t)/c,h=u*u,f=h*u,p=e*l,d=p-l,v=-2*f+3*h,m=f-h,y=1-v,b=m-h+u;for(let e=0;e!==o;e++){let t=s[d+e+o],n=s[d+e+a]*c,r=s[p+e+o],l=s[p+e]*c;i[e]=y*t+b*n+v*r+m*l}return i}}let es=new r.PTz;class eo extends ei{interpolate_(e,t,n,r){let i=super.interpolate_(e,t,n,r);return es.fromArray(i).normalize().toArray(i),i}}let ea={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},el={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},ec={9728:r.hxR,9729:r.k6q,9984:r.pHI,9985:r.kRr,9986:r.Cfg,9987:r.$_I},eu={33071:r.ghU,33648:r.kTW,10497:r.GJx},eh={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},ef={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},ep={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},ed={CUBICSPLINE:void 0,LINEAR:r.PJ3,STEP:r.ljd},ev={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function em(e,t,n){for(let r in n.extensions)void 0===e[r]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[r]=n.extensions[r])}function ey(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function eb(e){let t="",n=Object.keys(e).sort();for(let r=0,i=n.length;r<i;r++)t+=n[r]+":"+e[n[r]]+";";return t}function eg(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}let ew=new r.kn4;class ek{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new I,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let n=!1,i=-1,s=!1,o=-1;if("undefined"!=typeof navigator){let e=navigator.userAgent;n=!0===/^((?!chrome|android).)*safari/i.test(e);let t=e.match(/Version\/(\d+)/);i=n&&t?parseInt(t[1],10):-1,o=(s=e.indexOf("Firefox")>-1)?e.match(/Firefox\/([0-9]+)\./)[1]:-1}"undefined"==typeof createImageBitmap||n&&i<17||s&&o<98?this.textureLoader=new r.Tap(this.options.manager):this.textureLoader=new r.Kzg(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new r.Y9S(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){let n=this,r=this.json,i=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(e){return e._markDefs&&e._markDefs()}),Promise.all(this._invokeAll(function(e){return e.beforeRoot&&e.beforeRoot()})).then(function(){return Promise.all([n.getDependencies("scene"),n.getDependencies("animation"),n.getDependencies("camera")])}).then(function(t){let s={scene:t[0][r.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:r.asset,parser:n,userData:{}};return em(i,s,r),ey(s,r),Promise.all(n._invokeAll(function(e){return e.afterRoot&&e.afterRoot(s)})).then(function(){for(let e of s.scenes)e.updateMatrixWorld();e(s)})}).catch(t)}_markDefs(){let e=this.json.nodes||[],t=this.json.skins||[],n=this.json.meshes||[];for(let n=0,r=t.length;n<r;n++){let r=t[n].joints;for(let t=0,n=r.length;t<n;t++)e[r[t]].isBone=!0}for(let t=0,r=e.length;t<r;t++){let r=e[t];void 0!==r.mesh&&(this._addNodeRef(this.meshCache,r.mesh),void 0!==r.skin&&(n[r.mesh].isSkinnedMesh=!0)),void 0!==r.camera&&this._addNodeRef(this.cameraCache,r.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,n){if(e.refs[t]<=1)return n;let r=n.clone(),i=(e,t)=>{let n=this.associations.get(e);for(let[r,s]of(null!=n&&this.associations.set(t,n),e.children.entries()))i(s,t.children[r])};return i(n,r),r.name+="_instance_"+e.uses[t]++,r}_invokeOne(e){let t=Object.values(this.plugins);t.push(this);for(let n=0;n<t.length;n++){let r=e(t[n]);if(r)return r}return null}_invokeAll(e){let t=Object.values(this.plugins);t.unshift(this);let n=[];for(let r=0;r<t.length;r++){let i=e(t[r]);i&&n.push(i)}return n}getDependency(e,t){let n=e+":"+t,r=this.cache.get(n);if(!r){switch(e){case"scene":r=this.loadScene(t);break;case"node":r=this._invokeOne(function(e){return e.loadNode&&e.loadNode(t)});break;case"mesh":r=this._invokeOne(function(e){return e.loadMesh&&e.loadMesh(t)});break;case"accessor":r=this.loadAccessor(t);break;case"bufferView":r=this._invokeOne(function(e){return e.loadBufferView&&e.loadBufferView(t)});break;case"buffer":r=this.loadBuffer(t);break;case"material":r=this._invokeOne(function(e){return e.loadMaterial&&e.loadMaterial(t)});break;case"texture":r=this._invokeOne(function(e){return e.loadTexture&&e.loadTexture(t)});break;case"skin":r=this.loadSkin(t);break;case"animation":r=this._invokeOne(function(e){return e.loadAnimation&&e.loadAnimation(t)});break;case"camera":r=this.loadCamera(t);break;default:if(!(r=this._invokeOne(function(n){return n!=this&&n.getDependency&&n.getDependency(e,t)})))throw Error("Unknown type: "+e)}this.cache.add(n,r)}return r}getDependencies(e){let t=this.cache.get(e);if(!t){let n=this;t=Promise.all((this.json[e+("mesh"===e?"es":"s")]||[]).map(function(t,r){return n.getDependency(e,r)})),this.cache.add(e,t)}return t}loadBuffer(e){let t=this.json.buffers[e],n=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[C.KHR_BINARY_GLTF].body);let i=this.options;return new Promise(function(e,s){n.load(r.r6x.resolveURL(t.uri,i.path),e,void 0,function(){s(Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){let t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(e){let n=t.byteLength||0,r=t.byteOffset||0;return e.slice(r,r+n)})}loadAccessor(e){let t=this,n=this.json,i=this.json.accessors[e];if(void 0===i.bufferView&&void 0===i.sparse){let e=eh[i.type],t=el[i.componentType],n=!0===i.normalized,s=new t(i.count*e);return Promise.resolve(new r.THS(s,e,n))}let s=[];return void 0!==i.bufferView?s.push(this.getDependency("bufferView",i.bufferView)):s.push(null),void 0!==i.sparse&&(s.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),s.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(s).then(function(e){let s,o,a=e[0],l=eh[i.type],c=el[i.componentType],u=c.BYTES_PER_ELEMENT,h=u*l,f=i.byteOffset||0,p=void 0!==i.bufferView?n.bufferViews[i.bufferView].byteStride:void 0,d=!0===i.normalized;if(p&&p!==h){let e=Math.floor(f/p),n="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+e+":"+i.count,h=t.cache.get(n);h||(s=new c(a,e*p,i.count*p/u),h=new r.eB$(s,p/u),t.cache.add(n,h)),o=new r.eHs(h,l,f%p/u,d)}else s=null===a?new c(i.count*l):new c(a,f,i.count*l),o=new r.THS(s,l,d);if(void 0!==i.sparse){let t=eh.SCALAR,n=el[i.sparse.indices.componentType],s=i.sparse.indices.byteOffset||0,u=i.sparse.values.byteOffset||0,h=new n(e[1],s,i.sparse.count*t),f=new c(e[2],u,i.sparse.count*l);null!==a&&(o=new r.THS(o.array.slice(),o.itemSize,o.normalized)),o.normalized=!1;for(let e=0,t=h.length;e<t;e++){let t=h[e];if(o.setX(t,f[e*l]),l>=2&&o.setY(t,f[e*l+1]),l>=3&&o.setZ(t,f[e*l+2]),l>=4&&o.setW(t,f[e*l+3]),l>=5)throw Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}o.normalized=d}return o})}loadTexture(e){let t=this.json,n=this.options,r=t.textures[e].source,i=t.images[r],s=this.textureLoader;if(i.uri){let e=n.manager.getHandler(i.uri);null!==e&&(s=e)}return this.loadTextureImage(e,r,s)}loadTextureImage(e,t,n){let i=this,s=this.json,o=s.textures[e],a=s.images[t],l=(a.uri||a.bufferView)+":"+o.sampler;if(this.textureCache[l])return this.textureCache[l];let c=this.loadImageSource(t,n).then(function(t){t.flipY=!1,t.name=o.name||a.name||"",""===t.name&&"string"==typeof a.uri&&!1===a.uri.startsWith("data:image/")&&(t.name=a.uri);let n=(s.samplers||{})[o.sampler]||{};return t.magFilter=ec[n.magFilter]||r.k6q,t.minFilter=ec[n.minFilter]||r.$_I,t.wrapS=eu[n.wrapS]||r.GJx,t.wrapT=eu[n.wrapT]||r.GJx,t.generateMipmaps=!t.isCompressedTexture&&t.minFilter!==r.hxR&&t.minFilter!==r.k6q,i.associations.set(t,{textures:e}),t}).catch(function(){return null});return this.textureCache[l]=c,c}loadImageSource(e,t){let n=this.json,i=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then(e=>e.clone());let s=n.images[e],o=self.URL||self.webkitURL,a=s.uri||"",l=!1;if(void 0!==s.bufferView)a=this.getDependency("bufferView",s.bufferView).then(function(e){l=!0;let t=new Blob([e],{type:s.mimeType});return a=o.createObjectURL(t)});else if(void 0===s.uri)throw Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");let c=Promise.resolve(a).then(function(e){return new Promise(function(n,s){let o=n;!0===t.isImageBitmapLoader&&(o=function(e){let t=new r.gPd(e);t.needsUpdate=!0,n(t)}),t.load(r.r6x.resolveURL(e,i.path),o,void 0,s)})}).then(function(e){var t;return!0===l&&o.revokeObjectURL(a),ey(e,s),e.userData.mimeType=s.mimeType||((t=s.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":t.search(/\.ktx2($|\?)/i)>0||0===t.search(/^data\:image\/ktx2/)?"image/ktx2":"image/png"),e}).catch(function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",a),e});return this.sourceCache[e]=c,c}assignTexture(e,t,n,r){let i=this;return this.getDependency("texture",n.index).then(function(s){if(!s)return null;if(void 0!==n.texCoord&&n.texCoord>0&&((s=s.clone()).channel=n.texCoord),i.extensions[C.KHR_TEXTURE_TRANSFORM]){let e=void 0!==n.extensions?n.extensions[C.KHR_TEXTURE_TRANSFORM]:void 0;if(e){let t=i.associations.get(s);s=i.extensions[C.KHR_TEXTURE_TRANSFORM].extendTexture(s,e),i.associations.set(s,t)}}return void 0!==r&&(s.colorSpace=r),e[t]=s,s})}assignFinalMaterial(e){let t=e.geometry,n=e.material,i=void 0===t.attributes.tangent,s=void 0!==t.attributes.color,o=void 0===t.attributes.normal;if(e.isPoints){let e="PointsMaterial:"+n.uuid,t=this.cache.get(e);t||(t=new r.BH$,r.imn.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,t.sizeAttenuation=!1,this.cache.add(e,t)),n=t}else if(e.isLine){let e="LineBasicMaterial:"+n.uuid,t=this.cache.get(e);t||(t=new r.mrM,r.imn.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,this.cache.add(e,t)),n=t}if(i||s||o){let e="ClonedMaterial:"+n.uuid+":";i&&(e+="derivative-tangents:"),s&&(e+="vertex-colors:"),o&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=n.clone(),s&&(t.vertexColors=!0),o&&(t.flatShading=!0),i&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(n))),n=t}e.material=n}getMaterialType(){return r._4j}loadMaterial(e){let t,n=this,i=this.json,s=this.extensions,o=i.materials[e],a={},l=o.extensions||{},c=[];if(l[C.KHR_MATERIALS_UNLIT]){let e=s[C.KHR_MATERIALS_UNLIT];t=e.getMaterialType(),c.push(e.extendParams(a,o,n))}else{let i=o.pbrMetallicRoughness||{};if(a.color=new r.Q1f(1,1,1),a.opacity=1,Array.isArray(i.baseColorFactor)){let e=i.baseColorFactor;a.color.setRGB(e[0],e[1],e[2],r.Zr2),a.opacity=e[3]}void 0!==i.baseColorTexture&&c.push(n.assignTexture(a,"map",i.baseColorTexture,r.er$)),a.metalness=void 0!==i.metallicFactor?i.metallicFactor:1,a.roughness=void 0!==i.roughnessFactor?i.roughnessFactor:1,void 0!==i.metallicRoughnessTexture&&(c.push(n.assignTexture(a,"metalnessMap",i.metallicRoughnessTexture)),c.push(n.assignTexture(a,"roughnessMap",i.metallicRoughnessTexture))),t=this._invokeOne(function(t){return t.getMaterialType&&t.getMaterialType(e)}),c.push(Promise.all(this._invokeAll(function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,a)})))}!0===o.doubleSided&&(a.side=r.$EB);let u=o.alphaMode||ev.OPAQUE;if(u===ev.BLEND?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,u===ev.MASK&&(a.alphaTest=void 0!==o.alphaCutoff?o.alphaCutoff:.5)),void 0!==o.normalTexture&&t!==r.V9B&&(c.push(n.assignTexture(a,"normalMap",o.normalTexture)),a.normalScale=new r.I9Y(1,1),void 0!==o.normalTexture.scale)){let e=o.normalTexture.scale;a.normalScale.set(e,e)}if(void 0!==o.occlusionTexture&&t!==r.V9B&&(c.push(n.assignTexture(a,"aoMap",o.occlusionTexture)),void 0!==o.occlusionTexture.strength&&(a.aoMapIntensity=o.occlusionTexture.strength)),void 0!==o.emissiveFactor&&t!==r.V9B){let e=o.emissiveFactor;a.emissive=new r.Q1f().setRGB(e[0],e[1],e[2],r.Zr2)}return void 0!==o.emissiveTexture&&t!==r.V9B&&c.push(n.assignTexture(a,"emissiveMap",o.emissiveTexture,r.er$)),Promise.all(c).then(function(){let r=new t(a);return o.name&&(r.name=o.name),ey(r,o),n.associations.set(r,{materials:e}),o.extensions&&em(s,r,o),r})}createUniqueName(e){let t=r.Nwf.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){let t=this,n=this.extensions,i=this.primitiveCache,s=[];for(let o=0,a=e.length;o<a;o++){let a=e[o],l=function(e){let t,n=e.extensions&&e.extensions[C.KHR_DRACO_MESH_COMPRESSION];if(t=n?"draco:"+n.bufferView+":"+n.indices+":"+eb(n.attributes):e.indices+":"+eb(e.attributes)+":"+e.mode,void 0!==e.targets)for(let n=0,r=e.targets.length;n<r;n++)t+=":"+eb(e.targets[n]);return t}(a),c=i[l];if(c)s.push(c.promise);else{let e;e=a.extensions&&a.extensions[C.KHR_DRACO_MESH_COMPRESSION]?function(e){return n[C.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then(function(n){return ex(n,e,t)})}(a):ex(new r.LoY,a,t),i[l]={primitive:a,promise:e},s.push(e)}}return Promise.all(s)}loadMesh(e){let t=this,n=this.json,i=this.extensions,s=n.meshes[e],o=s.primitives,a=[];for(let e=0,t=o.length;e<t;e++){var l;let t=void 0===o[e].material?(void 0===(l=this.cache).DefaultMaterial&&(l.DefaultMaterial=new r._4j({color:0xffffff,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:r.hB5})),l.DefaultMaterial):this.getDependency("material",o[e].material);a.push(t)}return a.push(t.loadGeometries(o)),Promise.all(a).then(function(n){let a=n.slice(0,n.length-1),l=n[n.length-1],c=[];for(let n=0,u=l.length;n<u;n++){let u,h=l[n],f=o[n],p=a[n];if(f.mode===ea.TRIANGLES||f.mode===ea.TRIANGLE_STRIP||f.mode===ea.TRIANGLE_FAN||void 0===f.mode)!0===(u=!0===s.isSkinnedMesh?new r.I46(h,p):new r.eaF(h,p)).isSkinnedMesh&&u.normalizeSkinWeights(),f.mode===ea.TRIANGLE_STRIP?u.geometry=M(u.geometry,r.O49):f.mode===ea.TRIANGLE_FAN&&(u.geometry=M(u.geometry,r.rYR));else if(f.mode===ea.LINES)u=new r.DXC(h,p);else if(f.mode===ea.LINE_STRIP)u=new r.N1A(h,p);else if(f.mode===ea.LINE_LOOP)u=new r.FCc(h,p);else if(f.mode===ea.POINTS)u=new r.ONl(h,p);else throw Error("THREE.GLTFLoader: Primitive mode unsupported: "+f.mode);Object.keys(u.geometry.morphAttributes).length>0&&function(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let n=0,r=t.weights.length;n<r;n++)e.morphTargetInfluences[n]=t.weights[n];if(t.extras&&Array.isArray(t.extras.targetNames)){let n=t.extras.targetNames;if(e.morphTargetInfluences.length===n.length){e.morphTargetDictionary={};for(let t=0,r=n.length;t<r;t++)e.morphTargetDictionary[n[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}(u,s),u.name=t.createUniqueName(s.name||"mesh_"+e),ey(u,s),f.extensions&&em(i,u,f),t.assignFinalMaterial(u),c.push(u)}for(let n=0,r=c.length;n<r;n++)t.associations.set(c[n],{meshes:e,primitives:n});if(1===c.length)return s.extensions&&em(i,c[0],s),c[0];let u=new r.YJl;s.extensions&&em(i,u,s),t.associations.set(u,{meshes:e});for(let e=0,t=c.length;e<t;e++)u.add(c[e]);return u})}loadCamera(e){let t,n=this.json.cameras[e],i=n[n.type];return i?("perspective"===n.type?t=new r.ubm(r.cj9.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):"orthographic"===n.type&&(t=new r.qUd(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),n.name&&(t.name=this.createUniqueName(n.name)),ey(t,n),Promise.resolve(t)):void console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){let t=this.json.skins[e],n=[];for(let e=0,r=t.joints.length;e<r;e++)n.push(this._loadNodeShallow(t.joints[e]));return void 0!==t.inverseBindMatrices?n.push(this.getDependency("accessor",t.inverseBindMatrices)):n.push(null),Promise.all(n).then(function(e){let n=e.pop(),i=[],s=[];for(let o=0,a=e.length;o<a;o++){let a=e[o];if(a){i.push(a);let e=new r.kn4;null!==n&&e.fromArray(n.array,16*o),s.push(e)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[o])}return new r.EAD(i,s)})}loadAnimation(e){let t=this.json,n=this,i=t.animations[e],s=i.name?i.name:"animation_"+e,o=[],a=[],l=[],c=[],u=[];for(let e=0,t=i.channels.length;e<t;e++){let t=i.channels[e],n=i.samplers[t.sampler],r=t.target,s=r.node,h=void 0!==i.parameters?i.parameters[n.input]:n.input,f=void 0!==i.parameters?i.parameters[n.output]:n.output;void 0!==r.node&&(o.push(this.getDependency("node",s)),a.push(this.getDependency("accessor",h)),l.push(this.getDependency("accessor",f)),c.push(n),u.push(r))}return Promise.all([Promise.all(o),Promise.all(a),Promise.all(l),Promise.all(c),Promise.all(u)]).then(function(e){let t=e[0],o=e[1],a=e[2],l=e[3],c=e[4],u=[];for(let e=0,r=t.length;e<r;e++){let r=t[e],i=o[e],s=a[e],h=l[e],f=c[e];if(void 0===r)continue;r.updateMatrix&&r.updateMatrix();let p=n._createAnimationTracks(r,i,s,h,f);if(p)for(let e=0;e<p.length;e++)u.push(p[e])}let h=new r.tz3(s,void 0,u);return ey(h,i),h})}createNodeMesh(e){let t=this.json,n=this,r=t.nodes[e];return void 0===r.mesh?null:n.getDependency("mesh",r.mesh).then(function(e){let t=n._getNodeRef(n.meshCache,r.mesh,e);return void 0!==r.weights&&t.traverse(function(e){if(e.isMesh)for(let t=0,n=r.weights.length;t<n;t++)e.morphTargetInfluences[t]=r.weights[t]}),t})}loadNode(e){let t=this.json.nodes[e],n=this._loadNodeShallow(e),r=[],i=t.children||[];for(let e=0,t=i.length;e<t;e++)r.push(this.getDependency("node",i[e]));let s=void 0===t.skin?Promise.resolve(null):this.getDependency("skin",t.skin);return Promise.all([n,Promise.all(r),s]).then(function(e){let t=e[0],n=e[1],r=e[2];null!==r&&t.traverse(function(e){e.isSkinnedMesh&&e.bind(r,ew)});for(let e=0,r=n.length;e<r;e++)t.add(n[e]);return t})}_loadNodeShallow(e){let t=this.json,n=this.extensions,i=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];let s=t.nodes[e],o=s.name?i.createUniqueName(s.name):"",a=[],l=i._invokeOne(function(t){return t.createNodeMesh&&t.createNodeMesh(e)});return l&&a.push(l),void 0!==s.camera&&a.push(i.getDependency("camera",s.camera).then(function(e){return i._getNodeRef(i.cameraCache,s.camera,e)})),i._invokeAll(function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)}).forEach(function(e){a.push(e)}),this.nodeCache[e]=Promise.all(a).then(function(t){let a;if((a=!0===s.isBone?new r.$Kf:t.length>1?new r.YJl:1===t.length?t[0]:new r.B69)!==t[0])for(let e=0,n=t.length;e<n;e++)a.add(t[e]);if(s.name&&(a.userData.name=s.name,a.name=o),ey(a,s),s.extensions&&em(n,a,s),void 0!==s.matrix){let e=new r.kn4;e.fromArray(s.matrix),a.applyMatrix4(e)}else void 0!==s.translation&&a.position.fromArray(s.translation),void 0!==s.rotation&&a.quaternion.fromArray(s.rotation),void 0!==s.scale&&a.scale.fromArray(s.scale);if(i.associations.has(a)){if(void 0!==s.mesh&&i.meshCache.refs[s.mesh]>1){let e=i.associations.get(a);i.associations.set(a,{...e})}}else i.associations.set(a,{});return i.associations.get(a).nodes=e,a}),this.nodeCache[e]}loadScene(e){let t=this.extensions,n=this.json.scenes[e],i=this,s=new r.YJl;n.name&&(s.name=i.createUniqueName(n.name)),ey(s,n),n.extensions&&em(t,s,n);let o=n.nodes||[],a=[];for(let e=0,t=o.length;e<t;e++)a.push(i.getDependency("node",o[e]));return Promise.all(a).then(function(e){for(let t=0,n=e.length;t<n;t++)s.add(e[t]);return i.associations=(e=>{let t=new Map;for(let[e,n]of i.associations)(e instanceof r.imn||e instanceof r.gPd)&&t.set(e,n);return e.traverse(e=>{let n=i.associations.get(e);null!=n&&t.set(e,n)}),t})(s),s})}_createAnimationTracks(e,t,n,i,s){let o,a=[],l=e.name?e.name:e.uuid,c=[];switch(ep[s.path]===ep.weights?e.traverse(function(e){e.morphTargetInfluences&&c.push(e.name?e.name:e.uuid)}):c.push(l),ep[s.path]){case ep.weights:o=r.Hit;break;case ep.rotation:o=r.MBL;break;case ep.translation:case ep.scale:o=r.RiT;break;default:o=1===n.itemSize?r.Hit:r.RiT}let u=void 0!==i.interpolation?ed[i.interpolation]:r.PJ3,h=this._getArrayFromAccessor(n);for(let e=0,n=c.length;e<n;e++){let n=new o(c[e]+"."+ep[s.path],t.array,h,u);"CUBICSPLINE"===i.interpolation&&this._createCubicSplineTrackInterpolant(n),a.push(n)}return a}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){let e=eg(t.constructor),n=new Float32Array(t.length);for(let r=0,i=t.length;r<i;r++)n[r]=t[r]*e;t=n}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof r.MBL?eo:ei)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function ex(e,t,n){let i=t.attributes,s=[];for(let t in i){let r=ef[t]||t.toLowerCase();r in e.attributes||s.push(function(t,r){return n.getDependency("accessor",t).then(function(t){e.setAttribute(r,t)})}(i[t],r))}if(void 0!==t.indices&&!e.index){let r=n.getDependency("accessor",t.indices).then(function(t){e.setIndex(t)});s.push(r)}return r.ppV.workingColorSpace!==r.Zr2&&"COLOR_0"in i&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${r.ppV.workingColorSpace}" not supported.`),ey(e,t),!function(e,t,n){let i=t.attributes,s=new r.NRn;if(void 0===i.POSITION)return;{let e=n.json.accessors[i.POSITION],t=e.min,o=e.max;if(void 0===t||void 0===o)return console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(s.set(new r.Pq0(t[0],t[1],t[2]),new r.Pq0(o[0],o[1],o[2])),e.normalized){let t=eg(el[e.componentType]);s.min.multiplyScalar(t),s.max.multiplyScalar(t)}}let o=t.targets;if(void 0!==o){let e=new r.Pq0,t=new r.Pq0;for(let r=0,i=o.length;r<i;r++){let i=o[r];if(void 0!==i.POSITION){let r=n.json.accessors[i.POSITION],s=r.min,o=r.max;if(void 0!==s&&void 0!==o){if(t.setX(Math.max(Math.abs(s[0]),Math.abs(o[0]))),t.setY(Math.max(Math.abs(s[1]),Math.abs(o[1]))),t.setZ(Math.max(Math.abs(s[2]),Math.abs(o[2]))),r.normalized){let e=eg(el[r.componentType]);t.multiplyScalar(e)}e.max(t)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}s.expandByVector(e)}e.boundingBox=s;let a=new r.iyt;s.getCenter(a.center),a.radius=s.min.distanceTo(s.max)/2,e.boundingSphere=a}(e,t,n),Promise.all(s).then(function(){return void 0!==t.targets?function(e,t,n){let r=!1,i=!1,s=!1;for(let e=0,n=t.length;e<n;e++){let n=t[e];if(void 0!==n.POSITION&&(r=!0),void 0!==n.NORMAL&&(i=!0),void 0!==n.COLOR_0&&(s=!0),r&&i&&s)break}if(!r&&!i&&!s)return Promise.resolve(e);let o=[],a=[],l=[];for(let c=0,u=t.length;c<u;c++){let u=t[c];if(r){let t=void 0!==u.POSITION?n.getDependency("accessor",u.POSITION):e.attributes.position;o.push(t)}if(i){let t=void 0!==u.NORMAL?n.getDependency("accessor",u.NORMAL):e.attributes.normal;a.push(t)}if(s){let t=void 0!==u.COLOR_0?n.getDependency("accessor",u.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(o),Promise.all(a),Promise.all(l)]).then(function(t){let n=t[0],o=t[1],a=t[2];return r&&(e.morphAttributes.position=n),i&&(e.morphAttributes.normal=o),s&&(e.morphAttributes.color=a),e.morphTargetsRelative=!0,e})}(e,t.targets,n):e})}var eT=n("./src/model/physics/constants.ts"),eP=console.error;function eR(e){new s().parse(e,function(e){var t,n,r;console.log(e),t=e,n="scene.gltf",(r=document.createElement("a")).setAttribute("href","data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(t))),r.setAttribute("download",n),document.body.appendChild(r),r.click(),r.remove()},eP)}function eS(e,t){new _().load(e,function(n){n.scene.scale.set(eT.R/.5,eT.R/.5,eT.R/.5),n.scene.matrixAutoUpdate=!1,n.scene.updateMatrix(),n.scene.updateMatrixWorld(),n.scene.name=e,t(n)},function(t){return console.log(e+" "+t.loaded+" bytes loaded")},eP)}},"./src/utils/rack.ts":(e,t,n)=>{n.d(t,{m:()=>c});var r=n("./src/model/ball.ts"),i=n("./src/view/tablegeometry.ts"),s=n("./node_modules/three/build/three.core.js"),o=n("./src/utils/utils.ts"),a=n("./src/model/physics/constants.ts");function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var c=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"jitter",value:function(e){return(0,o.ld)(e.clone().add(new s.Pq0(t.noise*(Math.random()-.5),t.noise*(Math.random()-.5),0)))}},{key:"cueBall",value:function(e){return new r.c(t.jitter(e),0xfaebd7)}},{key:"diamond",value:function(){var e=new s.Pq0(i.P.tableX/2,0,0),n=[];return n.push(t.cueBall(t.spot)),n.push(new r.c(t.jitter(e),0xe0de36)),e.add(t.diagonal),n.push(new r.c(t.jitter(e),0xff9d00)),e.sub(t.across),n.push(new r.c(t.jitter(e),5380369)),e.add(t.diagonal),n.push(new r.c(t.jitter(e),5853696)),e.sub(t.across),n.push(new r.c(t.jitter(e),0xff0000)),e.addScaledVector(t.across,2),n.push(new r.c(t.jitter(e),328965)),e.add(t.diagonal).sub(t.across),n.push(new r.c(t.jitter(e),685250)),e.sub(t.across),n.push(new r.c(t.jitter(e),553728)),e.add(t.diagonal),n.push(new r.c(t.jitter(e),4063388)),n}},{key:"triangle",value:function(){var e=t.trianglePositions(),n=t.cueBall(t.spot),i=e.map(function(e){return new r.c(t.jitter(e))});return i.unshift(n),i.slice(0,5)}},{key:"trianglePositions",value:function(){var e=[],t=new s.Pq0(i.P.X/2,0,0);return e.push((0,o.t6)(t)),t.add(this.diagonal),e.push((0,o.t6)(t)),t.sub(this.across),e.push((0,o.t6)(t)),t.add(this.diagonal),e.push((0,o.t6)(t)),t.sub(this.across),e.push((0,o.t6)(t)),t.addScaledVector(this.across,2),e.push((0,o.t6)(t)),t.add(this.diagonal),e.push((0,o.t6)(t)),t.sub(this.across),e.push((0,o.t6)(t)),t.sub(this.across),e.push((0,o.t6)(t)),t.sub(this.across),e.push((0,o.t6)(t)),t.add(this.diagonal).sub(this.across),e.push((0,o.t6)(t)),t.add(this.across),e.push((0,o.t6)(t)),t.add(this.across),e.push((0,o.t6)(t)),t.add(this.across),e.push((0,o.t6)(t)),t.add(this.across),e.push((0,o.t6)(t)),e}},{key:"rerack",value:function(e,n){var i=t.trianglePositions(),s=i.shift();n.balls.filter(function(e){return e!==n.cueball}).filter(function(t){return t!==e}).forEach(function(e){e.pos.copy(t.jitter(i.shift())),e.state=r.U.Stationary}),n.overlapsAny(e.pos,e)&&e.pos.copy(s),n.overlapsAny(n.cueball.pos)&&n.cueball.pos.copy(t.spot)}},{key:"three",value:function(){var e=[],n=i.P.X/2,o=i.P.Y/4;return e.push(t.cueBall(t.jitter(new s.Pq0(-n,-o,0)))),e.push(new r.c(t.jitter(new s.Pq0(-n,0,0)),0xe0de36)),e.push(new r.c(t.jitter(new s.Pq0(n,0,0)),0xff0000)),e}},{key:"snooker",value:function(){var e=[],n=i.P.Y/4;e.push(t.cueBall(t.jitter(new s.Pq0(t.baulk,-(.5*n),0))));var o=t.snookerColourPositions();return e.push(new r.c(t.jitter(o[0]),0xeede36)),e.push(new r.c(t.jitter(o[1]),824932)),e.push(new r.c(t.jitter(o[2]),0xbd723a)),e.push(new r.c(t.jitter(o[3]),558062)),e.push(new r.c(t.jitter(o[4]),0xffaacc)),e.push(new r.c(t.jitter(o[5]),65793)),t.trianglePositions().slice(0,15).forEach(function(n){e.push(new r.c(t.jitter(n.add(t.down)),0xee0000))}),e}},{key:"snookerColourPositions",value:function(){var e=i.P.X/2,n=i.P.X-2*i.P.X/11,r=[];return r.push(new s.Pq0(t.baulk,-t.sixth,0)),r.push(new s.Pq0(t.baulk,t.sixth,0)),r.push(new s.Pq0(t.baulk,0,0)),r.push(new s.Pq0(0,0,0)),r.push(new s.Pq0(e,0,0)),r.push(new s.Pq0(n,0,0)),r}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();l(c,"noise",.0233*a.R),l(c,"gap",2*a.R+2*c.noise),l(c,"up",new s.Pq0(0,0,-1)),l(c,"spot",new s.Pq0(-i.P.X/2,0,0)),l(c,"across",new s.Pq0(0,c.gap,0)),l(c,"down",new s.Pq0(c.gap,0,0)),l(c,"diagonal",c.across.clone().applyAxisAngle(c.up,Math.PI/3)),l(c,"sixth",2*i.P.Y/6),l(c,"baulk",-1.5*i.P.X*2/5)},"./src/utils/respot.ts":(e,t,n)=>{n.d(t,{k:()=>a});var r=n("./src/model/ball.ts"),i=n("./src/view/tablegeometry.ts"),s=n("./src/model/physics/constants.ts"),o=n("./src/utils/rack.ts"),a=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"respot",value:function(e,n){var i=o.m.snookerColourPositions();return i.push(i[e.id-1]),i.reverse(),i.some(function(t){return!n.overlapsAny(t,e)&&(e.pos.copy(t),e.state=r.U.Stationary,!0)})||t.respotBehind(i[0],e,n),e}},{key:"respotBehind",value:function(e,t,n){for(var o=e.clone();o.x<i.P.tableX&&n.overlapsAny(o,t);)o.x+=s.R/8;for(;o.x>-i.P.tableX&&n.overlapsAny(o,t);)o.x-=s.R/8;t.pos.copy(o),t.state=r.U.Stationary}},{key:"closest",value:function(e,t){var n=t.filter(function(e){return e.onTable()}).filter(function(t){return t!==e});if(0!==n.length){var r=function(t){return e.pos.distanceTo(t.pos)};return n.reduce(function(e,t){return r(e)<r(t)?e:t},n[0])}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}()},"./src/utils/utils.ts":(e,t,n)=>{n.d(t,{Dz:()=>p,F8:()=>b,FP:()=>m,KM:()=>l,RZ:()=>w,gn:()=>g,ld:()=>v,n7:()=>y,oN:()=>k,rq:()=>f,t6:()=>o,up:()=>s,v_:()=>i,xb:()=>u});var r=n("./node_modules/three/build/three.core.js"),i=new r.Pq0(0,0,0),s=new r.Pq0(0,0,1);function o(e){return new r.Pq0(e.x,e.y,e.z)}var a=new r.Pq0;function l(e){return a.copy(s).cross(e)}var c=new r.Pq0;function u(e){return c.copy(e).normalize()}var h=new r.Pq0;function f(e,t){return 0>=h.copy(e).add(t).dot(e)}function p(e){return new r.Pq0(1,0,0).applyAxisAngle(s,e)}function d(e){return Math.sign(e)*Math.floor((Math.abs(e)+Number.EPSILON)*1e4)/1e4}function v(e){return e.x=d(e.x),e.y=d(e.y),e.z=d(e.z),e}function m(e,t){return Math.fround(Math.atan2(e,t))}function y(e,t){return Math.fround(Math.pow(e,t))}function b(e){return Math.fround(Math.sin(e))}function g(e){return Math.fround(Math.cos(e))}function w(e){return Math.fround(Math.sqrt(e))}function k(e){return Math.fround(Math.exp(e))}},"./src/view/assets.ts":(e,t,n)=>{n.d(t,{s:()=>m});var r=n("./src/controller/rules/rulefactory.ts"),i=n("./src/utils/gltf.ts"),s=n("./node_modules/three/build/three.core.js");function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e;function t(e){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");o(this,"listener",void 0),o(this,"audioLoader",void 0),o(this,"ballcollision",void 0),o(this,"cue",void 0),o(this,"cushion",void 0),o(this,"pot",void 0),o(this,"success",void 0),o(this,"lastOutcomeTime",0),o(this,"loadAssets",void 0),this.loadAssets=e,e&&(this.listener=new s.Pf$,this.audioLoader=new s.Am1,this.ballcollision=new s.fP5(this.listener),this.load("sounds/ballcollision.ogg",this.ballcollision),this.cue=new s.fP5(this.listener),this.load("sounds/cue.ogg",this.cue),this.cushion=new s.fP5(this.listener),this.load("sounds/cushion.ogg",this.cushion),this.pot=new s.fP5(this.listener),this.load("sounds/pot.ogg",this.pot),this.success=new s.fP5(this.listener),this.load("sounds/success.ogg",this.success))}return e=[{key:"addCameraToListener",value:function(e){e.add(this.listener)}},{key:"load",value:function(e,t){this.audioLoader.load(e,function(e){t.setBuffer(e),t.setLoop(!1)},function(e){},function(e){})}},{key:"play",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(this.loadAssets){var r,i,o=s.UtX.getContext();if((null==o?void 0:o.state)==="suspended"){(null==(i=navigator)||null==(r=i.userActivation)?void 0:r.hasBeenActive)&&o.resume();return}e.setVolume(t),e.isPlaying&&e.stop(),e.play(s.cj9.randFloat(0,.01)),e.setDetune(n)}}},{key:"outcomeToSound",value:function(e){"Collision"===e.type&&this.play(this.ballcollision,e.incidentSpeed/80,5*e.incidentSpeed),"Pot"===e.type&&this.play(this.pot,e.incidentSpeed/10,-1e3+10*e.incidentSpeed),"Cushion"===e.type&&this.play(this.cushion,e.incidentSpeed/70),"Hit"===e.type&&this.play(this.cue,e.incidentSpeed/30)}},{key:"processOutcomes",value:function(e){var t=this;e.every(function(e){return!(e.timestamp>t.lastOutcomeTime)||(t.lastOutcomeTime=e.timestamp,t.outcomeToSound(e),!1)})}},{key:"playNotify",value:function(){this.play(this.pot,1)}},{key:"playSuccess",value:function(e){this.play(this.success,.1,100*e-2200)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}(),l=n("./src/view/tablegeometry.ts"),c=n("./src/view/pocketgeometry.ts"),u=n("./src/model/physics/constants.ts");function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var f=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");h(this,"logger",function(e){}),h(this,"cloth",new s.tXL({color:4478393,wireframe:!1,flatShading:!0,transparent:!1})),h(this,"cushion",new s.tXL({color:5531065,wireframe:!1,flatShading:!0,transparent:!1})),h(this,"pocket",new s.tXL({color:4478361,wireframe:!1,flatShading:!0,transparent:!0,opacity:.3}))}return e=[{key:"generateTable",value:function(e){var t=this,n=new s.YJl,r=new s.HiM(0xf0f0e8,22);if(r.position.set(0,0,50*u.R),n.add(r),this.addCushions(n,e),e){c.f.knuckles.forEach(function(e){return t.knuckleCylinder(e,n)}),c.f.pocketCenters.forEach(function(e){return t.knuckleCylinder(e,n,t.pocket)});var i=c.f.pockets.pocketNW.pocket,o=c.f.pockets.pocketNW.knuckleNE;this.logger("knuckle-pocket gap = "+(i.pos.distanceTo(o.pos)-i.radius-o.radius))}return n}},{key:"knuckleCylinder",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.cloth;this.cylinder(e.pos,e.radius,.75*u.R/.5,t,n).position.setZ(-(.25*u.R)/.5/2)}},{key:"cylinder",value:function(e,t,n,r,i){var o=new s.Ho_(t,t,n,16),a=new s.eaF(o,i);return a.position.copy(e),a.geometry.applyMatrix4(new s.kn4().identity().makeRotationAxis(new s.Pq0(1,0,0),Math.PI/2)),r.add(a),a}},{key:"addCushions",value:function(e,t){var n=10*u.R/.5;this.plane(new s.Pq0(0,0,-u.R-n/2),2*l.P.X,2*l.P.Y,n,e,this.cloth);var r=u.R/.5,i=.75*u.R/.5,o=-(.25*u.R)/.5/2,a=l.P.X,h=l.P.Y,f=Math.abs(c.f.pockets.pocketNW.knuckleNE.pos.x-c.f.pockets.pocketN.knuckleNW.pos.x),p=Math.abs(c.f.pockets.pocketNW.knuckleSW.pos.y-c.f.pockets.pocketSW.knuckleNW.pos.y);t||(f=2*l.P.Y,p=2*l.P.Y+4*u.R),this.plane(new s.Pq0(a+r/2,0,o),r,p,i,e),this.plane(new s.Pq0(-a-r/2,0,o),r,p,i,e),this.plane(new s.Pq0(-a/2,h+r/2,o),f,r,i,e),this.plane(new s.Pq0(-a/2,-h-r/2,o),f,r,i,e),this.plane(new s.Pq0(a/2,h+r/2,o),f,r,i,e),this.plane(new s.Pq0(a/2,-h-r/2,o),f,r,i,e)}},{key:"plane",value:function(e,t,n,r,i){var o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:this.cushion,a=new s.iNn(t,n,r),l=new s.eaF(a,o);l.receiveShadow=!0,l.position.copy(e),i.add(l)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}();h(f,"mesh",void 0);var p=n("./src/view/cuemesh.ts");function d(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function v(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var m=function(){var e,t;function n(e){if(!(this instanceof n))throw TypeError("Cannot call a class as a function");v(this,"ready",void 0),v(this,"rules",void 0),v(this,"background",void 0),v(this,"table",void 0),v(this,"cue",void 0),v(this,"sound",void 0),this.rules=r.V.create(e,null),this.rules.tableGeometry()}return e=[{key:"loadFromWeb",value:function(e){var t=this;this.ready=e,this.sound=new a(!0),(0,i.Ro)("models/background.gltf",function(e){t.background=e.scene,t.done()}),(0,i.Ro)(this.rules.asset(),function(e){t.table=e.scene,f.mesh=e.scene.children[0],t.done()}),(0,i.Ro)("models/cue.gltf",function(e){t.cue=e,p.l.mesh=e.scene.children[0],t.done()})}},{key:"creatLocal",value:function(){this.sound=new a(!1),f.mesh=new f().generateTable(l.P.hasPockets),this.table=f.mesh}},{key:"done",value:function(){this.background&&this.table&&this.cue&&this.ready()}}],t=[{key:"localAssets",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=new n(e);return t.creatLocal(),t}}],e&&d(n.prototype,e),t&&d(n,t),n}()},"./src/view/cameratop.ts":(e,t,n)=>{n.d(t,{v:()=>a});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/view/tablegeometry.ts"),s=n("./src/model/physics/constants.ts");function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"viewPoint",value:function(e,n){var o=t.zoomFactor/(2*Math.tan(n*Math.PI/360));if(e>this.portrait){var a=e>t.aspectLimit?2.75*i.P.tableY:2.4*i.P.tableX/e;return new r.Pq0(0,-.01*s.R,o*a)}var l=e>1/t.aspectLimit?4.9*i.P.tableY:1.35*i.P.tableX/e;return new r.Pq0(-.01*s.R,0,o*l)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();o(a,"aspectLimit",1.78),o(a,"portrait",.95),o(a,"fov",20),o(a,"zoomFactor",1)},"./src/view/cue.ts":(e,t,n)=>{n.d(t,{s:()=>f});var r=n("./src/view/tablegeometry.ts"),i=n("./src/utils/utils.ts"),s=n("./src/events/aimevent.ts"),o=n("./src/model/ball.ts"),a=n("./src/model/physics/physics.ts"),l=n("./src/view/cuemesh.ts"),c=n("./node_modules/three/build/three.core.js"),u=n("./src/model/physics/constants.ts");function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var f=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function");h(this,"mesh",void 0),h(this,"helperMesh",void 0),h(this,"placerMesh",void 0),h(this,"offCenterLimit",.3),h(this,"maxPower",160*u.R),h(this,"t",0),h(this,"aimInputs",void 0),h(this,"aim",new s.w),h(this,"length",+r.P.tableX),this.mesh=l.l.createCue(.05*u.R/.5,.15*u.R/.5,this.length),this.helperMesh=l.l.createHelper(),this.placerMesh=l.l.createPlacer()}return e=[{key:"rotateAim",value:function(e,t){this.aim.angle=this.aim.angle+e,this.mesh.rotation.z=this.aim.angle,this.helperMesh.rotation.z=this.aim.angle,this.aimInputs.showOverlap(),this.avoidCueTouchingOtherBall(t)}},{key:"adjustPower",value:function(e){this.aim.power=Math.min(this.maxPower,this.aim.power+e),this.updateAimInput()}},{key:"setPower",value:function(e){this.aim.power=e*this.maxPower}},{key:"hit",value:function(e){var t=this.aim;this.t=0,e.state=o.U.Sliding,e.vel.copy((0,i.Dz)(t.angle).multiplyScalar(t.power)),e.rvel.copy((0,a.t6)(t.offset,e.vel))}},{key:"aimAtNext",value:function(e,t){if(t){var n=(0,i.xb)(t.pos.clone().sub(e.pos));this.aim.angle=(0,i.FP)(n.y,n.x)}}},{key:"adjustSpin",value:function(e,t){var n=this.aim.offset.clone().clone().add(e);this.setSpin(n,t)}},{key:"setSpin",value:function(e,t){e.length()>this.offCenterLimit&&e.normalize().multiplyScalar(this.offCenterLimit),this.aim.offset.copy(e),this.avoidCueTouchingOtherBall(t),this.updateAimInput()}},{key:"avoidCueTouchingOtherBall",value:function(e){for(var t=0;t++<20&&this.intersectsAnything(e);)this.aim.offset.y+=.1,this.aim.offset.length()>this.offCenterLimit&&this.aim.offset.normalize().multiplyScalar(this.offCenterLimit);t>1&&this.updateAimInput()}},{key:"updateAimInput",value:function(){var e,t,n;null==(e=this.aimInputs)||e.updateVisualState(this.aim.offset.x,this.aim.offset.y),null==(t=this.aimInputs)||t.updatePowerSlider(this.aim.power/this.maxPower),null==(n=this.aimInputs)||n.showOverlap()}},{key:"moveTo",value:function(e){this.aim.pos.copy(e),this.mesh.rotation.z=this.aim.angle,this.helperMesh.rotation.z=this.aim.angle;var t=this.spinOffset(),n=((0,i.F8)(this.t+Math.PI/2)-1)*2*u.R*(this.aim.power/this.maxPower),r=(0,i.Dz)(this.aim.angle).clone().multiplyScalar(n);this.mesh.position.copy(e.clone().add(t).add(r)),this.helperMesh.position.copy(e),this.placerMesh.position.copy(e),this.placerMesh.rotation.z=this.t}},{key:"update",value:function(e){this.t+=e,this.moveTo(this.aim.pos)}},{key:"placeBallMode",value:function(){this.mesh.visible=!1,this.placerMesh.visible=!0,this.aim.angle=0}},{key:"aimMode",value:function(){this.mesh.visible=!0,this.placerMesh.visible=!1}},{key:"spinOffset",value:function(){return(0,i.KM)((0,i.Dz)(this.aim.angle)).multiplyScalar(2*this.aim.offset.x*u.R).setZ(2*this.aim.offset.y*u.R)}},{key:"intersectsAnything",value:function(e){var t=this.spinOffset(),n=e.cueball.pos.clone().add(t),r=(0,i.xb)((0,i.Dz)(this.aim.angle+Math.PI).setZ(.1)),s=new c.tBo(n,r),o=e.balls.map(function(e){return e.ballmesh.mesh});return e.mesh&&o.push(e.mesh),s.intersectObjects(o,!0).length>0}},{key:"showHelper",value:function(e){this.helperMesh.visible=e}},{key:"toggleHelper",value:function(){this.showHelper(!this.helperMesh.visible)}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/view/cuemesh.ts":(e,t,n)=>{n.d(t,{l:()=>a});var r=n("./src/model/physics/constants.ts"),i=n("./src/utils/utils.ts"),s=n("./node_modules/three/build/three.core.js");function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"indicateValid",value:function(e){t.placermaterial.color.setHex(e?0xccffcc:0xff0000)}},{key:"createHelper",value:function(){var e=new s.Ho_(r.R,r.R,30*r.R/.5,12,1,!0),t=new s.eaF(e,this.helpermaterial);return t.geometry.applyMatrix4(new s.kn4().identity().makeRotationAxis(i.up,-Math.PI/2)).applyMatrix4(new s.kn4().identity().makeTranslation(15*r.R/.5,0,-(.01*r.R)/.5)),t.visible=!1,t.renderOrder=-1,t.material.depthTest=!1,t}},{key:"createPlacer",value:function(){var e=new s.Ho_(.01*r.R/.5,r.R,r.R,4),n=new s.eaF(e,t.placermaterial);return n.geometry.applyMatrix4(new s.kn4().identity().makeRotationAxis(new s.Pq0(1,0,0),-Math.PI/2)).applyMatrix4(new s.kn4().identity().makeTranslation(0,0,.7*r.R/.5)),n.visible=!1,n}},{key:"createCue",value:function(e,n,o){var a=new s.Ho_(e,n,o,11),l=new s.eaF(a,t.material);return l.castShadow=!1,l.geometry.applyMatrix4(new s.kn4().identity().makeRotationAxis(new s.Pq0(1,0,0),-.17)).applyMatrix4(new s.kn4().identity().makeRotationAxis(i.up,-Math.PI/2)).applyMatrix4(new s.kn4().identity().makeTranslation(-o/2-r.R,0,o/2*.16918234906699603+.25*r.R)),l}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();o(a,"mesh",void 0),o(a,"material",new s.tXL({color:8934775,wireframe:!1,flatShading:!1})),o(a,"placermaterial",new s.tXL({color:0xccffcc,wireframe:!1,flatShading:!1,transparent:!0,opacity:.5})),o(a,"helpermaterial",new s.BKk({uniforms:{lightDirection:{value:new s.Pq0(0,0,1)}},vertexShader:`
      varying vec2 vUv;
      varying vec3 vNormal;  
      void main() {
        vNormal = normal;
        vUv = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
      }
    `,fragmentShader:`
      varying vec2 vUv;
      varying vec3 vNormal;
      uniform vec3 lightDirection;
      void main() {
        float intensity = dot(vNormal, lightDirection);
        vec3 color = vec3(1.0, 1.0, 1.0);
        vec3 finalColor = color * intensity;
        gl_FragColor = vec4(finalColor, 0.05 * (1.0-vUv.y));
      }
    `,wireframe:!1,transparent:!0}))},"./src/view/pocketgeometry.ts":(e,t,n)=>{n.d(t,{f:()=>c});var r=n("./node_modules/three/build/three.core.js"),i=n("./src/model/physics/knuckle.ts"),s=n("./src/model/physics/pocket.ts"),o=n("./src/view/tablegeometry.ts"),a=n("./src/model/physics/constants.ts");function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var c=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"scaleToRadius",value:function(e){t.PX=o.P.tableX+1.6*e,t.PY=o.P.tableY+1.6*e,t.knuckleInset=1.6*e/.5,t.knuckleRadius=.31*e/.5,t.middleKnuckleInset=1.385*e/.5,t.middleKnuckleRadius=.2*e/.5,t.cornerRadius=1.1*e/.5,t.middleRadius=.9*e/.5,t.pocketLayout(e),t.enumerateCenters(),t.enumerateKnuckles()}},{key:"enumerateKnuckles",value:function(){t.knuckles=[t.pockets.pocketNW.knuckleNE,t.pockets.pocketNW.knuckleSW,t.pockets.pocketN.knuckleNW,t.pockets.pocketN.knuckleNE,t.pockets.pocketS.knuckleSW,t.pockets.pocketS.knuckleSE,t.pockets.pocketNE.knuckleNW,t.pockets.pocketNE.knuckleSE,t.pockets.pocketSE.knuckleNE,t.pockets.pocketSE.knuckleSW,t.pockets.pocketSW.knuckleSE,t.pockets.pocketSW.knuckleNW]}},{key:"enumerateCenters",value:function(){t.pocketCenters=[t.pockets.pocketNW.pocket,t.pockets.pocketSW.pocket,t.pockets.pocketN.pocket,t.pockets.pocketS.pocket,t.pockets.pocketNE.pocket,t.pockets.pocketSE.pocket]}},{key:"pocketLayout",value:function(e){t.pockets={pocketNW:{pocket:new s.Z(new r.Pq0(-t.PX,t.PY,0),t.cornerRadius),knuckleNE:new i.O(new r.Pq0(-o.P.X+t.knuckleInset,o.P.Y+t.knuckleRadius,0),t.knuckleRadius),knuckleSW:new i.O(new r.Pq0(-o.P.X-t.knuckleRadius,o.P.Y-t.knuckleInset,0),t.knuckleRadius)},pocketN:{pocket:new s.Z(new r.Pq0(0,t.PY+.7*e/.5,0),t.middleRadius),knuckleNE:new i.O(new r.Pq0(t.middleKnuckleInset,o.P.Y+t.middleKnuckleRadius,0),t.middleKnuckleRadius),knuckleNW:new i.O(new r.Pq0(-t.middleKnuckleInset,o.P.Y+t.middleKnuckleRadius,0),t.middleKnuckleRadius)},pocketS:{pocket:new s.Z(new r.Pq0(0,-t.PY-.7*e/.5,0),t.middleRadius),knuckleSE:new i.O(new r.Pq0(t.middleKnuckleInset,-o.P.Y-t.middleKnuckleRadius,0),t.middleKnuckleRadius),knuckleSW:new i.O(new r.Pq0(-t.middleKnuckleInset,-o.P.Y-t.middleKnuckleRadius,0),t.middleKnuckleRadius)},pocketNE:{pocket:new s.Z(new r.Pq0(t.PX,t.PY,0),t.cornerRadius),knuckleNW:new i.O(new r.Pq0(o.P.X-t.knuckleInset,o.P.Y+t.knuckleRadius,0),t.knuckleRadius),knuckleSE:new i.O(new r.Pq0(o.P.X+t.knuckleRadius,o.P.Y-t.knuckleInset,0),t.knuckleRadius)},pocketSE:{pocket:new s.Z(new r.Pq0(t.PX,-t.PY,0),t.cornerRadius),knuckleNE:new i.O(new r.Pq0(o.P.X+t.knuckleRadius,-o.P.Y+t.knuckleInset,0),t.knuckleRadius),knuckleSW:new i.O(new r.Pq0(o.P.X-t.knuckleInset,-o.P.Y-t.knuckleRadius,0),t.knuckleRadius)},pocketSW:{pocket:new s.Z(new r.Pq0(-t.PX,-t.PY,0),t.cornerRadius),knuckleSE:new i.O(new r.Pq0(-o.P.X+t.knuckleInset,-o.P.Y-t.knuckleRadius,0),t.knuckleRadius),knuckleNW:new i.O(new r.Pq0(-o.P.X-t.knuckleRadius,-o.P.Y+t.knuckleInset,0),t.knuckleRadius)}}}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();l(c,"PX",void 0),l(c,"PY",void 0),l(c,"knuckleInset",void 0),l(c,"knuckleRadius",void 0),l(c,"middleKnuckleInset",void 0),l(c,"middleKnuckleRadius",void 0),l(c,"cornerRadius",void 0),l(c,"middleRadius",void 0),l(c,"pockets",void 0),l(c,"knuckles",void 0),l(c,"pocketCenters",void 0),c.scaleToRadius(a.R)},"./src/view/sliders.ts":(e,t,n)=>{n.d(t,{r:()=>s});var r=n("./src/model/physics/constants.ts");function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var s=function(){var e;function t(e){var n,s;if(!(this instanceof t))throw TypeError("Cannot call a class as a function");i(this,"style",void 0),i(this,"notify",void 0),this.notify=null!=e?e:function(){},this.style=null!=(s=null==(n=document.getElementById("constants"))?void 0:n.style)?s:{},this.initialiseSlider("R",r.R,r.jG),this.initialiseSlider("m",r.m,r.Qg),this.initialiseSlider("e",r.e,r.cM),this.initialiseSlider("mu",r.mu,r.xO),this.initialiseSlider("muS",r.gf,r.Ys),this.initialiseSlider("muC",r.gT,r.kM),this.initialiseSlider("rho",r.kL,r.Wv),this.initialiseSlider("μs",r.oV,r.ko),this.initialiseSlider("μw",r._m,r.ki),this.initialiseSlider("ee",r.ee,r.PX)}return e=[{key:"toggleVisibility",value:function(){this.style.visibility="visible"===this.style.visibility?"hidden":"visible"}},{key:"getInputElement",value:function(e){var t;return null!=(t=document.getElementById(e))?t:{}}},{key:"initialiseSlider",value:function(e,t,n){var r=this,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,s=this.getInputElement(e);s&&(s.step="0.001",s.min="0.01",s.max="".concat(i),s.value=t,this.showValue(e,t),s.oninput=function(t){var i=parseFloat(t.target.value);n(i),r.showValue(e,i),r.notify()})}},{key:"showValue",value:function(e,t){var n=document.querySelector("label[for=".concat(e,"]"));n&&(n.innerHTML="".concat(e,"=").concat(t))}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t.prototype,e),t}()},"./src/view/tablegeometry.ts":(e,t,n)=>{n.d(t,{P:()=>s});var r=n("./src/model/physics/constants.ts");function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var s=function(){var e;function t(){if(!(this instanceof t))throw TypeError("Cannot call a class as a function")}return e=[{key:"scaleToRadius",value:function(e){t.tableX=43*e,t.tableY=21*e,t.X=t.tableX+e,t.Y=t.tableY+e}}],function(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(t,e),t}();i(s,"tableX",void 0),i(s,"tableY",void 0),i(s,"X",void 0),i(s,"Y",void 0),i(s,"hasPockets",!0),s.scaleToRadius(r.R)}},e=>{e(e.s="./src/diagrams.ts")}]);