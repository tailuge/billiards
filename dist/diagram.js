"use strict";(self.webpackChunkbilliards=self.webpackChunkbilliards||[]).push([[465],{"./src/container/container.ts":(e,t,n)=>{let i,r,o,s;n.d(t,{W:()=>ng});var a,l=n("./src/events/gameevent.ts"),c=n("./src/events/eventtype.ts");function u(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var p=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}(r,e);var t,n,i=(t=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,n,i=h(r);if(t){var o=h(this).constructor;n=Reflect.construct(i,arguments,o)}else n=i.apply(this,arguments);return(e=n)&&("object"==(e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e)||"function"==typeof e)?e:function(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this)});function r(){var e;return!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,r),(e=i.call(this)).type=c.t.STATIONARY,e}return u(r.prototype,[{key:"applyToController",value:function(e){return e.handleStationary(this)}}]),n&&u(r,n),r}(l.Z),d=n("./node_modules/three/build/three.module.js"),m=n("./src/utils/utils.ts"),v=n("./src/view/cameratop.ts"),y=n("./src/model/physics/constants.ts");function b(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function g(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var w=function(){var e,t;function n(e){!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,n),g(this,"camera",void 0),g(this,"mode",this.topView),g(this,"mainMode",this.aimView),g(this,"height",8*y.R),g(this,"elapsed",void 0),this.camera=new d.cPb(45,e,y.R,1e3*y.R)}return e=[{key:"update",value:function(e,t){this.elapsed=e,this.mode(t)}},{key:"topView",value:function(e){this.camera.fov=v.c.fov,this.camera.position.lerp(v.c.viewPoint(this.camera.aspect,this.camera.fov),.9),this.camera.up=m.up,this.camera.lookAt(m.bM)}},{key:"aimView",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.08;this.camera.fov=this.camera.aspect<.8?60:40,this.camera.position.lerp(e.pos.clone().addScaledVector((0,m.AA)(e.angle),-(18*y.R)),t),this.camera.position.z=this.height,this.camera.up=m.up,this.camera.lookAt(e.pos.clone().addScaledVector(m.up,2*y.R))}},{key:"adjustHeight",value:function(e){this.height=d.M8C.clamp(this.height+e,1,6)}},{key:"suggestMode",value:function(e){this.mainMode===this.aimView&&(this.mode=e)}},{key:"forceMode",value:function(e){this.mode=e,this.mainMode=e}},{key:"forceMove",value:function(e){this.mode===this.aimView&&this.aimView(e,1)}},{key:"toggleMode",value:function(){this.mode===this.topView?this.mode=this.aimView:this.mode=this.topView,this.mainMode=this.mode}}],b(n.prototype,e),t&&b(n,t),n}();function k(e,t=1/0,n=null){r||(r=new d._12(2,2,1,1)),o||(o=new d.jyz({uniforms:{blitTexture:new d.xWb(e)},vertexShader:`
            varying vec2 vUv;
            void main(){
                vUv = uv;
                gl_Position = vec4(position.xy * 1.0,0.,.999999);
            }`,fragmentShader:`
            uniform sampler2D blitTexture; 
            varying vec2 vUv;

            void main(){ 
                gl_FragColor = vec4(vUv.xy, 0, 1);
                
                #ifdef IS_SRGB
                gl_FragColor = LinearTosRGB( texture2D( blitTexture, vUv) );
                #else
                gl_FragColor = texture2D( blitTexture, vUv);
                #endif
            }`})),o.uniforms.blitTexture.value=e,o.defines.IS_SRGB=e.colorSpace==d.KI_,o.needsUpdate=!0,s||((s=new d.Kj0(r,o)).frustrumCulled=!1);let a=new d.cPb,l=new d.xsS;l.add(s),n||(n=i=new d.CP7({antialias:!1})),n.setSize(Math.min(e.image.width,t),Math.min(e.image.height,t)),n.clear(),n.render(l,a);let c=new d.xEZ(n.domElement);return c.minFilter=e.minFilter,c.magFilter=e.magFilter,c.wrapS=e.wrapS,c.wrapT=e.wrapT,c.name=e.name,i&&(i.dispose(),i=null),c}let x={POSITION:["byte","byte normalized","unsigned byte","unsigned byte normalized","short","short normalized","unsigned short","unsigned short normalized"],NORMAL:["byte normalized","short normalized"],TANGENT:["byte normalized","short normalized"],TEXCOORD:["byte","byte normalized","unsigned byte","short","short normalized","unsigned short"]};class T{constructor(){this.pluginCallbacks=[],this.register(function(e){return new j(e)}),this.register(function(e){return new L(e)}),this.register(function(e){return new F(e)}),this.register(function(e){return new U(e)}),this.register(function(e){return new D(e)}),this.register(function(e){return new G(e)}),this.register(function(e){return new B(e)}),this.register(function(e){return new H(e)}),this.register(function(e){return new z(e)}),this.register(function(e){return new K(e)}),this.register(function(e){return new V(e)})}register(e){return -1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return -1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,n,i){let r=new N,o=[];for(let e=0,t=this.pluginCallbacks.length;e<t;e++)o.push(this.pluginCallbacks[e](r));r.setPlugins(o),r.write(e,t,i).catch(n)}parseAsync(e,t){let n=this;return new Promise(function(i,r){n.parse(e,i,r,t)})}}let R={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},A="KHR_mesh_quantization",E={};E[d.TyD]=R.NEAREST,E[d.YLQ]=R.NEAREST_MIPMAP_NEAREST,E[d.aH4]=R.NEAREST_MIPMAP_LINEAR,E[d.wem]=R.LINEAR,E[d.qyh]=R.LINEAR_MIPMAP_NEAREST,E[d.D1R]=R.LINEAR_MIPMAP_LINEAR,E[d.uWy]=R.CLAMP_TO_EDGE,E[d.rpg]=R.REPEAT,E[d.OoA]=R.MIRRORED_REPEAT;let S={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},P=new d.Ilk;function M(e,t){return e.length===t.length&&e.every(function(e,n){return e===t[n]})}function O(e){return 4*Math.ceil(e/4)}function _(e,t=0){let n=O(e.byteLength);if(n!==e.byteLength){let i=new Uint8Array(n);if(i.set(new Uint8Array(e)),0!==t)for(let r=e.byteLength;r<n;r++)i[r]=t;return i.buffer}return e}function I(){return"undefined"==typeof document&&"undefined"!=typeof OffscreenCanvas?new OffscreenCanvas(1,1):document.createElement("canvas")}function C(e,t){let n;return void 0!==e.toBlob?new Promise(n=>e.toBlob(n,t)):("image/jpeg"===t?n=.92:"image/webp"===t&&(n=.8),e.convertToBlob({type:t,quality:n}))}class N{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.extensionsRequired={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter"}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map}}setPlugins(e){this.plugins=e}async write(e,t,n={}){this.options=Object.assign({binary:!1,trs:!1,onlyVisible:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},n),this.options.animations.length>0&&(this.options.trs=!0),this.processInput(e),await Promise.all(this.pending);let i=this.buffers,r=this.json;n=this.options;let o=this.extensionsUsed,s=this.extensionsRequired,a=new Blob(i,{type:"application/octet-stream"}),l=Object.keys(o),c=Object.keys(s);if(l.length>0&&(r.extensionsUsed=l),c.length>0&&(r.extensionsRequired=c),r.buffers&&r.buffers.length>0&&(r.buffers[0].byteLength=a.size),!0===n.binary){let e=new FileReader;e.readAsArrayBuffer(a),e.onloadend=function(){var n;let i=_(e.result),o=new DataView(new ArrayBuffer(8));o.setUint32(0,i.byteLength,!0),o.setUint32(4,5130562,!0);let s=_((n=JSON.stringify(r),new TextEncoder().encode(n).buffer),32),a=new DataView(new ArrayBuffer(8));a.setUint32(0,s.byteLength,!0),a.setUint32(4,1313821514,!0);let l=new ArrayBuffer(12),c=new DataView(l);c.setUint32(0,1179937895,!0),c.setUint32(4,2,!0);let u=12+a.byteLength+s.byteLength+o.byteLength+i.byteLength;c.setUint32(8,u,!0);let h=new Blob([l,a,s,o,i],{type:"application/octet-stream"}),f=new FileReader;f.readAsArrayBuffer(h),f.onloadend=function(){t(f.result)}}}else if(r.buffers&&r.buffers.length>0){let e=new FileReader;e.readAsDataURL(a),e.onloadend=function(){let n=e.result;r.buffers[0].uri=n,t(r)}}else t(r)}serializeUserData(e,t){if(0===Object.keys(e.userData).length)return;let n=this.options,i=this.extensionsUsed;try{let r=JSON.parse(JSON.stringify(e.userData));if(n.includeCustomExtensions&&r.gltfExtensions){for(let e in void 0===t.extensions&&(t.extensions={}),r.gltfExtensions)t.extensions[e]=r.gltfExtensions[e],i[e]=!0;delete r.gltfExtensions}Object.keys(r).length>0&&(t.extras=r)}catch(t){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+t.message)}}getUID(e,t=!1){if(!1===this.uids.has(e)){let t=new Map;t.set(!0,this.uid++),t.set(!1,this.uid++),this.uids.set(e,t)}let n=this.uids.get(e);return n.get(t)}isNormalizedNormalAttribute(e){let t=this.cache;if(t.attributesNormalized.has(e))return!1;let n=new d.Pa4;for(let t=0,i=e.count;t<i;t++)if(Math.abs(n.fromBufferAttribute(e,t).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(e){let t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);let n=e.clone(),i=new d.Pa4;for(let e=0,t=n.count;e<t;e++)i.fromBufferAttribute(n,e),0===i.x&&0===i.y&&0===i.z?i.setX(1):i.normalize(),n.setXYZ(e,i.x,i.y,i.z);return t.attributesNormalized.set(e,n),n}applyTextureTransform(e,t){let n=!1,i={};(0!==t.offset.x||0!==t.offset.y)&&(i.offset=t.offset.toArray(),n=!0),0!==t.rotation&&(i.rotation=t.rotation,n=!0),(1!==t.repeat.x||1!==t.repeat.y)&&(i.scale=t.repeat.toArray(),n=!0),n&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=i,this.extensionsUsed.KHR_texture_transform=!0)}buildMetalRoughTexture(e,t){if(e===t)return e;function n(e){return e.colorSpace===d.KI_?function(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}:function(e){return e}}console.warn("THREE.GLTFExporter: Merged metalnessMap and roughnessMap textures."),e instanceof d.EB7&&(e=k(e)),t instanceof d.EB7&&(t=k(t));let i=e?e.image:null,r=t?t.image:null,o=Math.max(i?i.width:0,r?r.width:0),s=Math.max(i?i.height:0,r?r.height:0),a=I();a.width=o,a.height=s;let l=a.getContext("2d");l.fillStyle="#00ffff",l.fillRect(0,0,o,s);let c=l.getImageData(0,0,o,s);if(i){l.drawImage(i,0,0,o,s);let t=n(e),r=l.getImageData(0,0,o,s).data;for(let e=2;e<r.length;e+=4)c.data[e]=256*t(r[e]/256)}if(r){l.drawImage(r,0,0,o,s);let e=n(t),i=l.getImageData(0,0,o,s).data;for(let t=1;t<i.length;t+=4)c.data[t]=256*e(i[t]/256)}l.putImageData(c,0,0);let u=e||t,h=u.clone();return h.source=new d.Hw6(a),h.colorSpace=d.aCh,h.channel=(e||t).channel,e&&t&&e.channel!==t.channel&&console.warn("THREE.GLTFExporter: UV channels for metalnessMap and roughnessMap textures must match."),h}processBuffer(e){let t=this.json,n=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),n.push(e),0}processBufferView(e,t,n,i,r){let o;let s=this.json;switch(s.bufferViews||(s.bufferViews=[]),t){case R.BYTE:case R.UNSIGNED_BYTE:o=1;break;case R.SHORT:case R.UNSIGNED_SHORT:o=2;break;default:o=4}let a=O(i*e.itemSize*o),l=new DataView(new ArrayBuffer(a)),c=0;for(let r=n;r<n+i;r++)for(let n=0;n<e.itemSize;n++){let i;e.itemSize>4?i=e.array[r*e.itemSize+n]:(0===n?i=e.getX(r):1===n?i=e.getY(r):2===n?i=e.getZ(r):3===n&&(i=e.getW(r)),!0===e.normalized&&(i=d.M8C.normalize(i,e.array))),t===R.FLOAT?l.setFloat32(c,i,!0):t===R.INT?l.setInt32(c,i,!0):t===R.UNSIGNED_INT?l.setUint32(c,i,!0):t===R.SHORT?l.setInt16(c,i,!0):t===R.UNSIGNED_SHORT?l.setUint16(c,i,!0):t===R.BYTE?l.setInt8(c,i):t===R.UNSIGNED_BYTE&&l.setUint8(c,i),c+=o}let u={buffer:this.processBuffer(l.buffer),byteOffset:this.byteOffset,byteLength:a};void 0!==r&&(u.target=r),r===R.ARRAY_BUFFER&&(u.byteStride=e.itemSize*o),this.byteOffset+=a,s.bufferViews.push(u);let h={id:s.bufferViews.length-1,byteLength:0};return h}processBufferViewImage(e){let t=this,n=t.json;return n.bufferViews||(n.bufferViews=[]),new Promise(function(i){let r=new FileReader;r.readAsArrayBuffer(e),r.onloadend=function(){let e=_(r.result),o={buffer:t.processBuffer(e),byteOffset:t.byteOffset,byteLength:e.byteLength};t.byteOffset+=e.byteLength,i(n.bufferViews.push(o)-1)}})}processAccessor(e,t,n,i){let r,o;let s=this.json;if(e.array.constructor===Float32Array)r=R.FLOAT;else if(e.array.constructor===Int32Array)r=R.INT;else if(e.array.constructor===Uint32Array)r=R.UNSIGNED_INT;else if(e.array.constructor===Int16Array)r=R.SHORT;else if(e.array.constructor===Uint16Array)r=R.UNSIGNED_SHORT;else if(e.array.constructor===Int8Array)r=R.BYTE;else if(e.array.constructor===Uint8Array)r=R.UNSIGNED_BYTE;else throw Error("THREE.GLTFExporter: Unsupported bufferAttribute component type: "+e.array.constructor.name);if(void 0===n&&(n=0),void 0===i&&(i=e.count),0===i)return null;let a=function(e,t,n){let i={min:Array(e.itemSize).fill(Number.POSITIVE_INFINITY),max:Array(e.itemSize).fill(Number.NEGATIVE_INFINITY)};for(let r=t;r<t+n;r++)for(let t=0;t<e.itemSize;t++){let n;e.itemSize>4?n=e.array[r*e.itemSize+t]:(0===t?n=e.getX(r):1===t?n=e.getY(r):2===t?n=e.getZ(r):3===t&&(n=e.getW(r)),!0===e.normalized&&(n=d.M8C.normalize(n,e.array))),i.min[t]=Math.min(i.min[t],n),i.max[t]=Math.max(i.max[t],n)}return i}(e,n,i);void 0!==t&&(o=e===t.index?R.ELEMENT_ARRAY_BUFFER:R.ARRAY_BUFFER);let l=this.processBufferView(e,r,n,i,o),c={bufferView:l.id,byteOffset:l.byteOffset,componentType:r,count:i,max:a.max,min:a.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",9:"MAT3",16:"MAT4"}[e.itemSize]};return!0===e.normalized&&(c.normalized=!0),s.accessors||(s.accessors=[]),s.accessors.push(c)-1}processImage(e,t,n,i="image/png"){if(null!==e){let r=this,o=r.cache,s=r.json,a=r.options,l=r.pending;o.images.has(e)||o.images.set(e,{});let c=o.images.get(e),u=i+":flipY/"+n.toString();if(void 0!==c[u])return c[u];s.images||(s.images=[]);let h={mimeType:i},f=I();f.width=Math.min(e.width,a.maxTextureSize),f.height=Math.min(e.height,a.maxTextureSize);let p=f.getContext("2d");if(!0===n&&(p.translate(0,f.height),p.scale(1,-1)),void 0!==e.data){t!==d.wk1&&console.error("GLTFExporter: Only RGBAFormat is supported.",t),(e.width>a.maxTextureSize||e.height>a.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",e);let n=new Uint8ClampedArray(e.height*e.width*4);for(let t=0;t<n.length;t+=4)n[t+0]=e.data[t+0],n[t+1]=e.data[t+1],n[t+2]=e.data[t+2],n[t+3]=e.data[t+3];p.putImageData(new ImageData(n,e.width,e.height),0,0)}else p.drawImage(e,0,0,f.width,f.height);!0===a.binary?l.push(C(f,i).then(e=>r.processBufferViewImage(e)).then(e=>{h.bufferView=e})):void 0!==f.toDataURL?h.uri=f.toDataURL(i):l.push(C(f,i).then(e=>new FileReader().readAsDataURL(e)).then(e=>{h.uri=e}));let m=s.images.push(h)-1;return c[u]=m,m}throw Error("THREE.GLTFExporter: No valid image data found. Unable to process texture.")}processSampler(e){let t=this.json;t.samplers||(t.samplers=[]);let n={magFilter:E[e.magFilter],minFilter:E[e.minFilter],wrapS:E[e.wrapS],wrapT:E[e.wrapT]};return t.samplers.push(n)-1}processTexture(e){let t=this.options,n=this.cache,i=this.json;if(n.textures.has(e))return n.textures.get(e);i.textures||(i.textures=[]),e instanceof d.EB7&&(e=k(e,t.maxTextureSize));let r=e.userData.mimeType;"image/webp"===r&&(r="image/png");let o={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY,r)};e.name&&(o.name=e.name),this._invokeAll(function(t){t.writeTexture&&t.writeTexture(e,o)});let s=i.textures.push(o)-1;return n.textures.set(e,s),s}processMaterial(e){let t=this.cache,n=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;n.materials||(n.materials=[]);let i={pbrMetallicRoughness:{}};!0!==e.isMeshStandardMaterial&&!0!==e.isMeshBasicMaterial&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");let r=e.color.toArray().concat([e.opacity]);if(M(r,[1,1,1,1])||(i.pbrMetallicRoughness.baseColorFactor=r),e.isMeshStandardMaterial?(i.pbrMetallicRoughness.metallicFactor=e.metalness,i.pbrMetallicRoughness.roughnessFactor=e.roughness):(i.pbrMetallicRoughness.metallicFactor=.5,i.pbrMetallicRoughness.roughnessFactor=.5),e.metalnessMap||e.roughnessMap){let t=this.buildMetalRoughTexture(e.metalnessMap,e.roughnessMap),n={index:this.processTexture(t),channel:t.channel};this.applyTextureTransform(n,t),i.pbrMetallicRoughness.metallicRoughnessTexture=n}if(e.map){let t={index:this.processTexture(e.map),texCoord:e.map.channel};this.applyTextureTransform(t,e.map),i.pbrMetallicRoughness.baseColorTexture=t}if(e.emissive){let t=e.emissive,n=Math.max(t.r,t.g,t.b);if(n>0&&(i.emissiveFactor=e.emissive.toArray()),e.emissiveMap){let t={index:this.processTexture(e.emissiveMap),texCoord:e.emissiveMap.channel};this.applyTextureTransform(t,e.emissiveMap),i.emissiveTexture=t}}if(e.normalMap){let t={index:this.processTexture(e.normalMap),texCoord:e.normalMap.channel};e.normalScale&&1!==e.normalScale.x&&(t.scale=e.normalScale.x),this.applyTextureTransform(t,e.normalMap),i.normalTexture=t}if(e.aoMap){let t={index:this.processTexture(e.aoMap),texCoord:e.aoMap.channel};1!==e.aoMapIntensity&&(t.strength=e.aoMapIntensity),this.applyTextureTransform(t,e.aoMap),i.occlusionTexture=t}e.transparent?i.alphaMode="BLEND":e.alphaTest>0&&(i.alphaMode="MASK",i.alphaCutoff=e.alphaTest),e.side===d.ehD&&(i.doubleSided=!0),""!==e.name&&(i.name=e.name),this.serializeUserData(e,i),this._invokeAll(function(t){t.writeMaterial&&t.writeMaterial(e,i)});let o=n.materials.push(i)-1;return t.materials.set(e,o),o}processMesh(e){let t;let n=this.cache,i=this.json,r=[e.geometry.uuid];if(Array.isArray(e.material))for(let t=0,n=e.material.length;t<n;t++)r.push(e.material[t].uuid);else r.push(e.material.uuid);let o=r.join(":");if(n.meshes.has(o))return n.meshes.get(o);let s=e.geometry;t=e.isLineSegments?R.LINES:e.isLineLoop?R.LINE_LOOP:e.isLine?R.LINE_STRIP:e.isPoints?R.POINTS:e.material.wireframe?R.LINES:R.TRIANGLES;let a={},l={},c=[],u=[],h={uv:"TEXCOORD_0",uv1:"TEXCOORD_1",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},f=s.getAttribute("normal");void 0===f||this.isNormalizedNormalAttribute(f)||(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),s.setAttribute("normal",this.createNormalizedNormalAttribute(f)));let p=null;for(let e in s.attributes){if("morph"===e.slice(0,5))continue;let t=s.attributes[e];e=h[e]||e.toUpperCase();let i=/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/;if(i.test(e)||(e="_"+e),n.attributes.has(this.getUID(t))){l[e]=n.attributes.get(this.getUID(t));continue}p=null;let r=t.array;"JOINTS_0"!==e||r instanceof Uint16Array||r instanceof Uint8Array||(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),p=new d.TlE(new Uint16Array(r),t.itemSize,t.normalized));let o=this.processAccessor(p||t,s);null!==o&&(e.startsWith("_")||this.detectMeshQuantization(e,t),l[e]=o,n.attributes.set(this.getUID(t),o))}if(void 0!==f&&s.setAttribute("normal",f),0===Object.keys(l).length)return null;if(void 0!==e.morphTargetInfluences&&e.morphTargetInfluences.length>0){let t=[],i=[],r={};if(void 0!==e.morphTargetDictionary)for(let t in e.morphTargetDictionary)r[e.morphTargetDictionary[t]]=t;for(let o=0;o<e.morphTargetInfluences.length;++o){let a={},l=!1;for(let e in s.morphAttributes){if("position"!==e&&"normal"!==e){l||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),l=!0);continue}let t=s.morphAttributes[e][o],i=e.toUpperCase(),r=s.attributes[e];if(n.attributes.has(this.getUID(t,!0))){a[i]=n.attributes.get(this.getUID(t,!0));continue}let c=t.clone();if(!s.morphTargetsRelative)for(let e=0,n=t.count;e<n;e++)for(let n=0;n<t.itemSize;n++)0===n&&c.setX(e,t.getX(e)-r.getX(e)),1===n&&c.setY(e,t.getY(e)-r.getY(e)),2===n&&c.setZ(e,t.getZ(e)-r.getZ(e)),3===n&&c.setW(e,t.getW(e)-r.getW(e));a[i]=this.processAccessor(c,s),n.attributes.set(this.getUID(r,!0),a[i])}u.push(a),t.push(e.morphTargetInfluences[o]),void 0!==e.morphTargetDictionary&&i.push(r[o])}a.weights=t,i.length>0&&(a.extras={},a.extras.targetNames=i)}let m=Array.isArray(e.material);if(m&&0===s.groups.length)return null;let v=m?e.material:[e.material],y=m?s.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let e=0,i=y.length;e<i;e++){let i={mode:t,attributes:l};if(this.serializeUserData(s,i),u.length>0&&(i.targets=u),null!==s.index){let t=this.getUID(s.index);(void 0!==y[e].start||void 0!==y[e].count)&&(t+=":"+y[e].start+":"+y[e].count),n.attributes.has(t)?i.indices=n.attributes.get(t):(i.indices=this.processAccessor(s.index,s,y[e].start,y[e].count),n.attributes.set(t,i.indices)),null===i.indices&&delete i.indices}let r=this.processMaterial(v[y[e].materialIndex]);null!==r&&(i.material=r),c.push(i)}a.primitives=c,i.meshes||(i.meshes=[]),this._invokeAll(function(t){t.writeMesh&&t.writeMesh(e,a)});let b=i.meshes.push(a)-1;return n.meshes.set(o,b),b}detectMeshQuantization(e,t){let n;if(this.extensionsUsed[A])return;switch(t.array.constructor){case Int8Array:n="byte";break;case Uint8Array:n="unsigned byte";break;case Int16Array:n="short";break;case Uint16Array:n="unsigned short";break;default:return}t.normalized&&(n+=" normalized");let i=e.split("_",1)[0];x[i]&&x[i].includes(n)&&(this.extensionsUsed[A]=!0,this.extensionsRequired[A]=!0)}processCamera(e){let t=this.json;t.cameras||(t.cameras=[]);let n=e.isOrthographicCamera,i={type:n?"orthographic":"perspective"};return n?i.orthographic={xmag:2*e.right,ymag:2*e.top,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:i.perspective={aspectRatio:e.aspect,yfov:d.M8C.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},""!==e.name&&(i.name=e.type),t.cameras.push(i)-1}processAnimation(e,t){let n=this.json,i=this.nodeMap;n.animations||(n.animations=[]),e=T.Utils.mergeMorphTargetTracks(e.clone(),t);let r=e.tracks,o=[],s=[];for(let e=0;e<r.length;++e){let n;let a=r[e],l=d.iUV.parseTrackName(a.name),c=d.iUV.findNode(t,l.nodeName),u=S[l.propertyName];if("bones"===l.objectName&&(c=!0===c.isSkinnedMesh?c.skeleton.getBoneByName(l.objectIndex):void 0),!c||!u)return console.warn('THREE.GLTFExporter: Could not export animation track "%s".',a.name),null;let h=a.values.length/a.times.length;u===S.morphTargetInfluences&&(h/=c.morphTargetInfluences.length),!0===a.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(n="CUBICSPLINE",h/=3):n=a.getInterpolation()===d.Syv?"STEP":"LINEAR",s.push({input:this.processAccessor(new d.TlE(a.times,1)),output:this.processAccessor(new d.TlE(a.values,h)),interpolation:n}),o.push({sampler:s.length-1,target:{node:i.get(c),path:u}})}return n.animations.push({name:e.name||"clip_"+n.animations.length,samplers:s,channels:o}),n.animations.length-1}processSkin(e){let t=this.json,n=this.nodeMap,i=t.nodes[n.get(e)],r=e.skeleton;if(void 0===r)return null;let o=e.skeleton.bones[0];if(void 0===o)return null;let s=[],a=new Float32Array(16*r.bones.length),l=new d.yGw;for(let t=0;t<r.bones.length;++t)s.push(n.get(r.bones[t])),l.copy(r.boneInverses[t]),l.multiply(e.bindMatrix).toArray(a,16*t);void 0===t.skins&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new d.TlE(a,16)),joints:s,skeleton:n.get(o)});let c=i.skin=t.skins.length-1;return c}processNode(e){let t=this.json,n=this.options,i=this.nodeMap;t.nodes||(t.nodes=[]);let r={};if(n.trs){let t=e.quaternion.toArray(),n=e.position.toArray(),i=e.scale.toArray();M(t,[0,0,0,1])||(r.rotation=t),M(n,[0,0,0])||(r.translation=n),M(i,[1,1,1])||(r.scale=i)}else e.matrixAutoUpdate&&e.updateMatrix(),!1===M(e.matrix.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])&&(r.matrix=e.matrix.elements);if(""!==e.name&&(r.name=String(e.name)),this.serializeUserData(e,r),e.isMesh||e.isLine||e.isPoints){let t=this.processMesh(e);null!==t&&(r.mesh=t)}else e.isCamera&&(r.camera=this.processCamera(e));if(e.isSkinnedMesh&&this.skins.push(e),e.children.length>0){let t=[];for(let i=0,r=e.children.length;i<r;i++){let r=e.children[i];if(r.visible||!1===n.onlyVisible){let e=this.processNode(r);null!==e&&t.push(e)}}t.length>0&&(r.children=t)}this._invokeAll(function(t){t.writeNode&&t.writeNode(e,r)});let o=t.nodes.push(r)-1;return i.set(e,o),o}processScene(e){let t=this.json,n=this.options;t.scenes||(t.scenes=[],t.scene=0);let i={};""!==e.name&&(i.name=e.name),t.scenes.push(i);let r=[];for(let t=0,i=e.children.length;t<i;t++){let i=e.children[t];if(i.visible||!1===n.onlyVisible){let e=this.processNode(i);null!==e&&r.push(e)}}r.length>0&&(i.nodes=r),this.serializeUserData(e,i)}processObjects(e){let t=new d.xsS;t.name="AuxScene";for(let n=0;n<e.length;n++)t.children.push(e[n]);this.processScene(t)}processInput(e){let t=this.options;e=e instanceof Array?e:[e],this._invokeAll(function(t){t.beforeParse&&t.beforeParse(e)});let n=[];for(let t=0;t<e.length;t++)e[t]instanceof d.xsS?this.processScene(e[t]):n.push(e[t]);n.length>0&&this.processObjects(n);for(let e=0;e<this.skins.length;++e)this.processSkin(this.skins[e]);for(let n=0;n<t.animations.length;++n)this.processAnimation(t.animations[n],e[0]);this._invokeAll(function(t){t.afterParse&&t.afterParse(e)})}_invokeAll(e){for(let t=0,n=this.plugins.length;t<n;t++)e(this.plugins[t])}}class j{constructor(e){this.writer=e,this.name="KHR_lights_punctual"}writeNode(e,t){if(!e.isLight)return;if(!e.isDirectionalLight&&!e.isPointLight&&!e.isSpotLight){console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e);return}let n=this.writer,i=n.json,r=n.extensionsUsed,o={};e.name&&(o.name=e.name),o.color=e.color.toArray(),o.intensity=e.intensity,e.isDirectionalLight?o.type="directional":e.isPointLight?(o.type="point",e.distance>0&&(o.range=e.distance)):e.isSpotLight&&(o.type="spot",e.distance>0&&(o.range=e.distance),o.spot={},o.spot.innerConeAngle=(1-e.penumbra)*e.angle,o.spot.outerConeAngle=e.angle),void 0!==e.decay&&2!==e.decay&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),e.target&&(e.target.parent!==e||0!==e.target.position.x||0!==e.target.position.y||-1!==e.target.position.z)&&console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),r[this.name]||(i.extensions=i.extensions||{},i.extensions[this.name]={lights:[]},r[this.name]=!0);let s=i.extensions[this.name].lights;s.push(o),t.extensions=t.extensions||{},t.extensions[this.name]={light:s.length-1}}}class L{constructor(e){this.writer=e,this.name="KHR_materials_unlit"}writeMaterial(e,t){if(!e.isMeshBasicMaterial)return;let n=this.writer,i=n.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},i[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}}class B{constructor(e){this.writer=e,this.name="KHR_materials_clearcoat"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0===e.clearcoat)return;let n=this.writer,i=n.extensionsUsed,r={};if(r.clearcoatFactor=e.clearcoat,e.clearcoatMap){let t={index:n.processTexture(e.clearcoatMap),texCoord:e.clearcoatMap.channel};n.applyTextureTransform(t,e.clearcoatMap),r.clearcoatTexture=t}if(r.clearcoatRoughnessFactor=e.clearcoatRoughness,e.clearcoatRoughnessMap){let t={index:n.processTexture(e.clearcoatRoughnessMap),texCoord:e.clearcoatRoughnessMap.channel};n.applyTextureTransform(t,e.clearcoatRoughnessMap),r.clearcoatRoughnessTexture=t}if(e.clearcoatNormalMap){let t={index:n.processTexture(e.clearcoatNormalMap),texCoord:e.clearcoatNormalMap.channel};n.applyTextureTransform(t,e.clearcoatNormalMap),r.clearcoatNormalTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=r,i[this.name]=!0}}class H{constructor(e){this.writer=e,this.name="KHR_materials_iridescence"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0===e.iridescence)return;let n=this.writer,i=n.extensionsUsed,r={};if(r.iridescenceFactor=e.iridescence,e.iridescenceMap){let t={index:n.processTexture(e.iridescenceMap),texCoord:e.iridescenceMap.channel};n.applyTextureTransform(t,e.iridescenceMap),r.iridescenceTexture=t}if(r.iridescenceIor=e.iridescenceIOR,r.iridescenceThicknessMinimum=e.iridescenceThicknessRange[0],r.iridescenceThicknessMaximum=e.iridescenceThicknessRange[1],e.iridescenceThicknessMap){let t={index:n.processTexture(e.iridescenceThicknessMap),texCoord:e.iridescenceThicknessMap.channel};n.applyTextureTransform(t,e.iridescenceThicknessMap),r.iridescenceThicknessTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=r,i[this.name]=!0}}class F{constructor(e){this.writer=e,this.name="KHR_materials_transmission"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;let n=this.writer,i=n.extensionsUsed,r={};if(r.transmissionFactor=e.transmission,e.transmissionMap){let t={index:n.processTexture(e.transmissionMap),texCoord:e.transmissionMap.channel};n.applyTextureTransform(t,e.transmissionMap),r.transmissionTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=r,i[this.name]=!0}}class U{constructor(e){this.writer=e,this.name="KHR_materials_volume"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;let n=this.writer,i=n.extensionsUsed,r={};if(r.thicknessFactor=e.thickness,e.thicknessMap){let t={index:n.processTexture(e.thicknessMap),texCoord:e.thicknessMap.channel};n.applyTextureTransform(t,e.thicknessMap),r.thicknessTexture=t}r.attenuationDistance=e.attenuationDistance,r.attenuationColor=e.attenuationColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=r,i[this.name]=!0}}class D{constructor(e){this.writer=e,this.name="KHR_materials_ior"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||1.5===e.ior)return;let n=this.writer,i=n.extensionsUsed,r={};r.ior=e.ior,t.extensions=t.extensions||{},t.extensions[this.name]=r,i[this.name]=!0}}class G{constructor(e){this.writer=e,this.name="KHR_materials_specular"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||1===e.specularIntensity&&e.specularColor.equals(P)&&!e.specularIntensityMap&&!e.specularColorTexture)return;let n=this.writer,i=n.extensionsUsed,r={};if(e.specularIntensityMap){let t={index:n.processTexture(e.specularIntensityMap),texCoord:e.specularIntensityMap.channel};n.applyTextureTransform(t,e.specularIntensityMap),r.specularTexture=t}if(e.specularColorMap){let t={index:n.processTexture(e.specularColorMap),texCoord:e.specularColorMap.channel};n.applyTextureTransform(t,e.specularColorMap),r.specularColorTexture=t}r.specularFactor=e.specularIntensity,r.specularColorFactor=e.specularColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=r,i[this.name]=!0}}class z{constructor(e){this.writer=e,this.name="KHR_materials_sheen"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0==e.sheen)return;let n=this.writer,i=n.extensionsUsed,r={};if(e.sheenRoughnessMap){let t={index:n.processTexture(e.sheenRoughnessMap),texCoord:e.sheenRoughnessMap.channel};n.applyTextureTransform(t,e.sheenRoughnessMap),r.sheenRoughnessTexture=t}if(e.sheenColorMap){let t={index:n.processTexture(e.sheenColorMap),texCoord:e.sheenColorMap.channel};n.applyTextureTransform(t,e.sheenColorMap),r.sheenColorTexture=t}r.sheenRoughnessFactor=e.sheenRoughness,r.sheenColorFactor=e.sheenColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=r,i[this.name]=!0}}class K{constructor(e){this.writer=e,this.name="KHR_materials_anisotropy"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0==e.anisotropy)return;let n=this.writer,i=n.extensionsUsed,r={};if(e.anisotropyMap){let t={index:n.processTexture(e.anisotropyMap)};n.applyTextureTransform(t,e.anisotropyMap),r.anisotropyTexture=t}r.anisotropyStrength=e.anisotropy,r.anisotropyRotation=e.anisotropyRotation,t.extensions=t.extensions||{},t.extensions[this.name]=r,i[this.name]=!0}}class V{constructor(e){this.writer=e,this.name="KHR_materials_emissive_strength"}writeMaterial(e,t){if(!e.isMeshStandardMaterial||1===e.emissiveIntensity)return;let n=this.writer,i=n.extensionsUsed,r={};r.emissiveStrength=e.emissiveIntensity,t.extensions=t.extensions||{},t.extensions[this.name]=r,i[this.name]=!0}}function X(e,t){if(t===d.WwZ)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(t!==d.z$h&&t!==d.UlW)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),e;{let n=e.getIndex();if(null===n){let t=[],i=e.getAttribute("position");if(void 0===i)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<i.count;e++)t.push(e);e.setIndex(t),n=e.getIndex()}let i=n.count-2,r=[];if(t===d.z$h)for(let e=1;e<=i;e++)r.push(n.getX(0)),r.push(n.getX(e)),r.push(n.getX(e+1));else for(let e=0;e<i;e++)e%2==0?(r.push(n.getX(e)),r.push(n.getX(e+1)),r.push(n.getX(e+2))):(r.push(n.getX(e+2)),r.push(n.getX(e+1)),r.push(n.getX(e)));r.length/3!==i&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");let o=e.clone();return o.setIndex(r),o.clearGroups(),o}}T.Utils={insertKeyframe:function(e,t){let n;let i=e.getValueSize(),r=new e.TimeBufferType(e.times.length+1),o=new e.ValueBufferType(e.values.length+i),s=e.createInterpolant(new e.ValueBufferType(i));if(0===e.times.length){r[0]=t;for(let e=0;e<i;e++)o[e]=0;n=0}else if(t<e.times[0]){if(.001>Math.abs(e.times[0]-t))return 0;r[0]=t,r.set(e.times,1),o.set(s.evaluate(t),0),o.set(e.values,i),n=0}else if(t>e.times[e.times.length-1]){if(.001>Math.abs(e.times[e.times.length-1]-t))return e.times.length-1;r[r.length-1]=t,r.set(e.times,0),o.set(e.values,0),o.set(s.evaluate(t),e.values.length),n=r.length-1}else for(let a=0;a<e.times.length;a++){if(.001>Math.abs(e.times[a]-t))return a;if(e.times[a]<t&&e.times[a+1]>t){r.set(e.times.slice(0,a+1),0),r[a+1]=t,r.set(e.times.slice(a+1),a+2),o.set(e.values.slice(0,(a+1)*i),0),o.set(s.evaluate(t),(a+1)*i),o.set(e.values.slice((a+1)*i),(a+2)*i),n=a+1;break}}return e.times=r,e.values=o,n},mergeMorphTargetTracks:function(e,t){let n=[],i={},r=e.tracks;for(let e=0;e<r.length;++e){let o,s=r[e],a=d.iUV.parseTrackName(s.name),l=d.iUV.findNode(t,a.nodeName);if("morphTargetInfluences"!==a.propertyName||void 0===a.propertyIndex){n.push(s);continue}if(s.createInterpolant!==s.InterpolantFactoryMethodDiscrete&&s.createInterpolant!==s.InterpolantFactoryMethodLinear){if(s.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),(s=s.clone()).setInterpolation(d.NMF)}let c=l.morphTargetInfluences.length,u=l.morphTargetDictionary[a.propertyIndex];if(void 0===u)throw Error("THREE.GLTFExporter: Morph target name not found: "+a.propertyIndex);if(void 0===i[l.uuid]){o=s.clone();let e=new o.ValueBufferType(c*o.times.length);for(let t=0;t<o.times.length;t++)e[t*c+u]=o.values[t];o.name=(a.nodeName||"")+".morphTargetInfluences",o.values=e,i[l.uuid]=o,n.push(o);continue}let h=s.createInterpolant(new s.ValueBufferType(1));o=i[l.uuid];for(let e=0;e<o.times.length;e++)o.values[e*c+u]=h.evaluate(o.times[e]);for(let e=0;e<s.times.length;e++){let t=this.insertKeyframe(o,s.times[e]);o.values[t*c+u]=s.values[e]}}return e.tracks=n,e}};class W extends d.aNw{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(e){return new $(e)}),this.register(function(e){return new ea(e)}),this.register(function(e){return new el(e)}),this.register(function(e){return new ec(e)}),this.register(function(e){return new et(e)}),this.register(function(e){return new en(e)}),this.register(function(e){return new ei(e)}),this.register(function(e){return new er(e)}),this.register(function(e){return new Q(e)}),this.register(function(e){return new eo(e)}),this.register(function(e){return new ee(e)}),this.register(function(e){return new es(e)}),this.register(function(e){return new J(e)}),this.register(function(e){return new eu(e)}),this.register(function(e){return new eh(e)})}load(e,t,n,i){let r;let o=this;r=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:d.Zp0.extractUrlBase(e),this.manager.itemStart(e);let s=function(t){i?i(t):console.error(t),o.manager.itemError(e),o.manager.itemEnd(e)},a=new d.hH6(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(e,function(n){try{o.parse(n,r,function(n){t(n),o.manager.itemEnd(e)},s)}catch(e){s(e)}},n,s)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return -1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return -1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,n,i){let r;let o={},s={},a=new TextDecoder;if("string"==typeof e)r=JSON.parse(e);else if(e instanceof ArrayBuffer){let t=a.decode(new Uint8Array(e,0,4));if(t===ef){try{o[Z.KHR_BINARY_GLTF]=new ed(e)}catch(e){i&&i(e);return}r=JSON.parse(o[Z.KHR_BINARY_GLTF].content)}else r=JSON.parse(a.decode(e))}else r=e;if(void 0===r.asset||r.asset.version[0]<2){i&&i(Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}let l=new ej(r,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){let t=this.pluginCallbacks[e](l);s[t.name]=t,o[t.name]=!0}if(r.extensionsUsed)for(let e=0;e<r.extensionsUsed.length;++e){let t=r.extensionsUsed[e],n=r.extensionsRequired||[];switch(t){case Z.KHR_MATERIALS_UNLIT:o[t]=new q;break;case Z.KHR_DRACO_MESH_COMPRESSION:o[t]=new em(r,this.dracoLoader);break;case Z.KHR_TEXTURE_TRANSFORM:o[t]=new ev;break;case Z.KHR_MESH_QUANTIZATION:o[t]=new ey;break;default:n.indexOf(t)>=0&&void 0===s[t]&&console.warn('THREE.GLTFLoader: Unknown extension "'+t+'".')}}l.setExtensions(o),l.setPlugins(s),l.parse(n,i)}parseAsync(e,t){let n=this;return new Promise(function(i,r){n.parse(e,t,i,r)})}}function Y(){let e={};return{get:function(t){return e[t]},add:function(t,n){e[t]=n},remove:function(t){delete e[t]},removeAll:function(){e={}}}}let Z={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class J{constructor(e){this.parser=e,this.name=Z.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){let e=this.parser,t=this.parser.json.nodes||[];for(let n=0,i=t.length;n<i;n++){let i=t[n];i.extensions&&i.extensions[this.name]&&void 0!==i.extensions[this.name].light&&e._addNodeRef(this.cache,i.extensions[this.name].light)}}_loadLight(e){let t;let n=this.parser,i="light:"+e,r=n.cache.get(i);if(r)return r;let o=n.json,s=o.extensions&&o.extensions[this.name]||{},a=s.lights||[],l=a[e],c=new d.Ilk(16777215);void 0!==l.color&&c.setRGB(l.color[0],l.color[1],l.color[2],d.GUF);let u=void 0!==l.range?l.range:0;switch(l.type){case"directional":(t=new d.Ox3(c)).target.position.set(0,0,-1),t.add(t.target);break;case"point":(t=new d.cek(c)).distance=u;break;case"spot":(t=new d.PMe(c)).distance=u,l.spot=l.spot||{},l.spot.innerConeAngle=void 0!==l.spot.innerConeAngle?l.spot.innerConeAngle:0,l.spot.outerConeAngle=void 0!==l.spot.outerConeAngle?l.spot.outerConeAngle:Math.PI/4,t.angle=l.spot.outerConeAngle,t.penumbra=1-l.spot.innerConeAngle/l.spot.outerConeAngle,t.target.position.set(0,0,-1),t.add(t.target);break;default:throw Error("THREE.GLTFLoader: Unexpected light type: "+l.type)}return t.position.set(0,0,0),t.decay=2,e_(t,l),void 0!==l.intensity&&(t.intensity=l.intensity),t.name=n.createUniqueName(l.name||"light_"+e),r=Promise.resolve(t),n.cache.add(i,r),r}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){let t=this,n=this.parser,i=n.json,r=i.nodes[e],o=r.extensions&&r.extensions[this.name]||{},s=o.light;return void 0===s?null:this._loadLight(s).then(function(e){return n._getNodeRef(t.cache,s,e)})}}class q{constructor(){this.name=Z.KHR_MATERIALS_UNLIT}getMaterialType(){return d.vBJ}extendParams(e,t,n){let i=[];e.color=new d.Ilk(1,1,1),e.opacity=1;let r=t.pbrMetallicRoughness;if(r){if(Array.isArray(r.baseColorFactor)){let t=r.baseColorFactor;e.color.setRGB(t[0],t[1],t[2],d.GUF),e.opacity=t[3]}void 0!==r.baseColorTexture&&i.push(n.assignTexture(e,"map",r.baseColorTexture,d.KI_))}return Promise.all(i)}}class Q{constructor(e){this.parser=e,this.name=Z.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let r=i.extensions[this.name].emissiveStrength;return void 0!==r&&(t.emissiveIntensity=r),Promise.resolve()}}class ${constructor(e){this.parser=e,this.name=Z.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){let t=this.parser,n=t.json.materials[e];return n.extensions&&n.extensions[this.name]?d.EJi:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let r=[],o=i.extensions[this.name];if(void 0!==o.clearcoatFactor&&(t.clearcoat=o.clearcoatFactor),void 0!==o.clearcoatTexture&&r.push(n.assignTexture(t,"clearcoatMap",o.clearcoatTexture)),void 0!==o.clearcoatRoughnessFactor&&(t.clearcoatRoughness=o.clearcoatRoughnessFactor),void 0!==o.clearcoatRoughnessTexture&&r.push(n.assignTexture(t,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),void 0!==o.clearcoatNormalTexture&&(r.push(n.assignTexture(t,"clearcoatNormalMap",o.clearcoatNormalTexture)),void 0!==o.clearcoatNormalTexture.scale)){let e=o.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new d.FM8(e,e)}return Promise.all(r)}}class ee{constructor(e){this.parser=e,this.name=Z.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){let t=this.parser,n=t.json.materials[e];return n.extensions&&n.extensions[this.name]?d.EJi:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let r=[],o=i.extensions[this.name];return void 0!==o.iridescenceFactor&&(t.iridescence=o.iridescenceFactor),void 0!==o.iridescenceTexture&&r.push(n.assignTexture(t,"iridescenceMap",o.iridescenceTexture)),void 0!==o.iridescenceIor&&(t.iridescenceIOR=o.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==o.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),void 0!==o.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),void 0!==o.iridescenceThicknessTexture&&r.push(n.assignTexture(t,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(r)}}class et{constructor(e){this.parser=e,this.name=Z.KHR_MATERIALS_SHEEN}getMaterialType(e){let t=this.parser,n=t.json.materials[e];return n.extensions&&n.extensions[this.name]?d.EJi:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let r=[];t.sheenColor=new d.Ilk(0,0,0),t.sheenRoughness=0,t.sheen=1;let o=i.extensions[this.name];if(void 0!==o.sheenColorFactor){let e=o.sheenColorFactor;t.sheenColor.setRGB(e[0],e[1],e[2],d.GUF)}return void 0!==o.sheenRoughnessFactor&&(t.sheenRoughness=o.sheenRoughnessFactor),void 0!==o.sheenColorTexture&&r.push(n.assignTexture(t,"sheenColorMap",o.sheenColorTexture,d.KI_)),void 0!==o.sheenRoughnessTexture&&r.push(n.assignTexture(t,"sheenRoughnessMap",o.sheenRoughnessTexture)),Promise.all(r)}}class en{constructor(e){this.parser=e,this.name=Z.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){let t=this.parser,n=t.json.materials[e];return n.extensions&&n.extensions[this.name]?d.EJi:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let r=[],o=i.extensions[this.name];return void 0!==o.transmissionFactor&&(t.transmission=o.transmissionFactor),void 0!==o.transmissionTexture&&r.push(n.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(r)}}class ei{constructor(e){this.parser=e,this.name=Z.KHR_MATERIALS_VOLUME}getMaterialType(e){let t=this.parser,n=t.json.materials[e];return n.extensions&&n.extensions[this.name]?d.EJi:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let r=[],o=i.extensions[this.name];t.thickness=void 0!==o.thicknessFactor?o.thicknessFactor:0,void 0!==o.thicknessTexture&&r.push(n.assignTexture(t,"thicknessMap",o.thicknessTexture)),t.attenuationDistance=o.attenuationDistance||1/0;let s=o.attenuationColor||[1,1,1];return t.attenuationColor=new d.Ilk().setRGB(s[0],s[1],s[2],d.GUF),Promise.all(r)}}class er{constructor(e){this.parser=e,this.name=Z.KHR_MATERIALS_IOR}getMaterialType(e){let t=this.parser,n=t.json.materials[e];return n.extensions&&n.extensions[this.name]?d.EJi:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let r=i.extensions[this.name];return t.ior=void 0!==r.ior?r.ior:1.5,Promise.resolve()}}class eo{constructor(e){this.parser=e,this.name=Z.KHR_MATERIALS_SPECULAR}getMaterialType(e){let t=this.parser,n=t.json.materials[e];return n.extensions&&n.extensions[this.name]?d.EJi:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let r=[],o=i.extensions[this.name];t.specularIntensity=void 0!==o.specularFactor?o.specularFactor:1,void 0!==o.specularTexture&&r.push(n.assignTexture(t,"specularIntensityMap",o.specularTexture));let s=o.specularColorFactor||[1,1,1];return t.specularColor=new d.Ilk().setRGB(s[0],s[1],s[2],d.GUF),void 0!==o.specularColorTexture&&r.push(n.assignTexture(t,"specularColorMap",o.specularColorTexture,d.KI_)),Promise.all(r)}}class es{constructor(e){this.parser=e,this.name=Z.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){let t=this.parser,n=t.json.materials[e];return n.extensions&&n.extensions[this.name]?d.EJi:null}extendMaterialParams(e,t){let n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let r=[],o=i.extensions[this.name];return void 0!==o.anisotropyStrength&&(t.anisotropy=o.anisotropyStrength),void 0!==o.anisotropyRotation&&(t.anisotropyRotation=o.anisotropyRotation),void 0!==o.anisotropyTexture&&r.push(n.assignTexture(t,"anisotropyMap",o.anisotropyTexture)),Promise.all(r)}}class ea{constructor(e){this.parser=e,this.name=Z.KHR_TEXTURE_BASISU}loadTexture(e){let t=this.parser,n=t.json,i=n.textures[e];if(!i.extensions||!i.extensions[this.name])return null;let r=i.extensions[this.name],o=t.options.ktx2Loader;if(!o){if(!(n.extensionsRequired&&n.extensionsRequired.indexOf(this.name)>=0))return null;throw Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures")}return t.loadTextureImage(e,r.source,o)}}class el{constructor(e){this.parser=e,this.name=Z.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){let t=this.name,n=this.parser,i=n.json,r=i.textures[e];if(!r.extensions||!r.extensions[t])return null;let o=r.extensions[t],s=i.images[o.source],a=n.textureLoader;if(s.uri){let e=n.options.manager.getHandler(s.uri);null!==e&&(a=e)}return this.detectSupport().then(function(r){if(r)return n.loadTextureImage(e,o.source,a);if(i.extensionsRequired&&i.extensionsRequired.indexOf(t)>=0)throw Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return n.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){let t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}})),this.isSupported}}class ec{constructor(e){this.parser=e,this.name=Z.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){let t=this.name,n=this.parser,i=n.json,r=i.textures[e];if(!r.extensions||!r.extensions[t])return null;let o=r.extensions[t],s=i.images[o.source],a=n.textureLoader;if(s.uri){let e=n.options.manager.getHandler(s.uri);null!==e&&(a=e)}return this.detectSupport().then(function(r){if(r)return n.loadTextureImage(e,o.source,a);if(i.extensionsRequired&&i.extensionsRequired.indexOf(t)>=0)throw Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return n.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){let t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(1===t.height)}})),this.isSupported}}class eu{constructor(e){this.name=Z.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){let t=this.parser.json,n=t.bufferViews[e];if(!n.extensions||!n.extensions[this.name])return null;{let e=n.extensions[this.name],i=this.parser.getDependency("buffer",e.buffer),r=this.parser.options.meshoptDecoder;if(!r||!r.supported){if(!(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0))return null;throw Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files")}return i.then(function(t){let n=e.byteOffset||0,i=e.byteLength||0,o=e.count,s=e.byteStride,a=new Uint8Array(t,n,i);return r.decodeGltfBufferAsync?r.decodeGltfBufferAsync(o,s,a,e.mode,e.filter).then(function(e){return e.buffer}):r.ready.then(function(){let t=new ArrayBuffer(o*s);return r.decodeGltfBuffer(new Uint8Array(t),o,s,a,e.mode,e.filter),t})})}}}class eh{constructor(e){this.name=Z.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){let t=this.parser.json,n=t.nodes[e];if(!n.extensions||!n.extensions[this.name]||void 0===n.mesh)return null;let i=t.meshes[n.mesh];for(let e of i.primitives)if(e.mode!==ek.TRIANGLES&&e.mode!==ek.TRIANGLE_STRIP&&e.mode!==ek.TRIANGLE_FAN&&void 0!==e.mode)return null;let r=n.extensions[this.name],o=r.attributes,s=[],a={};for(let e in o)s.push(this.parser.getDependency("accessor",o[e]).then(t=>(a[e]=t,a[e])));return s.length<1?null:(s.push(this.parser.createNodeMesh(e)),Promise.all(s).then(e=>{let t=e.pop(),n=t.isGroup?t.children:[t],i=e[0].count,r=[];for(let e of n){let t=new d.yGw,n=new d.Pa4,o=new d._fP,s=new d.Pa4(1,1,1),l=new d.SPe(e.geometry,e.material,i);for(let e=0;e<i;e++)a.TRANSLATION&&n.fromBufferAttribute(a.TRANSLATION,e),a.ROTATION&&o.fromBufferAttribute(a.ROTATION,e),a.SCALE&&s.fromBufferAttribute(a.SCALE,e),l.setMatrixAt(e,t.compose(n,o,s));for(let t in a)"TRANSLATION"!==t&&"ROTATION"!==t&&"SCALE"!==t&&e.geometry.setAttribute(t,a[t]);d.Tme.prototype.copy.call(l,e),this.parser.assignFinalMaterial(l),r.push(l)}return t.isGroup?(t.clear(),t.add(...r),t):r[0]}))}}let ef="glTF",ep={JSON:1313821514,BIN:5130562};class ed{constructor(e){this.name=Z.KHR_BINARY_GLTF,this.content=null,this.body=null;let t=new DataView(e,0,12),n=new TextDecoder;if(this.header={magic:n.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==ef)throw Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw Error("THREE.GLTFLoader: Legacy binary file detected.");let i=this.header.length-12,r=new DataView(e,12),o=0;for(;o<i;){let t=r.getUint32(o,!0);o+=4;let i=r.getUint32(o,!0);if(o+=4,i===ep.JSON){let i=new Uint8Array(e,12+o,t);this.content=n.decode(i)}else if(i===ep.BIN){let n=12+o;this.body=e.slice(n,n+t)}o+=t}if(null===this.content)throw Error("THREE.GLTFLoader: JSON content not found.")}}class em{constructor(e,t){if(!t)throw Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=Z.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){let n=this.json,i=this.dracoLoader,r=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,s={},a={},l={};for(let e in o){let t=eE[e]||e.toLowerCase();s[t]=o[e]}for(let t in e.attributes){let i=eE[t]||t.toLowerCase();if(void 0!==o[t]){let r=n.accessors[e.attributes[t]],o=ex[r.componentType];l[i]=o.name,a[i]=!0===r.normalized}}return t.getDependency("bufferView",r).then(function(e){return new Promise(function(t){i.decodeDracoFile(e,function(e){for(let t in e.attributes){let n=e.attributes[t],i=a[t];void 0!==i&&(n.normalized=i)}t(e)},s,l)})})}}class ev{constructor(){this.name=Z.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(void 0===t.texCoord||t.texCoord===e.channel)&&void 0===t.offset&&void 0===t.rotation&&void 0===t.scale||(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class ey{constructor(){this.name=Z.KHR_MESH_QUANTIZATION}}class eb extends d._C8{constructor(e,t,n,i){super(e,t,n,i)}copySampleValue_(e){let t=this.resultBuffer,n=this.sampleValues,i=this.valueSize,r=e*i*3+i;for(let e=0;e!==i;e++)t[e]=n[r+e];return t}interpolate_(e,t,n,i){let r=this.resultBuffer,o=this.sampleValues,s=this.valueSize,a=2*s,l=3*s,c=i-t,u=(n-t)/c,h=u*u,f=h*u,p=e*l,d=p-l,m=-2*f+3*h,v=f-h,y=1-m,b=v-h+u;for(let e=0;e!==s;e++){let t=o[d+e+s],n=o[d+e+a]*c,i=o[p+e+s],l=o[p+e]*c;r[e]=y*t+b*n+m*i+v*l}return r}}let eg=new d._fP;class ew extends eb{interpolate_(e,t,n,i){let r=super.interpolate_(e,t,n,i);return eg.fromArray(r).normalize().toArray(r),r}}let ek={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},ex={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},eT={9728:d.TyD,9729:d.wem,9984:d.YLQ,9985:d.qyh,9986:d.aH4,9987:d.D1R},eR={33071:d.uWy,33648:d.OoA,10497:d.rpg},eA={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},eE={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},eS={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},eP={CUBICSPLINE:void 0,LINEAR:d.NMF,STEP:d.Syv},eM={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function eO(e,t,n){for(let i in n.extensions)void 0===e[i]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[i]=n.extensions[i])}function e_(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function eI(e){let t="",n=Object.keys(e).sort();for(let i=0,r=n.length;i<r;i++)t+=n[i]+":"+e[n[i]]+";";return t}function eC(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}let eN=new d.yGw;class ej{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new Y,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let n=!1,i=!1,r=-1;"undefined"!=typeof navigator&&(n=!0===/^((?!chrome|android).)*safari/i.test(navigator.userAgent),r=(i=navigator.userAgent.indexOf("Firefox")>-1)?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),"undefined"==typeof createImageBitmap||n||i&&r<98?this.textureLoader=new d.dpR(this.options.manager):this.textureLoader=new d.QRU(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new d.hH6(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){let n=this,i=this.json,r=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(e){return e._markDefs&&e._markDefs()}),Promise.all(this._invokeAll(function(e){return e.beforeRoot&&e.beforeRoot()})).then(function(){return Promise.all([n.getDependencies("scene"),n.getDependencies("animation"),n.getDependencies("camera")])}).then(function(t){let o={scene:t[0][i.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:i.asset,parser:n,userData:{}};return eO(r,o,i),e_(o,i),Promise.all(n._invokeAll(function(e){return e.afterRoot&&e.afterRoot(o)})).then(function(){e(o)})}).catch(t)}_markDefs(){let e=this.json.nodes||[],t=this.json.skins||[],n=this.json.meshes||[];for(let n=0,i=t.length;n<i;n++){let i=t[n].joints;for(let t=0,n=i.length;t<n;t++)e[i[t]].isBone=!0}for(let t=0,i=e.length;t<i;t++){let i=e[t];void 0!==i.mesh&&(this._addNodeRef(this.meshCache,i.mesh),void 0!==i.skin&&(n[i.mesh].isSkinnedMesh=!0)),void 0!==i.camera&&this._addNodeRef(this.cameraCache,i.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,n){if(e.refs[t]<=1)return n;let i=n.clone(),r=(e,t)=>{let n=this.associations.get(e);for(let[i,o]of(null!=n&&this.associations.set(t,n),e.children.entries()))r(o,t.children[i])};return r(n,i),i.name+="_instance_"+e.uses[t]++,i}_invokeOne(e){let t=Object.values(this.plugins);t.push(this);for(let n=0;n<t.length;n++){let i=e(t[n]);if(i)return i}return null}_invokeAll(e){let t=Object.values(this.plugins);t.unshift(this);let n=[];for(let i=0;i<t.length;i++){let r=e(t[i]);r&&n.push(r)}return n}getDependency(e,t){let n=e+":"+t,i=this.cache.get(n);if(!i){switch(e){case"scene":i=this.loadScene(t);break;case"node":i=this._invokeOne(function(e){return e.loadNode&&e.loadNode(t)});break;case"mesh":i=this._invokeOne(function(e){return e.loadMesh&&e.loadMesh(t)});break;case"accessor":i=this.loadAccessor(t);break;case"bufferView":i=this._invokeOne(function(e){return e.loadBufferView&&e.loadBufferView(t)});break;case"buffer":i=this.loadBuffer(t);break;case"material":i=this._invokeOne(function(e){return e.loadMaterial&&e.loadMaterial(t)});break;case"texture":i=this._invokeOne(function(e){return e.loadTexture&&e.loadTexture(t)});break;case"skin":i=this.loadSkin(t);break;case"animation":i=this._invokeOne(function(e){return e.loadAnimation&&e.loadAnimation(t)});break;case"camera":i=this.loadCamera(t);break;default:if(!(i=this._invokeOne(function(n){return n!=this&&n.getDependency&&n.getDependency(e,t)})))throw Error("Unknown type: "+e)}this.cache.add(n,i)}return i}getDependencies(e){let t=this.cache.get(e);if(!t){let n=this,i=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(i.map(function(t,i){return n.getDependency(e,i)})),this.cache.add(e,t)}return t}loadBuffer(e){let t=this.json.buffers[e],n=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[Z.KHR_BINARY_GLTF].body);let i=this.options;return new Promise(function(e,r){n.load(d.Zp0.resolveURL(t.uri,i.path),e,void 0,function(){r(Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){let t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(e){let n=t.byteLength||0,i=t.byteOffset||0;return e.slice(i,i+n)})}loadAccessor(e){let t=this,n=this.json,i=this.json.accessors[e];if(void 0===i.bufferView&&void 0===i.sparse){let e=eA[i.type],t=ex[i.componentType],n=!0===i.normalized,r=new t(i.count*e);return Promise.resolve(new d.TlE(r,e,n))}let r=[];return void 0!==i.bufferView?r.push(this.getDependency("bufferView",i.bufferView)):r.push(null),void 0!==i.sparse&&(r.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),r.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(r).then(function(e){let r,o;let s=e[0],a=eA[i.type],l=ex[i.componentType],c=l.BYTES_PER_ELEMENT,u=c*a,h=i.byteOffset||0,f=void 0!==i.bufferView?n.bufferViews[i.bufferView].byteStride:void 0,p=!0===i.normalized;if(f&&f!==u){let e=Math.floor(h/f),n="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+e+":"+i.count,u=t.cache.get(n);u||(r=new l(s,e*f,i.count*f/c),u=new d.vpT(r,f/c),t.cache.add(n,u)),o=new d.kB5(u,a,h%f/c,p)}else r=null===s?new l(i.count*a):new l(s,h,i.count*a),o=new d.TlE(r,a,p);if(void 0!==i.sparse){let t=eA.SCALAR,n=ex[i.sparse.indices.componentType],r=i.sparse.indices.byteOffset||0,c=i.sparse.values.byteOffset||0,u=new n(e[1],r,i.sparse.count*t),h=new l(e[2],c,i.sparse.count*a);null!==s&&(o=new d.TlE(o.array.slice(),o.itemSize,o.normalized));for(let e=0,t=u.length;e<t;e++){let t=u[e];if(o.setX(t,h[e*a]),a>=2&&o.setY(t,h[e*a+1]),a>=3&&o.setZ(t,h[e*a+2]),a>=4&&o.setW(t,h[e*a+3]),a>=5)throw Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return o})}loadTexture(e){let t=this.json,n=this.options,i=t.textures[e],r=i.source,o=t.images[r],s=this.textureLoader;if(o.uri){let e=n.manager.getHandler(o.uri);null!==e&&(s=e)}return this.loadTextureImage(e,r,s)}loadTextureImage(e,t,n){let i=this,r=this.json,o=r.textures[e],s=r.images[t],a=(s.uri||s.bufferView)+":"+o.sampler;if(this.textureCache[a])return this.textureCache[a];let l=this.loadImageSource(t,n).then(function(t){t.flipY=!1,t.name=o.name||s.name||"",""===t.name&&"string"==typeof s.uri&&!1===s.uri.startsWith("data:image/")&&(t.name=s.uri);let n=r.samplers||{},a=n[o.sampler]||{};return t.magFilter=eT[a.magFilter]||d.wem,t.minFilter=eT[a.minFilter]||d.D1R,t.wrapS=eR[a.wrapS]||d.rpg,t.wrapT=eR[a.wrapT]||d.rpg,i.associations.set(t,{textures:e}),t}).catch(function(){return null});return this.textureCache[a]=l,l}loadImageSource(e,t){let n=this.json,i=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then(e=>e.clone());let r=n.images[e],o=self.URL||self.webkitURL,s=r.uri||"",a=!1;if(void 0!==r.bufferView)s=this.getDependency("bufferView",r.bufferView).then(function(e){a=!0;let t=new Blob([e],{type:r.mimeType});return s=o.createObjectURL(t)});else if(void 0===r.uri)throw Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");let l=Promise.resolve(s).then(function(e){return new Promise(function(n,r){let o=n;!0===t.isImageBitmapLoader&&(o=function(e){let t=new d.xEZ(e);t.needsUpdate=!0,n(t)}),t.load(d.Zp0.resolveURL(e,i.path),o,void 0,r)})}).then(function(e){var t;return!0===a&&o.revokeObjectURL(s),e.userData.mimeType=r.mimeType||((t=r.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":"image/png"),e}).catch(function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",s),e});return this.sourceCache[e]=l,l}assignTexture(e,t,n,i){let r=this;return this.getDependency("texture",n.index).then(function(o){if(!o)return null;if(void 0!==n.texCoord&&n.texCoord>0&&((o=o.clone()).channel=n.texCoord),r.extensions[Z.KHR_TEXTURE_TRANSFORM]){let e=void 0!==n.extensions?n.extensions[Z.KHR_TEXTURE_TRANSFORM]:void 0;if(e){let t=r.associations.get(o);o=r.extensions[Z.KHR_TEXTURE_TRANSFORM].extendTexture(o,e),r.associations.set(o,t)}}return void 0!==i&&(o.colorSpace=i),e[t]=o,o})}assignFinalMaterial(e){let t=e.geometry,n=e.material,i=void 0===t.attributes.tangent,r=void 0!==t.attributes.color,o=void 0===t.attributes.normal;if(e.isPoints){let e="PointsMaterial:"+n.uuid,t=this.cache.get(e);t||(t=new d.UY4,d.F5T.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,t.sizeAttenuation=!1,this.cache.add(e,t)),n=t}else if(e.isLine){let e="LineBasicMaterial:"+n.uuid,t=this.cache.get(e);t||(t=new d.nls,d.F5T.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,this.cache.add(e,t)),n=t}if(i||r||o){let e="ClonedMaterial:"+n.uuid+":";i&&(e+="derivative-tangents:"),r&&(e+="vertex-colors:"),o&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=n.clone(),r&&(t.vertexColors=!0),o&&(t.flatShading=!0),i&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(n))),n=t}e.material=n}getMaterialType(){return d.Wid}loadMaterial(e){let t;let n=this,i=this.json,r=this.extensions,o=i.materials[e],s={},a=o.extensions||{},l=[];if(a[Z.KHR_MATERIALS_UNLIT]){let e=r[Z.KHR_MATERIALS_UNLIT];t=e.getMaterialType(),l.push(e.extendParams(s,o,n))}else{let i=o.pbrMetallicRoughness||{};if(s.color=new d.Ilk(1,1,1),s.opacity=1,Array.isArray(i.baseColorFactor)){let e=i.baseColorFactor;s.color.setRGB(e[0],e[1],e[2],d.GUF),s.opacity=e[3]}void 0!==i.baseColorTexture&&l.push(n.assignTexture(s,"map",i.baseColorTexture,d.KI_)),s.metalness=void 0!==i.metallicFactor?i.metallicFactor:1,s.roughness=void 0!==i.roughnessFactor?i.roughnessFactor:1,void 0!==i.metallicRoughnessTexture&&(l.push(n.assignTexture(s,"metalnessMap",i.metallicRoughnessTexture)),l.push(n.assignTexture(s,"roughnessMap",i.metallicRoughnessTexture))),t=this._invokeOne(function(t){return t.getMaterialType&&t.getMaterialType(e)}),l.push(Promise.all(this._invokeAll(function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,s)})))}!0===o.doubleSided&&(s.side=d.ehD);let c=o.alphaMode||eM.OPAQUE;if(c===eM.BLEND?(s.transparent=!0,s.depthWrite=!1):(s.transparent=!1,c===eM.MASK&&(s.alphaTest=void 0!==o.alphaCutoff?o.alphaCutoff:.5)),void 0!==o.normalTexture&&t!==d.vBJ&&(l.push(n.assignTexture(s,"normalMap",o.normalTexture)),s.normalScale=new d.FM8(1,1),void 0!==o.normalTexture.scale)){let e=o.normalTexture.scale;s.normalScale.set(e,e)}if(void 0!==o.occlusionTexture&&t!==d.vBJ&&(l.push(n.assignTexture(s,"aoMap",o.occlusionTexture)),void 0!==o.occlusionTexture.strength&&(s.aoMapIntensity=o.occlusionTexture.strength)),void 0!==o.emissiveFactor&&t!==d.vBJ){let e=o.emissiveFactor;s.emissive=new d.Ilk().setRGB(e[0],e[1],e[2],d.GUF)}return void 0!==o.emissiveTexture&&t!==d.vBJ&&l.push(n.assignTexture(s,"emissiveMap",o.emissiveTexture,d.KI_)),Promise.all(l).then(function(){let i=new t(s);return o.name&&(i.name=o.name),e_(i,o),n.associations.set(i,{materials:e}),o.extensions&&eO(r,i,o),i})}createUniqueName(e){let t=d.iUV.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){let t=this,n=this.extensions,i=this.primitiveCache,r=[];for(let o=0,s=e.length;o<s;o++){let s=e[o],a=function(e){let t;let n=e.extensions&&e.extensions[Z.KHR_DRACO_MESH_COMPRESSION];if(t=n?"draco:"+n.bufferView+":"+n.indices+":"+eI(n.attributes):e.indices+":"+eI(e.attributes)+":"+e.mode,void 0!==e.targets)for(let n=0,i=e.targets.length;n<i;n++)t+=":"+eI(e.targets[n]);return t}(s),l=i[a];if(l)r.push(l.promise);else{let e;e=s.extensions&&s.extensions[Z.KHR_DRACO_MESH_COMPRESSION]?function(e){return n[Z.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then(function(n){return eL(n,e,t)})}(s):eL(new d.u9r,s,t),i[a]={primitive:s,promise:e},r.push(e)}}return Promise.all(r)}loadMesh(e){let t=this,n=this.json,i=this.extensions,r=n.meshes[e],o=r.primitives,s=[];for(let e=0,t=o.length;e<t;e++){var a;let t=void 0===o[e].material?(void 0===(a=this.cache).DefaultMaterial&&(a.DefaultMaterial=new d.Wid({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:d.Wl3})),a.DefaultMaterial):this.getDependency("material",o[e].material);s.push(t)}return s.push(t.loadGeometries(o)),Promise.all(s).then(function(n){let s=n.slice(0,n.length-1),a=n[n.length-1],l=[];for(let n=0,c=a.length;n<c;n++){let c;let u=a[n],h=o[n],f=s[n];if(h.mode===ek.TRIANGLES||h.mode===ek.TRIANGLE_STRIP||h.mode===ek.TRIANGLE_FAN||void 0===h.mode)!0===(c=!0===r.isSkinnedMesh?new d.TUv(u,f):new d.Kj0(u,f)).isSkinnedMesh&&c.normalizeSkinWeights(),h.mode===ek.TRIANGLE_STRIP?c.geometry=X(c.geometry,d.UlW):h.mode===ek.TRIANGLE_FAN&&(c.geometry=X(c.geometry,d.z$h));else if(h.mode===ek.LINES)c=new d.ejS(u,f);else if(h.mode===ek.LINE_STRIP)c=new d.x12(u,f);else if(h.mode===ek.LINE_LOOP)c=new d.blk(u,f);else if(h.mode===ek.POINTS)c=new d.woe(u,f);else throw Error("THREE.GLTFLoader: Primitive mode unsupported: "+h.mode);Object.keys(c.geometry.morphAttributes).length>0&&function(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let n=0,i=t.weights.length;n<i;n++)e.morphTargetInfluences[n]=t.weights[n];if(t.extras&&Array.isArray(t.extras.targetNames)){let n=t.extras.targetNames;if(e.morphTargetInfluences.length===n.length){e.morphTargetDictionary={};for(let t=0,i=n.length;t<i;t++)e.morphTargetDictionary[n[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}(c,r),c.name=t.createUniqueName(r.name||"mesh_"+e),e_(c,r),h.extensions&&eO(i,c,h),t.assignFinalMaterial(c),l.push(c)}for(let n=0,i=l.length;n<i;n++)t.associations.set(l[n],{meshes:e,primitives:n});if(1===l.length)return r.extensions&&eO(i,l[0],r),l[0];let c=new d.ZAu;r.extensions&&eO(i,c,r),t.associations.set(c,{meshes:e});for(let e=0,t=l.length;e<t;e++)c.add(l[e]);return c})}loadCamera(e){let t;let n=this.json.cameras[e],i=n[n.type];if(!i){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return"perspective"===n.type?t=new d.cPb(d.M8C.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):"orthographic"===n.type&&(t=new d.iKG(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),n.name&&(t.name=this.createUniqueName(n.name)),e_(t,n),Promise.resolve(t)}loadSkin(e){let t=this.json.skins[e],n=[];for(let e=0,i=t.joints.length;e<i;e++)n.push(this._loadNodeShallow(t.joints[e]));return void 0!==t.inverseBindMatrices?n.push(this.getDependency("accessor",t.inverseBindMatrices)):n.push(null),Promise.all(n).then(function(e){let n=e.pop(),i=[],r=[];for(let o=0,s=e.length;o<s;o++){let s=e[o];if(s){i.push(s);let e=new d.yGw;null!==n&&e.fromArray(n.array,16*o),r.push(e)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[o])}return new d.OdW(i,r)})}loadAnimation(e){let t=this.json,n=this,i=t.animations[e],r=i.name?i.name:"animation_"+e,o=[],s=[],a=[],l=[],c=[];for(let e=0,t=i.channels.length;e<t;e++){let t=i.channels[e],n=i.samplers[t.sampler],r=t.target,u=r.node,h=void 0!==i.parameters?i.parameters[n.input]:n.input,f=void 0!==i.parameters?i.parameters[n.output]:n.output;void 0!==r.node&&(o.push(this.getDependency("node",u)),s.push(this.getDependency("accessor",h)),a.push(this.getDependency("accessor",f)),l.push(n),c.push(r))}return Promise.all([Promise.all(o),Promise.all(s),Promise.all(a),Promise.all(l),Promise.all(c)]).then(function(e){let t=e[0],i=e[1],o=e[2],s=e[3],a=e[4],l=[];for(let e=0,r=t.length;e<r;e++){let r=t[e],c=i[e],u=o[e],h=s[e],f=a[e];if(void 0===r)continue;r.updateMatrix&&r.updateMatrix();let p=n._createAnimationTracks(r,c,u,h,f);if(p)for(let e=0;e<p.length;e++)l.push(p[e])}return new d.m7l(r,void 0,l)})}createNodeMesh(e){let t=this.json,n=this,i=t.nodes[e];return void 0===i.mesh?null:n.getDependency("mesh",i.mesh).then(function(e){let t=n._getNodeRef(n.meshCache,i.mesh,e);return void 0!==i.weights&&t.traverse(function(e){if(e.isMesh)for(let t=0,n=i.weights.length;t<n;t++)e.morphTargetInfluences[t]=i.weights[t]}),t})}loadNode(e){let t=this.json,n=t.nodes[e],i=this._loadNodeShallow(e),r=[],o=n.children||[];for(let e=0,t=o.length;e<t;e++)r.push(this.getDependency("node",o[e]));let s=void 0===n.skin?Promise.resolve(null):this.getDependency("skin",n.skin);return Promise.all([i,Promise.all(r),s]).then(function(e){let t=e[0],n=e[1],i=e[2];null!==i&&t.traverse(function(e){e.isSkinnedMesh&&e.bind(i,eN)});for(let e=0,i=n.length;e<i;e++)t.add(n[e]);return t})}_loadNodeShallow(e){let t=this.json,n=this.extensions,i=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];let r=t.nodes[e],o=r.name?i.createUniqueName(r.name):"",s=[],a=i._invokeOne(function(t){return t.createNodeMesh&&t.createNodeMesh(e)});return a&&s.push(a),void 0!==r.camera&&s.push(i.getDependency("camera",r.camera).then(function(e){return i._getNodeRef(i.cameraCache,r.camera,e)})),i._invokeAll(function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)}).forEach(function(e){s.push(e)}),this.nodeCache[e]=Promise.all(s).then(function(t){let s;if((s=!0===r.isBone?new d.N$j:t.length>1?new d.ZAu:1===t.length?t[0]:new d.Tme)!==t[0])for(let e=0,n=t.length;e<n;e++)s.add(t[e]);if(r.name&&(s.userData.name=r.name,s.name=o),e_(s,r),r.extensions&&eO(n,s,r),void 0!==r.matrix){let e=new d.yGw;e.fromArray(r.matrix),s.applyMatrix4(e)}else void 0!==r.translation&&s.position.fromArray(r.translation),void 0!==r.rotation&&s.quaternion.fromArray(r.rotation),void 0!==r.scale&&s.scale.fromArray(r.scale);return i.associations.has(s)||i.associations.set(s,{}),i.associations.get(s).nodes=e,s}),this.nodeCache[e]}loadScene(e){let t=this.extensions,n=this.json.scenes[e],i=this,r=new d.ZAu;n.name&&(r.name=i.createUniqueName(n.name)),e_(r,n),n.extensions&&eO(t,r,n);let o=n.nodes||[],s=[];for(let e=0,t=o.length;e<t;e++)s.push(i.getDependency("node",o[e]));return Promise.all(s).then(function(e){for(let t=0,n=e.length;t<n;t++)r.add(e[t]);return i.associations=(e=>{let t=new Map;for(let[e,n]of i.associations)(e instanceof d.F5T||e instanceof d.xEZ)&&t.set(e,n);return e.traverse(e=>{let n=i.associations.get(e);null!=n&&t.set(e,n)}),t})(r),r})}_createAnimationTracks(e,t,n,i,r){let o;let s=[],a=e.name?e.name:e.uuid,l=[];switch(eS[r.path]===eS.weights?e.traverse(function(e){e.morphTargetInfluences&&l.push(e.name?e.name:e.uuid)}):l.push(a),eS[r.path]){case eS.weights:o=d.dUE;break;case eS.rotation:o=d.iLg;break;case eS.position:case eS.scale:o=d.yC1;break;default:o=1===n.itemSize?d.dUE:d.yC1}let c=void 0!==i.interpolation?eP[i.interpolation]:d.NMF,u=this._getArrayFromAccessor(n);for(let e=0,n=l.length;e<n;e++){let n=new o(l[e]+"."+eS[r.path],t.array,u,c);"CUBICSPLINE"===i.interpolation&&this._createCubicSplineTrackInterpolant(n),s.push(n)}return s}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){let e=eC(t.constructor),n=new Float32Array(t.length);for(let i=0,r=t.length;i<r;i++)n[i]=t[i]*e;t=n}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){let t=this instanceof d.iLg?ew:eb;return new t(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function eL(e,t,n){let i=t.attributes,r=[];for(let t in i){let o=eE[t]||t.toLowerCase();o in e.attributes||r.push(function(t,i){return n.getDependency("accessor",t).then(function(t){e.setAttribute(i,t)})}(i[t],o))}if(void 0!==t.indices&&!e.index){let i=n.getDependency("accessor",t.indices).then(function(t){e.setIndex(t)});r.push(i)}return d.epp.workingColorSpace!==d.GUF&&"COLOR_0"in i&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${d.epp.workingColorSpace}" not supported.`),e_(e,t),!function(e,t,n){let i=t.attributes,r=new d.ZzF;if(void 0===i.POSITION)return;{let e=n.json.accessors[i.POSITION],t=e.min,o=e.max;if(void 0!==t&&void 0!==o){if(r.set(new d.Pa4(t[0],t[1],t[2]),new d.Pa4(o[0],o[1],o[2])),e.normalized){let t=eC(ex[e.componentType]);r.min.multiplyScalar(t),r.max.multiplyScalar(t)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}let o=t.targets;if(void 0!==o){let e=new d.Pa4,t=new d.Pa4;for(let i=0,r=o.length;i<r;i++){let r=o[i];if(void 0!==r.POSITION){let i=n.json.accessors[r.POSITION],o=i.min,s=i.max;if(void 0!==o&&void 0!==s){if(t.setX(Math.max(Math.abs(o[0]),Math.abs(s[0]))),t.setY(Math.max(Math.abs(o[1]),Math.abs(s[1]))),t.setZ(Math.max(Math.abs(o[2]),Math.abs(s[2]))),i.normalized){let e=eC(ex[i.componentType]);t.multiplyScalar(e)}e.max(t)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}r.expandByVector(e)}e.boundingBox=r;let s=new d.aLr;r.getCenter(s.center),s.radius=r.min.distanceTo(r.max)/2,e.boundingSphere=s}(e,t,n),Promise.all(r).then(function(){return void 0!==t.targets?function(e,t,n){let i=!1,r=!1,o=!1;for(let e=0,n=t.length;e<n;e++){let n=t[e];if(void 0!==n.POSITION&&(i=!0),void 0!==n.NORMAL&&(r=!0),void 0!==n.COLOR_0&&(o=!0),i&&r&&o)break}if(!i&&!r&&!o)return Promise.resolve(e);let s=[],a=[],l=[];for(let c=0,u=t.length;c<u;c++){let u=t[c];if(i){let t=void 0!==u.POSITION?n.getDependency("accessor",u.POSITION):e.attributes.position;s.push(t)}if(r){let t=void 0!==u.NORMAL?n.getDependency("accessor",u.NORMAL):e.attributes.normal;a.push(t)}if(o){let t=void 0!==u.COLOR_0?n.getDependency("accessor",u.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(s),Promise.all(a),Promise.all(l)]).then(function(t){let n=t[0],s=t[1],a=t[2];return i&&(e.morphAttributes.position=n),r&&(e.morphAttributes.normal=s),o&&(e.morphAttributes.color=a),e.morphTargetsRelative=!0,e})}(e,t.targets,n):e})}var eB=console.error;function eH(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:function(){};new W().load(e,function(e){e.scene.scale.set(y.R/.5,y.R/.5,y.R/.5),e.scene.matrixAutoUpdate=!1,e.scene.visible=n,e.scene.updateMatrix(),t.add(e.scene),i()},function(e){return console.log(e.loaded+" bytes loaded")},eB)}var eF=n("./src/view/tablegeometry.ts");function eU(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var eD=function(){var e,t;function n(){var e,t;!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,n),e="material",t=new d.nls({color:132,opacity:.15,transparent:!0}),e in this?Object.defineProperty(this,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):this[e]=t}return e=[{key:"generateLineSegments",value:function(){var e=this,t=[this.point(0,-11.13*y.R/.5),this.point(0,11.13*y.R/.5)],n=eF.H.X/4,i=eF.H.tableY+y.R;[1,2,3,-1,-2,-3].forEach(function(r){t.push(e.point(r*n,-i)),t.push(e.point(r*n,i))});var r=(eF.H.Y+y.R)/2,o=eF.H.tableX+y.R;[-1,0,1].forEach(function(n){t.push(e.point(-o,n*r)),t.push(e.point(o,n*r))});var s=new d.u9r().setFromPoints(t);return new d.ejS(s,this.material)}},{key:"point",value:function(e,t){var n=-(.485*y.R)/.5;return new d.Pa4(e,t,n)}}],eU(n.prototype,e),t&&eU(n,t),n}();function eG(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function ez(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var eK=function(){var e,t;function n(e,t){!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,n),ez(this,"pos",void 0),ez(this,"radius",void 0),this.pos=e,this.radius=t}return e=[{key:"bounce",value:function(e){var t=e.pos.clone().sub(this.pos).normalize(),n=t.dot(e.vel);return e.vel.addScaledVector(t,-2*y.e*n),Math.abs(n)}}],t=[{key:"willBounce",value:function(e,t){return t.distanceTo(e.pos)<y.R+e.radius}},{key:"findBouncing",value:function(e,t){var i=e.futurePosition(t);return eJ.knuckles.find(function(e){return n.willBounce(e,i)})}}],e&&eG(n.prototype,e),t&&eG(n,t),n}(),eV=n("./src/model/ball.ts");function eX(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function eW(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var eY=function(){var e,t;function n(e,t){!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,n),eW(this,"pos",void 0),eW(this,"radius",void 0),this.pos=e,this.radius=t}return e=[{key:"fall",value:function(e,t){return e.vel.z=-y.g*t,e.state=eV.Z.Falling,e.pocket=this,e.vel.length()}},{key:"updateFall",value:function(e,t){if(e.vel.addScaledVector(m.up,-(10*y.R)/.5*t*y.g),e.pos.z<-(2*y.R)/.5&&(e.pos.z+=d.M8C.randFloat(-y.R,.25*y.R),e.setStationary(),e.state=eV.Z.InPocket),e.pos.distanceTo(this.pos)>this.radius-y.R){var n=this.pos.clone().sub(e.pos).normalize().multiplyScalar(e.vel.length()*y.R);0>e.vel.dot(n)&&(e.vel.x=n.x,e.vel.y=n.y)}}}],t=[{key:"willFall",value:function(e,t){return t.distanceTo(e.pos)<e.radius}},{key:"findPocket",value:function(e,t,i){var r=t.futurePosition(i);return e.find(function(e){return n.willFall(e,r)})}}],e&&eX(n.prototype,e),t&&eX(n,t),n}();function eZ(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var eJ=function(){var e;function t(){!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,t)}return e=[{key:"scaleToRadius",value:function(e){t.PX=eF.H.tableX+1.6*e,t.PY=eF.H.tableY+1.6*e,t.knuckleInset=1.6*e/.5,t.knuckleRadius=.31*e/.5,t.middleKnuckleInset=1.385*e/.5,t.middleKnuckleRadius=.2*e/.5,t.cornerRadius=1.1*e/.5,t.middleRadius=.9*e/.5,t.pocketLayout(e),t.enumerateCenters(),t.enumerateKnuckles()}},{key:"enumerateKnuckles",value:function(){t.knuckles=[t.pockets.pocketNW.knuckleNE,t.pockets.pocketNW.knuckleSW,t.pockets.pocketN.knuckleNW,t.pockets.pocketN.knuckleNE,t.pockets.pocketS.knuckleSW,t.pockets.pocketS.knuckleSE,t.pockets.pocketNE.knuckleNW,t.pockets.pocketNE.knuckleSE,t.pockets.pocketSE.knuckleNE,t.pockets.pocketSE.knuckleSW,t.pockets.pocketSW.knuckleSE,t.pockets.pocketSW.knuckleNW]}},{key:"enumerateCenters",value:function(){t.pocketCenters=[t.pockets.pocketNW.pocket,t.pockets.pocketSW.pocket,t.pockets.pocketN.pocket,t.pockets.pocketS.pocket,t.pockets.pocketNE.pocket,t.pockets.pocketSE.pocket]}},{key:"pocketLayout",value:function(e){t.pockets={pocketNW:{pocket:new eY(new d.Pa4(-t.PX,t.PY,0),t.cornerRadius),knuckleNE:new eK(new d.Pa4(-eF.H.X+t.knuckleInset,eF.H.Y+t.knuckleRadius,0),t.knuckleRadius),knuckleSW:new eK(new d.Pa4(-eF.H.X-t.knuckleRadius,eF.H.Y-t.knuckleInset,0),t.knuckleRadius)},pocketN:{pocket:new eY(new d.Pa4(0,t.PY+.7*e/.5,0),t.middleRadius),knuckleNE:new eK(new d.Pa4(t.middleKnuckleInset,eF.H.Y+t.middleKnuckleRadius,0),t.middleKnuckleRadius),knuckleNW:new eK(new d.Pa4(-t.middleKnuckleInset,eF.H.Y+t.middleKnuckleRadius,0),t.middleKnuckleRadius)},pocketS:{pocket:new eY(new d.Pa4(0,-t.PY-.7*e/.5,0),t.middleRadius),knuckleSE:new eK(new d.Pa4(t.middleKnuckleInset,-eF.H.Y-t.middleKnuckleRadius,0),t.middleKnuckleRadius),knuckleSW:new eK(new d.Pa4(-t.middleKnuckleInset,-eF.H.Y-t.middleKnuckleRadius,0),t.middleKnuckleRadius)},pocketNE:{pocket:new eY(new d.Pa4(t.PX,t.PY,0),t.cornerRadius),knuckleNW:new eK(new d.Pa4(eF.H.X-t.knuckleInset,eF.H.Y+t.knuckleRadius,0),t.knuckleRadius),knuckleSE:new eK(new d.Pa4(eF.H.X+t.knuckleRadius,eF.H.Y-t.knuckleInset,0),t.knuckleRadius)},pocketSE:{pocket:new eY(new d.Pa4(t.PX,-t.PY,0),t.cornerRadius),knuckleNE:new eK(new d.Pa4(eF.H.X+t.knuckleRadius,-eF.H.Y+t.knuckleInset,0),t.knuckleRadius),knuckleSW:new eK(new d.Pa4(eF.H.X-t.knuckleInset,-eF.H.Y-t.knuckleRadius,0),t.knuckleRadius)},pocketSW:{pocket:new eY(new d.Pa4(-t.PX,-t.PY,0),t.cornerRadius),knuckleSE:new eK(new d.Pa4(-eF.H.X+t.knuckleInset,-eF.H.Y-t.knuckleRadius,0),t.knuckleRadius),knuckleNW:new eK(new d.Pa4(-eF.H.X-t.knuckleRadius,-eF.H.Y+t.knuckleInset,0),t.knuckleRadius)}}}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}(t,e),t}();function eq(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function eQ(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}eZ(eJ,"PX",void 0),eZ(eJ,"PY",void 0),eZ(eJ,"knuckleInset",void 0),eZ(eJ,"knuckleRadius",void 0),eZ(eJ,"middleKnuckleInset",void 0),eZ(eJ,"middleKnuckleRadius",void 0),eZ(eJ,"cornerRadius",void 0),eZ(eJ,"middleRadius",void 0),eZ(eJ,"pockets",void 0),eZ(eJ,"knuckles",void 0),eZ(eJ,"pocketCenters",void 0),eJ.scaleToRadius(y.R);var e$=function(){var e,t;function n(){!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,n),eQ(this,"logger",function(e){}),eQ(this,"cloth",new d.xoR({color:4478393,wireframe:!1,flatShading:!0,transparent:!1})),eQ(this,"cushion",new d.xoR({color:5531065,wireframe:!1,flatShading:!0,transparent:!1})),eQ(this,"pocket",new d.xoR({color:4478361,wireframe:!1,flatShading:!0,transparent:!0,opacity:.3}))}return e=[{key:"addToScene",value:function(e,t){var n=this,i=new d.cek(15790312,22);if(i.position.set(0,0,50*y.R),e.add(i),this.addCushions(e,t),t){eJ.knuckles.forEach(function(t){return n.knuckleCylinder(t,e)}),eJ.pocketCenters.forEach(function(t){return n.knuckleCylinder(t,e,n.pocket)});var r=eJ.pockets.pocketNW.pocket,o=eJ.pockets.pocketNW.knuckleNE;this.logger("knuckle-pocket gap = "+(r.pos.distanceTo(o.pos)-r.radius-o.radius))}}},{key:"knuckleCylinder",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.cloth;this.cylinder(e.pos,e.radius,.75*y.R/.5,t,n).position.setZ(-(.25*y.R)/.5/2)}},{key:"cylinder",value:function(e,t,n,i,r){var o=new d.fHI(t,t,n,16),s=new d.Kj0(o,r);return s.position.copy(e),s.geometry.applyMatrix4(new d.yGw().identity().makeRotationAxis(new d.Pa4(1,0,0),Math.PI/2)),i.add(s),s}},{key:"addCushions",value:function(e,t){var n=10*y.R/.5;this.plane(new d.Pa4(0,0,-y.R-n/2),2*eF.H.X,2*eF.H.Y,n,e,this.cloth);var i=1*y.R/.5,r=.75*y.R/.5,o=-(.25*y.R)/.5/2,s=eF.H.X,a=eF.H.Y,l=Math.abs(eJ.pockets.pocketNW.knuckleNE.pos.x-eJ.pockets.pocketN.knuckleNW.pos.x),c=Math.abs(eJ.pockets.pocketNW.knuckleSW.pos.y-eJ.pockets.pocketSW.knuckleNW.pos.y);t||(l=2*eF.H.Y,c=2*eF.H.Y+4*y.R),this.plane(new d.Pa4(s+i/2,0,o),i,c,r,e),this.plane(new d.Pa4(-s-i/2,0,o),i,c,r,e),this.plane(new d.Pa4(-s/2,a+i/2,o),l,i,r,e),this.plane(new d.Pa4(-s/2,-a-i/2,o),l,i,r,e),this.plane(new d.Pa4(s/2,a+i/2,o),l,i,r,e),this.plane(new d.Pa4(s/2,-a-i/2,o),l,i,r,e)}},{key:"plane",value:function(e,t,n,i,r){var o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:this.cushion,s=new d.DvJ(t,n,i),a=new d.Kj0(s,o);a.receiveShadow=!0,a.position.copy(e),r.add(a)}}],eq(n.prototype,e),t&&eq(n,t),n}();function e0(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function e1(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var e2=function(){var e,t;function n(e,t,i,r){!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,n),e1(this,"scene",new d.xsS),e1(this,"renderer",void 0),e1(this,"camera",void 0),e1(this,"windowWidth",1),e1(this,"windowHeight",1),e1(this,"element",void 0),e1(this,"table",void 0),e1(this,"loadAssets",!0),e1(this,"ballToCheck",0),this.element=e,this.loadAssets=r,this.table=i,this.renderer=function(e){if("undefined"==typeof process){var t=new d.CP7({antialias:!1});return t.shadowMap.enabled=!1,t.autoClear=!1,t.setSize(e.offsetWidth,e.offsetHeight),t.setPixelRatio(.75*window.devicePixelRatio),e.appendChild(t.domElement),t}}(e),this.camera=new w(e?e.offsetWidth/e.offsetHeight:1),this.addTable(t)}return e=[{key:"update",value:function(e,t){this.camera.update(e,t)}},{key:"sizeChanged",value:function(){var e,t;return this.windowWidth!=(null===(e=this.element)||void 0===e?void 0:e.offsetWidth)||this.windowHeight!=(null===(t=this.element)||void 0===t?void 0:t.offsetHeight)}},{key:"updateSize",value:function(){if(this.sizeChanged()){var e,t;return this.windowWidth=null===(e=this.element)||void 0===e?void 0:e.offsetWidth,this.windowHeight=null===(t=this.element)||void 0===t?void 0:t.offsetHeight,!0}return!1}},{key:"render",value:function(){this.isInMotionNotVisible()&&this.camera.suggestMode(this.camera.topView),this.renderCamera(this.camera)}},{key:"renderCamera",value:function(e){var t;if(this.updateSize()){var n,i,r,o,s=this.windowWidth,a=this.windowHeight;null===(n=this.renderer)||void 0===n||n.setSize(s,a),null===(i=this.renderer)||void 0===i||i.setViewport(0,0,s,a),null===(r=this.renderer)||void 0===r||r.setScissor(0,0,s,a),null===(o=this.renderer)||void 0===o||o.setScissorTest(!0),e.camera.aspect=s/a}e.camera.updateProjectionMatrix(),null===(t=this.renderer)||void 0===t||t.render(this.scene,e.camera)}},{key:"addTable",value:function(e){this.scene.add(new d.Mig(5329491,.3)),this.scene.add(new eD().generateLineSegments()),this.loadAssets?(eH("models/background.gltf",this.scene,!0),eH(this.table.hasPockets?"models/p8.min.gltf":"models/threecushion.min.gltf",this.scene,!0,e)):(new e$().addToScene(this.scene,this.table.hasPockets),setTimeout(function(){e()},10))}},{key:"isInMotionNotVisible",value:function(){var e=this.viewFrustrum(),t=this.table.balls[this.ballToCheck++%this.table.balls.length];return t.inMotion()&&!e.intersectsObject(t.ballmesh.mesh)}},{key:"viewFrustrum",value:function(){var e=this.camera.camera,t=new d.iWj;return t.setFromProjectionMatrix(new d.yGw().multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse)),t}}],e0(n.prototype,e),t&&e0(n,t),n}(),e4=n("./src/events/watchevent.ts");n("./src/events/beginevent.ts");var e3=n("./src/events/aimevent.ts"),e5=n("./src/events/hitevent.ts"),e8=n("./src/events/input.ts");function e6(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}n("./src/events/abortevent.ts");var e9=function(){var e;function t(e){var n,i;!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,t),i=void 0,(n="container")in this?Object.defineProperty(this,n,{value:i,enumerable:!0,configurable:!0,writable:!0}):this[n]=i,this.container=e}return e6(t.prototype,[{key:"handleInput",value:function(e){return this}},{key:"handleBegin",value:function(e){return this}},{key:"handleBreak",value:function(e){return this}},{key:"handleAim",value:function(e){return this}},{key:"handleHit",value:function(e){return this}},{key:"handleAbort",value:function(e){return this}},{key:"handleWatch",value:function(e){return this}},{key:"handlePlaceBall",value:function(e){return this}},{key:"handleStationary",value:function(e){return this}},{key:"handleChat",value:function(e){return this}},{key:"handleRejoin",value:function(e){return this}},{key:"onFirst",value:function(){}}]),e&&e6(t,e),t}();function e7(e){return(e7=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function te(e,t){return(te=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var tt=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&te(e,t)}(i,e);var t,n=(t=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,n,r=e7(i);if(t){var o=e7(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return(e=n)&&("object"==(e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e)||"function"==typeof e)?e:function(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this)});function i(){return!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,i),n.apply(this,arguments)}return i}(e9);function tn(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e.Pot="Pot",e.Cushion="Cushion",e.Collision="Collision",e.Hit="Hit"}(a||(a={}));var ti=function(){var e;function t(e,n,i,r){!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,t),tn(this,"type",void 0),tn(this,"timestamp",void 0),tn(this,"ballA",null),tn(this,"ballB",null),tn(this,"incidentSpeed",void 0),this.type=e,this.ballA=n,this.ballB=i,this.incidentSpeed=r,this.timestamp=Date.now()}return e=[{key:"pot",value:function(e,n){return new t("Pot",e,e,n)}},{key:"cushion",value:function(e,n){return new t("Cushion",e,e,n)}},{key:"collision",value:function(e,n,i){return new t("Collision",e,n,i)}},{key:"hit",value:function(e,n){return new t("Hit",e,e,n)}},{key:"isCueBallPotted",value:function(e,t){return t.some(function(t){return"Pot"==t.type&&t.ballA===e})}},{key:"isBallPottedNoFoul",value:function(e,n){return n.some(function(e){return"Pot"==e.type&&null!==e.ballA})&&!t.isCueBallPotted(e,n)}},{key:"potCount",value:function(e){return e.filter(function(e){return"Pot"==e.type}).length}},{key:"isThreeCushionPoint",value:function(e,n){n=t.cueBallFirst(e,n).filter(function(t){return t.ballA===e});var i=new Set,r=0,o=!0,s=!1,a=void 0;try{for(var l,c=n[Symbol.iterator]();!(o=(l=c.next()).done);o=!0){var u=l.value;if("Cushion"===u.type&&r++,"Collision"===u.type&&(i.add(u.ballB),2===i.size))return r>=3}}catch(e){s=!0,a=e}finally{try{o||null==c.return||c.return()}finally{if(s)throw a}}return!1}},{key:"cueBallFirst",value:function(e,t){return t.forEach(function(t){"Collision"===t.type&&t.ballB===e&&(t.ballB=t.ballA,t.ballA=e)}),t}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}(t,e),t}();function tr(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function to(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function ts(e){return(ts=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ta(e,t){return(ta=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var tl=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ta(e,t)}(o,e);var t,n,i,r=(t=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,n,i=ts(o);if(t){var r=ts(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return(e=n)&&("object"==(e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e)||"function"==typeof e)?e:tr(this)});function o(){var e,t,n;return!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,o),e=r.apply(this,arguments),(n="scale")in(t=tr(e))?Object.defineProperty(t,n,{value:.001,enumerable:!0,configurable:!0,writable:!0}):t[n]=.001,e}return n=[{key:"handleAbort",value:function(e){return new tt(this.container)}},{key:"handleChat",value:function(e){var t=e.sender?"".concat(e.sender,":"):"",n="".concat(t," ").concat(e.message);return this.container.chat.showMessage(n),this}},{key:"hit",value:function(){this.container.table.outcome=[ti.hit(this.container.table.cueball,this.container.table.cue.aim.power)],this.container.table.hit(),this.container.view.camera.suggestMode(this.container.view.camera.aimView),this.container.table.cue.showHelper(!1)}},{key:"commonKeyHandler",value:function(e){var t,n=this.container.table.cue,i=e.t*this.scale;switch(e.key){case"ArrowLeft":return n.rotateAim(-i),!0;case"ArrowRight":return n.rotateAim(i),!0;case"ArrowDown":return n.adjustSpin(new d.Pa4(0,-i)),!0;case"ArrowUp":return n.adjustSpin(new d.Pa4(0,i)),!0;case"ShiftArrowLeft":return n.adjustSpin(new d.Pa4(i,0)),!0;case"ShiftArrowRight":return n.adjustSpin(new d.Pa4(-i,0)),!0;case"KeyPUp":return t=this.container.view.scene,new T().parse(t,function(e){var t;console.log(e),(t=document.createElement("a")).setAttribute("href","data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(e))),t.setAttribute("download","scene.gltf"),document.body.appendChild(t),t.click(),t.remove()},eB),!0;case"KeyHUp":return n.toggleHelper(),!0;case"movementXUp":return n.rotateAim(2*i),!0;case"movementYUp":case"NumpadSubtract":return this.container.view.camera.adjustHeight(-(10*i)),!0;case"NumpadAdd":return this.container.view.camera.adjustHeight(10*i),!0;case"KeyOUp":return this.container.view.camera.toggleMode(),!0;case"KeyDUp":return this.togglePanel(),!0;default:return!1}}},{key:"togglePanel",value:function(){this.container.sliders.toggleVisibility(),this.container.table.showSpin(!0),this.container.table.showTraces(!0),"object"!=typeof process&&console.log(this.container.table.serialise())}}],to(o.prototype,n),i&&to(o,i),o}(e9);function tc(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function tu(e){return(tu=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function th(e,t){return(th=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var tf=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&th(e,t)}(o,e);var t,n,i,r=(t=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,n,i=tu(o);if(t){var r=tu(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return(e=n)&&("object"==(e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e)||"function"==typeof e)?e:function(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this)});function o(e){var t;return!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,o),(t=r.call(this,e)).hit(),t}return n=[{key:"handleStationary",value:function(e){var t=this.container.table.outcome;return this.container.recoder.updateBreak(t),this.container.rules.update(t)}},{key:"handleInput",value:function(e){return this.commonKeyHandler(e),this}}],tc(o.prototype,n),i&&tc(o,i),o}(tl);function tp(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function td(e){return(td=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function tm(e,t){return(tm=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var tv=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&tm(e,t)}(o,e);var t,n,i,r=(t=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,n,i=td(o);if(t){var r=td(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return(e=n)&&("object"==(e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e)||"function"==typeof e)?e:function(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this)});function o(e){!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,o);var t,n=(t=r.call(this,e)).container.table;return n.cue.aimMode(),n.cue.showHelper(!0),n.cueball=t.container.rules.cueball,n.cue.moveTo(n.cueball.pos),t.container.view.camera.suggestMode(t.container.view.camera.aimView),t}return n=[{key:"handleInput",value:function(e){switch(e.key){case"Space":this.container.table.cue.adjustPower(e.t*this.scale*.7);break;case"SpaceUp":return this.playShot();default:if(!this.commonKeyHandler(e))return this}return this.container.sendEvent(this.container.table.cue.aim),this}},{key:"playShot",value:function(){this.container.table.cue.aim.round();var e=new e5.O(this.container.table.serialise());return this.container.sendEvent(e),this.container.recoder.record(e),new tf(this.container)}}],tp(o.prototype,n),i&&tp(o,i),o}(tl),ty=n("./src/events/breakevent.ts");function tb(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function tg(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function tw(e){return(tw=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function tk(e,t){return(tk=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var tx=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&tk(e,t)}(o,e);var t,n,i,r=(t=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,n,i=tw(o);if(t){var r=tw(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return(e=n)&&("object"==(e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e)||"function"==typeof e)?e:tb(this)});function o(e){var t,n,i,s;return!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,o),n=tb(t=r.call(this,e)),i="placescale",s=.02*y.R,i in n?Object.defineProperty(n,i,{value:s,enumerable:!0,configurable:!0,writable:!0}):n[i]=s,t.container.table.cue.moveTo(t.container.table.cueball.pos),t.container.table.cue.aim.power=0,t.container.view.camera.forceMode(t.container.view.camera.aimView),t}return n=[{key:"onFirst",value:function(){var e=this.container.table.cueball;e.onTable()||e.pos.copy(new d.Pa4(-(11*y.R)/.5,0,0)),e.setStationary(),e.updateMesh(0),this.container.table.cue.placeBallMode(),this.container.table.cue.showHelper(!1),this.container.table.cue.moveTo(this.container.table.cueball.pos),this.container.table.cue.aimInputs.setButtonText("Place\nBall"),this.container.rules.allowsPlaceBall()||this.container.inputQueue.push(new e8.I(1,"SpaceUp"))}},{key:"handleInput",value:function(e){var t=this.container.table.cueball.pos;switch(e.key){case"ArrowLeft":t.y=d.M8C.clamp((0,m.NM)(t.y+e.t*this.placescale),-eF.H.tableY,eF.H.tableY);break;case"ArrowRight":t.y=d.M8C.clamp((0,m.NM)(t.y-e.t*this.placescale),-eF.H.tableY,eF.H.tableY);break;case"movementXUp":t.y=d.M8C.clamp((0,m.NM)(t.y-e.t*this.placescale*2),-eF.H.tableY,eF.H.tableY);break;case"SpaceUp":return this.placed();default:this.commonKeyHandler(e)}return this.container.table.cue.moveTo(t),this.container.view.camera.forceMove(this.container.table.cue.aim),this.container.sendEvent(this.container.table.cue.aim),this}},{key:"placed",value:function(){return this.container.table.cue.aim.round(),this.container.table.cue.aimInputs.setButtonText("Hit"),this.container.sound.playNotify(),this.container.sendEvent(new ty.l(this.container.table.shortSerialise())),new tv(this.container)}}],tg(o.prototype,n),i&&tg(o,i),o}(tl);function tT(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function tR(e){return(tR=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function tA(e,t){return(tA=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var tE=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&tA(e,t)}(o,e);var t,n,i,r=(t=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,n,i=tR(o);if(t){var r=tR(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return(e=n)&&("object"==(e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e)||"function"==typeof e)?e:function(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this)});function o(e){var t;return!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,o),(t=r.call(this,e)).container.table.outcome=[],t.container.table.hit(),t}return n=[{key:"handleAim",value:function(e){return new tv(this.container)}},{key:"handlePlaceBall",value:function(e){return new tx(this.container)}},{key:"handleWatch",value:function(e){return new tO(this.container)}}],tT(o.prototype,n),i&&tT(o,i),o}(tl);function tS(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function tP(e){return(tP=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function tM(e,t){return(tM=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var tO=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&tM(e,t)}(o,e);var t,n,i,r=(t=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,n,i=tP(o);if(t){var r=tP(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return(e=n)&&("object"==(e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e)||"function"==typeof e)?e:function(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this)});function o(e){var t;return!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,o),(t=r.call(this,e)).container.table.cueball=t.container.rules.otherPlayersCueBall(),t.container.table.cue.moveTo(t.container.table.cueball.pos),t.container.view.camera.suggestMode(t.container.view.camera.topView),t}return n=[{key:"handleAim",value:function(e){return this.container.table.cue.aim=e,this.container.table.cueball.pos=e.pos,this}},{key:"handleHit",value:function(e){return this.container.table.updateFromSerialised(e.tablejson),new tE(this.container)}}],tS(o.prototype,n),i&&tS(o,i),o}(tl);function t_(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function tI(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function tC(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function tN(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function tj(e){return(tj=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function tL(e,t){return(tL=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function tB(e){return function(e){if(Array.isArray(e))return t_(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return t_(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return t_(e,t)}}(e)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var tH=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&tL(e,t)}(o,e);var t,n,i,r=(t=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,n,i=tj(o);if(t){var r=tj(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return(e=n)&&("object"==(e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e)||"function"==typeof e)?e:tI(this)});function o(e,t){var n,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1500;return!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,o),tN(tI(n=r.call(this,e)),"delay",void 0),tN(tI(n),"shots",void 0),tN(tI(n),"timer",void 0),n.shots=tB(t),n.delay=i,n.container.table.showTraces(!0),n}return n=[{key:"onFirst",value:function(){this.playNextShot(2*this.delay)}},{key:"playNextShot",value:function(e){var t=this,n=this.shots.shift(),i=e3.f.fromJson(n);this.container.table.cueball=this.container.table.balls[i.i],this.container.table.cueball.pos.copy(i.pos),this.container.table.cue.aim=i,this.container.table.cue.updateAimInput(),this.container.table.cue.t=1,this.container.view.camera.forceMode(this.container.view.camera.topView),clearTimeout(this.timer),this.timer=setTimeout(function(){t.container.eventQueue.push(new e5.O(t.container.table.cue.aim))},e)}},{key:"handleHit",value:function(e){return this.hit(),this}},{key:"handleStationary",value:function(e){var t=this;return this.shots.length>0&&setTimeout(function(){t.playNextShot(t.delay)},this.delay),this}},{key:"handleInput",value:function(e){return"KeyOUp"==e.key&&this.container.view.camera.toggleMode(),"KeyDUp"==e.key&&this.container.sliders.toggleVisibility(),this}},{key:"handleBreak",value:function(e){return e.init&&0==this.shots.length&&(this.container.table.updateFromShortSerialised(e.init),this.shots=tB(e.shots),this.playNextShot(this.delay),this.container.table.showSpin(!0)),this}}],tC(o.prototype,n),i&&tC(o,i),o}(tl);function tF(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function tU(e){return(tU=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function tD(e,t){return(tD=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var tG=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&tD(e,t)}(o,e);var t,n,i,r=(t=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,n,i=tU(o);if(t){var r=tU(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return(e=n)&&("object"==(e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e)||"function"==typeof e)?e:function(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this)});function o(){return!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,o),r.apply(this,arguments)}return n=[{key:"handleBegin",value:function(e){return this.container.chat.showMessage("Start"),this.container.sendEvent(new e4.g(this.container.table.serialise())),new tx(this.container)}},{key:"handleWatch",value:function(e){return this.container.chat.showMessage("Opponent to break"),this.container.rules.secondToPlay(),this.container.table.updateFromSerialised(e.json),new tO(this.container)}},{key:"handleBreak",value:function(e){return e.init?(this.container.table.updateFromShortSerialised(e.init),this.container.chat.showMessage("Replay"),new tH(this.container,e.shots)):new tx(this.container)}}],tF(o.prototype,n),i&&tF(o,i),o}(tl);function tz(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function tK(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var tV=function(){var e,t;function n(e){var t=this;!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,n),tK(this,"cueBallElement",void 0),tK(this,"cueTipElement",void 0),tK(this,"cuePowerElement",void 0),tK(this,"cueHitElement",void 0),tK(this,"container",void 0),tK(this,"ballWidth",void 0),tK(this,"ballHeight",void 0),tK(this,"tipRadius",void 0),tK(this,"mousemove",function(e){1===e.buttons&&t.adjustSpin(e)}),tK(this,"powerChanged",function(e){t.container.table.cue.setPower(t.cuePowerElement.value)}),tK(this,"hit",function(e){var n;t.container.table.cue.setPower(null===(n=t.cuePowerElement)||void 0===n?void 0:n.value),t.container.inputQueue.push(new e8.I(0,"SpaceUp"))}),tK(this,"mousewheel",function(e){t.cuePowerElement&&(t.cuePowerElement.value-=Math.sign(e.deltaY)/10,t.container.table.cue.setPower(t.cuePowerElement.value),t.container.lastEventTime=performance.now())}),this.container=e,this.cueBallElement=document.getElementById("cueBall"),this.cueTipElement=document.getElementById("cueTip"),this.cuePowerElement=document.getElementById("cuePower"),this.cueHitElement=document.getElementById("cueHit"),this.addListeners()}return e=[{key:"addListeners",value:function(){var e,t,n,i,r=this;null===(e=this.cueBallElement)||void 0===e||e.addEventListener("pointermove",this.mousemove),null===(t=this.cueBallElement)||void 0===t||t.addEventListener("click",function(e){r.adjustSpin(e)}),null===(n=this.cueHitElement)||void 0===n||n.addEventListener("click",this.hit),null===(i=this.cuePowerElement)||void 0===i||i.addEventListener("change",this.powerChanged),document.addEventListener("dblclick",this.hit),document.addEventListener("wheel",this.mousewheel)}},{key:"setButtonText",value:function(e){this.cueHitElement&&(this.cueHitElement.innerText=e)}},{key:"readDimensions",value:function(){var e,t,n;this.ballWidth=null===(e=this.cueBallElement)||void 0===e?void 0:e.offsetWidth,this.ballHeight=null===(t=this.cueBallElement)||void 0===t?void 0:t.offsetHeight,this.tipRadius=(null===(n=this.cueTipElement)||void 0===n?void 0:n.offsetWidth)/2}},{key:"adjustSpin",value:function(e){this.readDimensions(),this.container.table.cue.setSpin(new d.Pa4(-(e.offsetX-this.ballWidth/2)/this.ballWidth,-(e.offsetY-this.ballHeight/2)/this.ballHeight)),this.container.lastEventTime=performance.now()}},{key:"updateVisualState",value:function(e,t){this.readDimensions();var n,i=null===(n=this.cueTipElement)||void 0===n?void 0:n.style;i&&(i.left=(-e+.5)*this.ballWidth-this.tipRadius+"px",i.top=(-t+.5)*this.ballHeight-this.tipRadius+"px")}},{key:"updatePowerSlider",value:function(e){var t;e>0&&(null===(t=this.cuePowerElement)||void 0===t?void 0:t.value)&&(this.cuePowerElement.value=e)}}],tz(n.prototype,e),t&&tz(n,t),n}();function tX(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function tW(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var tY=function(){var e,t;function n(e,t){!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,n),tW(this,"listener",void 0),tW(this,"audioLoader",void 0),tW(this,"ballcollision",void 0),tW(this,"cue",void 0),tW(this,"cushion",void 0),tW(this,"pot",void 0),tW(this,"success",void 0),tW(this,"lastOutcomeTime",0),tW(this,"loadAssets",void 0),this.loadAssets=t,t&&(this.listener=new d.SJI,this.audioLoader=new d.mTL,e.add(this.listener),this.ballcollision=new d.BbS(this.listener),this.load("sounds/ballcollision.ogg",this.ballcollision),this.cue=new d.BbS(this.listener),this.load("sounds/cue.ogg",this.cue),this.cushion=new d.BbS(this.listener),this.load("sounds/cushion.ogg",this.cushion),this.pot=new d.BbS(this.listener),this.load("sounds/pot.ogg",this.pot),this.success=new d.BbS(this.listener),this.load("sounds/success.ogg",this.success))}return e=[{key:"load",value:function(e,t){this.audioLoader.load(e,function(e){t.setBuffer(e),t.setLoop(!1)},function(e){},function(e){})}},{key:"play",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(this.loadAssets){var i,r,o=d.Hmr.getContext();if((null==o?void 0:o.state)==="suspended"){(null===(r=navigator)||void 0===r?void 0:null===(i=r.userActivation)||void 0===i?void 0:i.hasBeenActive)&&o.resume();return}e.setVolume(t),e.isPlaying&&e.stop(),e.play(d.M8C.randFloat(0,.01)),e.setDetune(n)}}},{key:"outcomeToSound",value:function(e){"Collision"===e.type&&this.play(this.ballcollision,e.incidentSpeed/80,5*e.incidentSpeed),"Pot"===e.type&&this.play(this.pot,e.incidentSpeed/10,-1e3+10*e.incidentSpeed),"Cushion"===e.type&&this.play(this.cushion,e.incidentSpeed/70),"Hit"===e.type&&this.play(this.cue,e.incidentSpeed/30)}},{key:"processOutcomes",value:function(e){var t=this;e.every(function(e){return!(e.timestamp>t.lastOutcomeTime)||(t.lastOutcomeTime=e.timestamp,t.outcomeToSound(e),!1)})}},{key:"playNotify",value:function(){this.play(this.pot,1)}},{key:"playSuccess",value:function(e){this.play(this.success,.1,100*e-2200)}}],tX(n.prototype,e),t&&tX(n,t),n}();function tZ(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}function tJ(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function tq(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var tQ=function(){var e;function t(e){var n,i=this;!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,t),tq(this,"chatoutput",void 0),tq(this,"chatInput",void 0),tq(this,"chatSend",void 0),tq(this,"chatInputText",void 0),tq(this,"send",void 0),tq(this,"sendClicked",function(e){var t,n;i.send(null===(t=i.chatInputText)||void 0===t?void 0:t.value),i.showMessage(null===(n=i.chatInputText)||void 0===n?void 0:n.value)}),this.chatoutput=document.getElementById("chatoutput"),this.chatInputText=document.getElementById("chatinputtext"),this.chatSend=document.getElementById("chatsend"),null===(n=this.chatSend)||void 0===n||n.addEventListener("click",this.sendClicked),this.send=e}return tJ(t.prototype,[{key:"showMessage",value:function(e){this.chatoutput&&(this.chatoutput.innerHTML+=e),this.updateScroll()}},{key:"updateScroll",value:function(){this.chatoutput&&(this.chatoutput.scrollTop=this.chatoutput.scrollHeight)}}]),e&&tJ(t,e),t}(),t$=n("./src/events/chatevent.ts");function t0(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function t1(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var t2=function(){var e,t;function n(e,t){!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,n),t1(this,"period",void 0),t1(this,"pending",null),t1(this,"sentTime",0),t1(this,"apply",function(e){}),this.period=e,this.apply=t}return e=[{key:"flush",value:function(){this.pending&&(this.apply(this.pending),this.pending=null)}},{key:"send",value:function(e){if(performance.now()>this.sentTime+this.period||e.type!==c.t.AIM){this.flush(),this.apply(e),this.sentTime=performance.now();return}this.pending=e}}],t0(n.prototype,e),t&&t0(n,t),n}(),t4=n("./src/view/sliders.ts");function t3(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function t5(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var t8=function(){var e,t;function n(e){!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,n),t5(this,"container",void 0),t5(this,"shots",[]),t5(this,"states",[]),t5(this,"breakStart",void 0),t5(this,"replayUrl",void 0),this.container=e}return e=[{key:"record",value:function(e){e.type===c.t.HIT&&(this.states.push(this.container.table.shortSerialise()),this.shots.push(e.tablejson.aim))}},{key:"replayGame",value:function(){return this.state(this.states[0],this.shots)}},{key:"replayLastShot",value:function(){var e=this.states.length-1;return this.state(this.states[e],[this.shots[e]])}},{key:"replayCurrentBreak",value:function(){if(void 0!==this.breakStart)return this.state(this.states[this.breakStart],this.shots.slice(this.breakStart))}},{key:"state",value:function(e,t){return{init:e,shots:t}}},{key:"updateBreak",value:function(e){var t=this.container.rules.isPartOfBreak(e),n=this.container.rules.isEndOfGame(e),i=ti.potCount(e);if(t||this.replayBreakLink(n),this.replayLastShotLink(t||n,i),n&&this.replayBreakLink(n),!t){this.breakStart=void 0;return}void 0===this.breakStart&&(this.breakStart=this.states.length-1)}},{key:"replayLastShotLink",value:function(e,t){var n="".repeat(t>1?t-1:0)+(e?"":""),i=JSON.stringify(this.replayLastShot());this.generateLink(n,i)}},{key:"replayBreakLink",value:function(e){var t=this.replayCurrentBreak();if(t&&(e||t.shots.pop(),1!==t.shots.length)){var n="break(".concat(t.shots.length,")"),i=JSON.stringify(t);this.generateLink(n,i)}}},{key:"generateLink",value:function(e,t){var n="".concat(this.replayUrl).concat(encodeURIComponent(t)),i='<a class="pill" target="_blank" href="'.concat(n,'">').concat(e,"</a>");this.container.eventQueue.push(new t$.s(null,"".concat(i)))}}],t3(n.prototype,e),t&&t3(n,t),n}(),t6=n("./src/events/placeballevent.ts"),t9=n("./src/model/physics/physics.ts"),t7=function(){var e;function t(){!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,t)}return e=[{key:"bounceAny",value:function(e,n){var i=!(arguments.length>2)||void 0===arguments[2]||arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t9.h_,o=e.futurePosition(n);if(t.willBounceLong(o,i)){var s=o.y>eF.H.tableY?-Math.PI/2:Math.PI/2;return t.bounceIn(s,e,r)}if(t.willBounceShort(o,i)){var a=o.x>eF.H.tableX?0:Math.PI;return t.bounceIn(a,e,r)}}},{key:"willBounceShort",value:function(e,n){return n?t.willBounceShortSegment(eJ.pockets.pocketNW.knuckleSW.pos.y,eJ.pockets.pocketSW.knuckleNW.pos.y,e):t.willBounceShortSegment(eF.H.Y,-eF.H.Y,e)}},{key:"willBounceLong",value:function(e,n){return n?t.willBounceLongSegment(eJ.pockets.pocketNW.knuckleNE.pos.x,eJ.pockets.pocketN.knuckleNW.pos.x,e)||t.willBounceLongSegment(eJ.pockets.pocketN.knuckleNE.pos.x,eJ.pockets.pocketNE.knuckleNW.pos.x,e):t.willBounceLongSegment(-eF.H.X,eF.H.X,e)}},{key:"willBounceLongSegment",value:function(e,t,n){return n.x>e&&n.x<t&&Math.abs(n.y)>eF.H.tableY}},{key:"willBounceShortSegment",value:function(e,t,n){return n.y>t&&n.y<e&&Math.abs(n.x)>eF.H.tableX}},{key:"bounceIn",value:function(e,t,n){var i=(0,t9.ZI)(e,t.vel,t.rvel,n);return t.vel.add(i.v),t.rvel.add(i.w),i.v.length()}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}(t,e),t}(),ne=function(){var e;function t(){!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,t)}return e=[{key:"willCollide",value:function(e,t,n){return(e.inMotion()||t.inMotion())&&e.onTable()&&t.onTable()&&e.futurePosition(n).distanceToSquared(t.futurePosition(n))<4*y.R*y.R}},{key:"collide",value:function(e,n){return t.updateVelocities(e,n)}},{key:"updateVelocities",value:function(e,t){var n=t.pos.clone().sub(e.pos).normalize(),i=n.dot(e.vel),r=n.dot(t.vel);return e.vel.addScaledVector(n,r).addScaledVector(n,-i),t.vel.addScaledVector(n,i).addScaledVector(n,-r),e.state=eV.Z.Sliding,t.state=eV.Z.Sliding,Math.abs(i)+Math.abs(r)}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}(t,e),t}(),nt=n("./src/view/cue.ts");function nn(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function ni(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var nr=function(){var e,t;function n(e){!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,n),ni(this,"balls",void 0),ni(this,"cue",new nt.N),ni(this,"pairs",void 0),ni(this,"outcome",[]),ni(this,"hasPockets",!0),ni(this,"cueball",void 0),ni(this,"cushionModel",t9.h_),this.cueball=e[0],this.initialiseBalls(e)}return e=[{key:"initialiseBalls",value:function(e){this.balls=e,this.pairs=[];for(var t=0;t<e.length;t++)for(var n=0;n<e.length;n++)t<n&&this.pairs.push({a:e[t],b:e[n]})}},{key:"updateBallMesh",value:function(e){this.balls.forEach(function(t){t.updateMesh(e)})}},{key:"advance",value:function(e){for(var t=0;!this.prepareAdvanceAll(e);)if(t++>100)throw Error("Depth exceeded resolving collisions");this.balls.forEach(function(t){t.update(e)})}},{key:"prepareAdvanceAll",value:function(e){var t=this;return this.pairs.every(function(n){return t.prepareAdvancePair(n.a,n.b,e)})&&this.balls.every(function(n){return t.prepareAdvanceToCushions(n,e)})}},{key:"prepareAdvancePair",value:function(e,t,n){if(ne.willCollide(e,t,n)){var i=ne.collide(e,t);return this.outcome.push(ti.collision(e,t,i)),!1}return!0}},{key:"prepareAdvanceToCushions",value:function(e,t){if(!e.onTable())return!0;var n=e.futurePosition(t);if(Math.abs(n.y)<eF.H.tableY&&Math.abs(n.x)<eF.H.tableX)return!0;var i=t7.bounceAny(e,t,this.hasPockets,this.cushionModel);if(i)return this.outcome.push(ti.cushion(e,i)),!1;var r=eK.findBouncing(e,t);if(r){var o=r.bounce(e);return this.outcome.push(ti.cushion(e,o)),!1}var s=eY.findPocket(eJ.pocketCenters,e,t);if(s){var a=s.fall(e,t);return this.outcome.push(ti.pot(e,a)),!1}return!0}},{key:"allStationary",value:function(){return this.balls.every(function(e){return!e.inMotion()||!e.onTable()})}},{key:"inPockets",value:function(){return this.balls.reduce(function(e,t){return t.onTable()?e:e+1},0)}},{key:"hit",value:function(){this.cue.hit(this.cueball),this.balls.forEach(function(e){e.ballmesh.trace.reset()})}},{key:"serialise",value:function(){return{balls:this.balls.map(function(e){return e.serialise()}),aim:this.cue.aim.copy()}}},{key:"updateFromSerialised",value:function(e){e.balls&&this.balls.forEach(function(t,n){return eV.e.updateFromSerialised(t,e.balls[n])}),e.aim&&(this.cue.aim=e3.f.fromJson(e.aim))}},{key:"shortSerialise",value:function(){return this.balls.map(function(e){return[e.pos.x,e.pos.y]}).reduce(function(e,t){return e.concat(t)},[])}},{key:"updateFromShortSerialised",value:function(e){this.balls.forEach(function(t,n){t.pos.x=e[2*n],t.pos.y=e[2*n+1],t.pos.z=0,t.state=eV.Z.Stationary})}},{key:"addToScene",value:function(e){this.balls.forEach(function(t){t.ballmesh.addToScene(e)}),e.add(this.cue.mesh),e.add(this.cue.helperMesh),e.add(this.cue.placerMesh)}},{key:"showTraces",value:function(e){this.balls.forEach(function(t){t.ballmesh.trace.line.visible=e,t.ballmesh.trace.reset()})}},{key:"showSpin",value:function(e){this.balls.forEach(function(t){t.ballmesh.spinAxisArrow.visible=e})}}],t=[{key:"fromSerialised",value:function(e){var t=new n(e.balls.map(function(e){return eV.e.fromSerialised(e)}));return t.updateFromSerialised(e),t}}],e&&nn(n.prototype,e),t&&nn(n,t),n}();function no(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var ns=function(){var e;function t(){!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,t)}return e=[{key:"jitter",value:function(e){return(0,m.wK)(e.clone().add(new d.Pa4(t.noise*(Math.random()-.5),t.noise*(Math.random()-.5),0)))}},{key:"cueBall",value:function(e){return new eV.e(e,16444375)}},{key:"diamond",value:function(){var e=new d.Pa4(0,t.gap,0),n=e.clone().applyAxisAngle(t.up,1*Math.PI/3),i=new d.Pa4(eF.H.tableX/2,0,0),r=[];return r.push(t.cueBall(t.spot)),r.push(new eV.e(t.jitter(i),14736950)),i.add(n),r.push(new eV.e(t.jitter(i),16751872)),i.sub(e),r.push(new eV.e(t.jitter(i),5380369)),i.add(n),r.push(new eV.e(t.jitter(i),5853696)),i.sub(e),r.push(new eV.e(t.jitter(i),16711680)),i.addScaledVector(e,2),r.push(new eV.e(t.jitter(i),328965)),i.add(n).sub(e),r.push(new eV.e(t.jitter(i),685250)),i.sub(e),r.push(new eV.e(t.jitter(i),553728)),i.add(n),r.push(new eV.e(t.jitter(i),4063388)),r}},{key:"three",value:function(){var e=[],n=(0,m.NM)(eF.H.X/2),i=(0,m.NM)(eF.H.Y/4);return e.push(t.cueBall(new d.Pa4(-n,-i,0))),e.push(new eV.e(new d.Pa4(-n,0,0),14736950)),e.push(new eV.e(new d.Pa4(n,0,0),16711680)),e}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}(t,e),t}();function na(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function nl(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}no(ns,"noise",.05*y.R/.5),no(ns,"gap",2*y.R+2*ns.noise),no(ns,"up",new d.Pa4(0,0,-1)),no(ns,"spot",new d.Pa4(-eF.H.X/2,0,0));var nc=function(){var e,t;function n(e){!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,n),nl(this,"container",void 0),nl(this,"cueball",void 0),this.container=e}return e=[{key:"table",value:function(){var e=new nr(this.rack());return this.cueball=e.cueball,e}},{key:"rack",value:function(){return ns.diamond()}},{key:"update",value:function(e){var t=this.container.table;return ti.isCueBallPotted(t.cueball,e)?(this.container.log("in off"),this.container.isSinglePlayer)?new tx(this.container):(this.container.sendEvent(new t6.I(m.bM,!0)),new tO(this.container)):ti.isBallPottedNoFoul(t.cueball,e)?(this.container.sound.playSuccess(t.inPockets()),this.container.sendEvent(new e4.g(t.serialise())),new tv(this.container)):(this.container.log("no pot"),this.container.sendEvent(t.cue.aim),this.container.isSinglePlayer)?(this.container.sendEvent(new e4.g(t.serialise())),new tv(this.container)):new tO(this.container)}},{key:"isPartOfBreak",value:function(e){return ti.isBallPottedNoFoul(this.container.table.cueball,e)}},{key:"isEndOfGame",value:function(e){return 1===this.container.table.balls.filter(function(e){return e.onTable()}).length}},{key:"otherPlayersCueBall",value:function(){return this.cueball}},{key:"secondToPlay",value:function(){}},{key:"allowsPlaceBall",value:function(){return!0}}],na(n.prototype,e),t&&na(n,t),n}();function nu(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function nh(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var nf=function(){var e,t;function n(e){!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,n),nh(this,"container",void 0),nh(this,"cueball",void 0),this.container=e}return e=[{key:"secondToPlay",value:function(){this.cueball=this.container.table.balls[1]}},{key:"table",value:function(){eF.H.tableX=49*y.R,eF.H.tableY=24*y.R,eF.H.X=eF.H.tableX+y.R,eF.H.Y=eF.H.tableY+y.R,v.c.zoomFactor=.92;var e=new nr(this.rack());return e.hasPockets=!1,this.cueball=e.cueball,e}},{key:"rack",value:function(){return ns.three()}},{key:"update",value:function(e){return ti.isThreeCushionPoint(this.cueball,e)?(this.container.sound.playSuccess(e.length/3),this.container.sendEvent(new e4.g(this.container.table.serialise())),new tv(this.container)):this.container.isSinglePlayer?(this.cueball=this.otherPlayersCueBall(),this.container.table.cue.aim.i=this.container.table.balls.indexOf(this.cueball),new tv(this.container)):(this.container.sendEvent(this.container.table.cue.aim),new tO(this.container))}},{key:"otherPlayersCueBall",value:function(){var e=this.container.table.balls;return this.cueball===e[0]?e[1]:e[0]}},{key:"isPartOfBreak",value:function(e){return ti.isThreeCushionPoint(this.cueball,e)}},{key:"isEndOfGame",value:function(e){return!1}},{key:"allowsPlaceBall",value:function(){return!1}}],nu(n.prototype,e),t&&nu(n,t),n}(),np=function(){var e;function t(){!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,t)}return e=[{key:"create",value:function(e,t){return"threecushion"===e?new nf(t):new nc(t)}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}(t,e),t}();function nd(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function nm(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var nv=function(){var e,t;function n(e){var t,i=this;!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,n),nm(this,"container",void 0),nm(this,"togglemenu",void 0),nm(this,"menu",void 0),this.container=e,this.menu=null===(t=document.getElementById("menu"))||void 0===t?void 0:t.style,this.togglemenu=this.getElement("togglemenu");var r=this.getElement("toggleview");this.togglemenu&&(this.togglemenu.onclick=function(e){i.toggleVisibility()},r.onclick=function(e){i.toggleView()})}return e=[{key:"toggleVisibility",value:function(){this.menu.display="flex"===this.menu.display?"none":"flex"}},{key:"toggleView",value:function(){this.container.view.camera.toggleMode(),this.container.lastEventTime=performance.now()}},{key:"replayMode",value:function(e){var t=this;this.togglemenu.innerHTML="share",this.togglemenu.onclick=function(n){!function(e,t){if("object"==typeof process)return t(e);fetch("https://gotiny.cc/api",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({input:e})}).then(function(e){return e.json()}).then(function(n){Array.isArray(n)&&"code"in n[0]?t("https://gotiny.cc/".concat(n[0].code)):(console.log("Could not shorten url:"),console.log(n),t(e))})}(e,function(e){var n,i,r,o,s=(o={title:"Billiards",text:"Replay break",url:e},(null===(n=(i=navigator).canShare)||void 0===n?void 0:n.call(i,o))?(navigator.share(o).then(function(){return console.log("shared successfully")}).catch(function(e){console.log("Error: "+e)}),"link shared"):(null===(r=navigator.clipboard)||void 0===r||r.writeText(e),"link copied to clipboard"));t.container.eventQueue.push(new t$.s(null,s))})}}},{key:"getElement",value:function(e){return document.getElementById(e)}}],nd(n.prototype,e),t&&nd(n,t),n}();function ny(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function nb(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var ng=function(){var e,t;function n(e,t){var i=!(arguments.length>2)||void 0===arguments[2]||arguments[2],r=arguments.length>3?arguments[3]:void 0,o=arguments.length>4?arguments[4]:void 0,s=arguments.length>5?arguments[5]:void 0,a=arguments.length>6?arguments[6]:void 0,l=this;!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,n),nb(this,"table",void 0),nb(this,"view",void 0),nb(this,"controller",void 0),nb(this,"inputQueue",[]),nb(this,"eventQueue",[]),nb(this,"keyboard",void 0),nb(this,"sound",void 0),nb(this,"chat",void 0),nb(this,"sliders",void 0),nb(this,"recoder",void 0),nb(this,"id",""),nb(this,"isSinglePlayer",!0),nb(this,"rules",void 0),nb(this,"menu",void 0),nb(this,"last",performance.now()),nb(this,"step",.001953125),nb(this,"broadcast",void 0),nb(this,"log",void 0),nb(this,"sendChat",function(e){l.sendEvent(new t$.s(l.id,e))}),nb(this,"throttle",new t2(200,function(e){l.broadcast(e)})),nb(this,"lastEventTime",performance.now()),this.log=t,this.rules=np.create(r,this),this.table=this.rules.table(),this.view=new e2(e,s,this.table,i),this.table.cue.aimInputs=new tV(this),this.keyboard=o,this.sound=new tY(this.view.camera.camera,i),this.chat=new tQ(this.sendChat),this.sliders=new t4.E,this.recoder=new t8(this),this.id=a,this.menu=new nv(this),this.table.addToScene(this.view.scene),this.updateController(new tG(this))}return e=[{key:"sendEvent",value:function(e){this.throttle.send(e)}},{key:"advance",value:function(e){for(var t=Math.floor(e/this.step),n=t*this.step,i=this.table.allStationary(),r=0;r<t;r++)this.table.advance(this.step);this.table.updateBallMesh(n),this.view.update(n,this.table.cue.aim),this.table.cue.update(n),!i&&this.table.allStationary()&&this.eventQueue.push(new p),this.sound.processOutcomes(this.table.outcome)}},{key:"processEvents",value:function(){var e=this;for(this.keyboard&&this.keyboard.getEvents().forEach(function(t){return e.inputQueue.push(t)});this.inputQueue.length>0;){this.lastEventTime=this.last;var t=this.inputQueue.shift();t&&this.updateController(this.controller.handleInput(t))}if(this.table.allStationary()){var n=this.eventQueue.shift();n&&(this.lastEventTime=performance.now(),this.updateController(n.applyToController(this.controller)))}}},{key:"animate",value:function(e){var t=this;this.advance((e-this.last)/1e3),this.last=e,this.processEvents(),(e<this.lastEventTime+1e4||!this.table.allStationary()||this.view.sizeChanged())&&this.view.render(),requestAnimationFrame(function(e){t.animate(e)})}},{key:"updateController",value:function(e){e!==this.controller&&(this.log("Transition to "+(tZ(e,tG)?"Init":tZ(e,tx)?"PlaceBall":tZ(e,tv)?"Aim":tZ(e,tO)?"WatchAim":tZ(e,tf)?"PlayShot":tZ(e,tE)?"WatchShot":tZ(e,tH)?"Replay":tZ(e,tt)?"End":"UNKNOWN")),this.controller=e,this.controller.onFirst())}}],ny(n.prototype,e),t&&ny(n,t),n}()},"./src/diagrams.ts":(e,t,n)=>{var i,r,o,s,a,l,c,u,h,f=n("./src/model/physics/physics.ts"),p=n("./node_modules/three/build/three.module.js");function d(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var v=function(){var e,t;function n(e,t){!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,n),m(this,"canvas",void 0),m(this,"context",void 0),m(this,"endx",100),m(this,"endy",100),m(this,"scale",2e3),m(this,"r",20),e.firstElementChild.innerHTML=t,this.canvas=e.lastElementChild,this.context=this.canvas.getContext("2d")}return e=[{key:"drawBall",value:function(){this.context.beginPath(),this.context.strokeStyle="lightgray",this.context.fillStyle="beige",this.context.arc(this.endx,this.endy,this.r,0,2*Math.PI,!1),this.context.fill(),this.context.stroke()}},{key:"drawCushion",value:function(){var e=this.context.createLinearGradient(10,90,200,90);e.addColorStop(0,"lightgray"),e.addColorStop(.75,"white"),this.context.fillStyle=e,this.context.fillRect(this.endx+this.r,10,200,250)}},{key:"plot",value:function(e,t,n,i,r){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawCushion(),this.drawBall();for(var o=e;o<=t;o+=n){var s=i(o),a=r(o),l=(0,f.vZ)(s,a)?[]:[2,2];this.context.setLineDash(l);var c=(o+360)*101%360;this.context.strokeStyle="hsl(".concat(c,",50%,50%)"),this.drawArrow(this.endx-s.x*this.scale,this.endy-s.y*this.scale,this.endx,this.endy);var u=(0,f.ZI)(0,s,a,f.Fn);s.add(u.v),this.drawArrow(this.endx,this.endy,this.endx+s.x*this.scale,this.endy+s.y*this.scale)}}},{key:"drawArrow",value:function(e,t,n,i){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:.9,o={dx:n-e,dy:i-t},s={x:o.dx*r+e,y:o.dy*r+t},a={dx:n-s.x,dy:i-s.y};this.context.beginPath(),this.context.moveTo(e,t),this.context.lineTo(s.x,s.y),this.context.moveTo(s.x+.5*a.dy,s.y-.5*a.dx),this.context.lineTo(s.x-.5*a.dy,s.y+.5*a.dx),this.context.lineTo(n,i),this.context.closePath(),this.context.stroke()}}],d(n.prototype,e),t&&d(n,t),n}();function y(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function b(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function g(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function w(e){return function(e){if(Array.isArray(e))return y(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return y(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if("Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return y(e,t)}}(e)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var k=function(){var e,t;function n(e,t,i){!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,n),g(this,"canvas",void 0),g(this,"ctx",void 0),g(this,"xAxis",void 0),g(this,"yAxis",void 0),g(this,"gutter",20),this.canvas=document.getElementById(e),this.ctx=this.canvas.getContext("2d"),this.canvas.previousElementSibling.innerHTML=t,this.canvas.nextElementSibling.innerHTML=i}return e=[{key:"plot",value:function(e,t,n){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.shadowColor="grey",this.ctx.shadowBlur=2;var i=w(t).concat(w(n));i.push(0),this.xAxis=this.axisInfo(e,this.canvas.width),this.yAxis=this.axisInfo(i,this.canvas.height),this.drawXAxis(e),this.drawYAxis(i),this.plotLine(e,t,"blue"),this.plotLine(e,n,"red")}},{key:"plotLine",value:function(e,t,n){this.ctx.beginPath();for(var i=0;i<e.length;i++){var r=this.scale(e[i],this.xAxis),o=this.canvas.height-.8*this.scale(t[i],this.yAxis)-this.gutter;0===i?this.ctx.moveTo(r,o):this.ctx.lineTo(r,o)}this.ctx.strokeStyle=n,this.ctx.stroke()}},{key:"drawXAxis",value:function(e){var t=this.canvas.height-this.gutter;this.ctx.beginPath(),this.ctx.moveTo(0,t),this.ctx.lineTo(this.canvas.width,t),this.ctx.strokeStyle="grey",this.ctx.stroke(),this.ctx.font="8px Arial",this.ctx.strokeStyle="grey";for(var n=!1,i=2;i<e.length-2;i++){var r=this.scale(e[i],this.xAxis);this.ctx.beginPath(),this.ctx.moveTo(r,t),this.ctx.lineTo(r,t+4),this.ctx.stroke(),n||this.ctx.fillText(e[i],r-5,t+10),n=!n}}},{key:"drawYAxis",value:function(e){var t,n=(t=Math).max.apply(t,w(e)),i=this.canvas.height-.8*this.scale(n,this.yAxis)-this.gutter,r=this.canvas.height-.8*this.scale(0,this.yAxis)-this.gutter;this.ctx.beginPath(),this.ctx.moveTo(0,r),this.ctx.lineTo(0,i),this.ctx.strokeStyle="grey",this.ctx.stroke(),this.ctx.fillText("".concat(0..toFixed(3)),0,r),this.ctx.fillText("".concat(n.toFixed(3)),0,i)}},{key:"scale",value:function(e,t){return(e-t.min)*t.scale}},{key:"axisInfo",value:function(e,t){var n,i,r=(n=Math).min.apply(n,w(e)),o=(i=Math).max.apply(i,w(e));return{min:r,max:o,scale:t/(o-r||1)}}}],b(n.prototype,e),t&&b(n,t),n}(),x=n("./src/model/ball.ts"),T=n("./src/model/physics/constants.ts"),R=n("./src/utils/utils.ts");function A(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function E(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var S=function(){var e,t;function n(e){!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,n),E(this,"ball",void 0),E(this,"theta",0),E(this,"canvas",void 0),E(this,"ctx",void 0),E(this,"step",.01),this.canvas=e,this.ctx=this.canvas.getContext("2d"),this.ball=new x.e(R.bM),this.ball.vel.copy(new p.Pa4(32*T.R,0,0)),this.ball.rvel.copy(new p.Pa4(0,-(2*this.ball.vel.x)/T.R,0)),this.ball.state=x.Z.Sliding}return e=[{key:"drawBall",value:function(e,t,n){var i=this.canvas.width,r=this.canvas.height,o=i/(27*T.R);this.ctx.beginPath(),this.ctx.strokeStyle=n,this.ctx.fillStyle=n;var s=e*o+2*T.R*o,a=t*o+r/2,l=T.R*o;this.ctx.ellipse(s,a,l,l,0,0,2*Math.PI),this.ctx.stroke();var c=s+-(T.R*Math.sin(this.theta))*o,u=a+T.R*Math.cos(this.theta)*o;this.ctx.beginPath(),this.ctx.strokeStyle="black",this.ctx.moveTo(s,a),this.ctx.lineTo(c,u),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.fillStyle="black",this.ctx.arc(c,u,3,0,2*Math.PI),this.ctx.fill()}},{key:"advance",value:function(e){this.ball.update(e);var t=this.ball.rvel.length()*e;this.theta+=t}},{key:"draw",value:function(e){this.ctx.clearRect(0,0,1,1);for(var t=0;t<e;){var n="blue";this.ball.isRolling()?n="red":this.ball.inMotion()&&(n="green"),this.drawBall(this.ball.pos.x,0,n),this.advance(this.step),t+=this.step}}}],A(n.prototype,e),t&&A(n,t),n}(),P=n("./src/view/sliders.ts"),M=n("./src/container/container.ts"),O=n("./src/events/keyboard.ts"),_=n("./src/events/breakevent.ts"),I=n("./src/view/cameratop.ts");function C(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function N(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}for(var j=function(){var e,t;function n(e,t,i){var r=this;!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,n),N(this,"container",void 0),N(this,"canvas3d",void 0),N(this,"ruletype",void 0),N(this,"replay",void 0),N(this,"cushionModel",void 0),N(this,"breakState",{init:null,shots:[]}),N(this,"onAssetsReady",function(){console.log("diagram ready"),r.breakState=JSON.parse(decodeURIComponent(r.replay));var e=document.getElementById("replay");r.replayButton(e),r.container.eventQueue.push(new _.l(r.breakState.init,r.breakState.shots)),r.container.animate(performance.now())}),this.replay=i,this.ruletype=t,this.canvas3d=e,I.c.zoomFactor=.88}return e=[{key:"start",value:function(){var e=new O.N(this.canvas3d);this.container=new M.W(this.canvas3d,console.log,!1,this.ruletype,e,this.onAssetsReady,"diagram"),this.cushionModel&&(this.container.table.cushionModel=this.cushionModel)}},{key:"replayButton",value:function(e){var t=this;e.innerHTML="",e.addEventListener("click",function(){0==t.container.eventQueue.length&&t.container.eventQueue.push(new _.l(t.breakState.init,t.breakState.shots))})}}],t=[{key:"fromDiamgramElement",value:function(e){var t=null==e?void 0:e.getElementsByClassName("topview")[0],i=null==t?void 0:t.getAttribute("data-state"),r=new URLSearchParams(i),o=null==e?void 0:e.getElementsByClassName("description")[0],s=document.createElement("a");s.href="../".concat(i),s.innerHTML="",s.target="_blank",null==o||o.appendChild(s);var a=document.createElement("button");null==o||o.appendChild(a);var l=new n(t,r.get("ruletype"),r.get("state"));return l.replayButton(a),"bounceHan"==r.get("cushionModel")&&(l.cushionModel=f.Fn),l}}],e&&C(n.prototype,e),t&&C(n,t),n}(),L=n("./src/view/cue.ts"),B=3*T.R,H=document.getElementsByClassName("replaydiagram"),F=0;F<H.length;F++){var U=H.item(F);j.fromDiamgramElement(U).start()}var D=z("rollcanvas");function G(){i&&(function(){function e(e){return function(t){return K(0,0,e)}}var t=function(e){return K(Math.cos(e*Math.PI/180),Math.sin(e*Math.PI/180),0)};i.plot(10,80,10,t,function(e){return K(0,0,0)}),r.plot(10,80,10,t,e(-40)),o.plot(10,80,10,t,e(40)),s.plot(-6,6,1,function(e){return K(.7,.7,0)},function(e){return K(0,0,6*e)}),a.plot(-6,6,1,function(e){return K(2,2,0)},function(e){return K(0,0,6*e)})}(),function(){for(var e=[],t=[],n=[],i=-180;i<=180;i+=30){e.push(i);var r=new p.Pa4(.2*T.R,0,0),o=new p.Pa4(0,0,i*T.R);t.push((0,f.NP)((0,f.c0)(r))),n.push((0,f.al)((0,f.s0)(r,o)))}l.plot(e,t,n)}(),function(){for(var e=[],t=[],n=[],i=-180;i<=180;i+=30){e.push(i);var r=new p.Pa4(150*T.R,0,0),o=new p.Pa4(0,i*T.R,0);t.push((0,f.NP)((0,f.c0)(r))),n.push((0,f.al)((0,f.s0)(r,o)))}c.plot(e,t,n)}(),function(){for(var e=[],t=[],n=[],i=-80;i<=80;i+=10){e.push(i);var r=i*Math.PI/180,o=new p.Pa4(Math.cos(r)*T.R,Math.sin(r)*T.R,0);o.multiplyScalar(B);var s=new p.Pa4(0,0,-10*T.R);t.push((0,f.NP)((0,f.c0)(o))),n.push((0,f.al)((0,f.s0)(o,s)))}u.plot(e,t,n)}(),function(){for(var e=[],t=[],n=[],i=0;i<=88;i+=2){e.push(i);var r=i*Math.PI/180,o=new p.Pa4(Math.cos(r)*T.R,Math.sin(r)*T.R,0),s=new p.Pa4(0,0,50*T.R),a=(0,f.Fn)(o,s),l=o.clone().add(a.v),c=-(180*Math.atan2(-l.y,-l.x))/Math.PI;t.push(c);var u=(0,f.h_)(o,s),d=o.clone().add(u.v),m=-(180*Math.atan2(-d.y,-d.x))/Math.PI;n.push(m)}h.plot(e,t,n)}())}function z(e){return document.getElementById(e)}function K(e,t,n){return new p.Pa4(e*T.R,t*T.R,n*T.R)}D?new S(D).draw(5):(z("cushion1")&&(i=new v(z("cushion1"),"stun shot"),r=new v(z("cushion2"),"running side"),o=new v(z("cushion3"),"check side"),s=new v(z("cushion4"),"varying side"),a=new v(z("cushion5"),"varying side high vel"),l=new k("plot1","Top spin ball played slow directly into cushion","top/back spin w.y"),c=new k("plot2","Top spin ball played hard directly into cushion","top/back spin w.y"),u=new k("plot3","Right hand spinning ball with varying incident angleand speed s","Incident angle (degrees) of ball to cushion with right side"),h=new k("plot4","Bounce angle of ball with check side (y-axis outward angle)","Incident angle (degrees) of ball to cushion, 0=perpendicular, 90=parallel. Blue=Han2005 Red=Blend"),G()),new P.E(G).initialiseSlider("s",B,function(e){B=e},4),z("derived")&&function(){var e=z("derived"),t=new p.Pa4(new L.N().maxPower,0,0),n=(0,f.WL)(new p.Pa4(.5),t);e.innerHTML+="Mx,My    = ".concat(T.Hz.toFixed(6),"\n"),e.innerHTML+="Mz       = ".concat(T.Mz.toFixed(6),"\n"),e.innerHTML+="I        = ".concat(T.I.toFixed(6),"\n"),e.innerHTML+="Max vel  = ".concat(t.length().toFixed(6),"\n"),e.innerHTML+="Max rvel = ".concat(n.length().toFixed(4),"\n")}())},"./src/events/abortevent.ts":(e,t,n)=>{n.d(t,{Y:()=>l});var i=n("./src/events/gameevent.ts"),r=n("./src/events/eventtype.ts");function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var l=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&a(e,t)}(l,e);var t,n,i=(t=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,n,i=s(l);if(t){var r=s(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return(e=n)&&("object"==(e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e)||"function"==typeof e)?e:function(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this)});function l(){var e;return!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,l),(e=i.call(this)).type=r.t.ABORT,e}return o(l.prototype,[{key:"applyToController",value:function(e){return e.handleAbort(this)}}]),n&&o(l,n),l}(i.Z)},"./src/events/aimevent.ts":(e,t,n)=>{n.d(t,{f:()=>f});var i=n("./src/events/gameevent.ts"),r=n("./src/events/eventtype.ts"),o=n("./src/utils/utils.ts"),s=n("./node_modules/three/build/three.module.js");function a(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function l(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function u(e){return(u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function h(e,t){return(h=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var f=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&h(e,t)}(p,e);var t,n,i,f=(t=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,n,i=u(p);if(t){var r=u(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return(e=n)&&("object"==(e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e)||"function"==typeof e)?e:a(this)});function p(){var e;return!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,p),c(a(e=f.call(this)),"offset",new s.Pa4(0,0,0)),c(a(e),"angle",0),c(a(e),"power",0),c(a(e),"pos",new s.Pa4(0,0,0)),c(a(e),"i",0),e.type=r.t.AIM,e}return n=[{key:"applyToController",value:function(e){return e.handleAim(this)}},{key:"copy",value:function(){return p.fromJson(this)}},{key:"round",value:function(){this.angle=(0,o.NM)(this.angle),this.power=(0,o.NM)(this.power),this.offset=(0,o.wK)(this.offset)}}],i=[{key:"fromJson",value:function(e){var t=new p;return t.pos=(0,o.Bh)(e.pos),t.angle=e.angle,t.offset=(0,o.Bh)(e.offset),t.power=e.power,e.i&&(t.i=e.i),t}}],n&&l(p.prototype,n),i&&l(p,i),p}(i.Z)},"./src/events/beginevent.ts":(e,t,n)=>{n.d(t,{Z:()=>l});var i=n("./src/events/gameevent.ts"),r=n("./src/events/eventtype.ts");function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var l=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&a(e,t)}(l,e);var t,n,i=(t=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,n,i=s(l);if(t){var r=s(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return(e=n)&&("object"==(e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e)||"function"==typeof e)?e:function(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this)});function l(){var e;return!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,l),(e=i.call(this)).type=r.t.BEGIN,e}return o(l.prototype,[{key:"applyToController",value:function(e){return e.handleBegin(this)}}]),n&&o(l,n),l}(i.Z)},"./src/events/breakevent.ts":(e,t,n)=>{n.d(t,{l:()=>u});var i=n("./src/events/gameevent.ts"),r=n("./src/events/eventtype.ts");function o(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var u=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(h,e);var t,n,i,u=(t=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,n,i=l(h);if(t){var r=l(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return(e=n)&&("object"==(e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e)||"function"==typeof e)?e:o(this)});function h(e,t){var n;return!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,h),a(o(n=u.call(this)),"init",void 0),a(o(n),"shots",void 0),n.init=e,n.shots=t,n.type=r.t.BREAK,n}return n=[{key:"applyToController",value:function(e){return e.handleBreak(this)}}],i=[{key:"fromJson",value:function(e){return new h(e.init,e.shots)}}],n&&s(h.prototype,n),i&&s(h,i),h}(i.Z)},"./src/events/chatevent.ts":(e,t,n)=>{n.d(t,{s:()=>u});var i=n("./src/events/gameevent.ts"),r=n("./src/events/eventtype.ts");function o(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var u=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(h,e);var t,n,i,u=(t=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,n,i=l(h);if(t){var r=l(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return(e=n)&&("object"==(e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e)||"function"==typeof e)?e:o(this)});function h(e,t){var n;return!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,h),a(o(n=u.call(this)),"sender",void 0),a(o(n),"message",void 0),n.sender=e,n.message=t,n.type=r.t.CHAT,n}return n=[{key:"applyToController",value:function(e){return e.handleChat(this)}}],i=[{key:"fromJson",value:function(e){return new h(e.sender,e.message)}}],n&&s(h.prototype,n),i&&s(h,i),h}(i.Z)},"./src/events/eventtype.ts":(e,t,n)=>{var i;n.d(t,{t:()=>i}),function(e){e.BEGIN="BEGIN",e.BREAK="BREAK",e.WATCHAIM="WATCHAIM",e.AIM="AIM",e.HIT="HIT",e.STATIONARY="STATIONARY",e.CHAT="CHAT",e.ABORT="ABORT",e.PLACEBALL="PLACEBALL",e.REJOIN="REJOIN"}(i||(i={}))},"./src/events/gameevent.ts":(e,t,n)=>{function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,{Z:()=>r});var r=function e(){!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,e),i(this,"type",void 0),i(this,"sequence",void 0)}},"./src/events/hitevent.ts":(e,t,n)=>{n.d(t,{O:()=>c});var i=n("./src/events/gameevent.ts"),r=n("./src/events/eventtype.ts");function o(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var c=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&l(e,t)}(u,e);var t,n,i,c=(t=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,n,i=a(u);if(t){var r=a(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return(e=n)&&("object"==(e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e)||"function"==typeof e)?e:o(this)});function u(e){var t,n,i,s;return!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,u),n=o(t=c.call(this)),s=void 0,(i="tablejson")in n?Object.defineProperty(n,i,{value:s,enumerable:!0,configurable:!0,writable:!0}):n[i]=s,t.type=r.t.HIT,t.tablejson=e,t}return n=[{key:"applyToController",value:function(e){return e.handleHit(this)}}],i=[{key:"fromJson",value:function(e){return new u(e.tablejson)}}],n&&s(u.prototype,n),i&&s(u,i),u}(i.Z)},"./src/events/input.ts":(e,t,n)=>{function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,{I:()=>r});var r=function e(t,n){!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,e),i(this,"t",void 0),i(this,"key",void 0),this.t=t,this.key=n}},"./src/events/keyboard.ts":(e,t,n)=>{n.d(t,{N:()=>l});var i=n("./src/events/input.ts"),r=n("./node_modules/interactjs/dist/interact.min.js"),o=n.n(r);function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var l=function(){var e,t;function n(e){var t=this;!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,n),a(this,"pressed",{}),a(this,"released",{}),a(this,"keydown",function(e){null==t.pressed[e.code]&&(t.pressed[e.code]=performance.now()),e.stopImmediatePropagation(),"F12"!==e.key&&e.preventDefault()}),a(this,"keyup",function(e){t.released[e.code]=performance.now()-t.pressed[e.code],delete t.pressed[e.code],e.stopImmediatePropagation(),"F12"!==e.key&&e.preventDefault()}),a(this,"mousetouch",function(e){var n=e.dx;t.released.movementX?t.released.movementX+=n:t.released.movementX=n}),this.addHandlers(e),/Android|iPhone/i.test(navigator.userAgent)||(e.contentEditable="true")}return e=[{key:"getEvents",value:function(){var e=this,t=Object.keys(this.pressed).filter(function(e){return!/Shift/.test(e)}).filter(function(e){return!/Control/.test(e)}),n=Object.keys(this.pressed).some(function(e){return/Shift/.test(e)}),r=Object.keys(this.pressed).some(function(e){return/Control/.test(e)}),o=[];return t.forEach(function(t){var s=performance.now()-e.pressed[t];o.push(new i.I(r?s/3:s,n?"Shift"+t:t)),"Space"!=t&&(e.pressed[t]=performance.now())}),Object.keys(this.released).forEach(function(t){return o.push(new i.I(e.released[t],t+"Up"))}),this.released={},o}},{key:"addHandlers",value:function(e){var t=this;e.addEventListener("keydown",this.keydown),e.addEventListener("keyup",this.keyup),e.focus(),o()(e).draggable({listeners:{move:function(e){t.mousetouch(e)}}})}}],s(n.prototype,e),t&&s(n,t),n}()},"./src/events/placeballevent.ts":(e,t,n)=>{n.d(t,{I:()=>h});var i=n("./src/events/gameevent.ts"),r=n("./src/events/eventtype.ts"),o=n("./src/utils/utils.ts");function s(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function a(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function u(e,t){return(u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var h=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&u(e,t)}(f,e);var t,n,i,h=(t=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,n,i=c(f);if(t){var r=c(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return(e=n)&&("object"==(e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e)||"function"==typeof e)?e:s(this)});function f(e,t){var n;return!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,f),l(s(n=h.call(this)),"pos",void 0),l(s(n),"allTable",void 0),n.pos=e,n.allTable=t,n.type=r.t.PLACEBALL,n}return n=[{key:"applyToController",value:function(e){return e.handlePlaceBall(this)}}],i=[{key:"fromJson",value:function(e){return new f((0,o.Bh)(e.pos),e.allTable)}}],n&&a(f.prototype,n),i&&a(f,i),f}(i.Z)},"./src/events/watchevent.ts":(e,t,n)=>{n.d(t,{g:()=>c});var i=n("./src/events/gameevent.ts"),r=n("./src/events/eventtype.ts");function o(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var c=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&l(e,t)}(u,e);var t,n,i,c=(t=function(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,n,i=a(u);if(t){var r=a(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return(e=n)&&("object"==(e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e)||"function"==typeof e)?e:o(this)});function u(e){var t,n,i,s;return!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,u),n=o(t=c.call(this)),s=void 0,(i="json")in n?Object.defineProperty(n,i,{value:s,enumerable:!0,configurable:!0,writable:!0}):n[i]=s,t.type=r.t.WATCHAIM,t.json=e,t}return n=[{key:"applyToController",value:function(e){return e.handleWatch(this)}}],i=[{key:"fromJson",value:function(e){return new u(e)}}],n&&s(u.prototype,n),i&&s(u,i),u}(i.Z)},"./src/model/ball.ts":(e,t,n)=>{n.d(t,{e:()=>v,Z:()=>i});var i,r=n("./src/utils/utils.ts"),o=n("./src/model/physics/physics.ts"),s=n("./node_modules/three/build/three.module.js"),a=n("./src/model/physics/constants.ts");function l(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var u=function(){var e,t;function n(e,t){!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,n),c(this,"line",void 0),c(this,"geometry",void 0),c(this,"positions",void 0),c(this,"lastPos",new s.Pa4),c(this,"lastVel",new s.Pa4),this.geometry=new s.u9r,this.positions=new Float32Array(3*e),this.geometry.setAttribute("position",new s.TlE(this.positions,3)),this.reset();var i=new s.nls({color:t,opacity:.25,linewidth:3,transparent:!0});this.line=new s.x12(this.geometry,i),this.line.visible=!1}return e=[{key:"reset",value:function(){this.geometry.setDrawRange(0,0),this.lastVel.setZ(1)}},{key:"addTrace",value:function(e,t){if(0!==t.length()){var n=this.lastVel.angleTo(t),i=n>Math.PI/32?.01*a.R:a.R,r=this.lastPos.distanceTo(e),o=this.geometry.drawRange.count;0!==o&&r<i||(o>1&&n<1e-4&&o--,this.lastPos.copy(e),this.lastVel.copy(t),this.addPoint(e,o))}}},{key:"addPoint",value:function(e,t){var n=3*t;n>this.positions.length||(this.positions[n++]=e.x,this.positions[n++]=e.y,this.positions[n]=e.z,this.geometry.setDrawRange(0,t+1),this.line.geometry.attributes.position.needsUpdate=!0)}}],l(n.prototype,e),t&&l(n,t),n}();function h(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var p=function(){var e,t;function n(e){!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,n),f(this,"mesh",void 0),f(this,"shadow",void 0),f(this,"spinAxisArrow",void 0),f(this,"trace",void 0),f(this,"m",new s.yGw),this.initialiseMesh(e)}return e=[{key:"updateAll",value:function(e,t){this.updatePosition(e.pos),this.updateArrows(e.pos,e.rvel,e.state),0!==e.rvel.lengthSq()&&(this.updateRotation(e.rvel,t),this.trace.addTrace(e.pos,e.vel))}},{key:"updatePosition",value:function(e){this.mesh.position.copy(e),this.shadow.position.copy(e)}},{key:"updateRotation",value:function(e,t){var n=e.length()*t;this.mesh.rotateOnWorldAxis((0,r.KO)(e),n)}},{key:"updateArrows",value:function(e,t,n){this.spinAxisArrow.setLength(a.R+a.R*t.length()/2,a.R,a.R),this.spinAxisArrow.position.copy(e),this.spinAxisArrow.setDirection((0,r.KO)(t)),n==i.Rolling?this.spinAxisArrow.setColor(13369344):this.spinAxisArrow.setColor(52224)}},{key:"initialiseMesh",value:function(e){var t=new s.cJO(a.R,1),n=new s.xoR({emissive:0,flatShading:!0,vertexColors:!0});this.addDots(t,e),this.mesh=new s.Kj0(t,n),this.mesh.name="ball",this.updateRotation(new s.Pa4().random(),100);var i=new s.zf8(.9*a.R,9);i.applyMatrix4(new s.yGw().identity().makeTranslation(0,0,-(.99*a.R)));var o=new s.vBJ({color:1118498});this.shadow=new s.Kj0(i,o),this.spinAxisArrow=new s.tGC(r.up,r.bM,2,0,.01,.01),this.spinAxisArrow.visible=!1,this.trace=new u(500,e)}},{key:"addDots",value:function(e,t){var n=this,i=e.attributes.position.count,r=new s.Ilk(t),o=new s.Ilk(11149858);e.setAttribute("color",new s.TlE(new Float32Array(3*i),3));for(var a=e.attributes.color,l=0;l<i/3;l++)this.colorVerticesForFace(l,a,this.scaleNoise(r.r),this.scaleNoise(r.g),this.scaleNoise(r.b));[0,96,111,156,186,195].forEach(function(e){n.colorVerticesForFace(e/3,a,o.r,o.g,o.b)})}},{key:"addToScene",value:function(e){e.add(this.mesh),e.add(this.shadow),e.add(this.spinAxisArrow),e.add(this.trace.line)}},{key:"colorVerticesForFace",value:function(e,t,n,i,r){t.setXYZ(3*e+0,n,i,r),t.setXYZ(3*e+1,n,i,r),t.setXYZ(3*e+2,n,i,r)}},{key:"scaleNoise",value:function(e){return(1-.25*Math.random())*e}}],h(n.prototype,e),t&&h(n,t),n}();function d(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e.Stationary="Stationary",e.Rolling="Rolling",e.Sliding="Sliding",e.Falling="Falling",e.InPocket="InPocket"}(i||(i={}));var v=function(){var e,t;function n(e,t){!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,n),m(this,"pos",void 0),m(this,"vel",r.bM.clone()),m(this,"rvel",r.bM.clone()),m(this,"futurePos",r.bM.clone()),m(this,"ballmesh",void 0),m(this,"state","Stationary"),m(this,"pocket",void 0),m(this,"id",n.id++),m(this,"transition",.05),this.pos=e.clone(),this.ballmesh=new p(t||5592405*Math.random())}return e=[{key:"update",value:function(e){this.updatePosition(e),this.updateVelocity(e),this.updateFalling(e)}},{key:"updateMesh",value:function(e){this.ballmesh.updateAll(this,e)}},{key:"updatePosition",value:function(e){this.pos.addScaledVector(this.vel,e)}},{key:"updateFalling",value:function(e){"Falling"==this.state&&this.pocket.updateFall(this,e)}},{key:"updateVelocity",value:function(e){this.inMotion()&&(this.isRolling()?(this.state="Rolling",(0,o.IT)(this.vel,this.rvel),this.addDelta(e,(0,o.QC)(this.rvel))):(this.state="Sliding",this.addDelta(e,(0,o.Vp)(this.vel,this.rvel))))}},{key:"addDelta",value:function(e,t){t.v.multiplyScalar(e),t.w.multiplyScalar(e),this.passesZero(t)||(this.vel.add(t.v),this.rvel.add(t.w))}},{key:"passesZero",value:function(e){var t=(0,r.Ls)(this.vel,e.v),n=(0,r.Ls)(this.rvel,e.w);return!!(("Rolling"===this.state?t||n:t&&n)&&.01>Math.abs(this.rvel.z))&&(this.setStationary(),!0)}},{key:"setStationary",value:function(){this.vel.copy(r.bM),this.rvel.copy(r.bM),this.state="Stationary"}},{key:"isRolling",value:function(){return 0!=this.vel.lengthSq()&&0!=this.rvel.lengthSq()&&(0,o.E9)(this.vel,this.rvel).length()<this.transition}},{key:"onTable",value:function(){return"Falling"!==this.state&&"InPocket"!==this.state}},{key:"inMotion",value:function(){return"Rolling"==this.state||"Sliding"==this.state}},{key:"isFalling",value:function(){return"Falling"==this.state}},{key:"futurePosition",value:function(e){return this.futurePos.copy(this.pos).addScaledVector(this.vel,e),this.futurePos}},{key:"serialise",value:function(){return{pos:this.pos,vel:this.vel,rvel:this.rvel,state:this.state}}}],t=[{key:"fromSerialised",value:function(e){return n.updateFromSerialised(new n((0,r.Bh)(e.pos)),e)}},{key:"updateFromSerialised",value:function(e,t){return e.pos.copy(t.pos),e.vel.copy((0,r.Bh)(t.vel)),e.rvel.copy((0,r.Bh)(t.rvel)),e.state=t.state,e}}],e&&d(n.prototype,e),t&&d(n,t),n}();m(v,"id",0)},"./src/model/physics/constants.ts":(e,t,n)=>{n.d(t,{Dt:()=>c,Ew:()=>m,G3:()=>w,Hz:()=>r,I:()=>o,Mz:()=>i,R:()=>f,Xm:()=>k,_5:()=>u,dE:()=>y,e:()=>p,f7:()=>g,fN:()=>v,g:()=>s,m:()=>h,mu:()=>a,zq:()=>b,zv:()=>l});var i,r,o,s=9.8,a=.00985,l=.105,c=.8,u=.025,h=.22,f=.03075,p=.86;function d(){i=a*h*s*2/3*u,r=7/(5*Math.sqrt(2))*f*a*h*s,o=.4*h*f*f}function m(e){f=e,d()}function v(e){h=e,d()}function y(e){a=e,d()}function b(e){u=e,d()}function g(e){l=e}function w(e){p=e}function k(e){c=e}d()},"./src/model/physics/physics.ts":(e,t,n)=>{n.d(t,{E9:()=>a,Fn:()=>R,IT:()=>h,NP:()=>g,QC:()=>u,Vp:()=>c,WL:()=>S,ZI:()=>f,al:()=>b,c0:()=>y,h_:()=>A,s0:()=>v,vZ:()=>w});var i=n("./node_modules/three/build/three.module.js"),r=n("./src/utils/utils.ts"),o=n("./src/model/physics/constants.ts"),s=new i.Pa4;function a(e,t){return s.copy(e).addScaledVector((0,r.a1)(t),o.R)}var l={v:new i.Pa4,w:new i.Pa4};function c(e,t){var n=a(e,t).setZ(0);return l.v.copy((0,r.KO)(n).multiplyScalar(-o.zv*o.g)),l.w.copy((0,r.KO)((0,r.a1)(n)).multiplyScalar(2.5*o.zv*o.g/o.R)),l.w.setZ(-2.5*(o.Mz/(o.R*o.R))*Math.sign(t.z)),l}function u(e){var t=new i.Pa4(e.x,e.y,0).length(),n=5/7*o.Hz/(o.m*o.R)/t,r=5/7*o.Hz/(o.m*o.R*o.R)/t;return l.v.set(-n*e.y,n*e.x,0),l.w.set(-r*e.x,-r*e.y,-2.5*(o.Mz/(o.m*o.R*o.R))*Math.sign(e.z)),l}function h(e,t){var n=t.z;t.copy((0,r.a1)(e).multiplyScalar(1/o.R)),t.setZ(n)}function f(e,t,n,i){var o=i(t.clone().applyAxisAngle(r.up,e),n.clone().applyAxisAngle(r.up,e));return o.v.applyAxisAngle(r.up,-e),o.w.applyAxisAngle(r.up,-e),o}Object.freeze(l);var p=Math.asin(.2*o.R/o.R),d=Math.sin(p),m=Math.cos(p);function v(e,t){return new i.Pa4(e.x*d-e.z*m+o.R*t.y,-e.y-o.R*t.z*m+o.R*t.x*d)}function y(e){return e.x*m}function b(e){var t=3.5/o.m;return e.length()/t}function g(e){var t,n=1/o.m,r=.39+.257*(t=new i.Pa4(e/m,0,0)).x-.044*t.x*t.x;return o.Dt*((1+r)*e)/n}function w(e,t){var n=g(y(e));return b(v(e,t))<=n}function k(e,t){return{c:y(e),s:v(e,t),A:3.5/o.m,B:1/o.m}}function x(e,t){var n=k(e,t),i=n.c,r=n.s,s=n.A,a=n.B,l=(1+o.e)*(i/a);return E(-r.x/s*d-l*m,r.y/s,r.x/s*m-l*d)}function T(e,t){var n=k(e,t),i=n.c,r=n.B,s=(1+o.e)*(i/r),a=.471-.241*Math.atan2(Math.abs(e.y),e.x),l=Math.atan2(e.y,e.x),c=Math.cos(l),u=-a*s*c*m-s*m,h=a*s*c*m-s*d;return E(u,a*s*Math.sin(l),h)}function R(e,t){return w(e,t)?x(e,t):T(e,t)}function A(e,t){var n=x(e,t),i=T(e,t),r=Math.sign(e.y)===Math.sign(t.z)?Math.cos(Math.atan2(e.y,e.x)):1;return{v:i.v.lerp(n.v,r),w:i.w.lerp(n.w,r)}}function E(e,t,n){return{v:new i.Pa4(e/o.m,t/o.m),w:new i.Pa4(-o.R/o.I*t*d,o.R/o.I*(e*d-n*m),o.R/o.I*t*m)}}function S(e,t){var n=Math.atan2(-e.x,e.y),i=2.5*t.length()*(e.length()*o.R)/(o.R*o.R),s=t.clone().normalize();return(0,r.a1)(s).applyAxisAngle(s,n).multiplyScalar(i)}},"./src/utils/utils.ts":(e,t,n)=>{n.d(t,{AA:()=>p,Bh:()=>s,KO:()=>u,Ls:()=>f,NM:()=>d,a1:()=>l,bM:()=>r,up:()=>o,wK:()=>m});var i=n("./node_modules/three/build/three.module.js"),r=new i.Pa4(0,0,0),o=new i.Pa4(0,0,1);function s(e){return new i.Pa4(e.x,e.y,e.z)}var a=new i.Pa4;function l(e){return a.copy(o).cross(e)}var c=new i.Pa4;function u(e){return c.copy(e).normalize()}var h=new i.Pa4;function f(e,t){return 0>=h.copy(e).add(t).dot(e)}function p(e){return new i.Pa4(1,0,0).applyAxisAngle(o,e)}function d(e){return Math.round((e+Number.EPSILON)*1e3)/1e3}function m(e){return e.x=d(e.x),e.y=d(e.y),e.z=d(e.z),e}},"./src/view/cameratop.ts":(e,t,n)=>{n.d(t,{c:()=>a});var i=n("./node_modules/three/build/three.module.js"),r=n("./src/view/tablegeometry.ts"),o=n("./src/model/physics/constants.ts");function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){var e;function t(){!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,t)}return e=[{key:"viewPoint",value:function(e,n){var s=t.zoomFactor/(2*Math.tan(n*Math.PI/360));if(e>this.portrait){var a=e>t.aspectLimit?2.75*r.H.tableY:2.4*r.H.tableX/e;return new i.Pa4(0,-.01*o.R,s*a)}var l=e>1/t.aspectLimit?4.9*r.H.tableY:1.35*r.H.tableX/e;return new i.Pa4(-.01*o.R,0,s*l)}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}(t,e),t}();s(a,"aspectLimit",1.78),s(a,"portrait",.95),s(a,"fov",20),s(a,"zoomFactor",1)},"./src/view/cue.ts":(e,t,n)=>{n.d(t,{N:()=>d});var i=n("./src/view/tablegeometry.ts"),r=n("./src/utils/utils.ts"),o=n("./src/events/aimevent.ts"),s=n("./src/model/ball.ts"),a=n("./src/model/physics/physics.ts"),l=n("./src/model/physics/constants.ts"),c=n("./node_modules/three/build/three.module.js");function u(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var h=function(){var e;function t(){!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,t)}return e=[{key:"createHelper",value:function(){var e=new c.fHI(l.R,l.R,30*l.R/.5,12,1,!0),t=new c.Kj0(e,this.helpermaterial);return t.geometry.applyMatrix4(new c.yGw().identity().makeRotationAxis(r.up,-Math.PI/2)).applyMatrix4(new c.yGw().identity().makeTranslation(15*l.R/.5,0,-(.01*l.R)/.5)),t.visible=!1,t.renderOrder=-1,t.material.depthTest=!1,t}},{key:"createPlacer",value:function(){var e=new c.fHI(.01*l.R/.5,l.R,l.R,4),n=new c.Kj0(e,t.helpermaterial);return n.geometry.applyMatrix4(new c.yGw().identity().makeRotationAxis(new c.Pa4(1,0,0),-Math.PI/2)).applyMatrix4(new c.yGw().identity().makeTranslation(0,0,.7*l.R/.5)),n.visible=!1,n}},{key:"createCue",value:function(e,n,i){var o=new c.fHI(e,n,i,11),s=new c.Kj0(o,t.material);return s.castShadow=!1,s.geometry.applyMatrix4(new c.yGw().identity().makeRotationAxis(new c.Pa4(1,0,0),-.1)).applyMatrix4(new c.yGw().identity().makeRotationAxis(r.up,-Math.PI/2)).applyMatrix4(new c.yGw().identity().makeTranslation(-i/2-l.R,0,2*l.R)),s}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}(t,e),t}();function f(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function p(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}u(h,"material",new c.xoR({color:8934775,wireframe:!1,flatShading:!1})),u(h,"helpermaterial",new c.jyz({uniforms:{lightDirection:{value:new c.Pa4(0,0,1)}},vertexShader:"\n      varying vec2 vUv;\n      varying vec3 vNormal;  \n      void main() {\n        vNormal = normal;\n        vUv = uv;\n        gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);\n      }\n    ",fragmentShader:"\n      varying vec2 vUv;\n      varying vec3 vNormal;\n      uniform vec3 lightDirection;\n      void main() {\n        float intensity = dot(vNormal, lightDirection);\n        vec3 color = vec3(1.0, 1.0, 1.0);\n        vec3 finalColor = color * intensity;\n        gl_FragColor = vec4(finalColor, 0.05 * (1.0-vUv.y));\n      }\n    ",wireframe:!1,transparent:!0}));var d=function(){var e,t;function n(){!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,n),p(this,"mesh",void 0),p(this,"helperMesh",void 0),p(this,"placerMesh",void 0),p(this,"offCenterLimit",.3),p(this,"maxPower",150*l.R),p(this,"t",0),p(this,"aimInputs",void 0),p(this,"aim",new o.f),p(this,"length",1*i.H.tableX),this.mesh=h.createCue(.05*l.R/.5,.15*l.R/.5,this.length),this.helperMesh=h.createHelper(),this.placerMesh=h.createPlacer()}return e=[{key:"rotateAim",value:function(e){this.aim.angle+=e,this.mesh.rotation.z=this.aim.angle,this.helperMesh.rotation.z=this.aim.angle}},{key:"adjustPower",value:function(e){this.aim.power=Math.min(this.maxPower,this.aim.power+e),this.updateAimInput()}},{key:"setPower",value:function(e){this.aim.power=e*this.maxPower}},{key:"hit",value:function(e){var t=this.aim;this.t=0,e.state=s.Z.Sliding,e.vel.copy((0,r.AA)(t.angle).multiplyScalar(t.power)),e.rvel.copy((0,a.WL)(t.offset,e.vel))}},{key:"adjustSpin",value:function(e){var t=this.aim.offset.clone().add(e);this.setSpin(t)}},{key:"setSpin",value:function(e){e.length()>this.offCenterLimit&&e.normalize().multiplyScalar(this.offCenterLimit),this.aim.offset=e,this.updateAimInput()}},{key:"updateAimInput",value:function(){var e,t;null===(e=this.aimInputs)||void 0===e||e.updateVisualState(this.aim.offset.x,this.aim.offset.y),null===(t=this.aimInputs)||void 0===t||t.updatePowerSlider(this.aim.power/this.maxPower)}},{key:"moveTo",value:function(e){this.aim.pos.copy(e),this.mesh.rotation.z=this.aim.angle,this.helperMesh.rotation.z=this.aim.angle;var t=(0,r.a1)((0,r.AA)(this.aim.angle)).multiplyScalar(2*this.aim.offset.x*l.R).setZ(2*this.aim.offset.y*l.R),n=(Math.sin(this.t+Math.PI/2)-1)*3*l.R*(this.aim.power/this.maxPower),i=(0,r.AA)(this.aim.angle).clone().multiplyScalar(n);this.mesh.position.copy(e.clone().add(t).add(i)),this.helperMesh.position.copy(e),this.placerMesh.position.copy(e),this.placerMesh.rotation.z=this.t}},{key:"update",value:function(e){this.t+=e,this.moveTo(this.aim.pos)}},{key:"placeBallMode",value:function(){this.mesh.visible=!1,this.placerMesh.visible=!0,this.aim.angle=0}},{key:"aimMode",value:function(){this.mesh.visible=!0,this.placerMesh.visible=!1}},{key:"intersectsAnything",value:function(e){var t=e.cueball.pos.clone().addScaledVector((0,r.AA)(this.aim.angle),-this.length/2);t.z=this.aim.offset.y;var n=(0,r.AA)(this.aim.angle);return new c.iMs(t,n,0,this.length/2-.6).intersectObjects(e.balls.map(function(e){return e.ballmesh.mesh})).length>0}},{key:"showHelper",value:function(e){this.helperMesh.visible=e}},{key:"toggleHelper",value:function(){this.showHelper(!this.helperMesh.visible)}}],f(n.prototype,e),t&&f(n,t),n}()},"./src/view/sliders.ts":(e,t,n)=>{n.d(t,{E:()=>s});var i=n("./src/model/physics/constants.ts");function r(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var s=function(){var e,t;function n(e){var t,r;!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,n),o(this,"style",void 0),o(this,"notify",void 0),this.notify=null!=e?e:function(){},this.style=null!==(r=null===(t=document.getElementById("constants"))||void 0===t?void 0:t.style)&&void 0!==r?r:{},this.initialiseSlider("R",i.R,i.Ew),this.initialiseSlider("m",i.m,i.fN),this.initialiseSlider("e",i.e,i.G3),this.initialiseSlider("mu",i.mu,i.dE),this.initialiseSlider("muS",i.zv,i.f7),this.initialiseSlider("muC",i.Dt,i.Xm),this.initialiseSlider("rho",i._5,i.zq)}return e=[{key:"toggleVisibility",value:function(){this.style.visibility="visible"===this.style.visibility?"hidden":"visible"}},{key:"getInputElement",value:function(e){var t;return null!==(t=document.getElementById(e))&&void 0!==t?t:{}}},{key:"initialiseSlider",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,r=this,o=this.getInputElement(e);o.step="0.001",o.min="0.01",o.max="".concat(i),o.value=t,this.showValue(e,t),o.oninput=function(t){var i=parseFloat(t.target.value);n(i),r.showValue(e,i),r.notify()}}},{key:"showValue",value:function(e,t){var n=document.querySelector("label[for=".concat(e,"]"));n&&(n.innerHTML="".concat(e,"=").concat(t))}}],r(n.prototype,e),t&&r(n,t),n}()},"./src/view/tablegeometry.ts":(e,t,n)=>{n.d(t,{H:()=>o});var i=n("./src/model/physics/constants.ts");function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var o=function(){var e;function t(){!function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,t)}return e=[{key:"scaleToRadius",value:function(e){t.tableX=43*e,t.tableY=21*e,t.X=t.tableX+e,t.Y=t.tableY+e}}],function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}(t,e),t}();r(o,"tableX",void 0),r(o,"tableY",void 0),r(o,"X",void 0),r(o,"Y",void 0),o.scaleToRadius(i.R)}},e=>{e(e.s="./src/diagrams.ts")}]);